--Trunk Script

SET ECHO OFF;
SET FEED OFF;
SET SQLBL ON;
SET SERVEROUTPUT ON SIZE 1000000;
SET AUTOCOMMIT ON;
SET DEFINE OFF;
--SET ESCAPE ~;
spool TowersWatson.err;
EXEC SP_SETTING;
EXEC SP_PRESCRUB_CLEANDATA;
EXEC SP_DROPZZZTABLES;
EXEC SP_PULLHRDATA ('802');
EXEC SP_PULLHRDATA ('826');
EXEC SP_MASTER_PREPN;

-------------------------------------------------------------
------------------------------GRANT PERMISSION TO ALL HI TABLES------------------
DECLARE
    SchemaName VARCHAR2(20);
BEGIN
	SELECT sys_context('USERENV', 'CURRENT_USER')
	INTO SchemaName from dual;

	UTILITY.SP_TABLE_GRANT('HI0826001',SchemaName);

END;
/
---------------------------------------------------------------------------------
BEGIN
        DBMS_OUTPUT.PUT_LINE( 'HawkeyePrescrub Started  ' || TO_CHAR(SYSDATE,'MM-DD-YYYY HH:MI:SS'));
        DELETE FROM VH_QUERYLOG WHERE QueryName LIKE '060_826_%';
        INSERT INTO VH_QUERYLOG(QueryName) VALUES('060_826 : Horan PreScrub');
END;
/
--------------------------------------------------------------------------------
-----------Adding EI Specific Fields--------------------------------------------
----------------------------------------------------------------------------

BEGIN
        EXECUTE IMMEDIATE 'ALTER TABLE VH_CLAIMS ADD SRCRELFLAG VARCHAR2(50)';
        EXCEPTION WHEN OTHERS THEN NULL;
END;
/

--------------------------------------------------------------------------------
BEGIN
        EXECUTE IMMEDIATE 'ALTER TABLE VH_CLAIMS ADD PlanType VARCHAR2(100)';
        EXCEPTION WHEN OTHERS THEN NULL;
END;
/

--------------------------------------------------------------------------------
BEGIN
        EXECUTE IMMEDIATE 'ALTER TABLE VH_CLAIMS ADD PlanName VARCHAR2(200)';
        EXCEPTION WHEN OTHERS THEN NULL;
END;
/

--------------------------------------------------------------------------------
BEGIN
        EXECUTE IMMEDIATE 'ALTER TABLE VH_CLAIMS ADD ENROLLMENT_SOURCE VARCHAR2(20)';
        EXCEPTION WHEN OTHERS THEN NULL;
END;
/

-----------------------------------------------------------------------------------
BEGIN
        EXECUTE IMMEDIATE 'ALTER TABLE VH_CLAIMS ADD COVTYPEDESC VARCHAR2(50)';
        EXCEPTION WHEN OTHERS THEN NULL;
END;
/

----------------------------------------------------------------------------------
--BEGIN
--        EXECUTE IMMEDIATE 'ALTER TABLE VH_CLAIMS ADD BENCOVTYPEDESC VARCHAR2(60)';
--        EXCEPTION WHEN OTHERS THEN NULL;
--END;
--/
--------------------------------------------------------------------------------
BEGIN
        EXECUTE IMMEDIATE 'ALTER TABLE VH_RXCLAIMS ADD SRCRELFLAG VARCHAR2(50)';
        EXCEPTION WHEN OTHERS THEN NULL;
END;
/


--------------------------------------------------------------------------------
BEGIN
        EXECUTE IMMEDIATE 'ALTER TABLE VH_RXCLAIMS ADD PlanType VARCHAR2(100)';
        EXCEPTION WHEN OTHERS THEN NULL;
END;
/

--------------------------------------------------------------------------------
BEGIN
        EXECUTE IMMEDIATE 'ALTER TABLE VH_RXCLAIMS ADD PlanName VARCHAR2(200)';
        EXCEPTION WHEN OTHERS THEN NULL;
END;
/

--------------------------------------------------------------------------------
BEGIN
        EXECUTE IMMEDIATE 'ALTER TABLE VH_RXCLAIMS ADD ENROLLMENT_SOURCE VARCHAR2(20)';
        EXCEPTION WHEN OTHERS THEN NULL;
END;
/

----------------------------------------------------------------------------------
--BEGIN
--        EXECUTE IMMEDIATE 'ALTER TABLE VH_RXCLAIMS ADD BENCOVTYPEDESC VARCHAR2(60)';
--        EXCEPTION WHEN OTHERS THEN NULL;
--END;
--/

---------------------------------------------------------------------------------
--ALTER TABLE TO ADD IUOU
BEGIN

  EXECUTE IMMEDIATE 'ALTER TABLE VH_CLAIMS ADD IUOU VARCHAR2(50)';
  EXCEPTION WHEN OTHERS THEN NULL;

END;
/

 --------------------------------------------------------------------------------

BEGIN
	          EXECUTE IMMEDIATE 'DROP TABLE VH_HRA_DATA PURGE';
	          EXCEPTION WHEN OTHERS THEN NULL;

END;
/

 --------------------------------------------------------------------------------

BEGIN
    EXECUTE IMMEDIATE 'CREATE TABLE VH_HRA_DATA (
	    MEMID	VARCHAR2(50) NOT NULL,
	    SMOKINGHISTORY	NUMBER(1,0)  NULL,
	    ALCOHOLDRINKS	NUMBER(1,0)  NULL,
	    BLOODGLUCOSECODE	NUMBER(1,0)  NULL,
	    BLOODGLUCOSEVALUE	NUMBER(5,2)  NULL,
	    BPDIASTOLICCODE	NUMBER(1,0)  NULL,
	    BPDIASTOLICVALUE	NUMBER(5,2)  NULL,
	    BPSYSTOLICCODE	NUMBER(1,0)  NULL,
	    BPSYSTOLICVALUE	NUMBER(5,2)  NULL,
	    CHOLESTEROLHDLCODE	NUMBER(1,0)  NULL,
	    CHOLESTEROLHDLVALUE	NUMBER(5,2)  NULL,
	    CHOLESTEROLLDLCODE	NUMBER(1,0)  NULL,
	    CHOLESTEROLLDLVALUE	NUMBER(5,2)  NULL,
	    CHOLESTEROLTOTALCODE	NUMBER(1,0)  NULL,
	    COLONOSCOPY	NUMBER(1,0)  NULL,
	    COLONSCREENING	NUMBER(1,0)  NULL,
	    DEPRESSIONSCORE	NUMBER(3,0)  NULL,
	    DEPRESSIONSCORECODE	NUMBER(1,0)  NULL,
	    DRINKDRIVE	NUMBER(1,0)  NULL,
	    EXERCISE	NUMBER(1,0)  NULL,
	    FECALTESTING	NUMBER(1,0)  NULL,
	    GENERALHEALTH	NUMBER(1,0)  NULL,
	    HEIGHTFEET	NUMBER(5,2)  NULL,
	    HISTORYASTHMA	NUMBER(1,0)  NULL,
	    HISTORYBRONCHITIS	NUMBER(1,0)  NULL,
	    HISTORYCOPD	NUMBER(1,0)  NULL,
	    HISTORYDIABETES	NUMBER(1,0)  NULL,
	    HISTORYHYPERLIPIDEMIA	NUMBER(1,0)  NULL,
	    HISTORYHYPERTENSION	NUMBER(1,0)  NULL,
	    HISTORYLUNGDISEASE	NUMBER(1,0)  NULL,
	    MAMMOGRAM	NUMBER(1,0)  NULL,
	    NUMDEPRESSIONQUESTIONS	NUMBER(3,0)  NULL,
	    PREGNANT	NUMBER(1,0)  NULL,
	    PAPSMEAR	NUMBER(1,0)  NULL,
	    SAFETYBELT	NUMBER(1,0)  NULL,
	    SIGMOIDOSCOPY	NUMBER(1,0)  NULL,
	    SMOKINGFREQUENCY	NUMBER(1,0)  NULL,
	    STRESSSCORECODE	NUMBER(1,0)  NULL,
	    WANTCHANGEEXERCISE	NUMBER(1,0)  NULL,
	    WANTCHANGESMOKING	NUMBER(1,0)  NULL,
	    WANTCHANGEWEIGHT	NUMBER(1,0)  NULL,
	    WEIGHT	NUMBER(5,2)  NULL,
	    UDF1	VARCHAR2(50) NULL,
	    UDF2	VARCHAR2(50) NULL,
	    UDF3	VARCHAR2(50) NULL,
	    UDF4	VARCHAR2(50) NULL,
	    UDF5	VARCHAR2(50) NULL,
	    SURVEYDATE	DATE         NULL,
	    CYCLEENDDATE	DATE         NULL,
	    IMPORTEDDATE	DATE         NULL,
         AIFILEID VARCHAR2(20),
         AIROWNUMBER VARCHAR2(20),
         I_SRC_TBL_NM VARCHAR2(30),
         I_SRC_ORCL_ROW_ID VARCHAR2(255),
		 VHGROUPNAME VARCHAR2(50)
    ) NOLOGGING';
    END;
/
--------------------------------------------------------------------------------
BEGIN
        DBMS_OUTPUT.PUT_LINE('Start Creating Temporary Table ' || TO_CHAR(SYSDATE,'MM-DD-YYYY HH:MI:SS'));
END;
/

---------------------------------------------------------------------------------
CREATE TABLE ZZZ_M_MODIFIERS
(
	modifiercode VARCHAR2(10) PRIMARY KEY,
	modifierdesc VARCHAR2(70)
)NOLOGGING;
---------------------------------------------------------------------------------
CREATE TABLE ZZZ_PROCS
(
	PROCCODE VARCHAR2(10) PRIMARY KEY,
	PROCTYPEDESC VARCHAR2(50),
	CNT INT
)NOLOGGING;
---------------------------------------------------------------------------------
CREATE TABLE ZZZ_SPECS
(
	PROCCODE VARCHAR2(10) PRIMARY KEY,
	IMPLIEDSPECCODE VARCHAR2(10),
	IMPLIEDSPECDESC VARCHAR2(100),
	CNT INT
)NOLOGGING;
--------------------------------------------------------------------------------
CREATE TABLE ZZZ_DIAGS
(
	DIAGCODE VARCHAR2(10) PRIMARY KEY,
	DIAGTYPEDESC VARCHAR2(50),
	CNT INT
)NOLOGGING;

---------------------------------------------------------------------------------
CREATE TABLE ZZZ_PACKAGE_MERGE
(
	TABLE_NAME VARCHAR2(255),
	EMPLID VARCHAR2(20),
	SET1 VARCHAR2(20),
	SERIALNO VARCHAR2(20)
)NOLOGGING;

--------------------------------------------------------------------------------
CREATE TABLE zzz_NPI
(
    NPI VARCHAR2(15),
	ProviderName VARCHAR2(70),
	entity_type_code VARCHAR2(5),
	CONSTRAINTS PK_NPI PRIMARY KEY (NPI)
)NOLOGGING;
---------------------------------------------------------------------------------
BEGIN
EXECUTE IMMEDIATE 'DROP TABLE zzz_memid_update_anthem PURGE';
EXCEPTION
WHEN OTHERS THEN NULL;
END;
/

---------------------------------------------------------------------------------

BEGIN
    EXECUTE IMMEDIATE 'CREATE TABLE zzz_memid_update_anthem NOLOGGING PARALLEL 4
    as
    SELECT memid,enrid,memfirstname,memlastname,gender,dob,lvl3id
    FROM(
    SELECT /*+PARALLEL (4)*/
		a.SUBSCRIBER_SSN||a.PERS_SEX_CD|| TO_CHAR(a.PERS_BIRTH_DATE,''YYYYMMDD'') AS MEMID,
		a.SUBSCRIBER_SSN	AS	ENRID,
		UPPER(a.PERS_FIRST_NAME) AS MEMFIRSTNAME,
		UPPER(a.PERS_LAST_NAME) AS MEMLASTNAME,
		a.PERS_SEX_CD AS GENDER,
		a.PERS_BIRTH_DATE AS DOB,
		Nvl(grp.ROLLUPID,a.grp_id) AS LVL3ID,
    Row_Number() OVER (PARTITION BY UPPER(a.PERS_FIRST_NAME),UPPER(a.PERS_LAST_NAME),a.PERS_SEX_CD,a.PERS_BIRTH_DATE
    ORDER BY a.SUBSCRIBER_SSN||a.PERS_SEX_CD|| TO_CHAR(a.PERS_BIRTH_DATE,''YYYYMMDD'')) rn
	FROM
		HI0826001.HI_ELIG_HUMANA_HAMI a
	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.grp_id = grp.SRC_CODE)
    WHERE rn=1';
  EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/
------------------------------------------271895---------------------------------------

BEGIN
    EXECUTE IMMEDIATE
	'INSERT INTO zzz_memid_update_anthem
    SELECT memid,enrid,memfirstname,memlastname,gender,dob,lvl3id
    FROM(
    SELECT
		a.EMPLOYEE_ID||Decode(a.ELIG_SEX,''1'',''M'',''2'',''F'',''U'')||To_Char(a.DATE_OF_BIRTH,''YYYYMMDD'') AS MEMID,
		a.EMPLOYEE_ID AS ENRID,
		Upper(a.ELIG_FNAME) AS MEMFIRSTNAME,
		Upper(a.ELIG_LNAME) AS MEMLASTNAME,
		Decode(a.ELIG_SEX,''1'',''M'',''2'',''F'',''U'') AS GENDER,
		a.DATE_OF_BIRTH AS DOB,
		NVL(lvl3.rollupid,SubStr(A.ELIG_GROUP,1,6)) LVL3ID,
		Row_Number() OVER (PARTITION BY Upper(a.ELIG_FNAME), Upper(a.ELIG_LNAME), Decode(a.ELIG_SEX,''1'',''M'',''2'',''F'',''U''), a.DATE_OF_BIRTH
							ORDER BY a.ELIG_COV_EFF DESC, A.RECEIVEDMONTH DESC) rn
	FROM
		HI0826001.HI_ELIG_MMOH_ATRM a
	LEFT JOIN
		HR_826_MMOH_LVL2 LVL2
	ON
		SubStr(A.ELIG_GROUP,1,6) = LVL2.SRC_GROUP_CODE
	AND
		SubStr(A.ELIG_GROUP,7,3) = LVL2.SECTION_CODE
	LEFT JOIN
		HR_826_GROUP lvl3
	ON
		SubStr(A.ELIG_GROUP,1,6) = lvl3.SRC_CODE
    WHERE
		upper(NVL(LVL2.ROLLUP_DESC, SubStr(A.ELIG_GROUP,1,6)|| SubStr(A.ELIG_GROUP,7,3))) not like upper(''%DENTAL%'')
		)
    WHERE rn=1
	';
  EXCEPTION
    WHEN OTHERS THEN dbms_output.put_Line(sqlerrm);
END;
/

-------------------------------------------271895--------------------------------------
BEGIN
EXECUTE IMMEDIATE 'DROP TABLE zzz_memid_update_anthem1 PURGE';
EXCEPTION
WHEN OTHERS THEN NULL;
END;
/

---------------------------------------------------------------------------------

BEGIN
EXECUTE IMMEDIATE '
CREATE TABLE zzz_memid_update_anthem1 NOLOGGING PARALLEL 4
    AS
    SELECT MEMID,ENRID,MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVLID3
    FROM
		vh_eligibilities a
	WHERE 1 = 2';
EXCEPTION
WHEN OTHERS THEN NULL;
END;
/
---------------------------ICE 271567------------------------------------------------------

BEGIN
EXECUTE IMMEDIATE 'DROP TABLE zzz_memid_update_anthem_uhc PURGE';
EXCEPTION
WHEN OTHERS THEN NULL;
END;
/

--------------------------------ICE 271567-------------------------------------------------

BEGIN
    EXECUTE IMMEDIATE 'CREATE TABLE zzz_memid_update_anthem_uhc NOLOGGING PARALLEL 4
    as
    SELECT memid,enrid,memfirstname,memlastname,gender,dob,lvl3id
    FROM
    (
    SELECT
	  a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'') AS MEMID,
		a.SBSCRBR_ID AS	ENRID,
    UPPER(a.MBR_FIRST_NM) AS MEMFIRSTNAME,
		UPPER(a.MBR_LAST_NM) AS MEMLASTNAME,
		CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END AS  Gender,
		a.MBR_BRTH_DT  AS DOB,
		NVL(grp.ROLLUPID,a.ACCT_NBR) AS LVL3ID,
    Row_Number() OVER (PARTITION BY UPPER(a.MBR_FIRST_NM),UPPER(a.MBR_LAST_NM),CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END,a.MBR_BRTH_DT,nvl(grp.ROLLUPID,a.ACCT_NBR)
    ORDER BY a.MBR_EFCTV_DT desc,CASE WHEN a.mbr_term_dt > To_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') THEN
		to_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') ELSE a.mbr_term_dt END desc  NULLS LAST) rn
	FROM
		HI0826001.HI_ELIG_ANTHEM_FERN a
	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.ACCT_NBR = grp.src_code
   )
    WHERE rn=1';
  EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

--------------------------------ICE 287515-------------------------------------------------
BEGIN
    EXECUTE IMMEDIATE '	CREATE /*+PARALLEL(A,4)*/ TABLE zzz_elig_ardx_CIST
			AS
			SELECT
				MEMID,
				ENRID,
				MEMFIRSTNAME,
				MEMLASTNAME,
				GENDER,
				DOB,
				LVLID3,
				LVLDesc3,
				EFFDATE
			FROM
			(
				SELECT
			 MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3, LVLDesc3, EFFDATE ,
			 ROW_NUMBER() OVER (PARTITION BY MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3, LVLDesc3 ORDER BY EFFDATE NULLS LAST) RN
			 FROM (
					 SELECT /*+PARALLEL(A,4)*/
						 CASE
							WHEN a.ACCT_NBR IN (''00123728'', ''00172918'', ''00172421'', ''00169440'', ''00070454'',''00171314'',''00249106'',''00246533'') --275996
							THEN COALESCE(REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~''),''MEMBERID'')
							ELSE a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'') END AS MEMID,   --ice 254417     ICE263460
						 CASE
							WHEN a.ACCT_NBR IN (''00123728'', ''00172918'', ''00172421'', ''00169440'', ''00070454'',''00171314'',''00249106'',''00246533'') THEN COALESCE(REPLACE(a.SBSCRBR_ID,''~''),''EMPLOYEEID'')	--275996
							ELSE a.SBSCRBR_ID END AS ENRID,    --ice 254417  263460
							UPPER(a.MBR_FIRST_NM) AS MEMFIRSTNAME, --ICE259700,266811
							UPPER(a.MBR_LAST_NM) AS MEMLASTNAME,  --ICE259700,266811
						CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END AS  GENDER,
						a.MBR_BRTH_DT  AS DOB,
						nvl(grp.ROLLUPID,a.ACCT_NBR) AS LVLID3,
						nvl(grp.Group_Name,a.ACCT_NBR) AS LVLDesc3,
						a.MBR_EFCTV_DT AS EFFDATE

						FROM
							HI0826001.HI_ELIG_ANTHEM_CIST a
						LEFT JOIN
							HR_826_GROUP grp
						ON
							a.ACCT_NBR = grp.src_code
            LEFT JOIN
		          HR_826_ANTHEM_PLAN pl
	          ON
		          a.ACCT_NBR = pl.ACCT_NBR
	          AND
		          UPPER(a.PKG_NBR) = pl.src_code
						LEFT JOIN
							zzz_memid_update_anthem MEM
						ON
							UPPER(a.MBR_FIRST_NM) = MEM.MEMFIRSTNAME
						AND
							UPPER(a.MBR_LAST_NM) = MEM.MEMLASTNAME
						AND
							CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END = MEM.GENDER
						AND
							a.MBR_BRTH_DT = MEM.DOB
						AND 	--271895
							nvl(grp.ROLLUPID,a.ACCT_NBR)= mem.lvl3id
						WHERE
							NVL(pl.DROP_PLAN,''N'')=''N''
						) A  )
            WHERE RN=1
       '
	   ;

    EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

-------------------------------------------------------------------------------------------

---------------------------ICE 283275------------------------------------------------------

BEGIN
EXECUTE IMMEDIATE 'DROP TABLE ZZZ_MEMID_UPDATE_ANTHEM_WOOL PURGE';
EXCEPTION
WHEN OTHERS THEN NULL;
END;
/

--------------------------------ICE 283275-------------------------------------------------

BEGIN
EXECUTE IMMEDIATE 'CREATE TABLE ZZZ_MEMID_UPDATE_ANTHEM_WOOL NOLOGGING PARALLEL 4
    AS
    SELECT MEMID,ENRID,MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVL3ID
    FROM
    (
    SELECT
	  COALESCE(REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~''),''MEMBERID'')||''-''||nvl(GRP.ROLLUPID,a.ACCT_NBR) AS MEMID,
		a.SBSCRBR_ID||''-''||nvl(GRP.ROLLUPID,a.ACCT_NBR) AS	ENRID,
    UPPER(A.MBR_FIRST_NM) AS MEMFIRSTNAME,
		UPPER(A.MBR_LAST_NM) AS MEMLASTNAME,
		CASE WHEN A.MBR_GNDR_CD IN (''F'',''M'') THEN A.MBR_GNDR_CD ELSE ''U'' END AS  GENDER,
		A.MBR_BRTH_DT  AS DOB,
		nvl(GRP.ROLLUPID,a.ACCT_NBR) AS LVL3ID,
    ROW_NUMBER() OVER (PARTITION BY UPPER(A.MBR_FIRST_NM),UPPER(A.MBR_LAST_NM),CASE WHEN A.MBR_GNDR_CD IN (''F'',''M'') THEN A.MBR_GNDR_CD ELSE ''U'' END,A.MBR_BRTH_DT,nvl(GRP.ROLLUPID,a.ACCT_NBR)
    ORDER BY A.MBR_EFCTV_DT DESC,CASE WHEN A.MBR_TERM_DT > TO_DATE(SUBSTR(A.SOURCEFILENAME,INSTR(A.SOURCEFILENAME,''_'',-1,2)+1,8), ''YYYYMMDD'') THEN
		TO_DATE(SUBSTR(A.SOURCEFILENAME,INSTR(A.SOURCEFILENAME,''_'',-1,2)+1,8), ''YYYYMMDD'') ELSE A.MBR_TERM_DT END DESC NULLS LAST) RN
	FROM
		HI0826001.HI_ELIG_ANTHEM_WOOL A
	LEFT JOIN
		HR_826_GROUP GRP
	ON
		A.ACCT_NBR = GRP.SRC_CODE
  LEFT JOIN
		HR_826_ANTHEM_PLAN pl
	ON
		a.ACCT_NBR = pl.ACCT_NBR
	AND
		UPPER(a.PKG_NBR) = pl.src_code
  WHERE NVL(pl.DROP_PLAN,''N'')=''N''
   )
    WHERE RN=1';
EXCEPTION
WHEN OTHERS THEN NULL;
END;
/



--BEGIN
--        EXECUTE IMMEDIATE 'DROP TABLE ZZZ_UHC_WOOL_TWIN PURGE';
--        EXCEPTION WHEN OTHERS THEN NULL;
--END;
--/



--BEGIN
--        EXECUTE IMMEDIATE'
--        CREATE TABLE ZZZ_UHC_WOOL_TWIN NOLOGGING PARALLEL AS
--        SELECT /*+PARALLEL(A,4)*/
--	        GRP.ROLLUPID LVL3ID,COALESCE(SUBSTR(A.EMPLOYEENUMBER,-9),''EMPLOYEEID'') ENRID,UPPER(A.FIRSTNAME) MEMFIRSTNAME,UPPER(A.LASTNAME) MEMLASTNAME, NVL(A.BIRTHDATE,TO_DATE(''2000/01/01'',''YYYY/MM/DD'')) DOB, NVL(CASE WHEN A.SEX IN (''F'',''M'') THEN A.SEX ELSE ''U'' END,''X'') GENDER ,
--          COALESCE(SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID'') MEMID,
--          COALESCE(SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID'')||A.DEPENDENTNUMBER NEW_MEMID
--        FROM
--	        hi0826001.HI_ELIG_UHC_WOOL A
--          LEFT JOIN
--		        HR_826_GROUP@HAWKEYERULES GRP
--	        ON
--		        A.CUSTOMERSTRUCTURE1 = GRP.SRC_CODE
--        WHERE
--          COALESCE(SUBSTR(A.EMPLOYEENUMBER,-9),''EMPLOYEEID'') ||UPPER(A.LASTNAME) ||A.BIRTHDATE ||CASE WHEN A.SEX IN (''F'',''M'') THEN A.SEX ELSE ''U'' END IN
--	        (
--	        SELECT /*+PARALLEL(A,4)*/  COALESCE(SUBSTR(A.EMPLOYEENUMBER,-9),''EMPLOYEEID'') ||UPPER(A.LASTNAME) ||A.BIRTHDATE ||CASE WHEN A.SEX IN (''F'',''M'') THEN A.SEX ELSE ''U'' END
--          FROM hi0826001.HI_ELIG_UHC_WOOL A
--          GROUP BY COALESCE(SUBSTR(A.EMPLOYEENUMBER,-9),''EMPLOYEEID'') ||UPPER(A.LASTNAME) ||A.BIRTHDATE ||CASE WHEN A.SEX IN (''F'',''M'') THEN A.SEX ELSE ''U'' END
--          HAVING
--          (COUNT(DISTINCT UPPER(A.FIRSTNAME))>1
--          AND
--          COUNT(DISTINCT A.DEPENDENTNUMBER)>1)
--	        )
--        GROUP BY
--	        GRP.ROLLUPID ,COALESCE(SUBSTR(A.EMPLOYEENUMBER,-9),''EMPLOYEEID'') ,UPPER(A.FIRSTNAME) ,UPPER(A.LASTNAME) , NVL(A.BIRTHDATE,TO_DATE(''2000/01/01'',''YYYY/MM/DD'')) ,
--           NVL(CASE WHEN A.SEX IN (''F'',''M'') THEN A.SEX ELSE ''U'' END,''X'') ,COALESCE(SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID''),
--          COALESCE(SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID'')||A.DEPENDENTNUMBER  ORDER BY 2
--        ';
--EXCEPTION WHEN OTHERS THEN NULL;
--END;
--/

--------------------------------------------------------------------------------
-- MEMID/ENRID UPDATE FROM HISTORICAL PAYER ANTHEMRDX TO CDB        295787
--------------------------------------------------------------------------------
BEGIN
EXECUTE IMMEDIATE 'DROP TABLE ZZZ_MEMID_ANTHEM_CDB PURGE';
EXCEPTION
WHEN OTHERS THEN NULL;
END;
/

---------------------------------------------------------------------------------

BEGIN
    EXECUTE IMMEDIATE 'CREATE TABLE ZZZ_MEMID_ANTHEM_CDB NOLOGGING PARALLEL 4
    as
    SELECT memid,enrid,memfirstname,memlastname,gender,dob,lvl3id
    FROM(
    SELECT /*+PARALLEL (a,4)*/
		COALESCE(REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~''),''MEMBERID'')||''-''||nvl(grp.ROLLUPID,a.ACCT_NBR) AS MEMID,
		a.SBSCRBR_ID||''-''||nvl(grp.ROLLUPID,a.ACCT_NBR)  AS	ENRID,
		UPPER(a.MBR_FIRST_NM) AS MEMFIRSTNAME,
		UPPER(a.MBR_LAST_NM) AS MEMLASTNAME,
		CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END AS  Gender,
		a.MBR_BRTH_DT  AS DOB,
		nvl(grp.ROLLUPID,a.ACCT_NBR) AS LVL3ID,
    Row_Number() OVER (PARTITION BY UPPER(a.MBR_FIRST_NM),
    UPPER(a.MBR_LAST_NM),CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END,a.MBR_BRTH_DT,nvl(grp.ROLLUPID,a.ACCT_NBR)
    ORDER BY CASE WHEN TO_CHAR(CASE WHEN A.MBR_TERM_DT > TO_DATE(SUBSTR(A.SOURCEFILENAME,INSTR(A.SOURCEFILENAME,''_'',-1,2)+1,8), ''YYYYMMDD'') THEN
		TO_DATE(SUBSTR(A.SOURCEFILENAME,INSTR(A.SOURCEFILENAME,''_'',-1,2)+1,8), ''YYYYMMDD'') ELSE A.MBR_TERM_DT END) > ''20151231'' THEN TO_DATE(''20151231'',''YYYYMMDD'')
    ELSE
    CASE WHEN A.MBR_TERM_DT > TO_DATE(SUBSTR(A.SOURCEFILENAME,INSTR(A.SOURCEFILENAME,''_'',-1,2)+1,8), ''YYYYMMDD'') THEN
		TO_DATE(SUBSTR(A.SOURCEFILENAME,INSTR(A.SOURCEFILENAME,''_'',-1,2)+1,8), ''YYYYMMDD'') ELSE A.MBR_TERM_DT END END desc nulls last , a.MBR_EFCTV_DT desc nulls last) rn
	FROM
		HI0826001.HI_ELIG_ANTHEM_CSTA a
	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.ACCT_NBR = grp.src_code
    )
    WHERE rn=1';
  EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/
--MEMID/ENRID UPDATE FROM ELIG CSTA TO CLAIMS CSTA
-------------------------------------------295787--------------------------------------
-------------------------------------------4870--------------------------------------

	BEGIN
		EXECUTE IMMEDIATE 'DROP TABLE ZZZ_ELIG_ARDX_TWINS_CECO PURGE';
		EXCEPTION WHEN OTHERS THEN NULL;
	END;
	/
BEGIN
		EXECUTE IMMEDIATE
'CREATE TABLE ZZZ_ELIG_ARDX_TWINS_CECO NOLOGGING PARALLEL 4 AS
        SELECT /*+PARALLEL(A,4)*/
	        nvl(grp.ROLLUPID,a.ACCT_NBR) AS LVLID3,
			a.SBSCRBR_ID AS ENRID,
			UPPER(a.MBR_FIRST_NM) AS MEMFIRSTNAME,
			UPPER(a.MBR_LAST_NM) AS MEMLASTNAME,
			a.MBR_BRTH_DT  AS DOB,
			Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'') AS GENDER,
			a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'') AS MEMID,
			a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'')||''-''||a.MBR_SQNC_NBR NEW_MEMID
		FROM
			HI0826001.HI_ELIG_ANTHEM_CECO a
		LEFT JOIN
		HR_826_GROUP grp
	ON
		a.ACCT_NBR = grp.src_code
		 WHERE a.MBR_REL_CD IN (''02'',''03'',''04'',''05'',''06'',''07'',''08'',''09'',''10'',''11'',''12'',''13'',''14'',''15'',''16'',''17'',''19'',
                               ''22'',''23'',''24'',''26'',''31'',''32'',''33'',''36'',''38'',''39'',''40'',''41'',''43'',''60'',''D2'') AND
          a.SBSCRBR_ID||UPPER(a.MBR_LAST_NM)|| a.MBR_BRTH_DT ||Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'') IN
	        (

	        SELECT /*+PARALLEL(A,4)*/   a.SBSCRBR_ID||UPPER(a.MBR_LAST_NM)|| a.MBR_BRTH_DT ||Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')
          FROM hi0826001.HI_ELIG_ANTHEM_CECO A
          GROUP BY a.SBSCRBR_ID||UPPER(a.MBR_LAST_NM)|| a.MBR_BRTH_DT ||Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')
          HAVING
          (COUNT(DISTINCT UPPER(a.MBR_FIRST_NM))>1
          AND
          COUNT(DISTINCT a.MBR_SQNC_NBR)>1)
	       )
        GROUP BY
			nvl(grp.ROLLUPID,a.ACCT_NBR) ,a.SBSCRBR_ID ,UPPER(a.MBR_FIRST_NM) ,UPPER(a.MBR_LAST_NM) , a.MBR_BRTH_DT ,Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U''),
			a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD''),
			a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'')||''-''||a.MBR_SQNC_NBR
	ORDER BY 2';


	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	/
-------------------------------------------4870--------------------------------------

BEGIN
EXECUTE IMMEDIATE 'DROP TABLE ZZZ_MEMID_UPDATE_CSTA PURGE';
EXCEPTION
WHEN OTHERS THEN NULL;
END;
/
-------------------------------------------------------------------------------------------

BEGIN
EXECUTE IMMEDIATE '
CREATE TABLE ZZZ_MEMID_UPDATE_CSTA NOLOGGING PARALLEL 4
    AS
    SELECT MEMID,ENRID,MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVLID3
    FROM
		VH_ELIGIBILITIES A
	WHERE 1 = 2';
EXCEPTION
WHEN OTHERS THEN NULL;
END;
/


BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ZZZ_UNIQUE_DIAG_LIST';
  EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
  EXECUTE IMMEDIATE
  'CREATE TABLE ZZZ_UNIQUE_DIAG_LIST NOLOGGING AS
  SELECT /*+ PARALLEL(a,4) */  DIAGCODE,DIAGTYPEDESC FROM HAWKEYEMASTER.M_DIAGS a
  WHERE DIAGCODE NOT IN
  (
    SELECT /*+ PARALLEL(a,4) */  DIAGCODE FROM HAWKEYEMASTER.M_DIAGS a
    GROUP BY DIAGCODE
    HAVING COUNT(*)>1
  )';
END;
/


-------------------------------------------------------------------------------------
BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE VH_ELIGIBILITIES_PMPR FORCE';
        EXCEPTION WHEN OTHERS THEN NULL;
END;
/

------------------------------------------------------------------------------
BEGIN
        EXECUTE IMMEDIATE 'CREATE TABLE VH_ELIGIBILITIES_PMPR NOLOGGING
                                AS
                                SELECT * FROM VH_ELIGIBILITIES WHERE ROWNUM<1';
        EXCEPTION WHEN OTHERS THEN NULL;
END;
/

--------------------------------------------------------------------------------
BEGIN
    EXECUTE IMMEDIATE 'DROP SEQUENCE rowindexElg';
    EXCEPTION WHEN OTHERS THEN NULL;
END;
/
--------------------------------------------------------------------------------
CREATE SEQUENCE rowindexElg
  MINVALUE 1
  MAXVALUE 9999999999999
  INCREMENT BY 1
  NOCYCLE
  ORDER
  NOCACHE
/


--------------------------------------------------------------------------------
BEGIN
    EXECUTE IMMEDIATE 'DROP SEQUENCE rowindexClm';
    EXCEPTION WHEN OTHERS THEN NULL;
END;
/
--------------------------------------------------------------------------------
CREATE SEQUENCE rowindexClm
  MINVALUE 1
  MAXVALUE 9999999999999
  INCREMENT BY 1
  NOCYCLE
  ORDER
  NOCACHE
/

--------------------------------------------------------------------------------
BEGIN
    EXECUTE IMMEDIATE 'DROP SEQUENCE rowindexRx';
    EXCEPTION WHEN OTHERS THEN NULL;
END;
/
--------------------------------------------------------------------------------
CREATE SEQUENCE rowindexRx
  MINVALUE 1
  MAXVALUE 9999999999999
  INCREMENT BY 1
  NOCYCLE
  ORDER
  NOCACHE
/


---------------------------------------------------------------------------------

DECLARE
        vblQueryName VARCHAR2(20);
		vb_query varchar2(200);     --MI Implementation
		v_appid varchar2(3);		--MI Implementation
BEGIN
        vblQueryName:='060_826_005';

		vb_query := 'SELECT SubStr(USER,7,3) FROM DUAL';   	--MI Implementation
		Execute immediate vb_query into v_appid;        	--MI Implementation

        INSERT INTO VH_CLIENTS
        (
			ClientID,
			ClientName,
			APPID,
			APPNAME,
			APPTYPE,
			ISCDF,
			PRODUCTTYPE,
			HP_APPID,
			I_SOURCE,
			PROCESS_CUSTOM_EDW,
			HAS_EI
        )
        SELECT
			CLIENTID,
			CLIENTNAME,
			CLIENTID ||'-'|| v_appid AS APPID,		--MI Implementation
			'Horan Associates' AS APPNAME,	--343328
			--NULL AS APPTYPE,	--343328   	--MI Implementation
			CASE WHEN v_appid IN  ('004','001') THEN 'SMI' END AS APPTYPE,   		--MI Implementation (-- APPTYPE ='SMI' added as per Defect ICE-4855 Since we are giving both EI and MI app )
			'Y' AS ISCDF,
			'PAYOR' AS PRODUCTTYPE,	--343328
			NULL AS HP_APPID,	--343328
			'VH' AS I_SOURCE,	--343328
			'N' AS PROCESS_CUSTOM_EDW,	--343328
			CASE WHEN v_appid = '004' THEN 'N' ELSE 'Y' END AS HAS_EI	--343328	ice#3326
        FROM
		   HAWKEYEMASTER.M_CLIENTS
        WHERE
			CLIENTID ='826';
	COMMIT;

DBMS_OUTPUT.PUT_LINE('Query Executed: ' || vblqueryName);
INSERT INTO VH_QUERYLOG(QueryName) VALUES(vblQueryName);
EXCEPTION WHEN NO_DATA_FOUND THEN NULL;
END;
/


---------------------------------------------------------------------------------
DECLARE
        vblQueryName VARCHAR2(20);
BEGIN
        vblQueryName:='060_826_010';
        INSERT INTO VH_RUNDATE
        (
                CYCLESTARTDATE,
                CYCLEENDDATE
        )
        SELECT
                CYCLESTARTDATE,
                CYCLEENDDATE
        FROM
                HR_Global_RunDates a
        WHERE
                a.CLIENTID ='826';

COMMIT;

DBMS_OUTPUT.PUT_LINE('Query Executed: ' || vblqueryName);
INSERT INTO VH_QUERYLOG(QueryName) VALUES(vblQueryName);
EXCEPTION WHEN NO_DATA_FOUND THEN NULL;
END;
/

--229688---------------------------------------------------------------------------------
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE  zzz_Fac_NPI';
  EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
  EXECUTE IMMEDIATE
  'CREATE TABLE zzz_Fac_NPI NOLOGGING AS
	SELECT DISTINCT To_Char(NPI)AS npi_facility FROM HAWKEYEMASTER.M_NPI_DATA b
	JOIN   HAWKEYEMASTER.M_NPI_TAXONOMYCODES c
	ON     c.TAXONOMY_CD = Decode(''Y'', b.H_P_P_T_SWITCH_1, b.H_P_T_CODE_1,
								b.H_P_P_T_SWITCH_2, b.H_P_T_CODE_2,
								b.H_P_P_T_SWITCH_3, b.H_P_T_CODE_3,
								b.H_P_P_T_SWITCH_4,b.H_P_T_CODE_4,
								b.H_P_P_T_SWITCH_5,b.H_P_T_CODE_5,
								b.H_P_P_T_SWITCH_6,b.H_P_T_CODE_6,
								b.H_P_P_T_SWITCH_7, b.H_P_T_CODE_7,
								b.H_P_P_T_SWITCH_8,b.H_P_T_CODE_8,
								b.H_P_P_T_SWITCH_9, b.H_P_T_CODE_9,
								b.H_P_P_T_SWITCH_10, b.H_P_T_CODE_10,
								b.H_P_P_T_SWITCH_11, b.H_P_T_CODE_11,
								b.H_P_P_T_SWITCH_12, b.H_P_T_CODE_12,
								b.H_P_P_T_SWITCH_13, b.H_P_T_CODE_13,
								b.H_P_P_T_SWITCH_14, b.H_P_T_CODE_14,
								b.H_P_P_T_SWITCH_15, b.H_P_T_CODE_15, b.H_P_T_CODE_1)
								AND    c.TAXGRPDESC3=''Non-individual''
';
END;
/


-------------------------------------------------------------------------------------
---------------------------------------------------------------------------------
------------------------- Populating ProcCodes from master---------
---------------------------------------------------------------------------------
DECLARE
        vblQueryName VARCHAR2(20);
BEGIN
        vblQueryName:='060_826_020';
		-- Upper removed from  Proctypedesc as per ICE#160629
		INSERT INTO ZZZ_PROCS(PROCCODE,PROCTYPEDESC,CNT)
		SELECT PROCCODE,MAX(PROCTYPEDESC) AS PROCTYPEDESC,COUNT(DISTINCT PROCTYPEDESC) AS CNT
		FROM HAWKEYEMASTER.M_PROCS
		GROUP BY PROCCODE;

        COMMIT;

		INSERT INTO ZZZ_SPECS(PROCCODE,IMPLIEDSPECCODE,IMPLIEDSPECDESC)
		SELECT PROCCODE,IMPLIEDSPECCODE,IMPLIEDSPECDESC
		FROM (
				SELECT PROCCODE,IMPLIEDSPECCODE,UPPER(IMPLIEDSPECDESC) IMPLIEDSPECDESC,ROW_NUMBER() OVER (PARTITION BY PROCCODE ORDER BY IMPLIEDSPECDESC DESC,IMPLIEDSPECCODE DESC) RN
				FROM HAWKEYEMASTER.M_PROCS
			 )
		WHERE RN=1
		GROUP BY PROCCODE,IMPLIEDSPECCODE,IMPLIEDSPECDESC;

        COMMIT;

		INSERT INTO ZZZ_DIAGS(DIAGCODE,DIAGTYPEDESC,CNT)
		SELECT DIAGCODE,MAX(DIAGTYPEDESC) AS DIAGTYPEDESC,COUNT(DISTINCT DIAGTYPEDESC) AS CNT
		FROM HAWKEYEMASTER.M_DIAGS
		GROUP BY DIAGCODE;

        COMMIT;

		INSERT INTO ZZZ_M_MODIFIERS(modifiercode,modifierdesc)
		SELECT modifiercode,MAX(modifierdesc) AS modifierdesc
		FROM HAWKEYEMASTER.M_MODIFIERS
		GROUP BY modifiercode;

        COMMIT;

		INSERT INTO zzz_NPI(NPI,ProviderName,entity_type_code)
		SELECT
			NPI,
			UPPER(COALESCE(P_O_N_LEGAL_BUSINESS_NAME,PROVIDER_LAST_NAME_LEGAL_NAME||' '||PROVIDER_FIRST_NAME||' '||PROVIDER_MIDDLE_NAME)) AS ProviderName,
			entity_type_code as entity_type_code
		FROM hawkeyemaster.M_Npi_data
		WHERE
		COALESCE(P_O_N_LEGAL_BUSINESS_NAME,PROVIDER_LAST_NAME_LEGAL_NAME,PROVIDER_FIRST_NAME,PROVIDER_MIDDLE_NAME) IS NOT NULL;
		COMMIT;

		INSERT INTO zzz_NPI(NPI,ProviderName)
		SELECT
			DEAID,
			DEANAME AS ProviderName
		FROM hawkeyemaster.M_deaNames
		WHERE
			DEAID IS NOT NULL and DEANAME is not null;
		COMMIT;

DBMS_OUTPUT.PUT_LINE('Query Executed: ' || vblqueryName);
INSERT INTO VH_QUERYLOG(QueryName) VALUES(vblQueryName);
DBMS_STATS.GATHER_TABLE_STATS(OWNNAME => USER, TABNAME => 'zzz_Procs', ESTIMATE_PERCENT=> DBMS_STATS.AUTO_SAMPLE_SIZE,DEGREE=>4);
DBMS_STATS.GATHER_TABLE_STATS(OWNNAME => USER, TABNAME => 'ZZZ_DIAGS', ESTIMATE_PERCENT=> DBMS_STATS.AUTO_SAMPLE_SIZE,DEGREE=>4);
DBMS_STATS.GATHER_TABLE_STATS(OWNNAME => USER, TABNAME => 'ZZZ_M_MODIFIERS', ESTIMATE_PERCENT=> DBMS_STATS.AUTO_SAMPLE_SIZE,DEGREE=>4);
DBMS_STATS.GATHER_TABLE_STATS(OWNNAME => USER, TABNAME => 'zzz_NPI', ESTIMATE_PERCENT=> DBMS_STATS.AUTO_SAMPLE_SIZE,DEGREE=>4);
EXCEPTION WHEN NO_DATA_FOUND THEN NULL;
END;
/

---------------------------------------------------------------------------------
---------------------              TABLES                     -------------------
---------------------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE 'DROP TABLE TBL_CHECKERROR';EXCEPTION WHEN OTHERS THEN NULL; END;
/

CREATE TABLE TBL_CHECKERROR
(
  ID VARCHAR2(1000)
)NOLOGGING;


BEGIN EXECUTE IMMEDIATE 'DROP TABLE TBL_SCRUB_MAIN';EXCEPTION WHEN OTHERS THEN NULL; END;
/

CREATE TABLE TBL_SCRUB_MAIN
(
  MODULE_ID NUMBER(10),
  PROCEDURE_NAME VARCHAR2(100),
  WAITFOR VARCHAR2(100)
)nologging;




EXEC SP_DROPZZZTABLES('tbl_scrub_status');

CREATE TABLE tbl_scrub_status (
	MODULE_ID NUMBER(10,0) NULL,
	status_id NUMBER(1,0)  NULL,
	starttm   DATE         NULL,
	endtm     DATE         NULL
)NOLOGGING;

EXEC SP_DROPZZZTABLES('tbl_error_log');

CREATE TABLE tbl_error_log(errmsg VARCHAR2(1000), jobid NUMBER(10), procname VARCHAR2(50),logtime date default sysdate);

EXEC SP_DROPZZZTABLES('TBL_PROCESSINGPARAMS');

CREATE TABLE TBL_PROCESSINGPARAMS(
    DOP number(1)
)NOLOGGING;




------------------------------------------For Scrub Verification each employeer Group--------------------------------


-----------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------- D2SCRUB -----------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------
CREATE OR REPLACE PACKAGE d2scrub
AS

  PROCEDURE SP_EXECQUERY (stmt LONG);

  type str_array is table of VARCHAR2(4000);
  subtype tString   is varchar2(200);
  subtype tJob      is varchar2(64);
  subtype tDBString is varchar2(255);

  type tArrayJob is table of tJob index by pls_integer;
  type tRecNextJob is record (module_id number(10), procname tString);
  type tArrayNextJob is table of tRecNextJob index by PLS_INTEGER;
  type tArraySeqByJob is table of number index by tJob;

  PROCEDURE sp_loginfo(schemaname varchar, queryid in varchar);

  function split(str varchar2,delimiter varchar2) return str_array;
  function fn_checkforwait(module_id in number, SchemaName in tString) RETURN boolean;
  function fn_findnextmod(SchemaName in tString) RETURN tArrayNextJob;

  PROCEDURE log_error(errmsg_IN IN VARCHAR2, job_id IN NUMBER, procname IN varchar2) ;
  PROCEDURE AddJob   (SchemaName tString);
  PROCEDURE Execute  (pJob in tJob,pCommit in boolean := true);
  PROCEDURE Execute   (pJobs in tArrayJob,pCommit in boolean := true);


   /*
    * SignalCompletion
    *
    * Send an alert to signal job completion.
    */
   PROCEDURE SignalCompletion
   (
      pJob     in tJob,
      pMessage in tDBString := NULL
   );

   /*
    * WaitForCompletion
    *
    * Waits for completion of all parallel jobs
    * from the array pJobs passed as a parameter.
    */
   PROCEDURE WaitForCompletion
   (
      pJobs tArrayJob,
      SchemaName tString
   );
END D2SCRUB;
/

CREATE OR REPLACE PACKAGE BODY d2scrub
AS
  PROCEDURE SP_EXECQUERY (stmt LONG)
  IS
BEGIN
    EXECUTE IMMEDIATE(stmt);
    EXCEPTION WHEN OTHERS THEN
       DBMS_OUTPUT.PUT_LINE(SQLERRM);
  END SP_EXECQUERY;


  PROCEDURE log_error(errmsg_IN IN VARCHAR2, job_id IN NUMBER, procname IN varchar2)
    IS
  BEGIN
   INSERT INTO tbl_error_log(errmsg, jobid, procname)
   VALUES (errmsg_IN, job_id, procname);
   commit;
  END log_error;

  PROCEDURE SP_LOGINFO(SCHEMANAME VARCHAR, QUERYID IN VARCHAR)
  IS
   STMNT LONG;
  BEGIN
     STMNT := 'INSERT INTO '||SCHEMANAME||'.VH_QUERYLOG(QUERYNAME) VALUES ('''||QUERYID||''')';
     SP_EXECQUERY(STMNT);
      COMMIT;
  END SP_LOGINFO;


  FUNCTION fn_checkforwait
  (
    module_id number,
    SchemaName tString
  )
  RETURN BOOLEAN
  IS
     type tArrayWaits is table of NUMBER(10);
     vWaitFor VARCHAR2(1000);
     p_array str_array;
     vCheck BOOLEAN := true;
     vStatus NUMBER(10);
     vLastModule NUMBER(10);
  BEGIN

      insert into tbl_checkerror select 'check for wait called' from dual;

      execute immediate 'select waitfor from '||SchemaName||'.tbl_scrub_main where module_id='||module_id into vWaitFor;

      insert into tbl_checkerror select 'check for wait called >>>'||vwaitfor from dual;

      p_array := split(vWaitFor,',');
      for i in 1 .. p_array.Count LOOP
          execute immediate 'select Count(*) from '||SchemaName||'.tbl_scrub_status where module_id='||p_array(i)||' and status_id = 0' into vStatus;
          if (vStatus <> 1) AND (p_array(i)<>'0') THEN
              vCheck := false; --waitfor module running or have not yet initiated
          end if;
      end loop;

      insert into tbl_checkerror select 'check for wait completed for >>>'||vwaitfor from dual;
      return vCheck;
  END fn_checkforwait;


  FUNCTION fn_findnextmod(
    SchemaName tString
  )
  RETURN
    tArrayNextJob
  IS
     vNextModule NUMBER(10);
     vCheck BOOLEAN;
     d2scrub_Crawl sys_refcursor;
     pNextJobs tArrayNextJob;
     procname varchar2(200);
     sqlstr varchar2(1000);
     i pls_integer;
     vLastModule number(10);
     mysql1 varchar2(1000);
  BEGIN

      insert into tbl_checkerror select 'findnextjob called' from dual;
        i:=0;

     mysql1:='select count(*) from '||SchemaName||'.tbl_scrub_main a where module_id<5000
                  and a.module_id<>1
                                        and not exists(select 1 from '||SchemaName||'.tbl_scrub_status b
                                                    where a.module_id=b.module_id and b.status_id=0)';

          execute immediate mysql1 into vLastModule;

         if vLastModule >0 then

            sqlstr := 'select module_id from(select * from '||SchemaName||'.tbl_scrub_main a
                            where   not exists(select 1 from '||SchemaName||'.tbl_scrub_status b where a.module_id=b.module_id)
                            and module_id<5000
                          order by to_number(case when InStr(waitfor, '','')>1 then substr(waitfor, 1,InStr(waitfor, '','')-1) else waitfor end) asc)';
    ELSE

         sqlstr := 'select module_id from(select * from '||SchemaName||'.tbl_scrub_main a
                                    where   not exists(select 1 from '||SchemaName||'.tbl_scrub_status b where a.module_id=b.module_id)
                                    and module_id>5000
                          order by to_number(case when InStr(waitfor, '','')>1 then substr(waitfor, 1,InStr(waitfor, '','')-1) else waitfor end) asc)';



    END IF;


      OPEN d2scrub_Crawl FOR sqlstr;
      loop
        fetch d2scrub_Crawl into vNextModule;
          exit when d2scrub_Crawl%notfound;

            insert into tbl_checkerror select 'before check for wait called' from dual;

              vCheck:=fn_checkforwait(vNextModule, SchemaName);

            insert into tbl_checkerror select 'after check for wait' from dual;

              if vCheck then
                  i := i+1;

                  mysql1 :='select UPPER(procedure_name) procedure_name from '||SchemaName||'.tbl_scrub_main where module_id='||vNextModule ;

                  insert into tbl_checkerror select mysql1 from dual;

                  execute immediate mysql1 into procname;


                  pNextJobs(i).module_id := vNextModule;
                  pNextJobs(i).procname := procname;
              END IF;
      END LOOP;
      CLOSE d2scrub_Crawl;
      RETURN pNextJobs;
  END fn_findnextmod;

PROCEDURE AddJob
  (
      SchemaName tString
  )
  is
    vJobName  tJob;
    nVacantIndex pls_integer;
    nIndex pls_integer;
    vNextJobs tArrayNextJob;
    i pls_integer;
    vJbCount NUMBER(10);
    vMaxJbCount NUMBER(10);
    module_id NUMBER(10);
    b_modid varchar2(20);
    b_jobname VARCHAR2(50);
    vTempSQL VARCHAR2(500);
    vblDOP Numeric;
  vdiff numeric := 0;

  BEGIN
      i:=1;
    --do not repeat failed jobs
      FOR j IN (SELECT job, what FROM user_jobs a, tbl_error_log b where a.job=b.jobid and a.broken='N')
      LOOP
        vTempSQL:= SubStr(j.what, InStr(j.what, 'BEGIN'), InStr(j.what, 'EXCEPTION'));
        vTempSQL :=Trim(substr(vTempSQL,regexp_instr(vTempSQL, 'HP[[:digit:]]+'), InStr(vTempSQL, ';')));
        b_jobname :=SubStr(vTempSQL,1, Length(vTempSQL)-2);
        EXECUTE IMMEDIATE 'SELECT module_id FROM '||SchemaName||'.tbl_scrub_main WHERE UPPER(procedure_name)='''||REPLACE(b_jobname, SchemaName||'.', '')||'''' INTO b_modid;

          Dbms_Job.broken(j.job, TRUE);
        BEGIN d2scrub.signalCompletion(b_jobname); EXCEPTION WHEN OTHERS THEN Dbms_Output.put_Line(SQLERRM); END;
          Dbms_Job.remove(j.job);
          Utility.sp_suspendJobs(j.job);
          EXECUTE IMMEDIATE 'UPDATE '||SchemaName||'.tbl_scrub_status SET status_id = 0 WHERE module_id='''||b_modid||'''';

        COMMIT;
      END LOOP;
      commit;
      vNextJobs := fn_findnextmod(SchemaName);
      Dbms_Output.put_line(vNextJobs.Count);

      execute immediate 'SELECT DOP FROM  '||SchemaName||'.tbl_processingparams ' into vblDOP;

      vMaxJbCount := least(vNextJobs.Count, vblDOP);

      SELECT Count(*) INTO vJbCount FROM user_jobs WHERE BROKEN <> 'Y';

     if vNextJobs.Count > 0 then
            vdiff := vblDOP - vJbCount;
            vdiff := least(vNextJobs.Count,vdiff);
      end if;

    for nIndex in 1..vdiff
      loop
          vJobName := SchemaName||'.'||vNextJobs(i).procname;
          Execute(vJobName);
          dbms_alert.register(vJobName);
          EXECUTE IMMEDIATE 'insert into '||SchemaName||'.tbl_scrub_status(module_id, status_id, starttm) select '||vNextJobs(i).module_id||',1, sysdate from dual';
          COMMIT;
          i:=i+1;
      end loop;
end AddJob;

  FUNCTION BuildAlertName
  (
       pJob in tJob
  )
    return tString
  IS
  vAlert tString;
  BEGIN
      IF LENGTH(pJob) <= 30 THEN
          vAlert := upper(pJob);
      ELSE
        IF INSTR(PJOB, '.') > 0  THEN
            vAlert := UPPER(SUBSTR(pJob, INSTR(pJob, '.') + 1));
        ELSE
            vAlert := UPPER(SUBSTR(pJob, 1, 30));
        END IF;
      END IF;

    return vAlert;
   END BuildAlertName;

   /*
    * Executes single job by submiting it to the job queue.
    */
   procedure Execute
   (
      pJob    in tJob,
      pCommit in boolean := true
   )
   is

      vJob     tJob := ltrim(rtrim(pJob));
      vJobNum  binary_integer;
      vSQLString VARCHAR2(2000);
      vinstance binary_integer;

   begin

      if substr(vJob, -1) != ';'
      then
         vJob := vJob || ';';
      end if;
      vJob:=REPLACE(vJob, ''', ''''');

      select instance_number into vinstance FROM  v$instance;

      vSQLString := 'DECLARE errcode NUMBER;
                      jobid number;
                      BEGIN '||vJob||'
                      EXCEPTION WHEN OTHERS THEN
                        errcode := SQLCODE;
                        ROLLBACK;
                        select max(job) into jobid from user_jobs where instr(what, '''||REPLACE(vJob, '''', '')||''')>0;
                        d2scrub.log_error(SQLERRM(errcode), jobid, '''||REPLACE(vJob, '''', '')||''');
                        COMMIT;
                        RAISE;
                    END;';
            dbms_job.submit
            (
            job=>vJobNum,
            what=>vSQLString,
            instance=>vinstance
            );
      if pCommit
      then
         commit;
      end if;

   end Execute;

 /*
  * Executes set of jobs by submiting it to the job queue.
  */

   procedure Execute
   (
      pJobs   in tArrayJob,
      pCommit in boolean := true
   )
   is

      vJobNum  binary_integer;

   begin

      if pJobs.count > 0
      then
         for nIndex in pJobs.first..pJobs.last
         loop
             Execute(pJobs(nIndex), (not pCommit));
         end loop;

         if pCommit
         then
            commit;
         end if;
      end if;

   end Execute;


   /*
    * SignalCompletion
    *
    * Send an alert to signal job completion.
    */

   procedure SignalCompletion
   (
      pJob     in tJob,
      pMessage in tDBString := NULL
   )
   IS
    mod_id NUMBER(10);
    SchemaName tString;
    vstrsql varchar2(1000);
   BEGIN
          insert into tbl_checkerror values ('SignalCompletion called');
          commit;

             SchemaName := Trim(SubStr(pJob, 1, InStr(pJob, '.')-1));

             vstrsql:= 'SELECT module_id FROM '||SchemaName||'.tbl_scrub_main WHERE replace(procedure_name,'''''''','''') = UPPER('''||replace(Trim(SubStr(pJob, InStr(pJob, '.')+1, Length(pJob))),'''','')||''')' ;

            insert into tbl_checkerror select vstrsql from dual;
            commit;

             EXECUTE IMMEDIATE vstrsql INTO mod_id ;

            insert into tbl_checkerror values('SignalCompletion modid'||mod_id);

        commit;

          EXECUTE IMMEDIATE 'update '||SchemaName||'.tbl_scrub_Status set status_id=0, endtm=sysdate where module_id = '||mod_id;
          COMMIT;

          insert into tbl_checkerror values('SignalCompletion modid'||mod_id);
          commit;


          Dbms_Output.put_line('Module id:'||mod_id);

          BEGIN
                dbms_alert.signal(BuildAlertName(pJob), nvl(pMessage, pJob || ' completed.'));
          EXCEPTION WHEN OTHERS THEN
            EXECUTE IMMEDIATE 'insert into '||SchemaName||'.tbl_error_log(errmsg, jobid, procname) select '''||SubStr(SQLERRM, 1, 50)||''', -1,'''||mod_id||''' from dual';
            COMMIT;
          END;
      COMMIT;

   end SignalCompletion;



   /*
    * WaitForCompletion
    *
    * Waits for completion of all parallel jobs
    * from the array pJobs passed as a parameter.
    */
   procedure WaitForCompletion
   (
      pJobs tArrayJob,
      SchemaName tString
   )
   is
      vAlerts   tArraySeqByJob;
      vAlert    tJob;
      vName     tJob;
      vMessage  tDBString;
      vStatus   pls_integer;
      vTimeOut  pls_integer := 60;
      tComplete PLS_INTEGER :=100;
      vErrMsg varchar2(50);
      vCnt  Number(5);
   begin

      if pJobs.count > 0
      then
         /*
          * Step 1.
          * Build array of alerts.
          */
          for nIndex in pJobs.first..pJobs.last
          loop
             vAlerts(BuildAlertName(pJobs(nIndex))) := nIndex;
          end loop;

         /*
          * Step 2.
          * Register for alerts.
          */
          vAlert := vAlerts.first;
          while (vAlert is not null)
          loop
             dbms_alert.register(vAlert);
             vAlert := vAlerts.next(vAlert);
          end loop;

          /*
           * Step 3.
           * Waiting until all of the alerts are received.
           */
          WHILE (true)
          loop
            begin
             dbms_alert.waitany(vName, vMessage, vStatus, vTimeOut);

       SELECT Count(*) INTO vCnt FROM user_jobs WHERE instr(what, SchemaName) > 0;
       IF (vstatus = 1  AND  vCnt = 0) THEN
          vstatus := 0;
        END IF;


             if vStatus = 0
             then
                dbms_alert.remove(vName);
                vAlerts.delete(vName);
                dbms_output.put_line('Received alert: ' || vName ||
                                     ' with message: '  || vMessage);
                AddJob(SchemaName);
             end if;
             EXECUTE IMMEDIATE 'SELECT b.RecCount-a.RecCount FROM
                                    (SELECT Count(*) RecCount FROM '||SchemaName||'.tbl_scrub_status WHERE status_id=0) a,
                                    (SELECT Count(*) RecCount FROM '||SchemaName||'.tbl_scrub_main) b' INTO tComplete;
            EXCEPTION WHEN OTHERS THEN
                vErrMsg := substr(SQLERRM, 1, 50);
                Dbms_Output.put_line('Execution Complete!!!'||SQLERRM);
                tComplete:=0;
            END;
            IF (tComplete=0) THEN
                EXIT;
            END IF;
          end loop;
     end if;

   end WaitForCompletion;

function split(str varchar2,delimiter varchar2)
return str_array
as
val_list str_array;
head varchar2(4000);
tail varchar2(4000); i number :=1;
do_loop boolean := true;
begin -- Initialize array
val_list := str_array('');
tail := str;
while do_loop loop
  head := substr(tail,1,instr(tail,delimiter,1,1)-1);
    if instr(tail,delimiter,1,1) > 0 then
      if i = 1 then
          val_list.DELETE(1);
          val_list(i) := head;
        else
          val_list.EXTEND;
          val_list(i) := head;
      end if;
    else if i <> 1 then
      val_list.EXTEND; end if;
      val_list(i) := tail;
      do_loop := false;
    end if;
    i := i + 1;
    tail := substr(tail,instr(tail,delimiter,1,1)+1,length(tail));
end loop;
    return val_list;
END split;

END D2SCRUB;
/


-------------------------------------------------------------------------------------------------
CREATE OR REPLACE PROCEDURE SP_INIT IS
  SchemaName VARCHAR2(20);
BEGIN
      select sys_context('USERENV', 'CURRENT_USER')
      INTO SchemaName
      from dual;

      D2SCRUB.signalCompletion(SchemaName || '.SP_INIT');
END;
/



/********************************CONFIGURATION SCRIPT ***********************************************/

BEGIN EXECUTE IMMEDIATE 'DROP TABLE TBL_CLIENTCONFIG CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/

CREATE TABLE TBL_CLIENTCONFIG
(
  CLIENTID NUMBER(10),
  FIELDNAME VARCHAR2(10) NOT NULL,
  SOURCETABLE VARCHAR2(50) NOT NULL,
  PRIMARY KEY(CLIENTID)
)NOLOGGING;


INSERT INTO TBL_CLIENTCONFIG VALUES(826,'EMPGRPID','HR_826_PKG_EMPPAYER');
COMMIT;


BEGIN EXECUTE IMMEDIATE 'DROP TABLE TBL_DEPENDENCY_CONFIG'; EXCEPTION WHEN OTHERS THEN NULL; END;
/

CREATE TABLE TBL_DEPENDENCY_CONFIG
(
  CLIENTID NUMBER(10) ,
  PROCID NUMBER(10) NOT NULL,
  PARAM VARCHAR2(50) NOT NULL,
  PROCNAME VARCHAR2(50) NOT NULL,
  WAITFOR VARCHAR2(50) NOT NULL,
  FOREIGN KEY (CLIENTID)    REFERENCES TBL_CLIENTCONFIG
)NOLOGGING;

INSERT INTO TBL_DEPENDENCY_CONFIG SELECT 826,1,'IMP','SP_ED','0' FROM DUAL;
INSERT INTO TBL_DEPENDENCY_CONFIG SELECT 826,2,'ELIG_SCRUB','SP_SE','1' FROM DUAL;
INSERT INTO TBL_DEPENDENCY_CONFIG SELECT 826,3,'ELIG_MERGE','SP_ME','1,2' FROM DUAL;
INSERT INTO TBL_DEPENDENCY_CONFIG SELECT 826,4,'MED_SCRUB','SP_SC','1,2,3' FROM DUAL;
INSERT INTO TBL_DEPENDENCY_CONFIG SELECT 826,5,'RX_SCRUB','SP_SR','1,2,3' FROM DUAL;

INSERT INTO TBL_DEPENDENCY_CONFIG SELECT 826,6,'MED_MERGE','SP_MC','1,2,3,4' FROM DUAL;
INSERT INTO TBL_DEPENDENCY_CONFIG SELECT 826,7,'RX_MERGE','SP_MR','1,2,3,5' FROM DUAL;
INSERT INTO TBL_DEPENDENCY_CONFIG SELECT 826,8,'LAB_SCRUB','SP_LB','1,2,3,4' FROM DUAL;
INSERT INTO TBL_DEPENDENCY_CONFIG SELECT 826,9,'HRA_SCRUB','SP_HR','1,2,3,4' FROM DUAL;
INSERT INTO TBL_DEPENDENCY_CONFIG SELECT 826,10,'HRA_MERGE','SP_MH','1,2,3,4,9' FROM DUAL;


COMMIT;




/********************************CONFIGURATION SCRIPT END *****************************************************/


/********************************CLIENT SPECIFIC SCRIPT *****************************************************/

/******************************************************************
  ASSUMPTIONS:
    1. FINAL TABLE IS TBL_SCRUB_MAIN
    2. SOURCE TABLES:
                      A. TBL_CLIENTCONFIG
                      B. TBL_DEPENDENCY_CONFIG
    3. PARAMETER FOR PROCEDURES ARE SAME AS THE DATA FROM EMPID

******************************************************************/

CREATE OR REPLACE PACKAGE PKG_SCRUB IS
  PROCEDURE SP_EXECCURSOR(p_vstr IN VARCHAR2, p_recordset OUT SYS_REFCURSOR);
  PROCEDURE SP_SETUP_PROCESSING(CLIENTID IN  NUMBER);
  FUNCTION  FN_PREPARE_WAITFOR(STR IN VARCHAR2, delimiter IN VARCHAR2,MODID IN NUMBER) RETURN VARCHAR2;

END PKG_SCRUB;
/

CREATE OR REPLACE PACKAGE  BODY PKG_SCRUB IS

  TYPE Cur IS REF CURSOR;

  PROCEDURE SP_EXECCURSOR (p_vstr IN VARCHAR2, p_recordset OUT SYS_REFCURSOR) AS
    BEGIN
      OPEN p_recordset FOR p_vstr;
  END SP_EXECCURSOR ;


  FUNCTION fn_prepare_waitfor(str in VARCHAR2,delimiter VARCHAR2,modid IN NUMBER)
    RETURN VARCHAR2
    AS
      type str_array is table of VARCHAR2(4000);
      val_list str_array;
      head varchar2(4000);
      tail varchar2(4000); i number :=1;
      do_loop boolean := true;
      retVal varchar2(1000);
      temp number(10);

    begin -- Initialize array
    val_list := str_array('');
    tail := str;
    while do_loop loop
      head := substr(tail,1,instr(tail,delimiter,1,1)-1);
        if instr(tail,delimiter,1,1) > 0 then
          if i = 1 then
              val_list.DELETE(1);
              val_list(i) := head;
            else
              val_list.EXTEND;
              val_list(i) := head;
          end if;
        else if i <> 1 then
          val_list.EXTEND; end if;
          val_list(i) := tail;
          do_loop := false;
        end if;
        i := i + 1;
        tail := substr(tail,instr(tail,delimiter,1,1)+1,length(tail));
    end loop;
        for i in 1..val_list.Count
        loop
            temp:= to_number(val_list(i))+modid;
            retVal := retVal || ','||temp;
        end loop;
        return substr(retVal,2);
    END FN_PREPARE_WAITFOR;



  PROCEDURE SP_SETUP_PROCESSING(clientid IN NUMBER) IS

      vUpperCounter number(10) := 0;
      vCounter number(10) := 0;
      vStartcnt number(10) := 0;
      vProcname varchar2(100);
      vWaitFor varchar2(100);
      vTemp number(10) := 0;

      vClientID number(10);
      vSourceTable varchar2(100);
      vFieldName varchar2(100);
      vCount Number(10);

      vStrSQL varchar2(4000);
      vEmpCuror Cur;

      vEmpId varchar2(500);


  BEGIN

      vClientID := NVL(clientID ,999);

      EXECUTE IMMEDIATE 'TRUNCATE TABLE TBL_SCRUB_MAIN';
     -- dbms_output.put_line(0);
      EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM TBL_CLIENTCONFIG A,TBL_DEPENDENCY_CONFIG B WHERE A.CLIENTID=B.CLIENTID' INTO vCount ;

     -- dbms_output.put_line(10);

      IF vCount = 0 THEN
          DBMS_OUTPUT.PUT_LINE('NO CONFIGURATION FOUND FOR THIS CLIENT !!! PLEASE CHECK THE CONFIG TABLES FIRST. ');
          RETURN;
      END IF;

     -- DBMS_OUTPUT.PUT_LINE(20);

      vStrSQL:=  'SELECT FIELDNAME, SOURCETABLE FROM TBL_CLIENTCONFIG WHERE 1=1 AND CLIENTID='||vClientID ;

     -- DBMS_OUTPUT.PUT_LINE(vStrSQL);

      EXECUTE IMMEDIATE vStrSQL INTO vFieldName,vSourceTable;

     -- DBMS_OUTPUT.PUT_LINE(30);

      vStrSQL := 'SELECT DISTINCT '||vFieldName||' FROM '|| vSourceTable||' WHERE FLAG=''T''';

      SP_EXECCURSOR(vStrSql,vEmpCuror);

     -- dbms_output.put_line(40);

      insert into TBL_SCRUB_MAIN (module_id,procedure_name,waitfor) select 0,'SP_INIT',0 from dual;

      LOOP
        FETCH vEmpCuror INTO vEmpId;
        EXIT WHEN vEmpCuror%NOTFOUND;

         EXECUTE IMMEDIATE ' SELECT COUNT(*) FROM TBL_SCRUB_MAIN WHERE module_id<>0' INTO vStartCnt ;

         dbms_output.put_line(30);
         vUpperCounter := vUpperCounter+1;

              FOR j IN
              (
                SELECT Procid,TRIM(Procname)Procname,TRIM(Waitfor)Waitfor FROM TBL_DEPENDENCY_CONFIG
              )
              LOOP

                   vCounter := vCounter+1;
                   vProcname := j.procname||'('''||vEmpId||''')';
                   vWaitFor  := fn_prepare_waitfor(j.waitfor,',',vstartcnt) ;

                   if substr(j.waitfor,1,2) ='0' then
                        vWaitFor :=0;
                   end if;

                   insert into TBL_SCRUB_MAIN (module_id,procedure_name,waitfor)
                   select vcounter,vprocname,vwaitfor from dual;
                    commit;
              END LOOP;
      END LOOP;
    CLOSE vEmpCuror;


    ------------------------------for odd Emp Group---------------------------

   INSERT INTO TBL_SCRUB_MAIN SELECT '5010','SP_FM',0 from DUAL;



   END SP_SETUP_PROCESSING;

END PKG_SCRUB;
/


 EXEC PKG_SCRUB.SP_SETUP_PROCESSING(826);
commit;
------------------------------------------------------------------------------------------------------------
----------------------------------------------- MAIN PROC ---------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------
--exec SP_PROCESS_SCRUB(4);

CREATE OR REPLACE PROCEDURE SP_PROCESS_SCRUB
(
  DOP NUMBER :=1
)
IS
  vJobs D2SCRUB.tArrayJob;
  SchemaName varchar2(20);
  vblCount NUMBER(10);
  vblClientID VARCHAR2(20);
  vblApplicationID VARCHAR2(20);
  vblClientName VARCHAR2(50);
  vblCountAppID NUMBER(10);

  vStartTime date;
  vEndtime date;
  vExectime date ;
  verrormsg VARCHAR2(2000);
  vblmodCnt NUMERIC;
  vblprocessedCnt NUMERIC;

BEGIN

	BEGIN
		utility.SP_CENTRAL_TIMELOG_UTLITY('START','Y','826',Upper(Sys_Context('UserEnv','SERVER_HOST')),user);
	EXCEPTION WHEN OTHERS THEN NULL;
	END;

  SELECT ClientID INTO vblClientID
   FROM VH_CLIENTS;
  SELECT Count(*) INTO vblCount FROM HAWKEYEMASTER.M_CLIENTS WHERE ClientID = vblClientID;
  IF vblCount = 0 THEN
      RAISE_APPLICATION_ERROR(-20101,'ClientID ' || vblClientID || ' not found in master database. Process Engine is terminated forcely!!!');
  END IF;


  SELECT COUNT(*) INTO vblCount FROM VH_PROCESSINFO;
  IF vblCount = 0 THEN
      RAISE_APPLICATION_ERROR(-20101,' No records found in VH_PROCESSINFO Process Engine is terminated forcely!!!');
  END IF;

  SELECT AppID, ClientName INTO vblApplicationID, vblClientName FROM VH_CLIENTS;
      SELECT  Count(*)
      INTO vblCountAppID
      FROM VH_CLIENTS WHERE  REGEXP_LIKE (AppID,'[0-9][0-9][0-9]-[0-9][0-9][0-9]');
  IF vblCountAppID = 0 THEN
    RAISE_APPLICATION_ERROR(-20101,'AppID ' || vblApplicationID || ' for ' || vblClientName ||' is not in valid format it must be "###-###" Format.
    Process Engine is terminated forcely!!!');
  END IF;

  select sys_context('USERENV', 'CURRENT_USER')
   INTO SchemaName
   from dual;

  select sysdate into vStartTime from dual;

  --SELECT * FROM TBL_SCRUB_STATUS

  --SELECT * FROM  USER_TABLES WHERE TABLE_NAME LIKE '%EXEC%'


  EXECUTE IMMEDIATE('TRUNCATE TABLE TBL_SCRUB_STATUS');
  EXECUTE IMMEDIATE ('TRUNCATE TABLE VH_QUERYLOG');
  EXECUTE IMMEDIATE ('TRUNCATE TABLE TBL_PROCESSINGPARAMS');
  EXECUTE IMMEDIATE ('TRUNCATE TABLE TBL_ERROR_LOG');
  EXECUTE IMMEDIATE ('TRUNCATE TABLE TBL_CHECKERROR');

  INSERT INTO TBL_PROCESSINGPARAMS
    (
     DOP
    )
    SELECT DOP FROM DUAL;
    COMMIT;

  dbms_alert.register(vblClientID);

  INSERT INTO TBL_SCRUB_STATUS(MODULE_ID, STATUS_ID, STARTTM) SELECT 0,1, SYSDATE FROM DUAL;
  commit;

  vJobs(1) := SchemaName||'.SP_INIT';

  D2SCRUB.Execute(vJobs);
  D2SCRUB.WaitForCompletion(vJobs,SchemaName);

  dbms_output.put_line('StartTime: '||to_char(vStartTime, 'MM/DD/YYYY HH24:MI:SS'));
  dbms_output.put_line('EndTime: '||to_char(Sysdate, 'MM/DD/YYYY HH24:MI:SS'));


BEGIN
        utility.SP_CENTRAL_TIMELOG_UTLITY('END','Y','826', Upper(Sys_Context('UserEnv','SERVER_HOST')), USER, Upper(Sys_Context('USERENV','TERMINAL')), 'DATA SCRUBING', 'SCRUB', NULL, 'USI Holdings', NULL,NULL,NULL);
EXCEPTION WHEN OTHERS THEN NULL;
END;


  dbms_alert.signal(vblClientID,'OK');
  dbms_alert.remove(vblClientID);

  EXCEPTION WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE(SQLERRM);
END;
/

--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE SCRUBSTATUSLOG PURGE';
    EXCEPTION WHEN OTHERS THEN NULL;
END;
/
--------------------------------------------------------------------------------
CREATE TABLE SCRUBSTATUSLOG (
  OrderNumber  VARCHAR2(50)  NULL,
  SET1      VARCHAR2(50)  NULL,
  EMPLOYER     VARCHAR2(50)  NULL,
  PAYER        VARCHAR2(50)  NULL,
  HITABLENAME  VARCHAR2(4000)  NULL,
  HIROWCOUNT   NUMBER(22,9)  NULL,
  HPROWCOUNT   NUMBER(22,9)  NULL,
  ERROR_NUMBER VARCHAR2(100) NULL,
  MESSAGE      VARCHAR2(4000) NULL,
  REMARK       VARCHAR2(4000) NULL
)NOLOGGING;


--------------------------------------------------------------------------------
BEGIN
    EXECUTE IMMEDIATE 'DROP SEQUENCE rowindex';
    EXCEPTION WHEN OTHERS THEN NULL;
END;
/
--------------------------------------------------------------------------------
CREATE SEQUENCE rowindex
  MINVALUE 1
  MAXVALUE 99999
  INCREMENT BY 1
  NOCYCLE
  ORDER
  NOCACHE
/

CREATE OR REPLACE TRIGGER RowIndix BEFORE INSERT ON SCRUBSTATUSLOG FOR EACH ROW
DECLARE ordernum INT;  BEGIN SELECT rowindex.nextval INTO ordernum FROM dual; :new.OrderNumber:=ordernum; END;
/


CREATE OR REPLACE PROCEDURE xp_scrubstatuslog
(
    vSET1       VARCHAR2,
    vEmpID      VARCHAR2,
    vPayer      VARCHAR2,
    vErrorCode  VARCHAR2,
    vErrorDesc  VARCHAR2,
    vHISchemaName   VARCHAR2,
    vHPRowCout  INTEGER,
    vTableName  VARCHAR2, -- ELIG/CLAIMS/RX/PROV (OR FULL TABLE NAME)
    vIsFullTblName  VARCHAR,  -- IF TABLE NAME IS FULL THEN 'Y' ELSE 'N'
    vFlag       VARCHAR   -- 'E' FOR EXCEPTION HANDELING; I FOR ROWCOUNT VERIFICATION
)
IS
    vQuery      LONG;
BEGIN
commit;
    IF Upper(vFlag) = 'E' THEN
        vQuery:='
        INSERT INTO SCRUBSTATUSLOG
        (
            SET1,
            EMPLOYER,
            PAYER,
            ERROR_NUMBER,
            MESSAGE,
            REMARK
        )
        VALUES
        (
            ''' || vSET1 || ''',
            ''' || vEmpID || ''',
            ''' || vPayer || ''',
            ''' || vErrorCode || ''',
            ''' || vErrorDesc || ''',
            ''' || vTableName || ''')';
    END IF;

    IF Upper(vFlag) = 'I' THEN


        vQuery:='
        INSERT INTO SCRUBSTATUSLOG
        (
            SET1,
            EMPLOYER,
            PAYER,
                HITABLENAME,
            HPROWCOUNT,
            HIROWCOUNT
        )
        SELECT
                ''' || vSET1 || ''',
                ''' || vEmpID || ''',
				''' || vPayer || ''',
                ''' || vTableName || ''',
                ' || vHPRowCout || ',
                COUNT(*)
        FROM ';

        IF upper(vIsFullTblName) = 'Y' THEN
                vQuery:= vQuery || vHISchemaName || '.' || vTableName;
        ELSE
            vQuery:= vQuery || vHISchemaName || '.HI_' || vTableName || '_' || vPayer || '_' || vEmpID;
        END IF;
    END IF;

    BEGIN EXECUTE IMMEDIATE vQuery; END;
commit;
END xp_scrubStatusLog;
/
--------------------------------------------------------------------------------
CREATE OR REPLACE PROCEDURE sp_VH_Grant
(
    FROM_USER VARCHAR2,
    TO_USER VARCHAR2
)

AS

vTableName VARCHAR(50);

CURSOR cur_Object IS
        (
            SELECT OBJECT_NAME  FROM ALL_OBJECTS
            WHERE Object_Type ='TABLE'
            AND   OWNER = FROM_USER
            AND (OBJECT_NAME LIKE 'HP%'  OR OBJECT_NAME LIKE 'HR%'OR OBJECT_NAME LIKE 'HI%' OR OBJECT_NAME LIKE 'ZTBL%' OR object_name = 'ZZZ_IMPORTLOG')
        );
BEGIN

    OPEN cur_Object;
    LOOP
         FETCH cur_Object  INTO vTableName;
         EXIT WHEN cur_Object%NOTFOUND;
         EXECUTE IMMEDIATE 'GRANT SELECT,UPDATE,INSERT,DELETE ON ' ||  FROM_USER || '.' ||  vTableName || ' TO ' || TO_USER;
         DBMS_OUTPUT.PUT_LINE (FROM_USER || '.' ||  vTableName);
    END LOOP;
    CLOSE cur_Object;

END;
/

--------------------------------------------------------------------------------
DECLARE
     SchemaName VARCHAR2(20);
BEGIN
    SELECT sys_context('USERENV', 'CURRENT_USER') INTO SchemaName FROM dual;

END;
/

--------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------
  ------------------------------------  PROC LISTS ----------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------
CREATE OR REPLACE PROCEDURE sp_ed
(
           EMPID IN VARCHAR2
) IS
        vQuery LONG;
        vQueryE LONG;
            vQueryS LONG;
        vExtractTable VARCHAR2(500);
        vTAbles VARCHAR2(200);
            vTablesS VARCHAR2(200);
        vLvl VARCHAR2(200);
        SchemaName VARCHAR2(20);

BEGIN

 SELECT sys_context('USERENV', 'CURRENT_USER')
      INTO SchemaName
       FROM dual;


       FOR vLvl IN (SELECT DISTINCT SERIALNO,EMPGRPID,PAYER,set1,set2 FROM HR_826_PKG_EMPPAYER WHERE EMPGRPID=''||EmpID||'')
        LOOP
           vQuery:='SELECT EMPGRPID,PAYER,set1 from HR_826_PKG_EMPPAYER WHERE  EMPGRPID='''||vLvl.EMPGRPID||''' AND PAYER='''||vlvl.PAYER||'''';

           BEGIN
                   EXECUTE IMMEDIATE vQuery; EXCEPTION WHEN OTHERS THEN DBMS_output.PUT_LINE ('1. ' ||SQLERRM);
         END;


             vTablesS:='VH_'||vLvl.set2||'_'||vLvl.SERIALNO;
              DBMS_OUTPUT.PUT_LINE(vTables);

            BEGIN
              EXECUTE IMMEDIATE 'DROP TABLE '||vTablesS;EXCEPTION WHEN OTHERS THEN NULL;
             END;


    vQueryS:='CREATE TABLE '||vTablesS||' AS'||
                       ' SELECT * FROM VH_'||vLvl.Set2||' WHERE rownum<1';
               DBMS_OUTPUT.PUT_LINE(vQueryS);
                  BEGIN
                       EXECUTE IMMEDIATE vQueryS; EXCEPTION WHEN OTHERS THEN DBMS_output.PUT_LINE ('1. ' ||SQLERRM);
          END;

     END LOOP;

    D2SCRUB.signalCompletion(SchemaName || '.SP_ED('''||EMPID||''')');

END SP_ED;
/
------------------------ICE-17438 START(SSN MASK)---------------------------------------------
CREATE OR REPLACE FUNCTION SSNMASK(SSN_ORG VARCHAR2) RETURN VARCHAR
--RESULT_CACHE
IS

 TYPE bin_array IS TABLE OF VARCHAR2(50)
 INDEX BY BINARY_INTEGER;

  RET_SSN VARCHAR2(50);
  SSN VARCHAR2(50);
  char_array bin_array;
  char_array1 bin_array;

  BEGIN
	char_array('0') := '14';
	char_array('1') := '19';
	char_array('2') := '23';
	char_array('3') := '44';
	char_array('4') := '64';
	char_array('5') := '78';
	char_array('6') := '80';
	char_array('7') := '85';
	char_array('8') := '89';
	char_array('9') := '12';
	char_array1('0') := '9';
	char_array1('1') := '7';
	char_array1('2') := '8';
	char_array1('3') := '5';
	char_array1('4') := '6';
	char_array1('5') := '2';
	char_array1('6') := '3';
	char_array1('7') := '1';
	char_array1('8') := '0';
	char_array1('9') := '4';


      SSN:=REPLACE (SSN_ORG,'-','');
      RET_SSN:=CASE WHEN ISNUMERIC(SubStr(SSN,1,1))=1 THEN char_array(SubStr(SSN,1,1)) ELSE SubStr(SSN,1,1) END;
      --||char_array1(SubStr(SSN,2,1));

	FOR i IN 2 .. 32 LOOP
		RET_SSN:=RET_SSN||CASE WHEN ISNUMERIC(SubStr(SSN,i,1))=1 THEN char_array1(SubStr(SSN,i,1)) ELSE SubStr(SSN,i,1) END;
	END LOOP;

	RET_SSN:=RET_SSN||SubStr(SSN,33);

      RETURN(RET_SSN);
END SSNMASK;
/
------------------------ICE-17438 END---------------------------------------------
CREATE OR REPLACE PROCEDURE SP_SE
        (
            EMPID IN VARCHAR2
        ) IS

		vbQuery LONG;
		vQuery LONG;
		tablename VARCHAR2(50);
		vblStaticDate DATE;
		vbDate LONG;
		vLvl VARCHAR2(200);
		EMP_PAYEER VARCHAR2(20);
		vbltemp VARCHAR2(200);
		vblEffDate DATE;
		vblTermDate DATE;
		SchemaName VARCHAR2(20);

    BEGIN
        SELECT sys_context('USERENV', 'CURRENT_USER')
                      INTO SchemaName
                FROM dual;

----------------------------------------Creating temp table -----------------------

FOR vLvl IN (SELECT DISTINCT SERIALNO,PAYER,EMPGRPID,replace(EMPGRPNAME,'''','''''')EMPGRPNAME FROM HR_826_PKG_EMPPAYER WHERE  EMPGRPID=''||EmpID||'' AND SET1='ELIG' ORDER BY PAYER DESC)


            LOOP

       DBMS_OUTPUT.PUT_LINE(EmpID);

---------------------------------------------- ANTHEM implementation starts ---------------------
IF  vLvl.PAYER='ANTHEM' THEN

	vbQuery:=
	'
	INSERT  INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
	(
		Source,
		SrcFileName,
		MemID,
		EnrID,
		RelFlag,
		MemFirstName,
		MemLastName,
		Gender,
		DOB,
		Addr1,
		Addr2,
		City,
		State,
		Zip,
		HomePhone,
		WorkPhone,
		EffDate,
		TermDate,
		LVLID1,
		LVLDesc1,
		LVLID2,
		LVLDesc2,
		LVLID3,
		LVLDesc3,
		LVLID4,
		LVLDesc4,
		LVLID5,
		LVLDesc5,
		LVLID6,
		LVLDesc6,
		CMStatus,
		UDF1,
		UDF2,
		UDFC5,
		UDF1_Mem,
		UDF2_Mem,
		RcvMth,
		VHPAYORID,
		covtypeid,
		covtypedesc,
		BENCOVTYPE,
		BENCOVTYPEDESC,
		COVERAGESTATUS ,
		PLANTYPE ,
		PLANNAME,
		SrcRelFlag,
		PRODUCTID,
		UDFC21 --ICE-17438
	)
	SELECT
		''ANTHEM'' AS Source,
		a.SourceFileName AS SrcFileName,
		COALESCE(REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~''),''MEMBERID'') AS MemID,
		COALESCE(REPLACE(a.SBSCRBR_ID,''~''),''EMPLOYEEID'') AS ENRID ,
		CASE WHEN MBR_REL_CD IN(''18'',''20'') THEN ''E'' WHEN MBR_REL_CD IN (''01'',''25'',''53'') THEN ''S'' ELSE ''D'' END AS RelFlag,
		UPPER(a.MBR_FIRST_NM) AS MemFirstName,
		UPPER(a.MBR_LAST_NM) AS MemLastName,
		CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END AS  Gender,
		a.MBR_BRTH_DT  AS DOB,
		NULL  AS Addr1,
		NULL AS Addr2,
		NULL AS City,
		NULL AS State,
		SUBSTR(a.EMP_ZIP_CD,1,5) AS Zip,
		NULL AS HomePhone,
		NULL AS WorkPhone,'
		;
		--256494
		IF EMPID='WSTU' THEN
		vbQuery:= vbQuery||'CASE WHEN TO_CHAR(a.MBR_EFCTV_DT,''YYYY-MM'')<''2015-07'' THEN TO_DATE(''2015-07-01'',''YYYY-MM-DD'') ELSE a.MBR_EFCTV_DT END AS EffDate,'
		;
		ELSE
		vbQuery:= vbQuery||'a.MBR_EFCTV_DT AS EffDate,'
		;
		END IF;
		vbQuery:= vbQuery||'
		--a.MBR_TERM_DT AS TermDate,
		--CASE WHEN A.MBR_TERM_DT > TO_DATE(REGEXP_SUBSTR(A.SOURCEFILENAME, ''(\d+){8}'', 1,2) , ''YYYYMMDD'') THEN
		--TO_DATE(REGEXP_SUBSTR(A.SOURCEFILENAME, ''(\d+){8}'', 1,2) , ''YYYYMMDD'') ELSE A.MBR_TERM_DT END AS TERMDATE,   ----ICE 229690
		CASE WHEN a.mbr_term_dt > To_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') THEN
		to_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') ELSE a.mbr_term_dt END  AS termdate, ----ICE 229690
		''C'' AS LVL1ID,
		''Commercial'' AS LVL1Desc,
		COALESCE(t.ROLLUP_ID, pl.ROLLUPID) AS LVL2ID,		--188358
		COALESCE(t.ROLLUP_DESC, pl.PLAN_NAME) AS LVL2Desc,	--188358
		nvl(grp.ROLLUPID,a.ACCT_NBR) AS LVL3ID,
		nvl(grp.Group_Name,a.ACCT_NBR) AS LVL3Desc,
		Sgrp.ROLLUPID AS LVL4ID,
		Sgrp.sub_grp_nm AS LVL4Desc,
		NULL AS LVL5ID,
		NULL AS LVL5Desc,
		NULL AS LVL6ID,
		NULL AS LVL6Desc,
		NULL AS CMStatus,
		a.UDF1 AS UDF1,
		NULL AS UDF2,
		CASE WHEN ISDATE(SubStr(SubStr(a.sourceFileName,-21),1,8),''YYYYMMDD'')=1 THEN SubStr(SubStr(a.sourceFileName,-21),1,8) END UDFC5,
		NULL AS UDF1_Mem,
		NULL AS UDF2_Mem,
		a.RECEIVEDMONTH AS RcvMth,
		(SELECT p.PAYORID FROM HR_GLOBAL_PAYORLIST p WHERE TABLENAME=''HI_ELIG_ANTHEM'') AS VHPAYORID,
		NVL(pl.COVTYPEID,''MED'') covtypeid,
		NVL(pl.covtypedesc,''MEDICAL'') covtypedesc,
		CASE WHEN UPPER(A.EMP_CNTRCT_TYPE)=''SBSCR'' THEN ''S'' ELSE ''F'' END BENCOVTYPE,
		(SELECT cv.ROLLUP_DESC FROM HR_826_COVERAGE cv WHERE ''ANTHEMOH'' = cv.source AND UPPER(A.EMP_CNTRCT_TYPE)=cv.SRC_CODE) BENCOVTYPEDESC,
		Sgrp.cov_status COVERAGESTATUS ,
		COALESCE(t.PLANTYPE, pl.PLAN_TYPE) PLANTYPE ,		--188358
		COALESCE(t.ROLLUP_DESC, pl.PLAN_NAME) PLANNAME,		--188358
		(SELECT R.rollup_desc FROM HR_826_REL R WHERE R.source=''ANTHEMOH'' AND R.src_code=a.MBR_REL_CD ) SrcRelFlag,
		''1'' AS PRODUCTID, --in hr_global_productLine 1 prodID is mapped as commercial
		a.SBSCRBR_ID AS UDFC21 --ICE-17438
	FROM
		HI0826001.HI_ELIG_ANTHEM_'||EMPID||' a
	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.ACCT_NBR = grp.src_code
	LEFT JOIN
		HR_826_ANTHEM_SUBGRP Sgrp
	ON
		a.ACCT_NBR = Sgrp.ACCT_NBR
	AND
		SUBSTR(A.SUBGRP_NBR,-4) = Sgrp.src_code
	LEFT JOIN
		HR_826_ANTHEM_PLAN pl
	ON
		a.ACCT_NBR = pl.ACCT_NBR
	AND
		UPPER(a.PKG_NBR) = pl.src_code
	LEFT JOIN											--188358
		HR_826_LOA_LVL_ROLLUP t
	ON
		a.ACCT_NBR  = t.groupid
	AND
		UPPER(a.PKG_NBR) = Upper(t.PLANCODE)
	AND
		To_Char(a.MBR_EFCTV_DT,''YYYY'') = To_Char(t.effectivedate, ''YYYY'')
	WHERE NVL(pl.DROP_PLAN,''N'')=''N''
	';


	BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('ELIG',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ELIG',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
	-------------------------------------------------------------------------------------------------
	--TERM DATE UPDATE LOGIC TO RESOLVE OPEN TERM DATE ISSUE
	-------------------------------------------------------------------------------------------------
	vbQuery:='
		UPDATE VH_ELIGIBILITIES_'||vLvl.SERIALNO||' a
		SET TERMDATE=TO_DATE(UDFC5,''YYYYMMDD'')
		WHERE (TERMDATE IS NULL) OR (UDFC5 IS NOT NULL AND TERMDATE > TO_DATE(UDFC5,''YYYYMMDD''))
	';
	-------------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ANTHEM TERMDATE UPDATE',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	 END;
	 COMMIT;
END IF;
------------------------------------- ANTHEM OH/RDX implementation starts --------------------
IF  vLvl.PAYER='ANTHEMRDX' OR vLvl.PAYER='ANTHEM_OH' THEN

---------------------------------ICE 311296------------------------------------------------------------

IF EMPID IN ('WSPI') THEN

BEGIN EXECUTE IMMEDIATE 'DROP TABLE ZZZ_UMR_MEMUPD_'||vLvl.SERIALNO||' PURGE';
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
---------------------------------------------------------------------------------------------
	vbQuery:=
	'CREATE TABLE ZZZ_UMR_MEMUPD_'||vLvl.SERIALNO||' NOLOGGING AS
	SELECT
		MEMID,
		ENRID,
		MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		LVLID3
	FROM (
		SELECT
			a.EMPE_SSN_NBR||DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')|| TO_CHAR(a.INDIV_BIRTH_DATE,''YYYYMMDD'') AS MEMID,
			a.EMPE_SSN_NBR	AS	ENRID,
			UPPER(a.INDIV_1ST_NAME_TEXT) AS MEMFIRSTNAME,
			UPPER(a.INDIV_LAST_NAME_TEXT) AS MEMLASTNAME,
			DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'') AS GENDER,
			a.INDIV_BIRTH_DATE AS DOB,
			grp.ROLLUPID AS LVLID3,
			row_number() over (partition by UPPER(a.INDIV_1ST_NAME_TEXT),
			UPPER(a.INDIV_LAST_NAME_TEXT),DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U''),a.INDIV_BIRTH_DATE,grp.ROLLUPID
			order by a.INDIV_INS_EFF_DATE desc,A.RECEIVEDMONTH DESC) rn
		FROM
			HI0826001.HI_ELIG_UMR_BEF_'||EMPID||' a
		LEFT JOIN
			HR_826_GROUP grp
		ON
			a.GROUP_ID_NUMBER = grp.SRC_CODE
		WHERE
			Nvl(grp.ROLLUPID,a.GROUP_ID_NUMBER)='''||EMPID||'''
		)
	WHERE RN=1
	';
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	COMMIT;
END IF;

---------------------------------ICE 311296------------------------------------------------------------
---------------------------------ICE#330246   ICE337498  ICE5216-----------------------------------------------------------

IF EMPID IN ('PRIM','OHIO','XAVI','GROT') THEN

BEGIN EXECUTE IMMEDIATE 'DROP TABLE ZZZ_HUM_MEMUPD_'||vLvl.SERIALNO||' PURGE';
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
---------------------------------------------------------------------------------------------
	vbQuery:=
	'CREATE TABLE ZZZ_HUM_MEMUPD_'||vLvl.SERIALNO||' NOLOGGING AS
	SELECT
		MEMID,
		ENRID,
		MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		LVLID3
	FROM (
		SELECT
			a.SUBSCRIBER_SSN||a.PERS_SEX_CD|| TO_CHAR(a.PERS_BIRTH_DATE,''YYYYMMDD'') AS MEMID,
			a.SUBSCRIBER_SSN AS	ENRID,
			UPPER(a.PERS_FIRST_NAME) AS MEMFIRSTNAME,
			UPPER(a.PERS_LAST_NAME) AS MEMLASTNAME,
			a.PERS_SEX_CD AS GENDER,
			a.PERS_BIRTH_DATE AS DOB,
			Nvl(grp.ROLLUPID,a.grp_id) AS LVLID3,
			row_number() over (partition by UPPER(a.PERS_FIRST_NAME),
			UPPER(a.PERS_LAST_NAME),a.PERS_SEX_CD,a.PERS_BIRTH_DATE,Nvl(grp.ROLLUPID,a.grp_id)
			order by a.MBR_COV_EFF_DATE desc,A.RECEIVEDMONTH DESC) rn
		FROM
			HI0826001.HI_ELIG_HUMANA_'||EMPID||' a
		LEFT JOIN
			HR_826_GROUP grp
		ON
			a.grp_id = grp.SRC_CODE
		LEFT JOIN
			HR_826_HUMANA_LOA lvl
		ON
			a.grp_id = lvl.SRC_CD1
		AND
			SUBSTR(a.CUST_COV_KEY,-8) = lvl.SRC_CD2
		WHERE
			Nvl(grp.ROLLUPID,a.grp_id)='''||EMPID||'''
		AND
			NVL(lvl.clmtype,''MED'')=''MED''
		)
	WHERE RN=1
	';
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	COMMIT;
END IF;

---------------------------------ICE#330246------------------------------------------------------------
---------------------------------ICE 350132--start----------------------------------------------------------
IF EMPID IN ('OLSD') THEN

-- BEGIN EXECUTE IMMEDIATE 'DROP TABLE ZZZ_ELIG_ANTHEM_SWOO PURGE';   ----- COMMENTED OUT THROUGH ice 371234
	-- EXCEPTION WHEN OTHERS THEN NULL;
	-- END;
-- ---------------------------------------------------------------------------------------------
	-- vbQuery:=
	-- 'CREATE TABLE ZZZ_ELIG_ANTHEM_SWOO NOLOGGING AS
	-- SELECT
		-- MEMID,
		-- ENRID,
		-- MEMFIRSTNAME,
		-- MEMLASTNAME,
		-- GENDER,
		-- DOB,
		-- LVL3ID,
		-- LVL3Desc
	-- FROM (
		-- SELECT
		-- COALESCE(REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~''),''MEMBERID'') AS MemID,
		-- COALESCE(REPLACE(a.SBSCRBR_ID,''~''),''EMPLOYEEID'') AS ENRID ,
		-- UPPER(a.MBR_FIRST_NM) AS MemFirstName,
		-- UPPER(a.MBR_LAST_NM) AS MemLastName,
		-- CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END AS  Gender,
		-- a.MBR_BRTH_DT  AS DOB,
		-- grp.ROLLUPID AS LVL3ID,
		-- grp.Group_Name AS LVL3Desc,
		-- row_number() over (partition by UPPER(a.MBR_FIRST_NM),
		-- UPPER(a.MBR_LAST_NM),CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END,a.MBR_BRTH_DT,grp.ROLLUPID
		-- order by a.MBR_EFCTV_DT desc,A.RECEIVEDMONTH DESC) rn
	-- FROM
		-- HI0826001.HI_ELIG_ANTHEM_SWOO A
	-- LEFT JOIN
		-- HR_826_GROUP grp
	-- ON
		-- a.ACCT_NBR = grp.src_code
		-- )
	-- WHERE RN=1
	-- ';
	-- BEGIN EXECUTE IMMEDIATE vbquery;
	-- EXCEPTION WHEN OTHERS THEN NULL;
	-- END;
	-- COMMIT;

BEGIN EXECUTE IMMEDIATE 'DROP TABLE ZZZ_ELIG_OLSD_SSN PURGE';
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
---------------------------------------------------------------------------------------------
	vbQuery:=
	'CREATE TABLE ZZZ_ELIG_OLSD_SSN NOLOGGING AS
	SELECT
		MBR_SSN,
		SBSCRBR_ID
	FROM (
		SELECT
			a.MBR_SSN,
			a.SBSCRBR_ID,
			Row_Number() OVER (PARTITION BY SBSCRBR_ID ORDER BY a.MBR_EFCTV_DT desc,a.MBR_SSN) RN
		FROM
			HI0826001.HI_ELIG_ANTHEM_OLSD A
		WHERE
			a.MBR_REL_CD IN (''18'',''20'')
			)
	WHERE RN=1
	';
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	COMMIT;
END IF;

---------------------------------ICE 350132---end---------------------------------------------------------
	vbQuery:=

	'
	INSERT  INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
	(
		Source,
		SrcFileName,
		MemID,
		EnrID,
		RelFlag,
		MemFirstName,
		MemLastName,
		Gender,
		DOB,
		Addr1,
		Addr2,
		City,
		State,
		Zip,
		HomePhone,
		WorkPhone,
		EffDate,
		TermDate,
		LVLID1,
		LVLDesc1,
		LVLID2,
		LVLDesc2,
		LVLID3,
		LVLDesc3,
		LVLID4,
		LVLDesc4,
		LVLID5,
		LVLDesc5,
		LVLID6,
		LVLDesc6,
		CMStatus,
		UDF1,
		UDF2,
		UDFC5,
		UDF1_Mem,
		UDF2_Mem,
		RcvMth,
		VHPAYORID,
		covtypeid,
		covtypedesc,
		BENCOVTYPE,
		BENCOVTYPEDESC,
		COVERAGESTATUS ,
		PLANTYPE ,
		PLANNAME,
		SrcRelFlag,
		PRODUCTID,
		UDFC20,
		UDFC21 --ICE-17438
	)
	SELECT
		''ANTHEM_OH'' AS Source,
		a.SourceFileName AS SrcFileName,
';
	IF EMPID IN ('WSPI') THEN
	vbQuery := vbQuery||'NVL(MEM1.MEMID,a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD''))  AS MemID,
	';
	ELSIF EMPID IN ('PRIM','OHIO','GROT') THEN
	vbQuery := vbQuery||'NVL(HUM.MEMID,a.SBSCRBR_ID||Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'')||''-''||nvl(grp.ROLLUPID,a.ACCT_NBR)) AS MemID,	--330246 ----ice337498, 12926
	';
	ELSIF EMPID IN ('XAVI') THEN
	vbQuery := vbQuery||
	'COALESCE(HUM.MEMID,REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~'')||''-''||nvl(grp.ROLLUPID,a.ACCT_NBR),''MEMBERID'') AS MemID,	--5216
	';
	ELSIF EMPID IN ('OLSD') THEN
	vbQuery := vbQuery||'NVL(sw.MEMID,ssn.mbr_ssn||Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'')) AS MemID,	--350132
	';
	ELSIF EMPID IN ('CECO') THEN
	vbQuery := vbQuery||'NVL(TWINS.NEW_MEMID,a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'')) AS MemID,	--4870
	';
	ELSE
	vbQuery := vbQuery ||
	'CASE
    WHEN grp.MEMID_GRP_FLAG = ''Y'' THEN COALESCE(REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~''),''MEMBERID'')||''-''||nvl(grp.ROLLUPID,a.ACCT_NBR)   --ICE283272
    WHEN grp.ROLLUPID = ''OHMH'' THEN a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2)||''-''||''OHMH''   ----ICE 278043
    WHEN a.ACCT_NBR IN (''00123728'', ''00172918'', ''00172421'', ''00169440'', ''00070454'',''00171314'',''00249106'',''00246533'',''00173134'') --379532
    THEN COALESCE(REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~''),''MEMBERID'')
    WHEN a.ACCT_NBR in (''834~004007010'',''00249078'') THEN COALESCE (MEM.MEMID, a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD''),''MEMBERID'')	--271895
    ELSE a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'') END AS MemID,   --ice 254417     ICE263460
';
	END IF;
	IF EMPID IN ('WSPI') THEN
		vbQuery := vbQuery||'NVL(MEM1.ENRID,a.SBSCRBR_ID)  AS ENRID,
	';
	ELSIF EMPID IN ('PRIM') THEN
	vbQuery := vbQuery||'NVL(HUM.ENRID,''EMPLOYEEID-''||nvl(grp.ROLLUPID,a.ACCT_NBR)) AS ENRID,		--330246 ----ice337498
	';
	ELSIF EMPID IN ('OHIO','XAVI','GROT') THEN
	vbQuery := vbQuery||'NVL(HUM.ENRID,a.SBSCRBR_ID||''-''||nvl(grp.ROLLUPID,a.ACCT_NBR)) AS ENRID,		--330246 ----ice337498,5216, 12926
	';
	ELSIF EMPID IN ('OLSD') THEN
	vbQuery := vbQuery||'NVL(sw.ENRID,ssn.mbr_ssn) AS ENRID,	--350132
	';
	ELSE
	vbQuery := vbQuery ||
	'CASE
    WHEN grp.MEMID_GRP_FLAG = ''Y'' THEN a.SBSCRBR_ID||''-''||nvl(grp.ROLLUPID,a.ACCT_NBR)  --ICE283272
    WHEN grp.ROLLUPID = ''OHMH'' THEN a.SBSCRBR_ID||''-''||''OHMH''  ----ICE 278043
    WHEN grp.ROLLUPID in (''GTCO'',  ''ARTW'') THEN ''EMPLOYEEID''    --ICE259700 ,266811
    WHEN a.ACCT_NBR in (''834~004007010'',''00249078'') THEN COALESCE (MEM.ENRID,a.SBSCRBR_ID)	--271895
    WHEN a.ACCT_NBR IN (''00123728'', ''00172918'', ''00172421'', ''00169440'', ''00070454'',''00171314'',''00249106'',''00246533'') THEN COALESCE(REPLACE(a.SBSCRBR_ID,''~''),''EMPLOYEEID'')	--275996
    ELSE a.SBSCRBR_ID END AS ENRID,    --ice 254417  263460
';
	END IF;
	vbQuery := vbQuery ||
	'CASE WHEN a.MBR_REL_CD IN (''18'',''20'') THEN ''E''
         WHEN a.MBR_REL_CD IN (''01'',''25'',''53'') THEN ''S''
         WHEN a.MBR_REL_CD IN (''02'',''03'',''04'',''05'',''06'',''07'',''08'',''09'',''10'',''11'',''12'',''13'',''14'',''15'',''16'',''17'',''19'',
                               ''22'',''23'',''24'',''26'',''31'',''32'',''33'',''36'',''38'',''39'',''40'',''41'',''43'',''60'',''D2'') THEN ''D''
                               ELSE ''U'' END AS RELFLAG,
		CASE
    WHEN grp.ROLLUPID in (''GTCO'',  ''ARTW'',''PRIM'') THEN SubStr(UPPER(a.MBR_FIRST_NM),1,30) ELSE UPPER(a.MBR_FIRST_NM) END AS MemFirstName, --ICE259700,266811
		CASE
    WHEN grp.ROLLUPID in (''GTCO'',  ''ARTW'',''PRIM'') THEN SubStr(UPPER(a.MBR_LAST_NM),1,50) ELSE UPPER(a.MBR_LAST_NM) END AS MemLastName,  --ICE259700,266811
		CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END AS  Gender,
		a.MBR_BRTH_DT  AS DOB,
		SubStr(a.MBR_ADDR_LINE1,1,50) AS Addr1,     --ICE259700,266811
		SubStr(a.MBR_ADDR_LINE2,1,50) AS Addr2,     --ICE259700,266811
		a.MBR_CITY AS CITY,
		a.ST_PRVNC_CD AS STATE,
		a.MBR_ZIP_CD AS ZIP,
		NULL AS HomePhone,
		NULL AS WorkPhone,
		a.MBR_EFCTV_DT AS EffDate,';
		----ICE 287515
		IF EMPID IN ('OHMH','CIST') THEN
		vbQuery := vbQuery||'  CASE WHEN
		---ICE 289380
      CASE WHEN Nvl(mbr_term_dt, To_Date(''99991231'', ''YYYYMMDD'')) > To_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'')
          THEN to_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') ELSE A.MBR_TERM_DT END >= To_Date(''20161231'', ''YYYYMMDD'')
      THEN  To_Date(''20161231'', ''YYYYMMDD'')
          ELSE
         CASE WHEN Nvl(mbr_term_dt, To_Date(''99991231'', ''YYYYMMDD'')) > To_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'')
          THEN to_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') ELSE A.MBR_TERM_DT END
            END
          AS TERMDATE, ';
ELSIF EMPID IN ('CSTA') THEN
vbQuery := vbQuery || 'CASE WHEN TO_CHAR(CASE WHEN A.MBR_TERM_DT > TO_DATE(SUBSTR(A.SOURCEFILENAME,INSTR(A.SOURCEFILENAME,''_'',-1,2)+1,8), ''YYYYMMDD'') THEN
		TO_DATE(SUBSTR(A.SOURCEFILENAME,INSTR(A.SOURCEFILENAME,''_'',-1,2)+1,8), ''YYYYMMDD'') ELSE A.MBR_TERM_DT END) > ''20151231'' THEN TO_DATE(''20151231'',''YYYYMMDD'')
    ELSE
    CASE WHEN A.MBR_TERM_DT > TO_DATE(SUBSTR(A.SOURCEFILENAME,INSTR(A.SOURCEFILENAME,''_'',-1,2)+1,8), ''YYYYMMDD'') THEN
		TO_DATE(SUBSTR(A.SOURCEFILENAME,INSTR(A.SOURCEFILENAME,''_'',-1,2)+1,8), ''YYYYMMDD'') ELSE A.MBR_TERM_DT END END
     AS TERMDATE,    ----ICE 295787
 ';
ELSIF EMPID IN ('SHAW') THEN
vbQuery := vbQuery || 'CASE WHEN UPPER(SOURCEFILENAME)=''456234_VERSCEND_SHAWNEESTATE_MBSHP_20201101_20201130_20201211.TXT'' THEN 
		CASE WHEN a.mbr_term_dt > ADD_MONTHS(To_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD''),1) THEN
		ADD_MONTHS(To_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD''),1) ELSE a.mbr_term_dt END   
    ELSE
    CASE WHEN a.mbr_term_dt > To_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') THEN
		to_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') ELSE a.mbr_term_dt END
   END   AS TERMDATE,    ----ICE 19514
	 ';

ELSE
vbQuery := vbQuery || 'CASE WHEN a.mbr_term_dt > To_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') THEN
		to_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') ELSE a.mbr_term_dt END  AS termdate,
     ----ICE 229690   ---337498
     ';
END IF;
vbQuery := vbQuery || '
		--a.MBR_TERM_DT AS TermDate,
		--CASE WHEN A.MBR_TERM_DT > TO_DATE(REGEXP_SUBSTR(A.SOURCEFILENAME, ''(\d+){8}'', 1,2) , ''YYYYMMDD'') THEN
		--TO_DATE(REGEXP_SUBSTR(A.SOURCEFILENAME, ''(\d+){8}'', 1,2) , ''YYYYMMDD'') ELSE A.MBR_TERM_DT END AS TERMDATE,   ----ICE 229690
		''C'' AS LVL1ID,
		''Commercial'' AS LVL1Desc,
		CASE WHEN a.acct_nbr=''00217976'' AND UPPER(a.PKG_NBR)= ''HEALTH 3'' AND To_Number(To_Char(a.MBR_EFCTV_DT,''YYYY''))<=2013 THEN  ''00217976Health32013''
		WHEN a.acct_nbr=''00172431'' AND UPPER(a.PKG_NBR)= ''HEALTH 7'' AND To_Char(a.MBR_EFCTV_DT,''YYYY'')=''2014'' THEN  ''00172431HEALTH72014''   ---ice 266811
		ELSE COALESCE(Sgrp.PLAN_ID,t.ROLLUP_ID ,pl.ROLLUPID) END AS LVL2ID, --ICE 221/222--ICE#12926
		 CASE WHEN a.acct_nbr=''00217976'' AND UPPER(a.PKG_NBR)= ''HEALTH 3'' AND To_Number(To_Char(a.MBR_EFCTV_DT,''YYYY''))<=2013 THEN  ''PPO $750 Deb Opt''
		 WHEN a.acct_nbr=''00172431'' AND UPPER(a.PKG_NBR)= ''HEALTH 7'' AND To_Char(a.MBR_EFCTV_DT,''YYYY'')=''2014'' THEN  ''$2500 Embedded LHSA''   ---ice 266811
			ELSE COALESCE(Sgrp.PLAN_DESC,t.ROLLUP_DESC, pl.PLAN_NAME) END AS LVL2Desc, --ICE 221/222--ICE#12926
		nvl(grp.ROLLUPID,a.ACCT_NBR) AS LVL3ID,
		nvl(grp.Group_Name,a.ACCT_NBR) AS LVL3Desc,
		REPLACE(Nvl(Sgrp.ROLLUPID,a.ACCT_NBR||SUBSTR(A.SUBGRP_NBR,-4)),''~'') AS LVL4ID,
		CASE WHEN Sgrp.ROLLUPID IS NULL THEN a.ACCT_NBR||SUBSTR(A.SUBGRP_NBR,-4) ELSE Sgrp.sub_grp_nm END AS LVL4Desc,
		NULL AS LVL5ID,
		NULL AS LVL5Desc,
		NULL AS LVL6ID,
		NULL AS LVL6Desc,
		NULL AS CMStatus,
		a.UDF1 AS UDF1,
		CASE WHEN grp.ROLLUPID = ''KBCN'' THEN A.PKG_NBR --ICE#269211
		ELSE NULL END AS UDF2,
		CASE WHEN ISDATE(SubStr(SubStr(a.sourceFileName,-21),1,8),''YYYYMMDD'')=1 THEN SubStr(SubStr(a.sourceFileName,-21),1,8) END UDFC5,
		NULL AS UDF1_Mem,
		NULL AS UDF2_Mem,
		a.RECEIVEDMONTH AS RcvMth,
		(SELECT p.PAYORID FROM HR_GLOBAL_PAYORLIST p WHERE TABLENAME=''HI_ELIG_ANTHEM_'||EMPID||''') AS VHPAYORID,
		NVL(pl.COVTYPEID,''MED'')  as COVTYPEID,
		NVL(pl.covtypedesc,''MEDICAL'')  as COVTYPEDESC,
		CASE WHEN UPPER(A.EMP_CNTRCT_TYPE)=''SBSCR'' THEN ''S'' ELSE ''F'' END BENCOVTYPE,
		(SELECT cv.ROLLUP_DESC FROM HR_826_COVERAGE cv WHERE ''ANTHEMOH'' = cv.source AND UPPER(A.EMP_CNTRCT_TYPE)=cv.SRC_CODE) BENCOVTYPEDESC,
		Sgrp.cov_status COVERAGESTATUS ,
		CASE WHEN grp.ROLLUPID=''KBCN'' THEN ''HDHP'' --ICE#269211
		ELSE COALESCE(t.PLANTYPE, pl.PLAN_TYPE) END AS PLANTYPE ,
		CASE WHEN a.acct_nbr=''00217976'' AND UPPER(a.PKG_NBR)= ''HEALTH 3'' AND To_Number(To_Char(a.MBR_EFCTV_DT,''YYYY''))<=2013 THEN  ''PPO $750 Deb Opt''
			ELSE COALESCE(t.ROLLUP_DESC, pl.PLAN_NAME) END AS PLANNAME,
		(SELECT R.rollup_desc FROM HR_826_REL R WHERE R.source=''ANTHEMOH'' AND R.src_code=a.MBR_REL_CD ) SrcRelFlag,
		''1'' AS PRODUCTID, --in hr_global_productLine 1 prodID is mapped as commercial
		a.ACCT_NBR AS UDFC20,
		a.SBSCRBR_ID AS UDFC21 --ICE-17438
	FROM
		HI0826001.HI_ELIG_ANTHEM_'||EMPID||' a
	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.ACCT_NBR = grp.src_code
	LEFT JOIN
		HR_826_ANTHEM_SUBGRP Sgrp
	ON
		a.ACCT_NBR = Sgrp.ACCT_NBR
	AND
		SUBSTR(A.SUBGRP_NBR,-4) = Sgrp.src_code
	LEFT JOIN
		HR_826_ANTHEM_PLAN pl
	ON
		 a.ACCT_NBR   =  pl.ACCT_NBR
		 AND
		 Case
		 When pl.FLAG= ''Y'' AND A.mbr_efctv_dt > TO_DATE(''2018.12.31'',''YYYY.MM.DD'') THEN UPPER(SUBSTR(a.subgrp_nbr,-4))
		 WHEN grp.ROLLUPID= ''XAVI''  AND pl.FLAG IS NULL  and A.mbr_efctv_dt < TO_DATE(''2018.12.31'',''YYYY.MM.DD'')  THEN  upper(a.PROD_ID)
		 WHEN grp.ROLLUPID IN (''TRAN'', ''GROT'', ''RLCS'')  THEN substr(a.SUBGRP_NBR , -4)    --ICE-18938
		 ELSE UPPER(a.PKG_NBR) END = UPPER(pl.src_code)  --5216
			  --6088 --ICE7917 --ICE-10717
	LEFT JOIN
		HR_826_LOA_LVL_ROLLUP t
	ON
		a.ACCT_NBR  = t.groupid
	AND
		UPPER(a.PKG_NBR) = Upper(t.PLANCODE)
	AND
		To_Char(a.MBR_EFCTV_DT,''YYYY'') = To_Char(t.effectivedate, ''YYYY'')
	LEFT JOIN
		zzz_memid_update_anthem MEM
	ON
		UPPER(a.MBR_FIRST_NM) = MEM.MEMFIRSTNAME
	AND
		UPPER(a.MBR_LAST_NM) = MEM.MEMLASTNAME
	AND
		CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END = MEM.GENDER
	AND
		a.MBR_BRTH_DT = MEM.DOB
	AND 	--271895
		nvl(grp.ROLLUPID,a.ACCT_NBR) = mem.lvl3id
';
	IF EMPID IN ('WSPI') THEN
		vbQuery := vbQuery||'
	LEFT JOIN
		ZZZ_UMR_MEMUPD_'||vLvl.SERIALNO||' MEM1
	ON
		UPPER(a.MBR_FIRST_NM) = MEM1.MEMFIRSTNAME
	AND
		UPPER(a.MBR_LAST_NM) = MEM1.MEMLASTNAME
	AND
		CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END = MEM1.GENDER
	AND
		a.MBR_BRTH_DT = MEM1.DOB
	AND 	--271895
		nvl(grp.ROLLUPID,a.ACCT_NBR) = MEM1.LVLID3
	';
	ELSIF EMPID IN ('CECO') THEN
		vbQuery := vbQuery||'
	LEFT JOIN
			ZZZ_ELIG_ARDX_TWINS_CECO TWINS
		ON
			UPPER(a.MBR_FIRST_NM) = TWINS.MEMFIRSTNAME
		AND
			UPPER(a.MBR_LAST_NM)= TWINS.MEMLASTNAME
		AND
			a.MBR_BRTH_DT  =  TWINS.DOB
		AND
			CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END  = TWINS.GENDER
		AND
		nvl(grp.ROLLUPID,a.ACCT_NBR) = TWINS.LVLID3 ';
	--330246
	ELSIF EMPID IN ('PRIM', 'OHIO','XAVI','GROT') THEN				----ice337498,5216,12926
		vbQuery := vbQuery||'
	LEFT JOIN
		ZZZ_HUM_MEMUPD_'||vLvl.SERIALNO||' HUM
	ON
		UPPER(a.MBR_FIRST_NM) = HUM.MEMFIRSTNAME
	AND
		UPPER(a.MBR_LAST_NM) = HUM.MEMLASTNAME
	AND
		CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END = HUM.GENDER
	AND
		a.MBR_BRTH_DT = HUM.DOB
	AND
		nvl(grp.ROLLUPID,a.ACCT_NBR) = HUM.LVLID3
	';
	END IF;
	--350132
	IF EMPID IN ('OLSD') THEN
		vbQuery := vbQuery||'
	LEFT JOIN
		--ZZZ_ELIG_ANTHEM_SWOO sw   --ICE 371234
		HR_826_MEMUPD_SWOO SW
	ON
		UPPER(a.MBR_FIRST_NM) = sw.MEMFIRSTNAME
	AND
		UPPER(a.MBR_LAST_NM) = sw.MEMLASTNAME
	AND
		CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END = sw.GENDER
	AND
		a.MBR_BRTH_DT = sw.DOB
	AND
		nvl(grp.ROLLUPID,a.ACCT_NBR) = sw.LVL3ID
	LEFT JOIN
		ZZZ_ELIG_OLSD_SSN ssn
	ON
		a.SBSCRBR_ID = ssn.SBSCRBR_ID
	';
	END IF;
	vbQuery := vbQuery ||
	'
	WHERE
		NVL(pl.DROP_PLAN,''N'')=''N''
	AND
		(CASE WHEN grp.ROLLUPID = ''ARTW'' THEN a.PKG_NBR ELSE ''1'' END) NOT LIKE  ''%Vision%''      --ICE259700
AND
		(CASE WHEN grp.ROLLUPID = ''HAMI'' THEN SUBSTR(A.SUBGRP_NBR,-4) ELSE ''1'' END NOT IN ( ''AAAV'',''AACV'') ) -- ICE 312410, 314441 (else added)
	AND
		(CASE WHEN grp.ROLLUPID IN (''KBCN'',''PRIM'') THEN a.PKG_NBR ELSE ''1'' END) NOT LIKE  ''%Vision%''	  --ICE#269211,330246
	AND
		(CASE WHEN grp.ROLLUPID IN (''MAKN'',''RELA'') THEN a.PKG_NBR ELSE ''1'' END) NOT LIKE  ''%Vision%''		--ICE#4731, ICE#14352
		AND
		(CASE WHEN a.acct_nbr = ''00171811'' THEN a.PKG_NBR ELSE ''1'' END) NOT LIKE  ''%Vision%''      --ICE 7281
AND
		(CASE WHEN a.acct_nbr = ''W41215'' THEN SUBSTR(A.SUBGRP_NBR,-4) ELSE ''1'' END NOT IN ( ''V001'',''V002'',''VC01''))   --ICE 7281
	';
  IF EmpID='BTLR' THEN
			vbQuery:=vbQuery||' and a.ACCT_NBR = ''834~003321010'' and SUBSTR(A.SUBGRP_NBR,-4) in (''B1AG'',''B1AP'',''B2CG'',''B2CP'')';
  END IF;
  IF EmpID='PEVM' THEN
			vbQuery:=vbQuery||' and SUBSTR(A.SUBGRP_NBR,-4) not in (''VC01'',''V001'')';       	--ICE#5645

  END IF;
-- added as per ICE#159780 followup 9

	BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('ELIG',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_ANTHEM_'||EMPID,'Y','I');
		DBMS_STATS.GATHER_TABLE_STATS(OWNNAME => USER, TABNAME => 'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'', ESTIMATE_PERCENT => DBMS_STATS.AUTO_SAMPLE_SIZE); --ICE 2933
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ELIG',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

--------------------------------------------------
--MEMID/ ENRID Update due to WGS Migration(3113, 3114, 3151,4063,7281,9722, 10629,10919,10920,10920,10922, 10717, 11626, 12593,15285,15712,15286,,ICE-16085, 18616)
IF EMPID in ('CIMO', 'SHAW', 'TBCM','MAYF','OMYA','FUYA','FHLB','EAGF','PEVM','TCRG','ADTL', 'MEDP','ATRM','GRTI','GTEG','00172422','RITT', 'TRAN','COCI', 'ARTW', 'GTCO', 'MAKN','PRIM','MAKI','OHIO','KMCC','RTCO', 'COMS','UCFO','RELA','DNHB') THEN
vbQuery:='	MERGE /*+ parallel(a,4) */ INTO  VH_ELIGIBILITIES_'||vLvl.SERIALNO||' A
USING
(
	SELECT DISTINCT MEMID,ENRID,LVLID3,LVLDESC3,MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB,UDFC1
	FROM
	(
    SELECT
		DISTINCT MEMID,ENRID,LVLID3,LVLDESC3,MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB,UDFC1,
		Row_Number()over (PARTITION BY LVLID3,MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ORDER BY EFFDATE DESC, TERMDATE DESC ) rn
	FROM  VH_ELIGIBILITIES_'||vLvl.SERIALNO||' A WHERE A.UDFC20 NOT LIKE ''W%''
	) WHERE rn=1
) b
ON
(
			a.MEMFIRSTNAME=b.MEMFIRSTNAME
		AND
			a.MEMLASTNAME=b.MEMLASTNAME
		AND
			a.GENDER=b.GENDER
		AND
			a.DOB=b.DOB
		AND
			a.LVLID3=b.LVLID3

)
WHEN MATCHED THEN UPDATE
SET
	a.MEMID=b.MEMID,
	a.ENRID=b.ENRID
WHERE
  A.UDFC20 LIKE ''W%'' ';

BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('Anthem MEMID Update',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_ANTHEM_'||EMPID,'Y','I');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('Anthem MEMID Update',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

END IF;

--------------------------------------------------
-- ICE#264343   ICE-1794
IF EMPID in ('KBCN', 'MDOM', 'WSTR', 'RLCS' ) THEN    --ICE-18938
vbQuery:='	MERGE /*+PARALLEL(A,4)*/ INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||' A
			USING (
			SELECT MEMID, ENRID, RELFLAG, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB
			FROM
			(
			 SELECT /*+PARALLEL(A,4)*/  MEMID, ENRID, RELFLAG, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ,
			 ROW_NUMBER() OVER (PARTITION BY RELFLAG, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ORDER BY EFFDATE ASC NULLS LAST, TERMDATE ASC NULLS LAST) RN
			 FROM  VH_ELIGIBILITIES_'||vLvl.SERIALNO||' A ) WHERE RN=1
			 ) B
			 ON
			 (
			  A.RELFLAG = B.RELFLAG AND
			  A.MEMFIRSTNAME = B.MEMFIRSTNAME AND
			  A.MEMLASTNAME = B.MEMLASTNAME AND
			  A.GENDER = B.GENDER AND
			  A.DOB = B.DOB
			 )
			 WHEN MATCHED THEN UPDATE SET
			 A.MEMID = B.MEMID ,
			 A.ENRID = B.ENRID';
IF EMPID <> ('RLCS' ) THEN       --ICE-18938
  vbquery := vbquery || ' WHERE A.ENRID <> B.ENRID';
END IF;

BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('Anthem MEMID Update',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_ANTHEM_'||EMPID,'Y','I');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('Anthem MEMID Update',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

END IF;


--------------------------------------------------------------------------------------------------------------
IF EMPID IN ('WSPI','PRIM','OHIO','XAVI','COMS','GROT','UCFO', 'RLCS') THEN			----ice337498,350132,(,'OLSD')371234,5216,8136,12926,15172 --ICE-18938
vbQuery:='CREATE TABLE ZZZ_VH_ELIG_MEMUPD_'||EMPID||' AS
SELECT * FROM
(SELECT DISTINCT MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3
FROM
(
SELECT /*+PARALLEL(A,4)*/  MEMID, ENRID,  MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ,LVLID3,
			 ROW_NUMBER() OVER (PARTITION BY LVLID3, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ORDER BY EFFDATE ASC NULLS LAST, TERMDATE ASC NULLS LAST) RN
			 FROM  VH_ELIGIBILITIES_'||vLvl.SERIALNO||' A ) WHERE RN=1
			 ) B


WHERE LVLID3 IN (''WSPI'',''PRIM'',''OHIO'',''XAVI'',''COMS'',''GROT'',''UCFO'' ,''RLCS'')';	--(,''SWOO'')371234,5216,8136,12926, 15172 --ICE-18938

BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('WSPI MEMID Update',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_ANTHEM_'||EMPID,'Y','I');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('WSPI MEMID Update',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

END IF;
--------------------------------------------------------------------------------------------------------------
--ICE#269211
IF EMPID = 'KBCN' THEN

BEGIN EXECUTE IMMEDIATE 'DROP TABLE VH_ELIGIBILITIES_KBCN PURGE';
	EXCEPTION WHEN OTHERS THEN NULL;
END;

vbQuery:='RENAME VH_ELIGIBILITIES_'||vLvl.SERIALNO||' to VH_ELIGIBILITIES_KBCN';

BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('RENAME KBCN',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_ANTHEM_'||EMPID,'Y','I');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RENAME KBCN',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
COMMIT;

--vbQuery:='UPDATE VH_ELIGIBILITIES_KBCN SET lvlid2='''',lvldesc2=''''';  --ice221/222

--BEGIN EXECUTE IMMEDIATE vbquery;
		--xp_scrubStatusLog ('NULL LOA2 KBCN',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_ANTHEM_'||EMPID,'Y','I');
	--EXCEPTION WHEN OTHERS THEN
		--xp_scrubStatusLog ('NULL LOA2 KBCN',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	--END;
--COMMIT; --ICE 221/222

--PMPR
DECLARE
	  VBLCYCLESTARTDATE varchar2(20);
	  VBLCYCLEENDDATE varchar2(20);
  BEGIN
	SELECT TO_CHAR(CYCLESTARTDATE,'DD-MON-YYYY') INTO VBLCYCLESTARTDATE FROM VH_RUNDATE;
	SELECT TO_CHAR(CYCLEENDDATE,'DD-MON-YYYY') INTO VBLCYCLEENDDATE FROM VH_RUNDATE;

	PKG_PMPR.CREATE_MEMBERS_PER_MONTH('VH_ELIGIBILITIES_KBCN','VH_ELIGIBILITIES_9097',VBLCYCLESTARTDATE,VBLCYCLEENDDATE,'Y');

	COMMIT;
END;

------
--LOA 2 UPDATE
vbQuery:='UPDATE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
SET lvlid2=  CASE  WHEN BEGIN_DTE BETWEEN TO_DATE(''2014-07-01'',''YYYY-MM-DD'') and TO_DATE(''2015-06-30'',''YYYY-MM-DD'') AND upper(UDF2)=''HEALTH 1'' THEN ''HEALTH1KBCN1415''
					  WHEN BEGIN_DTE BETWEEN TO_DATE(''2015-07-01'',''YYYY-MM-DD'') and TO_DATE(''2016-06-30'',''YYYY-MM-DD'')AND upper(UDF2)=''HEALTH 1'' THEN ''HEALTH1KBCN1516''
					  WHEN BEGIN_DTE BETWEEN TO_DATE(''2014-07-01'',''YYYY-MM-DD'') and TO_DATE(''2015-06-30'',''YYYY-MM-DD'') AND upper(UDF2)=''HEALTH 2'' THEN ''HEALTH2KBCN1415''
					  WHEN BEGIN_DTE BETWEEN TO_DATE(''2015-07-01'',''YYYY-MM-DD'') and TO_DATE(''2016-06-30'',''YYYY-MM-DD'')AND upper(UDF2)=''HEALTH 2'' THEN ''HEALTH2KBCN1516''
					  WHEN BEGIN_DTE >=TO_DATE(''2016-07-01'',''YYYY-MM-DD'') AND upper(UDF2)=''HEALTH 1'' THEN ''HEALTH1KBCN16''
						 ELSE LVLID2
				END,
	lvldesc2= CASE WHEN BEGIN_DTE BETWEEN TO_DATE(''2014-07-01'',''YYYY-MM-DD'') and TO_DATE(''2015-06-30'',''YYYY-MM-DD'')AND upper(UDF2)=''HEALTH 1'' THEN ''7.6 Lumenos HSA non-embedded $3000 ded single only''
					 WHEN BEGIN_DTE BETWEEN TO_DATE(''2015-07-01'',''YYYY-MM-DD'') and TO_DATE(''2016-06-30'',''YYYY-MM-DD'')AND upper(UDF2)=''HEALTH 1'' THEN ''8.6 Lumenos HSA non-embedded $3000 ded single only''
					 WHEN BEGIN_DTE BETWEEN TO_DATE(''2014-07-01'',''YYYY-MM-DD'') and TO_DATE(''2015-06-30'',''YYYY-MM-DD'') AND upper(UDF2)=''HEALTH 2'' THEN ''7.6 Lumenos HSA non-embedded $6000 ded family''
					 WHEN BEGIN_DTE BETWEEN TO_DATE(''2015-07-01'',''YYYY-MM-DD'') and TO_DATE(''2016-06-30'',''YYYY-MM-DD'')AND upper(UDF2)=''HEALTH 2'' THEN ''8.6 Lumenos HSA non-embedded $6000 ded family''
					 WHEN BEGIN_DTE >=TO_DATE(''2016-07-01'',''YYYY-MM-DD'') AND upper(UDF2)=''HEALTH 1'' THEN ''8.6 Lumenos HSA Embedded $3000 ded''
						 ELSE LVLDESC2
				END';  --ICE 221/222

	BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('ELIG',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_ANTHEM_'||EMPID,'Y','I');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('LOA 2 UPDATE-KBCN',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

vbQuery:='UPDATE VH_ELIGIBILITIES_'||vLvl.SERIALNO||' SET UDF2=''''';

BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('UDF2 NULL-KBCN',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_ANTHEM_'||EMPID,'Y','I');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('UDF2 NULL-KBCN',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
END IF;
----ICE#269211 END
------------------------------------------------

------------------------------------------------

END IF;

---------------------------------------------- UHC implementation starts ---------------------
IF  vLvl.PAYER='UHC' THEN

----handle twins
IF EMPID IN ('WOOL','FIGA', 'FIAE', 'PHEC','CHWI','ERNS','HMLT','HDCO','MEVS', 'CTIS','DRCO', 'LSIN') THEN	--318790 --ICE_5371,ICE_134 --ICE_2056,5264, 11345,14138, ICE-16119
BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE ZZZ_UHC_'||EMPID||'_TWIN PURGE';
        EXCEPTION WHEN OTHERS THEN NULL;
END;


BEGIN
        EXECUTE IMMEDIATE'
        CREATE TABLE ZZZ_UHC_'||EMPID||'_TWIN NOLOGGING PARALLEL 4 AS
        SELECT /*+PARALLEL(A,4)*/
	        nvl(grp.ROLLUPID,a.Customerstructure1) LVL3ID,COALESCE(SUBSTR(A.EMPLOYEENUMBER,-9),''EMPLOYEEID'') ENRID,UPPER(A.FIRSTNAME) MEMFIRSTNAME,UPPER(A.LASTNAME) MEMLASTNAME, NVL(A.BIRTHDATE,TO_DATE(''2000/01/01'',''YYYY/MM/DD'')) DOB, NVL(CASE WHEN A.SEX IN (''F'',''M'') THEN A.SEX ELSE ''U'' END,''X'') GENDER ,
          COALESCE(SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID'') MEMID,
		  --ICE_134
		 --COALESCE(SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID'')||A.DEPENDENTNUMBER END NEW_MEMID
		 CASE WHEN grp.memid_grp_flag=''Y''
          THEN COALESCE(SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID'')||A.DEPENDENTNUMBER||''-''||nvl(grp.ROLLUPID,a.Customerstructure1)
		 ELSE
		  COALESCE(SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID'')||A.DEPENDENTNUMBER END NEW_MEMID
        FROM
	        hi0826001.HI_ELIG_UHC_036_'||EMPID||' A      --3051
          LEFT JOIN
		        HR_826_GROUP GRP
	        ON
		        A.CUSTOMERSTRUCTURE1 = GRP.SRC_CODE
        WHERE
          COALESCE(SUBSTR(A.EMPLOYEENUMBER,-9),''EMPLOYEEID'') ||UPPER(A.LASTNAME) ||A.BIRTHDATE ||CASE WHEN A.SEX IN (''F'',''M'') THEN A.SEX ELSE ''U'' END IN
	        (
	        SELECT /*+PARALLEL(A,4)*/  COALESCE(SUBSTR(A.EMPLOYEENUMBER,-9),''EMPLOYEEID'') ||UPPER(A.LASTNAME) ||A.BIRTHDATE ||CASE WHEN A.SEX IN (''F'',''M'') THEN A.SEX ELSE ''U'' END
          FROM hi0826001.HI_ELIG_UHC_036_'||EMPID||' A        --3051
          GROUP BY COALESCE(SUBSTR(A.EMPLOYEENUMBER,-9),''EMPLOYEEID'') ||UPPER(A.LASTNAME) ||A.BIRTHDATE ||CASE WHEN A.SEX IN (''F'',''M'') THEN A.SEX ELSE ''U'' END
          HAVING
          (COUNT(DISTINCT UPPER(A.FIRSTNAME))>1
          AND
          COUNT(DISTINCT A.DEPENDENTNUMBER)>1)
	        )
        GROUP BY
			nvl(grp.ROLLUPID,a.Customerstructure1) ,COALESCE(SUBSTR(A.EMPLOYEENUMBER,-9),''EMPLOYEEID'') ,UPPER(A.FIRSTNAME) ,UPPER(A.LASTNAME) , NVL(A.BIRTHDATE,TO_DATE(''2000/01/01'',''YYYY/MM/DD'')) ,
			NVL(CASE WHEN A.SEX IN (''F'',''M'') THEN A.SEX ELSE ''U'' END,''X'') ,COALESCE(SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID''),
			--COALESCE(SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID'')||A.DEPENDENTNUMBER
			CASE WHEN grp.memid_grp_flag=''Y''
				THEN COALESCE(SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID'')||A.DEPENDENTNUMBER||''-''||nvl(grp.ROLLUPID,a.Customerstructure1)
			ELSE
				COALESCE(SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID'')||A.DEPENDENTNUMBER END
		ORDER BY 2
        ';
EXCEPTION WHEN OTHERS THEN NULL;
END;

END IF;
----------------------CREATE TWINS TABLE FOR SOURCE AETNA ICE#6052-------------
IF EMPID in ('FIGA')
THEN

    BEGIN
			EXECUTE IMMEDIATE 'DROP TABLE ZZZ_TWINS_AETNA_UHC_'||VLVL.SERIALNO;
			EXCEPTION WHEN OTHERS THEN NULL;
	END;

vbquery:=' CREATE TABLE ZZZ_TWINS_AETNA_UHC_'||VLVL.SERIALNO||' AS
  SELECT
	DISTINCT
	NVL(lvl3.rollupid,substr(a.HIERARCHY_LEVEL_3,-7)) LVLID3 ,
	substr(a.SUBSCRIBER_SSN,-9)||DECODE(UPPER(A.member_gender),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(A.member_date_of_birth,''YYYYMMDD'')||CASE WHEN lvl3.MEMID_GRP_FLAG = ''Y'' THEN ''-''||lvl3.ROLLUPID END AS MEMID,
	substr(a.SUBSCRIBER_SSN,-9)||CASE WHEN lvl3.MEMID_GRP_FLAG = ''Y'' THEN ''-''||lvl3.ROLLUPID END as ENRID,
	UPPER(A.MEMBER_FIRST_NAME ) AS MEMFIRSTNAME,
		UPPER(A.MEMBER_LAST_NAME) AS MEMLASTNAME,
		DECODE(UPPER(A.MEMBER_GENDER),''F'',''F'',''M'',''M'',''U'') AS GENDER,
		A.MEMBER_DATE_OF_BIRTH AS DOB,
	substr(a.SUBSCRIBER_SSN,-9)||DECODE(UPPER(A.MEMBER_GENDER),''F'',''F'',''M'',''M'',''U'')||TO_CHAR(A.MEMBER_DATE_OF_BIRTH,''YYYYMMDD'')||CASE WHEN lvl3.MEMID_GRP_FLAG = ''Y'' THEN ''-''||lvl3.ROLLUPID END||''-''||SubStr(UPPER(A.MEMBER_FIRST_NAME),1,4) as MEMID_NEW
	FROM
	HI0826001.HI_ELIG_AETNA_'||EMPID||'  A
	left join
	HR_826_GROUP lvl3
  on
	substr(a.HIERARCHY_LEVEL_3,-7)  =  lvl3.SRC_CODE
	WHERE
		DECODE (UPPER(MEM_RELATIONSHIP_TO_SUBSCRIBER),''E'',''E'',''S'',''S'',''P'',''S'',''X'',''S'',''C'',''D'',''D'',''D'',''F'',
             ''D'',''G'',''D'',''H'',''D'',''L'',''D'',''T'',''D'',''U'') = ''D'' --Applies for Dependent only
	AND
		substr(a.SUBSCRIBER_SSN,-9)||UPPER(A.MEMBER_LAST_NAME)||A.MEMBER_DATE_OF_BIRTH||DECODE(UPPER(A.MEMBER_GENDER),''F'',''F'',''M'',''M'',''U'')
	IN
		(
		SELECT  substr(a.SUBSCRIBER_SSN,-9)||UPPER(A.MEMBER_LAST_NAME)||A.MEMBER_DATE_OF_BIRTH||DECODE(UPPER(A.MEMBER_GENDER),''F'',''F'',''M'',''M'',''U'')
    FROM HI0826001.HI_ELIG_AETNA_'||EMPID||' a
		WHERE
			DECODE (UPPER(MEM_RELATIONSHIP_TO_SUBSCRIBER),''E'',''E'',''S'',''S'',''P'',''S'',''X'',''S'',''C'',''D'',''D'',''D'',''F'',
             ''D'',''G'',''D'',''H'',''D'',''L'',''D'',''T'',''D'',''U'') = ''D''
		GROUP BY substr(a.SUBSCRIBER_SSN,-9)||UPPER(A.MEMBER_LAST_NAME)||A.MEMBER_DATE_OF_BIRTH||DECODE(UPPER(A.MEMBER_GENDER),''F'',''F'',''M'',''M'',''U'')
		HAVING COUNT(DISTINCT UPPER(A.MEMBER_FIRST_NAME))>1
		)
	GROUP BY
		NVL(lvl3.rollupid,substr(a.HIERARCHY_LEVEL_3,-7)) ,
	substr(a.SUBSCRIBER_SSN,-9)||DECODE(UPPER(A.member_gender),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(A.member_date_of_birth,''YYYYMMDD'')||CASE WHEN lvl3.MEMID_GRP_FLAG = ''Y'' THEN ''-''||lvl3.ROLLUPID END,
	substr(a.SUBSCRIBER_SSN,-9)||CASE WHEN lvl3.MEMID_GRP_FLAG = ''Y'' THEN ''-''||lvl3.ROLLUPID END,
	UPPER(A.MEMBER_FIRST_NAME ),
		UPPER(A.MEMBER_LAST_NAME),
		DECODE(UPPER(A.MEMBER_GENDER),''F'',''F'',''M'',''M'',''U''),
		A.MEMBER_DATE_OF_BIRTH,
    substr(a.SUBSCRIBER_SSN,-9)||DECODE(UPPER(A.MEMBER_GENDER),''F'',''F'',''M'',''M'',''U'')||TO_CHAR(A.MEMBER_DATE_OF_BIRTH,''YYYYMMDD'')||CASE WHEN lvl3.MEMID_GRP_FLAG = ''Y'' THEN ''-''||lvl3.ROLLUPID END||''-''||SubStr(UPPER(A.MEMBER_FIRST_NAME),1,4)
	ORDER BY 1,2,3,4

	';

BEGIN EXECUTE IMMEDIATE VBQUERY;
 xp_scrubStatusLog ('AETNA '|| EMPID || ' TWIN TABLE',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_AETNA_'||EMPID,'Y','I');
EXCEPTION WHEN OTHERS THEN
xp_scrubStatusLog ('AETNA '|| EMPID ||' TIRE TWIN TABLE',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
END;

END IF;
------------------------------------------------------------------------------------------------
IF EMPID IN ('FIGA') THEN
--------------------------------ICE 6052-------------------------------------------------
 BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE ZZZ_AETNA_ELIG_MEMUPD_'||EMPID||' PURGE';
        EXCEPTION WHEN OTHERS THEN NULL;
END;
vbQuery:='CREATE TABLE ZZZ_AETNA_ELIG_MEMUPD_'||EMPID||' NOLOGGING PARALLEL 4
    AS
   SELECT
		MEMID,
		ENRID,
		RELFLAG,
		MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		LVLID3
    FROM(
    SELECT /*+PARALLEL (a,4)*/
		COALESCE (TW.MEMID_NEW,substr(a.SUBSCRIBER_SSN,-9)||DECODE(UPPER(A.member_gender),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(A.member_date_of_birth,''YYYYMMDD'')||CASE WHEN lvl3.MEMID_GRP_FLAG = ''Y'' THEN ''-''||lvl3.ROLLUPID END) AS MEMID,
		substr(a.SUBSCRIBER_SSN,-9)||CASE WHEN lvl3.MEMID_GRP_FLAG = ''Y'' THEN ''-''||lvl3.ROLLUPID END as ENRID,
		DECODE (UPPER(MEM_RELATIONSHIP_TO_SUBSCRIBER),''E'',''E'',''S'',''S'',''P'',''S'',''X'',''S'',''C'',''D'',''D'',''D'',''F'',
        ''D'',''G'',''D'',''H'',''D'',''L'',''D'',''T'',''D'',''U'') AS RELFLAG,
		UPPER(A.MEMBER_FIRST_NAME ) AS MEMFIRSTNAME,
		UPPER(A.MEMBER_LAST_NAME) AS MEMLASTNAME,
		DECODE(UPPER(A.MEMBER_GENDER),''F'',''F'',''M'',''M'',''U'') AS GENDER,
		A.MEMBER_DATE_OF_BIRTH AS DOB,
	    NVL(lvl3.rollupid,substr(a.HIERARCHY_LEVEL_3,-7)) LVLID3,
		Row_Number() OVER (PARTITION BY UPPER(a.MEMBER_FIRST_NAME),
    UPPER(a.MEMBER_LAST_NAME),DECODE(UPPER(A.MEMBER_GENDER),''F'',''F'',''M'',''M'',''U''),a.MEMBER_DATE_OF_BIRTH,NVL(lvl3.rollupid,substr(a.HIERARCHY_LEVEL_3,-7)),DECODE (UPPER(MEM_RELATIONSHIP_TO_SUBSCRIBER),''E'',''E'',''S'',''S'',''P'',''S'',''X'',''S'',''C'',''D'',''D'',''D'',''F'',
    ''D'',''G'',''D'',''H'',''D'',''L'',''D'',''T'',''D'',''U'')
    ORDER BY Nvl(a.INDIVIDUAL_ORIG_EFF_DATE_AETNA,FLDT.effective_date) ASC nulls last,
    CASE WHEN Nvl(a.INDIVIDUAL_CANCEL_DATE_AETNA,To_Date(''99991231'',''YYYYMMDD''))>TO_DATE(''20181231'',''YYYYMMDD'') THEN TO_DATE(''20181231'',''YYYYMMDD'')    ---ICE 4867
	ELSE a.INDIVIDUAL_CANCEL_DATE_AETNA END  ASC nulls last ) rn
		FROM
	HI0826001.HI_ELIG_AETNA_'||EMPID||'  A
    left join
	HR_826_GROUP lvl3
  on
	substr(a.HIERARCHY_LEVEL_3,-7)  =  lvl3.SRC_CODE
	LEFT JOIN
		HR_826_FILEDATE_AETNA FLDT
	ON
		UPPER(a.SOURCEFILENAME)  =  UPPER(FLDT.SRCFILENAME)
	AND
		a.RECEIVEDMONTH	 = FLDT.RECEIVEDMONTH
	LEFT JOIN
		ZZZ_TWINS_AETNA_UHC_'||VLVL.SERIALNO||' TW
	ON
		UPPER(A.MEMBER_FIRST_NAME )=UPPER(TW.MEMFIRSTNAME)
	AND
		UPPER(A.MEMBER_LAST_NAME)=UPPER(TW.MEMLASTNAME)
	AND
		A.MEMBER_DATE_OF_BIRTH=TW.DOB
	AND
		DECODE(UPPER(A.MEMBER_GENDER),''F'',''F'',''M'',''M'',''U'') =UPPER(TW.GENDER)
	AND
		NVL(lvl3.rollupid,substr(a.HIERARCHY_LEVEL_3,-7))=TW.LVLID3
 )
    WHERE rn=1';
 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('UHC MEMID UPDATE TABLE ZZZ_AETNA_ELIG_MEMUPD_FIGA CREATED',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	 END;
	 COMMIT;

END IF;

--ICE_134 MEMIP UPDATE FROM ANTHEM TO UHC FOR 'ERNS'
IF EMPID IN ('ERNS') THEN	--318790 --ICE_134
BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE ZZZ_ARDX_ELIG_MEMUPD_'||EMPID||' PURGE';
        EXCEPTION WHEN OTHERS THEN NULL;
END;
---------------------------------------------------------------------------------

vbQuery:='
	CREATE TABLE ZZZ_ARDX_ELIG_MEMUPD_'||EMPID||' NOLOGGING PARALLEL 4
    AS
    SELECT
		MEMID,
		ENRID,
		MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		LVLID3
    FROM(
    SELECT /*+PARALLEL (a,4)*/
		COALESCE(REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~''),''MEMBERID'') AS MEMID,
		COALESCE(REPLACE(a.SBSCRBR_ID,''~''),''EMPLOYEEID'') AS	ENRID,
		UPPER(a.MBR_FIRST_NM) AS MEMFIRSTNAME,
		UPPER(a.MBR_LAST_NM) AS MEMLASTNAME,
		CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END AS  Gender,
		a.MBR_BRTH_DT  AS DOB,
		nvl(grp.ROLLUPID,a.ACCT_NBR) AS LVLID3,
    Row_Number() OVER (PARTITION BY UPPER(a.MBR_FIRST_NM),
    UPPER(a.MBR_LAST_NM),CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END,a.MBR_BRTH_DT,nvl(grp.ROLLUPID,a.ACCT_NBR)
    ORDER BY a.MBR_EFCTV_DT ASC nulls last,
    CASE WHEN a.mbr_term_dt > To_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') THEN
		to_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') ELSE a.mbr_term_dt END ASC nulls last ) rn
	FROM
		HI0826001.HI_ELIG_ANTHEM_ERNST a
	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.ACCT_NBR = grp.src_code
    )
    WHERE rn=1';
 -------------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ARDX MEMID UPDATE TABLE ZZZ_ARDX_ELIG_MEMUPD_'||EMPID||' CREATED',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	 END;
	 COMMIT;

END IF;
--------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------
	---------------------------------4493 UHC--MI Implementation--------------------------------------------------------------
	VBQUERY := 'DROP TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_U_CSTM PURGE'; --DEFECT 4748
		BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_U_CSTM AS
	SELECT
		SOURCE,
		MEMID,
		ENRID,
		EFFDATE,
		TERMDATE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		COVTYPEID,
		COVTYPEDESC,
		BENCOVTYPEDESC,
		PLANTYPE,
		PLANNAME,
		PRODUCTID,
		UDFC21 --ICE-17438
	FROM
		VH_ELIGIBILITIES
	WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG TABLE CREATE UHC',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_U_CSTM ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_U_CSTM ADD CONSTRAINT PK_CSTM_ELIG_UHC_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	BEGIN
		SP_PYR_5304_ELIG_UHC('HI0826001','HI_ELIG_UHC_036_'||EMPID||'','ELIG','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_U_COMM');     --3051
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG-COMM UHC',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_5304_ELIG_UHC','','E');  --3051
	END;

	COMMIT;
----------------------------------------------------------------------------------------------------------

	vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_U_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		EFFDATE,
		TERMDATE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		COVTYPEID,
		COVTYPEDESC,
		BENCOVTYPEDESC,
		PLANTYPE,
		PLANNAME,
		PRODUCTID,
		UDFC21 --ICE-17438
	)
	SELECT
		a.ROWID AS SRCROWID,
		''UHC'' AS Source,
		CASE
			WHEN grp.ROLLUPID = ''FERN'' THEN COALESCE(MEM.MEMID,SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID'')
			WHEN grp.memid_grp_flag=''Y'' THEN COALESCE(CASE WHEN grp.ROLLUPID = ''WOOL'' THEN MEM1.MEMID END,  ----ice 284513
		';
		IF EMPID IN ('WOOL','FIAE', 'PHEC','CHWI','HMLT','HDCO', 'CTIS','DRCO','LSIN') THEN    --ICE 5264 --ICE-14138 --ICE-16119
		vbQuery:=vbQuery||'TWIN.NEW_MEMID,
		';
		END IF;
		IF EMPID IN ('FIGA') THEN    --ICE 6052
		vbQuery:=vbQuery||'COALESCE(MEM3.MEMID,TWIN.NEW_MEMID,NVL(SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID'')||''-''||nvl(grp.ROLLUPID,a.Customerstructure1)),
		';
		END IF;
		vbQuery:=vbQuery||'NVL(SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID'')||''-''||nvl(grp.ROLLUPID,a.Customerstructure1))
		ELSE
		';    	--ICE_134 5643
		IF EMPID in ('ERNS') THEN
		vbQuery:=vbQuery||'COALESCE(TWIN.NEW_MEMID,MEM2.MEMID,SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID'')
		';
		ELSIF EMPID in ('MEVS') THEN
		vbQuery:=vbQuery||'COALESCE(TWIN.NEW_MEMID,SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID'')
		';
		ELSE
		vbQuery:=vbQuery||' COALESCE(SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID'')
		';
		END IF;
		vbQuery:=vbQuery||
		'
		END AS MemID,
		'; 	--ICE_134
		IF EMPID='ERNS' THEN
		vbQuery:=vbQuery||'COALESCE(MEM2.ENRID,SUBSTR(a.EMPLOYEENUMBER,-9),''EMPLOYEEID'') AS ENRID,
		';
		ELSIF EMPID='FIGA' THEN
		vbQuery:=vbQuery||'COALESCE(MEM3.ENRID,NVL(SUBSTR(a.EMPLOYEENUMBER,-9), ''EMPLOYEEID'')||''-''||nvl(grp.ROLLUPID,a.Customerstructure1)) AS ENRID,
		';
		ELSE
		vbQuery:=vbQuery||'
		CASE
			WHEN grp.ROLLUPID = ''FERN'' THEN COALESCE(MEM.ENRID,SUBSTR(a.EMPLOYEENUMBER,-9),''EMPLOYEEID'')
		    WHEN grp.memid_grp_flag=''Y'' THEN COALESCE(CASE WHEN grp.ROLLUPID in (''WOOL'', ''CTIS'') THEN MEM1.ENRID END, NVL(SUBSTR(a.EMPLOYEENUMBER,-9), ''EMPLOYEEID'')||''-''||nvl(grp.ROLLUPID,a.Customerstructure1))  ----ice 284513
		    ELSE COALESCE(SUBSTR(a.EMPLOYEENUMBER,-9),''EMPLOYEEID'')
		  END AS ENRID,
		  ';
		END IF;
		vbQuery:= vbQuery||'  --287830E
		CASE WHEN a.COVERAGESTARTDATE < d.EFFDATE THEN d.EFFDATE ELSE a.COVERAGESTARTDATE END AS EffDate,
		CASE
			WHEN grp.rollupid=''729388'' AND To_Char( Nvl(A.COVERAGESTOPDATE, To_Date(A.RECEIVEDMONTH, ''YYYYMM'') -1), ''YYYYMMDD'') >= ''20170630'' THEN  To_Date(''20170630'', ''YYYYMMDD'')
		  --WHEN grp.rollupid=''702313'' AND To_Char( Nvl(A.COVERAGESTOPDATE, To_Date(''99991231'', ''YYYYMMDD'')), ''YYYYMMDD'') >= ''20171231'' THEN  To_Date(''20171231'', ''YYYYMMDD'') 	--318790   ---ice342122
			WHEN grp.rollupid=''FIAE'' AND To_Char( Nvl(A.COVERAGESTOPDATE, To_Date(A.RECEIVEDMONTH, ''YYYYMM'') -1), ''YYYYMMDD'') >= ''20191130'' THEN  To_Date(''20191130'', ''YYYYMMDD'')--ICE#10928
			WHEN grp.rollupid=''HMLT'' and NVL(A.COVERAGESTOPDATE, To_Date(''99991231'', ''YYYYMMDD'')) >= Last_day(To_Date(A.RECEIVEDMONTH, ''YYYYMM'') -1) THEN Last_day(To_Date(A.RECEIVEDMONTH, ''YYYYMM'') -1) --ICE_2056
			WHEN grp.rollupid in (''HDCO'', ''CTIS'',''FIGA'',''DRCO'',''LSIN'') and NVL(A.COVERAGESTOPDATE, To_Date(''99991231'', ''YYYYMMDD'')) >= Last_day(Add_Months(To_Date(SubStr(A.SOURCEFILENAME,-12,8), ''YYYYMMDD'') ,-1))  THEN Last_day(Add_Months(To_Date(SubStr(A.SOURCEFILENAME,-12,8), ''YYYYMMDD'') ,-1)) --ICE-9530--12063 --ICE-14138 --ICE-16119
			WHEN grp.rollupid = ''XENI'' AND To_Char( Nvl(A.COVERAGESTOPDATE, To_Date(A.RECEIVEDMONTH, ''YYYYMM'') -1), ''YYYYMMDD'') >= ''20191231'' THEN To_Date(''20191231'', ''YYYYMMDD'') --ICE-11915
			WHEN NVL(A.COVERAGESTOPDATE, To_Date(''99991231'', ''YYYYMMDD'')) >= To_Date(A.RECEIVEDMONTH, ''YYYYMM'') -1    THEN  To_Date(A.RECEIVEDMONTH, ''YYYYMM'') -1  ---ICE12050 
		ELSE
			A.COVERAGESTOPDATE
		END as termdate,
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		lv.ROLLUP_PLANID AS LVLID2,
		lv.ROLLUP_PLANNM  AS LVLDESC2,
		nvl(grp.ROLLUPID,a.Customerstructure1) AS LVLID3,
		nvl(grp.Group_Name,a.Customerstructure1) AS LVLDESC3,
		lv.ROLLUP_SUB_GRPID AS LVLID4,
		lv.ROLLUP_SUB_GRPNM AS LVLDESC4,
		''MED'' COVTYPEID,
		''MEDICAL'' COVTYPEDESC,
		(SELECT cv.ROLLUP_DESC FROM HR_826_COVERAGE cv WHERE ''UHC'' = cv.source AND UPPER(A.MEMBERSCOVERED)=cv.SRC_CODE) BENCOVTYPEDESC,
		lv.PLANTYPE PLANTYPE ,
		lv.ROLLUP_PLANNM PLANNAME,
		''1'' AS PRODUCTID, --in hr_global_productLine 1 prodID is mapped as commercial
		a.EMPLOYEENUMBER AS UDFC21 --ICE-17438
	FROM
		HI0826001.HI_ELIG_UHC_036_'||EMPID||' a     --3051

	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.CUSTOMERSTRUCTURE1 = grp.SRC_CODE

	left JOIN
		HR_826_ELIG_CUTOFF  d
	ON
		nvl(grp.ROLLUPID,a.CUSTOMERSTRUCTURE1) = d.grpid3

	LEFT JOIN
		HR_826_UHC_LOA lv
	ON
		a.CUSTOMERSTRUCTURE1 = lv.SRC_CD1
		AND
		a.CUSTOMERSTRUCTURE4 = lv.SRC_CD2  ------previously used customerstructure4

	LEFT JOIN
		ZZZ_MEMID_UPDATE_ANTHEM_UHC MEM
	ON
		UPPER(a.FIRSTNAME) = MEM.MEMFIRSTNAME
		AND
		UPPER(a.LASTNAME) = MEM.MEMLASTNAME
		AND
		CASE WHEN a.SEX IN (''F'',''M'') THEN a.SEX ELSE ''U'' END = MEM.GENDER
		AND
		a.BIRTHDATE = MEM.DOB
		AND
		nvl(grp.ROLLUPID,a.Customerstructure1) = MEM.LVL3ID
	LEFT JOIN
		ZZZ_MEMID_UPDATE_ANTHEM_WOOL MEM1  --283275
	ON
		UPPER(a.FIRSTNAME) = MEM1.MEMFIRSTNAME
		AND
		UPPER(a.LASTNAME) = MEM1.MEMLASTNAME
		AND
		CASE WHEN a.SEX IN (''F'',''M'') THEN a.SEX ELSE ''U'' END = MEM1.GENDER
		AND
		a.BIRTHDATE = MEM1.DOB
		AND
		nvl(grp.ROLLUPID,a.Customerstructure1)= MEM1.LVL3ID
	';

	IF EMPID IN ('WOOL','FIGA', 'FIAE', 'PHEC','CHWI','ERNS','HMLT','HDCO','MEVS', 'CTIS','DRCO', 'LSIN') THEN --ICE_134, ICE#5317,5264, 11345,14138, 16119
	vbQuery := vbQuery || '
	LEFT JOIN
		ZZZ_UHC_'||EMPID||'_TWIN TWIN
	ON
		UPPER(a.FIRSTNAME) = TWIN.MEMFIRSTNAME
		AND
		UPPER(a.LASTNAME) = TWIN.MEMLASTNAME
		AND
		CASE WHEN a.SEX IN (''F'',''M'') THEN a.SEX ELSE ''U'' END = TWIN.GENDER
		AND
		a.BIRTHDATE = TWIN.DOB
		AND
		nvl(grp.ROLLUPID,a.Customerstructure1) = TWIN.LVL3ID
	';
	END IF;   --ICE_134
	IF EMPID IN ('FIGA') THEN
	vbQuery := vbQuery||'
	LEFT JOIN
		ZZZ_AETNA_ELIG_MEMUPD_FIGA MEM3
	ON
		UPPER(a.FIRSTNAME) = MEM3.MEMFIRSTNAME
		AND
		UPPER(a.LASTNAME) = MEM3.MEMLASTNAME
		AND
		UPPER(CASE WHEN UPPER(a.SEX) IN (''F'',''M'') THEN UPPER(a.SEX) ELSE ''U'' END) = UPPER(MEM3.GENDER)
		AND
		a.BIRTHDATE = MEM3.DOB
		AND
		nvl(grp.ROLLUPID,a.Customerstructure1) = MEM3.LVLID3
		AND
		CASE WHEN a.RELATIONSHIP =''00'' THEN ''E'' WHEN a.RELATIONSHIP IN (''01'',''04'') THEN ''S'' WHEN a.RELATIONSHIP IN (''02'',''27'') THEN ''D'' ELSE ''U'' END = MEM3.RELFLAG
	';
	END IF;
	IF EMPID IN ('ERNS') THEN
	vbQuery := vbQuery||'
	LEFT JOIN
		ZZZ_ARDX_ELIG_MEMUPD_'||EMPID||' MEM2
	ON
		UPPER(a.FIRSTNAME) = MEM2.MEMFIRSTNAME
		AND
		UPPER(a.LASTNAME) = MEM2.MEMLASTNAME
		AND
		CASE WHEN a.SEX IN (''F'',''M'') THEN a.SEX ELSE ''U'' END = MEM2.GENDER
		AND
		a.BIRTHDATE = MEM2.DOB
		AND
		nvl(grp.ROLLUPID,a.Customerstructure1) = MEM2.LVLID3
	';
	END IF;
	vbQuery := vbQuery || '
	WHERE NVL(lv.DROP_PLAN,''N'')=''N''		--ICE #169508
	';

	BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('ELIG-CSTM UHC',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_UHC_036_'||EMPID,'Y','I');    --DEFECT ICE- 4769
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG-CSTM UHC',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
------------------------------------------------------------------------------------------------------------------
	BEGIN
		SP_CDF_TBL_MERGE(USER,'ELIG-MERGE UHC','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_U_COMM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_U_CSTM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_UHC');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG-MERGE UHC',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	END;
	COMMIT;

---------------------------------- Start of Insert of  UHC OR dropped data back ---------------------------------------------------------------

	VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='INSERT INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_UHC';

	BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('UHC ELIG FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_UHC_036_'||EMPID,'Y','I');         --DEFECT ICE- 4769
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('UHC ELIG FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
-------------------------------------------------------------4493 UHC--MI Implementation-------------------------------------------------

--------------------------------------------------------------------------------------------------------------
--ICE_134 : ELIG UHC MEMID/ENRID UPDATE TO CLAIMS AND RX
IF EMPID IN ('ERNS','MEVS') THEN
vbQuery:='CREATE TABLE ZZZ_VH_ELIG_MEMUPD_'||EMPID||'_UHC AS
SELECT * FROM
(SELECT DISTINCT MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3
FROM
(
SELECT /*+PARALLEL(A,4)*/  MEMID, ENRID,  MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ,LVLID3,
			 ROW_NUMBER() OVER (PARTITION BY LVLID3, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ORDER BY EFFDATE ASC NULLS LAST, TERMDATE ASC NULLS LAST) RN
			 FROM  VH_ELIGIBILITIES_'||vLvl.SERIALNO||' A ) WHERE RN=1
			 ) B


WHERE LVLID3 IN (''ERNS'',''MEVS'')';

BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('UHC_ELIG MEMID Update',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_UHC_036_'||EMPID,'Y','I');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('UHC_ELIG MEMID Update',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

END IF;
--------------------------------------------------------------------------------------------------------------

END IF;

---------------------------------------------- UMR implementation starts ---------------------
IF  vLvl.PAYER='UMR' THEN

	---------------------------------------------------------------------------------------------
	--PASS REQUIRED TO GET BEN COV OF DEPENDENTS
	---------------------------------------------------------------------------------------------
	vbQuery:='CREATE TABLE zzz_UMR_BenCov_'||vLvl.SERIALNO||' NOLOGGING AS
		SELECT ENRID,BENCOVTYPEDESC
		FROM
		(
			SELECT
				COALESCE(a.SSN ,''EMPLOYEEID'') AS ENRID ,
				(SELECT cv.ROLLUP_DESC FROM HR_826_COVERAGE cv WHERE ''UMR'' = cv.source AND UPPER(A.COVERAGE)=cv.SRC_CODE) BENCOVTYPEDESC,
				ROW_NUMBER()OVER(PARTITION BY a.SSN ORDER BY a.receivedmonth DESC)rn
			FROM
				HI0826001.HI_ELIG_UMR_'||EMPID||' a
			WHERE
				a.SSN IS NOT NULL AND UPPER(a.DEPENDENT_CODE) = ''E''
		) WHERE rn = 1
		';
	BEGIN EXECUTE IMMEDIATE vbQuery;
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('CREATE zzz_UMR_BenCov',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
	---------------------------------------------------------------------------------------------
	BEGIN EXECUTE IMMEDIATE 'ALTER TABLE zzz_UMR_BenCov_'||vLvl.SERIALNO||' ADD constraint pk_UMR_BenCov_'||vLvl.SERIALNO||' PRIMARY KEY (ENRID)';
	EXCEPTION WHEN OTHERS THEN
	xp_scrubStatusLog ('pk_UMR_BenCov',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
	---------------------------------------------------------------------------------------------
	vbQuery:=
	'
	INSERT  INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
	(
		Source,
		SrcFileName,
		MemID,
		EnrID,
		RelFlag,
		MemFirstName,
		MemLastName,
		Gender,
		DOB,
		Addr1,
		Addr2,
		City,
		State,
		Zip,
		HomePhone,
		WorkPhone,
		EffDate,
		TermDate,
		LVLID1,
		LVLDesc1,
		LVLID2,
		LVLDesc2,
		LVLID3,
		LVLDesc3,
		LVLID4,
		LVLDesc4,
		LVLID5,
		LVLDesc5,
		LVLID6,
		LVLDesc6,
		CMStatus,
		UDF1,
		UDF2,
		UDFC5,
		UDF1_Mem,
		UDF2_Mem,
		RcvMth,
		VHPAYORID,
		covtypeid,
		covtypedesc,
		BENCOVTYPE,
		BENCOVTYPEDESC,
		COVERAGESTATUS ,
		PLANTYPE ,
		PLANNAME,
		SrcRelFlag,
		PRODUCTID, 
		UDFC21 --ICE-17438
	)
	SELECT
		''UMR'' AS Source,
		a.SourceFileName AS SrcFileName,
		COALESCE(SUBSTR(''000''||a.SSN,-9) ||UPPER(a.SEX)|| TO_CHAR(a.BIRTH_DATE,''YYYYMMDD''),''MEMBERID'') AS MemID,
		COALESCE(SUBSTR(''000''||a.SSN,-9),''EMPLOYEEID'') AS ENRID ,
		CASE WHEN UPPER(a.DEPENDENT_CODE) = ''E'' THEN ''E'' WHEN UPPER(a.DEPENDENT_CODE) IN (''S'',''T'',''U'',''V'',''W'',''X'',''Y'',''Z'') THEN ''S'' ELSE ''D'' END  AS RelFlag,
		Upper(a.FIRST_NAME) AS MEMFIRSTNAME,
		Upper(a.LAST_NAME) AS MEMLASTNAME,
		UPPER(a.SEX)AS  Gender,
		a.BIRTH_DATE  AS DOB,
		a.ADDRESS_1 AS ADDR1,
		a.ADDRESS_2 AS ADDR2,
		a.CITY AS CITY,
		a.STATE AS STATE,
		SUBSTR(a.ZIP_CODE,1,5) AS ZIP,
		a.PHONE_NUMBER AS HOMEPHONE,
		NULL AS WorkPhone,
		a.ENR_DEP_ORIGINAL_EFF_DATE  AS EFFDATE,
		NVL(a.ENR_DEP_BENEFIT_END_TERMDATE,TO_DATE(a.RECEIVEDMONTH,''YYYYMM'')-1) AS TermDate,
		''C'' AS LVL1ID,
		''Commercial'' AS LVL1Desc,
		lv.rollup_plan_id AS LVL2ID,
		lv.rollup_plan_desc  AS LVL2Desc,
		nvl(grp.ROLLUPID,a.GROUP_NUMBER) AS LVL3ID,
		nvl(grp.Group_Name,a.GROUP_NUMBER) AS LVL3Desc,
		lv.rollup_loc_id AS LVL4ID,
		lv.rollup_loc_desc AS LVL4Desc,
		NULL AS LVL5ID,
		NULL AS LVL5Desc,
		NULL AS LVL6ID,
		NULL AS LVL6Desc,
		NULL AS CMStatus,
		NULL AS UDF1,
		NULL AS UDF2,
		NULL UDFC5,
		NULL AS UDF1_Mem,
		NULL AS UDF2_Mem,
		a.RECEIVEDMONTH AS RcvMth,
		(SELECT p.PAYORID FROM HR_GLOBAL_PAYORLIST p WHERE TABLENAME=''HI_ELIG_UMR'') AS VHPAYORID,
		''MED'' covtypeid,
		''MEDICAL'' covtypedesc,
		CASE WHEN UPPER(A.COVERAGE)=''E'' THEN ''S'' ELSE ''F'' END BENCOVTYPE,
		NVL(cv.ROLLUP_DESC,bc.BENCOVTYPEDESC) BENCOVTYPEDESC,
		UPPER(a.LOCATION_NAME) COVERAGESTATUS ,
		lv.plantype PLANTYPE ,
		lv.rollup_plan_desc PLANNAME,
		CASE WHEN UPPER(a.DEPENDENT_CODE) = ''E'' THEN ''SELF'' WHEN UPPER(a.DEPENDENT_CODE) IN (''S'',''T'',''U'',''V'',''W'',''X'',''Y'',''Z'') THEN ''SPOUSE'' ELSE ''CHILD'' END SrcRelFlag,
		''1'' AS PRODUCTID, --in hr_global_productLine 1 prodID is mapped as commercial
		a.SSN AS UDFC21 --ICE-17438
	FROM
		HI0826001.HI_ELIG_UMR_'||EMPID||' a
	LEFT JOIN
		zzz_UMR_BenCov_'||vLvl.SERIALNO||' bc
	ON
		a.SSN = bc.ENRID
	LEFT JOIN
		HR_826_COVERAGE cv
	ON
		''UMR'' = cv.source AND UPPER(A.COVERAGE)=cv.SRC_CODE
	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.GROUP_NUMBER = grp.src_code
	JOIN
		HR_826_UMR_LOA lv
	ON
		a.GROUP_NUMBER = lv.SRC_GRP
	AND
		a.PLAN_CODE = lv.SRC_PLAN
	AND
		a.LOCATION = lv.SRC_LOC
	';


	BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('ELIG',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ELIG',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

END IF;
---------------------------------------------- UMR BEF0479 LAYOUT: ELIGIBILITIES ---------------------
IF  vLvl.PAYER='UMR_BEF' THEN

	---------------------------------------------------------------------------------------------
	--To resolve open term date issue ICE#146647
	---------------------------------------------------------------------------------------------
	BEGIN EXECUTE IMMEDIATE 'DROP TABLE zzz_umr_term_'||vLvl.SERIALNO||' PURGE';
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	---------------------------------------------------------------------------------------------
	vbQuery:=
	'CREATE TABLE zzz_umr_term_'||vLvl.SERIALNO||' NOLOGGING AS
	SELECT
		a.EMPE_SSN_NBR||DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')|| TO_CHAR(a.INDIV_BIRTH_DATE,''YYYYMMDD'') AS MEMID,		--MEMID LOGIC MAY VARY FROM CLIENT TO CLIENT
		a.INDIV_INS_EFF_DATE AS EffDate,
		MAX(a.INDIV_INS_EXP_DATE) AS M_TermDate
	FROM HI0826001.HI_ELIG_UMR_BEF_'||EMPID||' a
	WHERE
		a.EMPE_SSN_NBR IS NOT NULL AND a.INDIV_INS_EFF_DATE IS NOT NULL
	GROUP BY
		a.EMPE_SSN_NBR||DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')|| TO_CHAR(a.INDIV_BIRTH_DATE,''YYYYMMDD''),
		a.INDIV_INS_EFF_DATE
	';
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('zzz_umr_term',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
	---------------------------------------------------------------------------------------------
	vbQuery:=
	'ALTER TABLE zzz_umr_term_'||vLvl.SERIALNO||' ADD CONSTRAINT PK_umr_term_'||vLvl.SERIALNO||' PRIMARY KEY (MEMID,EffDate)
	';
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('zzz_umr_term',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

  ---302098
  IF EMPID = 'CSTA' THEN
  BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE zzz_umr_memid_upd_csta PURGE';
  EXCEPTION WHEN OTHERS THEN NULL;
  END;
	---------------------------------------------------------------------------------------------
	vbQuery:=
	'CREATE TABLE zzz_umr_memid_upd_csta NOLOGGING AS
	    SELECT distinct memid, memfirstname, memlastname, gender, dob,lvl3id from ZZZ_MEMID_ANTHEM_CDB a
      where not exists (select 1 from HI0826001.HI_ELIG_CDBT_CSTA b where a.memfirstname = UPPER(b.NAMEFIRST1) and a.memlastname = UPPER(b.NAMELAST1) and a.gender = DECODE(UPPER(b.GENDER),''M'',''M'',''F'',''F'',''U'')
      and a.dob = b.DATEPERIOD_1 )';
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('zzz_umr_memid_upd_csta','CSTA',vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
  END IF;
--------------------------------------------ICE#3966----------------------------------------------------
IF EMPID IN ('LHY', 'EMPI') THEN
BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE ZZZ_ARDX_ELIG_MEMUPD_'||EMPID||' PURGE';
        EXCEPTION WHEN OTHERS THEN NULL;
END;
---------------------------------------------------------------------------------

vbQuery:='
	CREATE TABLE ZZZ_ARDX_ELIG_MEMUPD_'||EMPID||' NOLOGGING PARALLEL 4
    AS
    SELECT
		MEMID,
		ENRID,
		MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		LVLID3
    FROM(
    SELECT /*+PARALLEL (a,4)*/';
    IF EMPID IN ('EMPI') THEN
    vbQuery:= vbQuery || '
    COALESCE(REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~''),''MEMBERID'') AS MemID,
    COALESCE(REPLACE(a.SBSCRBR_ID,''~''),''EMPLOYEEID'') AS ENRID,';
    ELSE
    vbQuery:= vbQuery || '
		a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'')  AS MemID,
    a.SBSCRBR_ID AS ENRID,';
    END IF;
    vbQuery:= vbQuery || '
		UPPER(a.MBR_FIRST_NM) AS MEMFIRSTNAME,
		UPPER(a.MBR_LAST_NM) AS MEMLASTNAME,
		CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END AS  Gender,
		a.MBR_BRTH_DT  AS DOB,
		nvl(grp.ROLLUPID,a.ACCT_NBR) AS LVLID3,
    Row_Number() OVER (PARTITION BY UPPER(a.MBR_FIRST_NM),
    UPPER(a.MBR_LAST_NM),CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END,a.MBR_BRTH_DT,nvl(grp.ROLLUPID,a.ACCT_NBR)
    ORDER BY a.MBR_EFCTV_DT ASC nulls last,
    CASE WHEN a.mbr_term_dt > To_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') THEN
		to_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') ELSE a.mbr_term_dt END ASC nulls last ) rn
	FROM
		HI0826001.HI_ELIG_ANTHEM_'||EMPID||' a
	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.ACCT_NBR = grp.src_code
    )
    WHERE rn=1';
 -------------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ZZZ_ARDX_ELIG_MEMUPD_'||EMPID||'-CREATED',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	 END;
	 COMMIT;

END IF;

IF EMPID IN ('EMPI') THEN
---------------------------------------------------------------------------------
vbQuery:='
	INSERT INTO ZZZ_ARDX_ELIG_MEMUPD_'||EMPID||'
    SELECT
		MEMID,
		ENRID,
		MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		LVLID3
    FROM
    (
    SELECT /*+PARALLEL (a,4)*/
		COALESCE(REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~''),''MEMBERID'') AS MemID,
    COALESCE(REPLACE(a.SBSCRBR_ID,''~''),''EMPLOYEEID'') AS ENRID,
		UPPER(a.MBR_FIRST_NM) AS MEMFIRSTNAME,
		UPPER(a.MBR_LAST_NM) AS MEMLASTNAME,
		CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END AS  Gender,
		a.MBR_BRTH_DT  AS DOB,
		CASE WHEN nvl(grp.ROLLUPID,a.ACCT_NBR) =''MPFS''  THEN ''EMPI'' ELSE nvl(grp.ROLLUPID,a.ACCT_NBR) END AS LVLID3, --ICE  11873, MPFS group changed to EMPI so that Memeber update from MPFS can be done in consolidated group EMPI
    Row_Number() OVER (PARTITION BY UPPER(a.MBR_FIRST_NM),
    UPPER(a.MBR_LAST_NM),CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END,a.MBR_BRTH_DT,nvl(grp.ROLLUPID,a.ACCT_NBR)
    ORDER BY a.MBR_EFCTV_DT ASC nulls last,
    CASE WHEN a.mbr_term_dt > To_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') THEN
		to_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') ELSE a.mbr_term_dt END ASC nulls last ) rn
	FROM
		HI0826001.HI_ELIG_ANTHEM_MPFS a
	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.ACCT_NBR = grp.src_code
    )      b
    WHERE rn=1
   AND
    NOT EXISTS (SELECT /*+PARALLEL (a,4)*/ 1 FROM ZZZ_ARDX_ELIG_MEMUPD_'||EMPID||' c      where c.MEMFIRSTNAME = B.MEMFIRSTNAME AND c.MEMLASTNAME = b.MEMLASTNAME AND c.DOB = b.DOB AND c.GENDER = b.GENDER AND C.LVLID3 = B.LVLID3)

';
 -------------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ZZZ_ARDX_ELIG_MEMUPD_'||EMPID||'-CREATED',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	 END;
	 COMMIT;

END IF;
---------------------------------------ICE 646------------------------------------------------------
IF EMPID IN ('WSPI') THEN

BEGIN EXECUTE IMMEDIATE 'DROP TABLE ZZZ_UMR_BEF_MEMUPD_WSPI PURGE';
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
---------------------------------------------------------------------------------------------
	vbQuery:=
	'CREATE TABLE ZZZ_UMR_BEF_MEMUPD_WSPI NOLOGGING AS
	SELECT
		MEMID,
		ENRID,
		MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		LVLID3
	FROM (
		SELECT
			a.EMPE_SSN_NBR||DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')|| TO_CHAR(a.INDIV_BIRTH_DATE,''YYYYMMDD'') AS MEMID,
			a.EMPE_SSN_NBR	AS	ENRID,
			UPPER(a.INDIV_1ST_NAME_TEXT) AS MEMFIRSTNAME,
			UPPER(a.INDIV_LAST_NAME_TEXT) AS MEMLASTNAME,
			DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'') AS GENDER,
			a.INDIV_BIRTH_DATE AS DOB,
			grp.ROLLUPID AS LVLID3,
			row_number() over (partition by UPPER(a.INDIV_1ST_NAME_TEXT),
			UPPER(a.INDIV_LAST_NAME_TEXT),DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U''),a.INDIV_BIRTH_DATE,grp.ROLLUPID
			order by a.INDIV_INS_EFF_DATE desc,A.RECEIVEDMONTH DESC) rn
		FROM
			HI0826001.HI_ELIG_UMR_BEF_'||EMPID||' a
		LEFT JOIN
			HR_826_GROUP grp
		ON
			a.GROUP_ID_NUMBER = grp.SRC_CODE
		WHERE
			Nvl(grp.ROLLUPID,a.GROUP_ID_NUMBER)='''||EMPID||'''
		)
	WHERE RN=1
	';
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	COMMIT;
END IF;

---------------------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE 'DROP TABLE ZZZ_ELIG_UMR_BEF_MEMID_WSPI PURGE';
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
---------------------------------------------------------------------------------------------
vbQuery:= 'CREATE TABLE ZZZ_ELIG_UMR_BEF_MEMID_WSPI NOLOGGING PARALLEL 4
    as
    SELECT memid,enrid,memfirstname,memlastname,gender,dob,LVLID3
    FROM(
    SELECT
		NVL(MEM1.MEMID,a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'')) AS MEMID,
		NVL(MEM1.ENRID,a.SBSCRBR_ID) AS	ENRID,
		UPPER(a.MBR_FIRST_NM) AS MEMFIRSTNAME,
		UPPER(a.MBR_LAST_NM)  AS MEMLASTNAME,
		CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END AS GENDER,
		a.MBR_BRTH_DT AS DOB,
		nvl(grp.ROLLUPID,a.ACCT_NBR) AS LVLID3,
    Row_Number() OVER (PARTITION BY UPPER(a.MBR_FIRST_NM),UPPER(a.MBR_LAST_NM),CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END,a.MBR_BRTH_DT,nvl(grp.ROLLUPID,a.ACCT_NBR)
    ORDER BY a.MBR_EFCTV_DT desc nulls last ,
	CASE WHEN a.mbr_term_dt > To_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') THEN
		to_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') ELSE a.mbr_term_dt END	 desc nulls last) rn
	FROM
		hi0826001.HI_ELIG_ANTHEM_WSPI a
		LEFT JOIN
		HR_826_GROUP grp
	ON
		a.ACCT_NBR = grp.src_code
		LEFT JOIN
		ZZZ_UMR_BEF_MEMUPD_WSPI MEM1
	ON
		UPPER(a.MBR_FIRST_NM) = MEM1.MEMFIRSTNAME
	AND
		UPPER(a.MBR_LAST_NM) = MEM1.MEMLASTNAME
	AND
		CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END = MEM1.GENDER
	AND
		a.MBR_BRTH_DT = MEM1.DOB
	AND 	--271895
		nvl(grp.ROLLUPID,a.ACCT_NBR) = MEM1.LVLID3
    )
    WHERE rn=1';
BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	COMMIT;

--------------------------------------------ICE 646-------------------------------------------------
-------------------------------------------ICE 5770 STARTS(CREATING TEMP TABLE TO UPDATE THE MEMBERS FROM MERITAIN)----------------------------------------------------
IF EMPID IN ('ALTM') THEN
BEGIN EXECUTE IMMEDIATE 'DROP table ZZZ_COVERAGES_'||EMPID||' purge'; EXCEPTION WHEN OTHERS THEN NULL; END;


EXECUTE IMMEDIATE 'CREATE TABLE ZZZ_COVERAGES_'||EMPID||' NOLOGGING AS
SELECT
	INSURED_ID,SOURCEFILENAME,MED_COV_CODE,DEN_COV_CODE, VIS_COV_CODE,RECEIVEDMONTH
FROM
	HI0826001.HI_ELIG_MERITAIN_'||EMPID||' WHERE RECORD_TYPE = ''01''
GROUP BY
	INSURED_ID,SOURCEFILENAME,MED_COV_CODE,DEN_COV_CODE, VIS_COV_CODE,RECEIVEDMONTH';

	EXECUTE IMMEDIATE 'ALTER TABLE ZZZ_COVERAGES_'||EMPID||'  ADD PRIMARY KEY(INSURED_ID,SOURCEFILENAME,RECEIVEDMONTH)';

BEGIN

FOR TBL IN
(
	SELECT 'MED_COV_CODE' AS COVERAGE,'MED_EFFECTIVE' AS COVERAGE_EFF,'MED_TERMINATION' AS COVERAGE_TERM,'MED' AS COVTYPEID,'MEDICAL' AS COVTYPEDESC FROM dual
	UNION ALL
	SELECT 'DEN_COV_CODE' AS COVERAGE,'DEN_EFFECTIVE' AS COVERAGE_EFF,'DEN_TERMINATION' AS COVERAGE_TERM,'DEN' AS COVTYPEID ,'DENTAL' AS COVTYPEDESC FROM dual
	UNION ALL
	SELECT 'VIS_COV_CODE' AS COVERAGE,'VIS_EFFECTIVE' AS COVERAGE_EFF,'VIS_TERMINATION' AS COVERAGE_TERM,'VIS' AS COVTYPEID ,'VISION' AS COVTYPEDESC FROM dual
)

LOOP

BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE ZZZ_MRTN_MEMUPD_'||EMPID||' PURGE';
        EXCEPTION WHEN OTHERS THEN NULL;
END;
---------------------------------------------------------------------------------

vbQuery:='
	CREATE /*+PARALLEL(A,4)*/ TABLE ZZZ_MRTN_MEMUPD_'||EMPID||'
			AS
			SELECT MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3,LVLDESC3, EFFDATE,TERMDATE
			FROM (
			SELECT /*+PARALLEL(A,4)*/
			NVL(a.INSURED_ID||DECODE(UPPER(a.GENDER),''M'',''M'',''F'',''F'',''U'')|| TO_CHAR(a.DATE_OF_BIRTH ,''YYYYMMDD''),''MEMBERID'')  AS MEMID,
			NVL(a.INSURED_ID,''EMPLOYEEID'') AS ENRID,
			UPPER(NVL(SUBSTR(a.FIRST_AND_MIDDLE,1,INSTR(a.FIRST_AND_MIDDLE,'' '')-1),A.FIRST_AND_MIDDLE)) AS MEMFIRSTNAME,
			UPPER(a.LAST_NAME) AS MEMLASTNAME,
			CASE WHEN UPPER(a.GENDER) IN (''M'',''F'') THEN UPPER(a.GENDER) ELSE ''U'' END AS GENDER,
			TRUNC(a.DATE_OF_BIRTH) AS DOB,
			NVL(lvl3.rollupid,a.group1) LVLID3,
		    NVL(lvl3.GROUP_NAME,a.group1)  AS LVLDESC3,
			CASE WHEN NVL('||TBL.COVERAGE_EFF||',TO_DATE(''9999-12-31'',''YYYY-MM-DD'')) <= fldt.FILESTARTDATE THEN fldt.FILESTARTDATE ELSE '||TBL.COVERAGE_EFF||' END  AS EFFDATE,
            CASE WHEN
             CASE WHEN NVL('||TBL.COVERAGE_TERM||',TO_DATE(''9999-12-31'',''YYYY-MM-DD''))>=fldt.FILEENDDATE THEN Last_day(fldt.FILEENDDATE) ELSE NVL('||TBL.COVERAGE_TERM||',TO_DATE(''9999-12-31'',''YYYY-MM-DD'')) END  >=  TO_DATE(''2018-12-31'',''YYYY-MM-DD'')
            THEN TO_DATE(''2018-12-31'',''YYYY-MM-DD'')
             ELSE
            CASE WHEN NVL('||TBL.COVERAGE_TERM||',TO_DATE(''9999-12-31'',''YYYY-MM-DD''))>=fldt.FILEENDDATE THEN Last_day(fldt.FILEENDDATE) ELSE '||TBL.COVERAGE_TERM||' END  END
            AS termdate,
			 ROW_NUMBER() OVER (PARTITION BY NVL(a.INSURED_ID||DECODE(UPPER(a.GENDER),''M'',''M'',''F'',''F'',''U'')|| TO_CHAR(a.DATE_OF_BIRTH ,''YYYYMMDD''),''MEMBERID''), NVL(lvl3.rollupid,a.group1)  ORDER BY 9 NULLS LAST, 10 NULLS LAST) RN
			 FROM HI0826001.HI_ELIG_MERITAIN_'||EMPID||'  A
			 LEFT JOIN
             ZZZ_COVERAGES_'||EMPID||' B
	         ON
		     A.INSURED_ID = B.INSURED_ID
	         AND
		     A.SOURCEFILENAME = B.SOURCEFILENAME
	         AND
		     A.RECEIVEDMONTH = B.RECEIVEDMONTH
			 LEFT JOIN
		     HR_826_FILEDATE_MRTN_STD fldt
	         ON
		     A.RECEIVEDMONTH = fldt.RECEIVEDMONTH
	         AND
		     A.SOURCEFILENAME = fldt.SRCFILENAME
	         AND
		     UPPER(fldt.PAYER) = ''MERITAIN_STD''
              left join
		     HR_826_GROUP lvl3
		     on
		    substr(a.group1,1,5) = lvl3.SRC_CODE
			)
			 WHERE RN=1
			 '
			 ;
 -------------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ZZZ_MRTN_MEMUPD-CREATED',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	 END;
	 COMMIT;
END LOOP;
END ;
COMMIT;
END IF;
------MEMBER UPDATE FROM UMR ELIG ENDS BY MATCHING SSN,GENDER,DOB AND LVLID2(ICE 5770)------------------------------



--------------------------------------------ICE 5770 ENDS----------------------------------------------------




	------------------------------------------------------ELIG UMR_BEF 341 --MI Implementation-----------------------------------------------------------------

	VBQUERY := 'DROP TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM PURGE';
		BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM AS
	SELECT
		SOURCE,
		MEMID,
		ENRID,
		EFFDATE,
		TERMDATE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		BENCOVTYPE,
		BENCOVTYPEDESC,
		PLANTYPE,
		PLANNAME,
		PRODUCTID,
		COVERAGESTATUS,
		UDFC4,
		UDFC5, ---ICE 5770
		SRCRELFLAG,
		UDFC21 --ICE-17438
	FROM
		VH_ELIGIBILITIES
	WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG TABLE CREATE UMR_BEF',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTM_ELIG_UMRBEF_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	BEGIN
		SP_PYR_341_ELIG_UMR('HI0826001','HI_ELIG_UMR_BEF_'||EMPID||'','ELIG','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_COMM');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG-COMM UMR_BEF',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_341_ELIG_UMR','','E');
	END;
	COMMIT;
----------------------------------------------------------------------------------------------------------

	vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		EFFDATE,
		TERMDATE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		BENCOVTYPE,
		BENCOVTYPEDESC,
		PLANTYPE,
		PLANNAME,
		PRODUCTID,
		COVERAGESTATUS,
		UDFC4,
		UDFC5,        --ICE 5770
		SRCRELFLAG,
		UDFC21 --ICE-17438
	)
	SELECT
		a.ROWID AS SRCROWID,
		''UMR'' AS SOURCE, ';
		IF EMPID = 'CSTA' THEN
		vbQuery:= vbQuery||'
			NVL(MEM.MEMID,a.EMPE_SSN_NBR||DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')|| TO_CHAR(a.INDIV_BIRTH_DATE,''YYYYMMDD'')||''-''||grp.ROLLUPID) AS MEMID,  --302098
			NVL(MEM.ENRID,a.EMPE_SSN_NBR||''-''||grp.ROLLUPID)  AS	ENRID, ';      --302098
		ELSIF EMPID = 'WSPI' THEN	--ICE-646
		vbQuery:= vbQuery||'
			NVL(MEM1.MEMID,a.EMPE_SSN_NBR||DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')|| TO_CHAR(a.INDIV_BIRTH_DATE,''YYYYMMDD'')) AS MEMID,
			NVL(MEM1.ENRID,a.EMPE_SSN_NBR)  AS	ENRID, ';
		ELSIF EMPID IN ('LHY','EMPI') THEN	--ICE-3966
		vbQuery:= vbQuery||'
			NVL(MEM2.MEMID,a.EMPE_SSN_NBR||DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')|| TO_CHAR(a.INDIV_BIRTH_DATE,''YYYYMMDD'')) AS MEMID,
			NVL(MEM2.ENRID,a.EMPE_SSN_NBR)  AS	ENRID, ';
        ELSIF EMPID IN ('ALTM') THEN	--ICE-5770
		vbQuery:= vbQuery||'
	NVL(MEM3.MEMID,a.EMPE_SSN_NBR||DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')||TO_CHAR(a.INDIV_BIRTH_DATE,''YYYYMMDD'')||''-''||grp.ROLLUPID) AS MEMID,
			NVL(MEM3.ENRID,a.EMPE_SSN_NBR||''-''||grp.ROLLUPID)  AS	ENRID, ';
		ELSE
		vbQuery:= vbQuery||'
		NVL(ARDX.MEMID,
        CASE WHEN grp.MEMID_GRP_FLAG = ''Y'' THEN a.EMPE_SSN_NBR||DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')|| TO_CHAR(a.INDIV_BIRTH_DATE,''YYYYMMDD'')||''-''||grp.ROLLUPID
        ELSE a.EMPE_SSN_NBR||DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')|| TO_CHAR(a.INDIV_BIRTH_DATE,''YYYYMMDD'') END ) AS MEMID,		--MEMID LOGIC MAY VARY FROM CLIENT TO CLIENT
		NVL(ARDX.ENRID, CASE WHEN grp.MEMID_GRP_FLAG = ''Y'' THEN a.EMPE_SSN_NBR||''-''||grp.ROLLUPID ELSE a.EMPE_SSN_NBR END)	AS	ENRID, ';   --ENRID LOGIC MAY VARY FROM CLIENT TO CLIENT
		END IF;
		vbQuery:= vbQuery||'
		CASE
			WHEN Nvl(grp.ROLLUPID,a.GROUP_ID_NUMBER) = ''DUCH'' AND COALESCE(a.INDIV_INS_EFF_DATE,TO_DATE(''01/01/0001'',''MM/DD/YYYY'')) < TERM.FILESTARTDATE THEN TERM.FILESTARTDATE  --Defect#361033 --DEFECT#355283
			ELSE a.INDIV_INS_EFF_DATE
		  END AS EFFDATE,
		CASE
			WHEN Nvl(grp.ROLLUPID,a.GROUP_ID_NUMBER) IN (''ACKT'') AND to_char(COALESCE(a.INDIV_INS_EXP_DATE,trm.M_TermDate,TO_DATE(a.RECEIVEDMONTH,''YYYYMM'')-1),''YYYYMMDD'') > ''20161231'' THEN To_Date(''20161231'',''YYYYMMDD'')  --275048,323306
			WHEN Nvl(grp.ROLLUPID,a.GROUP_ID_NUMBER) = ''UCH'' AND COALESCE(a.INDIV_INS_EXP_DATE,trm.M_TermDate,TO_DATE(a.RECEIVEDMONTH,''YYYYMM'')-1) > To_Date(''20160831'',''yyyymmdd'') THEN To_Date(''20160831'',''yyyymmdd'')
			WHEN COALESCE(a.INDIV_INS_EXP_DATE,TO_DATE(''12/31/9999'',''MM/DD/YYYY'')) > TERM.FILEENDDATE THEN TERM.FILEENDDATE   	--DEFECT#355283  --ICE-13785
			ELSE COALESCE(a.INDIV_INS_EXP_DATE,TO_DATE(a.RECEIVEDMONTH,''YYYYMM'')-1) --ICE-13785
		  END AS TERMDATE,         ---ice236314   ICE240479
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		CASE WHEN grp.ROLLUPID = ''ALTM'' THEN Nvl(lvl24.ROLLUP_ID2, a.GROUP_ID_NUMBER||a.STAT_CLASS_CODE)
        ELSE COALESCE(t.ROLLUP_ID, lvl.ROLLUP_CLASS,a.GROUP_ID_NUMBER||a.STAT_CLASS_CODE) END AS LVLID2,   ---ICE 5770	--ice-16180
		CASE WHEN grp.ROLLUPID = ''ALTM'' THEN Nvl(lvl24.ROLLUP_DESC2, a.GROUP_ID_NUMBER||a.STAT_CLASS_CODE)
        ELSE COALESCE(t.ROLLUP_DESC, lvl.CLASS_DESCRIPTION,a.GROUP_ID_NUMBER||a.STAT_CLASS_CODE) END AS LVLDESC2, --ICE 5770	--ice-16180
		Nvl(grp.ROLLUPID,a.GROUP_ID_NUMBER) AS LVLID3,
		Nvl(grp.GROUP_NAME,a.GROUP_ID_NUMBER) AS LVLDESC3,
		CASE WHEN grp.ROLLUPID = ''ALTM'' THEN Nvl(lvl24.ROLLUP_ID4, a.GROUP_ID_NUMBER||a.STAT_CLASS_CODE) ELSE loc.ROLLUP_LOCATION END AS LVLID4,  --ICE 5770
		CASE WHEN grp.ROLLUPID = ''ALTM'' THEN Nvl(lvl24.ROLLUP_DESC4, a.GROUP_ID_NUMBER||a.STAT_CLASS_CODE) ELSE loc.LOCATION_DESCRIPTION END AS LVLDESC4, --ICE 5770
		CASE WHEN UPPER(A.POL_COV_APPL_IND)=''1'' THEN ''S'' ELSE ''F'' END BENCOVTYPE ,
		ben.ROLLUP_DESC AS BENCOVTYPEDESC,
		COALESCE(t.PLANTYPE ,lvl.PLANTYPE,''PPO'') AS PLANTYPE,
		CASE WHEN grp.ROLLUPID = ''ALTM'' THEN lvl24.ROLLUP_DESC2 ELSE COALESCE(t.ROLLUP_DESC, lvl.CLASS_DESCRIPTION) END AS PLANNAME, --ICE 5770
		''1'' AS PRODUCTID,
		CASE
			WHEN SubStr(UPPER(a.STAT_CLASS_CODE),1,1)=''A'' THEN ''ACTIVE''
			WHEN SubStr(UPPER(a.STAT_CLASS_CODE),1,1)=''C'' THEN ''COBRA''
			WHEN SubStr(UPPER(a.STAT_CLASS_CODE),1,1)=''R'' THEN ''RETIREE''
			WHEN lvl.groupid=''76410079'' THEN Nvl(lvl.coverageStatus,''ACTIVE'')
			ELSE ''ACTIVE''
		  END AS COVERAGESTATUS, --- logic modified for new group Aurora Casket as per ICE 151256
		a.INDIV_SEQ_NBR AS UDFC4, --- ICE 312761
		a.EMPE_SSN_NBR||DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')||TO_CHAR(a.INDIV_BIRTH_DATE,''YYYYMMDD'')||''-''||grp.ROLLUPID as UDFC5, --ICE 5770
		b.ROLLUP_DESC AS SRCRELFLAG,
		a.EMPE_SSN_NBR AS UDFC21 --ICE-17438
	FROM
		HI0826001.HI_ELIG_UMR_BEF_'||EMPID||' a

	LEFT JOIN
		zzz_umr_term_'||vLvl.SERIALNO||' trm
	ON
		a.EMPE_SSN_NBR||DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')|| TO_CHAR(a.INDIV_BIRTH_DATE,''YYYYMMDD'') = trm.MEMID
		AND
		a.INDIV_INS_EFF_DATE = trm.EffDate

	LEFT JOIN
		HR_826_REL b
	ON
		a.DPNT_CUR_STATUS_CDE = b.SRC_CODE AND ''UMR_BEF'' = b.SOURCE

	LEFT JOIN
		HR_826_COVERAGE ben
	ON
		a.POL_COV_APPL_IND = ben.SRC_CODE AND ''UMR_BEF'' = ben.SOURCE

	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.GROUP_ID_NUMBER = grp.SRC_CODE

	LEFT JOIN
		HR_826_UMR_NEW_LOA lvl
	ON
		a.GROUP_ID_NUMBER = lvl.GROUPID
		AND
		a.policy_id_number = lvl.PLAN_CONTRACT
		AND
		a.STAT_CLASS_CODE = lvl.CLASS

	LEFT JOIN
		HR_826_UMR_NEW_LOC loc
	ON
		a.GROUP_ID_NUMBER = loc.GROUPID
		AND
		a.GRP_LOCATION_CODE = loc.LOCATION

	LEFT JOIN
		HR_826_LOA_LVL_ROLLUP t
	ON
		a.GROUP_ID_NUMBER  = t.groupid
		AND
		Upper(a.STAT_CLASS_CODE) = Upper(t.PLANCODE)
		AND
		To_Char(a.INDIV_INS_EFF_DATE,''YYYY'') = To_Char(t.effectivedate,''YYYY'')

	LEFT JOIN   ---ICE 5770
	HR_826_UMR_LVL lvl24
    ON
	    a.GROUP_ID_NUMBER = lvl24.SRC_GROUPID
	    AND
	    a.policy_id_number = lvl24.PLAN_CONTRACT
	    AND
	    a.STAT_CLASS_CODE = lvl24.CLASS
	LEFT JOIN
		ZZZ_ELIG_ARDX_CIST ARDX
	ON
		UPPER(a.INDIV_1ST_NAME_TEXT) = ARDX.MEMFIRSTNAME
		AND
		UPPER(a.INDIV_LAST_NAME_TEXT) = ARDX.MEMLASTNAME
		AND
		DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'') = ARDX.GENDER
		AND
		a.INDIV_BIRTH_DATE=ARDX.DOB
		AND
		Nvl(grp.ROLLUPID,a.GROUP_ID_NUMBER)= ARDX.LVLID3 --ICE 287515

	LEFT JOIN 	--DEFECT#355283     ICE-10266
		HR_826_FILEDATE_UMR_BEF TERM
	ON
		UPPER(A.SOURCEFILENAME) = TERM.SRCFILENAME
		AND
		A.RECEIVEDMONTH = TERM.RECEIVEDMONTH
    AND
    Nvl(grp.ROLLUPID,a.GROUP_ID_NUMBER) = TERM.EMPGROUPID';

	IF EMPID = 'CSTA' THEN
	vbquery := vbquery || '
	LEFT JOIN
		ZZZ_MEMID_ANTHEM_CDB MEM            --302098
	ON
		UPPER(a.INDIV_1ST_NAME_TEXT) = MEM.MEMFIRSTNAME
		AND
		UPPER(a.INDIV_LAST_NAME_TEXT) = MEM.MEMLASTNAME
		AND
		DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'') = MEM.GENDER
		AND
		a.INDIV_BIRTH_DATE = MEM.DOB
		AND
		Nvl(grp.ROLLUPID,a.GROUP_ID_NUMBER) = MEM.LVL3ID ';
	END IF;

	IF EMPID IN ('WSPI') THEN	--ICE-646
	vbQuery := vbQuery||'
	LEFT JOIN
		ZZZ_ELIG_UMR_BEF_MEMID_WSPI MEM1
	ON
		UPPER(a.INDIV_1ST_NAME_TEXT) = MEM1.MEMFIRSTNAME
		AND
		UPPER(a.INDIV_LAST_NAME_TEXT) = MEM1.MEMLASTNAME
		AND
		DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'') = MEM1.GENDER
		AND
		a.INDIV_BIRTH_DATE = MEM1.DOB
		AND
		Nvl(grp.ROLLUPID,a.GROUP_ID_NUMBER) = MEM1.LVLID3 ';
	END IF;

	IF EMPID IN ('LHY','EMPI') THEN	--ICE-3966
	vbQuery := vbQuery||'
	LEFT JOIN
		ZZZ_ARDX_ELIG_MEMUPD_'||EMPID||' MEM2
	ON
		UPPER(a.INDIV_1ST_NAME_TEXT) = MEM2.MEMFIRSTNAME
		AND
		UPPER(a.INDIV_LAST_NAME_TEXT) = MEM2.MEMLASTNAME
		AND
		DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'') = MEM2.GENDER
		AND
		a.INDIV_BIRTH_DATE = MEM2.DOB
		AND
		Nvl(grp.ROLLUPID,a.GROUP_ID_NUMBER) = MEM2.LVLID3 ';
	END IF;
	IF EMPID IN ('ALTM') THEN	--ICE-5770
	vbQuery := vbQuery||'
	LEFT JOIN
		ZZZ_MRTN_MEMUPD_'||EMPID||' MEM3
	ON
		MEM3.MEMID||''-''||MEM3.LVLID3=a.EMPE_SSN_NBR||DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')|| TO_CHAR(a.INDIV_BIRTH_DATE,''YYYYMMDD'')||''-''||grp.ROLLUPID
		 ';
	END IF;

	BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('ELIG-CSTM UMR_BEF',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG-CSTM UMR_BEF',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
------------------------------------------------------------------------------------------------------------------
	BEGIN
		SP_CDF_TBL_MERGE(USER,'ELIG-MERGE UMR_BEF','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_COMM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_UMRBEF');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG-MERGE UMR_BEF',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	END;
	COMMIT;

---------------------------------- Start of Insert of UMR OR dropped data back ---------------------------------------------------------------

	VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='INSERT INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_UMRBEF';

	BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('UMR_BEF ELIG FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('UMR_BEF ELIG FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
-------------------------------------------------------ELIG UMR_BEF 341 ---MI Implementation---------------------------------------------------------------

--- To handle twin case for Fort Recovery Industries, Inc. ICE 312764,5770,6085,8079, 10249---------ICE-17029--ICE-18918,18917----------------

IF EMPID IN ('FRII','HENG', 'DUCH','DIAV','LHY','COFL','ALTM','CORM','ARST', 'TPME', 'EMPI' , 'PMPT','STUT','ACTL') THEN
vbquery:='DROP TABLE ZZZ_ELIG_UMR_TWINS_'||EMPID||' PURGE';
BEGIN
EXECUTE IMMEDIATE vbQuery;
EXCEPTION WHEN OTHERS THEN NULL;
END;

vbQuery:='CREATE TABLE ZZZ_ELIG_UMR_TWINS_'||EMPID||' NOLOGGING
AS
SELECT /*+PARALLEL(A,4)*/ DISTINCT MEMID
FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||' A
WHERE LVLID3 IN (''FRII'',''HENG'', ''DUCH'',''DIAV'',''00172422'',''COFL'',''ALTM'',''CORM'',''ARST'',''TPME'', ''EMPI'', ''PMPT'',''STUT'',''ACTL'') 	--ICE#3966,5266,5770,6085, 8079--ICE-18918,18917
GROUP BY MEMID
HAVING Count(DISTINCT MEMFIRSTNAME)>1 AND Count(DISTINCT UDFC4)>1';

BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('ELIG TWINS',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ELIG TWINS',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;


vbquery:='DROP TABLE ZZZ_ELIG_UMR_TWINS_UPD_'||EMPID||' PURGE';
BEGIN
EXECUTE IMMEDIATE vbQuery;
EXCEPTION WHEN OTHERS THEN NULL;
END;

--- temp table After twin Case handled  ICE: 312761,312760,5266,5770 ,6085, 8079, 10249--ICE-18918,18917

vbQuery:='CREATE TABLE ZZZ_ELIG_UMR_TWINS_UPD_'||EMPID||' NOLOGGING AS
SELECT * FROM (
SELECT  /*+PARALLEL(A,4)*/ LVLID3,MEMID,MEMFIRSTNAME,MEMLASTNAME,DOB,GENDER,SUBSTR(MEMID||UDFC4,1,50) NEWMEMID,
					ROW_NUMBER() OVER (PARTITION BY LVLID3,MEMFIRSTNAME,MEMLASTNAME,DOB,GENDER ORDER BY EFFDATE NULLS LAST, UDFC4) RN
		FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||' A
		WHERE LVLID3 in (''FRII'',''HENG'', ''DUCH'',''DIAV'',''00172422'',''COFL'',''ALTM'',''CORM'',''ARST'',''TPME'',''EMPI'',''PMPT'',''STUT'',''ACTL'')
		AND EXISTS(
			SELECT 1 FROM ZZZ_ELIG_UMR_TWINS_'||EMPID||' B
			WHERE A.MEMID=B.MEMID
					)
		) WHERE RN=1';

BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('ELIG TWINS UPD',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ELIG TWINS UPD',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

 vbQuery:='MERGE INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  a
	USING
		ZZZ_ELIG_UMR_TWINS_UPD_'||EMPID||' b
	ON
	(
		a.MemFirstName = b.MemFirstName AND
		a.MemLastName = b.MemLastName AND
		a.Gender = b.Gender AND
		a.DOB = b.DOB
		AND
		a.LVLID3=b.LVLID3
	)
	WHEN MATCHED THEN UPDATE
	SET
	a.MemID=b.NEWMEMID';


BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('ELIG TWINS MERGE',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ELIG TWINS MERGE',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;


vbQuery:='UPDATE VH_ELIGIBILITIES_'||vLvl.SERIALNO||' SET UDFC4=''''';

BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('ELIG',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ELIG',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
END IF;

--- TWIN case handled Completed ICE 312761,312760--------
------MEMBER UPDATE FROM UMR ELIG STARTS BY MATCHING SSN,GENDER,DOB AND LVLID2(ICE 5770)------------------------------
IF EMPID IN ('ALTM') THEN
BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE zzz_eligupd_'||vLvl.SERIALNO||' PURGE';
        EXCEPTION WHEN OTHERS THEN NULL;
END;
---------------------------------------------------------------------------------

vbQuery:='
	CREATE /*+PARALLEL(A,4)*/ TABLE zzz_eligupd_'||vLvl.SERIALNO||'
			AS
			SELECT MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3, UDFC5,EFFDATE,TERMDATE
			FROM
			(
			 SELECT /*+PARALLEL(A,4)*/  MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3, UDFC5,EFFDATE ,TERMDATE,
			 ROW_NUMBER() OVER (PARTITION BY UDFC5 ORDER BY EFFDATE NULLS LAST, TERMDATE NULLS LAST) RN
			 FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||' A
			 where source=''UMR''
			)
			 WHERE RN=1
			 '
			 ;
 -------------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ZZZ_MRTN_MEMUPD-CREATED',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	 END;
	 COMMIT;
     vbQuery:='UPDATE VH_ELIGIBILITIES_'||vLvl.SERIALNO||' SET UDFC5=''''';

    BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('ELIGUPD',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ELIGUPD',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
END IF;


------------------------------------------------------ICE 5770 ENDS --------------------------------------------------
END IF;

---------------------------------------START-275048-----------------------------------------------------

IF  vLvl.PAYER='BAS' THEN

BEGIN EXECUTE IMMEDIATE 'DROP TABLE zzz_elig_umr_'||vLvl.SERIALNO||' PURGE';
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
---------------------------------------------------------------------------------------------
	vbQuery:=
	'CREATE TABLE zzz_elig_umr_'||vLvl.SERIALNO||' NOLOGGING AS
	SELECT
		MEMID,
		ENRID,
		MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		LVLID3
	FROM (
		SELECT
			a.EMPE_SSN_NBR||DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')|| TO_CHAR(a.INDIV_BIRTH_DATE,''YYYYMMDD'') AS MEMID,
			a.EMPE_SSN_NBR	AS	ENRID,
			UPPER(a.INDIV_1ST_NAME_TEXT) AS MEMFIRSTNAME,
			UPPER(a.INDIV_LAST_NAME_TEXT) AS MEMLASTNAME,
			DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'') AS GENDER,
			a.INDIV_BIRTH_DATE AS DOB,
			Nvl(grp.ROLLUPID,a.GROUP_ID_NUMBER) AS LVLID3,
			row_number() over (partition by UPPER(a.INDIV_1ST_NAME_TEXT), UPPER(a.INDIV_LAST_NAME_TEXT),DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U''),a.INDIV_BIRTH_DATE order by a.INDIV_INS_EFF_DATE desc,A.RECEIVEDMONTH DESC) rn
		FROM
			HI0826001.HI_ELIG_UMR_BEF_'||EMPID||' a
		LEFT JOIN
			HR_826_GROUP grp
		ON
			a.GROUP_ID_NUMBER = grp.SRC_CODE
		WHERE
			Nvl(grp.ROLLUPID,a.GROUP_ID_NUMBER)='''||EMPID||'''
		)
	WHERE RN=1
	';
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	COMMIT;
---------------------------------------------------------------------------------------------


 VBQUERY := 'DROP TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM AS
							  SELECT
								SOURCE,
								MEMID,
								ENRID,
								EFFDATE,
								TERMDATE,
								LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								LVLID4,
								LVLDESC4,
								PRODUCTID,
								PLANTYPE,
								PLANNAME,
								UDFC21 --ICE-17438
						   FROM
								VH_ELIGIBILITIES
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('ELIG TABLE CREATE BAS',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTM_ELIG_BAS_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_4794_ELIG_BAS('HI0826001','HI_ELIG_BAS_'||EMPID||'','ELIG','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_COMM');
exception when others then
xp_scrubStatusLog ('ELIG-COMM BAS',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4794_ELIG_BAS','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		EFFDATE,
		TERMDATE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		PRODUCTID,
		PLANTYPE,
		PLANNAME,
		UDFC21 --ICE-17438
	)
	SELECT /*+ PARALLEL(a,4) */
		a.ROWID AS SRCROWID,
		''BAS'' AS source,
		NVL(B.MEMID,A.SBSCRBR_ID|| DECODE(UPPER(A.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||TO_CHAR(A.MBR_BRTH_DT,''YYYYMMDD'')||''-''||A.MBR_SQNC_NBR||''-''||lvl3.ROLLUPID) AS MEMID,
		NVL(B.ENRID,A.SBSCRBR_ID||''-''||A.MBR_SQNC_NBR||''-''||lvl3.ROLLUPID) AS ENRID,
		CASE WHEN NVL(TO_CHAR(A.MBR_EFCTV_DT,''YYYYMM''),''0'')<''201701'' THEN TO_DATE(''20170101'',''YYYYMMDD'') ELSE A.MBR_EFCTV_DT END AS EFFDATE,
		CASE WHEN A.MBR_TERM_DT IS NULL OR A.MBR_TERM_DT>fldt.FILEENDDATE THEN Last_day(fldt.FILEENDDATE) ELSE A.MBR_TERM_DT END AS TERMDATE,
		''C'' AS LVL1ID,
		''Commercial'' AS LVL1Desc,
		NVL(lvl2.ROLLUPLVL2ID,a.ACCT_NBR||''-''||a.DEPT_NBR) AS LVL2ID,
		NVL(lvl2.ROLLUPLVL2DESC,a.ACCT_NBR||''-''||a.DEPT_NBR) AS LVL2Desc,
		NVL(lvl3.rollupid,a.ACCT_NBR||''-''||a.DEPT_NBR) LVL3ID,
		NVL(lvl3.GROUP_NAME,a.ACCT_NBR||''-''||a.DEPT_NBR)  AS LVL3Desc,
		NVL(lvl2.ROLLUPLVL4ID,a.ACCT_NBR||''-''||a.DEPT_NBR)  AS LVLID4,
		NVL(lvl2.ROLLUPLVL4DESC,a.ACCT_NBR||''-''||a.DEPT_NBR) AS LVLDesc4,
		''1'' AS PRODUCTID,
		''HDHP'' AS PLANTYPE,
		''BAS HDHP'' as PLANNAME,	--275048 F/U#7.3
		A.SBSCRBR_ID AS UDFC21 --ICE-17438
	FROM
		HI0826001.HI_ELIG_BAS_'||EMPID||' A
	left join
		HR_826_BAS_LVL2_4 lvl2
	on
		a.ACCT_NBR = lvl2.SRC_ACCT_NBR
	AND
		a.DEPT_NBR = lvl2.SRC_DEPT_NBR
	left join
		HR_826_GROUP lvl3
	on
	  a.ACCT_NBR = lvl3.SRC_CODE
	LEFT JOIN
		zzz_elig_umr_'||vLvl.SERIALNO||' B
	ON
		substr(UPPER(A.MBR_FIRST_NM),1,30) = B.MEMFIRSTNAME
	AND
		UPPER(A.MBR_LAST_NM) = B.MEMLASTNAME
	AND
		DECODE(UPPER(A.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'') = B.GENDER
	AND
		A.MBR_BRTH_DT = B.DOB
	AND 	--323306
		NVL(lvl3.rollupid,a.ACCT_NBR||''-''||a.DEPT_NBR) = B.LVLID3
	LEFT JOIN	--275048 F/U#6.5
		HR_826_FILEDATE_BAS FLDT
	ON
		UPPER(a.SOURCEFILENAME) = upper(FLDT.SOURCEFILENAME)
	AND
		a.RECEIVEDMONTH = FLDT.RECEIVEDMONTH
'

	 ;
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('ELIG-CSTM BAS',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('ELIG-CSTM BAS',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'ELIG-MERGE BAS','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_COMM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_BAS');
exception when others then
xp_scrubStatusLog ('ELIG-MERGE BAS',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

---------------------------------- Start of Insert of  ANTHEMR CA OR dropped data back ---------------------------------------------------------------

VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_BAS';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('BAS ELIG FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('BAS ELIG FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
END;
COMMIT;

END IF;
-----------------------------------------END-275048-----------------------------------------------------
-------------------------------------------------------------------------------------------------
---------------------------------------------- HUMANA ICE#143831 LAYOUT: ELIGIBILITIES ---------------------

-------------------------------------------------------ELIG HUMANA 1432 STARTS--MI Implementation-----------------------------------------------------------------
-----------------------------ICE 7490,7713 HUMANA TWIN CASES---------------------------
IF vLvl.PAYER='HUMANA' THEN

IF EMPID IN ('LPKI','CMHA') THEN

vbquery:='DROP TABLE ZZZ_ELIG_HM_TWINS_'||vLvl.SERIALNO||' PURGE';
	BEGIN
		EXECUTE IMMEDIATE vbQuery;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

vbQuery:=
'CREATE TABLE ZZZ_ELIG_HM_TWINS_'||vLvl.SERIALNO||' NOLOGGING PARALLEL 4 AS
       SELECT DISTINCT lvlid3,enrid, memfirstname, memlastname,dob, gender, memid,NEW_MEMID FROM   ( SELECT /*+PARALLEL(A,4)*/
	        Nvl(grp.ROLLUPID,a.GRP_ID) AS LVLID3,
			 a.SUBSCRIBER_SSN||''-''||Nvl(grp.ROLLUPID,a.GRP_ID) AS ENRID,
			UPPER(a.PERS_FIRST_NAME) AS MEMFIRSTNAME,
			UPPER(a.PERS_LAST_NAME) AS MEMLASTNAME,
			a.PERS_BIRTH_DATE AS DOB,
			DECODE(UPPER(a.PERS_SEX_CD),''M'',''M'',''F'',''F'',''U'')  AS GENDER ,
		 a.SUBSCRIBER_SSN||a.PERS_SEX_CD|| TO_CHAR(a.PERS_BIRTH_DATE,''YYYYMMDD'')||''-''||Nvl(grp.ROLLUPID,a.GRP_ID) AS MEMID,
			a.SUBSCRIBER_SSN||a.PERS_SEX_CD|| TO_CHAR(a.PERS_BIRTH_DATE,''YYYYMMDD'')||''-''||Nvl(grp.ROLLUPID,a.GRP_ID)||''-''||substr(A.mbr_id,-2) NEW_MEMID,
			Row_Number()   OVER   (PARTITION BY  UPPER(a.PERS_LAST_NAME),	DECODE(UPPER(a.PERS_SEX_CD),''M'',''M'',''F'',''F'',''U''),  Nvl(grp.ROLLUPID,a.GRP_ID), a.SUBSCRIBER_SSN||''-''||Nvl(grp.ROLLUPID,a.GRP_ID) ,a.PERS_BIRTH_DATE, UPPER(a.PERS_FIRST_NAME) ORDER BY  a.MBR_COV_EFF_DATE , a.MBR_COV_END_DATE) rn
		FROM
			HI0826001.HI_ELIG_HUMANA_'||EMPID||' a
		LEFT JOIN
			HR_826_GROUP GRP
		ON
			a.grp_id = grp.SRC_CODE
        WHERE (CASE
			WHEN UPPER(a.REL_TYPE_CD) = ''EE'' THEN ''E''
			WHEN UPPER(a.REL_TYPE_CD) IN (''SP'', ''DP'', ''DS'', ''CL'') THEN ''S''
			WHEN UPPER(a.REL_TYPE_CD) IN (''CH'', ''GC'', ''SC'', ''GU'', ''SB'', ''CU'', ''NN'', ''ST'', ''DD'', ''OD'') THEN ''D''
			Else ''U'' END) = ''D'' AND
           a.SUBSCRIBER_SSN||UPPER(a.PERS_LAST_NAME)||TO_CHAR(a.PERS_BIRTH_DATE,''YYYYMMDD'') IN
	        (
		  SELECT /*+PARALLEL(A,4)*/  a.SUBSCRIBER_SSN||UPPER(a.PERS_LAST_NAME)||TO_CHAR(a.PERS_BIRTH_DATE,''YYYYMMDD'')
          FROM hi0826001.HI_ELIG_HUMANA_'||EMPID||' A
          GROUP BY a.SUBSCRIBER_SSN||UPPER(a.PERS_LAST_NAME)||TO_CHAR(a.PERS_BIRTH_DATE,''YYYYMMDD'')
          HAVING COUNT(DISTINCT UPPER(a.PERS_FIRST_NAME)||substr(A.mbr_id,-2))>1
        )
        GROUP BY
		Nvl(grp.ROLLUPID,a.GRP_ID), a.SUBSCRIBER_SSN||''-''||Nvl(grp.ROLLUPID,a.GRP_ID), UPPER(a.PERS_FIRST_NAME), UPPER(a.PERS_LAST_NAME), a.PERS_BIRTH_DATE , DECODE(UPPER(a.PERS_SEX_CD),''M'',''M'',''F'',''F'',''U''),
a.SUBSCRIBER_SSN||a.PERS_SEX_CD|| TO_CHAR(a.PERS_BIRTH_DATE,''YYYYMMDD'')||''-''||Nvl(grp.ROLLUPID,a.GRP_ID),a.MBR_COV_EFF_DATE , a.MBR_COV_END_DATE,A.mbr_id
) WHERE rn=1
	ORDER BY 1,2,3,4';

BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	COMMIT;
BEGIN
   EXECUTE IMMEDIATE 'ALTER TABLE ZZZ_ELIG_HM_TWINS_'||vLvl.SERIALNO||' ADD PRIMARY KEY (ENRID,MEMLASTNAME,DOB,GENDER,LVLID3,MEMFIRSTNAME)';
EXCEPTION
  WHEN Others THEN Dbms_Output.Put_Line(SQLERRM);
END;
 end if;

	vbQuery := 'DROP TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM PURGE';
		BEGIN
		EXECUTE IMMEDIATE vbQuery;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	vbQuery:='CREATE TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM AS
	SELECT
		SOURCE,
		MEMID,
		ENRID,
		RELFLAG,
		EFFDATE,
		TERMDATE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		PRODUCTID,
		BENCOVTYPEDESC,
		PLANTYPE,
		PLANNAME,
		COVERAGESTATUS,
		SRCRELFLAG,
		UDFC21 --ICE-17438
	FROM
		VH_ELIGIBILITIES
	WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE vbQuery;
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG TABLE CREATE HUMANA',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	vbQuery:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE vbQuery;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	vbQuery :='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTM_ELIG_HMNA_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE vbQuery ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	BEGIN
		SP_PYR_1432_ELIG_HMNA('HI0826001','HI_ELIG_HUMANA_'||EMPID||'','ELIG','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_COMM');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG-COMM HUMANA',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_1432_ELIG_HMNA','','E');
	END;

	COMMIT;
----------------------------------------------------------------------------------------------------------

	vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		RELFLAG,
		EFFDATE,
		TERMDATE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		PRODUCTID,
		BENCOVTYPEDESC,
		PLANTYPE,
		PLANNAME,
		COVERAGESTATUS,
		SRCRELFLAG,
		UDFC21 --ICE-17438
	)
	SELECT
		a.ROWID AS SRCROWID,
		''HUMANA'' AS SOURCE,
		';
		IF EMPID IN ('LPKI','CMHA') THEN
	vbQuery := vbQuery||' NVL(TWINS.NEW_MEMID,a.SUBSCRIBER_SSN||a.PERS_SEX_CD|| TO_CHAR(a.PERS_BIRTH_DATE,''YYYYMMDD'')||''-''||Nvl(grp.ROLLUPID,a.GRP_ID))  AS MemID,
	';
		ELSE
	vbQuery := vbQuery ||
	'   CASE when grp.MEMID_GRP_FLAG =''Y''
		THEN a.SUBSCRIBER_SSN||a.PERS_SEX_CD|| TO_CHAR(a.PERS_BIRTH_DATE,''YYYYMMDD'')||''-''||Nvl(grp.ROLLUPID,a.GRP_ID)
		ELSE
		a.SUBSCRIBER_SSN||a.PERS_SEX_CD|| TO_CHAR(a.PERS_BIRTH_DATE,''YYYYMMDD'') END AS MEMID,';
         END IF;		--ICE#3054, CMHA- 7713
		 vbQuery := vbQuery ||
	'
		CASE WHEN grp.MEMID_GRP_FLAG =''Y''
		THEN a.SUBSCRIBER_SSN||''-''||Nvl(grp.ROLLUPID,a.GRP_ID)
		ELSE
		a.SUBSCRIBER_SSN END	AS	ENRID,			--ICE#3054
		Decode(Upper(a.REL_TYPE_CD),''EE'',''E'',''SP'',''S'',''DP'',''S'',''CL'',''S'',''DS'',''S'',''D'') AS RELFLAG,
		a.MBR_COV_EFF_DATE AS EFFDATE,
		CASE
			WHEN Nvl(grp.ROLLUPID,a.GRP_ID) = ''GROT'' AND CASE
			WHEN NVL(a.MBR_COV_END_DATE,To_Date(''99991231'',''YYYYMMDD''))>To_Date(SubStr(SOURCEFILENAME,InStr(SOURCEFILENAME,''_'',-1,1)+1,8),''YYYYMMDD'') THEN To_Date(SubStr(SOURCEFILENAME,InStr(SOURCEFILENAME,''_'',-1,1)+1,8), ''YYYYMMDD'')
			ELSE a.MBR_COV_END_DATE
		  END > To_Date(''20191231'',''YYYYMMDD'') THEN To_Date(''20191231'',''YYYYMMDD'')
		  WHEN NVL(a.MBR_COV_END_DATE,To_Date(''99991231'',''YYYYMMDD''))>To_Date(SubStr(SOURCEFILENAME,InStr(SOURCEFILENAME,''_'',-1,1)+1,8),''YYYYMMDD'') THEN To_Date(SubStr(SOURCEFILENAME,InStr(SOURCEFILENAME,''_'',-1,1)+1,8), ''YYYYMMDD'')
		  ELSE a.MBR_COV_END_DATE
		  END AS TERMDATE,--ICE#217857, 12926
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		CASE WHEN grp.ROLLUPID IN (''HAMI'',''SORT'') THEN COALESCE(t.PLANTYPE,pl.PLANTYPE,''PPO'') ELSE COALESCE(t.PLANTYPE,pt.PLANTYPE, a.MAJOR_LOB_CD) END AS LVLID2, --245727
		CASE WHEN grp.ROLLUPID IN (''HAMI'',''SORT'') THEN COALESCE(t.PLANTYPE,pl.PLANTYPE,''PPO'') ELSE COALESCE(t.PLANTYPE,pt.PLANTYPE, a.MAJOR_LOB_CD) END  AS LVLDESC2, --245727
		Nvl(grp.ROLLUPID,a.GRP_ID) AS LVLID3,
		Nvl(grp.GROUP_NAME,a.GRP_ID) AS LVLDESC3,
		COALESCE(l4hami.DIVISIONCODE, l4cinc.DIVISIONCODE, lvl.ROLLUP_ID) AS LVLID4,
		COALESCE(l4hami.SUBGROUPDESC, l4cinc.SUBGROUPDESC, lvl.rollup_Desc) AS LVLDESC4,
		''1'' AS PRODUCTID,
		ben.ROLLUP_DESC AS BENCOVTYPEDESC,
		CASE WHEN grp.ROLLUPID IN (''HAMI'',''SORT'',''LPKI'') THEN COALESCE(t.PLANTYPE,pl.PLANTYPE,''PPO'')
		 WHEN grp.ROLLUPID IN (''GROT'') then
		 CASE WHEN  a.MAJOR_LOB_CD=''NPOS'' THEN ''HDHP'' ELSE COALESCE(t.PLANTYPE,pt.PLANTYPE, a.MAJOR_LOB_CD) END  --ICE-14795
		ELSE COALESCE(t.PLANTYPE,pt.PLANTYPE, a.MAJOR_LOB_CD) end AS PLANTYPE,   --245727,7490
		CASE WHEN grp.ROLLUPID IN (''HAMI'',''SORT'',''LPKI'') THEN COALESCE(t.rollup_desc, pl.ROLLUPPRODUCTDESCRIPTION) ELSE COALESCE(t.rollup_desc,a.PLAN_DESC) END AS PLANNAME, --24572,7490
		st.Coverage_status AS COVERAGESTATUS,
		Nvl(b.ROLLUP_DESC, Upper(a.REL_TYPE_CD)) AS SRCRELFLAG,
		a.SUBSCRIBER_SSN AS UDFC21 --ICE-17438
	FROM
		HI0826001.HI_ELIG_HUMANA_'||EMPID||' a

	LEFT JOIN
		HR_826_REL b
	ON
		a.REL_TYPE_CD = b.SRC_CODE
		AND
		b.SOURCE = ''HUMANA''

	LEFT JOIN
		HR_826_COVERAGE ben
	ON
		a.COV_TYPE_CD = ben.SRC_CODE
		AND
		ben.SOURCE = ''HUMANA''

	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.grp_id = grp.SRC_CODE

	LEFT JOIN
		HR_826_HUMANA_STATUS st
	ON
		a.grp_id = st.SRC_CD1
		AND
		SUBSTR(a.CUST_COV_KEY,1,8) = st.SRC_CD2

	LEFT JOIN
		HR_826_HUMANA_LOA lvl
	ON
		a.grp_id = lvl.SRC_CD1
		AND
		SUBSTR(a.CUST_COV_KEY,-8) = lvl.SRC_CD2

	LEFT JOIN
		HR_826_HUMANA_PlAN pl
	ON
		a.GRP_ID = pl.GROUPNUMBER
		AND
		SubStr(a.CUST_COV_KEY,1,8) = pl.DIVISIONNUMBER
		AND
		a.PROD_KEY = pl.PACKAGEID

	LEFT JOIN
		HR_826_HUMANA_PLANTYPE pt
	ON
		a.PLAN_DESC = pt.PLANNAME';
	IF EMPID IN ('LPKI','CMHA') THEN
		vbQuery := vbQuery||'
    LEFT JOIN
		ZZZ_ELIG_HM_TWINS_'||vLvl.SERIALNO||' TWINS
	ON
		a.SUBSCRIBER_SSN||''-''||Nvl(grp.ROLLUPID,a.GRP_ID) =TWINS.ENRID
	AND
		UPPER(a.PERS_LAST_NAME) =TWINS.MEMLASTNAME
	AND
		DECODE(UPPER(a.PERS_SEX_CD),''M'',''M'',''F'',''F'',''U'') =TWINS.GENDER
	AND
		a.PERS_BIRTH_DATE = TWINS.DOB
	AND
		Nvl(grp.ROLLUPID,a.GRP_ID) =TWINS.LVLID3
	AND
		UPPER(a.PERS_FIRST_NAME) =TWINS.MEMFIRSTNAME';
	END IF;
	vbQuery := vbQuery ||
	'
	LEFT JOIN
		HR_826_LOA_LVL_ROLLUP t
	ON
		a.GRP_ID  = t.groupid
		AND
		Decode(a.GRP_ID, ''704786'', Upper(SubStr(CUST_COV_KEY,1,8)), ''NA'') = Nvl(t.DIVISIONCODE,''NA'')
		AND
		Upper(a.PROD_KEY) = Upper(t.PLANCODE)
		AND
		To_Char(a.MBR_COV_EFF_DATE,''YYYY'') = To_Char(t.effectivedate, ''YYYY'')

	left JOIN						--ICE #188386
		(SELECT * FROM HR_826_LVL4_DIVISION WHERE groupid = ''704786'') l4hami
	ON
		Upper(SubStr(CUST_COV_KEY,1,8)) = substr(l4hami.divisioncode,1,8)
		AND
		Upper(a.PROD_KEY) = Upper(l4hami.PLANCODE)

	left JOIN
		(SELECT * FROM HR_826_LVL4_DIVISION WHERE groupid = ''706811'') l4cinc
	ON
		Upper(SubStr(CUST_COV_KEY,1,8)) = substr(l4cinc.divisioncode,1,8)
		AND
		Upper(a.PROD_KEY) = Upper(l4cinc.PLANCODE)
		AND
		To_Char(a.MBR_COV_EFF_DATE,''YYYY'') = To_Char(l4cinc.effectivedate, ''YYYY'')

	WHERE NVL(lvl.clmtype,''MED'')=''MED''

	';

	BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('ELIG-CSTM HUMANA',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG-CSTM HUMANA',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
------------------------------------------------------------------------------------------------------------------
	BEGIN
		SP_CDF_TBL_MERGE(USER,'ELIG-MERGE HUMANA','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_COMM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_HMNA');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG-MERGE HUMANA',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	END;
	COMMIT;

---------------------------------- Start of Insert of  HUMANA OR dropped data back ---------------------------------------------------------------

	vbQuery:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE vbQuery;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	vbQuery:='INSERT INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_HMNA';

	BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('HUMANA ELIG FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('HUMANA ELIG FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
--ICE-12104 starts
	BEGIN EXECUTE IMMEDIATE 'DROP TABLE zzz_memid_hmna_'||vLvl.SERIALNO;
EXCEPTION WHEN OTHERS THEN NULL;
END;
	begin
	 vbQuery:='CREATE TABLE zzz_memid_hmna_'||vLvl.SERIALNO||' as
  SELECT DISTINCT SOURCE, MEMID, ENRID, RELFLAG, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB,termdate,effdate,lvlid3 FROM
  VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
 WHERE SOURCE = ''HUMANA''
 AND ( MEMFIRSTNAME||MEMLASTNAME||GENDER||To_CHAR(DOB,''DDMMYYYY'')||LVLID3) IN (
		SELECT  MEMFIRSTNAME||MEMLASTNAME||GENDER||To_CHAR(DOB,''DDMMYYYY'')||LVLID3 FROM
				VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
					GROUP BY  MEMFIRSTNAME||MEMLASTNAME||GENDER||To_CHAR(DOB,''DDMMYYYY'')||LVLID3
					HAVING Count(DISTINCT memid)>1) ORDER BY
					MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, RELFLAG';
  BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('HUMANA Multiple Mem',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('HUMANA Multiple Mem',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');

	end;
	end;
	commit;

	BEGIN EXECUTE IMMEDIATE 'DROP TABLE fin_mul_mem_'||vLvl.SERIALNO;
EXCEPTION WHEN OTHERS THEN NULL;
END;

BEGIN EXECUTE IMMEDIATE 'DROP TABLE emp_mul_mem_'||vLvl.SERIALNO;
EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
     vbQuery:='create TABLE  emp_mul_mem_'||vLvl.SERIALNO||' AS
      SELECT * from (
      SELECT t.*,Row_Number()
			OVER(PARTITION BY  memfirstname,memlastname,gender,dob,lvlid3 ORDER BY EFFDATE DESC NULLS LAST, TERMDATE DESC NULLS LAST , MEMID) rn
			FROM zzz_memid_hmna_'||vLvl.SERIALNO||' t WHERE relflag=''E'') WHERE rn=1' ;

BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('HUMANA emp table created',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('HUMANA emp table created',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
end;
end;
COMMIT;

begin
	vbQuery:='merge into VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  a
                  USING
				emp_mul_mem_'||vLvl.SERIALNO||'  b
					ON
			(a.memfirstname=b.memfirstname
			AND a.memlastname=b.memlastname
			AND a.gender=b.gender AND
			a.dob=b.dob and a.lvlid3=b.lvlid3)
				WHEN MATCHED THEN
				UPDATE SET
				a.memid=b.memid,
				a.enrid=b.enrid,
				a.udfc1=''Merged memid'' where a.source=''HUMANA''
				 AND A.MEMID <> B.MEMID';
BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('Merge Humana memid',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('Merge Humana memid',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');

	end;
	END;
	commit;

	BEGIN EXECUTE IMMEDIATE 'DROP TABLE ZZZ_MLPL_MEMID_DEP_'||vLvl.SERIALNO;
EXCEPTION WHEN OTHERS THEN NULL;
END;
	begin
	 vbQuery:='
	CREATE TABLE ZZZ_MLPL_MEMID_DEP_'||vLvl.SERIALNO||' NOLOGGING
AS
SELECT
  DISTINCT SOURCE, MEMID, ENRID, RELFLAG, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3, LVLDESC3, EFFDATE, TERMDATE
FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
WHERE source=''HUMANA'' AND MEMFIRSTNAME||MEMLASTNAME||DOB||GENDER||LVLID3 IN
(
  SELECT MEMFIRSTNAME||MEMLASTNAME||DOB||GENDER||LVLID3
  FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
  WHERE source=''HUMANA''
  GROUP BY MEMFIRSTNAME||MEMLASTNAME||DOB||GENDER||LVLID3
  HAVING Count(DISTINCT MEMID)>1
)
ORDER BY
  MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, RELFLAG';
  BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('HUMANA Multiple Dep',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('HUMANA Multiple Dep',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');

	end;
	end;
	commit;


	begin
	 vbQuery:='CREATE TABLE fin_mul_mem_'||vLvl.SERIALNO||' as
						SELECT * FROM (
					SELECT t.*,Row_Number()
			OVER(PARTITION BY  memfirstname,memlastname,gender,dob ,LVLID3 ORDER BY EFFDATE DESC NULLS LAST, TERMDATE DESC NULLS LAST, RELFLAG DESC, MEMID) rn
			FROM ZZZ_MLPL_MEMID_DEP_'||vLvl.SERIALNO||' t )
		    WHERE rn=1 ';

BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('HUMANA Multiple table created',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('HUMANA Multiple table created',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
end;
	end;
	commit;

	begin
	vbQuery:='merge into VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  a
                  USING
				fin_mul_mem_'||vLvl.SERIALNO||'  b
					ON
			(a.memfirstname=b.memfirstname
			AND a.memlastname=b.memlastname
			AND a.gender=b.gender AND
			a.dob=b.dob
			AND
  A.LVLID3 = B.LVLID3)
				WHEN MATCHED THEN
				UPDATE SET
				a.memid=b.memid,
				a.enrid=b.enrid,
				a.udfc1=''Merged memid in 2ndpass''
			 where a.source=''HUMANA'' and a.udfc1 IS NULL AND
  A.MEMID <> B.MEMID';
BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('Merge Humana memid mul dependent',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('Merge Humana memid mul dependent',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');

	end;
	END;
	commit;

--ICE-12104 ends

END IF;
-------------------------------------------------------ELIG HUMANA 1432 ENDS----MI Implementation---------------------------------------------------------------
------------------------ELIG BCBSIL STARTS ICE-4870------------------------------
IF  vLvl.PAYER='BCBSIL' THEN

IF EMPID IN ('CECO') THEN

vbquery:='DROP TABLE ZZZ_ELIG_BC_TWINS_'||vLvl.SERIALNO||' PURGE';
	BEGIN
		EXECUTE IMMEDIATE vbQuery;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

vbQuery:=
'CREATE TABLE ZZZ_ELIG_BC_TWINS_'||vLvl.SERIALNO||' NOLOGGING PARALLEL 4 AS
        SELECT /*+PARALLEL(A,4)*/
	        NVL(GRP.rollupid,a.accountnumber) AS LVLID3,
			SUBSTR(A.SUBSCRIBERSSN,1,9) AS ENRID,
			UPPER(A.MEMBERFIRSTNAME) AS MEMFIRSTNAME,
			UPPER(A.MEMBERLASTNAME) AS MEMLASTNAME,
			A.MEMBERDOB AS DOB,
			DECODE(UPPER(A.MEMBERGENDER),''M'',''M'',''F'',''F'',''U'') AS GENDER ,
			COALESCE (SubStr(A.SUBSCRIBERID,-9)||DECODE(UPPER(A.MEMBERGENDER),''M'',''M'',''F'',''F'',''U'')|| TO_CHAR(A.MEMBERDOB,''YYYYMMDD''),''MEMBERID'') AS MEMID,
			SubStr(A.SUBSCRIBERID,-9)||DECODE(UPPER(A.MEMBERGENDER),''M'',''M'',''F'',''F'',''U'')|| TO_CHAR(A.MEMBERDOB,''YYYYMMDD'') ||''-''||A.MEMBERNUMBER NEW_MEMID
		FROM
			HI0826001.HI_ELIG_BCBSIL_'||EMPID||' a
		LEFT JOIN
			HR_826_GROUP GRP
		ON
			A.ACCOUNTNUMBER = GRP.SRC_CODE
        WHERE DECODE(UPPER(A.MEMBERRELATIONSHIPCODE),''I'',''E'',''S'',''S'',''D'',''D'',''U'') = ''D'' AND
          SUBSTR(A.SUBSCRIBERSSN,1,9)||UPPER(A.MEMBERLASTNAME) ||A.MEMBERDOB  ||DECODE(UPPER(A.MEMBERGENDER),''M'',''M'',''F'',''F'',''U'') IN
	        (

	        SELECT /*+PARALLEL(A,4)*/  SUBSTR(A.SUBSCRIBERSSN,1,9)||UPPER(A.MEMBERLASTNAME) ||A.MEMBERDOB  ||DECODE(UPPER(A.MEMBERGENDER),''M'',''M'',''F'',''F'',''U'')
          FROM hi0826001.HI_ELIG_BCBSIL_'||EMPID||' A        --3051
          GROUP BY SUBSTR(A.SUBSCRIBERSSN,1,9)||UPPER(A.MEMBERLASTNAME) ||A.MEMBERDOB  ||DECODE(UPPER(A.MEMBERGENDER),''M'',''M'',''F'',''F'',''U'')
          HAVING
          (COUNT(DISTINCT UPPER(A.MEMBERFIRSTNAME))>1
          AND
          COUNT(DISTINCT A.MEMBERNUMBER)>1)

		   )
        GROUP BY
			NVL(GRP.rollupid,a.accountnumber) ,SUBSTR(A.SUBSCRIBERSSN,1,9) ,UPPER(A.MEMBERFIRSTNAME) ,UPPER(A.MEMBERLASTNAME) , A.MEMBERDOB ,DECODE(UPPER(A.MEMBERGENDER),''M'',''M'',''F'',''F'',''U'')  ,
			COALESCE (SubStr(A.SUBSCRIBERID,-9)||DECODE(UPPER(A.MEMBERGENDER),''M'',''M'',''F'',''F'',''U'')|| TO_CHAR(A.MEMBERDOB,''YYYYMMDD''),''MEMBERID''),
			SubStr(A.SUBSCRIBERID,-9)||DECODE(UPPER(A.MEMBERGENDER),''M'',''M'',''F'',''F'',''U'')|| TO_CHAR(A.MEMBERDOB,''YYYYMMDD'') ||''-''||A.MEMBERNUMBER
	ORDER BY 2';

BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	COMMIT;
-------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE 'DROP TABLE ZZZ_ARBC_MEMUPD_'||vLvl.SERIALNO||' PURGE';
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
vbQuery:=
	'CREATE TABLE ZZZ_ARBC_MEMUPD_'||vLvl.SERIALNO||' NOLOGGING AS
	SELECT
		MEMID,
		ENRID,
		MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		LVLID3,
		TERMDATE
	FROM (
		SELECT
			NVL(TWINS.NEW_MEMID,a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'')) AS MEMID,
			a.SBSCRBR_ID AS	ENRID,
			UPPER(a.MBR_FIRST_NM) AS MEMFIRSTNAME,
			UPPER(a.MBR_LAST_NM) AS MEMLASTNAME,
			CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END AS GENDER,
			a.MBR_BRTH_DT AS DOB,
			nvl(grp.ROLLUPID,a.ACCT_NBR) AS LVLID3,
			CASE WHEN a.mbr_term_dt > To_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') THEN
		to_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') ELSE a.mbr_term_dt END  AS termdate,
			row_number() over (partition by UPPER(a.MBR_FIRST_NM),
			UPPER(a.MBR_LAST_NM),CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END,a.MBR_BRTH_DT,nvl(grp.ROLLUPID,a.ACCT_NBR)
			order by a.MBR_EFCTV_DT desc NULLS LAST, 8 DESC NULLS LAST) rn
		FROM
			HI0826001.HI_ELIG_ANTHEM_'||EMPID||' a
		LEFT JOIN
			HR_826_GROUP grp
		ON
			a.ACCT_NBR = grp.src_code
		LEFT JOIN
			ZZZ_ELIG_ARDX_TWINS_CECO TWINS
		ON
			UPPER(a.MBR_FIRST_NM) = TWINS.MEMFIRSTNAME
		AND
			UPPER(a.MBR_LAST_NM) = TWINS.MEMLASTNAME
		AND
			a.MBR_BRTH_DT  =  TWINS.DOB
		AND
			Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'') =TWINS.GENDER
		AND
			nvl(grp.ROLLUPID,a.ACCT_NBR) =TWINS.LVLID3
		)
	WHERE RN=1
	';
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	COMMIT;
	----------------------------------------------------------------------------------
VBQUERY :='ALTER TABLE ZZZ_ARBC_MEMUPD_'||vLvl.SERIALNO||' ADD PRIMARY KEY( UPPER(a.MBR_FIRST_NM),
			UPPER(a.MBR_LAST_NM),CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END,a.MBR_BRTH_DT,nvl(grp.ROLLUPID,a.ACCT_NBR))';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;
	------------------------------------------------------------------------------------------
END IF;
-----------------------------------------------------------------------
VBQUERY := 'DROP TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_BC_CSTM PURGE';
		BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_BC_CSTM AS
	SELECT
		SOURCE,
		MEMID,
		ENRID,
		EFFDATE,
		TERMDATE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		PLANTYPE,
		PLANNAME,
		PRODUCTID,
    BENCOVTYPEDESC,
		UDFC5,
		UDFC21 --ICE-17438
	FROM
		VH_ELIGIBILITIES
	WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG TABLE CREATE BCBSIL',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_BC_CSTM ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_BC_CSTM ADD CONSTRAINT PK_CSTM_ELIG_BCBSIL_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	BEGIN
		SP_PYR_1404_ELIG_BCIL('HI0826001','HI_ELIG_BCBSIL_'||EMPID||'','ELIG','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_BC_COMM');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG-COMM BCBSIL',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_1404_ELIG_BCIL','','E');
	END;

	COMMIT;
----------------------------------------------------------------------------------------------------------

	vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_BC_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		EFFDATE,
		TERMDATE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		PLANTYPE,
		PLANNAME,
		PRODUCTID,
    BENCOVTYPEDESC,
		UDFC5,
		UDFC21 --ICE-17438
	)
	SELECT
		a.ROWID AS SRCROWID,
		''BCBSIL'' AS Source,
		CASE WHEN grp.ROLLUPID = ''CECO'' THEN COALESCE(UPD.MEMID, TWINS.NEW_MEMID,COALESCE (SubStr(A.SUBSCRIBERID,-9)||DECODE(UPPER(A.MEMBERGENDER),''M'',''M'',''F'',''F'',''U'')|| TO_CHAR(A.MEMBERDOB,''YYYYMMDD''),''MEMBERID'') )
		ELSE
		COALESCE(SubStr(A.SUBSCRIBERID,-9)||DECODE(UPPER(A.MEMBERGENDER),''M'',''M'',''F'',''F'',''U'')|| TO_CHAR(A.MEMBERDOB,''YYYYMMDD''),''MEMBERID'')||''-''||grp.ROLLUPID END AS MEMID,
        CASE WHEN grp.ROLLUPID = ''CECO'' THEN nvl(UPD.ENRID,COALESCE(SubStr(A.SUBSCRIBERID,-9),''EMPLOYEEID'')  ) ELSE COALESCE(SubStr(A.SUBSCRIBERID,-9),''EMPLOYEEID'') ||''-''||grp.ROLLUPID END AS ENRID,
		A.MEMBEREFFDATE AS EFFDATE,
		CASE WHEN Nvl(A.MEMBERCANCELDATE,To_Date(''99991231'',''YYYYMMDD'')) > To_Date(SubStr(A.SOURCEFILENAME,-12,8),''YYYYMMDD'') THEN To_Date(SubStr(A.SOURCEFILENAME,-12,8),''YYYYMMDD'')
        ELSE A.MEMBERCANCELDATE END as TERMDATE,
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		nvl(C.bano,a.GROUPNUMBER||a.SECTIONNUMBER) AS LVLID2,
		nvl(C.badescription,a.GROUPNUMBER||a.SECTIONNUMBER)  AS LVLDESC2,
		NVL(GRP.rollupid,a.accountnumber) AS LVLID3,
		NVL(GRP.group_name,a.accountnumber) AS LVL3DESC,
		NVL(C.billingcategory,a.GROUPNUMBER||a.SECTIONNUMBER) AS LVLID4,
		NVL(C.categorydescription,a.GROUPNUMBER||a.SECTIONNUMBER) AS LVLDESC4,
		A.PRODUCTTYPE AS PLANTYPE,
		nvl(C.badescription,a.GROUPNUMBER||a.SECTIONNUMBER) AS PLANNAME,--ICE 9230
		''1'' AS PRODUCTID, --in hr_global_productLine 1 prodID is mapped as commercial
    CASE WHEN A.CONTRACTTYPE IN (''SUBSCRIBER AND CHILDREN'',''SUBSCRIBER AND CHILD'') THEN ''SUB & 1 OR MORE CHILDREN'' ELSE A.CONTRACTTYPE END AS BENCOVTYPEDESC,	 --ICE-12493
		A.MemberNumber AS UDFC5,
		A.SUBSCRIBERID AS UDFC21 --ICE-17438
	FROM
		HI0826001.HI_ELIG_BCBSIL_'||EMPID||' a
        LEFT JOIN
		HR_826_GROUP grp
	ON
		a.accountnumber = grp.src_code
		LEFT JOIN
		HR_826_BCBSIL_PLAN c
	ON
		a.GROUPNUMBER = c.GROUPNUMBER
	AND
		a.SECTIONNUMBER = c.SECTIONNUMBER
		LEFT JOIN
		HR_826_PLANTYPE_BCIL PLANTYPE
		ON
		UPPER(A.PRODUCTTYPE)=PLANTYPE.SRCPLANCODE
	LEFT JOIN
		ZZZ_ELIG_BC_TWINS_'||vLvl.SERIALNO||' TWINS
	ON
		UPPER(A.MEMBERFIRSTNAME) = TWINS.MEMFIRSTNAME
	AND
		UPPER(A.MEMBERLASTNAME) = TWINS.MEMLASTNAME
	AND
		DECODE(UPPER(A.MEMBERGENDER),''M'',''M'',''F'',''F'',''U'') = TWINS.GENDER
	AND
		A.MEMBERDOB = TWINS.DOB
	AND
		NVL(GRP.rollupid,a.accountnumber) = TWINS.LVLID3
	';
	IF EMPID IN ('CECO') THEN
		vbQuery := vbQuery||'
	LEFT JOIN
		ZZZ_ARBC_MEMUPD_'||vLvl.SERIALNO||' UPD
	ON
		UPPER(A.MEMBERFIRSTNAME) = UPD.MEMFIRSTNAME
	AND
		UPPER(A.MEMBERLASTNAME) = UPD.MEMLASTNAME
	AND
		DECODE(UPPER(A.MEMBERGENDER),''M'',''M'',''F'',''F'',''U'') = UPD.GENDER
	AND
		A.MEMBERDOB = UPD.DOB
	AND
		NVL(GRP.rollupid,a.accountnumber) = UPD.LVLID3
	';
 END IF;
 BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('ELIG-CSTM BCBSIL',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_BCBSIL_'||EMPID,'Y','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG-CSTM BCBSIL',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
------------------------------------------------------------------------------------------------------------------
	BEGIN
		SP_CDF_TBL_MERGE(USER,'ELIG-MERGE BCBSIL','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_BC_COMM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_BC_CSTM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_BCBSIL');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG-MERGE BCBSIL',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	END;
	COMMIT;

VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='INSERT INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_BCBSIL';

	BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('BCBSIL ELIG FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_BCBSIL_'||EMPID,'Y','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('BCBSIL ELIG FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
--------------------------------------------------------------------------------------------------------------------------------
IF EMPID IN ('CECO') THEN

vbQuery:='CREATE TABLE ZZZ_E2C_E2R_MEMUPD_'||EMPID||' AS
SELECT * FROM
(SELECT DISTINCT MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3
FROM
(
SELECT /*+PARALLEL(A,4)*/  MEMID, ENRID,  MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ,LVLID3,
			 ROW_NUMBER() OVER (PARTITION BY LVLID3, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ORDER BY EFFDATE ASC NULLS LAST, TERMDATE ASC NULLS LAST) RN
			 FROM  VH_ELIGIBILITIES_'||vLvl.SERIALNO||' A ) WHERE RN=1
			 ) B
WHERE LVLID3 IN (''CECO'')';

BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('BCBSIL E2M AND E2R MEMID UPDATE',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_BCBSIL_'||EMPID,'Y','I');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('BCBSIL E2M AND E2R MEMID UPDATE',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
VBQUERY :='ALTER TABLE ZZZ_E2C_E2R_MEMUPD_'||EMPID||' ADD PRIMARY KEY( LVLID3, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

END IF;

END IF;

------------------------ELIG BCBSIL ENDS ICE-4870------------------------------------
------- #187186 STRT OF CUSTOM DESIGN BENEFIT ---------

IF  vLvl.PAYER='CDBT' THEN


BEGIN EXECUTE IMMEDIATE 'DROP TABLE zzz_umr_term_'||vLvl.SERIALNO||' PURGE';
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	---------------------------------------------------------------------------------------------
	vbQuery:=
	'CREATE TABLE zzz_umr_term_'||vLvl.SERIALNO||' NOLOGGING AS
	SELECT
		a.EMPE_SSN_NBR||DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')|| TO_CHAR(a.INDIV_BIRTH_DATE,''YYYYMMDD'') AS MEMID,		--MEMID LOGIC MAY VARY FROM CLIENT TO CLIENT
		a.INDIV_INS_EFF_DATE AS EffDate,
		MAX(a.INDIV_INS_EXP_DATE) AS M_TermDate
	FROM HI0826001.HI_ELIG_UMR_BEF_'||EMPID||' a
	WHERE
		a.EMPE_SSN_NBR IS NOT NULL AND a.INDIV_INS_EFF_DATE IS NOT NULL
	GROUP BY
		a.EMPE_SSN_NBR||DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')|| TO_CHAR(a.INDIV_BIRTH_DATE,''YYYYMMDD''),
		a.INDIV_INS_EFF_DATE
	';
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	COMMIT;
	---------------------------------------------------------------------------------------------
	vbQuery:=
	'ALTER TABLE zzz_umr_term_'||vLvl.SERIALNO||' ADD CONSTRAINT PK_umr_term_'||vLvl.SERIALNO||' PRIMARY KEY (MEMID,EffDate)
	';
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	COMMIT;
---------------------------------------------------------------------------------------------

-- UHC TO CDBT MEMID UPDATE FOR GROUP XENI 11915

VBQUERY := 'DROP TABLE ZZZ_UHC_CDBT_XENI PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='
CREATE TABLE ZZZ_UHC_CDBT_XENI NOLOGGING PARALLEL 4 AS
SELECT MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3, EFFDATE, TERMDATE FROM (
SELECT
COALESCE(SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID'') AS MEMID,
COALESCE(SUBSTR(a.EMPLOYEENUMBER,-9),''EMPLOYEEID'') AS ENRID,
UPPER(a.FIRSTNAME) AS MEMFIRSTNAME,
UPPER(a.LASTNAME) AS MEMLASTNAME,
DECODE(UPPER(a.SEX),''M'',''M'',''F'',''F'',''U'') AS GENDER,
a.BIRTHDATE AS DOB,
CASE WHEN a.COVERAGESTARTDATE < d.EFFDATE THEN d.EFFDATE ELSE a.COVERAGESTARTDATE END AS EffDate,
Nvl(A.COVERAGESTOPDATE, To_Date(A.RECEIVEDMONTH, ''YYYYMM'') -1) Termdate,
nvl(grp.ROLLUPID,a.Customerstructure1) AS LVLID3,
Row_Number() OVER (PARTITION BY UPPER(a.FIRSTNAME),UPPER(a.LASTNAME),DECODE(UPPER(a.SEX),''M'',''M'',''F'',''F'',''U''),a.BIRTHDATE,nvl(grp.ROLLUPID,a.Customerstructure1)
ORDER BY Nvl(A.COVERAGESTOPDATE, To_Date(A.RECEIVEDMONTH, ''YYYYMM'') -1) DESC ,CASE WHEN a.COVERAGESTARTDATE < d.EFFDATE THEN d.EFFDATE ELSE a.COVERAGESTARTDATE END DESC) rn
FROM
		HI0826001.HI_ELIG_UHC_036_XENI a
LEFT JOIN
	HR_826_GROUP grp
ON
	a.CUSTOMERSTRUCTURE1 = grp.SRC_CODE
left JOIN
		HR_826_ELIG_CUTOFF  d
	ON
		nvl(grp.ROLLUPID,a.CUSTOMERSTRUCTURE1) = d.grpid3)
WHERE rn = 1';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('ELIG UHC TO CDBT UPDATE FOR XENI',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;




----------------------------ICE 305422 twins table start------------------------------------------------

IF EMPID IN ('TAHO','DETO','JEWC') THEN
BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE ZZZ_CDBT_'||EMPID||'_TWIN PURGE';
        EXCEPTION WHEN OTHERS THEN NULL;
END;



BEGIN
        EXECUTE IMMEDIATE'
        CREATE TABLE ZZZ_CDBT_'||EMPID||'_TWIN NOLOGGING PARALLEL 4 AS
        SELECT /*+PARALLEL(A,4)*/
			NVL(lvl3.rollupid,a.REFFIDENTIFICATION3) AS LVL3ID,a.IDENTIFICATIONCODE1 AS ENRID,UPPER(A.NAMEFIRST1) MEMFIRSTNAME,UPPER(A.NAMELAST1) MEMLASTNAME, DATEPERIOD_1 AS DOB, NVL(CASE WHEN A.GENDER IN (''F'',''M'') THEN A.GENDER ELSE ''U'' END,''X'') AS GENDER ,
			NVL(a.REFFIDENTIFICATION2, a.IDENTIFICATIONCODE1)||DECODE(UPPER(A.GENDER),''M'',''M'',''F'',''F'',''U'')||to_char(A.DATEPERIOD_1,''YYYYMMDD'') AS MEMID,
			NVL(a.REFFIDENTIFICATION2, a.IDENTIFICATIONCODE1)||DECODE(UPPER(A.GENDER),''M'',''M'',''F'',''F'',''U'')||to_char(A.DATEPERIOD_1,''YYYYMMDD'') ||A.IDENTIFICATIONCODE1 ||''-''||NVL(lvl3.rollupid,a.REFFIDENTIFICATION3)  NEW_MEMID

		FROM
	        hi0826001.HI_ELIG_CDBT_'||EMPID||' A
        LEFT JOIN
			HR_826_GROUP LVL3
		ON
			A.REFFIDENTIFICATION3   =  LVL3.SRC_CODE
        WHERE
			NVL(a.REFFIDENTIFICATION2, a.IDENTIFICATIONCODE1)||DECODE(UPPER(A.GENDER),''M'',''M'',''F'',''F'',''U'')||to_char(A.DATEPERIOD_1,''YYYYMMDD'') IN
	        (
				SELECT /*+PARALLEL(A,4)*/ NVL(a.REFFIDENTIFICATION2, a.IDENTIFICATIONCODE1)||DECODE(UPPER(A.GENDER),''M'',''M'',''F'',''F'',''U'')||to_char(A.DATEPERIOD_1,''YYYYMMDD'')
					FROM hi0826001.HI_ELIG_CDBT_'||EMPID||' A
				GROUP BY NVL(a.REFFIDENTIFICATION2, a.IDENTIFICATIONCODE1)||DECODE(UPPER(A.GENDER),''M'',''M'',''F'',''F'',''U'')||to_char(A.DATEPERIOD_1,''YYYYMMDD'')
			  HAVING
			  (
			  COUNT(DISTINCT UPPER(A.NAMEFIRST1))>1
			  AND
			  COUNT(DISTINCT A.IDENTIFICATIONCODE1 )>1)
	        )
        GROUP BY
	        NVL(lvl3.rollupid,a.REFFIDENTIFICATION3),a.IDENTIFICATIONCODE1,UPPER(A.NAMEFIRST1) ,UPPER(A.NAMELAST1) , DATEPERIOD_1 ,
           NVL(CASE WHEN A.GENDER IN (''F'',''M'') THEN A.GENDER ELSE ''U'' END,''X'') ,NVL(a.REFFIDENTIFICATION2, a.IDENTIFICATIONCODE1)||DECODE(UPPER(A.GENDER),''M'',''M'',''F'',''F'',''U'')||to_char(A.DATEPERIOD_1,''YYYYMMDD''),
			NVL(a.REFFIDENTIFICATION2, a.IDENTIFICATIONCODE1)||DECODE(UPPER(A.GENDER),''M'',''M'',''F'',''F'',''U'')||to_char(A.DATEPERIOD_1,''YYYYMMDD'') ||A.IDENTIFICATIONCODE1 ||''-''||NVL(lvl3.rollupid,a.REFFIDENTIFICATION3)
		ORDER BY 2
        ';
EXCEPTION WHEN OTHERS THEN NULL;
END;

END IF;

  ----------------------------ICE 305422  twins table end------------------------------------------------

 VBQUERY := 'DROP TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM AS
							  SELECT
								SOURCE,
                MEMID, -- 295787
                ENRID,
                TERMDATE,
								LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								LVLID4,
								LVLDESC4,
								LVLID5,
								LVLDESC5,
								LVLID6,
								LVLDESC6,
								PLANNAME,
								VHPAYORID,
								PRODUCTID,
								UDFC1,
								UDFC21 --ICE-17438
						   FROM
								VH_ELIGIBILITIES
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('ELIG TABLE CREATE CDBT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
		BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_ELIG_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_4034_ELIG_CDBT('HI0826001','HI_ELIG_CDBT_'||EMPID||'','ELIG','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_COMM');
exception when others then
xp_scrubStatusLog ('ELIG-COMM CDBT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4034_ELIG_CDBT','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID, -- 295787
		ENRID,
		TERMDATE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		LVLID5,
		LVLDESC5,
		LVLID6,
		LVLDESC6,
		PLANNAME,
		VHPAYORID,
		PRODUCTID,
		UDFC1,
		UDFC21 --ICE-17438

	)

	SELECT /*+ PARALLEL(a,4) */
		 a.ROWID AS SRCROWID,
		 ''CDBT'' AS source,
		 COALESCE(MEM.MEMID,
			CASE WHEN LVL3.MEMID_GRP_FLAG = ''Y'' THEN ';
			IF EMPID IN ('TAHO','DETO','JEWC') THEN
				vbQuery:=vbQuery||'NVL(TWIN_CASE.NEW_MEMID,';
			END IF;
			vbQuery:=vbQuery||'
				nvl(a.REFFIDENTIFICATION2, a.IDENTIFICATIONCODE1)||DECODE(UPPER(A.GENDER),''M'',''M'',''F'',''F'',''U'')||to_char(A.DATEPERIOD_1,''YYYYMMDD'')||''-''||NVL(lvl3.rollupid,a.REFFIDENTIFICATION3)';
       	IF EMPID IN ('TAHO','DETO','JEWC') THEN
              VBQUERY := VBQUERY|| ') ';
        END IF;
        VBQUERY := vbQuery|| '
			 ELSE ';
       IF EMPID IN ('XENI') THEN
				vbQuery:=vbQuery||' NVL(MEM_XENI.MEMID,';
			END IF;
      vbQuery:=vbQuery||'nvl(a.REFFIDENTIFICATION2, a.IDENTIFICATIONCODE1)||DECODE(UPPER(A.GENDER),''M'',''M'',''F'',''F'',''U'')||to_char(A.DATEPERIOD_1,''YYYYMMDD'')';
       IF EMPID IN ('XENI') THEN
              VBQUERY := VBQUERY|| ') ';
        END IF;
        VBQUERY := vbQuery||
       'END
			 ) as MEMID, -- 295787
     COALESCE(MEM.ENRID,
     CASE WHEN LVL3.MEMID_GRP_FLAG = ''Y'' THEN
     a.IDENTIFICATIONCODE1||''-''||NVL(lvl3.rollupid,a.REFFIDENTIFICATION3)
     ELSE ';
     IF EMPID IN ('XENI') THEN
				vbQuery:=vbQuery||' NVL(MEM_XENI.ENRID,';
     END IF;
        VBQUERY := vbQuery||
     'a.IDENTIFICATIONCODE1';
      IF EMPID IN ('XENI') THEN
              VBQUERY := VBQUERY|| ') ';
        END IF;
        VBQUERY := vbQuery||
      ' END) as ENRID, -- 295787

     CASE
     WHEN NVL(lvl3.rollupid,a.REFFIDENTIFICATION3) = ''CSTA'' THEN
     CASE WHEN to_char(CASE WHEN A.DATEPERIOD4 IS NULL THEN Last_day(fldt.FILEENDDATE) ELSE  A.DATEPERIOD4 END,''YYYYMMDD'') > ''20161231'' THEN TO_DATE(''20161231'',''YYYYMMDD'')
     ELSE CASE WHEN A.DATEPERIOD4 IS NULL THEN Last_day(fldt.FILEENDDATE) ELSE  A.DATEPERIOD4 END END
     WHEN NVL(lvl3.rollupid,a.REFFIDENTIFICATION3) = ''JEWC'' AND
     to_char(CASE WHEN A.DATEPERIOD4 IS NULL THEN Last_day(fldt.FILEENDDATE) ELSE  A.DATEPERIOD4 END,''YYYYMMDD'') > ''20200101'' THEN TO_DATE(''20200101'',''YYYYMMDD'')
     WHEN A.DATEPERIOD4 IS NULL THEN Last_day(fldt.FILEENDDATE)
     ELSE A.DATEPERIOD4 END AS TERMDATE,
		 ''C'' AS LVL1ID,
		 ''Commercial'' AS LVL1Desc,
      NVL(lvl2.ROLLUP_ID,a.REFFIDENTIFICATION3||''-''||a.PLANCOVDESC) AS LVL2ID,
		  NVL(lvl2.ROLLUP_DESC,a.REFFIDENTIFICATION3||''-''||a.PLANCOVDESC) AS LVL2Desc,
		  NVL(lvl3.rollupid,a.REFFIDENTIFICATION3) LVL3ID,
		  NVL(lvl3.GROUP_NAME,a.REFFIDENTIFICATION3)  AS LVL3Desc,
		  NVL(lvl4.rollup_lvl4id,a.REFFIDENTIFICATION3||''-''||a.COVLVLCODE)  AS LVLID4,
		  NVL(lvl4.ROLLUP_LVL4DESC,a.REFFIDENTIFICATION3||''-''||a.COVLVLCODE) AS LVLDesc4,
	    NULL AS LVLID5,
	    NULL AS LVLDesc5,
		  NULL AS LVLID6,
		  NULL AS LVLDesc6,
		  NVL(lvl2.ROLLUP_DESC,a.REFFIDENTIFICATION3||''-''||a.PLANCOVDESC) AS PLANNAME,
		 (SELECT P.PAYORID FROM HR_GLOBAL_PAYORLIST P WHERE TABLENAME=''HI_ELIG_CDBT'' AND  CLIENTID=''826'')  AS VHPAYORID,
		 ''1'' AS PRODUCTID,
		 A.REFFIDENTIFICATION2 AS UDFC1,		--317412
		 a.REFFIDENTIFICATION2 AS UDFC21 --ICE-17438

	FROM
	HI0826001.HI_ELIG_CDBT_'||EMPID||'  A
  left join
  HR_826_LOA_LVL_ROLLUP lvl2
  on
  a.REFFIDENTIFICATION3 = lvl2.GROUPID AND
  a.PLANCOVDESC =  lvl2.PLANCODE
  left join
  HR_826_GROUP lvl3
  on
  a.REFFIDENTIFICATION3   =  lvl3.SRC_CODE
  left join
  HR_826_CDB_LVL4 lvl4
  on
  a.REFFIDENTIFICATION3   = lvl4.group_id  AND
  a.COVLVLCODE = lvl4.COVLVLCODE
  LEFT JOIN
		HR_826_FILEDATE_CDBT FLDT
	ON
		UPPER(a.SOURCEFILENAME)  =  FLDT.SOURCEFILENAME
	AND
		a.RECEIVEDMONTH	 = FLDT.RECEIVEDMONTH
  LEFT JOIN
  ZZZ_MEMID_ANTHEM_CDB MEM            --295787
  ON
  UPPER(A.NAMEFIRST1) = MEM.MEMFIRSTNAME
  AND
  UPPER(A.NAMELAST1) = MEM.MEMLASTNAME
  AND
  DECODE(UPPER(A.GENDER),''M'',''M'',''F'',''F'',''U'') = MEM.GENDER
  AND
  A.DATEPERIOD_1 = MEM.DOB
  AND
  NVL(lvl3.rollupid,a.REFFIDENTIFICATION3) = MEM.LVL3ID
';
  IF EMPID IN ('TAHO','DETO','JEWC') THEN
  vbQuery := vbQuery || '
  LEFT JOIN
  ZZZ_CDBT_'||EMPID||'_TWIN TWIN_CASE
  ON
  UPPER(a.NAMEFIRST1) = TWIN_CASE.MEMFIRSTNAME


  AND
  UPPER(a.NAMELAST1) = TWIN_CASE.MEMLASTNAME
  AND
  DECODE(UPPER(A.GENDER),''M'',''M'',''F'',''F'',''U'') = TWIN_CASE.GENDER
  AND
  A.DATEPERIOD_1 = TWIN_CASE.DOB
  AND
  NVL(lvl3.rollupid,a.REFFIDENTIFICATION3) = TWIN_CASE.LVL3ID ';
  END IF;

  IF EMPID IN ('XENI') THEN
  vbQuery := vbQuery || '
  LEFT JOIN
  ZZZ_UHC_CDBT_XENI MEM_XENI
  ON
  UPPER(a.NAMEFIRST1) = MEM_XENI.MEMFIRSTNAME
  AND
  UPPER(a.NAMELAST1) = MEM_XENI.MEMLASTNAME
  AND
  DECODE(UPPER(A.GENDER),''M'',''M'',''F'',''F'',''U'') = MEM_XENI.GENDER
  AND
  A.DATEPERIOD_1 = MEM_XENI.DOB
  AND
  NVL(lvl3.rollupid,a.REFFIDENTIFICATION3) = MEM_XENI.LVLID3 ';
  END IF;

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('ELIG-CSTM CDBT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('ELIG-CSTM CDBT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'ELIG-MERGE CDBT','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_COMM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CDBT');
exception when others then
xp_scrubStatusLog ('ELIG-MERGE CDBT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

IF   EMPID IN ('XENI') THEN
---------------------------------- XENI LVL4 UPDATE FROM EMPLOYEE TO DEPENDENT ------------------- 11915

VBQUERY:='
MERGE INTO VH_ELIGIBILITIES_'||VLVL.SERIALNO||'_CDBT A
USING
(
SELECT LVLID3, RELFLAG, ENRID, LVLID4, LVLDESC4 FROM
(
SELECT LVLID3, RELFLAG, ENRID, LVLID4, LVLDESC4 , ROW_NUMBER() OVER(PARTITION BY ENRID ORDER BY TERMDATE DESC, EFFDATE DESC) RN
FROM
VH_ELIGIBILITIES_'||VLVL.SERIALNO||'_CDBT
WHERE RELFLAG = ''E''
)
WHERE RN = 1
) B
ON
(
A.ENRID =B.ENRID
)
WHEN MATCHED THEN UPDATE SET
A.LVLID4 = B.LVLID4,
A.LVLDESC4 =B.LVLDESC4
WHERE RELFLAG <> ''E''
';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('XENI LVL4 UPDATE FROM EMPLOYEE TO DEPENDENT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

END IF;

--------------------------------------START-ICE#13125-------------------------------------------
DBMS_STATS.GATHER_TABLE_STATS(OWNNAME => USER, TABNAME => 'VH_ELIGIBILITIES_'||VLVL.SERIALNO||'_CDBT', ESTIMATE_PERCENT=> DBMS_STATS.AUTO_SAMPLE_SIZE,DEGREE=>4);

vbQuery:='
MERGE INTO VH_ELIGIBILITIES_'||VLVL.SERIALNO||'_CDBT A
USING (SELECT LVLID4, LVLDESC4,UDFC1, LVLID3
		FROM (
					SELECT LVLID4, LVLDESC4,UDFC1, LVLID3,
					ROW_NUMBER()OVER(PARTITION BY LVLID3,UDFC1 ORDER BY TERMDATE DESC NULLS LAST,EFFDATE DESC,LVLID4,LVLDESC4 ) RN
					FROM VH_ELIGIBILITIES_'||VLVL.SERIALNO||'_CDBT WHERE SOURCE = ''CDBT'' AND Nvl(LVLDESC4,''XXX'') NOT IN (''THS00-'', ''GWC00-'', ''STR00-'' , ''RMP00-'', ''DEL00-'', ''SGR00-'', ''MAS00-'' ,''JWL00-'', ''XEN00-'')
			 )
		WHERE RN=1
		) B
ON
(
	A.UDFC1=B.UDFC1  AND A.LVLID3 =B.LVLID3
)
WHEN MATCHED THEN
UPDATE SET
	A.LVLID4 = B.LVLID4,
	A.LVLDESC4 = B.LVLDESC4
WHERE A.source = ''CDBT''
';

BEGIN EXECUTE IMMEDIATE vbQuery;
DBMS_STATS.GATHER_TABLE_STATS(OWNNAME => USER, TABNAME => 'VH_ELIGIBILITIES_'||VLVL.SERIALNO||'_CDBT', ESTIMATE_PERCENT => DBMS_STATS.AUTO_SAMPLE_SIZE);
EXCEPTION WHEN OTHERS THEN
xp_scrubStatusLog ('VH_ELIGIBILITIES__CDBT LVL4 UPD: '||SQL%ROWCOUNT,'HORAN','  ',SQLCODE,substr(SQLERRM, 1,400),'',0,'VH_ELIGIBILITIES_CDBT','','E');
END;
COMMIT;
--------------------------------------END-ICE#13125--------------------------------------------


---------------------------------- Start of Insert of  ANTHEMR CA OR dropped data back ---------------------------------------------------------------

VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CDBT';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('CDBT FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CDBT FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
END;
COMMIT;


-------- PAYER SWITCH #187186  Cutoff and memid retaining --------

IF   EMPID IN ('RMPI') THEN
vbquery := 'UPDATE VH_ELIGIBILITIES_'||vLvl.SERIALNO||' set  termdate = to_date(''20151231'',''YYYYMMDD'') where
to_Char(termdate,''YYYY-MM'') > ''2015-12'' and source = ''CDBT''';
BEGIN
EXECUTE IMMEDIATE vbquery;
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('RMPI termdate update',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
END;

BEGIN EXECUTE IMMEDIATE 'DROP TABLE  zzz_Elig_UMR_MemID_'||vLvl.SERIALNO;
EXCEPTION WHEN OTHERS THEN NULL;
END;




BEGIN EXECUTE IMMEDIATE '
	CREATE TABLE zzz_Elig_UMR_MemID_'||vLvl.SERIALNO||'
	(

		MemID VARCHAR2(100),
		ENRID VARCHAR2(100),
		MEMFIRSTNAME VARCHAR2(100),
		MEMLASTNAME VARCHAR2(100),
		GENDER VARCHAR2(5),
		DOB DATE,
		EFFDATE DATE,
		TERMDATE DATE

	)NOLOGGING';
END;


vbQuery:=
		'INSERT INTO zzz_Elig_UMR_MemID_'||vLvl.SERIALNO||'
		SELECT
		a.EMPE_SSN_NBR||DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')|| TO_CHAR(a.INDIV_BIRTH_DATE,''YYYYMMDD'') as memid,
		a.EMPE_SSN_NBR AS ENRID,
		UPPER(a.INDIV_1ST_NAME_TEXT)  AS MemFirstName,
		UPPER(a.INDIV_LAST_NAME_TEXT) AS MemLastName,
		DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'') AS  Gender,
		a.INDIV_BIRTH_DATE  AS DOB,
		a.INDIV_INS_EFF_DATE AS EFFDATE,
		COALESCE(a.INDIV_INS_EXP_DATE,trm.M_TermDate,TO_DATE(a.RECEIVEDMONTH,''YYYYMM'')-1)  AS TERMDATE

		FROM
		HI0826001.hi_elig_umr_bef_rmpi a
		LEFT JOIN
		zzz_umr_term_'||vLvl.SERIALNO||' trm
	ON
		a.EMPE_SSN_NBR||DECODE(UPPER(a.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')|| TO_CHAR(a.INDIV_BIRTH_DATE,''YYYYMMDD'') = trm.MEMID
	AND
		a.INDIV_INS_EFF_DATE = trm.EffDate';

BEGIN EXECUTE IMMEDIATE vbquery;
    xp_scrubStatusLog ('ELIG Reliance mem update from UMR',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
 EXCEPTION WHEN OTHERS THEN
    xp_scrubStatusLog ('ELIG Reliance mem update from UMR',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
 END;
 COMMIT;


vbQuery:=
		'MERGE INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||' C
		USING
		(
		SELECT
			MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER,DOB
		FROM
		(
		SELECT
				MEMID, ENRID,  MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB,TERMDATE,
				ROW_NUMBER() OVER (PARTITION BY MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ORDER BY TERMDATE DESC) RN
		FROM
		zzz_Elig_UMR_MemID_'||vLvl.SERIALNO||'
		)
		WHERE RN = 1
		) D
	ON
	(
			C.MEMFIRSTNAME = D.MEMFIRSTNAME
		AND
			C.MEMLASTNAME = D.MEMLASTNAME
		AND
			C.GENDER = D.GENDER
		AND
			C.DOB= D.DOB
	)
	WHEN MATCHED THEN UPDATE
	SET
	C.MEMID = D.MEMID,
	C.ENRID = D.ENRID';


BEGIN EXECUTE IMMEDIATE vbquery;
    xp_scrubStatusLog ('Reliance mem merge from UMR',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
 EXCEPTION WHEN OTHERS THEN
    xp_scrubStatusLog ('Reliance mem merge from UMR',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
 END;
 COMMIT;




END IF;
END IF;
--------  END OF CUSTOM DESIGN BENEFITS-----------------------------------------------------------------------------------------
------------- ICE#179218 AETNA ELIG STARTS
IF  vLvl.PAYER='AETNA' THEN

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ZZZ_AETNA_MEM_HUMANA_UPDATE CASCADE CONSTRAINTS';
  EXCEPTION
    WHEN Others THEN NULL;
  END;


  vbquery:=
  'CREATE TABLE ZZZ_AETNA_MEM_HUMANA_UPDATE as
  SELECT * from
	  (SELECT
		MEMFIRSTNAME, MEMLASTNAME,DOB,MEMID, ENRID, GENDER,
		ROW_NUMBER() OVER(PARTITION BY MEMFIRSTNAME, MEMLASTNAME, DOB ORDER BY RCVMTH DESC) RN
  FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||' WHERE SOURCE=''HUMANA'') a
	WHERE rn = 1';

  EXECUTE IMMEDIATE vbquery;

 VBQUERY := 'DROP TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM AS
							  SELECT
								SOURCE,
								MEMID,
								ENRID,
								EFFDATE,
								TERMDATE,
								LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								LVLID4,
								LVLDESC4,
								LVLID5,
								LVLDESC5,
								LVLID6,
								LVLDESC6,
								VHPAYORID,
								PRODUCTID,
								PLANTYPE,
								PLANNAME

						   FROM
								VH_ELIGIBILITIES
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('ELIG TABLE CREATE AETNA '||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_ELIG_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_4105_ELIG_ATNA('HI0826001','HI_ELIG_AETNA_'||EMPID,'ELIG','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_COMM');
exception when others then
xp_scrubStatusLog ('ELIG-COMM AETNA '||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4105_ELIG_ATNA','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		EFFDATE,
		TERMDATE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		LVLID5,
		LVLDESC5,
		LVLID6,
		LVLDESC6,
		VHPAYORID,
		PRODUCTID,
		PLANTYPE,
		PLANNAME
	)
	SELECT /*+ PARALLEL(a,4) */
		 a.ROWID AS SRCROWID,
		 ''AETNA'' AS source,
		 nvl(X.MEMID,a.CUMBID||DECODE(UPPER(A.GENDER),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(A.BIRTH_DATE,''YYYYMMDD'')) AS MEMID,
		 NVL(X.ENRID,a.CUMBID) as ENRID,
		 Nvl(a.EFFECTIVE,FLDT.effective_date) AS EFFDATE,
		 CASE WHEN Nvl(a.TERM_DT,To_Date(''99991231'',''YYYYMMDD''))> FLDT.term_date then FLDT.term_date
		 ELSE a.TERM_DT END AS TERMDATE,
		 ''C'' AS LVL1ID,
		 ''Commercial'' AS LVL1Desc,
		 NVL(lvl2.LVL2ROLLUPID ,a.CONTROL||''-''||a.SUFFIX||''-''||a.account) AS LVL2ID,
		  NVL(lvl2.ACCOUNTNAME ,a.CONTROL||''-''||a.SUFFIX||''-''||a.account) AS LVL2Desc,
		  NVL(lvl3.rollupid,a.CONTROL) LVL3ID,
		  NVL(lvl3.GROUP_NAME,a.CONTROL)  AS LVL3Desc,
		  NVL(lvl4.LVL4ROLLUPID ,a.CONTROL||''-''||a.plan)  AS LVLID4,
		  substr(NVL(lvl4.plandesc ,a.CONTROL||''-''||a.plan),1,50) AS LVLDesc4,
		  NULL AS LVLID5,
	      NULL AS LVLDesc5,
		  NULL AS LVLID6,
		  NULL AS LVLDesc6,
		 (SELECT P.PAYORID FROM HR_GLOBAL_PAYORLIST P WHERE TABLENAME=''HI_ELIG_AETNA'' AND  CLIENTID=''826'')  AS VHPAYORID,
		 ''1'' AS PRODUCTID,
		 NVL(lvl4.LVL4ROLLUPID ,a.CONTROL||''-''||a.plan)  AS PLANTYPE,
		 substr(NVL(lvl4.plandesc ,a.CONTROL||''-''||a.plan),1,50) AS PLANNAME

	FROM
	HI0826001.HI_ELIG_AETNA_'||EMPID||'  A
  left join
  HR_826_AETNA_LVL2 lvl2
  on
  a.CONTROL = lvl2.CONTROL AND
  a.SUFFIX =  lvl2.SUFFIX AND
  a.account =  lvl2.account
  left join
  HR_826_GROUP lvl3
  on
  a.CONTROL   =  lvl3.SRC_CODE
  left join
  HR_826_AETNA_PLAN lvl4
  on
  a.CONTROL   = lvl4.CONTROL  AND
  a.plan = lvl4.plan
  LEFT JOIN
		HR_826_FILEDATE_AETNA FLDT
	ON
		UPPER(a.SOURCEFILENAME)  =  FLDT.SRCFILENAME
	AND
		a.RECEIVEDMONTH	 = FLDT.RECEIVEDMONTH
	left join
	ZZZ_AETNA_MEM_HUMANA_UPDATE X
	ON
	UPPER(A.FIRST_NAME)=X.MEMFIRSTNAME AND
	UPPER(A.LAST_NAME)=X.MEMLASTNAME AND
	A.BIRTH_DATE=X.DOB AND
	DECODE(UPPER(A.GENDER),''M'',''M'',''F'',''F'',''U'')=X.GENDER
'

	 ;
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('ELIG-CSTM AETNA '||EMPID,EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('ELIG-CSTM AETNA '||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'ELIG-MERGE AETNA '||EMPID,'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_COMM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_'||EMPID);
exception when others then
xp_scrubStatusLog ('ELIG-MERGE AETNA '||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

---------------------------------- Start of Insert of  AETMA CA OR dropped data back ---------------------------------------------------------------

VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_'||EMPID;

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('AETNA '||EMPID||' FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('AETNA '||EMPID||' FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
END;
COMMIT;

END IF;
------------------------------------------------------
---ICE 210269 (Aetna new layout)
IF  vLvl.PAYER='ATNA' THEN

---ICE#288907

IF EMPID = 'OHMH' THEN
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ZZZ_ANTHEM_MEM_OHMH_UPDATE CASCADE CONSTRAINTS';
	EXCEPTION WHEN Others THEN NULL;
  END;


  vbquery:=
  'CREATE TABLE ZZZ_ANTHEM_MEM_OHMH_UPDATE as
  SELECT MEMFIRSTNAME, MEMLASTNAME, DOB, GENDER, MEMID, ENRID, ''OHMH'' AS LVLID3 from
	  (SELECT
		upper(mbr_first_nm) as memfirstname, upper(mbr_last_nm) MEMLASTNAME, mbr_brth_dt DOB,  a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2)||''-''||''OHMH'' MEMID, a.SBSCRBR_ID||''-''||''OHMH'' ENRID, CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END GENDER,
		ROW_NUMBER() OVER(PARTITION BY mbr_first_nm, mbr_last_nm, mbr_brth_dt,MBR_GNDR_CD   ORDER BY receivedmonth DESC) RN
  FROM HI0826001.HI_ELIG_ANTHEM_OHMH a)
	WHERE rn = 1';


BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('TEMP TABLE ATNA UPDATE',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_ANTHEM_OHMH','Y','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('TEMP TABLE ATNA UPDATE',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
END;
COMMIT;

END IF;
-----------------------CREATE TWINS TABLE FOR GROUP TIRE AND SOURCE AETNA ICE#330646----3228-----4867----
IF EMPID in ('SWCS', 'TIRE','FIGA')
THEN

    BEGIN
			EXECUTE IMMEDIATE 'DROP TABLE ZZZ_TWINS_AETNA_'||VLVL.SERIALNO;
			EXCEPTION WHEN OTHERS THEN NULL;
	END;

vbquery:=' CREATE TABLE ZZZ_TWINS_AETNA_'||VLVL.SERIALNO||' AS
  SELECT
	DISTINCT
	NVL(lvl3.rollupid,substr(a.HIERARCHY_LEVEL_3,-7)) LVLID3 ,
	substr(a.SUBSCRIBER_SSN,-9)||DECODE(UPPER(A.member_gender),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(A.member_date_of_birth,''YYYYMMDD'')||CASE WHEN lvl3.MEMID_GRP_FLAG = ''Y'' THEN ''-''||lvl3.ROLLUPID END AS MEMID,
	substr(a.SUBSCRIBER_SSN,-9)||CASE WHEN lvl3.MEMID_GRP_FLAG = ''Y'' THEN ''-''||lvl3.ROLLUPID END as ENRID,
	UPPER(A.MEMBER_FIRST_NAME ) AS MEMFIRSTNAME,
		UPPER(A.MEMBER_LAST_NAME) AS MEMLASTNAME,
		DECODE(UPPER(A.MEMBER_GENDER),''F'',''F'',''M'',''M'',''U'') AS GENDER,
		A.MEMBER_DATE_OF_BIRTH AS DOB,
	substr(a.SUBSCRIBER_SSN,-9)||DECODE(UPPER(A.MEMBER_GENDER),''F'',''F'',''M'',''M'',''U'')||TO_CHAR(A.MEMBER_DATE_OF_BIRTH,''YYYYMMDD'')||CASE WHEN lvl3.MEMID_GRP_FLAG = ''Y'' THEN ''-''||lvl3.ROLLUPID END||''-''||SubStr(UPPER(A.MEMBER_FIRST_NAME),1,4) as MEMID_NEW
	FROM
	HI0826001.HI_ELIG_AETNA_'||EMPID||'  A
	left join
	HR_826_GROUP lvl3
  on
	substr(a.HIERARCHY_LEVEL_3,-7)  =  lvl3.SRC_CODE
	WHERE
		DECODE (UPPER(MEM_RELATIONSHIP_TO_SUBSCRIBER),''E'',''E'',''S'',''S'',''P'',''S'',''X'',''S'',''C'',''D'',''D'',''D'',''F'',
             ''D'',''G'',''D'',''H'',''D'',''L'',''D'',''T'',''D'',''U'') = ''D'' --Applies for Dependent only
	AND
		substr(a.SUBSCRIBER_SSN,-9)||UPPER(A.MEMBER_LAST_NAME)||A.MEMBER_DATE_OF_BIRTH||DECODE(UPPER(A.MEMBER_GENDER),''F'',''F'',''M'',''M'',''U'')
	IN
		(
		SELECT  substr(a.SUBSCRIBER_SSN,-9)||UPPER(A.MEMBER_LAST_NAME)||A.MEMBER_DATE_OF_BIRTH||DECODE(UPPER(A.MEMBER_GENDER),''F'',''F'',''M'',''M'',''U'')
    FROM HI0826001.HI_ELIG_AETNA_'||EMPID||' a
		WHERE
			DECODE (UPPER(MEM_RELATIONSHIP_TO_SUBSCRIBER),''E'',''E'',''S'',''S'',''P'',''S'',''X'',''S'',''C'',''D'',''D'',''D'',''F'',
             ''D'',''G'',''D'',''H'',''D'',''L'',''D'',''T'',''D'',''U'') = ''D''
		GROUP BY substr(a.SUBSCRIBER_SSN,-9)||UPPER(A.MEMBER_LAST_NAME)||A.MEMBER_DATE_OF_BIRTH||DECODE(UPPER(A.MEMBER_GENDER),''F'',''F'',''M'',''M'',''U'')
		HAVING COUNT(DISTINCT UPPER(A.MEMBER_FIRST_NAME))>1
		)
	GROUP BY
		NVL(lvl3.rollupid,substr(a.HIERARCHY_LEVEL_3,-7)) ,
	substr(a.SUBSCRIBER_SSN,-9)||DECODE(UPPER(A.member_gender),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(A.member_date_of_birth,''YYYYMMDD'')||CASE WHEN lvl3.MEMID_GRP_FLAG = ''Y'' THEN ''-''||lvl3.ROLLUPID END,
	substr(a.SUBSCRIBER_SSN,-9)||CASE WHEN lvl3.MEMID_GRP_FLAG = ''Y'' THEN ''-''||lvl3.ROLLUPID END,
	UPPER(A.MEMBER_FIRST_NAME ),
		UPPER(A.MEMBER_LAST_NAME),
		DECODE(UPPER(A.MEMBER_GENDER),''F'',''F'',''M'',''M'',''U''),
		A.MEMBER_DATE_OF_BIRTH,
    substr(a.SUBSCRIBER_SSN,-9)||DECODE(UPPER(A.MEMBER_GENDER),''F'',''F'',''M'',''M'',''U'')||TO_CHAR(A.MEMBER_DATE_OF_BIRTH,''YYYYMMDD'')||CASE WHEN lvl3.MEMID_GRP_FLAG = ''Y'' THEN ''-''||lvl3.ROLLUPID END||''-''||SubStr(UPPER(A.MEMBER_FIRST_NAME),1,4)
	ORDER BY 1,2,3,4

	';

BEGIN EXECUTE IMMEDIATE VBQUERY;
 xp_scrubStatusLog ('AETNA '|| EMPID || ' TWIN TABLE',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_AETNA_'||EMPID,'Y','I');
EXCEPTION WHEN OTHERS THEN
xp_scrubStatusLog ('AETNA '|| EMPID ||' TIRE TWIN TABLE',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
END;

END IF;
-----------------------CREATE TWINS TABLE FOR GROUP TIRE AND SOURCE AETNA ICE#330646---------

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ZZZ_ATNA_MEM_HUMANA_UPDATE CASCADE CONSTRAINTS';
  EXCEPTION
    WHEN Others THEN NULL;
  END;


  vbquery:=
  'CREATE TABLE ZZZ_ATNA_MEM_HUMANA_UPDATE as
  SELECT * from
	  (SELECT
		MEMFIRSTNAME, MEMLASTNAME,DOB,MEMID, ENRID, GENDER,
		ROW_NUMBER() OVER(PARTITION BY MEMFIRSTNAME, MEMLASTNAME, DOB ORDER BY RCVMTH DESC) RN
  FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||' WHERE SOURCE=''HUMANA'') a
	WHERE rn = 1';

  EXECUTE IMMEDIATE vbquery;

 VBQUERY := 'DROP TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM AS
							  SELECT
								SOURCE,
								MEMID,
								ENRID,
								EFFDATE,
								TERMDATE,
								LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								LVLID4,
								LVLDESC4,
								LVLID5,
								LVLDESC5,
								LVLID6,
								LVLDESC6,
								VHPAYORID,
								PRODUCTID,
								PLANTYPE,
								PLANNAME,
								UDFC21 --ICE-17438
						   FROM
								VH_ELIGIBILITIES
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('ELIG TABLE CREATE ATNA '||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM ADD  PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
     SP_PYR_2654_ELIG_ATNA('HI0826001','HI_ELIG_AETNA_'||EMPID,'ELIG','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_COMM');

exception when others then
xp_scrubStatusLog ('ELIG-COMM ATNA '||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4105_ELIG_ATNA','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
INSERT /*+ APPEND*/ ALL

	WHEN 1=1 THEN
		INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM
		(SRCROWID,SOURCE,MEMID,ENRID,EFFDATE,TERMDATE,LVLID1,LVLDESC1,LVLID2,LVLDESC2,LVLID3,LVLDESC3,LVLID4,LVLDESC4,LVLID5,LVLDESC5,LVLID6,LVLDESC6,VHPayorID,PRODUCTID,PLANTYPE,PLANNAME, UDFC21) --ICE-17438
		VALUES
		(
		''MED''||SRCROWID,SOURCE,MEMID,ENRID,EFFDATE,TERMDATE,LVLID1,LVLDESC1,LVLID2,LVLDESC2,LVLID3,LVLDESC3,LVLID4,LVLDESC4,LVLID5,LVLDESC5,LVLID6,LVLDESC6,VHPayorID,PRODUCTID,PLANTYPE,PLANNAME, UDFC21 --ICE-17438
		)

    WHEN DENTAL_INDICATOR=''Y'' THEN INTO
    VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM(SRCROWID,SOURCE,MEMID,ENRID,EFFDATE,TERMDATE,LVLID1,LVLDESC1,LVLID2,LVLDESC2,LVLID3,LVLDESC3,LVLID4,LVLDESC4,LVLID5,LVLDESC5,LVLID6,LVLDESC6,VHPayorID,PRODUCTID,PLANTYPE,PLANNAME , UDFC21) --ICE-17438
    VALUES(
    ''DEN''||SRCROWID,SOURCE,MEMID,ENRID,EFFDATE,TERMDATE,LVLID1,LVLDESC1,LVLID2,LVLDESC2,LVLID3,LVLDESC3,LVLID4,LVLDESC4,LVLID5,LVLDESC5,LVLID6,LVLDESC6,VHPayorID,PRODUCTID,PLANTYPE,PLANNAME ,UDFC21) --ICE-17438

    WHEN MENTAL_HEALTH_INDICATOR=''Y'' THEN INTO
    VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM(
    SRCROWID,SOURCE,MEMID,ENRID,EFFDATE,TERMDATE,LVLID1,LVLDESC1,LVLID2,LVLDESC2,LVLID3,LVLDESC3,LVLID4,LVLDESC4,LVLID5,LVLDESC5,LVLID6,LVLDESC6,VHPayorID,PRODUCTID,PLANTYPE,PLANNAME,UDFC21) --ICE-17438

    VALUES(
    ''MENT''||SRCROWID,SOURCE,MEMID,ENRID,EFFDATE,TERMDATE,LVLID1,LVLDESC1,LVLID2,LVLDESC2,LVLID3,LVLDESC3,LVLID4,LVLDESC4,LVLID5,LVLDESC5,LVLID6,LVLDESC6,VHPayorID,PRODUCTID,PLANTYPE,PLANNAME,UDFC21) --ICE-17438

	WHEN DRUG_INDICATOR=''Y'' THEN INTO
    VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM(
    SRCROWID,SOURCE,MEMID,ENRID,EFFDATE,TERMDATE,LVLID1,LVLDESC1,LVLID2,LVLDESC2,LVLID3,LVLDESC3,LVLID4,LVLDESC4,LVLID5,LVLDESC5,LVLID6,LVLDESC6,VHPayorID,PRODUCTID,PLANTYPE,PLANNAME,UDFC21) --ICE-17438

    VALUES(
    ''RX''||SRCROWID,SOURCE,MEMID,ENRID,EFFDATE,TERMDATE,LVLID1,LVLDESC1,LVLID2,LVLDESC2,LVLID3,LVLDESC3,LVLID4,LVLDESC4,LVLID5,LVLDESC5,LVLID6,LVLDESC6,VHPayorID,PRODUCTID,PLANTYPE,PLANNAME,UDFC21) --ICE-17438

	WHEN SUBSTANCE_ABUSE_INDICATOR=''Y'' THEN INTO
    VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM(SRCROWID,SOURCE,MEMID,ENRID,EFFDATE,TERMDATE,LVLID1,LVLDESC1,LVLID2,LVLDESC2,LVLID3,LVLDESC3,LVLID4,LVLDESC4,LVLID5,LVLDESC5,LVLID6,LVLDESC6,VHPayorID,PRODUCTID,PLANTYPE,PLANNAME,UDFC21) --ICE-17438

    VALUES(
    ''SABU''||SRCROWID,SOURCE,MEMID,ENRID,EFFDATE,TERMDATE,LVLID1,LVLDESC1,LVLID2,LVLDESC2,LVLID3,LVLDESC3,LVLID4,LVLDESC4,LVLID5,LVLDESC5,LVLID6,LVLDESC6,VHPayorID,PRODUCTID,PLANTYPE,PLANNAME,UDFC21) --ICE-17438

	SELECT /*+ PARALLEL(a,4) */
		 a.ROWID AS SRCROWID,
		 ''AETNA'' AS source,
		 nvl(';
		 ----ICE#288907
		IF EMPID='OHMH' THEN
		vbQuery:=vbQuery||'X1.MEMID,';
		elsIF EMPID in ('SWCS', 'TIRE','FIGA') THEN		--330646  3228  4867
		vbQuery:=vbQuery||'TW.MEMID_NEW,';
		ELSE
		vbQuery:=vbQuery||'X.MEMID,';
		END IF;
		vbQuery:=vbQuery||'substr(a.SUBSCRIBER_SSN,-9)||DECODE(UPPER(A.member_gender),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(A.member_date_of_birth,''YYYYMMDD'')||CASE WHEN lvl3.MEMID_GRP_FLAG = ''Y'' THEN ''-''||lvl3.ROLLUPID END) AS MEMID,
		nvl(';
		IF EMPID='OHMH' THEN
		vbQuery:=vbQuery||'X1.ENRID,';
		ELSE
		vbQuery:=vbQuery||'X.ENRID,';
		END IF;
		vbQuery:=vbQuery||'substr(a.SUBSCRIBER_SSN,-9)||CASE WHEN lvl3.MEMID_GRP_FLAG = ''Y'' THEN ''-''||lvl3.ROLLUPID END) as ENRID,	--330646
		';
		vbQuery:=vbQuery||'
		 --Nvl(a.INDIVIDUAL_ORIG_EFF_DATE_AETNA,FLDT.effective_date) AS EFFDATE,
		 --CASE WHEN Nvl(a.INDIVIDUAL_CANCEL_DATE_AETNA,To_Date(''99991231'',''YYYYMMDD''))> FLDT.term_date then FLDT.term_date
		 --WHEN lvl3.rollupid=''FIGA'' AND Nvl(a.INDIVIDUAL_CANCEL_DATE_AETNA,To_Date(''99991231'',''YYYYMMDD''))>TO_DATE(''20181231'',''YYYYMMDD'') THEN TO_DATE(''20181231'',''YYYYMMDD'')    ---ICE 4867
		 --ELSE a.INDIVIDUAL_CANCEL_DATE_AETNA END AS TERMDATE,
		 TO_DATE(A.EFFECTIVE_YEAR_MONTH||''01'',''YYYYMMDD'')  AS EFFDATE,--8590
		 CASE WHEN lvl3.rollupid=''FIGA'' AND Nvl(LAST_DAY(TO_DATE(A.EFFECTIVE_YEAR_MONTH||''01'',''YYYYMMDD'')),To_Date(''99991231'',''YYYYMMDD''))>TO_DATE(''20181231'',''YYYYMMDD'') THEN TO_DATE(''20181231'',''YYYYMMDD'')
		 ELSE LAST_DAY(TO_DATE(A.EFFECTIVE_YEAR_MONTH||''01'',''YYYYMMDD'')) END AS TERMDATE,--8590
		 ''C'' AS LVLID1,
		 ''Commercial'' AS LVLDESC1,
		 NVL(lvl4.LVL4ROLLUPID ,substr(a.HIERARCHY_LEVEL_3,-7)||''-''||a.GEN_CATEGORY_OF_HEALTH_PLAN)  AS LVLID2,	--ICE#245222
		  substr(NVL(lvl4.plandesc ,substr(a.HIERARCHY_LEVEL_3,-7)||''-''||a.GEN_CATEGORY_OF_HEALTH_PLAN),1,50) AS LVLDESC2,		--ICE#245222
		  NVL(lvl3.rollupid,substr(a.HIERARCHY_LEVEL_3,-7)) LVLID3,
		  NVL(lvl3.GROUP_NAME,substr(a.HIERARCHY_LEVEL_3,-7))  AS LVLDESC3,
		  NVL(lvl2.LVL2ROLLUPID ,substr(a.HIERARCHY_LEVEL_3,-7)||''-''||substr(a.HIERARCHY_LEVEL_5,-3)||''-''||a.HIERARCHY_LEVEL_6) AS LVLID4,	--ICE#245222
		  NVL(lvl2.ACCOUNTNAME ,substr(a.HIERARCHY_LEVEL_3,-7)||''-''||substr(a.HIERARCHY_LEVEL_5,-3)||''-''||a.HIERARCHY_LEVEL_6) AS LVLDesc4,	--ICE#245222
		  NULL AS LVLID5,
	      NULL AS LVLDesc5,
		  NULL AS LVLID6,
		  NULL AS LVLDesc6,
		 (SELECT P.PAYORID FROM HR_GLOBAL_PAYORLIST P WHERE TABLENAME=''HI_ELIG_AETNA'' AND  CLIENTID=''826'')  AS VHPAYORID,
		 ''1'' AS PRODUCTID,
		 CASE WHEN lvl3.rollupid=''SWCS'' and a.hierarchy_level_3=''00466013'' THEN --ICe-14795
		 NVL(lvl4.LVL4ROLLUPID ,''PPO'') 		 ELSE
		 NVL(lvl4.LVL4ROLLUPID ,substr(a.HIERARCHY_LEVEL_3,-7)||''-''||a.GEN_CATEGORY_OF_HEALTH_PLAN) END
		 AS PLANTYPE,
		 substr(NVL(lvl4.plandesc ,substr(a.HIERARCHY_LEVEL_3,-7)||''-''||a.GEN_CATEGORY_OF_HEALTH_PLAN),1,50) AS PLANNAME,
		 DENTAL_INDICATOR as DENTAL_INDICATOR,
		MENTAL_HEALTH_INDICATOR as MENTAL_HEALTH_INDICATOR,
		DRUG_INDICATOR as DRUG_INDICATOR,
		SUBSTANCE_ABUSE_INDICATOR as SUBSTANCE_ABUSE_INDICATOR, 
		a.SUBSCRIBER_SSN as UDFC21 --ICE-17438

	FROM
	HI0826001.HI_ELIG_AETNA_'||EMPID||'  A
  left join
		HR_826_AETNA_LVL2 lvl2
  on
	  substr(a.HIERARCHY_LEVEL_3,-7) = lvl2.CONTROL AND			-- ICE #210269
	  substr(a.HIERARCHY_LEVEL_5,-3) =  lvl2.SUFFIX AND
	  a.HIERARCHY_LEVEL_6 =  lvl2.account
  left join
	HR_826_GROUP lvl3
  on
	substr(a.HIERARCHY_LEVEL_3,-7)  =  lvl3.SRC_CODE
  left join
	HR_826_AETNA_PLAN lvl4
  on
	  substr(a.HIERARCHY_LEVEL_3,-7)  = lvl4.CONTROL  AND
	  a.GEN_CATEGORY_OF_HEALTH_PLAN = lvl4.plan
	LEFT JOIN
		HR_826_FILEDATE_AETNA FLDT
	ON
		UPPER(a.SOURCEFILENAME)  =  UPPER(FLDT.SRCFILENAME)
	AND
		a.RECEIVEDMONTH	 = FLDT.RECEIVEDMONTH
	left join
		ZZZ_ATNA_MEM_HUMANA_UPDATE X
	ON
		UPPER(A.member_first_name)=X.MEMFIRSTNAME AND
		UPPER(A.member_prefix_name)=X.MEMLASTNAME AND
		A.member_date_of_birth=X.DOB AND
		DECODE(UPPER(A.member_gender),''M'',''M'',''F'',''F'',''U'') = X.GENDER
		';
	IF EMPID='OHMH' THEN
	vbQuery:=vbQuery||'
	left join
		ZZZ_ANTHEM_MEM_OHMH_UPDATE X1
	ON
		UPPER(A.member_first_name)=X1.MEMFIRSTNAME AND
		UPPER(A.member_last_name)=X1.MEMLASTNAME AND
		A.member_date_of_birth=X1.DOB AND
		DECODE(UPPER(A.MEMBER_GENDER),''M'',''M'',''F'',''F'',''U'')=X1.GENDER AND
		NVL(lvl3.rollupid,substr(a.HIERARCHY_LEVEL_3,-7))=X1.LVLID3
	' ;
	ELSIF EMPID in ('SWCS', 'TIRE','FIGA') THEN	--330646  3228  4867
	vbQuery:=vbQuery||'
	LEFT JOIN
		ZZZ_TWINS_AETNA_'||VLVL.SERIALNO||' TW
	ON
		UPPER(A.member_first_name)=TW.MEMFIRSTNAME
	AND
		UPPER(A.member_last_name)=TW.MEMLASTNAME
	AND
		A.member_date_of_birth=TW.DOB
	AND
		DECODE(UPPER(A.MEMBER_GENDER),''M'',''M'',''F'',''F'',''U'')=TW.GENDER
	AND
		NVL(lvl3.rollupid,substr(a.HIERARCHY_LEVEL_3,-7))=TW.LVLID3
	';

	END IF;

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('ELIG-CSTM ATNA '||EMPID,EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_AETNA_'||EMPID,'Y','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('ELIG-CSTM ATNA '||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'ELIG-MERGE ATNA '||EMPID,'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_COMM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_'||EMPID);
exception when others then
xp_scrubStatusLog ('ELIG-MERGE ATNA '||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;
---------------------------------- Start of Insert of  AETMA CA OR dropped data back ---------------------------------------------------------------

VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_'||EMPID;

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('AETNA '||EMPID||' FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_AETNA_'||EMPID,'Y','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('AETNA '||EMPID||' FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
END;
COMMIT;

END IF;
--

----- AETNA ELIG ENDS


--------- MERITAIN ELIG STARTS ICE: #194048 --------------
IF  vLvl.PAYER='MERITAIN' THEN
IF EMPID='BTLR' THEN

   	BEGIN EXECUTE IMMEDIATE 'DROP TABLE zzz_memid_update_meritain PURGE';
	EXCEPTION WHEN OTHERS THEN NULL;
	END;


  vbQuery:='
     CREATE TABLE zzz_memid_update_meritain NOLOGGING PARALLEL 4
    as
    SELECT memid,enrid,memfirstname,memlastname,gender,dob,lvl3id
    FROM(
    SELECT
	  a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'') AS MEMID,
		a.SBSCRBR_ID	AS	ENRID,
    UPPER(a.MBR_FIRST_NM) AS MEMFIRSTNAME,
		UPPER(a.MBR_LAST_NM) AS MEMLASTNAME,
		CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END AS GENDER,
		a.MBR_BRTH_DT AS DOB,
		nvl(grp.ROLLUPID,a.ACCT_NBR) AS LVL3ID,
    Row_Number() OVER (PARTITION BY UPPER(a.MBR_FIRST_NM),UPPER(a.MBR_LAST_NM),CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END
    ,a.MBR_BRTH_DT
    ORDER BY a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'')) rn
	FROM
		HI0826001.HI_ELIG_ANTHEM_BTLR a
	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.ACCT_NBR = grp.SRC_CODE)
    WHERE rn=1
    ';                    -- ICE263783
	BEGIN EXECUTE IMMEDIATE vbQuery;
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('zzz_memid_update_meritain',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
END IF ;

 VBQUERY := 'DROP TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM AS
							  SELECT
								SOURCE,
								MEMID,
								ENRID,
                                TERMDATE,
                                LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								LVLID4,
								LVLDESC4,
								PRODUCTID,
								PLANTYPE, --ICE-14795
								PLANNAME,
								UDFC21 --ICE-17438
								FROM
								VH_ELIGIBILITIES
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('ELIG TABLE CREATE MERITAIN CSTM',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_ELIG_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_173_ELIG_MRTN('HI0826001','HI_ELIG_MERITAIN_'||EMPID||'','ELIG','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_COMM');
exception when others then
xp_scrubStatusLog ('ELIG-COMM MERITAIN',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_173_ELIG_MRTN','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE 'DROP table ZZZ_COVERAGES purge'; EXCEPTION WHEN OTHERS THEN NULL; END;


EXECUTE IMMEDIATE 'CREATE TABLE ZZZ_COVERAGES NOLOGGING AS
SELECT
	INSURED_ID,SOURCEFILENAME,MED_COV_CODE,DEN_COV_CODE, VIS_COV_CODE,RECEIVEDMONTH
FROM
	HI0826001.HI_ELIG_MERITAIN_'||EMPID||' WHERE RECORD_TYPE = ''01''
GROUP BY
	INSURED_ID,SOURCEFILENAME,MED_COV_CODE,DEN_COV_CODE, VIS_COV_CODE,RECEIVEDMONTH';

	EXECUTE IMMEDIATE 'ALTER TABLE ZZZ_COVERAGES ADD PRIMARY KEY(INSURED_ID,SOURCEFILENAME,RECEIVEDMONTH)';

BEGIN

FOR TBL IN
(
	SELECT 'MED_COV_CODE' AS COVERAGE,'MED_EFFECTIVE' AS COVERAGE_EFF,'MED_TERMINATION' AS COVERAGE_TERM,'MED' AS COVTYPEID,'MEDICAL' AS COVTYPEDESC FROM dual
	UNION ALL
	SELECT 'DEN_COV_CODE' AS COVERAGE,'DEN_EFFECTIVE' AS COVERAGE_EFF,'DEN_TERMINATION' AS COVERAGE_TERM,'DEN' AS COVTYPEID ,'DENTAL' AS COVTYPEDESC FROM dual
	UNION ALL
	SELECT 'VIS_COV_CODE' AS COVERAGE,'VIS_EFFECTIVE' AS COVERAGE_EFF,'VIS_TERMINATION' AS COVERAGE_TERM,'VIS' AS COVTYPEID ,'VISION' AS COVTYPEDESC FROM dual
)

LOOP

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
        TERMDATE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		PRODUCTID,
		PLANTYPE,
		PLANNAME,
		UDFC21 --ICE-17438
	)
	SELECT /*+ PARALLEL(a,4) */
		 A.ROWID||'''||TBL.COVTYPEID||''' AS SRCROWID,    -----ice 339000
		 ''MERITAIN'' AS source,';

	IF EMPID = 'BTLR' THEN
	vbQuery:= vbQuery||'
	COALESCE(mem.memid,NVL(a.INSURED_ID||DECODE(UPPER(a.GENDER),''M'',''M'',''F'',''F'',''U'')|| TO_CHAR(a.DATE_OF_BIRTH ,''YYYYMMDD''),''MEMBERID'')) AS MEMID,
	COALESCE(mem.enrid,NVL(a.INSURED_ID,''EMPLOYEEID'')) AS ENRID,
	';
	ELSE
	vbQuery:= vbQuery||'
	NVL(a.INSURED_ID||DECODE(UPPER(a.GENDER),''M'',''M'',''F'',''F'',''U'')|| TO_CHAR(a.DATE_OF_BIRTH ,''YYYYMMDD''),''MEMBERID'') AS MEMID,
	NVL(a.INSURED_ID,''EMPLOYEEID'') AS ENRID,';
	END IF;
   IF EMPID = 'BTLR' THEN
	vbQuery:= vbQuery||'
    --ICE 3967  --defect ice 4702
CASE WHEN
CASE WHEN NVL('||TBL.COVERAGE_TERM||',TO_DATE(''9999-12-31'',''YYYY-MM-DD''))>=fldt.FILEENDDATE THEN Last_day(fldt.FILEENDDATE) ELSE NVL('||TBL.COVERAGE_TERM||',TO_DATE(''9999-12-31'',''YYYY-MM-DD'')) END  >=  TO_DATE(''2018-12-31'',''YYYY-MM-DD'')
THEN TO_DATE(''2018-12-31'',''YYYY-MM-DD'')
  ELSE
CASE WHEN NVL('||TBL.COVERAGE_TERM||',TO_DATE(''9999-12-31'',''YYYY-MM-DD''))>=fldt.FILEENDDATE THEN Last_day(fldt.FILEENDDATE) ELSE NVL('||TBL.COVERAGE_TERM||',TO_DATE(''9999-12-31'',''YYYY-MM-DD'')) END  END
AS termdate,';
ELSIF EMPID IN ('ALTM') THEN   --Added as per ICE 5770
vbQuery:= vbQuery||'
   CASE WHEN
CASE WHEN NVL('||TBL.COVERAGE_TERM||',TO_DATE(''9999-12-31'',''YYYY-MM-DD''))>=fldt.FILEENDDATE THEN Last_day(fldt.FILEENDDATE) ELSE NVL('||TBL.COVERAGE_TERM||',TO_DATE(''9999-12-31'',''YYYY-MM-DD'')) END  >=  TO_DATE(''2018-12-31'',''YYYY-MM-DD'')
THEN TO_DATE(''2018-12-31'',''YYYY-MM-DD'')
  ELSE
CASE WHEN NVL('||TBL.COVERAGE_TERM||',TO_DATE(''9999-12-31'',''YYYY-MM-DD''))>=fldt.FILEENDDATE THEN Last_day(fldt.FILEENDDATE) ELSE '||TBL.COVERAGE_TERM||' END  END
AS termdate,';
 ELSE
 vbQuery:= vbQuery||'
 CASE WHEN NVL('||TBL.COVERAGE_TERM||',TO_DATE(''9999-12-31'',''YYYY-MM-DD''))>=fldt.FILEENDDATE THEN Last_day(fldt.FILEENDDATE)  ELSE  '||TBL.COVERAGE_TERM||' END AS TERMDATE,';
 END IF;
 vbQuery:= vbQuery||'
	''C'' AS LVL1ID,
		 ''Commercial'' AS LVL1Desc,
     CASE WHEN NVL(lvl3.rollupid,a.group1) = ''003321010'' THEN
     ''POS''
	 when NVL(lvl3.rollupid,a.group1) = ''ALTM'' THEN nvl(lvl4.rollup_id2, A.med_plan_desc)    ---ICE 339000
     ELSE
		 decode(substr(NVL(lvl4.Rollup_desc ,a.MED_PLAN_DESC),-5),''OPT 1'',''PPO'',''OPT 2'',''HDHP'') END AS LVL2ID,
     CASE WHEN NVL(lvl3.rollupid,a.group1) = ''003321010'' THEN
     ''POS''
	 when NVL(lvl3.rollupid,a.group1) = ''ALTM'' THEN nvl(lvl4.rollup_desc2, A.med_plan_desc)
     ELSE
		 decode(substr(NVL(lvl4.Rollup_desc ,a.MED_PLAN_DESC),-5),''OPT 1'',''PPO'',''OPT 2'',''HDHP'') END AS LVL2Desc,
		  NVL(lvl3.rollupid,a.group1) LVL3ID,
		  NVL(lvl3.GROUP_NAME,a.group1)  AS LVL3Desc,
		  NVL(lvl4.Rollup_id ,a.MED_PLAN_DESC)  AS LVLID4,
		  substr(NVL(lvl4.rollup_desc ,a.MED_PLAN_DESC),1,50) AS LVLDesc4,
		  ''1'' AS PRODUCTID,
		  CASE WHEN lvl3.rollupid=''ALTM'' and UPPER(a.MED_PLAN_TYPE)=''HLT'' THEN
		  ''PPO'' ELSE  --ICE-14795
		  a.MED_PLAN_TYPE END AS PLANTYPE,
		a.MED_PLAN_DESC AS PLANNAME,
		a.INSURED_ID AS UDFC21 --ICE-17438

		FROM
		HI0826001.HI_ELIG_MERITAIN_'||EMPID||'  A
 LEFT JOIN
ZZZ_COVERAGES B
	ON
		A.INSURED_ID = B.INSURED_ID
	AND
		A.SOURCEFILENAME = B.SOURCEFILENAME
	AND
		A.RECEIVEDMONTH = B.RECEIVEDMONTH
	LEFT JOIN
		HR_826_FILEDATE_MRTN_STD fldt
	ON
		A.RECEIVEDMONTH = fldt.RECEIVEDMONTH
	AND
		A.SOURCEFILENAME = fldt.SRCFILENAME
	AND
		UPPER(fldt.PAYER) = ''MERITAIN_STD''
    left join
		HR_826_GROUP lvl3
		on
		substr(a.group1,1,5) = lvl3.SRC_CODE
		left join
		hr_826_Meritain_lvl4 lvl4
		on
    substr(a.group1,1,5) = lvl4.GROUP_NUM
    and
		a.MED_PLAN_DESC  = lvl4.MED_PLAN_DESC';
  IF EMPID = 'BTLR' THEN
	vbQuery:= vbQuery||'
    left join zzz_memid_update_meritain mem
    on
    UPPER(NVL(SUBSTR(a.FIRST_AND_MIDDLE,1,INSTR(a.FIRST_AND_MIDDLE,'' '')-1),A.FIRST_AND_MIDDLE)) = mem.memfirstname
    and
    UPPER(a.LAST_NAME) = mem.memlastname
    and
    CASE WHEN UPPER(a.GENDER) IN (''M'',''F'') THEN UPPER(a.GENDER) ELSE ''U'' END = mem.gender
    and
    TRUNC(a.DATE_OF_BIRTH) = mem.dob
    ';
	END IF;
vbQuery := vbQuery ||
	'
	 WHERE
		NVL(B.'||TBL.COVERAGE||', a.'||TBL.COVERAGE||') IS NOT NULL
		';
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('ELIG-CSTM MERITAIN',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('ELIG-CSTM MERITAIN',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
END;
END LOOP;
 END
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'ELIG-MERGE MERITAIN','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_COMM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_MERT');
exception when others then
xp_scrubStatusLog ('ELIG-MERGE MERITAIN',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

---------------------------------- Start of Insert of  AETMA CA OR dropped data back ---------------------------------------------------------------

VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_MERT';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('AETNA MERITAIN FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('AETNA MERITIAN FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
END;
COMMIT;

END IF;
----- MERITAIN ELIG ENDS ICE #194048 -----------

--------------------------------------CIGNA ELIG STARTS HERE (ICE 1798)------------------------------------------------------------------------------
---------------------------------------------- CIGNA implementation starts (ICE 1798 STARTS)---------------------
IF  vLvl.PAYER='CIGNA' THEN

	VBQUERY := 'DROP TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM PURGE';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM AS
	SELECT
		Source,
		MemID,
		EnrID,
		LVLID1,
		LVLDesc1,
		LVLID2,
		LVLDesc2,
		LVLID3,
		LVLDesc3,
		LVLID4,
		LVLDesc4,
		PRODUCTID,
		UDFC4,
		UDFC21 --ICE-17438
	FROM
		VH_ELIGIBILITIES
	WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ELIG TABLE CREATE CGNA CSTM',EMPID,'CGNA',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMCGNA_ELIG_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	begin
		SP_PYR_200_ELIG_CGNA('HI0826001','HI_ELIG_CGNA_'||EMPID||'','ELIG','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_COMM');
		exception when others then
		xp_scrubStatusLog ('ELIG-COMM CGNA',EMPID,'CGNA',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_200_ELIG_CGNA','','E');
	end;
	COMMIT;

	vbQuery:=
	'
	INSERT INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM TBL
	(
	    SRCROWID,
		Source,
		MemID,
		EnrID,
		LVLID1,
		LVLDesc1,
		LVLID2,
		LVLDesc2,
		LVLID3,
		LVLDesc3,
		LVLID4,
		LVLDesc4,
		PRODUCTID,
		UDFC4,
		UDFC21 --ICE-17438
	)
	SELECT
	    a.ROWID AS SRCROWID,
		''CIGNA'' AS Source,
		a.SSN ||DECODE(UPPER(a.SEX),''F'',''F'',''M'',''M'',''U'')||TO_CHAR(a.DOB,''YYYYMMDD'')||''-''||grp.rollupid AS MemID,
		a.SSN||''-''||grp.rollupid  AS ENRID ,
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		Nvl(lvl2.ROLLUP_PLANID, a.BENPLAN)  AS LVLID2,
		Nvl(lvl2.ROLLUP_PLANNAME, a.BENPLAN)  AS LVLDESC2,
		Nvl(grp.ROLLUPID, a.ACCTNUM) AS LVLID3,
		Nvl(grp.GROUP_NAME, a.ACCTNUM) AS LVLDESC3,
		Nvl(lvl4.ROLLUP_BRANCHID, a.BRANCH)  AS LVLID4,
		Nvl(lvl4.ROLLUP_BRANCHNAME, a.BRANCH)  AS LVLDESC4,
		''1'' AS PRODUCTID,
		A.PATNUM AS UDFC4,
		a.SSN AS UDFC21 --ICE-17438
	FROM
		HI0826001.HI_ELIG_CGNA_'||EMPID||' a

	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.ACCTNUM = grp.SRC_CODE

	LEFT JOIN
		HR_826_CIGNA_LVL2 lvl2
	ON
		Upper(a.BENPLAN) = lvl2.SRC_PLANID
		AND
		grp.ROLLUPID =lvl2.GROUPID

    LEFT JOIN
		HR_826_CIGNA_LVL4 lvl4
	ON
		Upper(a.BRANCH) = lvl4.SRC_BRANCHID
		AND
		grp.ROLLUPID =lvl4.GROUPID

	';

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('ELIG-CSTM CGNA',EMPID,'CGNA','','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ELIG-CSTM CGNA',EMPID,'CGNA',SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

	begin
		SP_CDF_TBL_MERGE(USER,'ELIG-MERGE CGNA','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_COMM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CGNA');
		exception when others then
		xp_scrubStatusLog ('ELIG-MERGE CGNA',EMPID,'CGNA',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	end;
	COMMIT;

	VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='INSERT INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CGNA';

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('CGNA FINAL INSERT',EMPID,'CGNA','','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('CGNA FINAL INSERT',EMPID,'CGNA',SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
-------------------------------------------------------------------------------------------------

--- To handle twin case for CIGNA groups ICE 1798-------------------------

	vbquery:='DROP TABLE ZZZ_ELIG_CGNA_TWINS_'||vLvl.SERIALNO||' PURGE';
	BEGIN
		EXECUTE IMMEDIATE vbQuery;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	vbQuery:='CREATE TABLE ZZZ_ELIG_CGNA_TWINS_'||vLvl.SERIALNO||'
	(

		SOURCE       VARCHAR2(20) NULL,
		ENRID        VARCHAR2(20) NULL,
		MEMFIRSTNAME VARCHAR2(30) NULL,
		MEMLASTNAME  VARCHAR2(30) NULL,
		DOB          DATE         NULL,
		GENDER       VARCHAR2(1)  NULL,
		MEMID        VARCHAR2(50) NULL,
		NEWMEMID    VARCHAR2(50) NULL,
		LVLID3 		VARCHAR2(50),
		UDFC4 		VARCHAR2(20) NULL,
		PRIMARY KEY (LVLID3,ENRID,MEMFIRSTNAME,MEMLASTNAME,DOB)
	)  NOLOGGING';

	BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('ELIG TWINS',EMPID,'CGNA','','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ELIG TWINS',EMPID,'CGNA',SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

	vbQuery:='INSERT /*+parallel(a,4)*/ INTO ZZZ_ELIG_CGNA_TWINS_'||vLvl.SERIALNO||' a
	(
		SOURCE, ENRID, MEMFIRSTNAME, MEMLASTNAME,DOB, GENDER, MEMID, NEWMEMID,LVLID3,UDFC4
	)
		SELECT /*+parallel(a,4)*/
			SOURCE,ENRID,MEMFIRSTNAME,MEMLASTNAME,DOB,GENDER,MEMID,SUBSTR(MEMID||UDFC4,1,50) NEWMEMID ,LVLID3,UDFC4
		FROM
		(
			SELECT
				SOURCE, ENRID, MEMFIRSTNAME, MEMLASTNAME,DOB, GENDER, MEMID,LVLID3,UDFC4,
				Row_Number() OVER(PARTITION BY LVLID3,ENRID, MEMFIRSTNAME,MEMLASTNAME,DOB ORDER BY EFFDATE desc,TERMDATE desc,UDFC4)    rn
			FROM
			(
			SELECT DISTINCT
				SOURCE,ENRID, Nvl(SubStr(UPPER(MEMFIRSTNAME),1,InStr(UPPER(MEMFIRSTNAME),'' '')-1),MEMFIRSTNAME) memfirstname,memlastname,dob,gender,MEMID,LVLID3,
				UDFC4,effdate,termdate
			FROM
				VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
			WHERE RELFLAG=''D'' and (source,memid) IN
				(
				SELECT source,memid
				FROM  VH_ELIGIBILITIES_'||vLvl.SERIALNO||' a
				GROUP BY source,memid
				HAVING COUNT(DISTINCT Nvl(SubStr(UPPER(MEMFIRSTNAME),1,InStr(UPPER(MEMFIRSTNAME),'' '')-1),MEMFIRSTNAME))>1 AND COUNT(DISTINCT UDFC4)>1
				)
			)
		)
	WHERE rn=1	';

	BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('ELIG TWINS UPD',EMPID,'CGNA','','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ELIG TWINS UPD',EMPID,'CGNA',SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

	--vbQuery:='MERGE INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  a
	--USING
	--	ZZZ_ELIG_CGNA_TWINS_'||vLvl.SERIALNO||' b
	--ON
	--(
	--	a.MemFirstName = b.MemFirstName AND
	--	a.MemLastName = b.MemLastName AND
	--	a.Gender = b.Gender AND
	--	a.DOB = b.DOB AND
	--	a.LVLID3=b.LVLID3 and
	--	a.enrid
	--)
	--WHEN MATCHED THEN UPDATE
	--SET
	--a.MemID=b.NEWMEMID ';
	--ICE-16366
	vbQuery:='MERGE /*+PARALLEL(A,4)*/ INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||' A
		USING
			(
			SELECT /*+PARALLEL(A,4)*/
				SOURCE,MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ,LVLID3,NEWMEMID
			FROM
				ZZZ_ELIG_CGNA_TWINS_'||vLvl.SERIALNO||' A )S
			ON
			(
				A.LVLID3=S.LVLID3
				AND A.ENRID=S.ENRID
				AND A.DOB = s.DOB
				AND A.Gender = s.Gender
				AND A.MemFirstName = s.MemFirstName
				AND A.RelFlag = ''D''
			)
			WHEN MATCHED THEN UPDATE SET
				A.MEMID = S.NEWMEMID
			';


	BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('ELIG TWINS MERGE',EMPID,'CGNA','','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ELIG TWINS MERGE',EMPID,'CGNA',SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

	vbQuery:='UPDATE VH_ELIGIBILITIES_'||vLvl.SERIALNO||' SET UDFC4=''''';

	BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('ELIG',EMPID,'CGNA','','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ELIG',EMPID,'CGNA',SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

END IF;
--------------------------------------CIGNA ELIG ENDS HERE (ICE 1798)-------------------------------------

-------------------New payer : NORTH_AMERICAN_ADMIN (ICE 18475 ) starts
IF  vLvl.PAYER='NRAA' THEN

VBQUERY := 'DROP TABLE VH_ELIG_'||vLvl.SERIALNO||'_NRAA_CSTM PURGE';
		BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_ELIG_'||vLvl.SERIALNO||'_NRAA_CSTM AS
	SELECT
		SOURCE,
		MEMID,
		ENRID,
		TERMDATE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		PLANTYPE,
		PLANNAME,
		PRODUCTID
		FROM
		VH_ELIGIBILITIES
	WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG TABLE CREATE NRAA',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_ELIG_'||vLvl.SERIALNO||'_NRAA_CSTM ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_ELIG_'||vLvl.SERIALNO||'_NRAA_CSTM ADD CONSTRAINT PK_CSTM_ELIG_NRAA_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	BEGIN
		SP_PYR_5230_ELIG_NRAA('HI0826001','HI_ELIG_NRAA_5230_'||EMPID||'','ELIG','VH_ELIG_'||vLvl.SERIALNO||'_NRAA_COMM');   
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG-COMM NRAA',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_5230_ELIG_NRAA','','E'); 
	END;

	COMMIT;
----------------------------------------------------------------------------------------------------------

	vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_ELIG_'||vLvl.SERIALNO||'_NRAA_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		TERMDATE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		PLANTYPE,
		PLANNAME,
		PRODUCTID
		 
	)
	SELECT
		a.ROWID AS SRCROWID,
		''NORTH_AMERICAN_ADMIN'' AS Source,
		SubStr(replace(a.enrid,'' ''),1,10) || Decode(Upper(a.GENDER),''M'',''M'',''F'',''F'',''U'') || To_Char(a.DOB,''YYYYMMDD'')||''-''||nvl(grp.ROLLUPID,a.EMP_NBR) AS MemID,
		SubStr(replace(a.enrid,'' ''),1,10)||''-''||nvl(grp.ROLLUPID,a.EMP_NBR) as ENRID,
		CASE WHEN NVL(A.TERMDATE, To_Date(''99991231'', ''YYYYMMDD'')) >= LAST_DAY(TO_DATE(SUBSTR(REPLACE(a.SOURCEFILENAME,''.txt''),-8),''YYYYMMDD''))   THEN  LAST_DAY(TO_DATE(SUBSTR(REPLACE(a.SOURCEFILENAME,''.txt''),-8),''YYYYMMDD'')) ELSE a.TERMDATE END as termdate,
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		NVL(lv.rollup_plan_code, a.Plan_id ) AS LVLID2,
		NVL(lv.rollup_plan_desc, a.Plan_id ) AS LVLDESC2,
		nvl(grp.ROLLUPID,a.EMP_NBR) AS LVLID3,
		nvl(grp.Group_Name,a.EMP_NBR) AS LVLDESC3,
		NVL(div.ROLLUP_DIV_ID,a.DIVISIONNAME) AS LVLID4,
		NVL(div.ROLLUP_DIVISION ,a.DIVISIONNAME) AS LVLDESC4,
		lv.PLANTYPE PLANTYPE ,
		lv.rollup_plan_desc PLANNAME,
		''1'' AS PRODUCTID --in hr_global_productLine 1 prodID is mapped as commercial
		
	FROM
		HI0826001.HI_ELIG_NRAA_5230_'||EMPID||' a   
    LEFT JOIN
		HR_826_GROUP grp
	ON
		a.EMP_NBR = grp.SRC_CODE

	left JOIN
		HR_826_NRAA_LVL_PLAN  lv
	ON
		a.plan_id =lv.src_plan_code 
	and nvl(grp.ROLLUPID,a.EMP_NBR)=lv.groupid 
    LEFT JOIN
		HR_826_NRAA_LVL_DIV  div
	ON
		Upper(replace(a.DIVISIONNAME,'' ''))=div.SOURCE_DIVISION
	and nvl(grp.ROLLUPID,a.EMP_NBR)=div.group_id
	';

	BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('ELIG-CSTM NRAA',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_NRAA_5230_'||EMPID,'Y','I');  
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG-CSTM NRAA',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
------------------------------------------------------------------------------------------------------------------
	BEGIN
		SP_CDF_TBL_MERGE(USER,'ELIG-MERGE NRAA','VH_ELIG_'||vLvl.SERIALNO||'_NRAA_COMM','VH_ELIG_'||vLvl.SERIALNO||'_NRAA_CSTM','VH_ELIG_'||vLvl.SERIALNO||'_NRAA');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ELIG-MERGE NRAA',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	END;
	COMMIT;

---------------------------------- Start of Insert of  NRAA OR dropped data back ---------------------------------------------------------------

	VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='INSERT INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_ELIG_'||vLvl.SERIALNO||'_NRAA';

	BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('NRAA ELIG FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_NRAA_5230_'||EMPID,'Y','I');        
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('NRAA ELIG FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

--------------------------------------------------------------------------------------------------------------

END IF;


-------------------New payer : NORTH_AMERICAN_ADMIN (ICE 18475 ) ends

--------- MMOH ELIG STARTS ICE: #223052 --------------
IF  vLvl.PAYER='MMOH' THEN

--------------------------------------------ICE-5643--------------------------------------------
IF EMPID IN ('MEVS') THEN
BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE ZZZ_UHC_E2E_MEMUPD_'||EMPID||' PURGE';
        EXCEPTION WHEN OTHERS THEN NULL;
END;

vbQuery:='CREATE TABLE ZZZ_UHC_E2E_MEMUPD_'||EMPID||' AS
	SELECT
		MEMID,
		JOIN_MEMID,
		ENRID,
		LVLID3,
		LVLDESC3,
		MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB
	FROM(
		SELECT
			DISTINCT COALESCE(TWIN_UHC.NEW_MEMID,SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID'') AS MemID,
			SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD'') AS JOIN_MEMID,
			COALESCE(SUBSTR(a.EMPLOYEENUMBER,-9),''EMPLOYEEID'') AS ENRID,
			nvl(grp.ROLLUPID,a.Customerstructure1) AS LVLID3,
			nvl(grp.Group_Name,a.Customerstructure1) AS LVLDESC3,
			UPPER(a.FIRSTNAME) AS MEMFIRSTNAME,
			UPPER(a.LASTNAME) AS MEMLASTNAME,
			CASE WHEN a.SEX IN (''F'',''M'') THEN a.SEX ELSE ''U'' END AS GENDER,
			a.BIRTHDATE AS DOB,
			Row_Number() OVER (PARTITION BY UPPER(a.FIRSTNAME),	UPPER(a.LASTNAME) ,CASE WHEN a.SEX IN (''F'',''M'') THEN a.SEX ELSE ''U'' END, a.BIRTHDATE,nvl(grp.ROLLUPID,a.Customerstructure1)
			ORDER BY a.COVERAGESTARTDATE,Nvl(A.COVERAGESTOPDATE, To_Date(A.RECEIVEDMONTH, ''YYYYMM'') -1)) rn
	FROM
		HI0826001.HI_ELIG_UHC_036_'||EMPID||' a
	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.CUSTOMERSTRUCTURE1 = grp.SRC_CODE
	LEFT JOIN
		ZZZ_UHC_'||EMPID||'_TWIN TWIN_UHC
	ON
		UPPER(a.FIRSTNAME) = TWIN_UHC.MEMFIRSTNAME
	AND
		UPPER(a.LASTNAME) = TWIN_UHC.MEMLASTNAME
	AND
		CASE WHEN a.SEX IN (''F'',''M'') THEN a.SEX ELSE ''U'' END = TWIN_UHC.GENDER
	AND
		a.BIRTHDATE = TWIN_UHC.DOB
	AND
		nvl(grp.ROLLUPID,a.Customerstructure1) = TWIN_UHC.LVL3ID
		) WHERE RN=1';
-------------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('UHC MEMID UPDATE TABLE CREATED',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	 END;
	 COMMIT;

	VBQUERY:='ALTER TABLE ZZZ_UHC_E2E_MEMUPD_'||EMPID||'  ADD PRIMARY KEY(MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVLID3)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

END IF;
-------------------------------------------------------------------------------------------------
BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE ZZZ_MMOH_'||EMPID||'_TWIN_1 PURGE';
        EXCEPTION WHEN OTHERS THEN NULL;
END;

BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE ZZZ_MMOH_'||EMPID||'_TWIN PURGE';
        EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE ZZZ_MMOH_'||EMPID||'_TWIN_1 NOLOGGING PARALLEL 4 AS
	SELECT /*+PARALLEL(A,4)*/
		NVL(lvl3.rollupid,SubStr(A.ELIG_GROUP,1,6)) LVLID3,
		a.EMPLOYEE_ID||CASE WHEN LVL3.memid_grp_flag=''Y'' THEN ''-''||lvl3.ROLLUPID END AS ENRID,
		Upper(a.ELIG_FNAME) AS MEMFIRSTNAME,
		Upper(a.ELIG_LNAME) AS MEMLASTNAME,
		Decode(a.ELIG_SEX,''1'',''M'',''2'',''F'',''U'') AS GENDER,
		a.DATE_OF_BIRTH AS DOB,
		a.EMPLOYEE_ID||Decode(a.ELIG_SEX,''1'',''M'',''2'',''F'',''U'')||To_Char(a.DATE_OF_BIRTH,''YYYYMMDD'')||CASE WHEN LVL3.memid_grp_flag=''Y'' THEN ''-''||lvl3.ROLLUPID END  MEMID,
		a.EMPLOYEE_ID||Decode(a.ELIG_SEX,''1'',''M'',''2'',''F'',''U'')||To_Char(a.DATE_OF_BIRTH,''YYYYMMDD'')||''-''|| A.ELIG_DEP_NBR||CASE WHEN LVL3.memid_grp_flag=''Y'' THEN ''-''||lvl3.ROLLUPID END  NEW_MEMID,
		CASE WHEN Nvl(A.ELIG_COV_CANC_DT,To_Date(''99991231'',''YYYYMMDD'')) > Last_Day(To_Date(SubStr(a.SOURCEFILENAME,25,6),''YYYYMM'')) THEN
      Last_Day(To_Date(SubStr(a.SOURCEFILENAME,25,6),''YYYYMM'')) ELSE A.ELIG_COV_CANC_DT END as TERMDATE,
	  a.ELIG_COV_EFF AS EFFDATE
	FROM
		HI0826001.HI_ELIG_MMOH_'||EMPID||'  A
	LEFT JOIN
		HR_826_GROUP lvl3
	ON
		--SubStr(A.ELIG_GROUP,1,6) = lvl3.SRC_CODE
		 CASE WHEN '''||EMPID||''' IN   (''ESCC'',''CSCC'') THEN A.ELIG_GROUP ELSE SubStr(A.ELIG_GROUP,1,6) END = lvl3.SRC_CODE
	WHERE
		a.EMPLOYEE_ID ||Upper(a.ELIG_LNAME) ||a.DATE_OF_BIRTH||Decode(a.ELIG_SEX,''1'',''M'',''2'',''F'',''U'') IN
		(
			SELECT /*+PARALLEL(A,4)*/
				a.EMPLOYEE_ID ||Upper(a.ELIG_LNAME) ||a.DATE_OF_BIRTH||Decode(a.ELIG_SEX,''1'',''M'',''2'',''F'',''U'')
			FROM
				HI0826001.HI_ELIG_MMOH_'||EMPID||' a
			GROUP BY a.EMPLOYEE_ID ||Upper(a.ELIG_LNAME) ||a.DATE_OF_BIRTH||Decode(a.ELIG_SEX,''1'',''M'',''2'',''F'',''U'')
			HAVING
			(
				COUNT(DISTINCT Upper(a.ELIG_FNAME))>1
				AND
				COUNT(DISTINCT A.ELIG_DEP_NBR)>1
			)
		)
	ORDER BY 2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE ZZZ_MMOH_'||EMPID||'_TWIN nologging parallel 4 AS
			SELECT LVLID3, ENRID, MEMFIRSTNAME, MEMLASTNAME, DOB, GENDER, MEMID, NEW_MEMID FROM
				( SELECT LVLID3, ENRID, MEMFIRSTNAME, MEMLASTNAME, DOB, GENDER, MEMID, NEW_MEMID,
				  ROW_NUMBER() OVER (PARTITION BY LVLID3, MEMFIRSTNAME, MEMLASTNAME, DOB, GENDER ORDER BY TERMDATE DESC NULLS LAST, EFFDATE DESC ) RN
				  FROM ZZZ_MMOH_'||EMPID||'_TWIN_1 )
			WHERE RN = 1';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;


VBQUERY:='ALTER TABLE ZZZ_MMOH_'||EMPID||'_TWIN ADD PRIMARY KEY(MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVLID3)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

--------------------------------------------ICE-5643--------------------------------------------

 VBQUERY := 'DROP TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM AS
							  SELECT
								SOURCE,
								TERMDATE,
								LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								LVLID4,
								LVLDESC4,
								COVERAGESTATUS,	--ICE 239230
								PLANTYPE,
								PLANNAME,
								PRODUCTID,
								MEMID,--ICE-5643
								ENRID,--ICE-5643
								UDFC21 --ICE-17438
								FROM
								VH_ELIGIBILITIES
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('ELIG TABLE CREATE MMOH CSTM',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_ELIG_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_4562_ELIG_MMOH('HI0826001','HI_ELIG_MMOH_'||EMPID||'','ELIG','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_COMM');  --ICE240303
exception when others then
xp_scrubStatusLog ('ELIG-COMM MMOH',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_2246_ELIG_MMOH','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
    TERMDATE,      ---ICE244604
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		COVERAGESTATUS,	--ICE 239230
		PLANTYPE,
		PLANNAME,
		PRODUCTID,
		MEMID,--ICE-5643
		ENRID,--ICE-5643
		UDFC21 --ICE-17438
	)
	SELECT /*+ PARALLEL(a,4) */---fix for IT
		  a.ROWID AS SRCROWID,
		  ''MMOH'' AS source,
      CASE WHEN Nvl(A.ELIG_COV_CANC_DT,To_Date(''99991231'',''YYYYMMDD'')) > Last_Day(To_Date(SubStr(a.SOURCEFILENAME,25,6),''YYYYMM'')) THEN
      Last_Day(To_Date(SubStr(a.SOURCEFILENAME,25,6),''YYYYMM'')) ELSE A.ELIG_COV_CANC_DT END as TERMDATE,      ---ICE244604
		  ''C'' AS LVL1ID,
		  ''Commercial'' AS LVL1Desc,
		  NVL(LVL2.ROLLUP_ID, SubStr(A.ELIG_GROUP,1,6)|| SubStr(A.ELIG_GROUP,7,3)) AS LVL2ID,
		  NVL(LVL2.ROLLUP_DESC, SubStr(A.ELIG_GROUP,1,6)|| SubStr(A.ELIG_GROUP,7,3)) AS LVL2Desc,
		  NVL(lvl3.rollupid,SubStr(A.ELIG_GROUP,1,6)) LVL3ID,
		  NVL(lvl3.GROUP_NAME,SubStr(A.ELIG_GROUP,1,6))  AS LVL3Desc,
		  NVL(lvl4.Rollup_id ,a.ELIG_OUT_CONTR_TYPE)  AS LVLID4,
		  substr(NVL(lvl4.rollup_desc ,a.ELIG_OUT_CONTR_TYPE),1,50) AS LVLDesc4,
		  NVL(LVL2.STATUS,''ACTIVE'') AS COVERAGESTATUS,	--ICE 239230
		  NVL(LVL2.PLANTYPE, SubStr(A.ELIG_GROUP,1,6)|| SubStr(A.ELIG_GROUP,7,3)) AS PLANTYPE,	--ICE 239230
		  NVL(LVL2.ROLLUP_DESC, SubStr(A.ELIG_GROUP,1,6)|| SubStr(A.ELIG_GROUP,7,3)) AS PLANNAME,
		  ''1'' AS PRODUCTID,';
		  IF EMPID IN ('MEVS') THEN
	vbQuery := vbQuery||'	COALESCE(MEMUPD.MEMID,TWINS.NEW_MEMID,a.EMPLOYEE_ID||Decode(a.ELIG_SEX,''1'',''M'',''2'',''F'',''U'')||To_Char(a.DATE_OF_BIRTH,''YYYYMMDD'')||CASE WHEN LVL3.memid_grp_flag=''Y'' THEN ''-''||lvl3.ROLLUPID END)
	';
		  ELSIF EMPID IN ('PIQU', 'WECS', 'ESCC', 'CSCC') THEN --ICE#13475
	vbQuery := vbQuery||'	COALESCE(TWINS.NEW_MEMID,a.EMPLOYEE_ID||Decode(a.ELIG_SEX,''1'',''M'',''2'',''F'',''U'')||To_Char(a.DATE_OF_BIRTH,''YYYYMMDD'')||CASE WHEN LVL3.memid_grp_flag=''Y'' THEN ''-''||lvl3.ROLLUPID END)
	';
	ELSE
	vbQuery := vbQuery||'
		  a.EMPLOYEE_ID||Decode(a.ELIG_SEX,''1'',''M'',''2'',''F'',''U'')||To_Char(a.DATE_OF_BIRTH,''YYYYMMDD'')||CASE WHEN LVL3.memid_grp_flag=''Y'' THEN ''-''||lvl3.ROLLUPID END
		  ';
		END IF;
		vbQuery:=vbQuery||
		'
	AS MEMID,--ICE-5643
		  ';
	IF EMPID IN ('MEVS') THEN
	vbQuery := vbQuery||
	'COALESCE(MEMUPD.ENRID,a.EMPLOYEE_ID||CASE WHEN LVL3.memid_grp_flag=''Y'' THEN ''-''||lvl3.ROLLUPID END)
	';
	ELSE
	vbQuery := vbQuery||'a.EMPLOYEE_ID||CASE WHEN LVL3.memid_grp_flag=''Y'' THEN ''-''||lvl3.ROLLUPID END
		   ';
		END IF;
		vbQuery:=vbQuery||
		' AS ENRID,--ICE-5643
		a.EMPLOYEE_ID AS UDFC21 --ICE-17438
		FROM
		HI0826001.HI_ELIG_MMOH_'||EMPID||'  A
		LEFT JOIN
		HR_826_MMOH_LVL2 LVL2
		ON
		SubStr(A.ELIG_GROUP,1,6) = LVL2.SRC_GROUP_CODE
		AND
		SubStr(A.ELIG_GROUP,7,3) = LVL2.SECTION_CODE
		LEFT JOIN
		HR_826_GROUP lvl3
		ON
		--SubStr(A.ELIG_GROUP,1,6) = lvl3.SRC_CODE
		CASE WHEN '''||EMPID||''' IN   (''ESCC'',''CSCC'') THEN A.ELIG_GROUP ELSE SubStr(A.ELIG_GROUP,1,6) END = lvl3.SRC_CODE
		LEFT JOIN
		HR_826_MMOH_LVL4 lvl4
		ON
		A.ELIG_OUT_CONTR_TYPE  = lvl4.SRC_ID
		';
		IF EMPID IN ('MEVS','PIQU', 'WECS', 'ESCC', 'CSCC') THEN --ICE#13475
	vbQuery := vbQuery||'
		LEFT JOIN
		ZZZ_MMOH_'||EMPID||'_TWIN TWINS--ICE-5643
		ON
		Upper(a.ELIG_FNAME) = TWINS.MEMFIRSTNAME
		AND
		Upper(a.ELIG_LNAME)= TWINS.MEMLASTNAME
		AND
		Decode(a.ELIG_SEX,''1'',''M'',''2'',''F'',''U'') = TWINS.GENDER
		AND
		a.DATE_OF_BIRTH = TWINS.DOB
		AND
		NVL(lvl3.rollupid,SubStr(A.ELIG_GROUP,1,6))= TWINS.LVLID3';
		END IF;
		IF EMPID IN ('MEVS') THEN --ICE#13475
	vbQuery := vbQuery||'
		LEFT JOIN
		ZZZ_UHC_E2E_MEMUPD_'||EMPID||' MEMUPD--ICE-5643
		ON
		--a.EMPLOYEE_ID||Decode(a.ELIG_SEX,''1'',''M'',''2'',''F'',''U'')||To_Char(a.DATE_OF_BIRTH,''YYYYMMDD'') = MEMUPD.JOIN_MEMID
		Upper(a.ELIG_FNAME) = MEMUPD.MEMFIRSTNAME
		AND
		Upper(a.ELIG_LNAME)= MEMUPD.MEMLASTNAME
		AND
		Decode(a.ELIG_SEX,''1'',''M'',''2'',''F'',''U'') = MEMUPD.GENDER
		AND
		a.DATE_OF_BIRTH = MEMUPD.DOB
		AND
		NVL(lvl3.rollupid,SubStr(A.ELIG_GROUP,1,6))= MEMUPD.LVLID3
	';
	END IF;
	vbQuery:=vbQuery||'
    WHERE upper(NVL(LVL2.ROLLUP_DESC, SubStr(A.ELIG_GROUP,1,6)|| SubStr(A.ELIG_GROUP,7,3))) not like upper(''%DENTAL%'')
    '
	--- ICE244604 Excluding dental plans
;
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('ELIG-CSTM MMOH',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('ELIG-CSTM MMOH',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'ELIG-MERGE MMOH','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_COMM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_CSTM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_MMOH');
exception when others then
xp_scrubStatusLog ('ELIG-MERGE MMOH',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;
-------------ICE-5643------------------------------------------------------------------------------------
IF EMPID IN ('MEVS','PIQU', 'WECS', 'ESCC', 'CSCC') THEN --ICE#13475
vbQuery:='CREATE TABLE ZZZ_E2C_E2R_MEMUPD_'||EMPID||'_MMOH AS
SELECT * FROM
(SELECT DISTINCT MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3
FROM
(
SELECT /*+PARALLEL(A,4)*/  MEMID, ENRID,  MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ,LVLID3,
			 ROW_NUMBER() OVER (PARTITION BY LVLID3, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ORDER BY ';
 IF EMPID IN ('MEVS','PIQU') THEN--ICE#13475
		vbQuery := vbQuery||'
			CASE WHEN LVLID3 IN (''MEVS'', ''WECS'') THEN EFFDATE
      			WHEN LVLID3 IN (''MEVS'', ''WECS'') THEN TERMDATE END ASC NULLS LAST,
			CASE WHEN LVLID2 NOT IN (''PIQU'') THEN  EFFDATE
				WHEN LVLID2  NOT IN  (''PIQU'') THEN  TERMDATE  END DESC NULLS LAST ';
  ELSE
    vbQuery := vbQuery||'
                  TERMDATE DESC NULLS LAST, EFFDATE DESC ';
  END IF ;
      vbQuery := vbQuery||'
 ) RN
			 FROM  VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_MMOH A ) WHERE RN=1
			 ) B
WHERE LVLID3 IN (''MEVS'',''PIQU'', ''WECS'', ''ESCC'', ''CSCC'')';--ICE#13475


BEGIN EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('MMOH E2M AND E2R MEMID UPDATE',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_MMOH_'||EMPID,'Y','I');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('MMOH E2M AND E2R MEMID UPDATE',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

END IF;
---------------------------------- Start of Insert of  AETMA CA OR dropped data back ---------------------------------------------------------------

VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

VBQUERY:='INSERT INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_MMOH';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('MMOH FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('MMOH FINAL INSERT',EMPID,VLVL.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
END;
COMMIT;

END IF;
----- MMOH ELIG ENDS ICE #223052 -----------

-------------------------Start of ICE#9467

IF  vLvl.PAYER='OUHL' THEN
IF EMPID IN ('TAVG','HAMI') THEN

BEGIN EXECUTE IMMEDIATE 'DROP TABLE zzz_ELIG_ANTHEM_'||VLVL.SERIALNO||' PURGE';
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
---------------------------------------------------------------------------------------------
	vbQuery:=
	'CREATE TABLE zzz_ELIG_ANTHEM_'||VLVL.SERIALNO||' NOLOGGING AS
	SELECT
		MEMID,
		ENRID,
		MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLID4,
		LVLDesc4,
		TERMDATE
	FROM (
SELECT
			a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'')AS MEMID,
			a.SBSCRBR_ID AS	ENRID,
			UPPER(a.MBR_FIRST_NM) AS MEMFIRSTNAME,
			UPPER(a.MBR_LAST_NM) AS MEMLASTNAME,
			CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END AS GENDER,
			a.MBR_BRTH_DT AS DOB,
			COALESCE(Sgrp.PLAN_ID,t.ROLLUP_ID ,pl.ROLLUPID)LVLID2,
			COALESCE(Sgrp.PLAN_DESC,t.ROLLUP_DESC, pl.PLAN_NAME) LVLDESC2,
			nvl(grp.ROLLUPID,a.ACCT_NBR) AS LVLID3,
			REPLACE(Nvl(Sgrp.ROLLUPID,a.ACCT_NBR||SUBSTR(A.SUBGRP_NBR,-4)),''~'') AS LVLID4,
			CASE WHEN Sgrp.ROLLUPID IS NULL THEN a.ACCT_NBR||SUBSTR(A.SUBGRP_NBR,-4) ELSE Sgrp.sub_grp_nm END AS LVLDesc4,
			CASE WHEN a.mbr_term_dt > To_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') THEN
		to_Date(substr(a.sourcefilename,InStr(a.sourcefilename,''_'',-1,2)+1,8), ''YYYYMMDD'') ELSE a.mbr_term_dt END AS TERMDATE,
			row_number() over (partition by UPPER(a.MBR_FIRST_NM), UPPER(a.MBR_LAST_NM),CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END,a.MBR_BRTH_DT, nvl(grp.ROLLUPID,a.ACCT_NBR)  order by a.MBR_EFCTV_DT desc Nulls last, 12 desc ) rn

    FROM
		HI0826001.HI_ELIG_ANTHEM_'||EMPID||' a
		LEFT JOIN
			HR_826_GROUP grp
		ON
			a.ACCT_NBR = grp.src_code
		LEFT JOIN
		HR_826_ANTHEM_SUBGRP Sgrp
	ON
		a.ACCT_NBR = Sgrp.ACCT_NBR
	AND
		SUBSTR(A.SUBGRP_NBR,-4) = Sgrp.src_code
		LEFT JOIN
		HR_826_LOA_LVL_ROLLUP t
	ON
		a.ACCT_NBR  = t.groupid
	AND
		UPPER(a.PKG_NBR) = Upper(t.PLANCODE)
	AND
		To_Char(a.MBR_EFCTV_DT,''YYYY'') = To_Char(t.effectivedate, ''YYYY'')
		LEFT JOIN
		HR_826_ANTHEM_PLAN pl
		ON
			 a.ACCT_NBR   =  pl.ACCT_NBR
			-- and UPPER(a.PKG_NBR) = UPPER(pl.src_code)
      AND --ADDED as per ICE#14348
		 Case
		 When pl.FLAG= ''Y'' AND A.mbr_efctv_dt > TO_DATE(''2018.12.31'',''YYYY.MM.DD'') THEN UPPER(SUBSTR(a.subgrp_nbr,-4))
		 WHEN grp.ROLLUPID= ''XAVI''  AND pl.FLAG IS NULL  and A.mbr_efctv_dt < TO_DATE(''2018.12.31'',''YYYY.MM.DD'')  THEN  upper(a.PROD_ID)
		 WHEN grp.ROLLUPID IN (''TRAN'', ''GROT'')  THEN substr(a.SUBGRP_NBR , -4)
		 ELSE UPPER(a.PKG_NBR) END = UPPER(pl.src_code)
		Where NVL(pl.DROP_PLAN,''N'')=''N''
		AND
		(CASE WHEN grp.ROLLUPID = ''HAMI'' THEN SUBSTR(A.SUBGRP_NBR,-4) ELSE ''1'' END NOT IN ( ''AAAV'',''AACV'') ) -- ICE 312410, 314441 (else added)
	)
	WHERE RN=1
	';
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	COMMIT;
---------------------------------------------------------------------------------------------
VBQUERY := 'alter table zzz_ELIG_ANTHEM_'||VLVL.SERIALNO||' add primary key (MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVLID3)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;
END IF;

IF EMPID IN ('RUMP','WEHI') THEN --ICE#10163 'WEHI' ADDED
----------------------------ICE 10161 MEMUPD FROM UHC STARTS------------------------------
BEGIN EXECUTE IMMEDIATE 'DROP TABLE zzz_ELIG_UHC'||VLVL.SERIALNO||' PURGE';
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
---------------------------------------------------------------------------------------------
	vbQuery:=
	'CREATE TABLE zzz_ELIG_UHC_'||VLVL.SERIALNO||' NOLOGGING AS
	SELECT
		MEMID,
		ENRID,
		MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLID4,
		LVLDesc4,
		EFFDATE,
		TERMDATE
	FROM (
SELECT
			COALESCE(SUBSTR(a.EMPLOYEENUMBER,-9)||UPPER(a.SEX)||TO_CHAR(a.BIRTHDATE,''YYYYMMDD''),''MEMBERID'') AS MEMID,
			COALESCE(SUBSTR(a.EMPLOYEENUMBER,-9),''EMPLOYEEID'') AS	ENRID,
			UPPER(a.FIRSTNAME) AS MEMFIRSTNAME,
			UPPER(a.LASTNAME) AS MEMLASTNAME,
			DECODE(UPPER(a.SEX),''M'',''M'',''F'',''F'',''U'') AS GENDER,
			a.BIRTHDATE AS DOB,
			lv.ROLLUP_PLANID AS LVLID2,
		    lv.ROLLUP_PLANNM  AS LVLDESC2,
			nvl(grp.ROLLUPID,a.Customerstructure1) AS LVLID3,
			lv.ROLLUP_SUB_GRPID AS LVLID4,
		    lv.ROLLUP_SUB_GRPNM AS LVLDESC4,
			CASE WHEN a.COVERAGESTARTDATE < d.EFFDATE THEN d.EFFDATE ELSE a.COVERAGESTARTDATE END AS EffDate,
			Nvl(A.COVERAGESTOPDATE, To_Date(A.RECEIVEDMONTH, ''YYYYMM'') -1) as TERMDATE,
			row_number() over (partition by UPPER(a.FIRSTNAME), UPPER(a.LASTNAME),DECODE(UPPER(a.SEX),''M'',''M'',''F'',''F'',''U''),a.BIRTHDATE, nvl(grp.ROLLUPID,a.Customerstructure1) order by 12 desc Nulls last,13 DESC ) rn

    FROM
		HI0826001.HI_ELIG_UHC_036_'||EMPID||' a

	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.CUSTOMERSTRUCTURE1 = grp.SRC_CODE

	left JOIN
		HR_826_ELIG_CUTOFF  d
	ON
		nvl(grp.ROLLUPID,a.CUSTOMERSTRUCTURE1) = d.grpid3

	LEFT JOIN
		HR_826_UHC_LOA lv
	ON
		a.CUSTOMERSTRUCTURE1 = lv.SRC_CD1
		AND
		a.CUSTOMERSTRUCTURE4 = lv.SRC_CD2
		WHERE NVL(lv.DROP_PLAN,''N'')=''N''
	)
	WHERE RN=1
	';
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	COMMIT;
---------------------------------------------------------------------------------------------
VBQUERY := 'alter table zzz_ELIG_UHC_'||VLVL.SERIALNO||' add primary key (MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVLID3)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;
END IF;
------------------------------------ICE 10161 TEMP TABLE FOR MEM UPDATE FROM UHC ENDS----------------------------

 VBQUERY := 'DROP TABLE VH_ELIGIBILITIES_'||VLVL.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_ELIGIBILITIES_'||VLVL.SERIALNO||'_CSTM AS
							  SELECT
								SOURCE,
								MEMID,
								ENRID,
								EFFDATE,
								TERMDATE,
								LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								LVLID4,
								LVLDESC4,
								ProductID,
								UDFC10
						   FROM
								VH_ELIGIBILITIES
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('ELIG TABLE CREATE OUHL',EMPID,VLVL.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||VLVL.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_ELIGIBILITIES_'||VLVL.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTM_ELIG_OUHL_'||VLVL.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_4610_ELIG_OUHL('HI0826001','HI_ELIG_OUHL_'||EMPID||'','ELIG','VH_ELIGIBILITIES_'||VLVL.SERIALNO||'_COMM');
exception when others then
xp_scrubStatusLog ('ELIG-COMM OUHL',EMPID,VLVL.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4610_ELIG_OUHL','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_ELIGIBILITIES_'||VLVL.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		EFFDATE,
		TERMDATE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		ProductID,
		UDFC10
	)
	SELECT /*+ PARALLEL(a,4) */
		a.ROWID AS SRCROWID,
		''OUR HEALTH'' AS source,
		substr(CASE ';
		IF EMPID IN ('TAVG','HAMI') THEN
	vbQuery := vbQuery||
		' WHEN b.MEMID IS NOT NULL THEN b.MEMID';
		ELSIF EMPID IN ('RUMP','WEHI') THEN
		vbQuery := vbQuery||
		' WHEN c.MEMID IS NOT NULL THEN c.MEMID';
END IF;		--ICE 10161
vbQuery := vbQuery||
		' WHEN a.unique_id IS NOT NULL THEN a.unique_id||DECODE(UPPER(a.GENDER),''M'',''M'',''F'',''F'',''U'')||To_Char(a.born_on,''YYYYMMDD'')||''-''||lvl3.rollupid
		ELSE SUBSTR(a.OURHEALTH_WELLNESS_ID,1,30)||DECODE(UPPER(a.GENDER),''M'',''M'',''F'',''F'',''U'')||To_Char(a.born_on,''YYYYMMDD'')||''-''||lvl3.rollupid END,1,50) AS MEMID,
		substr(CASE '; IF EMPID IN ('TAVG','HAMI') THEN
	vbQuery := vbQuery||
		' WHEN b.ENRID IS NOT NULL THEN b.ENRID';
		ELSIF EMPID IN ('RUMP','WEHI') THEN
	vbQuery := vbQuery||
		' WHEN c.ENRID IS NOT NULL THEN c.ENRID';
END IF;   --ICE 10161
		vbQuery := vbQuery||
		' WHEN a.unique_id IS NOT NULL THEN a.unique_id||''-''||lvl3.rollupid
		ELSE SUBSTR(a.OURHEALTH_WELLNESS_ID,1,15)||''-''||lvl3.rollupid END,1,20) AS  ENRID,
		a.ELIGIBLE_ON AS EFFDATE,
		CASE
			WHEN Nvl(a.INELIGIBLE_ON, To_Date(''99991231'', ''YYYYMMDD'') ) > Last_Day(To_Date(substr(a.sourcefilename,-14,10),''mm-dd-yyyy''))
      THEN Last_Day(To_Date(substr(a.sourcefilename,-14,10),''mm-dd-yyyy''))
			ELSE a.INELIGIBLE_ON
		END	 AS TERMDATE,   --DEFECT 10418
		''C'' AS LVL1ID,
		''Commercial'' AS LVL1Desc,';
		IF EMPID IN ('TAVG','HAMI') THEN
	vbQuery := vbQuery||
		'B.LVLID2 AS LVLID2,
		B.LVLDESC2 AS LVLDesc2,';
		ELSIF EMPID IN ('RUMP','WEHI') THEN
	vbQuery := vbQuery||
		'C.LVLID2 AS LVLID2,
		C.LVLDESC2 AS LVLDesc2,';
		END IF;
		vbQuery := vbQuery||
		'NVL(lvl3.rollupid,a.Company_name) LVLID3,
		NVL(lvl3.GROUP_NAME,a.Company_name)  AS LVLDesc3,
		';
		IF EMPID IN ('TAVG','HAMI') THEN
	vbQuery := vbQuery||
		'B.LVLID4 AS LVLID4,
		B.LVLDESC4 AS LVLDesc4,';
		ELSIF EMPID IN ('RUMP','WEHI') THEN
	vbQuery := vbQuery||
		'C.LVLID4 AS LVLID4,
		C.LVLDESC4 AS LVLDesc4,';
		END IF;
		vbQuery := vbQuery||
		'
		''1'',
		a.OURHEALTH_WELLNESS_ID UDFC10
	FROM
		HI0826001.HI_ELIG_OUHL_'||EMPID||' A
	left join
		HR_826_GROUP lvl3
	on
	  a.COMPANY_NAME = lvl3.SRC_CODE';
	IF EMPID IN ('TAVG','HAMI') THEN
	vbQuery := vbQuery||'
	LEFT JOIN
		zzz_ELIG_ANTHEM_'||VLVL.SERIALNO||' B
	ON
		UPPER(a.FIRST_NAME) = B.MEMFIRSTNAME
	AND
		UPPER(a.LAST_NAME) = B.MEMLASTNAME
	AND
		DECODE(UPPER(a.GENDER),''M'',''M'',''F'',''F'',''U'') = B.GENDER
	AND
		TO_CHAR(a.BORN_ON,''YYYYMMDD'') = TO_CHAR(B.DOB,''YYYYMMDD'')
	AND
		NVL(lvl3.rollupid,a.Company_name) = B.LVLID3';
	ELSIF EMPID IN ('RUMP','WEHI') THEN
	vbQuery := vbQuery||'
	LEFT JOIN
		zzz_ELIG_UHC_'||VLVL.SERIALNO||' C
	ON
		UPPER(a.FIRST_NAME) = C.MEMFIRSTNAME
	AND
		UPPER(a.LAST_NAME) = C.MEMLASTNAME
	AND
		DECODE(UPPER(a.GENDER),''M'',''M'',''F'',''F'',''U'') = C.GENDER
	AND
		TO_CHAR(a.BORN_ON,''YYYYMMDD'') = TO_CHAR(C.DOB,''YYYYMMDD'')
	AND
		NVL(lvl3.rollupid,a.Company_name) = C.LVLID3
	';
		END IF;
		vbQuery := vbQuery||

		'';


BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('ELIG-CSTM OUHL',EMPID,VLVL.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('ELIG-CSTM OUHL',EMPID,VLVL.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'ELIG-MERGE OUHL','VH_ELIGIBILITIES_'||VLVL.SERIALNO||'_COMM','VH_ELIGIBILITIES_'||VLVL.SERIALNO||'_CSTM','VH_ELIGIBILITIES_'||VLVL.SERIALNO||'_OUHL');
exception when others then
xp_scrubStatusLog ('ELIG-MERGE OUHL',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;



VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||VLVL.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_ELIGIBILITIES_'||VLVL.SERIALNO||'  a
	        SELECT * FROM VH_ELIGIBILITIES_'||VLVL.SERIALNO||'_OUHL';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('OUHL ELIG FINAL INSERT',EMPID,VLVL.PAYER,'','','HI0826001',SQL%ROWCOUNT,'ELIG','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('OUHL ELIG FINAL INSERT',EMPID,VLVL.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
END;
COMMIT;

END IF;

----------------------------------------UPDATING PLANTYPE AND PLANNAME IN ELIG =OUR HEALTH -ICE 10670------------------------------------
vbQuery:=
		'MERGE /*+ PARALLEL(c,4) */ INTO VH_ELIGIBILITIES_'||VLVL.SERIALNO||' C
		USING
		(
		SELECT
			MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB,LVLID3,PLANTYPE,PLANNAME,BENCOVTYPEDESC,BENCOVTYPE,COVERAGESTATUS
		FROM
		(
		SELECT
				MEMID, ENRID,  MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB,LVLID3,PLANTYPE,PLANNAME,BENCOVTYPEDESC,BENCOVTYPE,COVERAGESTATUS,
				ROW_NUMBER() OVER (PARTITION BY MEMID,LVLID3 ORDER BY EFFDATE DESC NULLS LAST ,TERMDATE DESC) RN
		FROM
		VH_ELIGIBILITIES_'||VLVL.SERIALNO||' WHERE SOURCE <>''OUR HEALTH''
		)
		WHERE RN = 1
		) D
	ON
	(
			C.MEMID = D.MEMID
		AND
			C.LVLID3= D.LVLID3
	)
	WHEN MATCHED THEN UPDATE
	SET
	C.PLANTYPE = D.PLANTYPE ,
	C.PLANNAME = D.PLANNAME ,
	C.COVERAGESTATUS = D.COVERAGESTATUS, --ICE#11625
	C.BENCOVTYPE = D.BENCOVTYPE,--ICE#11625
	C.BENCOVTYPEDESC= D.BENCOVTYPEDESC --ICE#11625
	WHERE C.SOURCE=''OUR HEALTH''';

  BEGIN EXECUTE IMMEDIATE vbquery;
  EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('Planname and Plantype UPDATE OURHEALTH',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;

COMMIT;

-----------------------------------------------------------------------------------

-------------------------END of ICE#9467
---------------------ICE 279830 AETNA 1K START-------------
-- IF  vLvl.PAYER='AETNA_1K' THEN

-- BEGIN
    -- EXECUTE IMMEDIATE 'DROP TABLE ZZZ_ANTHEM_MEM_OHMH_UPDATE CASCADE CONSTRAINTS';
	-- EXCEPTION WHEN Others THEN NULL;
  -- END;


  -- vbquery:=
  -- 'CREATE TABLE ZZZ_ANTHEM_MEM_OHMH_UPDATE as
  -- SELECT MEMFIRSTNAME, MEMLASTNAME, DOB, GENDER, MEMID, ENRID, ''OHMH'' AS LVLID3 from
	  -- (SELECT
		-- upper(mbr_first_nm) as memfirstname, upper(mbr_last_nm) MEMLASTNAME, mbr_brth_dt DOB,  a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2)||''-''||''OHMH'' MEMID, a.SBSCRBR_ID||''-''||''OHMH'' ENRID, CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END GENDER,
		-- ROW_NUMBER() OVER(PARTITION BY mbr_first_nm, mbr_last_nm, mbr_brth_dt,MBR_GNDR_CD   ORDER BY receivedmonth DESC) RN
  -- FROM HI0826001.HI_ELIG_ANTHEM_OHMH a)
	-- WHERE rn = 1';


-- BEGIN EXECUTE IMMEDIATE vbquery;
  -- xp_scrubStatusLog ('TEMP TABLE AETNA_1K UPDATE ',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_ANTHEM_OHMH','Y','I');
-- EXCEPTION WHEN OTHERS THEN
  -- xp_scrubStatusLog ('TEMP TABLE AETNA_1K UPDATE',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
-- END;
-- COMMIT;

 -- VBQUERY := 'DROP TABLE VH_ELIG_'||vLvl.SERIALNO||'_AETNA_1K_CSTM PURGE';
-- BEGIN
	-- EXECUTE IMMEDIATE VBQUERY;
    -- EXCEPTION WHEN OTHERS THEN NULL;
-- END;

-- VBQUERY:='CREATE TABLE VH_ELIG_'||vLvl.SERIALNO||'_AETNA_1K_CSTM AS
							  -- SELECT
								-- SOURCE,
								-- MEMID,
								-- ENRID,
								-- TERMDATE,
								-- LVLID1,
								-- LVLDESC1,
								-- LVLID2,
								-- LVLDESC2,
								-- LVLID3,
								-- LVLDESC3,
								-- LVLID4,
								-- LVLDESC4,
								-- PRODUCTID,
								-- PLANTYPE,
								-- PLANNAME,
								-- COVERAGESTATUS

						   -- FROM
								-- VH_ELIGIBILITIES
						   -- WHERE 1=2';

-- BEGIN
	-- EXECUTE IMMEDIATE VBQUERY;
	-- EXCEPTION WHEN OTHERS THEN
  -- xp_scrubStatusLog ('ELIG TABLE CREATE AETNA 1K',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
-- END;

-- VBQUERY:='ALTER TABLE VH_ELIG_'||vLvl.SERIALNO||'_AETNA_1K_CSTM ADD SRCROWID VARCHAR2(200)';
    -- BEGIN
			-- EXECUTE IMMEDIATE VBQUERY;
			-- EXCEPTION WHEN OTHERS THEN NULL;
		-- END;


-- VBQUERY :='ALTER TABLE VH_ELIG_'||vLvl.SERIALNO||'_AETNA_1K_CSTM ADD  PRIMARY KEY(SRCROWID)';
-- BEGIN
	-- EXECUTE IMMEDIATE VBQUERY ;
  -- EXCEPTION WHEN OTHERS THEN NULL;
-- END;

-- begin
-- SP_PYR_1393_ELIG_ATNA('HI0826001','HI_ELIG_AETNA_'||EMPID||'','ELIG','VH_ELIG_'||vLvl.SERIALNO||'_AETNA_1K_COMM');
-- xp_scrubStatusLog ('ELIG-COMM AETNA_1K ',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_AETNA_'||EMPID,'Y','I');
-- exception when others then
-- xp_scrubStatusLog ('ELIG-COMM AETNA 1K',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_1393_ELIG_ATNA','','E');
-- end;

	-- COMMIT;
-- ----------------------------------------------------------------------------------------------------------

-- vbQuery:='
	-- INSERT /*+ PARALLEL(TBL,4) INTO VH_ELIG_'||vLvl.SERIALNO||'_AETNA_1K_CSTM TBL
	-- (
		-- SRCROWID,
		-- SOURCE,
		-- MEMID,
		-- ENRID,
		-- TERMDATE,
		-- LVLID1,
		-- LVLDESC1,
		-- LVLID2,
		-- LVLDESC2,
		-- LVLID3,
		-- LVLDESC3,
		-- LVLID4,
		-- LVLDESC4,
		-- PRODUCTID,
		-- PLANTYPE,
		-- PLANNAME,
		-- COVERAGESTATUS
	-- )
	-- SELECT /*+ PARALLEL(a,4) */
		-- a.ROWID AS SRCROWID,
		-- ''AETNA'' AS source,
		-- nvl(X.MEMID,
				-- CASE WHEN LVL3.MEMID_GRP_FLAG =''Y'' THEN a.EMPLOYEE_SOCIAL_SECURITY_NUM || Decode(Upper(a.GENDER_CODE),''F'',''F'',''M'',''M'',''U'') || To_Char(a.BIRTH_DATE,''YYYYMMDD'') ||''-''||LVL3.ROLLUPID
					-- ELSE a.EMPLOYEE_SOCIAL_SECURITY_NUM || Decode(Upper(a.GENDER_CODE),''F'',''F'',''M'',''M'',''U'') || To_Char(a.BIRTH_DATE,''YYYYMMDD'') END )AS MEMID,
		-- NVL(X.ENRID,CASE WHEN LVL3.MEMID_GRP_FLAG =''Y'' THEN a.EMPLOYEE_SOCIAL_SECURITY_NUM||''-''||LVL3.ROLLUPID ELSE a.EMPLOYEE_SOCIAL_SECURITY_NUM END ) as ENRID,
		-- --Last_Day(To_Date(a.receivedmonth ,''yyyymm'')) AS termdate,
		 -- COALESCE(eff_term.TERMDATE,CASE WHEN rel.ROLLUPRELFLAG != ''E'' THEN dep_term.TERMDATE END,Last_Day(To_Date(a.receivedmonth ,''yyyymm''))) AS TERMDATE,
		-- ''C'' AS LVL1ID,
		-- ''Commercial'' AS LVL1Desc,
		-- NVL(lvl2.LVL2ROLLUPID ,a.control_number1||''-''||a.suffix1||''-''||a.account1) AS LVL2ID,
		-- NVL(lvl2.ACCOUNTNAME ,a.control_number1||''-''||a.suffix1||''-''||a.account1) AS LVL2Desc,
		-- NVL(lvl3.rollupid,a.control_number1) LVL3ID,
		-- NVL(lvl3.GROUP_NAME,a.control_number1)  AS LVL3Desc,
		-- NVL(lvl4.LVL4ROLLUPID ,a.control_number1||''-''||a.plan_id2)  AS LVLID4,
		-- substr(NVL(lvl4.plandesc ,a.control_number1||''-''||a.plan_id2),1,50) AS LVLDesc4,
		-- ''1'' AS PRODUCTID,
		-- NVL(lvl4.LVL4ROLLUPID ,a.control_number1||''-''||a.plan_id2)  AS PLANTYPE,
		-- substr(NVL(lvl4.plandesc ,a.control_number1||''-''||a.plan_id2),1,50) AS PLANNAME,
		-- lvl2.status as COVERAGESTATUS

	-- FROM
	-- HI0826001.HI_ELIG_AETNA_'||EMPID||'  A
             -- left join
 -- HR_826_AETNA_LVL2  lvl2
 -- on
 -- a.control_number1 = lvl2.CONTROL AND
 -- a.suffix1 =  lvl2.SUFFIX AND
 -- a.account1 =  lvl2.account
 -- left join
 -- HR_826_GROUP lvl3
 -- on
 -- a.control_number1   =  lvl3.SRC_CODE
 -- left join
 -- HR_826_AETNA_PLAN  lvl4
 -- on
 -- a.control_number1   = lvl4.CONTROL  AND
 -- a.plan_id2 = lvl4.plan
	-- left join
	-- ZZZ_ANTHEM_MEM_OHMH_UPDATE X
	-- ON
	-- UPPER(A.FIRST_NAME)=X.MEMFIRSTNAME AND
	-- UPPER(A.LAST_NAME)=X.MEMLASTNAME AND
	-- A.BIRTH_DATE=X.DOB AND
	-- DECODE(UPPER(A.GENDER_CODE),''M'',''M'',''F'',''F'',''U'')=X.GENDER AND
	-- NVL(lvl3.rollupid,a.control_number1)=X.LVLID3
	-- LEFT JOIN
		-- HR_802_REL_ATNA_1K rel
	-- ON
		-- rel.SOURCE = ''AETNA_1K''
	-- AND
		-- a.RELATIONSHIP_CODE = rel.SRCRELFLAG
	-- LEFT JOIN
		-- ZZZ_EFF_TERM_DATE_1393_ATNA eff_term
	-- ON
		-- a.EMPLOYEE_SOCIAL_SECURITY_NUM || Decode(Upper(a.GENDER_CODE),''F'',''F'',''M'',''M'',''U'') || To_Char(a.BIRTH_DATE,''YYYYMMDD'') = eff_term.MEMID
	-- AND
		-- a.CONTROL_NUMBER1 = eff_term.CONTROL_NUMBER1
	-- AND
		-- a.SUFFIX1 = eff_term.SUFFIX1
	-- AND
		-- a.ACCOUNT1 = eff_term.ACCOUNT1
	-- AND
		-- a.PLAN_ID2 = eff_term.PLAN_ID2
	-- LEFT JOIN
		-- ZZZ_EMP_TERMDATE_1393_ATNA dep_term
	-- ON
		-- a.EMPLOYEE_SOCIAL_SECURITY_NUM = dep_term.ENRID
	-- AND
		-- a.CONTROL_NUMBER1 = dep_term.CONTROL_NUMBER1
	-- AND
		-- a.SUFFIX1 = dep_term.SUFFIX1
	-- AND
		-- a.ACCOUNT1 = dep_term.ACCOUNT1
	-- AND
		-- a.PLAN_ID2 = dep_term.PLAN_ID2
-- '	 ;

-- BEGIN EXECUTE IMMEDIATE vbquery;
  -- xp_scrubStatusLog ('ELIG-CSTM AETNA_1K ',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_AETNA_'||EMPID,'Y','I');
-- EXCEPTION WHEN OTHERS THEN
  -- xp_scrubStatusLog ('ELIG-CSTM AETNA_1K ',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
-- END;
-- COMMIT;
-- ------------------------------------------------------------------------------------------------------------------
-- begin
 -- SP_CDF_TBL_MERGE(USER,'ELIG-MERGE AETNA_1K','VH_ELIG_'||vLvl.SERIALNO||'_AETNA_1K_COMM','VH_ELIG_'||vLvl.SERIALNO||'_AETNA_1K_CSTM','VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_ATNA1K');
 -- xp_scrubStatusLog ('ELIG-MERGE AETNA_1K ',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_AETNA_'||EMPID,'Y','I');
-- exception when others then
-- xp_scrubStatusLog ('ELIG-MERGE AETNA 1K',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
-- end;

-- COMMIT;

-- -------------------------CREATE TWINS TABLE FOR GROUP TIRE AND SOURCE AETNA---------
-- IF EMPID='TIRE'
-- THEN

    -- BEGIN
			-- EXECUTE IMMEDIATE 'DROP TABLE ZZZ_TWINS_AETNA_'||VLVL.SERIALNO;
			-- EXCEPTION WHEN OTHERS THEN NULL;
	-- END;

-- vbquery:=' CREATE TABLE ZZZ_TWINS_AETNA_'||VLVL.SERIALNO||' AS
  -- SELECT
	-- DISTINCT Upper(LVLID3) LVLID3 ,ENRID, Upper(MEMFIRSTNAME) MEMFIRSTNAME ,memlastname,  NVL(DOB,To_DATE(''2000/01/01'',''YYYY/MM/DD'')) DOB, Nvl(GENDER,''X'') GENDER,MEMID  , ''twins'' as udfc20,
  -- SubStr(memid, 1, InStr(memid, ''-'')-1 )||''-''||SubStr(memfirstname, 1,4)||substr(memid, InStr(memid, ''-'')) as MEMID_NEW
	-- FROM
	-- VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_ATNA1K a
	-- WHERE
	-- RelFlag = ''D'' --Applies for Dependent only
	-- AND ENRID||MemLastName||DOB||GENDER IN
		-- (
		-- SELECT  ENRID||MemLastName||DOB||GENDER FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_ATNA1K a WHERE RelFlag = ''D'' AND SOURCE=''AETNA'' AND lvlid3=''TIRE''

	 	-- GROUP BY ENRID||MemLastName||DOB||GENDER
		-- HAVING COUNT(DISTINCT MemFirstName)>1
		-- )
	-- GROUP BY
	-- LVLID3,ENRID,MEMID, MEMFIRSTNAME,memlastname, NVL(DOB,To_DATE(''2000/01/01'',''YYYY/MM/DD'')), Nvl(GENDER,''X'') , udfc19
	-- ORDER BY 1,2,3,4'  ;

-- BEGIN EXECUTE IMMEDIATE VBQUERY;
 -- xp_scrubStatusLog ('AETNA 1K OHMH TWIN TABLE',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_AETNA_'||EMPID,'Y','I');
-- EXCEPTION WHEN OTHERS THEN
-- xp_scrubStatusLog ('AETNA 1K OHMH TWIN TABLE',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
-- END;

-- -----------------UPDATE THE MEMID OF TWINS-------------
-- vbquery:=' MERGE INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_ATNA1K T
	-- USING
		-- ZZZ_TWINS_AETNA_'||VLVL.SERIALNO||' S
	-- ON
	-- (   T.LVLID3=S.LVLID3
		-- AND t.ENRID = s.ENRID
		-- AND NVL(t.DOB,TO_DATE(''2000/02/02'',''YYYY/MM/DD'')) = Nvl(s.DOB,To_DATE(''2000/02/02'',''YYYY/MM/DD''))
		-- AND NVL(t.Gender,''X'') = NVL(s.Gender,''X'')
		-- AND t.MemFirstName = s.MemFirstName
		-- AND t.RelFlag = ''D''
		-- )
	-- WHEN MATCHED THEN UPDATE SET
	-- T.MEMID=S.MEMID_NEW,
	-- T.UDFC20=S.UDFC20';

-- BEGIN EXECUTE IMMEDIATE VBQUERY;
 -- xp_scrubStatusLog ('AETNA 1K OHMH TWIN MERGE',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_AETNA_'||EMPID,'Y','I');
-- EXCEPTION WHEN OTHERS THEN
-- xp_scrubStatusLog ('AETNA 1K OHMH TWIN MERGE',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
-- END;

-- END IF;

-- -----------------------------
-- VBQUERY:='ALTER TABLE VH_ELIGIBILITIES_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    -- BEGIN
			-- EXECUTE IMMEDIATE VBQUERY;
			-- EXCEPTION WHEN OTHERS THEN NULL;
		-- END;

-- VBQUERY:='INSERT INTO VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  a
	        -- SELECT * FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'_ATNA1K';

-- BEGIN EXECUTE IMMEDIATE vbquery;
  -- xp_scrubStatusLog ('AETNA 1K FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_AETNA_'||EMPID,'Y','I');
-- EXCEPTION WHEN OTHERS THEN
  -- xp_scrubStatusLog ('AETNA 1K FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
-- END;
-- COMMIT;

-- END IF;
-- ------------------------ICE 279830 AETNA 1K END----------- */


----------------**************************END OF ELIGIBILITIES  *********************------------------------------
-------------------------------------------------------------------------------------------------------------------


    tablename:='VH_ELIGIBILITIES_'||vLvl.SERIALNO;

    vbQuery:='INSERT INTO ZZZ_PACKAGE_MERGE VALUES('''||tablename||''','''||EmpID||''',''ELIG'','''||vLvl.SERIALNO||''')';


-------------------------------------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
EXCEPTION WHEN OTHERS THEN
xp_scrubStatusLog ('ELIG',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'INSERT INTO ZZZ_PACKAGE_MERGE VALUES ELIG','','E');
END;
-------------------------------------------------------------------------------------------------

END LOOP;


D2SCRUB.signalCompletion(SchemaName|| '.SP_SE('''||EMPID||''')');


END SP_SE;
/


-----------------------------------------------------Procedure Claims Started---------------------------------
CREATE OR REPLACE PROCEDURE SP_SC
        (
        EMPID IN VARCHAR2

        ) IS

        vbQuery LONG;
        tablename VARCHAR2(50);
        vblStaticDate DATE;
            vbDate LONG;
            vLvl VARCHAR2(200);
            SchemaName VARCHAR2(20);



    BEGIN
      SELECT sys_context('USERENV', 'CURRENT_USER')
                  INTO SchemaName
            FROM dual;



     FOR vLvl IN (SELECT DISTINCT SERIALNO,PAYER,EMPGRPID,replace(EMPGRPNAME,'''','''''')EMPGRPNAME  FROM HR_826_PKG_EMPPAYER WHERE  EMPGRPID=''||EmpID||'' AND SET1='CLAIMS')

            LOOP

----------------------------------------------START CLAIMS -----------------------------------------------

vbQuery :='UPDATE ZZZ_PYR_MODIFIERS
SET MODIFIERDESC = ''RH'' WHERE MODIFIERCODE = ''RH''';
execute immediate vbQuery;
commit;

----------------------------------------------anthem Claims ------------------------------------
IF vLvl.PAYER='ANTHEM' THEN

vbQuery:=
	' INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'
	(
		SN,
		Source,
		SrcFileName,
		ClmNum,
		CLMHEADERNUMBER,
		claimlinenumber,
		ClmType,
		ClmTypeDesc,
		ClmCategory,
		MemID,
		EnrID,
		RelFlag,
		MemFirstName,
		MemLastName,
		Gender,
		DOB,
		Addr1,
		Addr2,
		City,
		State,
		Zip,
		HomePhone,
		WorkPhone,
		LVLID1,
		LVLDesc1,
		LVLID2,
		LVLDesc2,
		LVLID3,
		LVLDesc3,
		LVLID4,
		LVLDesc4,
		LVLID5,
		LVLDesc5,
		LVLID6,
		LVLDesc6,
		claimstatus,
		FromDate,
		ToDate,
		ServiceDate,
		RcvDate,
		PaidDate,
		TypeOfBill,
		BillType,
		POSCode,
		POSDesc,
		SpecCode,
		SpecDesc,
		DiagCode,
		DiagDesc,
		FIRSTDIAGCODE,
		SECONDDIAGCODE,
		THIRDDIAGCODE,
		FOURTHDIAGCODE,
		PROCTYPE,
		ProcCode,
		ProcDesc,
		REVCODE,
		DRGCODE,
		cpt4_1,
		ModifierCode,
		ModifierDesc,
		ProvID,
		ProvName,
		ProvZipCode,
		InNwk,
		NwkID,
		NwkName,
		ServiceUnits,
		PaidAmt,
		BilledAmt,
		AllowedAmt,
		PPOSavingAmt,
		EnrPaidAmt,
		CoInsAmt,
		CopayAmt,
		DeductAmt,
		NotAllowedAmt,
		COBAmt,
		PlanExclAmt,
		ADJCODE,
		IPDays,
		SpecRollupCode,
		SpecRollupDesc,
		DISCHSTATUS,
		UDF1,
		UDF2,
		UDF3,
		UDF4,
		UDF5,
		UDF6,
		UDF7,
		UDF8,
		UDF9,
		UDFC1,
		UDFC2,
		UDFC3,
		UDFC4,
		UDFC5,
		UDFC6,
		UDFC7,
		UDFC8,
		UDFC9,
		UDFC10,
		UDFC11,
		UDFC12,
		UDFC13,
		UDFC14,
		UDFC15,
		UDFC16,
		UDFC17,
		UDFC18,
		UDFC19,
		UDFC20,
		UDFD1,
		UDFD2,
		UDFD3,
		UDFD4,
		UDFD5,
		UDFN1,
		UDFN2,
		UDFN3,
		UDFN4,
		UDFN5,
		UDFN6,
		UDFN7,
		UDFN8,
		UDFN9,
		UDFN10,
		UDFN11,
		UDFN12,
		UDFN13,
		UDFN14,
		UDFN15,
		UDFN16,
		UDFN17,
		UDFN18,
		UDFN19,
		UDFN20,
		--RBIND,
		RcvMth,
		PROVTYPECODE,
		ICD9PROCCODE1,
		ICD9PROCCODE2,
		ICD9PROCCODE3,
		REVCODE1,
		SrcRelFlag,
		PlanType,
		PlanName,
		ENROLLMENT_SOURCE,
		COVTYPEDESC,
		PRODUCTID,
--		BENCOVTYPEDESC,
		VHPAYORID
	)
	SELECT
		ROWNUM AS SN,
		''ANTHEM'' AS Source,
		a.SourceFileName AS SrcFileName,
		CASE WHEN UPPER(a.NTWK_IND)=''Y'' THEN ''Y_'' ELSE ''N_'' END ||a.CLM_NBR || a.CLM_LINE_NBR  AS ClmNum,
		a.CLM_NBR AS CLMHEADERNUMBER,
		a.CLM_LINE_NBR AS claimlinenumber,
		CASE WHEN pl.COVTYPEID =''DEN'' THEN ''DEN'' ELSE DECODE(a.CLM_TYP_CD,''DENTL'',''DEN'',''VISON'',''VIS'',''MED'') END ClmType,
		CASE WHEN pl.COVTYPEID =''DEN'' THEN ''DENTAL'' ELSE DECODE(a.CLM_TYP_CD,''DENTL'',''DENTAL'',''VISON'',''VISION'',''MEDICAL'') END AS ClmTypeDesc,
		NULL AS CLMCATEGORY,
		COALESCE(REPLACE(a.SBSCRBR_ID||SubStr(MBR_SQNC_NBR,1,2),''~''),''MEMBERID'') AS MemID,
		COALESCE(REPLACE(a.SBSCRBR_ID,''~''),''EMPLOYEEID'') AS ENRID,
		CASE WHEN a.MBR_REL_CD IN(''18'',''20'') THEN ''E'' WHEN a.MBR_REL_CD IN (''01'',''25'',''53'') THEN ''S'' ELSE ''D'' END AS RelFlag,
		UPPER(a.MBR_FIRST_NM) AS MemFirstName,
		UPPER(a.MBR_LAST_NM) AS MemLastName,
		CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN  a.MBR_GNDR_CD ELSE ''U'' END AS  Gender,
		a.MBR_BRTH_DT AS DOB,
		NULL AS Addr1,
		NULL AS Addr2,
		NULL AS City,
		NULL AS State,
		NULL AS Zip, --NEEDS TO BE UPDATED FROM ELIGIBILITIES
		NULL AS HomePhone,
		NULL AS WorkPhone,
		''C'' AS LVL1ID,
		''Commercial'' AS LVL1Desc,
		COALESCE(t.ROLLUP_ID,PL.ROLLUPID) AS LVL2ID,		--188358
		COALESCE(t.ROLLUP_DESC,PL.PLAN_NAME)  AS LVL2Desc,		--188358,
		nvl(grp.ROLLUPID,a.ACCT_NBR) AS LVL3ID,
		nvl(grp.Group_Name,a.ACCT_NBR) AS LVL3Desc,
		Sgrp.ROLLUPID AS LVL4ID,
		Sgrp.sub_grp_nm AS LVL4Desc,
		NULL AS LVL5ID,
		NULL AS LVL5Desc,
		NULL AS LVL6ID,
		NULL AS LVL6Desc,
		NULL AS CMStatus,
		a.SRVC_STRT_DT AS FromDate,
		a.SRVC_END_DT AS ToDate,
		a.SRVC_STRT_DT  AS ServiceDate,
		NULL AS RcvDate,
		a.PAID_DT AS PaidDate,
		SUBSTR(A.BILL_TYPE_CD,-3) AS TypeOfBill,
		CASE WHEN A.BILL_TYPE_CD IS NULL THEN ''P'' ELSE ''F'' END  AS BillType,';
		--FOR CBEL POS 23 IS MISSING HENCE DERIVED 23 BASED ON PROC CODE AS DONE IN 727-001 OAM MSG #716933
		IF EmpID='CBEL' THEN
			vbQuery:=vbQuery||'
			CASE
				WHEN SubStr(a.RVNU_CD,-3) IN (''450'',''451'',''452'',''453'',''454'',''455'',''456'',''457'',''458'',''459'') OR PRIM_PROC_CD IN (''99281'',''99282'',''99283'',''99284'',''99285'',''99288'') THEN ''23''
				ELSE COALESCE(a.PLACE_SRVC_CD,''99'')
			END AS POSCode,
			';
		ELSE
			vbQuery:=vbQuery||'a.PLACE_SRVC_CD AS POSCode,';
		END IF;
		vbQuery:=vbQuery||'
		NULL AS POSDesc,
		COALESCE((SELECT h.Rollup_code FROM HR_826_SPEC h WHERE a.BILL_PROV_SPEC_CD =h.SRCCODE AND h.PAYER = ''ANTHEM''), a.BILL_PROV_SPEC_CD,X.impliedspeccode) AS SpecCode,
		UPPER(COALESCE((SELECT h.Rollup_Desc FROM HR_826_SPEC h WHERE a.BILL_PROV_SPEC_CD =h.SRCCODE AND h.PAYER = ''ANTHEM''),a.BILL_PROV_SPEC_CD,X.impliedspecdesc)) AS SpecDesc,
		NVL(NULLIF(a.DIAG_1_CD,''UNK''),NULLIF(a.DIAG_2_CD,''UNK'')) AS DiagCode,
		NULL AS DiagDesc,
		NULLIF(a.DIAG_1_CD,''UNK'') AS FIRSTDIAGCODE,
		NULLIF(a.DIAG_2_CD,''UNK'') AS SECONDDIAGCODE,
		NULL AS THIRDDIAGCODE,
		NULL AS FOURTHDIAGCODE,
		NULL AS PROCTYPE,
		COALESCE(c.PROCCODE,d.PROCCODE,e.PROCCODE,NULLIF(a.PRIM_PROC_CD,''UNK''),NULLIF(''I''||NULLIF(a.SEC_PROC_CD,''UNK''),''I''),NULLIF(''R''||CASE WHEN SUBSTR(a.RVNU_CD,1,1)=''0'' THEN SUBSTR(a.RVNU_CD,-3)  ELSE NULLIF(a.RVNU_CD,''UNK'') END,''R'')) AS PROCCODE,
		NULL AS ProcDesc,
		CASE WHEN SUBSTR(a.RVNU_CD,1,1)=''0'' THEN SUBSTR(a.RVNU_CD,-3)  ELSE NULLIF(a.RVNU_CD,''UNK'') END AS REVCODE,
		NULL AS DRGCODE,
		CASE WHEN ISNUMERIC(a.PRIM_PROC_CD) = 1 THEN a.PRIM_PROC_CD END AS cpt4_1,
		NULLIF(a.PROC_MDFR1_CD,''UNK'') AS ModifierCode,
		NVL((SELECT m.MODIFIERDESC FROM ZZZ_M_MODIFIERS m WHERE a.PROC_MDFR1_CD = m.MODIFIERCODE),NULLIF(a.PROC_MDFR1_CD,''UNK'')) AS ModifierDesc,
		a.BILL_PROV_TAX_ID AS ProvID,
		a.BILL_PROV_TAX_ID AS ProvName,
		SUBSTR(a.BILL_PROV_ZIP_CD,1,5) AS ProvZipCode,
		CASE WHEN UPPER(a.NTWK_IND)=''Y'' THEN ''Y'' ELSE ''N'' END AS InNwk,
		''NNP'' AS NwkID,
		''NETWORK NOT PROVIDED'' AS NwkName,
		SRVC_CNT AS ServiceUnits,
		Nvl(a.PAID_AMT,0)  AS PaidAmt,
		Nvl(a.BILLED_AMT,0) AS BilledAmt,
		NVL(a.DDCTBL_AMT,0) + NVL(a.COINSRN_AMT,0) + NVL(a.CPAY_AMT,0) + Nvl(a.PAID_AMT,0) + NVL(a.COB_SVNGS_AMT,0) AS AllowedAmt, --logic modified as per oam msg#721968
		0 AS PPOSavingAmt,
		NVL(a.CPAY_AMT,0) + NVL(a.DDCTBL_AMT,0) + NVL(a.COINSRN_AMT,0) AS EmpPaidAmt,
		NVL(a.COINSRN_AMT,0) AS CoInsAmt,
		NVL(a.CPAY_AMT,0) AS CopayAmt,
		NVL(a.DDCTBL_AMT,0) AS DeductAmt,
		NVL(a.NON_CVRD_AMT,0) AS NotAllowedAmt,
		NVL(a.COB_SVNGS_AMT,0)  AS COBAmt,
		0 AS PlanExclAmt,
		CASE WHEN a.ADJ_TYP_CD = ''RVRSL'' THEN ''R'' ELSE ''P'' END AS ADJCODE,
		0 AS IPDays,
		NULL AS SpecRollupCode,
		NULL AS SpecRollupDesc,
		a.DSCHRG_STTS_CD AS DISCHSTATUS,
		a.UDF1 AS UDF1,
		NULL AS UDF2,
		NULL AS UDF3,
		NULL AS UDF4,
		NULL AS UDF5,
		NULL AS UDF6,
		NULL AS UDF7,
		NULL AS UDF8,
		NULL AS UDF9,
		NULL AS UDFC1,
		NULL AS UDFC2,
		NULL AS UDFC3,
		NULL AS UDFC4,
		NULL AS UDFC5,
		NULL AS UDFC6,
		NULL AS UDFC7,
		NULL AS UDFC8,
		NULL AS UDFC9,
		NULL AS UDFC10,
		NULL AS UDFC11,
		NULL AS UDFC12,
		NULL AS UDFC13,
		NULL AS UDFC14,
		NULL AS UDFC15,
		NULL AS UDFC16,
		NULL AS UDFC17,
		NULL AS UDFC18,
		NULL AS UDFC19,
		NULL AS UDFC20,
		NULL AS UDFD1,
		NULL AS UDFD2,
		NULL AS UDFD3,
		NULL AS UDFD4,
		NULL AS UDFD5,
		0 AS UDFN1,
		0 AS UDFN2,
		0 AS UDFN3,
		0 AS UDFN4,
		0 AS UDFN5,
		0 AS UDFN6,
		0 AS UDFN7,
		0 AS UDFN8,
		0 AS UDFN9,
		0 AS UDFN10,
		0 AS UDFN11,
		0 AS UDFN12,
		0 AS UDFN13,
		0 AS UDFN14,
		0 AS UDFN15,
		0 AS UDFN16,
		0 AS UDFN17,
		0 AS UDFN18,
		0 AS UDFN19,
		0 AS UDFN20,
		a.RECEIVEDMONTH AS RcvMth,
		NULL AS PROVTYPECODE,
		NULLIF(a.SEC_PROC_CD,''UNK'') ICD9PROCCODE1,
		NULL AS ICD9PROCCODE2,
		NULL AS ICD9PROCCODE3,
		CASE WHEN SUBSTR(a.RVNU_CD,1,1)=''0'' THEN SUBSTR(a.RVNU_CD,-3)  ELSE NULLIF(a.RVNU_CD,''UNK'') END AS REVCODE1,
		(SELECT R.rollup_desc FROM HR_826_REL R WHERE R.source = ''ANTHEMOH'' AND R.src_code=a.MBR_REL_CD ) SrcRelFlag,
		COALESCE(t.PLANTYPE, pl.PLAN_TYPE) PLANTYPE ,		--188358
		COALESCE(t.ROLLUP_DESC,PL.PLAN_NAME) PLANNAME,		--188358
		--''ANTHEM'' ENROLLMENT_SOURCE,
		NULL AS ENROLLMENT_SOURCE,    ---ICE 243113
		CASE WHEN pl.COVTYPEID =''DEN'' THEN ''DENTAL'' ELSE DECODE(a.CLM_TYP_CD,''DENTL'',''DENTAL'',''VISON'',''VISION'',''MEDICAL'') END COVTYPEDESC,
		''1'' as PRODUCTID,
		(SELECT p.PAYORID FROM HR_GLOBAL_PAYORLIST p WHERE TABLENAME=''HI_CLAIMS_ANTHEM'') AS VHPAYORID
	FROM
		HI0826001.HI_CLAIMS_ANTHEM_'||EMPID||' a
	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.ACCT_NBR = grp.src_code
	LEFT JOIN
		HR_826_ANTHEM_SUBGRP Sgrp
	ON
		a.ACCT_NBR = Sgrp.ACCT_NBR
	AND
		SUBSTR(A.SUBGRP_NBR,-4) = Sgrp.src_code
	LEFT JOIN
		HR_826_ANTHEM_PLAN pl
	ON
		a.ACCT_NBR = pl.ACCT_NBR
	AND
		UPPER(a.PKG_NBR) = pl.src_code
	LEFT JOIN
		ZZZ_PROCS c
	ON
		PRIM_PROC_CD = c.PROCCODE
	LEFT JOIN
		zzz_procs d
	ON
		''I''||a.SEC_PROC_CD = d.PROCCODE
	LEFT JOIN
		zzz_procs e
	ON
		''R'' || CASE WHEN SUBSTR(a.RVNU_CD,1,1)=''0'' THEN SUBSTR(a.RVNU_CD,-3)  ELSE a.RVNU_CD END = e.PROCCODE
	LEFT JOIN								--188358
		HR_826_LOA_LVL_ROLLUP t
	ON
		a.ACCT_NBR  = t.groupid
	AND
		UPPER(a.PKG_NBR) = Upper(t.PLANCODE)
	AND
		To_Char(a.SRVC_STRT_DT,''YYYY'') = To_Char(t.effectivedate, ''YYYY'')
	LEFT JOIN 	--259744
		ZZZ_SPECS X
	ON
		COALESCE(c.PROCCODE,d.PROCCODE,e.PROCCODE,NULLIF(a.PRIM_PROC_CD,''UNK''),NULLIF(''I''||NULLIF(a.SEC_PROC_CD,''UNK''),''I''),NULLIF(''R''||CASE WHEN SUBSTR(a.RVNU_CD,1,1)=''0'' THEN SUBSTR(a.RVNU_CD,-3)  ELSE NULLIF(a.RVNU_CD,''UNK'') END,''R''))
		= x.PROCCODE
	WHERE
		NVL(pl.DROP_PLAN,''N'')=''N''';

	------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('CLAIMS ANTHEM INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('CLAIMS ANTHEM INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
	------------------------------------------------------------------------------------------
	--UDPATE REQUIRED TO FULFILL EI REQUIREMENT
	------------------------------------------------------------------------------------------
	vbQuery:='
		MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' A
		USING
		(
			SELECT memID,zip
			FROM
			(
				SELECT memID,zip,
				ROW_NUMBER()OVER(PARTITION BY memID ORDER BY rcvMth DESC,NVL(termDate,TO_DATE(''9999-12-31'',''YYYY-MM-DD'')) DESC,effDate DESC,zip)rn
				FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
			)x WHERE RN=1
		)b
		ON
		(
			a.memID = b.memID
		)
		WHEN MATCHED THEN UPDATE
		SET a.zip=b.zip,a.udfC1=''1st pass''
		';
	------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('CLAIMS ZIP UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
	------------------------------------------------------------------------------------------
	vbQuery:='
		MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' A
		USING
		(
			SELECT enrID,zip
			FROM
			(
				SELECT enrID,zip,
				ROW_NUMBER()OVER(PARTITION BY enrID ORDER BY rcvMth DESC,NVL(termDate,TO_DATE(''9999-12-31'',''YYYY-MM-DD'')) DESC,effDate DESC,zip)rn
				FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
			)x WHERE RN=1
		)b
		ON
		(
			a.enrID = b.enrID
		)
		WHEN MATCHED THEN UPDATE
		SET a.zip=b.zip,a.udfC1=''2nd pass''
		WHERE a.zip IS NULL
		';
	------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('CLAIMS ZIP UPDATE PASS 2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
END IF;
---------------------------------------ANTHEM OH/RDX Claims ---------------------------------
IF  vLvl.PAYER='ANTHEMRDX' OR vLvl.PAYER='ANTHEM_OH' THEN

	-------------------------------------------------2610 ANTHEMRDX------MI Implementation---------------------------------------

	VBQUERY := 'DROP TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM AS
	    SELECT
		    SOURCE,
		    MEMID,
		    ENRID,
		    ZIP,
		    LVLID1,
		    LVLDESC1,
		    LVLID2,
		    LVLDESC2,
		    LVLID3,
		    LVLDESC3,
		    LVLID4,
		    LVLDESC4,
			SPECCODE,
			SPECDESC,
			PAIDAMT,
			BILLEDAMT,
			PRODUCTID,
			PLANTYPE,
			PLANNAME,
      UDFC20
		FROM
		    VH_CLAIMS
		 WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
    xp_scrubStatusLog ('CLAIMS TABLE CREATE ANTHEMRDX',EMPID,'ANTHEM',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_CLMS_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	BEGIN
		SP_PYR_2610_MED_ARDX('HI0826001','HI_CLAIMS_ANTHEM_'||EMPID||'','CLAIMS','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIMS-COMM ANTHEMRDX',EMPID,'ANTHEM',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_2610_MED_ARDX','','E');
	END;
	COMMIT;
----------------------------------------------------------------------------------------------------------

	vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		ZIP,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		SPECCODE,
		SPECDESC,
		PAIDAMT,
		BILLEDAMT,
		PRODUCTID,
		PLANTYPE,
		PLANNAME,
    UDFC20
	)
	SELECT
		a.ROWID AS SRCROWID,
		''ANTHEM_OH'' AS SOURCE,
		';
		IF EMPID IN ('WSPI','PRIM','OHIO','COMS','GROT','RLCS') THEN			----ice337498,8136,12926 --ICE-18938
		vbQuery := vbQuery||'NVL(MEM1.MEMID,a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'')||CASE WHEN grp.MEMID_GRP_FLAG = ''Y'' THEN ''-''||nvl(grp.ROLLUPID,a.ACCT_NBR)  END) AS MemID,
		';
		ELSIF EMPID IN ('OLSD') THEN			----350132,371234
		vbQuery := vbQuery||'NVL(SW.MEMID,ssn.MBR_SSN|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'')) AS MemID,
		';
		ELSIF EMPID IN ('XAVI') THEN
	vbQuery := vbQuery||
	'COALESCE(MEM1.MEMID,REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~'')||''-''||nvl(grp.ROLLUPID,a.ACCT_NBR),''MEMBERID'') AS MemID,	--5216
	';
		ELSE
		vbQuery := vbQuery ||
		'
		CASE
		WHEN grp.MEMID_GRP_FLAG = ''Y'' THEN COALESCE(REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~''),''MEMBERID'')||''-''||nvl(grp.ROLLUPID,a.ACCT_NBR)    --ICE283272
			WHEN grp.ROLLUPID = ''OHMH'' THEN a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2)||''-''||''OHMH'' ------ICE 278043
			WHEN a.ACCT_NBR in (''834~004007010'',''00249078'') THEN COALESCE (MEM.MEMID,a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD''))	--271895
			WHEN a.ACCT_NBR IN (''00123728'', ''00172918'', ''00172421'', ''00169440'', ''00070454'',''00171314'',''00249106'',''00246533'',''00173134'')	THEN COALESCE(REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~''),''MEMBERID'')  --275996
			ELSE a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'')
		  END AS MEMID,    --ice 254417
		';
		END IF;
		IF EMPID IN ('WSPI','COMS') THEN  ----ICE 8136
		vbQuery := vbQuery||'NVL(MEM1.ENRID,a.SBSCRBR_ID) AS ENRID,
		';
		ELSIF EMPID IN ('PRIM') THEN			----ice337498
		vbQuery := vbQuery||'NVL(MEM1.ENRID,''EMPLOYEEID-''||nvl(grp.ROLLUPID,a.ACCT_NBR)) AS ENRID,  --330246
		';
		ELSIF EMPID IN ('OHIO','XAVI','GROT') THEN			----ice337498,5216,12926
		vbQuery := vbQuery||'NVL(MEM1.ENRID,a.SBSCRBR_ID||''-''||nvl(grp.ROLLUPID,a.ACCT_NBR)) AS ENRID,  --330246
		';
		ELSIF EMPID IN ('OLSD') THEN			----350132,371234
		vbQuery := vbQuery||'NVL(SW.ENRID,ssn.MBR_SSN) AS ENRID,
		';
		ELSE
		vbQuery := vbQuery ||
		'
		CASE
			WHEN grp.MEMID_GRP_FLAG = ''Y'' THEN a.SBSCRBR_ID||''-''||nvl(grp.ROLLUPID,a.ACCT_NBR)  --ICE283272
			WHEN grp.ROLLUPID = ''OHMH'' THEN a.SBSCRBR_ID||''-''||''OHMH'' ----ICE 278043
			WHEN a.ACCT_NBR in (''834~004007010'',''00249078'') THEN COALESCE (MEM.ENRID,a.SBSCRBR_ID)	--271895
			WHEN grp.ROLLUPID in (''GTCO'',  ''ARTW'') THEN ''EMPLOYEEID''    --ICE259700,266811
			WHEN a.ACCT_NBR IN (''00123728'', ''00172918'', ''00172421'', ''00169440'', ''00070454'',''00171314'',''00249106'',''00246533'') THEN COALESCE(REPLACE(a.SBSCRBR_ID,''~''),''EMPLOYEEID'')	--275996
			ELSE a.SBSCRBR_ID
		  END AS ENRID,   --ice 254417
		';
		END IF;
		vbQuery := vbQuery ||
		'
		a.EMP_ZIP_CD AS ZIP,
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		CASE
			WHEN A.ACCT_NBR=''00217976'' AND UPPER(A.PKG_NBR)= ''HEALTH 3'' AND To_Number(TO_CHAR(SRVC_STRT_DT ,''YYYY''))<=2013 THEN  ''00217976Health32013''
			WHEN a.acct_nbr=''00172431'' AND UPPER(a.PKG_NBR)= ''HEALTH 7'' AND To_Char(a.SRVC_STRT_DT,''YYYY'')=''2014'' THEN  ''00172431HEALTH72014''   ---ice 266811
			ELSE COALESCE(Sgrp.PLAN_ID,t.ROLLUP_ID,PL.ROLLUPID)
		  END AS LVLID2,
		CASE
			WHEN A.ACCT_NBR=''00217976'' AND UPPER(A.PKG_NBR)= ''HEALTH 3'' AND To_Number(TO_CHAR(SRVC_STRT_DT ,''YYYY''))<=2013 THEN  ''PPO $750 DEB OPT''
			WHEN a.acct_nbr=''00172431'' AND UPPER(a.PKG_NBR)= ''HEALTH 7'' AND To_Char(a.SRVC_STRT_DT,''YYYY'')=''2014'' THEN  ''$2500 Embedded LHSA''   ---ice 266811
			ELSE COALESCE(Sgrp.PLAN_DESC,t.ROLLUP_DESC,PL.PLAN_NAME)
		  END AS LVLDESC2,
		nvl(grp.ROLLUPID,a.ACCT_NBR) AS LVLID3,
		nvl(grp.Group_Name,a.ACCT_NBR) AS LVLDESC3,
		Sgrp.ROLLUPID AS LVLID4,
		Sgrp.sub_grp_nm AS LVLDESC4,
		COALESCE(spec.ROLLUP_CODE,X.IMPLIEDSPECCODE,a.RNDR_PROV_SPEC) AS SPECCODE,			--Rules table used as that of ANTHEM, code matches with existing rules table. Need to review. ICE#294021
		UPPER(COALESCE(spec.ROLLUP_DESC,X.IMPLIEDSPECDESC,a.RNDR_PROV_SPEC)) AS SPECDESC,			--ICE#294021

		CASE
			WHEN grp.ROLLUPID = ''ARTW'' THEN a.PAID_AMT + a.HRA_AMT
			WHEN a.PAID_AMT in (99999.99,-99999.99) THEN 0
			ELSE a.PAID_AMT
		  END AS PAIDAMT,

		CASE
			WHEN grp.ROLLUPID = ''SWOO'' AND a.BILLED_AMT=''99999.99''
				THEN
				Nvl(CASE WHEN grp.ROLLUPID = ''SWOO'' AND a.PAID_AMT=''99999.99'' THEN 0 ELSE a.PAID_AMT END,0) +
				Nvl(CASE WHEN grp.ROLLUPID = ''SWOO'' AND a.CPAY_AMT=''99999.99'' THEN 0 ELSE a.CPAY_AMT END,0) +
				Nvl(CASE WHEN grp.ROLLUPID = ''SWOO'' AND a.COINSRN_AMT=''99999.99'' THEN 0 ELSE a.COINSRN_AMT END,0) +
				Nvl(CASE WHEN grp.ROLLUPID = ''SWOO'' AND a.DDCTBL_AMT=''99999.99'' THEN 0 ELSE a.DDCTBL_AMT END,0) +
				CASE WHEN grp.ROLLUPID = ''SWOO'' AND a.NON_CVRD_AMT=''99999.99'' THEN 0 ELSE a.NON_CVRD_AMT END
				WHEN grp.ROLLUPID IN (''RTCO'',''XAVI'',''COMS'') THEN Nvl( a.PAID_AMT ,0) +	Nvl( a.CPAY_AMT ,0) +Nvl( a.COINSRN_AMT ,0) +  Nvl( a.DDCTBL_AMT ,0)   --ADDED AS PER ICE 4296,5216,8136
			ELSE
			CASE WHEN a.BILLED_AMT in (99999.99,-99999.99) THEN 0 ELSE a.BILLED_AMT END
		  END AS BILLEDAMT,		--350132
		''1'' AS PRODUCTID,
		CASE
			WHEN grp.ROLLUPID=''KBCN'' THEN ''HDHP'' --ICE#269211
			ELSE COALESCE(t.PLANTYPE, pl.PLAN_TYPE)
		  END AS PLANTYPE ,
		CASE
			WHEN A.ACCT_NBR=''00217976'' AND UPPER(A.PKG_NBR)= ''HEALTH 3'' AND To_Number(TO_CHAR(SRVC_STRT_DT ,''YYYY''))<=2013 THEN ''PPO $750 DEB OPT''
			ELSE COALESCE(t.ROLLUP_DESC,PL.PLAN_NAME)
		  END AS PLANNAME,
      a.ACCT_NBR as UDFC20
	FROM
		HI0826001.HI_CLAIMS_ANTHEM_'||EMPID||' a

	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.ACCT_NBR = grp.src_code

	LEFT JOIN
		HR_826_ANTHEM_SUBGRP Sgrp
	ON
		a.ACCT_NBR = Sgrp.ACCT_NBR
		AND
		SUBSTR(A.SUBGRP_NBR,-4) = Sgrp.src_code

	LEFT JOIN
		HR_826_ANTHEM_PLAN pl
	ON
		a.ACCT_NBR = pl.ACCT_NBR
		AND
		Case When pl.FLAG= ''Y'' AND A.SRVC_STRT_DT > TO_DATE(''2018.12.31'',''YYYY.MM.DD'') THEN UPPER(SUBSTR(a.subgrp_nbr,-4))
        WHEN grp.ROLLUPID IN (''TRAN'', ''RLCS'')  THEN substr(a.SUBGRP_NBR , -4)    --ICE-18938
		 ELSE UPPER(a.PKG_NBR) END = UPPER(pl.src_code) --6088 --ICE7917 --ICE-10717

	LEFT JOIN
		HR_826_SPEC spec							--Rules table updated as per ice 163900.
	ON
		a.RNDR_PROV_SPEC=spec.SRCCODE
		AND
		spec.payer = ''ANTHEM''

	LEFT JOIN
		HR_826_LOA_LVL_ROLLUP t
	ON
		a.ACCT_NBR  = t.groupid
		AND
		UPPER(a.PKG_NBR) = Upper(t.PLANCODE)
		AND
		To_Char(a.SRVC_STRT_DT,''YYYY'') = To_Char(t.effectivedate, ''YYYY'')

	LEFT JOIN
		ZZZ_PYR_PROCS pro1
	ON
		Upper(a.PRIM_PROC_CD) = pro1.PROCCODE

	LEFT JOIN
		ZZZ_PYR_PROCS pro2
	ON
		''I''||Upper(a.SEC_PROC_CD) = pro2.PROCCODE

	LEFT JOIN
		ZZZ_PYR_PROCS pro3
	ON
		''R''||CASE WHEN LENGTH(a.RVNU_CD) = 4 AND SUBSTR(a.RVNU_CD,1,1) =''0'' THEN SUBSTR(a.RVNU_CD,-3) ELSE a.RVNU_CD END = pro3.PROCCODE

	LEFT JOIN
		ZZZ_PYR_PROCS pro4
	ON
		''D''||a.INP_DRG = pro4.PROCCODE

	LEFT JOIN 	--259744
		ZZZ_SPECS X
	ON
		COALESCE(pro1.PROCCODE,pro2.PROCCODE,pro3.PROCCODE,pro4.PROCCODE,REPLACE(a.PRIM_PROC_CD,''UNK''),REPLACE(a.SEC_PROC_CD,''UNK''),REPLACE(a.RVNU_CD,''UNK''),REPLACE(a.INP_DRG,''UNK'')) = x.PROCCODE

	LEFT JOIN
		zzz_memid_update_anthem1 MEM
	ON
		UPPER(a.MBR_FIRST_NM) = MEM.MEMFIRSTNAME
		AND
		UPPER(a.MBR_LAST_NM) = MEM.MEMLASTNAME
		AND
		Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'') = MEM.GENDER
		AND
		a.MBR_BRTH_DT = MEM.DOB
		AND
		mem.lvlid3 = nvl(grp.ROLLUPID,a.ACCT_NBR)		--271895
	';
	IF EMPID IN ('WSPI','PRIM','OHIO','XAVI','COMS','GROT','RLCS') THEN	--350132,(,'OLSD')371234,5216,8136,12926 --ICE-18938
	vbQuery := vbQuery||'
	LEFT JOIN
		ZZZ_VH_ELIG_MEMUPD_'||EMPID||' MEM1
	ON
		UPPER(a.MBR_FIRST_NM) = MEM1.MEMFIRSTNAME
		AND
		UPPER(a.MBR_LAST_NM) = MEM1.MEMLASTNAME
		AND
		Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'') = MEM1.GENDER
		AND
		a.MBR_BRTH_DT = MEM1.DOB
		AND 	--271895
		nvl(grp.ROLLUPID,a.ACCT_NBR) = MEM1.LVLID3
		';
	END IF;
	IF EMPID IN ('OLSD') THEN ----350132,371234
	vbQuery := vbQuery||'
	LEFT JOIN
		HR_826_MEMUPD_SWOO SW
	ON
		UPPER(a.MBR_FIRST_NM) = sw.MEMFIRSTNAME
		AND
		UPPER(a.MBR_LAST_NM) = sw.MEMLASTNAME
		AND
		CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END = sw.GENDER
		AND
		a.MBR_BRTH_DT = sw.DOB
		AND
		nvl(grp.ROLLUPID,a.ACCT_NBR) = sw.LVL3ID

	LEFT JOIN
		ZZZ_ELIG_OLSD_SSN ssn
	ON
		a.SBSCRBR_ID =ssn.SBSCRBR_ID
	';
	END IF;
	vbQuery := vbQuery ||
	'
	WHERE
		NVL(pl.DROP_PLAN,''N'')=''N''			--need confirmation if this filter condition is to be used
	';
	IF EmpID='BTLR' THEN
	vbQuery:=vbQuery||' and  a.ACCT_NBR = ''834~003321010'' and SUBSTR(A.SUBGRP_NBR,-4) in (''B1AG'',''B1AP'',''B2CG'',''B2CP'')';
	END IF;    -- added as per ICE#159780 followup#9
-----------------------------------------------------------------------------------------

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('CLAIMS-CSTM ANTHEMRDX',EMPID,'ANTHEM','','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIMS-CSTM ANTHEMRDX',EMPID,'ANTHEM',SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
	END;
	COMMIT;
------------------------------------------------------------------------------------------------------------------
	BEGIN
		SP_CDF_TBL_MERGE(USER,'CLAIMS-MERGE ANTHEMRDX','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM','VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_CLAIMS_'||vLvl.SERIALNO||'_ARDX');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIMS-MERGE ANTHEMRDX',EMPID,'ANTHEM',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	END;
	COMMIT;

---------------------------------- Start of Insert of  ANTHEMR CA OR dropped data back ---------------------------------------------------------------

	VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_CLAIMS_'||vLvl.SERIALNO||'_ARDX';

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('ANTHEMRDX FINAL INSERT',EMPID,'ANTHEM','','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ANTHEMRDX FINAL INSERT',EMPID,'ANTHEM',SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
	END;
	COMMIT;

------------------------------------------------ANTHEMRDX MI Implementation-----------------------------------------------------------------
--------------------------------------------------------------------------------
--ICE-1794(8 groups added as per ICE-3113, 3114, 3151,4063,4870,7281,9722, 10629,10919,10920,10921,10922 ,10717, 11626,15285, 15712,15286,16182,,ICE-16085, 18616)
IF EmpID IN ('KBCN', 'MDOM', 'WSTR','CIMO', 'SHAW', 'TBCM','MAYF','OMYA','FUYA','FHLB','EAGF','PEVM','CECO','TCRG','ADTL', 'MEDP','ATRM','GRTI','GTEG','00172422','RITT', 'TRAN','COCI', 'ARTW', 'GTCO', 'MAKN','PRIM','MAKI','KMCC','RTCO', 'COMS','UCFO','RELA','DNHB') THEN
vbQuery:='MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' d
	USING
	(
       SELECT
                /*+ PARALLEL(f,4) */ b.memid,b.enrid,b.MEMFIRSTNAME, b.MEMLASTNAME, b.GENDER, b.DOB
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ a.memid,a.enrid,a.MEMFIRSTNAME, a.MEMLASTNAME, a.GENDER, a.DOB,TERMDATE,EFFDATE,
                        ROW_NUMBER() OVER (PARTITION BY a.MEMFIRSTNAME, a.MEMLASTNAME, a.GENDER, a.DOB ORDER BY EFFDATE DESC nulls last) rn
        FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||' a
        ) b
        WHERE rn=1

	) c
	ON
	(
		d.MEMFIRSTNAME=c.MEMFIRSTNAME AND
		d.MEMLASTNAME=c.MEMLASTNAME AND
		d.GENDER=c.GENDER AND
		d.DOB=c.DOB
	)
	WHEN MATCHED THEN
        UPDATE SET
		d.memid=c.memid,
		d.enrid=c.enrid
        ';
---------------------------------------Memid update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('AnthemRDX CLAIMS Memid update from elig',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
END IF;
-----------------------------------------------------------------------------------
--ICE-14624
-- IF EMPID ='RELA' THEN
-- vbQuery:=
-- 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
-- USING
	-- (
       -- SELECT
                -- /*+ PARALLEL(f,4) */ f.MEMID,f.LVLID2, f.LVLDESC2, f.LVLID3, f.LVLID4, f.LVLDESC4, f.SERVICEDATE
        -- FROM
                -- (SELECT
                        -- /*+ PARALLEL(a,4) */ b.MEMID,b.LVLID2, b.LVLDESC2, b.LVLID3, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.SERVICEDATE,
                        -- ROW_NUMBER() OVER (PARTITION BY b.MEMID,b.LVLID3,a.SERVICEDATE ORDER BY b.TERMDATE DESC,b.EFFDATE DESC) rn
        -- FROM
                -- VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        -- INNER JOIN
                -- VH_CLAIMS_'||vLvl.SERIALNO||' a
        -- ON
                -- b.MEMID=a.MEMID
        -- AND
				        -- a.LVLID3 = b.LVLID3
		-- AND
                -- NVL(a.Servicedate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        -- ) f
        -- WHERE rn=1
-- ) d
-- ON
-- (
        -- c.MEMID=d.MEMID
-- AND
        -- NVL(c.Servicedate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.Servicedate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
-- AND
	-- c.LVLID3 = d.LVLID3
-- )
-- WHEN MATCHED THEN
        -- UPDATE SET
        -- c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
  -- c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
	-- udfc4=''PASS-1 : Updated from VH_ELIGIBILITIES''
-- ';
-- -------------------------------------------------------------------------------------------------------
-- BEGIN EXECUTE IMMEDIATE vbquery;
	-- EXCEPTION WHEN OTHERS THEN
	 -- VHSCRUB.XP_SCRUBSTATUSLOG('PASS1-CLAIMS LVL2, LVL4 UPDATE RELA',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
-- END;
-- -------------------------------------------------------------------------------------------------------
-- COMMIT;
-- -------------------------------------------------------------------------------------------------------
-- --PASS-2 : Updated from VH_ELIGIBILITIES
-- vbQuery:=
-- '
-- MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
-- USING
-- (
        -- SELECT
                -- /*+ PARALLEL(f,4) */ f.MEMID,f.LVLID2, f.LVLDESC2, f.LVLID3, f.LVLID4, f.LVLDESC4
        -- FROM
                -- (SELECT
                        -- /*+ PARALLEL(a,4) */ b.MEMID,b.LVLID2, b.LVLDESC2, b.LVLID3, b.LVLID4, b.LVLDESC4,
                        -- ROW_NUMBER() OVER (PARTITION BY b.LVLID3, b.MEMID ORDER BY b.TERMDATE DESC,b.EFFDATE DESC) rn
        -- FROM
                -- VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        -- INNER JOIN
                -- VH_CLAIMS_'||vLvl.SERIALNO||' a
        -- ON
                -- b.MEMID=a.MEMID
        -- AND
				-- a.LVLID3 = b.LVLID3
        -- ) f
        -- WHERE rn=1
-- ) d
-- ON
-- (
        -- c.MEMID=d.MEMID
	-- AND
		-- c.LVLID3 = d.LVLID3
-- )
-- WHEN MATCHED THEN
        -- UPDATE SET
		-- c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
		-- c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
		-- c.udfc10=''PASS-2 : Updated from VH_ELIGIBILITIES''
  -- WHERE c.udfc4 IS NULL
-- ';
-- -------------------------------------------------------------------------------------------------------
-- BEGIN EXECUTE IMMEDIATE vbquery;
-- EXCEPTION WHEN OTHERS THEN
	 -- VHSCRUB.XP_SCRUBSTATUSLOG('PASS1-CLAIMS LVL2, LVL4 UPDATE RELA',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
-- END;
-- -------------------------------------------------------------------------------------------------------
-- COMMIT;

-- ELSE

-- BEGIN
	 -- UTILITY.PKG_UPDATE.SP_LOA
	 -- (
	 	-- FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
	 	-- TO_TABLENAME =>	 'VH_CLAIMS_'||vLvl.SERIALNO||'',
	 	-- UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
	 	-- DELIMITER =>		'-',
	 	-- UPDATE_PASSES =>	'1-2',
	 	-- LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
	 	-- LVL_DESC_YN =>	  'Y',
	 	-- PASS_1_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3',
	 	-- PASS_1_UPDATE_CONDITION =>	'[a.source]=''ANTHEM_OH'' and [a.LVLID2] IS NULL',
	 	-- PASS_2_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3',
	 	-- PASS_2_UPDATE_CONDITION =>	'[a.source]=''ANTHEM_OH'' and [a.LVLID2] IS NULL',
	 	-- PASS_3_JOIN_CONDITION =>	NULL,
	 	-- PASS_3_UPDATE_CONDITION =>	NULL,
	 	-- PASS_4_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3',
	 	-- PASS_4_UPDATE_CONDITION =>	'[a.source]=''ANTHEM_OH'' and [a.LVLID2] IS NULL',
	 	-- BEGIN_END_DTE_YN =>	 'N',
	 	-- STABLE_FROM_TABLE_YN =>	 'N',
	 	-- ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
	 -- );
	 -- END;
-- END IF;
-- --------------------------------------------------------------------------------
-- --- LOA Update(Level 2 and Level 4 Update)

-- IF EmpID='WSTR' THEN

-- -- vbQuery:='UPDATE VH_CLAIMS_'||vLvl.SERIALNO||' a
-- -- SET
-- -- a.UDFC4=NULL
    -- -- ';


-- vbQuery:='MERGE INTO
		-- VH_CLAIMS_'||vLvl.SERIALNO||' c
	-- USING
		-- (
		-- SELECT
			-- MemID,
			-- LVLID1,LVLID2,LVLID3,LVLID4,
			-- LVLDESC1,LVLDESC2,LVLDESC3,LVLDESC4,
			-- EffDate,TermDate,servicedate
		-- FROM
			-- (
			-- SELECT
				-- b.MemID,
				-- b.LVLID1,b.LVLID2,b.LVLID3,b.LVLID4,b.LVLDESC1,b.LVLDESC2,b.LVLDESC3,b.LVLDESC4,
				-- b.EffDate,b.TermDate,a.servicedate,
				-- Row_Number() OVER (PARTITION BY b.MemID,a.servicedate ORDER BY b.LVLID1,b.LVLID2,b.LVLID3,b.LVLID4) rn
			-- FROM
				-- VH_CLAIMS_'||vLvl.SERIALNO||' a
			-- LEFT JOIN
				-- (
				-- SELECT
					-- MEMID, LVLID1,LVLID2,LVLID3,LVLID4,LVLDESC1,LVLDESC2,LVLDESC3,LVLDESC4,EffDate,TermDate
				-- FROM
					-- VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
				-- GROUP BY
					-- MEMID, LVLID1,LVLID2,LVLID3,LVLID4,LVLDESC1,LVLDESC2,LVLDESC3,LVLDESC4,EffDate,TermDate
				-- ) b
			-- ON
				-- a.MemID = b.MemID
				-- AND
				-- COALESCE(a.servicedate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN COALESCE(b.EffDate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND COALESCE(b.TermDate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        -- AND
        -- a.lvlid3=b.lvlid3
			-- )
			-- WHERE rn=1
		-- ) d
	-- ON
		-- (
		-- c.MemID=d.MemID
		-- AND
		-- c.servicedate =   d.servicedate
    -- AND
        -- c.lvlid3=d.lvlid3
		-- )
	-- WHEN MATCHED THEN UPDATE SET

		-- c.LVLID2   = d.LVLID2,
		-- c.LVLID4   = d.LVLID4,
		-- c.LVLDESC2 = d.LVLDESC2,
		-- c.LVLDESC4 = d.LVLDESC4,
		-- c.UDFC4 = ''LOA Update : 1st pass :WSTR''
	-- '
	-- ;

-- --------------------------------------------------------------------------------
-- BEGIN EXECUTE IMMEDIATE vbquery;
		 -- xp_scrubStatusLog ('WSTR CLAIMS-LOA UPDATE PASS1',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_ANTHEM_'||EMPID,'Y','I');
	 -- EXCEPTION WHEN OTHERS THEN
		 -- xp_scrubStatusLog ('AnthemRDX CLAIMS LOA update from elig Pass1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 -- END;
-- COMMIT;
-- --------------------------------------------------------------------------------
-- --ICE#290815 : LOA PASS 2 FOR WSTR NOT BEING USED
	-- -- vbQuery:='MERGE INTO
		-- -- VH_CLAIMS_'||vLvl.SERIALNO||' c
	-- -- USING
		-- -- (
		-- -- SELECT
			-- -- MemID,
			-- -- LVLID1,LVLID2,LVLID3,LVLID4,
			-- -- LVLDESC1,LVLDESC2,LVLDESC3,LVLDESC4
		-- -- FROM
			-- -- (
			-- -- SELECT
				-- -- b.MemID,
				-- -- b.LVLID1,b.LVLID2,b.LVLID3,b.LVLID4,b.LVLDESC1,b.LVLDESC2,b.LVLDESC3,b.LVLDESC4,
				-- -- ROW_NUMBER() OVER (PARTITION BY b.MemID ORDER BY b.MemID,b.LVLID1,b.LVLID2,b.LVLID3,b.LVLID4,b.EFFDATE DESC NULLS LAST) rn
			-- -- FROM
				-- -- VH_CLAIMS_'||vLvl.SERIALNO||' a
			-- -- LEFT JOIN
				-- -- (
				-- -- SELECT
					-- -- MEMID, LVLID1,LVLID2,LVLID3,LVLID4,LVLDESC1,LVLDESC2,LVLDESC3,LVLDESC4,EFFDATE
				-- -- FROM
					-- -- VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
					-- -- GROUP BY
					-- -- MEMID, LVLID1,LVLID2,LVLID3,LVLID4,LVLDESC1,LVLDESC2,LVLDESC3,LVLDESC4,EFFDATE
				-- -- ) b
			-- -- ON
				-- -- a.MemID=b.MemID
          -- -- AND
        -- -- a.lvlid3=b.lvlid3

			-- -- )
		-- -- WHERE rn=1
		-- -- ) d
	-- -- ON
		-- -- (
  -- -- c.MemID=d.MemID
  -- -- AND
  -- -- c.lvlid3=d.lvlid3
		-- -- )
	-- -- WHEN MATCHED THEN UPDATE SET

		-- -- c.LVLID2   = d.LVLID2,
		-- -- c.LVLID4   = d.LVLID4,
		-- -- c.LVLDESC2 = d.LVLDESC2,
		-- -- c.LVLDESC4 = d.LVLDESC4,
		-- -- c.UDFC4 = ''LOA Update  :WSTR''
	-- -- WHERE
		-- -- c.UDFC4 IS NULL
	-- -- ';
-- -- -----------------------------------------
-- -- BEGIN EXECUTE IMMEDIATE vbquery;
	 -- -- EXCEPTION WHEN OTHERS THEN
		 -- -- xp_scrubStatusLog ('AnthemRDX CLAIMS Memid update from elig',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 -- -- END;
	 -- -- COMMIT;
-- END IF;

--- LOA Update(Level 2 and Level 4 Update)  --JIRA_15810

		vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
		USING
		(
				SELECT
						/*+ PARALLEL(f,4) */ f.MEMID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4, f.EFFDATE, f.TERMDATE, f.SERVICEDATE
				FROM
						(SELECT
								/*+ PARALLEL(a,4) */ b.MEMID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.SERVICEDATE,
								ROW_NUMBER() OVER (PARTITION BY b.MEMID, b.LVLID3, a.SERVICEDATE ORDER BY b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.memid) rn
				FROM
						VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
				INNER JOIN
						VH_CLAIMS_'||vLvl.SERIALNO||' a
				ON
						b.MEMID=a.MEMID
				AND
						a.source=''ANTHEM_OH'' and  a.LVLID3 = b.LVLID3
				AND
						NVL( a.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
				) f
				WHERE rn=1
		) d
		ON
		(
				c.MEMID=d.MEMID
		AND
				NVL(c.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

		)
		WHEN MATCHED THEN
				UPDATE SET
				c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
				c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
				c.UDFC4=''PASS-1 : Updated from VH_ELIGIBILITIES''
		WHERE c.source=''ANTHEM_OH''';
		---------------------------------------------------------------------
		BEGIN EXECUTE IMMEDIATE vbquery;
				 xp_scrubStatusLog ('CLAIMS-LOA UPDATE PASS1',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_ANTHEM_'||EMPID||'','Y','I');
			 EXCEPTION WHEN OTHERS THEN
				 xp_scrubStatusLog ('ANTHEM_OH CLAIMS LOA update from elig Pass1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
			 END;
		----------------------------------------------------------------------------------------------
		vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
		USING
		(
				SELECT
						/*+ PARALLEL(f,4) */ f.MEMID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4
				FROM
						(SELECT
								/*+ PARALLEL(a,4) */ b.MEMID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4,
								ROW_NUMBER() OVER (PARTITION BY b.MEMID, b.LVLID3 ORDER BY  b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.memid) rn
				FROM
						 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
				INNER JOIN
						VH_CLAIMS_'||vLvl.SERIALNO||' a
				ON
						b.MEMID=a.MEMID
				AND
						a.source=''ANTHEM_OH'' and  a.LVLID3 = b.LVLID3
				) f
				WHERE rn=1
		) d
		ON
		(
				c.MEMID=d.MEMID
		)
		WHEN MATCHED THEN
				UPDATE SET
				c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
				c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
				c.UDFC4=''PASS-2 : Updated from VH_ELIGIBILITIES''
		WHERE c.source=''ANTHEM_OH'' and c.UDFC4 IS NULL  ';
		---------------------------------------------------------------------
		BEGIN EXECUTE IMMEDIATE vbquery;
				 xp_scrubStatusLog ('CLAIMS-LOA UPDATE PASS2',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_ANTHEM_'||EMPID||'','Y','I');
			 EXCEPTION WHEN OTHERS THEN
				 xp_scrubStatusLog ('ANTHEM_OH CLAIMS LOA update from elig Pass2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
			 END;
		----------------------------------------------------------------------------------------------


		vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
		USING
		(
				SELECT
						/*+ PARALLEL(f,4) */ f.ENRID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4,  f.EFFDATE, f.TERMDATE, f.SERVICEDATE
				FROM
						(SELECT
								/*+ PARALLEL(a,4) */ b.ENRID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.SERVICEDATE,
								ROW_NUMBER() OVER (PARTITION BY b.ENRID, b.LVLID3, a.SERVICEDATE ORDER BY  b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.enrid) rn
				FROM
						 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
				INNER JOIN
						VH_CLAIMS_'||vLvl.SERIALNO||' a
				ON
						b.ENRID=a.ENRID
				AND
						a.source=''ANTHEM_OH'' and a.LVLID3 = b.LVLID3
				AND
						NVL( a.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
				) f
				WHERE rn=1
		) d
		ON
		(
				c.ENRID=d.ENRID
		AND
				NVL(c.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
		)
		WHEN MATCHED THEN
				UPDATE SET
				c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
				c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
				c.UDFC4=''PASS-3 : Updated from VH_ELIGIBILITIES''
		WHERE c.source=''ANTHEM_OH'' and c.UDFC4 IS NULL ';
		---------------------------------------------------------------------
		BEGIN EXECUTE IMMEDIATE vbquery;
				 xp_scrubStatusLog ('ANTHEM_OH CLAIMS-LOA UPDATE PASS3',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_ANTHEM_'||EMPID||'','Y','I');
			 EXCEPTION WHEN OTHERS THEN
				 xp_scrubStatusLog ('ANTHEM_OH CLAIMS LOA update from elig Pass3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
			 END;
		----------------------------------------------------------------------------------------------

		vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
		USING
		(
				SELECT
						/*+ PARALLEL(f,4) */ f.ENRID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4
				FROM
						(SELECT
								/*+ PARALLEL(a,4) */ b.ENRID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4,
								ROW_NUMBER() OVER (PARTITION BY b.ENRID, b.LVLID3 ORDER BY  b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.enrid) rn
				FROM
						 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
				INNER JOIN
						VH_CLAIMS_'||vLvl.SERIALNO||' a
				ON
						b.ENRID=a.ENRID
				AND
						a.source=''ANTHEM_OH'' and a.LVLID3 = b.LVLID3
				) f
				WHERE rn=1
		) d
		ON
		(
				c.ENRID=d.ENRID
		)
		WHEN MATCHED THEN
				UPDATE SET
				c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
				c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
				c.UDFC4=''PASS-4 : Updated from VH_ELIGIBILITIES''
		WHERE c.source=''ANTHEM_OH'' and c.UDFC4 IS NULL   ';
		---------------------------------------------------------------------
		BEGIN EXECUTE IMMEDIATE vbquery;
				 xp_scrubStatusLog ('CLAIMS-LOA UPDATE PASS4',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_ANTHEM_'||EMPID||'','Y','I');
			 EXCEPTION WHEN OTHERS THEN
				 xp_scrubStatusLog ('ANTHEM_OH CLAIMS LOA update from elig Pass4',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
		END;
--------------------------------------------------------------------------------
END IF;
----------------------------------------------UHC Claims ------------------------------------
-------------------------------------------------------CLAIMS UHC 134 STARTS--MI Implementation-----------------------------------------------------------------
IF  vLvl.PAYER='UHC' THEN

	VBQUERY := 'DROP TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
		BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM AS
	SELECT
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
        BILLTYPE,
        POSCODE,
        SPECCODE,
        SPECDESC,
        ALLOWEDAMT,
        SRCRELFLAG,
        PLANTYPE,
        PLANNAME,
        COVTYPEDESC,
        PRODUCTID
	FROM
		VH_CLAIMS
	WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('CLAIMS TABLE CREATE UHC',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_CLMS_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	BEGIN
		SP_PYR_134_MED_UHC('HI0826001','HI_CLAIMS_UHC_'||EMPID||'','CLAIMS','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIMS-COMM UHC',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_134_MED_UHC','','E');
	END;
	COMMIT;
----------------------------------------------------------------------------------------------------------

	vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		BILLTYPE,
		POSCODE,
		SPECCODE,
		SPECDESC,
		ALLOWEDAMT,
		SRCRELFLAG,
		PLANTYPE,
		PLANNAME,
		COVTYPEDESC,
		PRODUCTID
	)
	SELECT
		a.ROWID AS SRCROWID,
		''UHC'' AS SOURCE,
		CASE
			WHEN grp.ROLLUPID = ''FERN'' THEN COALESCE(MEM.MEMID,SUBSTR(a.EMPLOYEEID,-9)||UPPER(a.MEMBERSEX)||TO_CHAR(a.MEMBERDATEOFBIRTH,''YYYYMMDD''),''MEMBERID'')
			WHEN grp.memid_grp_flag=''Y'' THEN COALESCE(CASE WHEN grp.ROLLUPID = ''WOOL'' THEN MEM1.MEMID END,  ----ice 284513
			';
		IF EMPID IN ('WOOL','FIAE', 'PHEC','CHWI','HMLT','HDCO', 'CTIS') THEN	--ICE#5317,5264,11345
		vbQuery:=vbQuery||'TWIN.NEW_MEMID,
		';
		END IF;
		IF EMPID IN ('FIGA') THEN	--ICE#6052
		vbQuery:=vbQuery||'COALESCE(MEM3.MEMID,TWIN.NEW_MEMID,NVL(SUBSTR(a.EMPLOYEEID,-9)||UPPER(a.MEMBERSEX)||TO_CHAR(a.MEMBERDATEOFBIRTH,''YYYYMMDD''),''MEMBERID'')||''-''||nvl(grp.ROLLUPID,a.POLICY)),
		';
		END IF;
		vbQuery:=vbQuery||'NVL(SUBSTR(a.EMPLOYEEID,-9)||UPPER(a.MEMBERSEX)||TO_CHAR(a.MEMBERDATEOFBIRTH,''YYYYMMDD''),''MEMBERID'')||''-''||nvl(grp.ROLLUPID,a.POLICY))
			ELSE
			'; 	--ICE_134
		IF EMPID IN ('ERNS','MEVS') THEN
		vbQuery:=vbQuery||'COALESCE(MEM2.MEMID,SUBSTR(a.EMPLOYEEID,-9)||UPPER(a.MEMBERSEX)||TO_CHAR(a.MEMBERDATEOFBIRTH,''YYYYMMDD''),''MEMBERID'')
		';
		ELSE
		vbQuery:=vbQuery||'COALESCE(SUBSTR(a.EMPLOYEEID,-9)||UPPER(a.MEMBERSEX)||TO_CHAR(a.MEMBERDATEOFBIRTH,''YYYYMMDD''),''MEMBERID'')
		';
		END IF;
		vbQuery:=vbQuery||'
			END AS MemID,
		';  --ICE_134
		IF EMPID='ERNS' THEN
		vbQuery:=vbQuery||'COALESCE(MEM2.ENRID,SUBSTR(a.EMPLOYEEID,-9),''EMPLOYEEID'') AS ENRID,
		';
		ELSIF EMPID='FIGA' THEN
		vbQuery:=vbQuery||'COALESCE(MEM3.ENRID,NVL(SUBSTR(a.EMPLOYEEID,-9),''EMPLOYEEID'')||''-''||nvl(grp.ROLLUPID,a.POLICY)) AS ENRID,
		';
		ELSE
		vbQuery:=vbQuery||'   --ICE271567
		CASE
			WHEN grp.ROLLUPID = ''FERN'' THEN COALESCE(MEM.ENRID,SUBSTR(a.EMPLOYEEID,-9),''EMPLOYEEID'')
			WHEN grp.memid_grp_flag=''Y'' THEN COALESCE(CASE WHEN grp.ROLLUPID = ''WOOL'' THEN MEM1.MEMID END,NVL(SUBSTR(a.EMPLOYEEID,-9),''EMPLOYEEID'')||''-''||nvl(grp.ROLLUPID,a.POLICY))   ----ice 284513
			ELSE COALESCE(SUBSTR(a.EMPLOYEEID,-9),''EMPLOYEEID'')
		  END	AS ENRID,  --ICE271567
		';
		END IF;
		vbQuery:= vbQuery||'   --287830E
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		lv.ROLLUP_PLANID AS LVLID2,
		lv.ROLLUP_PLANNM  AS LVLDESC2,
		nvl(grp.ROLLUPID,a.POLICY) AS LVLID3,
		nvl(grp.Group_Name,a.POLICY) AS LVLDESC3,
		lv.ROLLUP_SUB_GRPID AS LVLID4,
		lv.ROLLUP_SUB_GRPNM AS LVLDESC4,
		CASE WHEN fnpi.npi_facility IS NOT NULL THEN ''F'' ELSE ''P'' END  AS BILLTYPE, ---229688
		CASE
			WHEN UPPER(A.PROVIDERTYPE)=''UC'' THEN ''20''
			ELSE COALESCE(po.rollup_CD,a.PLACEOFSERVICE)
		  END AS POSCODE,			--ice268341
		COALESCE((SELECT h.Rollup_code FROM HR_826_SPEC h WHERE a.PROVIDERSPECIALTYCODE =h.SRCCODE AND h.PAYER = ''UHC''), a.PROVIDERSPECIALTYCODE,X.IMPLIEDSPECCODE) AS SPECCODE,
		UPPER(COALESCE((SELECT h.Rollup_Desc FROM HR_826_SPEC h WHERE a.PROVIDERSPECIALTYCODE =h.SRCCODE AND h.PAYER = ''UHC''),a.PROVIDERSPECIALTYCODE,X.IMPLIEDSPECDESC)) AS SPECDESC,
		CASE
			WHEN grp.ROLLUPID in (''FIAE'',  ''WOOL'',''FIGA'', ''PHEC'', ''BEOR'', ''XENI'', ''CLAR'', ''KENT'', ''ARMO'', ''WARR'',''730337'',''704711'',''ERNS'',''HMLT'',''003321010'',''HDCO'',''CTIS'',''DRCO'',''PLT'') THEN NVL(a.COPAY,0)+NVL(a.COINSURANCE,0)+NVL(a.DEDUCTIBLE,0)+a.NETPAID
			ELSE a.ALLOWABLEEXPENSE
		  END AS ALLOWEDAMT,    --283275    284513  304238 381594 ICE_134, 3967,5264, 11345 , --JIRA_ICE#16219
		(SELECT R.rollup_desc FROM HR_826_REL R WHERE R.source = ''UHC_CLM'' AND R.src_code=a.MEMBERRELATIONSHIPCODE ) SRCRELFLAG,
		lv.PLANTYPE PLANTYPE ,
		lv.ROLLUP_PLANNM PLANNAME,
		''MEDICAL'' COVTYPEDESC,
		''1'' as PRODUCTID
	FROM
		HI0826001.HI_CLAIMS_UHC_'||EMPID||' a

	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.POLICY = grp.SRC_CODE

	LEFT JOIN
		HR_826_UHC_LOA lv
	ON
		a.POLICY = lv.SRC_CD1
		AND
		a.PLANVARIATIONCODE = lv.SRC_CD2

	LEFT JOIN
		HR_826_POS po
	ON
		po.source =	''UHC''
		AND
		a.PLACEOFSERVICE = po.src_cd

	LEFT JOIN        ----229688--
		ZZZ_FAC_NPI fnpi
	ON
		a.NPINUMBER =fnpi.NPI_FACILITY

	LEFT JOIN
		zzz_NPI n
	ON
		n.NPI = a.NPINUMBER

  LEFT JOIN
		ZZZ_PYR_PROCS  p1
	ON
		a.SERVICECODE = p1.PROCCODE

	LEFT JOIN
		ZZZ_PYR_PROCS  p2
	ON
		''I''|| a.PRIMARYSURGICALPROCEDURECODE = p2.PROCCODE

	LEFT JOIN
		ZZZ_PYR_PROCS  P3
	ON
		''I'' || a.SECONDARYSURGICALPROCEDURECODE = P3.PROCCODE

	LEFT JOIN
		ZZZ_PYR_PROCS  P4
	ON
		''I'' || a.TERTIARYSURGICALPROCEDURECODE = P4.PROCCODE

	LEFT JOIN
		ZZZ_PYR_PROCS  p5
	ON
		''R''||CASE WHEN LENGTH(a.REVENUECODE1) = 4 AND SUBSTR(REVENUECODE1,1,1) = ''0'' THEN SUBSTR(a.REVENUECODE1,-3) ELSE a.REVENUECODE1 END = p5.PROCCODE

	LEFT JOIN
		ZZZ_PYR_PROCS  p6
	ON
		''R''||CASE WHEN LENGTH(a.REVENUECODE2) = 4 AND SUBSTR(REVENUECODE2,1,1) = ''0'' THEN SUBSTR(a.REVENUECODE2,-3) ELSE a.REVENUECODE2 END =  p6.PROCCODE

	LEFT JOIN
		ZZZ_PYR_PROCS  p10
	ON
		''D''|| SUBSTR(a.HOSPITALDRG,-3) = P10.PROCCODE

	LEFT JOIN 	--259744
		ZZZ_SPECS X
	ON
	  Coalesce(p1.PROCCODE,p2.PROCCODE,p3.PROCCODE,p4.PROCCODE,p5.PROCCODE,p6.PROCCODE,p10.PROCCODE,a.SERVICECODE,a.PRIMARYSURGICALPROCEDURECODE,a.SECONDARYSURGICALPROCEDURECODE,a.TERTIARYSURGICALPROCEDURECODE,a.REVENUECODE1,a.REVENUECODE2,a.REVENUECODE3,a.REVENUECODE4,a.REVENUECODE5,a.HOSPITALDRG)= x.PROCCODE

	LEFT JOIN
		ZZZ_MEMID_UPDATE_ANTHEM_UHC MEM
	ON
		UPPER(a.MEMBERFIRSTNAME) = MEM.MEMFIRSTNAME
		AND
		UPPER(a.MEMBERLASTNAME) = MEM.MEMLASTNAME
		AND
		CASE WHEN a.MEMBERSEX IN (''F'',''M'') THEN  a.MEMBERSEX ELSE ''U'' END = MEM.GENDER
		AND
		a.MEMBERDATEOFBIRTH = MEM.DOB
		AND
		nvl(grp.ROLLUPID,a.POLICY) = MEM.LVL3ID  --ICE271567

	LEFT JOIN
		ZZZ_MEMID_UPDATE_ANTHEM_WOOL MEM1  --283275
	ON
		UPPER(a.MEMBERFIRSTNAME) = MEM1.MEMFIRSTNAME
		AND
		UPPER(a.MEMBERLASTNAME) = MEM1.MEMLASTNAME
		AND
		CASE WHEN a.MEMBERSEX IN (''F'',''M'') THEN a.MEMBERSEX ELSE ''U'' END = MEM1.GENDER
		AND
		a.MEMBERDATEOFBIRTH = MEM1.DOB
		AND
		nvl(grp.ROLLUPID,a.POLICY) = MEM1.LVL3ID
	';
	IF EMPID IN ('WOOL','FIGA', 'FIAE', 'PHEC','CHWI','HMLT','HDCO', 'CTIS') THEN     --ICE 5264
	vbQuery := vbQuery || '
	LEFT JOIN
		ZZZ_UHC_'||EMPID||'_TWIN TWIN
	ON
		UPPER(a.MEMBERFIRSTNAME) = TWIN.MEMFIRSTNAME
		AND
		UPPER(a.MEMBERLASTNAME) = TWIN.MEMLASTNAME
		AND
		CASE WHEN a.MEMBERSEX IN (''F'',''M'') THEN a.MEMBERSEX ELSE ''U'' END = TWIN.GENDER
		AND
		a.MEMBERDATEOFBIRTH = TWIN.DOB
		AND
		nvl(grp.ROLLUPID,a.POLICY) = TWIN.LVL3ID
	';
	END IF;
   --ICE_134
	IF EMPID IN ('ERNS','MEVS') THEN
	vbQuery := vbQuery||'
	LEFT JOIN
		ZZZ_VH_ELIG_MEMUPD_'||EMPID||'_UHC MEM2
	ON
		UPPER(a.MEMBERFIRSTNAME) = MEM2.MEMFIRSTNAME
		AND
		UPPER(a.MEMBERLASTNAME) = MEM2.MEMLASTNAME
		AND
		CASE WHEN a.MEMBERSEX IN (''F'',''M'') THEN a.MEMBERSEX ELSE ''U'' END = MEM2.GENDER
		AND
		a.MEMBERDATEOFBIRTH = MEM2.DOB
		AND
		nvl(grp.ROLLUPID,a.POLICY) = MEM2.LVLID3
	';
	END IF;
	IF EMPID IN ('FIGA') THEN
	vbQuery := vbQuery||'
	LEFT JOIN
		ZZZ_AETNA_ELIG_MEMUPD_FIGA MEM3
	ON
		UPPER(a.MEMBERFIRSTNAME) = MEM3.MEMFIRSTNAME
		AND
		UPPER(a.MEMBERLASTNAME) = MEM3.MEMLASTNAME
		AND
		UPPER(CASE WHEN UPPER(a.MEMBERSEX) IN (''F'',''M'') THEN  UPPER(a.MEMBERSEX) ELSE ''U'' END) = UPPER(MEM3.GENDER)
		AND
		a.MEMBERDATEOFBIRTH = MEM3.DOB
		AND
		nvl(grp.ROLLUPID,a.POLICY) = MEM3.LVLID3
		AND
		CASE
			WHEN UPPER(a.MEMBERRELATIONSHIPCODE) IN (''18'',''20'',''RR'') THEN ''E''
			WHEN UPPER(a.MEMBERRELATIONSHIPCODE) IN (''01'',''SS'',''DP'') THEN ''S''
			WHEN UPPER(a.MEMBERRELATIONSHIPCODE) IN (''02'',''17'',''19'',''22'',''23'',''27'',''38'',''SW'',''NB'',''HS'') THEN ''D''
			ELSE ''U''
		END  = MEM3.RELFLAG
	';
	END IF;
	vbQuery := vbQuery || '
	WHERE
		NVL(lv.DROP_PLAN,''N'')=''N''		--ICE #169508
	';

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('CLAIMS-CSTM UHC',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIMS-CSTM UHC',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
	END;
	COMMIT;
------------------------------------------------------------------------------------------------------------------
	BEGIN
		SP_CDF_TBL_MERGE(USER,'CLAIMS-MERGE UHC','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM','VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_CLAIMS_'||vLvl.SERIALNO||'_UHC');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIMS-MERGE UHC',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	END;
	COMMIT;

---------------------------------- Start of Insert of UHC OR dropped data back ---------------------------------------------------------------

	VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_CLAIMS_'||vLvl.SERIALNO||'_UHC';

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('UHC FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('UHC FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
	END;
	COMMIT;

-----------------------------------------------------ICE 10670----------------------
--BEGIN
--	UTILITY.PKG_UPDATE.SP_LOA
--	(
--		FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
--		TO_TABLENAME =>	 'VH_CLAIMS_'||vLvl.SERIALNO||'',
--		UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
--		DELIMITER =>		'-',
--		UPDATE_PASSES =>	'1-2-3-4',
--		LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
--		LVL_DESC_YN =>	  'Y',
--		PASS_1_JOIN_CONDITION =>	'[a.source]=''UHC'' and  a.LVLID3 = b.LVLID3',
--		PASS_1_UPDATE_CONDITION =>	'[a.source]=''UHC''',
--		PASS_2_JOIN_CONDITION =>	'[a.source]=''UHC'' and  a.LVLID3 = b.LVLID3',
--		PASS_2_UPDATE_CONDITION =>	'[a.source]=''UHC'' and [a.UDFC4] IS NULL',
--		PASS_3_JOIN_CONDITION =>	'[a.source]=''UHC'' and a.LVLID3 = b.LVLID3',
--		PASS_3_UPDATE_CONDITION =>	'[a.source]=''UHC'' and [a.UDFC4] IS NULL',
--		PASS_4_JOIN_CONDITION =>	'[a.source]=''UHC'' and a.LVLID3 = b.LVLID3',
--		PASS_4_UPDATE_CONDITION =>	'[a.source]=''UHC'' and [a.UDFC4] IS NULL',
--		begin_END_DTE_YN =>	 'N',
--		STABLE_FROM_TABLE_YN =>	 'N',
--		ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
--	);
--END;


--- LOA Update(Level 2 and Level 4 Update)  --ICE-14836 --15656 starts

vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.LVLID2, f.LVLDESC2, f.LVLID3, f.LVLID4, f.LVLDESC4, f.EFFDATE, f.TERMDATE, f.SERVICEDATE
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID, b.LVLID2, b.LVLDESC2, b.LVLID3, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.SERVICEDATE,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, b.LVLID3, a.SERVICEDATE ORDER BY b.EFFDATE DESC NULLS LAST, b.TERMDATE DESC,b.LVLID2, b.LVLID4, b.MEMID) rn
        FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.source=''UHC'' and  a.LVLID3 = b.LVLID3
        AND
                NVL( a.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        ) f
        WHERE rn=1
) d
ON
(
        c.MEMID=d.MEMID
AND
        NVL(c.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
and
		c.LVLID3 = d.LVLID3

)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-1 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UHC''';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('CLAIMS-LOA UPDATE PASS1',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_UHC_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UHC CLAIMS_UHC LOA update from elig Pass1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------
vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.LVLID2, f.LVLDESC2, f.LVLID3, f.LVLID4, f.LVLDESC4
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID, b.LVLID2, b.LVLDESC2, b.LVLID3, b.LVLID4, b.LVLDESC4,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, b.LVLID3 ORDER BY b.EFFDATE DESC NULLS LAST, b.TERMDATE DESC,b.LVLID2, b.LVLID4, b.MEMID) rn
        FROM
                 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.source=''UHC'' and  a.LVLID3 = b.LVLID3
        ) f
        WHERE rn=1
) d
ON
(
        c.MEMID=d.MEMID
and
		c.LVLID3 = d.LVLID3
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-2 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UHC'' and c.UDFC4 IS NULL  ';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('CLAIMS-LOA UPDATE PASS2',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_UHC_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UHC CLAIMS_UHC LOA update from elig Pass2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------


vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, f.LVLID2, f.LVLDESC2, f.LVLID3, f.LVLID4, f.LVLDESC4,  f.EFFDATE, f.TERMDATE, f.SERVICEDATE
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, b.LVLID2, b.LVLDESC2, b.LVLID3, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.SERVICEDATE,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID, b.LVLID3, a.SERVICEDATE ORDER BY b.EFFDATE DESC NULLS LAST, b.TERMDATE DESC,b.LVLID2, b.LVLID4, b.ENRID) rn
        FROM
                 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.source=''UHC'' and a.LVLID3 = b.LVLID3
        AND
                NVL( a.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        ) f
        WHERE rn=1
) d
ON
(
        c.ENRID=d.ENRID
AND
        NVL(c.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
and
		c.LVLID3 = d.LVLID3
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-3 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UHC'' and c.UDFC4 IS NULL ';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('CLAIMS-LOA UPDATE PASS3',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_UHC_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UHC CLAIMS_UHC LOA update from elig Pass3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------

vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, f.LVLID2, f.LVLDESC2, f.LVLID3, f.LVLID4, f.LVLDESC4
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, b.LVLID2, b.LVLDESC2, b.LVLID3, b.LVLID4, b.LVLDESC4,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID, b.LVLID3 ORDER BY b.EFFDATE DESC NULLS LAST, b.TERMDATE DESC,b.LVLID2, b.LVLID4, b.ENRID) rn
        FROM
                  VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.source=''UHC'' and a.LVLID3 = b.LVLID3
        ) f
        WHERE rn=1
) d
ON
(
        c.ENRID=d.ENRID
and
		c.LVLID3 = d.LVLID3
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-4 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UHC'' and c.UDFC4 IS NULL    ';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('CLAIMS-LOA UPDATE PASS4',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_UHC_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UMR CLAIMS_UHC LOA update from elig Pass4',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
 --15656 ends

END IF;

----------------------------------------------------------------------------------------------

---------------------------------------------------------------UHC 134 ends---MI Implementation--------------------------------------------
----------------------------------------------UHC Claims 5600 ICE-11205------------------------------------
IF  vLvl.PAYER='UHC_5600' OR vLvl.PAYER='UHC' THEN

	VBQUERY := 'DROP TABLE VH_CLAIMS_5600_'||vLvl.SERIALNO||'_CSTM PURGE';
		BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_CLAIMS_5600_'||vLvl.SERIALNO||'_CSTM AS
	SELECT
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
        BILLTYPE,
        POSCODE,
        SPECCODE,
        SPECDESC,
        ALLOWEDAMT,
        SRCRELFLAG,
        PLANTYPE,
        PLANNAME,
        COVTYPEDESC,
        PRODUCTID
	FROM
		VH_CLAIMS
	WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('CLAIMS TABLE CREATE UHC 5600',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_CLAIMS_5600_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_CLAIMS_5600_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_CLMS_1_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	BEGIN
		SP_PYR_5600_MED_UHC('HI0826001','HI_CLAIMS_UHC_5600_'||EMPID||'','CLAIMS','VH_CLAIMS_5600_'||vLvl.SERIALNO||'_COMM');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIMS-COMM-1 UHC',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_5600_MED_UHC','','E');
	END;
	COMMIT;
----------------------------------------------------------------------------------------------------------

	vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_CLAIMS_5600_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		BILLTYPE,
		POSCODE,
		SPECCODE,
		SPECDESC,
		ALLOWEDAMT,
		SRCRELFLAG,
		PLANTYPE,
		PLANNAME,
		COVTYPEDESC,
		PRODUCTID
	)
	SELECT
		a.ROWID AS SRCROWID,
		''UHC'' AS SOURCE,
		CASE
			WHEN grp.ROLLUPID = ''FERN'' THEN COALESCE(MEM.MEMID,SUBSTR(a.EMPLOYEEID,-9)||UPPER(a.MEMBERSEX)||TO_CHAR(a.MEMBERDATEOFBIRTH,''YYYYMMDD''),''MEMBERID'')
			WHEN grp.memid_grp_flag=''Y'' THEN COALESCE(CASE WHEN grp.ROLLUPID = ''WOOL'' THEN MEM1.MEMID END,  ----ice 284513
			';
		IF EMPID IN ('WOOL','FIAE', 'PHEC','CHWI','HMLT','HDCO', 'CTIS','DRCO','LSIN') THEN	--ICE#5317,5264,11205 --ICE-16119
		vbQuery:=vbQuery||'TWIN.NEW_MEMID,
		';
		END IF;
		IF EMPID IN ('FIGA') THEN	--ICE#6052
		vbQuery:=vbQuery||'COALESCE(MEM3.MEMID,TWIN.NEW_MEMID,NVL(SUBSTR(a.EMPLOYEEID,-9)||UPPER(a.MEMBERSEX)||TO_CHAR(a.MEMBERDATEOFBIRTH,''YYYYMMDD''),''MEMBERID'')||''-''||nvl(grp.ROLLUPID,a.POLICY)),
		';
		END IF;
		vbQuery:=vbQuery||'NVL(SUBSTR(a.EMPLOYEEID,-9)||UPPER(a.MEMBERSEX)||TO_CHAR(a.MEMBERDATEOFBIRTH,''YYYYMMDD''),''MEMBERID'')||''-''||nvl(grp.ROLLUPID,a.POLICY))
			ELSE
			'; 	--ICE_134
		IF EMPID IN ('ERNS','MEVS') THEN
		vbQuery:=vbQuery||'COALESCE(MEM2.MEMID,SUBSTR(a.EMPLOYEEID,-9)||UPPER(a.MEMBERSEX)||TO_CHAR(a.MEMBERDATEOFBIRTH,''YYYYMMDD''),''MEMBERID'')
		';
		ELSE
		vbQuery:=vbQuery||'COALESCE(SUBSTR(a.EMPLOYEEID,-9)||UPPER(a.MEMBERSEX)||TO_CHAR(a.MEMBERDATEOFBIRTH,''YYYYMMDD''),''MEMBERID'')
		';
		END IF;
		vbQuery:=vbQuery||'
			END AS MemID,
		';  --ICE_134
		IF EMPID='ERNS' THEN
		vbQuery:=vbQuery||'COALESCE(MEM2.ENRID,SUBSTR(a.EMPLOYEEID,-9),''EMPLOYEEID'') AS ENRID,
		';
		ELSIF EMPID='FIGA' THEN
		vbQuery:=vbQuery||'COALESCE(MEM3.ENRID,NVL(SUBSTR(a.EMPLOYEEID,-9),''EMPLOYEEID'')||''-''||nvl(grp.ROLLUPID,a.POLICY)) AS ENRID,
		';
		ELSE
		vbQuery:=vbQuery||'   --ICE271567
		CASE
			WHEN grp.ROLLUPID = ''FERN'' THEN COALESCE(MEM.ENRID,SUBSTR(a.EMPLOYEEID,-9),''EMPLOYEEID'')
			WHEN grp.memid_grp_flag=''Y'' THEN COALESCE(CASE WHEN grp.ROLLUPID = ''WOOL'' THEN MEM1.MEMID END,NVL(SUBSTR(a.EMPLOYEEID,-9),''EMPLOYEEID'')||''-''||nvl(grp.ROLLUPID,a.POLICY))   ----ice 284513
			ELSE COALESCE(SUBSTR(a.EMPLOYEEID,-9),''EMPLOYEEID'')
		  END	AS ENRID,  --ICE271567
		';
		END IF;
		vbQuery:= vbQuery||'   --287830E
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		lv.ROLLUP_PLANID AS LVLID2,
		lv.ROLLUP_PLANNM  AS LVLDESC2,
		nvl(grp.ROLLUPID,a.POLICY) AS LVLID3,
		nvl(grp.Group_Name,a.POLICY) AS LVLDESC3,
		lv.ROLLUP_SUB_GRPID AS LVLID4,
		lv.ROLLUP_SUB_GRPNM AS LVLDESC4,
		CASE WHEN fnpi.npi_facility IS NOT NULL THEN ''F'' ELSE ''P'' END  AS BILLTYPE, ---229688
		CASE
			WHEN UPPER(A.PROVIDERTYPE)=''UC'' THEN ''20''
			ELSE COALESCE(po.rollup_CD,a.PLACEOFSERVICE)
		  END AS POSCODE,			--ice268341
		COALESCE((SELECT h.Rollup_code FROM HR_826_SPEC h WHERE a.PROVIDERSPECIALTYCODE =h.SRCCODE AND h.PAYER = ''UHC''), a.PROVIDERSPECIALTYCODE,X.IMPLIEDSPECCODE) AS SPECCODE,
		UPPER(COALESCE((SELECT h.Rollup_Desc FROM HR_826_SPEC h WHERE a.PROVIDERSPECIALTYCODE =h.SRCCODE AND h.PAYER = ''UHC''),a.PROVIDERSPECIALTYCODE,X.IMPLIEDSPECDESC)) AS SPECDESC,
		CASE
			WHEN grp.ROLLUPID in (''FIAE'',  ''WOOL'',''FIGA'', ''PHEC'', ''BEOR'', ''XENI'', ''CLAR'', ''KENT'', ''ARMO'', ''WARR'',''730337'',''704711'',''ERNS'',''HMLT'',''003321010'',''HDCO'',''CTIS'',''DRCO'',''PLT'',''LSIN'') THEN NVL(a.COPAY,0)+NVL(a.COINSURANCE,0)+NVL(a.DEDUCTIBLE,0)+a.NETPAID
			ELSE a.ALLOWABLEEXPENSE
		  END AS ALLOWEDAMT,    --283275    284513  304238 381594 ICE_134, 3967,5264 --ICE-14138,--JIRA_ICE#16219 --ICE-16119
		(SELECT R.rollup_desc FROM HR_826_REL R WHERE R.source = ''UHC_CLM'' AND R.src_code=a.MEMBERRELATIONSHIPCODE ) SRCRELFLAG,
		lv.PLANTYPE PLANTYPE ,
		lv.ROLLUP_PLANNM PLANNAME,
		''MEDICAL'' COVTYPEDESC,
		''1'' as PRODUCTID
	FROM
		HI0826001.HI_CLAIMS_UHC_5600_'||EMPID||' a

	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.POLICY = grp.SRC_CODE

	LEFT JOIN
		HR_826_UHC_LOA lv
	ON
		a.POLICY = lv.SRC_CD1
		AND
		a.PLANVARIATIONCODE = lv.SRC_CD2

	LEFT JOIN
		HR_826_POS po
	ON
		po.source =	''UHC''
		AND
		a.PLACEOFSERVICE = po.src_cd

	LEFT JOIN        ----229688--
		ZZZ_FAC_NPI fnpi
	ON
		a.NPINUMBER =fnpi.NPI_FACILITY

	LEFT JOIN
		zzz_NPI n
	ON
		n.NPI = a.NPINUMBER

  LEFT JOIN
		ZZZ_PYR_PROCS  p1
	ON
		a.SERVICECODE = p1.PROCCODE

	LEFT JOIN
		ZZZ_PYR_PROCS  p2
	ON
		''I''|| a.PRIMARYSURGICALPROCEDURECODE = p2.PROCCODE

	LEFT JOIN
		ZZZ_PYR_PROCS  P3
	ON
		''I'' || a.SECONDARYSURGICALPROCEDURECODE = P3.PROCCODE

	LEFT JOIN
		ZZZ_PYR_PROCS  P4
	ON
		''I'' || a.TERTIARYSURGICALPROCEDURECODE = P4.PROCCODE

	LEFT JOIN
		ZZZ_PYR_PROCS  p5
	ON
		''R''||CASE WHEN LENGTH(a.REVENUECODE1) = 4 AND SUBSTR(REVENUECODE1,1,1) = ''0'' THEN SUBSTR(a.REVENUECODE1,-3) ELSE a.REVENUECODE1 END = p5.PROCCODE

	LEFT JOIN
		ZZZ_PYR_PROCS  p6
	ON
		''R''||CASE WHEN LENGTH(a.REVENUECODE2) = 4 AND SUBSTR(REVENUECODE2,1,1) = ''0'' THEN SUBSTR(a.REVENUECODE2,-3) ELSE a.REVENUECODE2 END =  p6.PROCCODE

	LEFT JOIN
		ZZZ_PYR_PROCS  p10
	ON
		''D''|| SUBSTR(a.HOSPITALDRG,-3) = P10.PROCCODE

	LEFT JOIN 	--259744
		ZZZ_SPECS X
	ON
	  Coalesce(p1.PROCCODE,p2.PROCCODE,p3.PROCCODE,p4.PROCCODE,p5.PROCCODE,p6.PROCCODE,p10.PROCCODE,a.SERVICECODE,a.PRIMARYSURGICALPROCEDURECODE,a.SECONDARYSURGICALPROCEDURECODE,a.TERTIARYSURGICALPROCEDURECODE,a.REVENUECODE1,a.REVENUECODE2,a.REVENUECODE3,a.REVENUECODE4,a.REVENUECODE5,a.HOSPITALDRG)= x.PROCCODE

	LEFT JOIN
		ZZZ_MEMID_UPDATE_ANTHEM_UHC MEM
	ON
		UPPER(a.MEMBERFIRSTNAME) = MEM.MEMFIRSTNAME
		AND
		UPPER(a.MEMBERLASTNAME) = MEM.MEMLASTNAME
		AND
		CASE WHEN a.MEMBERSEX IN (''F'',''M'') THEN  a.MEMBERSEX ELSE ''U'' END = MEM.GENDER
		AND
		a.MEMBERDATEOFBIRTH = MEM.DOB
		AND
		nvl(grp.ROLLUPID,a.POLICY) = MEM.LVL3ID  --ICE271567

	LEFT JOIN
		ZZZ_MEMID_UPDATE_ANTHEM_WOOL MEM1  --283275
	ON
		UPPER(a.MEMBERFIRSTNAME) = MEM1.MEMFIRSTNAME
		AND
		UPPER(a.MEMBERLASTNAME) = MEM1.MEMLASTNAME
		AND
		CASE WHEN a.MEMBERSEX IN (''F'',''M'') THEN a.MEMBERSEX ELSE ''U'' END = MEM1.GENDER
		AND
		a.MEMBERDATEOFBIRTH = MEM1.DOB
		AND
		nvl(grp.ROLLUPID,a.POLICY) = MEM1.LVL3ID
	';
	IF EMPID IN ('WOOL','FIGA', 'FIAE', 'PHEC','CHWI','HMLT','HDCO', 'CTIS','DRCO','LSIN') THEN     --ICE 5264 --ICE-14138 --ICE-16119
	vbQuery := vbQuery || '
	LEFT JOIN
		ZZZ_UHC_'||EMPID||'_TWIN TWIN
	ON
		UPPER(a.MEMBERFIRSTNAME) = TWIN.MEMFIRSTNAME
		AND
		UPPER(a.MEMBERLASTNAME) = TWIN.MEMLASTNAME
		AND
		CASE WHEN a.MEMBERSEX IN (''F'',''M'') THEN a.MEMBERSEX ELSE ''U'' END = TWIN.GENDER
		AND
		a.MEMBERDATEOFBIRTH = TWIN.DOB
		AND
		nvl(grp.ROLLUPID,a.POLICY) = TWIN.LVL3ID
	';
	END IF;
   --ICE_134
	IF EMPID IN ('ERNS','MEVS') THEN
	vbQuery := vbQuery||'
	LEFT JOIN
		ZZZ_VH_ELIG_MEMUPD_'||EMPID||'_UHC MEM2
	ON
		UPPER(a.MEMBERFIRSTNAME) = MEM2.MEMFIRSTNAME
		AND
		UPPER(a.MEMBERLASTNAME) = MEM2.MEMLASTNAME
		AND
		CASE WHEN a.MEMBERSEX IN (''F'',''M'') THEN a.MEMBERSEX ELSE ''U'' END = MEM2.GENDER
		AND
		a.MEMBERDATEOFBIRTH = MEM2.DOB
		AND
		nvl(grp.ROLLUPID,a.POLICY) = MEM2.LVLID3
	';
	END IF;
	IF EMPID IN ('FIGA') THEN
	vbQuery := vbQuery||'
	LEFT JOIN
		ZZZ_AETNA_ELIG_MEMUPD_FIGA MEM3
	ON
		UPPER(a.MEMBERFIRSTNAME) = MEM3.MEMFIRSTNAME
		AND
		UPPER(a.MEMBERLASTNAME) = MEM3.MEMLASTNAME
		AND
		UPPER(CASE WHEN UPPER(a.MEMBERSEX) IN (''F'',''M'') THEN  UPPER(a.MEMBERSEX) ELSE ''U'' END) = UPPER(MEM3.GENDER)
		AND
		a.MEMBERDATEOFBIRTH = MEM3.DOB
		AND
		nvl(grp.ROLLUPID,a.POLICY) = MEM3.LVLID3
		AND
		CASE
			WHEN UPPER(a.MEMBERRELATIONSHIPCODE) IN (''18'',''20'',''RR'') THEN ''E''
			WHEN UPPER(a.MEMBERRELATIONSHIPCODE) IN (''01'',''SS'',''DP'') THEN ''S''
			WHEN UPPER(a.MEMBERRELATIONSHIPCODE) IN (''02'',''17'',''19'',''22'',''23'',''27'',''38'',''SW'',''NB'',''HS'') THEN ''D''
			ELSE ''U''
		END  = MEM3.RELFLAG
	';
	END IF;
	vbQuery := vbQuery || '
	WHERE
		NVL(lv.DROP_PLAN,''N'')=''N''		--ICE #169508
	';

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('CLAIMS-CSTM UHC 5600',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIMS-CSTM UHC 5600',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
	END;
	COMMIT;
------------------------------------------------------------------------------------------------------------------
	BEGIN
		SP_CDF_TBL_MERGE(USER,'CLAIMS-MERGE-1 UHC','VH_CLAIMS_5600_'||vLvl.SERIALNO||'_COMM','VH_CLAIMS_5600_'||vLvl.SERIALNO||'_CSTM','VH_CLAIMS_5600_'||vLvl.SERIALNO||'_UHC');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIMS-MERGE UHC 5600',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	END;
	COMMIT;

---------------------------------- Start of Insert of UHC OR dropped data back ---------------------------------------------------------------

	VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_CLAIMS_5600_'||vLvl.SERIALNO||'_UHC';

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('UHC FINAL INSERT 5600',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('UHC FINAL INSERT 5600',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
	END;
	COMMIT;

---------------------------------------------------------------------------
--BEGIN
--	UTILITY.PKG_UPDATE.SP_LOA
--	(
--		FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
--		TO_TABLENAME =>	 'VH_CLAIMS_'||vLvl.SERIALNO||'',
--		UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
--		DELIMITER =>		'-',
--		UPDATE_PASSES =>	'1-2-3-4',
--		LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
--		LVL_DESC_YN =>	  'Y',
--		PASS_1_JOIN_CONDITION =>	'[a.source]=''UHC'' and  a.LVLID3 = b.LVLID3',
--		PASS_1_UPDATE_CONDITION =>	'[a.source]=''UHC''',
--		PASS_2_JOIN_CONDITION =>	'[a.source]=''UHC'' and  a.LVLID3 = b.LVLID3',
--		PASS_2_UPDATE_CONDITION =>	'[a.source]=''UHC'' and [a.UDFC4] IS NULL',
--		PASS_3_JOIN_CONDITION =>	'[a.source]=''UHC'' and a.LVLID3 = b.LVLID3',
--		PASS_3_UPDATE_CONDITION =>	'[a.source]=''UHC'' and [a.UDFC4] IS NULL',
--		PASS_4_JOIN_CONDITION =>	'[a.source]=''UHC'' and a.LVLID3 = b.LVLID3',
--		PASS_4_UPDATE_CONDITION =>	'[a.source]=''UHC'' and [a.UDFC4] IS NULL',
--		begin_END_DTE_YN =>	 'N',
--		STABLE_FROM_TABLE_YN =>	 'N',
--		ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
--	);
--END;


--- LOA Update(Level 2 and Level 4 Update)  --ICE-14836

vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.LVLID2, f.LVLDESC2, f.LVLID3, f.LVLID4, f.LVLDESC4, f.EFFDATE, f.TERMDATE, f.SERVICEDATE
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID, b.LVLID2, b.LVLDESC2, b.LVLID3, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.SERVICEDATE,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, b.LVLID3, a.SERVICEDATE ORDER BY b.EFFDATE DESC NULLS LAST, b.TERMDATE DESC,b.LVLID2, b.LVLID4, b.MEMID) rn
        FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.source=''UHC'' and  a.LVLID3 = b.LVLID3
        AND
                NVL( a.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        ) f
        WHERE rn=1
) d
ON
(
        c.MEMID=d.MEMID
AND
        NVL(c.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
and
		c.LVLID3 = d.LVLID3

)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-1 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UHC''';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('CLAIMS-LOA UPDATE PASS1',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_UHC_5600_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UHC CLAIMS_UHC_5600 LOA update from elig Pass1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------
vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.LVLID2, f.LVLDESC2, f.LVLID3, f.LVLID4, f.LVLDESC4
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID, b.LVLID2, b.LVLDESC2, b.LVLID3, b.LVLID4, b.LVLDESC4,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, b.LVLID3 ORDER BY b.EFFDATE DESC NULLS LAST, b.TERMDATE DESC,b.LVLID2, b.LVLID4, b.MEMID) rn
        FROM
                 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.source=''UHC'' and  a.LVLID3 = b.LVLID3
        ) f
        WHERE rn=1
) d
ON
(
        c.MEMID=d.MEMID
and
		c.LVLID3 = d.LVLID3
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-2 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UHC'' and c.UDFC4 IS NULL  ';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('CLAIMS-LOA UPDATE PASS2',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_UHC_5600_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UHC CLAIMS_UHC_5600 LOA update from elig Pass2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------


vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, f.LVLID2, f.LVLDESC2, f.LVLID3, f.LVLID4, f.LVLDESC4,  f.EFFDATE, f.TERMDATE, f.SERVICEDATE
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, b.LVLID2, b.LVLDESC2, b.LVLID3, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.SERVICEDATE,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID, b.LVLID3, a.SERVICEDATE ORDER BY b.EFFDATE DESC NULLS LAST, b.TERMDATE DESC,b.LVLID2, b.LVLID4, b.ENRID) rn
        FROM
                 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.source=''UHC'' and a.LVLID3 = b.LVLID3
        AND
                NVL( a.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        ) f
        WHERE rn=1
) d
ON
(
        c.ENRID=d.ENRID
AND
        NVL(c.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
and
		c.LVLID3 = d.LVLID3
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-3 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UHC'' and c.UDFC4 IS NULL ';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('CLAIMS-LOA UPDATE PASS3',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_UHC_5600_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UHC CLAIMS_UHC_5600 LOA update from elig Pass3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------

vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, f.LVLID2, f.LVLDESC2, f.LVLID3, f.LVLID4, f.LVLDESC4
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, b.LVLID2, b.LVLDESC2, b.LVLID3, b.LVLID4, b.LVLDESC4,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID, b.LVLID3 ORDER BY b.EFFDATE DESC NULLS LAST, b.TERMDATE DESC,b.LVLID2, b.LVLID4, b.ENRID) rn
        FROM
                  VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.source=''UHC'' and a.LVLID3 = b.LVLID3
        ) f
        WHERE rn=1
) d
ON
(
        c.ENRID=d.ENRID
and
		c.LVLID3 = d.LVLID3
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-4 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UHC'' and c.UDFC4 IS NULL    ';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('CLAIMS-LOA UPDATE PASS4',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_UHC_5600_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UMR CLAIMS_UHC_5600 LOA update from elig Pass4',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------

END IF;
---------------------------------------------------------------UHC 5600 ends---MI Implementation--------------------------------------------

----------------------------------------------UMR Claims ------------------------------------
IF vLvl.PAYER='UMR' THEN
	---------------------------------------------------------------------------------------------
	--GET MEM DEMOGRAPHIC INFO
	---------------------------------------------------------------------------------------------
	vbQuery:='CREATE TABLE zzz_UMR_PROV_'||vLvl.SERIALNO||' NOLOGGING AS
		SELECT PROVIDER_ID, PROVIDER_TAX_ID, PROVIDER_NAME, PROVIDER_CATEGORY, PROVIDER_ADDRESS1, PROVIDER_ADDRESS2, PROVIDER_CITY, PROVIDER_STATE, PROVIDER_ZIP_CODE, PROVSPECCD,PROVSPECDESC
		FROM
		(
			SELECT
				PROVIDER_ID, PROVIDER_TAX_ID, PROVIDER_NAME, PROVIDER_CATEGORY, PROVIDER_ADDRESS1, PROVIDER_ADDRESS2, PROVIDER_CITY, PROVIDER_STATE, PROVIDER_ZIP_CODE,
				NVL(h.rollup_code,a.PROVIDER_SPECCODE)PROVSPECCD,
				NVL(h.rollup_desc,a.PROVIDER_SPECCODE)PROVSPECDESC,
				ROW_NUMBER()OVER(PARTITION BY a.PROVIDER_ID ORDER BY a.receivedmonth DESC,PROVIDER_NAME)rn
			FROM
				HI0826001.HI_PROV_UMR a
			LEFT JOIN
				HR_826_SPEC h
			ON
				a.PROVIDER_SPECCODE =h.SRCCODE AND h.PAYER = ''UMRQICLINK''
			WHERE
				a.PROVIDER_ID IS NOT NULL
		) WHERE rn = 1
		';
	BEGIN EXECUTE IMMEDIATE vbQuery;
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('CREATE zzz_UMR_PROV',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
	---------------------------------------------------------------------------------------------
	BEGIN EXECUTE IMMEDIATE 'ALTER TABLE zzz_UMR_PROV_'||vLvl.SERIALNO||' ADD constraint pk_UMR_PROV_'||vLvl.SERIALNO||' PRIMARY KEY (PROVIDER_ID)';
	EXCEPTION WHEN OTHERS THEN
	xp_scrubStatusLog ('pk_UMR_PROV',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
	---------------------------------------------------------------------------------------------
	--GET MEM DEMOGRAPHIC INFO
	---------------------------------------------------------------------------------------------
	vbQuery:='CREATE TABLE zzz_UMR_DEMO_'||vLvl.SERIALNO||' NOLOGGING AS
		SELECT EMPLOYEEID, MEMBERID, MEMBERLASTNAME, MEMBERFIRSTNAME, EMP_SSN, MEMBERRELATION, UPPER(MEMBERSEX)MEMBERSEX, MEMBERBIRTHDATE
		FROM
		(
			SELECT
				EMPLOYEEID, MEMBERID, MEMBERLASTNAME, MEMBERFIRSTNAME, SUBSTR(''000''||a.SSN,-9) as EMP_SSN, MEMBERRELATION, UPPER(MEMBERSEX)MEMBERSEX, MEMBERBIRTHDATE,
				ROW_NUMBER()OVER(PARTITION BY a.MEMBERID ORDER BY a.receivedmonth DESC,MEMBERFIRSTNAME)rn
			FROM
				HI0826001.HI_DEMO_UMR_'||EMPID||' a
			WHERE
				a.MEMBERID IS NOT NULL
		) WHERE rn = 1
		';
	BEGIN EXECUTE IMMEDIATE vbQuery;
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('CREATE zzz_UMR_DEMO',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
	---------------------------------------------------------------------------------------------
	BEGIN EXECUTE IMMEDIATE 'ALTER TABLE zzz_UMR_DEMO_'||vLvl.SERIALNO||' ADD constraint pk_UMR_DEMO_'||vLvl.SERIALNO||' PRIMARY KEY (MEMBERID)';
	EXCEPTION WHEN OTHERS THEN
	xp_scrubStatusLog ('pk_UMR_DEMO',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
	---------------------------------------------------------------------------------------------
	--GET MEM LOCATION/ZIP INFO BASED ON EMPLOYEE
	---------------------------------------------------------------------------------------------
	vbQuery:='CREATE TABLE ZZZ_UMR_LOCA_'||vLvl.SERIALNO||' NOLOGGING AS
		SELECT EMPLOYEEID, MEMBERADDRESS1, MEMBERADDRESS2, MEMBERCITY, MEMBERSTATE, MEMBERZIPCODE
		FROM
		(
			SELECT
				EMPLOYEEID,MEMBERADDRESS1, MEMBERADDRESS2, MEMBERCITY, MEMBERSTATE, MEMBERZIPCODE,
				ROW_NUMBER()OVER(PARTITION BY a.EMPLOYEEID ORDER BY a.receivedmonth DESC,MEMBERZIPCODE)rn
			FROM
				HI0826001.HI_DEMO_UMR_'||EMPID||' a
			WHERE
				a.EMPLOYEEID IS NOT NULL AND UPPER(a.MEMBERRELATION) =''EE''
		) WHERE rn = 1
		';
	BEGIN EXECUTE IMMEDIATE vbQuery;
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('CREATE ZZZ_UMR_LOCA',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
	---------------------------------------------------------------------------------------------
	BEGIN EXECUTE IMMEDIATE 'ALTER TABLE ZZZ_UMR_LOCA_'||vLvl.SERIALNO||' ADD constraint pk_UMR_LOCA_'||vLvl.SERIALNO||' PRIMARY KEY (EMPLOYEEID)';
	EXCEPTION WHEN OTHERS THEN
	xp_scrubStatusLog ('pk_UMR_LOCA',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
	---------------------------------------------------------------------------------------------
	vbQuery:=
	' INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'
	(
		SN,
		Source,
		SrcFileName,
		ClmNum,
		CLMHEADERNUMBER,
		claimlinenumber,
		ClmType,
		ClmTypeDesc,
		ClmCategory,
		MemID,
		EnrID,
		RelFlag,
		MemFirstName,
		MemLastName,
		Gender,
		DOB,
		Addr1,
		Addr2,
		City,
		State,
		Zip,
		HomePhone,
		WorkPhone,
		LVLID1,
		LVLDesc1,
		LVLID2,
		LVLDesc2,
		LVLID3,
		LVLDesc3,
		LVLID4,
		LVLDesc4,
		LVLID5,
		LVLDesc5,
		LVLID6,
		LVLDesc6,
		claimstatus,
		FromDate,
		ToDate,
		ServiceDate,
		RcvDate,
		PaidDate,
		TypeOfBill,
		BillType,
		POSCode,
		POSDesc,
		SpecCode,
		SpecDesc,
		ICDTYPE,
		DiagCode,
		DiagDesc,
		FIRSTDIAGCODE,
		SECONDDIAGCODE,
		THIRDDIAGCODE,
		FOURTHDIAGCODE,
		PROCTYPE,
		ProcCode,
		ProcDesc,
		REVCODE,
		DRGCODE,
		cpt4_1,
		HCPCS,
		ModifierCode,
		ModifierDesc,
		ProvID,
		ProvName,
		ProvZipCode,
		InNwk,
		NwkID,
		NwkName,
		ServiceUnits,
		PaidAmt,
		BilledAmt,
		AllowedAmt,
		PPOSavingAmt,
		EnrPaidAmt,
		CoInsAmt,
		CopayAmt,
		DeductAmt,
		NotAllowedAmt,
		COBAmt,
		PlanExclAmt,
		ADJCODE,
		IPDays,
		SpecRollupCode,
		SpecRollupDesc,
		DISCHSTATUS,
		UDF1,
		UDF2,
		UDF3,
		UDF4,
		UDF5,
		UDF6,
		UDF7,
		UDF8,
		UDF9,
		UDFC1,
		UDFC2,
		UDFC3,
		UDFC4,
		UDFC5,
		UDFC6,
		UDFC7,
		UDFC8,
		UDFC9,
		UDFC10,
		UDFC11,
		UDFC12,
		UDFC13,
		UDFC14,
		UDFC15,
		UDFC16,
		UDFC17,
		UDFC18,
		UDFC19,
		UDFC20,
		UDFD1,
		UDFD2,
		UDFD3,
		UDFD4,
		UDFD5,
		UDFN1,
		UDFN2,
		UDFN3,
		UDFN4,
		UDFN5,
		UDFN6,
		UDFN7,
		UDFN8,
		UDFN9,
		UDFN10,
		UDFN11,
		UDFN12,
		UDFN13,
		UDFN14,
		UDFN15,
		UDFN16,
		UDFN17,
		UDFN18,
		UDFN19,
		UDFN20,
		--RBIND,
		RcvMth,
		PROVTYPECODE,
		ICD9PROCCODE1,
		ICD9PROCCODE2,
		ICD9PROCCODE3,
		REVCODE1,
		SrcRelFlag,
		PlanType,
		PlanName,
		ENROLLMENT_SOURCE,
		COVTYPEDESC,
		PRODUCTID,
		VHPAYORID
	)
	SELECT
		ROWNUM AS SN,
		''UMR'' AS Source,
		a.SourceFileName AS SrcFileName,
		DECODE(Upper(a.BENEFITSUFFIXCODE),''P'',''Y_'',''N_'')||a.CLAIMNUMBER ||a.CLAIMLINENUMBER  AS ClmNum,
		a.CLAIMNUMBER AS CLMHEADERNUMBER,
		a.CLAIMLINENUMBER AS claimlinenumber,
		''MED'' ClmType,
		''MEDICAL'' AS ClmTypeDesc,
		NULL AS CLMCATEGORY,
		COALESCE(mem.EMP_SSN ||mem.MEMBERSEX|| TO_CHAR(mem.MEMBERBIRTHDATE,''YYYYMMDD''),a.MEMBERID,''MEMBERID'') AS MemID,
		COALESCE(mem.EMP_SSN,SUBSTR(a.MEMBERID,1,9),''EMPLOYEEID'') AS ENRID,
		DECODE(UPPER(mem.MEMBERRELATION),''EE'',''E'',''SP'',''S'',''CH'',''D'',''U'') AS RelFlag,
		UPPER(mem.MEMBERFIRSTNAME) AS MemFirstName,
		UPPER(mem.MEMBERLASTNAME) AS MemLastName,
		CASE WHEN UPPER(mem.MEMBERSEX) IN (''F'',''M'') THEN  UPPER(mem.MEMBERSEX) ELSE ''U'' END AS  Gender,
		mem.MEMBERBIRTHDATE AS DOB,
		SUBSTR(lc.MEMBERADDRESS1,1,50) AS Addr1,
		SUBSTR(lc.MEMBERADDRESS2,1,50) AS Addr2,
		SUBSTR(lc.MEMBERCITY,1,20) AS City,
		SUBSTR(lc.MEMBERSTATE,1,20) AS State,
		SUBSTR(lc.MEMBERZIPCODE,1,5)AS Zip,
		NULL AS HomePhone,
		NULL AS WorkPhone,
		''C'' AS LVL1ID,
		''Commercial'' AS LVL1Desc,
		lv.rollup_plan_id AS LVL2ID,
		lv.rollup_plan_desc  AS LVL2Desc,
		nvl(grp.ROLLUPID,a.GROUPNUMBER) AS LVL3ID,
		nvl(grp.Group_Name,a.GROUPNUMBER) AS LVL3Desc,
		lv.rollup_loc_id AS LVL4ID,
		lv.rollup_loc_desc AS LVL4Desc,
		NULL AS LVL5ID,
		NULL AS LVL5Desc,
		NULL AS LVL6ID,
		NULL AS LVL6Desc,
		NULL AS CMStatus,
		a.INCURREDSTARTDATE AS FROMDATE,
		a.INCURREDENDDATE AS TODATE,
		a.INCURREDSTARTDATE AS SERVICEDATE,
		a.CLAIMRECEIVEDDATE AS RCVDATE,
		a.PAIDDATE AS PAIDDATE,
		NULL AS TypeOfBill,
		CASE WHEN SUBSTR(c.PROCCODE,1,1)=''R'' THEN ''F'' ELSE ''P'' END AS BillType,
		NVL(po.rollup_CD,a.PLACEOFSERVICE) AS POSCode,
		NVL(po.rollup_Desc,a.PLACEOFSERVICE) AS POSDesc,
		NVL(pr.PROVSPECCD,X.IMPLIEDSPECCODE) AS SpecCode,
		UPPER(NVL(pr.PROVSPECDESC,X.IMPLIEDSPECDESC)) AS SpecDesc,
		''ICD9'' AS ICDTYPE,
		COALESCE(a.DIAGNOSISCODE,a.DIAGNOSIS2,a.DIAGNOSIS3) AS DIAGCODE,
		NULL AS DIAGDESC,
		COALESCE(a.DIAGNOSISCODE,a.DIAGNOSIS2,a.DIAGNOSIS3) AS FIRSTDIAGCODE,
		a.DIAGNOSIS2 AS SECONDDIAGCODE,
		a.DIAGNOSIS3 AS THIRDDIAGCODE,
		NULL  AS FOURTHDIAGCODE,
		NULL AS PROCTYPE,
		COALESCE(b.PROCCODE,c.PROCCODE,a.REVENUE_CPT_HCPCS) AS PROCCODE,
		NULL AS ProcDesc,
		REPLACE(c.PROCCODE,''R'') AS REVCODE,
		NULL AS DRGCODE,
		CASE WHEN UPPER(b.PROCTYPEDESC) = ''CPT4'' THEN b.PROCCODE  END AS cpt4_1,
		CASE WHEN UPPER(b.PROCTYPEDESC) = ''HCPCS'' THEN b.PROCCODE  END AS HCPCS,
		a.CPTMODIFIER AS ModifierCode,
		NVL((SELECT m.MODIFIERDESC FROM ZZZ_M_MODIFIERS m WHERE a.CPTMODIFIER = m.MODIFIERCODE),a.CPTMODIFIER) AS ModifierDesc,
		a.PROVIDERID AS ProvID,
		SUBSTR(COALESCE(pr.PROVIDER_NAME,a.PROVIDERID),1,70)AS ProvName,
		SUBSTR(pr.PROVIDER_ZIP_CODE,1,5) AS ProvZipCode,
		CASE WHEN UPPER(a.BENEFITSUFFIXCODE)=''P'' THEN ''Y'' ELSE ''N'' END AS InNwk,
		COALESCE(nw.rollup_code,a.NETWORK,''NNP'') AS NwkID,
		COALESCE(nw.rollup_code,a.NETWORK,''NETWORK NOT PROVIDED'') AS NwkName,
		a.DVTQUANTITY AS ServiceUnits,
		a.PAIDAMOUNT AS PaidAmt,
		a.CHARGEDAMOUNT AS BilledAmt,
		a.PAIDAMOUNT + a.COPAY + a.COINSURANCE + a.DEDUCTIBLE AS AllowedAmt,
		0 AS PPOSavingAmt,
		a.COPAY + a.COINSURANCE + a.DEDUCTIBLE AS EmpPaidAmt,
		a.COINSURANCE AS CoInsAmt,
		a.COPAY AS CopayAmt,
		a.DEDUCTIBLE AS DeductAmt,
		0 AS NotAllowedAmt,
		a.COBSAVINGS AS COBAmt,
		0 AS PlanExclAmt,
		NULL AS ADJCODE,
		0 AS IPDays,
		NULL AS SpecRollupCode,
		NULL AS SpecRollupDesc,
		NULL AS DISCHSTATUS,
		NULL AS UDF1,
		NULL AS UDF2,
		NULL AS UDF3,
		NULL AS UDF4,
		NULL AS UDF5,
		NULL AS UDF6,
		NULL AS UDF7,
		NULL AS UDF8,
		NULL AS UDF9,
		NULL AS UDFC1,
		NULL AS UDFC2,
		NULL AS UDFC3,
		NULL AS UDFC4,
		NULL AS UDFC5,
		NULL AS UDFC6,
		NULL AS UDFC7,
		NULL AS UDFC8,
		NULL AS UDFC9,
		NULL AS UDFC10,
		NULL AS UDFC11,
		NULL AS UDFC12,
		NULL AS UDFC13,
		NULL AS UDFC14,
		NULL AS UDFC15,
		NULL AS UDFC16,
		NULL AS UDFC17,
		NULL AS UDFC18,
		NULL AS UDFC19,
		NULL AS UDFC20,
		NULL AS UDFD1,
		NULL AS UDFD2,
		NULL AS UDFD3,
		NULL AS UDFD4,
		NULL AS UDFD5,
		0 AS UDFN1,
		0 AS UDFN2,
		0 AS UDFN3,
		0 AS UDFN4,
		0 AS UDFN5,
		0 AS UDFN6,
		0 AS UDFN7,
		0 AS UDFN8,
		0 AS UDFN9,
		0 AS UDFN10,
		0 AS UDFN11,
		0 AS UDFN12,
		0 AS UDFN13,
		0 AS UDFN14,
		0 AS UDFN15,
		0 AS UDFN16,
		0 AS UDFN17,
		0 AS UDFN18,
		0 AS UDFN19,
		0 AS UDFN20,
		a.RECEIVEDMONTH AS RcvMth,
		NULL AS PROVTYPECODE,
		NULL ICD9PROCCODE1,
		NULL AS ICD9PROCCODE2,
		NULL AS ICD9PROCCODE3,
		REPLACE(c.PROCCODE,''R'') AS REVCODE1,
		DECODE(UPPER(mem.MEMBERRELATION),''EE'',''SELF'',''SP'',''SPOUSE'',''CH'',''CHILD'',''UNKNOWN'') SrcRelFlag,
		lv.plantype PLANTYPE ,
		lv.rollup_plan_desc PLANNAME,
		--''UMR'' ENROLLMENT_SOURCE,
		NULL AS ENROLLMENT_SOURCE,    ---ICE 243113
		''MEDICAL'' COVTYPEDESC,
		''1'' as PRODUCTID,
		(SELECT p.PAYORID FROM HR_GLOBAL_PAYORLIST p WHERE TABLENAME=''HI_CLAIMS_UMR'' AND CLIENTID = ''826'') AS VHPAYORID
	FROM
		HI0826001.HI_CLAIMS_UMR_'||EMPID||' a
	LEFT JOIN
		zzz_UMR_DEMO_'||vLvl.SERIALNO||' mem
	ON
		a.MEMBERID = mem.MEMBERID
	LEFT JOIN
		zzz_UMR_PROV_'||vLvl.SERIALNO||' pr
	ON
		a.PROVIDERID = pr.PROVIDER_ID
	LEFT JOIN
		ZZZ_UMR_LOCA_'||vLvl.SERIALNO||' lc
	ON
		SUBSTR(a.MEMBERID,1,9) = lc.EMPLOYEEID
	LEFT JOIN
		HR_826_NETWORK nw
	ON
		''UMRQICLINK'' = nw.payer AND a.NETWORK = nw.srccode
	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.GROUPNUMBER = grp.src_code
	JOIN
		HR_826_UMR_LOA lv
	ON
		a.GROUPNUMBER = lv.SRC_GRP
	AND
		a.PLAN = lv.SRC_PLAN
	AND
		a.LOCATION = lv.SRC_LOC
	LEFT JOIN
		HR_826_POS po
	ON
		''UMRQICLINK'' = po.source AND a.PLACEOFSERVICE = po.src_cd
	LEFT JOIN
		ZZZ_PROCS b
	ON
		a.REVENUE_CPT_HCPCS=b.PROCCODE
	LEFT JOIN
		ZZZ_PROCS c
	ON
		CASE WHEN SUBSTR(REVENUE_CPT_HCPCS,1,2) = ''R0'' AND LENGTH(a.REVENUE_CPT_HCPCS) = ''5'' THEN ''R''||SUBSTR(a.REVENUE_CPT_HCPCS,-3) END = c.PROCCODE
	LEFT JOIN 	--259744
		ZZZ_SPECS X
	ON
		COALESCE(b.PROCCODE,c.PROCCODE,a.REVENUE_CPT_HCPCS) = x.PROCCODE
	WHERE
		UPPER(a.PLACEOFSERVICE) <> ''RX''
	AND
		COALESCE(a.DIAGNOSISCODE,a.DIAGNOSIS2,a.DIAGNOSIS3) NOT IN (''NOEOB'')
	';

	------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('CLAIMS',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('CLAIMS',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
	---------------------------------------------------------------------------------------------
	--ICE-14077
--	BEGIN
--	UTILITY.PKG_UPDATE.SP_LOA
--	(
--		FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
--		TO_TABLENAME =>	 'VH_CLAIMS_'||vLvl.SERIALNO||'',
--		UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
--		DELIMITER =>		'-',
--		UPDATE_PASSES =>	'1-2-3-4',
--		LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
--		LVL_DESC_YN =>	  'Y',
--		PASS_1_JOIN_CONDITION =>	'[a.source]=''UMR'' and  a.LVLID3 = b.LVLID3',
--		PASS_1_UPDATE_CONDITION =>	'[a.source]=''UMR''',
--		PASS_2_JOIN_CONDITION =>	'[a.source]=''UMR'' and  a.LVLID3 = b.LVLID3',
--		PASS_2_UPDATE_CONDITION =>	'[a.source]=''UMR'' and [a.UDFC4] IS NULL',
--		PASS_3_JOIN_CONDITION =>	'[a.source]=''UMR'' and a.LVLID3 = b.LVLID3',
--		PASS_3_UPDATE_CONDITION =>	'[a.source]=''UMR'' and [a.UDFC4] IS NULL',
--		PASS_4_JOIN_CONDITION =>	'[a.source]=''UMR'' and a.LVLID3 = b.LVLID3',
--		PASS_4_UPDATE_CONDITION =>	'[a.source]=''UMR'' and [a.UDFC4] IS NULL',
--		BEGIN_END_DTE_YN =>	 'N',
--		STABLE_FROM_TABLE_YN =>	 'N',
--		ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
--	);
--	END;
--	COMMIT;

--- LOA Update(Level 2 and Level 4 Update)  --JIRA_14529--edited order by during IT

vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4, f.EFFDATE, f.TERMDATE, f.SERVICEDATE
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.SERVICEDATE,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, b.LVLID3, a.SERVICEDATE ORDER BY b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.memid) rn
        FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.source=''UMR'' and  a.LVLID3 = b.LVLID3
        AND
                NVL( a.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        ) f
        WHERE rn=1
) d
ON
(
        c.MEMID=d.MEMID
AND
        NVL(c.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-1 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UMR''';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('CLAIMS-LOA UPDATE PASS1',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_UMR_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UMR CLAIMS LOA update from elig Pass1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------
vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, b.LVLID3 ORDER BY  b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.memid) rn
        FROM
                 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.source=''UMR'' and  a.LVLID3 = b.LVLID3
        ) f
        WHERE rn=1
) d
ON
(
        c.MEMID=d.MEMID
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-2 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UMR'' and c.UDFC4 IS NULL  ';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('CLAIMS-LOA UPDATE PASS2',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_UMR_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UMR CLAIMS LOA update from elig Pass2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------


vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4,  f.EFFDATE, f.TERMDATE, f.SERVICEDATE
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.SERVICEDATE,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID, b.LVLID3, a.SERVICEDATE ORDER BY  b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.enrid) rn
        FROM
                 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.source=''UMR'' and a.LVLID3 = b.LVLID3
        AND
                NVL( a.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        ) f
        WHERE rn=1
) d
ON
(
        c.ENRID=d.ENRID
AND
        NVL(c.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-3 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UMR'' and c.UDFC4 IS NULL ';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('CLAIMS-LOA UPDATE PASS3',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_UMR_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UMR CLAIMS LOA update from elig Pass3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------

vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID, b.LVLID3 ORDER BY  b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.enrid) rn
        FROM
                 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.source=''UMR'' and a.LVLID3 = b.LVLID3
        ) f
        WHERE rn=1
) d
ON
(
        c.ENRID=d.ENRID
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-4 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UMR'' and c.UDFC4 IS NULL    ';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('CLAIMS-LOA UPDATE PASS4',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_UMR_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UMR CLAIMS LOA update from elig Pass4',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------



END IF;

----------------------------------------------UMR BIV0041 LAYOUT: CLAIMS ------------------------------------
IF vLvl.PAYER='UMR_BEF' THEN

--ICE #287515
------------------------------------------------

IF EMPID  IN('CIST','FRII','HENG',  'DUCH','DIAV','WSPI','LHY','COFL','CORM','ARST', 'TPME', 'EMPI','PMPT','STUT','ACTL') THEN   --- ICE 312761,312760 347977,646,3966,5266,6085, 8079, 10249 --ICE-18918,18917
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE zzz_elig_'||vLvl.SERIALNO;
  EXCEPTION
    WHEN Others THEN NULL;
  END;
vbQuery:='	CREATE /*+PARALLEL(A,4)*/ TABLE zzz_elig_'||vLvl.SERIALNO||'
			AS
			SELECT MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3, EFFDATE
			FROM
			(
			 SELECT /*+PARALLEL(A,4)*/  MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3, EFFDATE ,
			 ROW_NUMBER() OVER (PARTITION BY MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3 ORDER BY EFFDATE NULLS LAST, TERMDATE NULLS LAST) RN
			 FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||' A
			 where source=''UMR''
			)
			 WHERE RN=1
			 '
			 ;

BEGIN
	EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('Temp table for MEMID Update to claims UMR_BEF',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_UMR_BEF_'||EMPID,'Y','I');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('Temp table for MEMID Update to claims UMR_BEF',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

END IF;
--------------------------------------------------------------------------------------------------------
------------------------------------------------------CLAIMS UMR_BEF 2228 STARTS--MI Implementation-----------------------------------------------------------------
	VBQUERY := 'DROP TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM AS
	SELECT
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		SPECCODE,
		SPECDESC,
		PLANTYPE,
		PLANNAME,
		PRODUCTID,
		SRCRELFLAG,
		IUOU
	FROM
		VH_CLAIMS
	WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('CLAIMS TABLE CREATE UMR_BEF',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_CLMS_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	BEGIN
		SP_PYR_2228_MED_UMR('HI0826001','HI_CLAIMS_UMR_BEF_'||EMPID||'','CLAIMS','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIMS-COMM UMR_BEF',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_2228_MED_UMR','','E');
  END;
	COMMIT;
----------------------------------------------------------------------------------------------------------

	vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		SPECCODE,
		SPECDESC,
		PLANTYPE,
		PLANNAME,
		PRODUCTID,
		SRCRELFLAG,
		IUOU
		)
	SELECT
		a.ROWID AS SRCROWID,
		''UMR'' AS SOURCE,
		';
		IF EMPID IN('CIST','FRII','HENG', 'DUCH','DIAV','LHY','COFL','CORM','ARST', 'TPME', 'EMPI', 'PMPT','STUT','ACTL') THEN  --ICE 312761,312760, 347977,3966,5266,6085,8079,10249 ,ICE-17029--ICE-18918--18917
		vbQuery:=vbQuery||'
			NVL(ELIG.MEMID,a.SOC_SECURITY_CD||DECODE(UPPER(a.FMLY_MEMB_SEX_CODE),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.CLMT_BIRTH_DATE,''YYYYMMDD'')||''-''||grp.ROLLUPID ) AS MEMID,
			NVL(ELIG.ENRID,a.SOC_SECURITY_CD||''-''||grp.ROLLUPID) AS ENRID,
		';
		ELSIF EMPID = 'WSPI' THEN	--ICE-646
		vbQuery:= vbQuery||'
			NVL(ELIG.MEMID,a.SOC_SECURITY_CD||DECODE(UPPER(a.FMLY_MEMB_SEX_CODE),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.CLMT_BIRTH_DATE,''YYYYMMDD'')) AS MEMID,
			NVL(ELIG.ENRID,a.SOC_SECURITY_CD)  AS	ENRID,
		';
		ELSIF EMPID = 'ALTM' THEN	--ICE-5770
		vbQuery:= vbQuery||'
			NVL(ELIG1.MEMID,a.SOC_SECURITY_CD||DECODE(UPPER(a.FMLY_MEMB_SEX_CODE),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.CLMT_BIRTH_DATE,''YYYYMMDD'')||''-''||grp.ROLLUPID) AS MEMID,
			NVL(ELIG1.ENRID,a.SOC_SECURITY_CD||''-''||grp.ROLLUPID)  AS	ENRID,
		';
		ELSE
		vbQuery:=vbQuery||'
		CASE WHEN grp.MEMID_GRP_FLAG = ''Y'' THEN
		a.SOC_SECURITY_CD||DECODE(UPPER(a.FMLY_MEMB_SEX_CODE),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.CLMT_BIRTH_DATE,''YYYYMMDD'')||''-''||grp.ROLLUPID
		ELSE
		a.SOC_SECURITY_CD||DECODE(UPPER(a.FMLY_MEMB_SEX_CODE),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.CLMT_BIRTH_DATE,''YYYYMMDD'') END
		AS MEMID,
		CASE WHEN grp.MEMID_GRP_FLAG = ''Y'' THEN
		a.SOC_SECURITY_CD||''-''||grp.ROLLUPID ELSE
		a.SOC_SECURITY_CD END AS ENRID,
		';
		END IF;
		vbQuery:=vbQuery||'
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		CASE WHEN grp.ROLLUPID = ''ALTM'' THEN Nvl(lvl24.ROLLUP_ID2, a.GROUP_ID_NUMBER||a.STAT_CLASS_CODE)
        ELSE COALESCE(t.ROLLUP_ID, lvl.ROLLUP_CLASS,a.GROUP_ID_NUMBER||a.STAT_CLASS_CODE) END AS LVLID2,  --ICE 5770	--ice-16180
		CASE WHEN grp.ROLLUPID = ''ALTM'' THEN Nvl(lvl24.ROLLUP_DESC2, a.GROUP_ID_NUMBER||a.STAT_CLASS_CODE)
        ELSE COALESCE(t.ROLLUP_DESC, lvl.CLASS_DESCRIPTION,a.GROUP_ID_NUMBER||a.STAT_CLASS_CODE) END AS LVLDESC2,  --ICE 5770	--ice-16180
		Nvl(grp.ROLLUPID,a.GROUP_ID_NUMBER) AS LVLID3,
		Nvl(grp.GROUP_NAME,a.GROUP_ID_NUMBER) AS LVLDESC3,
		CASE WHEN grp.ROLLUPID = ''ALTM'' THEN Nvl(lvl24.ROLLUP_ID4, a.GROUP_ID_NUMBER||a.STAT_CLASS_CODE)
        ELSE loc.ROLLUP_LOCATION END AS LVLID4,  --ICE 5770
		CASE WHEN grp.ROLLUPID = ''ALTM'' THEN Nvl(lvl24.ROLLUP_DESC4, a.GROUP_ID_NUMBER||a.STAT_CLASS_CODE)
        ELSE loc.LOCATION_DESCRIPTION END AS LVLDESC4,  --ICE 5770
		COALESCE(spec.rollup_code,a.PRVD_SPCLTY_CODE,X.IMPLIEDSPECCODE) AS SPECCODE,
		UPPER(COALESCE(spec.rollup_desc,a.PRVD_SPCLTY_CODE,X.IMPLIEDSPECDESC)) AS SPECDESC,
		COALESCE(t.PLANTYPE ,lvl.PLANTYPE,''PPO'') AS PLANTYPE,
		CASE WHEN grp.ROLLUPID = ''ALTM'' THEN lvl24.ROLLUP_DESC2 ELSE COALESCE(t.ROLLUP_DESC, lvl.CLASS_DESCRIPTION) END AS PLANNAME,  --ICE 5770
		''1'' PRODUCTID,
		re.ROLLUP_DESC as SRCRELFLAG,
		CASE WHEN UPPER(a.NTWK_RPVD_IND) = ''N'' THEN ''OU'' ELSE ''IU'' END AS IUOU
	FROM
		HI0826001.HI_CLAIMS_UMR_BEF_'||EMPID||' a

	LEFT JOIN
		HR_826_REL re
	ON
		UPPER(a.DPNT_REL_CODE) = re.SRC_CODE
		AND
		''UMR_BEF'' = re.SOURCE

	LEFT JOIN
		HR_826_SPEC spec
	ON
		a.PRVD_SPCLTY_CODE = spec.srccode
		AND
		''UMR'' = spec.payer

	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.GROUP_ID_NUMBER = grp.SRC_CODE

	LEFT JOIN
		HR_826_UMR_NEW_LOA lvl
	ON
		a.GROUP_ID_NUMBER = lvl.GROUPID
		AND
		a.policy_id_number = lvl.PLAN_CONTRACT
		AND
		a.STAT_CLASS_CODE = lvl.CLASS

	LEFT JOIN
		HR_826_UMR_NEW_LOC loc
	ON
		a.GROUP_ID_NUMBER = loc.GROUPID
		AND
		a.GRP_LOCATION_CODE = loc.LOCATION

	LEFT JOIN
		HR_826_LOA_LVL_ROLLUP t
	ON
		a.GROUP_ID_NUMBER  = t.groupid
		AND
		Upper(a.STAT_CLASS_CODE) = Upper(t.PLANCODE)
		AND
		To_Char(a.SERV_RECVD_DT,''YYYY'') = To_Char(t.effectivedate,''YYYY'')

	left JOIN
	HR_826_UMR_LVL lvl24   --ICE 5770
     ON
	    a.GROUP_ID_NUMBER = lvl24.SRC_GROUPID
	    AND
	    a.policy_id_number = lvl24.PLAN_CONTRACT
	    AND
	    a.STAT_CLASS_CODE = lvl24.CLASS
	LEFT JOIN
		ZZZ_PYR_PROCS P
	ON
		nullif(a.SERV_MED_PRCD_CODE,''00000'')=P.PROCCODE

	LEFT JOIN
		ZZZ_PYR_PROCS P1
	ON
		''R''||CASE WHEN SUBSTR(a.HOSP_RVNU_CODE,1,1) =''0'' AND LENGTH(a.HOSP_RVNU_CODE) = 4 THEN SUBSTR(a.HOSP_RVNU_CODE,-3) ELSE a.HOSP_RVNU_CODE END=P1.PROCCODE

	LEFT JOIN 	--259744
		ZZZ_SPECS X
	ON
		COALESCE(P.PROCCODE,P1.PROCCODE,nullif(a.SERV_MED_PRCD_CODE,''00000''),a.HOSP_RVNU_CODE) = x.PROCCODE
	';
	IF EMPID IN('CIST','FRII','HENG', 'DUCH','DIAV','WSPI','LHY','COFL','CORM','ARST', 'TPME', 'EMPI','PMPT','STUT','ACTL') THEN  --ICE312761,312760, 347977,646,3966,5266,6085,8079, 10249--ICE-18918,--ICE-18917
	vbQuery:=vbQuery||'
	LEFT JOIN
		zzz_elig_'||vLvl.SERIALNO||' ELIG
	ON
		UPPER(a.CLMT_1ST_NAME_TEXT) = ELIG.MEMFIRSTNAME
		AND
		UPPER(a.CLMT_LAST_NAME_TEXT) = ELIG.MEMLASTNAME
		AND
		UPPER(a.FMLY_MEMB_SEX_CODE) = ELIG.GENDER
		AND
		CLMT_BIRTH_DATE = ELIG.DOB
  	AND
		Nvl(grp.ROLLUPID,a.GROUP_ID_NUMBER)= ELIG.LVLID3
	';
	END IF;
    IF EMPID ='ALTM' THEN  --ICE 5770
	vbQuery:=vbQuery||'
	LEFT JOIN
		zzz_eligupd_'||vLvl.SERIALNO||' ELIG1
	ON
		ELIG1.UDFC5=a.SOC_SECURITY_CD||DECODE(UPPER(a.FMLY_MEMB_SEX_CODE),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.CLMT_BIRTH_DATE,''YYYYMMDD'')||''-''||grp.ROLLUPID
	';
	END IF ;
----------------------------------------------------------------------------------------------------------------------
	BEGIN
		EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('CLAIMS-CSTM UMR_BEF',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIMS-CSTM UMR_BEF',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
	END;
	COMMIT;

------------------------------------------------------------------------------------------------------------------
	BEGIN
		SP_CDF_TBL_MERGE(USER,'CLAIMS-MERGE UMR_BEF','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM','VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_CLAIMS_'||vLvl.SERIALNO||'_UMRBEF');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIMS-MERGE UMR_BEF',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	END;
	COMMIT;

--	--ICE-14077
--	BEGIN
--	UTILITY.PKG_UPDATE.SP_LOA
--	(
--		FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
--		TO_TABLENAME =>	 'VH_CLAIMS_'||vLvl.SERIALNO||'',
--		UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
--		DELIMITER =>		'-',
--		UPDATE_PASSES =>	'1-2-3-4',
--		LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
--		LVL_DESC_YN =>	  'Y',
--		PASS_1_JOIN_CONDITION =>	'[a.source]=''UMR'' and  a.LVLID3 = b.LVLID3',
--		PASS_1_UPDATE_CONDITION =>	'[a.source]=''UMR''',
--		PASS_2_JOIN_CONDITION =>	'[a.source]=''UMR'' and  a.LVLID3 = b.LVLID3',
--		PASS_2_UPDATE_CONDITION =>	'[a.source]=''UMR'' and [a.UDFC4] IS NULL',
--		PASS_3_JOIN_CONDITION =>	'[a.source]=''UMR'' and a.LVLID3 = b.LVLID3',
--		PASS_3_UPDATE_CONDITION =>	'[a.source]=''UMR'' and [a.UDFC4] IS NULL',
--		PASS_4_JOIN_CONDITION =>	'[a.source]=''UMR'' and a.LVLID3 = b.LVLID3',
--		PASS_4_UPDATE_CONDITION =>	'[a.source]=''UMR'' and [a.UDFC4] IS NULL',
--		BEGIN_END_DTE_YN =>	 'N',
--		STABLE_FROM_TABLE_YN =>	 'N',
--		ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
--	);
--	END;
--	COMMIT;
------------------------------- LOA Update(Level 2 and Level 4 Update)  --JIRA_14529

vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_UMRBEF c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4,  f.EFFDATE, f.TERMDATE, f.SERVICEDATE
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.SERVICEDATE,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID,  b.lvlid3,a.SERVICEDATE ORDER BY b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.memid) rn
        FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||'_UMRBEF a
        ON
                b.MEMID=a.MEMID
        AND
                a.source=''UMR'' and  a.LVLID3 = b.LVLID3
        AND
                NVL( a.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        ) f
        WHERE rn=1
) d
ON
(
        c.MEMID=d.MEMID
AND
        NVL(c.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-1 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UMR''';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('CLAIMS-LOA UMR-BEF UPDATE PASS1',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_UMR_BEF_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UMR-BEF CLAIMS LOA update from elig Pass1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------
vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_UMRBEF c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, b.lvlid3  ORDER BY b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.memid) rn
        FROM
                 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||'_UMRBEF a
        ON
                b.MEMID=a.MEMID
        AND
                a.source=''UMR'' and  a.LVLID3 = b.LVLID3
        ) f
        WHERE rn=1
) d
ON
(
        c.MEMID=d.MEMID
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-2 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UMR'' and c.UDFC4 IS NULL  ';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('CLAIMS-LOA UMR-BEF UPDATE PASS2',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_UMR_BEF_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UMR-BEF CLAIMS LOA update from elig Pass2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------


vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_UMRBEF c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4,  f.EFFDATE, f.TERMDATE, f.SERVICEDATE
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.SERVICEDATE,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID,b.lvlid3, a.SERVICEDATE ORDER BY b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.enrid) rn
        FROM
                 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||'_UMRBEF a
        ON
                b.ENRID=a.ENRID
        AND
                a.source=''UMR'' and a.LVLID3 = b.LVLID3
        AND
                NVL( a.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        ) f
        WHERE rn=1
) d
ON
(
        c.ENRID=d.ENRID
AND
        NVL(c.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-3 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UMR'' and c.UDFC4 IS NULL ';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('CLAIMS-LOA UMR-BEF UPDATE PASS3',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_UMR_BEF_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UMR-BEF CLAIMS LOA update from elig Pass3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------

vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_UMRBEF c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID, b.lvlid3 ORDER BY b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.enrid) rn
        FROM
                 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||'_UMRBEF a
        ON
                b.ENRID=a.ENRID
        AND
                a.source=''UMR'' and a.LVLID3 = b.LVLID3
        ) f
        WHERE rn=1
) d
ON
(
        c.ENRID=d.ENRID
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-4 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UMR'' and c.UDFC4 IS NULL    ';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('CLAIMS-LOA UMR-BEF UPDATE PASS4',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_UMR_BEF_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UMR-BEF CLAIMS LOA update from elig Pass4',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------

---------------------------------- Start of Insert of UMR_BEF OR dropped data back ---------------------------------------------------------------

	VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'  a
	    SELECT * FROM VH_CLAIMS_'||vLvl.SERIALNO||'_UMRBEF';

	BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('UMR_BEF FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('UMR_BEF FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
	END;
	COMMIT;


END IF;
------------------------------------------UMR_BEF 2228 ends-------------MI Implementation-----------------------------

--------------------------------------------------CIGNA PROCLAIM CLAIMS IMPLEMENTATION STARTS (ICE 1797)--------------------------------------------------
IF  vLvl.PAYER='CIGNA_PROCLAIM' THEN

	VBQUERY := 'DROP TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM AS
	SELECT
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		SPECCODE,
		SPECDESC,
		NWKID,
		NWKNAME,
		PRODUCTID
	FROM
		VH_CLAIMS
	WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('CLAIMS TABLE CREATE CGNA CSTM',EMPID,'CGPC',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMCGNA_CLM_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	BEGIN
		SP_PYR_4077_MED_CGPC('HI0826001','HI_CLAIMS_CGPC_'||EMPID||'','CLAIMS','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM','4');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIM-COMM CGNA ',EMPID,'CGPC',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4077_MED_CGPC','','E');
	END;
	COMMIT;
----------------------------------------------------------------------------------------------------------

	vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		SPECCODE,
		SPECDESC,
		NWKID,
		NWKNAME,
		PRODUCTID
	)
	SELECT /*+ PARALLEL(a,4) */
		a.ROWID AS SRCROWID,
		''CIGNA_PROCLAIM'' as  SOURCE,
		SUBSTR(a.MBR_NUM,1,9)|| CASE WHEN UPPER(a.SEX_CD) IN (''M'',''F'') THEN UPPER(a.SEX_CD) ELSE ''U'' END|| TO_CHAR(a.BRTH_DT,''YYYYMMDD'') ||''-''||GRP.rollupid  AS MEMID,
		SUBSTR(a.MBR_NUM,1,9)||''-''||GRP.rollupid AS ENRID,
		''C'' AS LVL1ID,
		''Commercial'' AS LVL1Desc,
		Nvl(lvl2.ROLLUP_PLANID, a.BEN_PLAN) AS LVLID2,
		Nvl(lvl2.ROLLUP_PLANNAME, a.BEN_PLAN) AS LVLDESC2,
		Nvl(grp.ROLLUPID, a.ACCT_NUM) AS LVLID3,
		Nvl(grp.GROUP_NAME, a.ACCT_NUM) AS LVLDESC3,
		Nvl(lvl4.ROLLUP_BRANCHID, a.BRANCH_CD) AS LVLID4,
		Nvl(lvl4.ROLLUP_BRANCHNAME, a.BRANCH_CD) AS LVLDESC4,
		COALESCE(spec.rollup_code,a.PROVSPEC) AS SPECCODE,
		COALESCE(spec.rollup_desc,a.PROVSPEC) AS SPECDESC,
		Nvl(NWK.ROLLUPNWKID, a.NT_ID) AS NWKID,
		NVL(NWK.ROLLUPNWKNAME, a.NT_ID) AS NWKNAME,
		''1'' AS PRODUCTID
	FROM
		HI0826001.HI_CLAIMS_CGPC_'||EMPID||'  A

	LEFT JOIN
		HR_826_GROUP GRP
	ON
		a.ACCT_NUM = grp.SRC_CODE

	LEFT JOIN
		HR_826_CIGNA_LVL2 lvl2
    ON
		Upper(a.BEN_PLAN) = lvl2.SRC_PLANID
		AND
		grp.ROLLUPID =lvl2.GROUPID

	LEFT JOIN
	  HR_826_CIGNA_LVL4 lvl4
    ON
		Upper(a.BRANCH_CD) = lvl4.SRC_BRANCHID
		AND
		grp.ROLLUPID =lvl4.GROUPID

	LEFT JOIN
		HR_826_SPEC spec
	ON
		a.PROVSPEC = spec.SRCCODE
		AND
		spec.payer = ''CIGNA_PROCLAIM''

	LEFT JOIN
		HR_826_CIGNA_PCLM_NWK NWK
	ON
		a.NT_ID = NWK.NWKID
		AND
		UPPER(NWK.SOURCE) = ''CIGNA_PROCLAIM''
	';

	BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('CLAIMS-CSTM CGNA',EMPID,'CGPC','','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIMS CGNA CSTM ERROR',EMPID,'CGPC',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	COMMIT;
------------------------------------------------------------------------------------------------------------------
	BEGIN
		SP_CDF_TBL_MERGE(USER,'CLAIMS-MERGE CGNA','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM','VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_CLAIMS_'||vLvl.SERIALNO||'_CGNA');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIMS-MERGE CGNA',EMPID,'CGPC',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	END;
	COMMIT;

--------------------------------------------------TWIN CASES UPDATE --------------------------------
	vbQuery:='MERGE /*+PARALLEL(A,4)*/ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_CGNA A
		USING
			(
			SELECT /*+PARALLEL(A,4)*/
				SOURCE,MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ,LVLID3,NEWMEMID
			FROM
				ZZZ_ELIG_CGNA_TWINS_'||vLvl.SERIALNO||' A )S
			ON
			(
					A.SOURCE=''CIGNA_PROCLAIM''
				AND A.LVLID3=S.LVLID3
				AND A.ENRID=S.ENRID
				AND NVL(A.DOB,TO_DATE(''2000/02/02'',''YYYY/MM/DD'')) = Nvl(s.DOB,To_DATE(''2000/02/02'',''YYYY/MM/DD''))
				AND NVL(A.Gender,''X'') = NVL(s.Gender,''X'')
				AND A.MemFirstName = s.MemFirstName
				AND A.RelFlag = ''D''
			)
			WHEN MATCHED THEN UPDATE SET
				A.MEMID = S.NEWMEMID
			';

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CIGNACLAIMS MEMID Update ',EMPID,'CGPC',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;
	COMMIT;

-----------------------------------------------Start of Insert of CIGNA claims OR dropped data back ---------------------------------------------

	VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	vbQuery:='INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||' a
           SELECT * FROM VH_CLAIMS_'||vLvl.SERIALNO||'_CGNA';

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('CLAIMS-CGNA',EMPID,'CGPC','','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('Insert CIGNA into CLAIMS EXCEPTION',EMPID,'CGPC',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;
	COMMIT;

END IF;
---------------------------------------------------CIGNA PROCLAIM CLAIMS IMPLEMENTATION ENDS (ICE 1797)----------------------------------------------------------

----------------START 275046 ------------------------------------------------------

IF  vLvl.PAYER='BAS' THEN


VBQUERY := 'DROP TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM AS
							SELECT
								SOURCE,
								MEMID,
								ENRID,
								LVLID1,
								LVLDESC1,
								LVLID3,
								LVLDESC3,
								SPECCODE,
								SPECDESC,
		PRODUCTID
		-- ,
		-- PLANTYPE,
		-- PLANNAME
						   FROM
								VH_CLAIMS
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS TABLE CREATE BAS',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_CLMS_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_4790_MED_BAS('HI0826001','HI_CLAIMS_BAS_'||EMPID||'','CLAIMS','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM');
exception when others then
xp_scrubStatusLog ('CLAIMS-COMM BAS',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4790_MED_BAS','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID3,
		LVLDESC3,
		speccode,
		specDesc,
		PRODUCTID
		-- ,
		-- PLANTYPE,
		-- PLANNAME
	)
	SELECT /*+ PARALLEL(a,4) */
		 a.ROWID AS SRCROWID,
		 ''BAS'' AS source,
		 NVL(B.MEMID,a.SBSCRBR_ID || Decode(upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'') || To_Char(a.MBR_BRTH_DT,''YYYYMMDD'')||''-''||A.MBR_SQNC_NBR||''-''||lvl3.ROLLUPID) AS MEMID,
		 NVL(B.ENRID,a.SBSCRBR_ID||''-''||A.MBR_SQNC_NBR||''-''||lvl3.ROLLUPID) AS ENRID,
		 ''C'' AS LVL1ID,
		 ''Commercial'' AS LVL1Desc,
		  NVL(lvl3.rollupid,a.ACCT_NBR) LVL3ID,
		  NVL(lvl3.GROUP_NAME,a.ACCT_NBR)  AS LVL3Desc,
		  COALESCE(spec.rollup_code, a.RNDR_PROV_SPEC, X.IMPLIEDSPECCODE) AS speccode,
		  UPPER(COALESCE(spec.rollup_desc, a.RNDR_PROV_SPEC ,X.IMPLIEDSPECDESC)) AS specDesc,
		''1'' AS PRODUCTID
		-- ,
		-- ''HDHP'' AS PLANTYPE,
		-- ''BAS HDHP'' as PLANNAME	--275048 F/U#7.3
	FROM
		HI0826001.HI_CLAIMS_BAS_'||EMPID||' A
	left join
		HR_826_GROUP lvl3
	on
		a.ACCT_NBR = lvl3.SRC_CODE
	LEFT JOIN
		zzz_elig_umr_'||vLvl.SERIALNO||' B
	ON
		substr(UPPER(A.MBR_FIRST_NM),1,30) = B.MEMFIRSTNAME
	AND
		UPPER(A.MBR_LAST_NM) = B.MEMLASTNAME
	AND
		DECODE(UPPER(A.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'') = B.GENDER
	AND
		A.MBR_BRTH_DT = B.DOB
	AND 	--323306
		NVL(lvl3.rollupid,a.ACCT_NBR) = B.LVLID3
	LEFT JOIN
		HR_826_SPEC spec
	ON
		a.RNDR_PROV_SPEC = spec.SRCCODE
	AND
		spec.payer = ''BAS''
	left JOIN
		ZZZ_PYR_PROCS proc1
	ON
		UPPER(A.PRIM_PROC_CD) = proc1.PROCCODE
	left JOIN
		ZZZ_PYR_PROCS proc2
	ON
		''I'' || UPPER(A.SEC_PROC_CD) = proc2.PROCCODE
	left JOIN
		ZZZ_PYR_PROCS proc3
	ON
		''R'' || CASE WHEN LENGTH(a.RVNU_CD) = 4 AND SUBSTR(a.RVNU_CD,1,1) =''0'' THEN SUBSTR(a.RVNU_CD,-3) ELSE a.RVNU_CD END = proc3.PROCCODE
	left JOIN
		ZZZ_PYR_PROCS proc4
	ON
		''D'' || a.INP_DRG = proc4.PROCCODE
	LEFT JOIN 	--259744
		ZZZ_SPECS X
	ON
		COALESCE(proc1.PROCCODE, proc2.PROCCODE, proc3.proccode, proc4.proccode, REPLACE(a.PRIM_PROC_CD,''UNK''), REPLACE(a.SEC_PROC_CD,''UNK''), REPLACE(a.RVNU_CD,''UNK''), REPLACE(a.INP_DRG,''UNK'')) = x.PROCCODE
	'
	 ;
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('CLAIMS-CSTM BAS',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS-CSTM BAS',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'CLAIMS-MERGE BAS','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM','VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_CLAIMS_'||vLvl.SERIALNO||'_BAS');
exception when others then
xp_scrubStatusLog ('CLAIMS-MERGE BAS',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

---------------------------------- Start of Insert of  ANTHEMR CA OR dropped data back ---------------------------------------------------------------

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_CLAIMS_'||vLvl.SERIALNO||'_BAS';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('BAS CLAIMS FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('BAS CLAIMS FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;

--ICE-11202
 BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
	FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
	TO_TABLENAME =>	 'VH_CLAIMS_'||vLvl.SERIALNO||'',
	UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
	DELIMITER =>		'-',
	UPDATE_PASSES =>	'1-2-3-4',
	LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
	LVL_DESC_YN =>	  'Y',
	PASS_1_JOIN_CONDITION =>  '[a.source]=''BAS'' and  a.LVLID3 = b.LVLID3',
	PASS_1_UPDATE_CONDITION =>	'[a.source]=''BAS''',
	PASS_2_JOIN_CONDITION =>	'[a.source]=''BAS'' and  a.LVLID3 = b.LVLID3',
	PASS_2_UPDATE_CONDITION =>	'[a.source]=''BAS'' and [a.UDFC4] IS NULL',
	PASS_3_JOIN_CONDITION =>	'[a.source]=''BAS'' and a.LVLID3 = b.LVLID3',
	PASS_3_UPDATE_CONDITION =>	'[a.source]=''BAS'' and [a.UDFC4] IS NULL',
	PASS_4_JOIN_CONDITION =>	'[a.source]=''BAS'' and a.LVLID3 = b.LVLID3',
	PASS_4_UPDATE_CONDITION =>	'[a.source]=''BAS'' and [a.UDFC4] IS NULL',
	BEGIN_END_DTE_YN =>	 'N',
	STABLE_FROM_TABLE_YN =>	 'N',
	ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
	);
END;
COMMIT;

--275046 removed because for one payer only on plan details. Hence can be hardcoded and no need merging to save scrub time
-- /*********************************************Beginning to Plan type and Plan name update from BAS Elig****************************************************/
	vbQuery:='MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.SERVICEDATE,F.LVLID3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.SERVICEDATE, B.LVLID3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.SERVICEDATE ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL(a.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        WHERE B.source='''||vLvl.PAYER||'''
        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) = NVL(d.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
	C.LVLID3=D.LVLID3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from '||vLvl.PAYER||' VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE
	c.plantype IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('BAS CLM Planname and Plantype UPDATE PASS1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
vbQuery:='MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype, F.LVLID3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype,B.LVLID3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
		WHERE B.source='''||vLvl.PAYER||'''
        ) f
        WHERE rn=1
) d
ON
(
        c.MEMID=d.MEMID
        AND
        C.LVLID3=D.LVLID3
)
WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from '||vLvl.PAYER||' VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
WHERE  c.PLANTYPE IS NULL';

---------------------------------------Executing second pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('BAS CLM Planname and Plantype UPDATE PASS2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;

----------------------------------------------------------------------------------------------------------------------------------------------------------

vbQuery:='MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE,F.LVLID3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,B.LVLID3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3
		WHERE B.source='''||vLvl.PAYER||'''
        ) f
        WHERE rn=1
) d
ON
(
        c.ENRID=d.ENRID
        AND
        C.LVLID3=D.LVLID3
)
WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from '||vLvl.PAYER||' VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
WHERE  c.PLANTYPE IS NULL';

-------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('BAS CLM Planname and Plantype UPDATE PASS3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

END IF;
---------------------------END 275046----------------------------------------------------------------------
----------------------------------------------HUMANA Claims ice#143821 ------------------------------------
IF vLvl.PAYER='HUMANA' THEN

vbQuery:=
	' INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'
	(
		SN,
		Source,
		SrcFileName,
		ClmNum,
		CLMHEADERNUMBER,
		claimlinenumber,
		ClmType,
		ClmTypeDesc,
		ClmCategory,
		MemID,
		EnrID,
		RelFlag,
		MemFirstName,
		MemLastName,
		Gender,
		DOB,
		Addr1,
		Addr2,
		City,
		State,
		Zip,
		HomePhone,
		WorkPhone,
		LVLID1,
		LVLDesc1,
		LVLID2,
		LVLDesc2,
		LVLID3,
		LVLDesc3,
		LVLID4,
		LVLDesc4,
		LVLID5,
		LVLDesc5,
		LVLID6,
		LVLDesc6,
		claimstatus,
		FromDate,
		ToDate,
		ServiceDate,
		RcvDate,
		PaidDate,
		TypeOfBill,
		BillType,
		POSCode,
		POSDesc,
		SpecCode,
		SpecDesc,
		ICDTYPE,
		DiagCode,
		DiagDesc,
		FIRSTDIAGCODE,
		SECONDDIAGCODE,
		THIRDDIAGCODE,
		FOURTHDIAGCODE,
		PROCTYPE,
		ProcCode,
		ProcDesc,
		REVCODE,
		DRGCODE,
		cpt4_1,
		HCPCS,
		ModifierCode,
		ModifierDesc,
		ProvID,
		ProvName,
		ProvZipCode,
		InNwk,
		NwkID,
		NwkName,
		ServiceUnits,
		PaidAmt,
		BilledAmt,
		AllowedAmt,
		PPOSavingAmt,
		EnrPaidAmt,
		CoInsAmt,
		CopayAmt,
		DeductAmt,
		NotAllowedAmt,
		COBAmt,
		PlanExclAmt,
		ADJCODE,
		IPDays,
		SpecRollupCode,
		SpecRollupDesc,
		DISCHSTATUS,
		UDF1,
		UDF2,
		UDF3,
		UDF4,
		UDF5,
		UDF6,
		UDF7,
		UDF8,
		UDF9,
		UDFC1,
		UDFC2,
		UDFC3,
		UDFC4,
		UDFC5,
		UDFC6,
		UDFC7,
		UDFC8,
		UDFC9,
		UDFC10,
		UDFC11,
		UDFC12,
		UDFC13,
		UDFC14,
		UDFC15,
		UDFC16,
		UDFC17,
		UDFC18,
		UDFC19,
		UDFC20,
		UDFD1,
		UDFD2,
		UDFD3,
		UDFD4,
		UDFD5,
		UDFN1,
		UDFN2,
		UDFN3,
		UDFN4,
		UDFN5,
		UDFN6,
		UDFN7,
		UDFN8,
		UDFN9,
		UDFN10,
		UDFN11,
		UDFN12,
		UDFN13,
		UDFN14,
		UDFN15,
		UDFN16,
		UDFN17,
		UDFN18,
		UDFN19,
		UDFN20,
		--RBIND,
		RcvMth,
		PROVTYPECODE,
		ICD9PROCCODE1,
		ICD9PROCCODE2,
		ICD9PROCCODE3,
		REVCODE1,
		SrcRelFlag,
		PlanType,
		PlanName,
		ENROLLMENT_SOURCE,
		COVTYPEDESC,
		PRODUCTID,
--		BENCOVTYPEDESC,
		VHPAYORID
	)
	SELECT
		ROWNUM AS SN,
		''HUMANA'' AS Source,
		a.SourceFileName AS SrcFileName,
		CASE WHEN UPPER(a.PAR_CODE)=''P'' THEN ''Y_'' ELSE ''N_'' END ||a.CLAIM_NBR || a.REL_LINE_NBR  AS ClmNum,
		a.CLAIM_NBR AS CLMHEADERNUMBER,
		a.REL_LINE_NBR AS claimlinenumber,
		CASE
			WHEN a.CLAIM_CODE IN (''D1'',''D2'',''DE'') THEN ''DEN''
			WHEN a.CLAIM_CODE IN (''RX'') THEN ''RX_MED''
			ELSE ''MED''
		END AS CLMTYPE,
		CASE
			WHEN a.CLAIM_CODE IN (''D1'',''D2'',''DE'') THEN ''DENTAL''
			WHEN a.CLAIM_CODE IN (''RX'') THEN ''PHARMACY''
			ELSE ''MEDICAL''
		END AS CLMTYPEDESC,
		NULL AS CLMCATEGORY,';
		IF EMPID IN ('LPKI','CMHA') THEN
	    vbQuery := vbQuery||'
		NVL(TWINS.NEW_MEMID,a.EMP_SSN || a.PAT_SEX || To_Char(a.PAT_DOB, ''YYYYMMDD'')||''-''||NVL(grp.ROLLUPID,a.GRP_NBR)) AS MemID,
	';
		ELSE
	vbQuery := vbQuery ||
	'CASE WHEN grp.MEMID_GRP_FLAG =''Y''
		then a.EMP_SSN || a.PAT_SEX || To_Char(a.PAT_DOB, ''YYYYMMDD'')||''-''||NVL(grp.ROLLUPID,a.GRP_NBR)
		ELSE
		a.EMP_SSN || a.PAT_SEX || To_Char(a.PAT_DOB, ''YYYYMMDD'') END AS MemID,';   -- CMHA 7713
         END IF;
		 vbQuery := vbQuery ||
	'CASE WHEN grp.MEMID_GRP_FLAG =''Y''
		then a.EMP_SSN||''-''||NVL(grp.ROLLUPID,a.GRP_NBR)
		ELSE a.EMP_SSN END AS ENRID,				--ice#3054
		DECODE(a.PAT_REL,''18'',''E'',''01'',''S'',''25'',''S'',''53'',''S'',''D'') AS RelFlag,
		UPPER(a.PAT_FST_NM) AS MemFirstName,
		UPPER(a.PAT_LST_NM) AS MemLastName,
		a.PAT_SEX AS  Gender,
		a.PAT_DOB AS DOB,
		NULL AS Addr1,
		NULL AS Addr2,
		NULL AS City,
		NULL AS State,
		SUBSTR(a.EMP_ZIP_CODE,1,5) AS Zip,
		NULL AS HomePhone,
		NULL AS WorkPhone,
		''C'' AS LVL1ID,
		''Commercial'' AS LVL1Desc,
		NULL AS LVL2ID,
		NULL  AS LVL2Desc,
		NVL(grp.ROLLUPID,a.GRP_NBR) AS LVL3ID,
		NVL(grp.Group_Name,a.GRP_NBR) AS LVL3Desc,
		NULL AS LVL4ID,
		NULL AS LVL4Desc,
		NULL AS LVL5ID,
		NULL AS LVL5Desc,
		NULL AS LVL6ID,
		NULL AS LVL6Desc,
		NULL AS CMStatus,
		a.FST_DT AS FromDate,
		a.LST_DT AS ToDate,
		a.FST_DT  AS ServiceDate,
		a.RCV_DT AS RcvDate,
		a.PAID_DT AS PaidDate,
		a.BILL_TYPE AS TypeOfBill,
		CASE WHEN a.BILL_TYPE IS NOT NULL THEN ''F'' ELSE ''P'' END AS BillType,
		a.POT AS POSCode,
		NULL AS POSDesc,
		COALESCE((SELECT h.Rollup_code FROM HR_826_SPEC h WHERE a.PLATFORM ||a.PROV_SPECIALTY =h.SRCCODE AND h.PAYER = ''HUMANA''), a.PROV_SPECIALTY,X.IMPLIEDSPECCODE) AS SpecCode,
		UPPER(COALESCE((SELECT h.Rollup_Desc FROM HR_826_SPEC h WHERE a.PLATFORM ||a.PROV_SPECIALTY =h.SRCCODE AND h.PAYER = ''HUMANA''),a.PROV_SPECIALTY,X.IMPLIEDSPECDESC)) AS SpecDesc,
		DECODE(a.ICD_VERS_CD,''09'',''ICD9'',''ICD10'') AS ICDTYPE,
		COALESCE(a.PRIMARY_DIAG, a.DIAG_2, a.DIAG_3) AS DiagCode,
		NULL AS DiagDesc,
		a.PRIMARY_DIAG AS FIRSTDIAGCODE,
		a.DIAG_2 AS SECONDDIAGCODE,
		a.DIAG_3 AS THIRDDIAGCODE,
		NULL AS FOURTHDIAGCODE,
		NULL AS PROCTYPE,
		COALESCE(c.PROCCODE,d.PROCCODE,e.PROCCODE,a.PROC,NULLIF(''I''||a.PRIMARY_ICD9_PROC,''I''),NULLIF(''R''||CASE WHEN SUBSTR(a.REVENUE_CD,1,1)=''0'' THEN SUBSTR(a.REVENUE_CD,-3)  ELSE a.REVENUE_CD END,''R'')) AS PROCCODE,
		NULL AS ProcDesc,
		SUBSTR(e.PROCCODE,2) AS REVCODE,
		NULL AS DRGCODE,
		CASE WHEN c.PROCTYPEDESC = ''CPT4'' THEN c.PROCCODE END AS cpt4_1,
		CASE WHEN c.PROCTYPEDESC = ''HCPCS'' THEN c.PROCCODE END AS HCPCS,
		a.CPT4_MOD_CD AS ModifierCode,
		NVL((SELECT m.MODIFIERDESC FROM ZZZ_M_MODIFIERS m WHERE a.CPT4_MOD_CD = m.MODIFIERCODE),a.CPT4_MOD_CD) AS ModifierDesc,
		a.PROV_NBR AS ProvID,
		a.PROV_NAME AS ProvName,
		NULL AS ProvZipCode,
		CASE WHEN UPPER(a.PAR_CODE)=''P'' THEN ''Y'' ELSE ''N'' END AS InNwk,
		''NNP'' AS NwkID,
		''NETWORK NOT PROVIDED'' AS NwkName,
		a.NBR_OF_SVC AS SERVICEUNITS,
		a.PAID_AMT AS PAIDAMT,
		a.PAID_AMT + a.MBR_RESP_AMT + a.COB_AMT AS BILLEDAMT,
		a.PAID_AMT + a.MBR_RESP_AMT AS ALLOWEDAMT,
		0 AS PPOSAVINGAMT,
		a.MBR_RESP_AMT AS ENRPAIDAMT,
		a.COINS_AMT AS COINSAMT,
		a.COPAY_AMT AS COPAYAMT,
		a.DEDUCT_AMT AS DEDUCTAMT,
		0 AS NOTALLOWEDAMT,
		a.COB_AMT AS COBAMT,
		0 AS PLANEXCLAMT,
		a.ADJ_CODE AS ADJCODE,
		0 AS IPDays,
		NULL AS SpecRollupCode,
		NULL AS SpecRollupDesc,
		a.HOSP_DISCHG_ST AS DISCHSTATUS,
		NULL AS UDF1,
		NULL AS UDF2,
		NULL AS UDF3,
		NULL AS UDF4,
		NULL AS UDF5,
		NULL AS UDF6,
		NULL AS UDF7,
		NULL AS UDF8,
		NULL AS UDF9,
		NULL AS UDFC1,
		NULL AS UDFC2,
		NULL AS UDFC3,
		NULL AS UDFC4,
		NULL AS UDFC5,
		NULL AS UDFC6,
		NULL AS UDFC7,
		NULL AS UDFC8,
		NULL AS UDFC9,
		NULL AS UDFC10,
		NULL AS UDFC11,
		NULL AS UDFC12,
		NULL AS UDFC13,
		NULL AS UDFC14,
		NULL AS UDFC15,
		NULL AS UDFC16,
		NULL AS UDFC17,
		NULL AS UDFC18,
		NULL AS UDFC19,
		NULL AS UDFC20,
		NULL AS UDFD1,
		NULL AS UDFD2,
		NULL AS UDFD3,
		NULL AS UDFD4,
		NULL AS UDFD5,
		0 AS UDFN1,
		0 AS UDFN2,
		0 AS UDFN3,
		0 AS UDFN4,
		0 AS UDFN5,
		0 AS UDFN6,
		0 AS UDFN7,
		0 AS UDFN8,
		0 AS UDFN9,
		0 AS UDFN10,
		0 AS UDFN11,
		0 AS UDFN12,
		0 AS UDFN13,
		0 AS UDFN14,
		0 AS UDFN15,
		0 AS UDFN16,
		0 AS UDFN17,
		0 AS UDFN18,
		0 AS UDFN19,
		0 AS UDFN20,
		a.RECEIVEDMONTH AS RcvMth,
		NULL AS PROVTYPECODE,
		a.PRIMARY_ICD9_PROC ICD9PROCCODE1,
		NULL AS ICD9PROCCODE2,
		NULL AS ICD9PROCCODE3,
		SUBSTR(e.PROCCODE,2) AS REVCODE1,
		(SELECT R.rollup_desc FROM HR_826_REL R WHERE R.source = ''HUMANA'' AND R.src_code=a.PAT_REL ) SrcRelFlag,
		NULL PLANTYPE,
		NULL PLANNAME,
		--''HUMANA'' ENROLLMENT_SOURCE,
		NULL AS ENROLLMENT_SOURCE,    ---ICE 243113
		CASE
			WHEN a.CLAIM_CODE IN (''D1'',''D2'',''DE'') THEN ''DENTAL''
			WHEN a.CLAIM_CODE IN (''RX'') THEN ''PHARMACY''
			ELSE ''MEDICAL''
		END COVTYPEDESC,
		''1'' as PRODUCTID,
		(SELECT p.PAYORID FROM HR_GLOBAL_PAYORLIST p WHERE TABLENAME=''HI_CLAIMS_HUMANA'') AS VHPAYORID
	FROM
		HI0826001.HI_CLAIMS_HUMANA_'||EMPID||' a
	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.GRP_NBR = grp.src_code
	LEFT JOIN
		ZZZ_PROCS c
	ON
		a.PROC = c.PROCCODE
	LEFT JOIN
		zzz_procs d
	ON
		''I''||a.PRIMARY_ICD9_PROC = d.PROCCODE';
IF EMPID IN ('LPKI','CMHA') THEN
		vbQuery := vbQuery||'
		LEFT JOIN ZZZ_ELIG_HM_TWINS_'||vLvl.SERIALNO||' TWINS
	ON
		a.EMP_SSN||''-''||NVL(grp.ROLLUPID,a.GRP_NBR)=TWINS.ENRID
	AND
		a.PAT_SEX =TWINS.GENDER
	AND
		a.PAT_DOB =TWINS.DOB
	AND
		NVL(grp.ROLLUPID,a.GRP_NBR) =TWINS.LVLID3
	AND
	UPPER(a.PAT_FST_NM)= TWINS.MEMFIRSTNAME
	AND
	UPPER(a.PAT_LST_NM)= TWINS.MEMLASTNAME';
	END IF;
	vbQuery := vbQuery ||
	'
	LEFT JOIN
		zzz_procs e
	ON
		''R''||CASE WHEN SUBSTR(a.REVENUE_CD,1,1)=''0'' THEN SUBSTR(a.REVENUE_CD,-3)  ELSE a.REVENUE_CD END = e.PROCCODE
	LEFT JOIN 	--259744
		ZZZ_SPECS X
	ON
		COALESCE(c.PROCCODE,d.PROCCODE,e.PROCCODE,a.PROC,NULLIF(''I''||a.PRIMARY_ICD9_PROC,''I''),NULLIF(''R''||CASE WHEN SUBSTR(a.REVENUE_CD,1,1)=''0'' THEN SUBSTR(a.REVENUE_CD,-3)  ELSE a.REVENUE_CD END,''R'')) = x.PROCCODE
	WHERE
		a.CLAIM_CODE NOT IN (''D1'',''D2'',''DE'',''RX'')
		';

	------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('CLAIMS',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('CLAIMS',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
	--ICE-12104
	 vbQuery:='MERGE /*+ PARALLEL(a,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'  a
	USING
	(
		SELECT MemFirstName,MemLastName,Gender,DOB,MemID,EnrID,lvlid3
		FROM
		(
			SELECT
				MemFirstName,MemLastName,Gender,DOB,MemID,EnrID,lvlid3,
				ROW_NUMBER() OVER(PARTITION BY MemFirstName,MemLastName,Gender,DOB,lvlid3 ORDER BY EFFDATE DESC NULLS LAST, TERMDATE DESC) rn
			FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||' where source<>''OUR HEALTH'' --ICE-13206
		)x WHERE rn=1
	)b
	ON
	(
		a.MemFirstName = b.MemFirstName AND
		a.MemLastName = b.MemLastName AND
		a.Gender = b.Gender AND
		a.DOB = b.DOB AND
    a.lvlid3=b.lvlid3
	)
	WHEN MATCHED THEN UPDATE
	SET a.MemID=b.MemID, a.EnrID = b.EnrID, UDFC3=''MemID Update''
	WHERE a.MemID<>b.MemID AND a.source=''HUMANA''';

BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('Memid update Humana from elig to claims',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;

--ICE-12652
	BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
		FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
		TO_TABLENAME =>	 'VH_CLAIMS_'||vLvl.SERIALNO||'',
		UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
		DELIMITER =>		'-',
		UPDATE_PASSES =>	'1-2-3-4',
		LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
		LVL_DESC_YN =>	  'Y',
		PASS_1_JOIN_CONDITION =>	'[a.source]=''HUMANA'' and  a.LVLID3 = b.LVLID3',
		PASS_1_UPDATE_CONDITION =>	'[a.source]=''HUMANA''',
		PASS_2_JOIN_CONDITION =>	'[a.source]=''HUMANA'' and  a.LVLID3 = b.LVLID3',
		PASS_2_UPDATE_CONDITION =>	'[a.source]=''HUMANA'' and [a.UDFC4] IS NULL',
		PASS_3_JOIN_CONDITION =>	'[a.source]=''HUMANA'' and a.LVLID3 = b.LVLID3',
		PASS_3_UPDATE_CONDITION =>	'[a.source]=''HUMANA'' and [a.UDFC4] IS NULL',
		PASS_4_JOIN_CONDITION =>	'[a.source]=''HUMANA'' and a.LVLID3 = b.LVLID3',
		PASS_4_UPDATE_CONDITION =>	'[a.source]=''HUMANA'' and [a.UDFC4] IS NULL',
		BEGIN_END_DTE_YN =>	 'N',
		STABLE_FROM_TABLE_YN =>	 'N',
		ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
	);
	END;
	COMMIT;

	/*********************************************Beginning to Plan type and Plan name update from Humana Elig****************************************************/
	vbQuery:='MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.SERVICEDATE,F.LVLID3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.SERVICEDATE, B.LVLID3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.SERVICEDATE ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL(a.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        WHERE a.source=''HUMANA''
        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
	C.LVLID3=D.LVLID3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE
	c.plantype IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('Humana CLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
vbQuery:='MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype, F.LVLID3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype,B.LVLID3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        ) f
        WHERE rn=1
) d
ON
(
        c.MEMID=d.MEMID
        AND
        C.LVLID3=D.LVLID3
)
WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
WHERE  c.PLANTYPE IS NULL';

---------------------------------------Executing second pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('Humana CLAIMS Planname and Plantype UPDATE PASS 2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;

----------------------------------------------------------------------------------------------------------------------------------------------------------

vbQuery:='MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE,F.LVLID3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,B.LVLID3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
) d
ON
(
        c.ENRID=d.ENRID
        AND
        C.LVLID3=D.LVLID3
)
WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
WHERE  c.PLANTYPE IS NULL';

-------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('Humana CLAIMS Planname and Plantype UPDATE PASS 3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
--/*********************************************End of Plan type and Plan name update from Humana Elig**********************************************************/
END IF;

----------------************************** END OF CLAIMS  *********************----------------
--------------------------------------------------------------------------------------------------
tablename:='VH_Claims_'||vLvl.SERIALNO;
vbQuery:='INSERT INTO ZZZ_PACKAGE_MERGE VALUES('''||tablename||''','''||EmpID||''',''CLAIMS'','''||vLvl.SERIALNO||''')';

BEGIN EXECUTE IMMEDIATE vbquery;
EXCEPTION WHEN OTHERS THEN
xp_scrubStatusLog ('CLAIMS',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'INSERT INTO ZZZ_PACKAGE_MERGE VALUES CLAIMS','','E');

END;
COMMIT;
----------------------------------------- CLAIMS START ICE 4869 BCBSIL----------------------------------------------------------
IF  vLvl.PAYER='BCBSIL' THEN

VBQUERY := 'DROP TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM AS
	    SELECT
		    SOURCE,
		    MEMID,
		    ENRID,
		    LVLID1,
		    LVLDESC1,
		    LVLID3,
		    LVLDESC3,
			SRCRELFLAG,
			SPECCODE,
		    SPECDESC,
			PRODUCTID
		FROM
		    VH_CLAIMS
		 WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
    xp_scrubStatusLog ('CLAIMS TABLE CREATE BCBSIL',EMPID,'BCBSIL',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	BEGIN
		SP_PYR_209_MED_BCIL('HI0826001','HI_CLAIMS_BCBSIL_'||EMPID||'','CLAIMS','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIMS-COMM BCBSIL',EMPID,'BCBSIL',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_209_MED_BCIL','','E');
	END;
	COMMIT;
----------------------------------------------------------------------------------------------------------

	vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID3,
		LVLDESC3,
		SRCRELFLAG,
		SPECCODE,
		SPECDESC,
		PRODUCTID
	)
	SELECT
		a.ROWID AS SRCROWID,
		''BCBSIL'' AS SOURCE,
		CASE WHEN grp.ROLLUPID = ''CECO'' THEN NVL(UPD.MEMID,COALESCE(SubStr(A.subscriber_id,-9) || Decode(Upper(a.patient_gender),''M'',''M'',''F'',''F'',''U'') || TO_CHAR(A.patient_dob,''YYYYMMDD''),''MEMBERID'')  )
		ELSE
		COALESCE(SubStr(A.subscriber_id,-9) || Decode(Upper(a.patient_gender),''M'',''M'',''F'',''F'',''U'') || TO_CHAR(A.patient_dob,''YYYYMMDD''),''MEMBERID'')||''-''||grp.ROLLUPID END AS MEMID,
		CASE WHEN grp.ROLLUPID = ''CECO'' THEN NVL(UPD.ENRID,COALESCE(SubStr(A.subscriber_id,-9),''EMPLOYEEID'')) ELSE  COALESCE(SubStr(A.subscriber_id,-9),''EMPLOYEEID'')||''-''||grp.ROLLUPID END AS ENRID,
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		NVL(GRP.rollupid,a.account_number) AS LVLID3,
		NVL(GRP.group_name,a.account_number) AS LVL3DESC,
		NVL(rel.ROLLUPRELDESC,a.PATIENT_RELATIONSHIP) AS SRCRELFLAG,
		NVL(spec.rollup_code,REGEXP_REPLACE(a.PERFORM_PROV_SPECIALTY,''[!~]'')) AS SPECCODE,
		UPPER(NVL(spec.rollup_desc,REGEXP_REPLACE(a.PERFORM_PROV_SPECIALTY,''[!~]''))) AS SPECDESC,
		''1'' AS PRODUCTID
	FROM
		HI0826001.HI_CLAIMS_BCBSIL_'||EMPID||' a

	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.account_number = grp.src_code
		LEFT JOIN
		HR_826_RELFLAG_BCIL rel
	ON
		upper(a.PATIENT_RELATIONSHIP) = rel.SRCRELCODE
		LEFT JOIN
		HR_826_SPEC spec
	ON
		upper(REGEXP_REPLACE(a.PERFORM_PROV_SPECIALTY,''[~!]'')) = spec.SRCCODE AND PAYER=''BCBSIL''
	';
	IF EMPID IN ('CECO') THEN
	vbQuery := vbQuery||'
	LEFT JOIN
		ZZZ_E2C_E2R_MEMUPD_'||EMPID||' UPD
	ON
		UPPER(a.PATIENT_FIRST_NAME) = UPD.MEMFIRSTNAME
		AND
		UPPER(a.PATIENT_LAST_NAME) = UPD.MEMLASTNAME
		AND
		DECODE(UPPER(a.PATIENT_GENDER),''M'',''M'',''F'',''F'',''U'')  = UPD.GENDER
		AND
		a.PATIENT_DOB = UPD.DOB
		AND
		NVL(GRP.rollupid,a.account_number) = UPD.LVLID3
		';
	END IF;
	BEGIN
		EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('CLAIMS-CSTM BCBSIL',EMPID,'BCBSIL','','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIMS-CSTM BCBSIL',EMPID,'BCBSIL',SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
	END;
	COMMIT;
------------------------------------------------------------------------------------------------------------------
	BEGIN
		SP_CDF_TBL_MERGE(USER,'CLAIMS-MERGE BCBSIL','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM','VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_CLAIMS_'||vLvl.SERIALNO||'_BC');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIMS-MERGE BCBSIL',EMPID,'BCBSIL',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	END;
	COMMIT;

---------------------------------- Start of Insert of  BCBSIL ---------------------------------------------------------------

	VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_CLAIMS_'||vLvl.SERIALNO||'_BC';

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('BCBSIL FINAL INSERT',EMPID,'BCBSIL','','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('BCBSIL FINAL INSERT',EMPID,'BCBSIL',SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
	END;
	COMMIT;

--ICE-11202
BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
		FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
		TO_TABLENAME =>	 'VH_CLAIMS_'||vLvl.SERIALNO||'',
		UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
		DELIMITER =>		'-',
		UPDATE_PASSES =>	'1-2-3-4',
		LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
		LVL_DESC_YN =>	  'Y',
		PASS_1_JOIN_CONDITION =>	'[a.source]=''BCBSIL'' and  a.LVLID3 = b.LVLID3',
		PASS_1_UPDATE_CONDITION =>	'[a.source]=''BCBSIL''',
		PASS_2_JOIN_CONDITION =>	'[a.source]=''BCBSIL'' and  a.LVLID3 = b.LVLID3',
		PASS_2_UPDATE_CONDITION =>	'[a.source]=''BCBSIL'' and [a.UDFC4] IS NULL',
		PASS_3_JOIN_CONDITION =>	'[a.source]=''BCBSIL'' and a.LVLID3 = b.LVLID3',
		PASS_3_UPDATE_CONDITION =>	'[a.source]=''BCBSIL'' and [a.UDFC4] IS NULL',
		PASS_4_JOIN_CONDITION =>	'[a.source]=''BCBSIL'' and a.LVLID3 = b.LVLID3',
		PASS_4_UPDATE_CONDITION =>	'[a.source]=''BCBSIL'' and [a.UDFC4] IS NULL',
		begin_END_DTE_YN =>	 'N',
		STABLE_FROM_TABLE_YN =>	 'N',
		ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
	);
END;
	 END IF;
-------------------------------------------END CLAIMS OF BCBSIL ICE 4869---------------------------------------------------

------- #187186 STRT OF CUSTOM DESIGN BENEFIT ---------

IF  vLvl.PAYER='CDBT' THEN


VBQUERY := 'DROP TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM AS
							  SELECT
								SOURCE,
								LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								LVLID4,
								LVLDESC4,
								LVLID5,
								LVLDESC5,
								LVLID6,
								LVLDESC6,
								VHPAYORID,
								PRODUCTID

						   FROM
								VH_CLAIMS
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS TABLE CREATE CDBT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_CLMS_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_3990_MED_CDBT('HI0826001','HI_CLAIMS_CDBT_'||EMPID||'','CLAIMS','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM');
exception when others then
xp_scrubStatusLog ('CLAIMS-COMM CDBT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_3990_MED_CDBT','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		LVLID5,
		LVLDESC5,
		LVLID6,
		LVLDESC6,
		VHPAYORID,
		PRODUCTID

	)
	SELECT /*+ PARALLEL(a,4) */
		 a.ROWID AS SRCROWID,
		 ''CDBT'' AS source,
		 ''C'' AS LVL1ID,
		 ''Commercial'' AS LVL1Desc,
      NULL AS LVL2ID,
		  NULL AS LVL2Desc,
		  NVL(lvl3.rollupid,a.client_group_id_code) LVL3ID,
		  NVL(lvl3.GROUP_NAME,a.client_group_id_code)  AS LVL3Desc,
		  NULL  AS LVLID4,
		  NULL AS LVLDesc4,
	    NULL AS LVLID5,
	    NULL AS LVLDesc5,
		  NULL AS LVLID6,
		  NULL AS LVLDesc6,
		 (SELECT P.PAYORID FROM HR_GLOBAL_PAYORLIST P WHERE TABLENAME=''HI_CLAIMS_CDBT'' AND  CLIENTID=''826'')  AS VHPAYORID,
		 ''1'' AS PRODUCTID

	FROM
	HI0826001.HI_CLAIMS_CDBT_'||EMPID||'  A
  left join

  HR_826_GROUP lvl3
  on
  a.client_group_id_code   = lvl3.SRC_CODE
  where client_group_id_code <> ''MAS00''

'

	 ;
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('CLAIMS-CSTM CDBT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS-CSTM CDBT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'CLAIMS-MERGE CDBT','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM','VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_CLAIMS_'||vLvl.SERIALNO||'_CDBT');
exception when others then
xp_scrubStatusLog ('CLAIMS-MERGE CDBT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

---------------------------------- Start of Insert of  ANTHEMR CA OR dropped data back ---------------------------------------------------------------

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_CLAIMS_'||vLvl.SERIALNO||'_CDBT';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('CDBT FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CDBT FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;


------- MEMID MERGE FROM ELIG TO CLAIMS -----   302100


-------------------------------------------------------------------------------------------------
vbQuery:=
		'MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' C
		USING
		(
		SELECT
			MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER,DOB
		FROM
		(
		SELECT
				MEMID, ENRID,  MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, TERMDATE,
				ROW_NUMBER() OVER (PARTITION BY MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ORDER BY TERMDATE DESC) RN
		FROM
		  VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
		)
		WHERE RN = 1
		) D
	ON
	(
			C.MEMFIRSTNAME = D.MEMFIRSTNAME
		AND
			C.MEMLASTNAME = D.MEMLASTNAME
		AND
			C.GENDER = D.GENDER
		AND
			C.DOB= D.DOB
	)
	WHEN MATCHED THEN UPDATE
	SET
	C.MEMID = D.MEMID,
	C.ENRID = D.ENRID';

-------------------------------------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
EXCEPTION WHEN OTHERS THEN
    xp_scrubStatusLog ('CLAIMS CDBT MEMID MERGE',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

COMMIT;

----------------------------------------------------------------------------
--ICE-11202
 BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
	FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
	TO_TABLENAME =>	 'VH_CLAIMS_'||vLvl.SERIALNO||'',
	UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
	DELIMITER =>		'-',
	UPDATE_PASSES =>	'1-2-3-4',
	LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
	LVL_DESC_YN =>	  'Y',
	PASS_1_JOIN_CONDITION =>	'[a.source]=''CDBT'' and  a.LVLID3 = b.LVLID3',
	PASS_1_UPDATE_CONDITION =>	'[a.source]=''CDBT''',
	PASS_2_JOIN_CONDITION =>	'[a.source]=''CDBT'' and  a.LVLID3 = b.LVLID3',
	PASS_2_UPDATE_CONDITION =>	  '[a.source]=''CDBT'' and [a.UDFC4] IS NULL',
	PASS_3_JOIN_CONDITION =>	'[a.source]=''CDBT'' and a.LVLID3 = b.LVLID3',
	PASS_3_UPDATE_CONDITION =>	'[a.source]=''CDBT'' and [a.UDFC4] IS NULL',
	PASS_4_JOIN_CONDITION =>	'[a.source]=''CDBT'' and a.LVLID3 = b.LVLID3',
	PASS_4_UPDATE_CONDITION =>	'[a.source]=''CDBT'' and [a.UDFC4] IS NULL',
	BEGIN_END_DTE_YN =>	 'N',
	STABLE_FROM_TABLE_YN =>	 'N',
	ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
	);
END;

COMMIT;

END IF;
--------  END OF CUSTOM DESIGN BENEFITS-----------------------------------------------------------------------------------------
---------------------------------------------ice#284473-start---------------------------------------------------
IF  vLvl.PAYER='CDBT_4734' THEN


VBQUERY := 'DROP TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_4734_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_4734_CSTM AS
							  SELECT
                MEMID,
                ENRID,
								CLMNUM,
								SOURCE,
								LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								LVLID4,
								LVLDESC4,
								LVLID5,
								LVLDESC5,
								LVLID6,
								LVLDESC6,
								SPECCODE,
								SPECDESC,
								INNWK,
								--VHPAYORID,
								PRODUCTID,
								I_SRC_TBL_NM
						   FROM
								VH_CLAIMS
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS TABLE CREATE CDBT_4734',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_4734_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_4734_CSTM ADD CONSTRAINT PK_CSTMTABLE_CLMS_'||vLvl.SERIALNO||'_4734 PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_4734_MED_CDBT('HI0826001','HI_CLAIMS_CDBT_4734_'||EMPID||'','CLAIMS','VH_CLAIMS_'||vLvl.SERIALNO||'_4734_COMM');
exception when others then
xp_scrubStatusLog ('CLAIMS-COMM CDBT_4734',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4734_MED_CDBT','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_4734_CSTM TBL
	(
		SRCROWID,
    MEMID,
    ENRID,
		CLMNUM,
		SOURCE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		LVLID5,
		LVLDESC5,
		LVLID6,
		LVLDESC6,
		SPECCODE,
		SPECDESC,
		INNWK,
		--VHPAYORID,
		PRODUCTID,
		I_SRC_TBL_NM

	)
	SELECT /*+ PARALLEL(a,4) */
		a.ROWID AS SRCROWID,
    CASE WHEN LVL3.MEMID_GRP_FLAG = ''Y'' THEN
    LPAD(a.EMPLOYEE_SSN,9,''0'') || Decode(Upper(a.PATIENTGENDER),''M'',''M'',''F'',''F'',''U'') || To_Char(a.DOB,''YYYYMMDD'')||''-''||lvl3.rollupid
    ELSE LPAD(a.EMPLOYEE_SSN,9,''0'') || Decode(Upper(a.PATIENTGENDER),''M'',''M'',''F'',''F'',''U'') || To_Char(a.DOB,''YYYYMMDD'') END AS MEMID,    --295787
		CASE WHEN LVL3.MEMID_GRP_FLAG = ''Y'' THEN
    LPAD(a.EMPLOYEE_SSN,9,''0'')||''-''||lvl3.rollupid ELSE
    LPAD(a.EMPLOYEE_SSN,9,''0'') END AS ENRID,    --295787
		CASE WHEN EMPLOYERIDENTIFIER IN (''GWC00'',''SKP00'') THEN ''Y''
		   WHEN EMPLOYERIDENTIFIER IN (''MAS00'') AND PPOINDICATOR IN (''HSN'',''MMO'') THEN ''Y''
		ELSE ''N'' END||a.DOCUMENT_NUM AS CLMNUM,
		''CDBT'' AS source,
		''C'' AS LVL1ID,
		''Commercial'' AS LVL1Desc,
		NULL AS LVL2ID,
		NULL AS LVL2Desc,
		NVL(lvl3.rollupid,a.EMPLOYERIDENTIFIER) LVL3ID,
		NVL(lvl3.GROUP_NAME,a.EMPLOYERIDENTIFIER)  AS LVL3Desc,
		NULL  AS LVLID4,
		NULL AS LVLDesc4,
		NULL AS LVLID5,
		NULL AS LVLDesc5,
		NULL AS LVLID6,
		NULL AS LVLDesc6,
		NVL(spec.rollup_code, a.PROVIDERSPECIALTY) AS SPECCODE,
		UPPER(Nvl(spec.rollup_desc, a.PROVIDERSPECIALTY)) AS SPECDESC,
		CASE WHEN EMPLOYERIDENTIFIER IN (''GWC00'',''SKP00'') THEN ''Y''
		   WHEN EMPLOYERIDENTIFIER IN (''MAS00'') AND PPOINDICATOR IN (''HSN'',''MMO'') THEN ''Y''
		ELSE ''N'' END as INNWK,
		--(SELECT P.PAYORID FROM HR_GLOBAL_PAYORLIST P WHERE TABLENAME=''HI_CLAIMS_CDBT_4734'' AND  CLIENTID=''826'')  AS VHPAYORID,
		''1'' AS PRODUCTID,
		''HI_CLAIMS_CDBT_4734_'||EMPID||''' AS I_SRC_TBL_NM
	FROM
	HI0826001.HI_CLAIMS_CDBT_4734_'||EMPID||'  A
	left join
		HR_826_GROUP lvl3
	on
		a.EMPLOYERIDENTIFIER   = lvl3.SRC_CODE
	LEFT JOIN
		HR_826_SPEC spec
	ON
		spec.payer = ''CDBT''
	AND
		CASE
			WHEN ISNUMERIC(a.PROVIDERSPECIALTY) = 1 THEN LPad(a.PROVIDERSPECIALTY,3,''0'')
			ELSE a.PROVIDERSPECIALTY
		END = spec.srccode
	LEFT JOIN
		HR_826_NETWORK nwk
	ON
		nwk.payer = ''CDBT''
	AND
		Upper(a.PPOINDICATOR) = nwk.srccode

'

	 ;
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('CLAIMS-CSTM CDBT_4734',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS-CSTM CDBT_4734',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'CLAIMS-MERGE CDBT_4734','VH_CLAIMS_'||vLvl.SERIALNO||'_4734_COMM','VH_CLAIMS_'||vLvl.SERIALNO||'_4734_CSTM','VH_CLAIMS_'||vLvl.SERIALNO||'_CDBT_4734');
exception when others then
xp_scrubStatusLog ('CLAIMS-MERGE CDBT_4734',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

---------------------------------- Start of Insert of  ANTHEMR CA OR dropped data back ---------------------------------------------------------------

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_CLAIMS_'||vLvl.SERIALNO||'_CDBT_4734';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('CDBT_4734 FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CDBT_4734 FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;


------- MEMID MERGE FROM ELIG TO CLAIMS ----- 302100


-------------------------------------------------------------------------------------------------
vbQuery:=
		'MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' C
		USING
		(
		SELECT
			MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER,DOB
		FROM
		(
		SELECT
				MEMID, ENRID,  MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, TERMDATE,
				ROW_NUMBER() OVER (PARTITION BY MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ORDER BY TERMDATE DESC) RN
		FROM
		  VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
		)
		WHERE RN = 1
		) D
	ON
	(
			C.MEMFIRSTNAME = D.MEMFIRSTNAME
		AND
			C.MEMLASTNAME = D.MEMLASTNAME
		AND
			C.GENDER = D.GENDER
		AND
			C.DOB= D.DOB
	)
	WHEN MATCHED THEN UPDATE
	SET
	C.MEMID = D.MEMID,
	C.ENRID = D.ENRID';

-------------------------------------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
EXCEPTION WHEN OTHERS THEN
    xp_scrubStatusLog ('CLAIMS CDBT MEMID MERGE',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

COMMIT;

----------------------------------------------------------------------------
--ICE-11202
 BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
	FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
	TO_TABLENAME =>	 'VH_CLAIMS_'||vLvl.SERIALNO||'',
	UPDATE_STATUS_FIELDNAME =>	   'UDFC4',
	DELIMITER =>		'-',
	UPDATE_PASSES =>	'1-2-3-4',
	LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
	LVL_DESC_YN =>	  'Y',
	PASS_1_JOIN_CONDITION =>	'[a.source]=''CDBT'' and  a.LVLID3 = b.LVLID3',
	PASS_1_UPDATE_CONDITION =>	'[a.source]=''CDBT''',
	PASS_2_JOIN_CONDITION =>	'[a.source]=''CDBT'' and  a.LVLID3 = b.LVLID3',
	PASS_2_UPDATE_CONDITION =>	'[a.source]=''CDBT'' and [a.UDFC4] IS NULL',
	PASS_3_JOIN_CONDITION =>	'[a.source]=''CDBT'' and a.LVLID3 = b.LVLID3',
	PASS_3_UPDATE_CONDITION =>	'[a.source]=''CDBT'' and [a.UDFC4] IS NULL',
	PASS_4_JOIN_CONDITION =>	'[a.source]=''CDBT'' and a.LVLID3 = b.LVLID3',
	PASS_4_UPDATE_CONDITION =>	'[a.source]=''CDBT'' and [a.UDFC4] IS NULL',
	BEGIN_END_DTE_YN =>	 'N',
	STABLE_FROM_TABLE_YN =>	 'N',
	ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
	);
END;

COMMIT;

END IF;
------------------------------------------ice#284473-end------------------------------------------------------



------- #178724 STRT OF AETNA CLAIMS FOR GROTE ---------

IF  vLvl.PAYER='AETNA' THEN
-------------------ice#---------------------------
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ZZZ_AETNA_MEMID_UPDATE_'||EMPID||' CASCADE CONSTRAINTS';
  EXCEPTION
    WHEN Others THEN NULL;
  END;


  vbquery:=
  'CREATE TABLE ZZZ_AETNA_MEMID_UPDATE_'||EMPID||' as
  SELECT * from
	  (SELECT
		MEMFIRSTNAME, MEMLASTNAME,DOB,MEMID, ENRID, GENDER,
		ROW_NUMBER() OVER(PARTITION BY MEMFIRSTNAME, MEMLASTNAME, DOB ORDER BY RCVMTH DESC) RN
  FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||' WHERE SOURCE=''AETNA'') a
	WHERE rn = 1';


 BEGIN EXECUTE IMMEDIATE vbquery;
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('TEMP TABLE AETNA CLAIMS UPDATE',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;


VBQUERY := 'DROP TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM AS
							  SELECT
								SOURCE,
								MEMID,
								ENRID,
								LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								LVLID4,
								LVLDESC4,
								LVLID5,
								LVLDESC5,
								LVLID6,
								LVLDESC6,
								SPECCODE,	--ice#294021
								SPECDESC,	--ice#294021
								VHPAYORID,
								PRODUCTID

						   FROM
								VH_CLAIMS
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS TABLE CREATE AETNA GTRI',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_CLMS_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_253_MED_ATNA('HI0826001','HI_CLAIMS_AETNA_'||EMPID||'','CLAIMS','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM');
exception when others then
xp_scrubStatusLog ('CLAIMS-COMM AETNA GTRI',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_253_MED_ATNA','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		LVLID5,
		LVLDESC5,
		LVLID6,
		LVLDESC6,
		SPECCODE,	--ice#294021
		SPECDESC,	--ice#294021
		VHPAYORID,
		PRODUCTID

	)
	SELECT /*+ PARALLEL(a,4) */
		 a.ROWID AS SRCROWID,
		 ''AETNA'' AS source,
		-- NVL(X.MEMID,SUBSTR(A.SRC_SUBSCRIBER_ID,-9)||DECODE(UPPER(A.MBR_GENDER_CD),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(A.MBR_BIRTH_DT,''YYYYMMDD'')) AS MEMID,
		 NVL(X.MEMID,
			CASE WHEN LVL3.MEMID_GRP_FLAG =''Y'' THEN
				SUBSTR(A.SRC_SUBSCRIBER_ID,-9)||DECODE(UPPER(A.MBR_GENDER_CD),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(A.MBR_BIRTH_DT,''YYYYMMDD'')||''-''||LVL3.ROLLUPID
			ELSE SUBSTR(A.SRC_SUBSCRIBER_ID,-9)||DECODE(UPPER(A.MBR_GENDER_CD),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(A.MBR_BIRTH_DT,''YYYYMMDD'') END ) AS MEMID,
		 --NVL(X.ENRID,SUBSTR(A.SRC_SUBSCRIBER_ID,-9)) AS ENRID,   ----ice 279609
		 NVL(X.ENRID,CASE WHEN LVL3.MEMID_GRP_FLAG =''Y'' THEN a.SRC_SUBSCRIBER_ID||''-''||LVL3.ROLLUPID ELSE a.SRC_SUBSCRIBER_ID END ) as ENRID,
		 ''C'' AS LVL1ID,
		 ''Commercial'' AS LVL1Desc,
		  NULL AS LVL2ID,
		  NULL AS LVL2Desc,
		  NVL(lvl3.rollupid,SUBSTR(a.GROUP_NBR,-7)) LVL3ID,
		  NVL(lvl3.GROUP_NAME,SUBSTR(a.GROUP_NBR,-7))  AS LVL3Desc,
		  NULL  AS LVLID4,
		  NULL AS LVLDesc4,
		  NULL AS LVLID5,
	      NULL AS LVLDesc5,
		  NULL AS LVLID6,
		  NULL AS LVLDesc6,
		  NVL(SPEC.ROLLUP_CODE,A.SRV_PROV_SPECIALTY_CD) AS SPECCODE,		--ice#294021
		UPPER(NVL(SPEC.ROLLUP_DESC,A.SRV_PROV_SPECIALTY_CD)) AS SPECDESC,	--ice#294021
		 (SELECT P.PAYORID FROM HR_GLOBAL_PAYORLIST P WHERE TABLENAME=''HI_CLAIMS_AETNA'' AND  CLIENTID=''826'')  AS VHPAYORID,
		 ''1'' AS PRODUCTID

  FROM
	HI0826001.HI_CLAIMS_AETNA_'||EMPID||'  A
  LEFT JOIN
	HR_826_GROUP lvl3
  ON
	SUBSTR(a.GROUP_NBR,-7)   =  lvl3.SRC_CODE
  LEFT JOIN
	ZZZ_AETNA_MEMID_UPDATE_'||EMPID||' X
 ON
	UPPER(A.MBR_FIRST_NM)=X.MEMFIRSTNAME
 AND
	UPPER(A.MBR_LAST_NM)=X.MEMLASTNAME
 AND
	A.MBR_BIRTH_DT=X.DOB
 AND
	DECODE(UPPER(A.MBR_GENDER_CD),''M'',''M'',''F'',''F'',''U'')=X.GENDER
LEFT JOIN
	HR_826_SPEC SPEC	--ice#294021
ON
	A.SRV_PROV_SPECIALTY_CD= SPEC.srccode
and
	spec.payer =''AETNA_UNIVERSAL''
	'
		 ;
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('CLAIMS-CSTM AETNA '||EMPID,EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS-CSTM AETNA '||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'CLAIMS-MERGE AETNA '||EMPID,'VH_CLAIMS_'||vLvl.SERIALNO||'_COMM','VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_CLAIMS_'||vLvl.SERIALNO||'_AETNA');
exception when others then
xp_scrubStatusLog ('CLAIMS-MERGE AETNA '||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

---------------------------------- Start of Insert of  ANTHEMR CA OR dropped data back ---------------------------------------------------------------

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_CLAIMS_'||vLvl.SERIALNO||'_AETNA';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('AETNA '||EMPID||' FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('AETNA '||EMPID||' FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;

-- Updated from ICE-13332
 BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
		FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
		TO_TABLENAME =>	 'VH_CLAIMS_'||vLvl.SERIALNO||'',
		UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
		DELIMITER =>		'-',
		UPDATE_PASSES =>	'1-2-3-4',
		LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
		LVL_DESC_YN =>	  'Y',
		PASS_1_JOIN_CONDITION =>	'[a.source]=''AETNA'' and  a.LVLID3 = b.LVLID3',
		PASS_1_UPDATE_CONDITION =>	'[a.source]=''AETNA''',
		PASS_2_JOIN_CONDITION =>	'[a.source]=''AETNA'' and  a.LVLID3 = b.LVLID3',
		PASS_2_UPDATE_CONDITION =>	'[a.source]=''AETNA'' and [a.UDFC4] IS NULL',
		PASS_3_JOIN_CONDITION =>	'[a.source]=''AETNA'' and a.LVLID3 = b.LVLID3',
		PASS_3_UPDATE_CONDITION =>	'[a.source]=''AETNA'' and [a.UDFC4] IS NULL',
		PASS_4_JOIN_CONDITION =>	'[a.source]=''AETNA'' and a.LVLID3 = b.LVLID3',
		PASS_4_UPDATE_CONDITION =>	'[a.source]=''AETNA'' and [a.UDFC4] IS NULL',
		BEGIN_END_DTE_YN =>	 'N',
		STABLE_FROM_TABLE_YN =>	 'N',
		ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
	);
	END;

-------  -----------------------------------------------------------------------------------------

COMMIT;

END IF;

--HERE ICE 192466


IF  vLvl.PAYER='BRITT' THEN

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ZZZ_BRITT_MEMID_UPDATE CASCADE CONSTRAINTS';
  EXCEPTION
    WHEN Others THEN NULL;
 END;


  vbquery:=
  'CREATE TABLE ZZZ_BRITT_MEMID_UPDATE as
  SELECT * from
	  (SELECT
		MEMFIRSTNAME, MEMLASTNAME,DOB,MEMID, ENRID, GENDER,
		ROW_NUMBER() OVER(PARTITION BY MEMFIRSTNAME, MEMLASTNAME, DOB ORDER BY RCVMTH DESC) RN
  FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||') a
	WHERE rn = 1';

 EXECUTE IMMEDIATE vbquery;


VBQUERY := 'DROP TABLE VH_CLAIMS_BRCL_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_CLAIMS_BRCL_'||vLvl.SERIALNO||'_CSTM AS
							  SELECT
								SOURCE,
								MEMID,
								ENRID,
								LVLID1,
								LVLDESC1,
								PROVID,
								PROVNAME,
								PRODUCTID

						   FROM
								VH_CLAIMS
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS TABLE CREATE BRCL GTRI',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_CLAIMS_BRCL_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_CLAIMS_BRCL_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_CLMS_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_4148_MED_BRCL('HI0826001','HI_CLAIMS_BRCL_'||EMPID||'','CLAIMS','VH_CLAIMS_BRCL_'||vLvl.SERIALNO||'_COMM','4');
exception when others then
xp_scrubStatusLog ('CLAIMS-COMM BRCL GTRI',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4148_MED_BRCL','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_CLAIMS_BRCL_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		PROVID,
		PROVNAME,
		PRODUCTID

	)
	SELECT /*+ PARALLEL(a,4) */
		 a.ROWID AS SRCROWID,
		 ''BRITT_CLINIC'' AS source,
		 NVL(X.MEMID,SUBSTR(a.PRIMARY_SSN,1,9)||DECODE(UPPER(a.GENDER),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.DATE_OF_BIRTH,''YYYYMMDD'')) AS MEMID,
		 NVL(X.ENRID,a.PRIMARY_SSN) AS ENRID,
		 ''C'' AS LVL1ID,
		 ''Commercial'' AS LVL1Desc,
		 ''Britt Clinic'' AS PROVID,
		 ''Britt Clinic'' AS PROVNAME,
		 ''1'' AS PRODUCTID

  FROM
	HI0826001.HI_CLAIMS_BRCL_'||EMPID||'  A
  LEFT JOIN
	ZZZ_BRITT_MEMID_UPDATE X
 ON
	CASE WHEN  InStr(first_name,'' '')<>0 THEN  REPLACE(Upper(SubStr(first_name,1,InStr(first_name,'' '')-1)),''.'','''')
   WHEN  InStr(first_name,''.'')<>0 THEN  REPLACE(Upper(SubStr(first_name,1,InStr(first_name,''.'')-1)),'' '','''')
   ELSE  Upper(first_name) END=X.MEMFIRSTNAME
 AND
	UPPER(A.last_name)=X.MEMLASTNAME
 AND
	A.date_of_birth=X.DOB
 AND
	DECODE(UPPER(A.gender),''M'',''M'',''F'',''F'',''U'')=X.GENDER'
	 ;
BEGIN EXECUTE IMMEDIATE vbquery;
EXCEPTION WHEN OTHERS THEN
	xp_scrubStatusLog ('CLAIMS BRITT_CLINIC ERROR',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'CLAIMS-MERGE BRCL GTRI','VH_CLAIMS_BRCL_'||vLvl.SERIALNO||'_COMM','VH_CLAIMS_BRCL_'||vLvl.SERIALNO||'_CSTM','VH_CLAIMS_'||vLvl.SERIALNO||'_BRCL');
exception when others then
xp_scrubStatusLog ('CLAIMS-MERGE BRCL GTRI EXCEPTION',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

vbQuery:=
	'MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||'_BRCL c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname, f.plantype, f.ZIP,f.RELFLAG, f.SRCRELFLAG, f.lvlid2,f.lvldesc2,f.lvlid3,f.lvldesc3,f.lvlid4,f.lvldesc4
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype,b.ZIP ,b.RELFLAG, b.SRCRELFLAG ,b.lvlid2,b.lvldesc2,b.lvlid3,b.lvldesc3,b.lvlid4,b.lvldesc4 ,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname,b.ZIP,b.RELFLAG, b.SRCRELFLAG ,b.lvlid2,b.lvldesc2,b.lvlid3,b.lvldesc3,b.lvlid4,b.lvldesc4) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||'_BRCL a
        ON
                b.MEMID=a.MEMID
        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
    )
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.ZIP =d.ZIP,
        c.RELFLAG = d.RELFLAG,     --ICE 209585
        c.SRCRELFLAG = d.SRCRELFLAG,     --ICE 209585
		c.lvlid2= d.lvlid2,
		c.lvldesc2= d.lvldesc2,
		c.lvlid3= d.lvlid3,
		c.lvldesc3= d.lvldesc3,
		c.lvlid4= d.lvlid4,
		c.lvldesc4= d.lvldesc4
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('CLAIMS Planname , Plantype.. UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;

----------------

	 vbQuery:='INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'
	 (
	 source,
sn,
clmnum,
claimlinenumber,
clmtype,
clmtypedesc,
clmcategory,
memid,
enrid,
relflag,
memfirstname,
memlastname,
gender,
dob,
addr1,
addr2,
city,
state,
zip,
homephone,
workphone,
lvlid1,
lvldesc1,
lvlid2,
lvldesc2,
lvlid3,
lvldesc3,
lvlid4,
lvldesc4,
lvlid5,
lvldesc5,
lvlid6,
lvldesc6,
lvlid7,
lvldesc7,
lvlid8,
lvldesc8,
lvlid9,
lvldesc9,
lvlid10,
lvldesc10,
fromdate,
todate,
servicedate,
rcvdate,
paiddate,
billtype,
poscode,
posdesc,
speccode,
specdesc,
diagcode,
diagdesc,
firstdiagcode,
firstdiagdesc,
seconddiagcode,
seconddiagdesc,
thirddiagcode,
thirddiagdesc,
fourthdiagcode,
fourthdiagdesc,
fifthdiagcode,
fifthdiagdesc,
sixthdiagcode,
sixthdiagdesc,
seventhdiagcode,
seventhdiagdesc,
eighthdiagcode,
eighthdiagdesc,
ninthdiagcode,
ninthdiagdesc,
tenthdiagcode,
tenthdiagdesc,
proctype,
proccode,
procdesc,
revcode,
drgcode,
modifiercode,
modifierdesc,
cpt4_1,
cpt4_2,
cpt4_3,
hcpcs,
cptii,
modifiercode2,
revcode1,
revcode2,
revcode4,
revcode3,
revcode5,
icd9proccode1,
icd9proccode2,
icd9proccode3,
icd9proccode4,
icd9proccode5,
icd9proccode6,
drgtype,
drgidentifier,
ipdays,
dischstatus,
typeofbill,
claimstatus,
adjcode,
provid,
provname,
providerfirstname,
providerlastname,
provnpi,
provzipcode,
servtypecode,
servtypedesc,
provtypecode,
provtypedesc,
servicecode,
specrollupcode,
specrollupdesc,
nwkid,
nwkname,
innwk,
networktype,
serviceunits,
paidamt,
billedamt,
allowedamt,
pposavingamt,
enrpaidamt,
coinsamt,
copayamt,
deductamt,
notallowedamt,
cobamt,
planexclamt,
labtestdata,
siccode,
sicdesc,
ssn,
rcvmth,
srcfilename,
sourceform,
sourcetype,
udfm1,
udfm2,
udf1,
udf2,
udf3,
udf4,
udf5,
udf6,
udf7,
udf8,
udf9,
udfc1,
udfc2,
udfc3,
udfc4,
udfc5,
udfc6,
udfc7,
udfc8,
udfc9,
udfc10,
udfc11,
udfc12,
udfc13,
udfc14,
udfc15,
udfc16,
udfc17,
udfc18,
udfc19,
udfc20,
udfd1,
udfd2,
udfd3,
udfd4,
udfd5,
udfn1,
udfn2,
udfn3,
udfn4,
udfn5,
udfn6,
udfn7,
udfn8,
udfn9,
udfn10,
udfn11,
udfn12,
udfn13,
udfn14,
udfn15,
udfn16,
udfn17,
udfn18,
udfn19,
udfn20,
vh_lvl_id,
paiddays,
emp_nbr,
medeligcatid,
productid,
icdtype,
clmheadernumber,
vhpayorid,
vhlayoutid,
nchclmtypecode,
admittype,
admitsource,
srcrelflag,
mdcr_npmt_rsn_cd,
prov_ccn,
clm_adjsmt_type_cd,
clm_query_cd,
prncpl_diag_cd,
admtg_diag_cd,
hdr_from_dt,
hdr_thru_dt,
op_srvc_typ_cd,
aifileid,
airownumber,
vhpayername,
vhgroupname,
plannumber,
planname,
plantype,
populationtype,
refrngprovid,
refrngprovname,
refrngprovnpi,
billngprovid,
billngprovname,
billngprovnpi,
billngprovtaxid,
srvcngprovid,
srvcngprovname,
srvcngprovnpi,
atndngprovid,
atndngprovname,
atndngprovnpi,
oprtngprovid,
oprtngprovname,
oprtngprovnpi,
otherprov1id,
otherprov1name,
otherprov1npi,
otherprov2id,
otherprov2name,
otherprov2npi,
enrollment_source,
covtypedesc,
iuou)
SELECT source,
sn,
clmnum,
claimlinenumber,
clmtype,
clmtypedesc,
clmcategory,
memid,
enrid,
relflag,
memfirstname,
memlastname,
gender,
dob,
addr1,
addr2,
city,
state,
zip,
homephone,
workphone,
lvlid1,
lvldesc1,
lvlid2,
lvldesc2,
lvlid3,
lvldesc3,
lvlid4,
lvldesc4,
lvlid5,
lvldesc5,
lvlid6,
lvldesc6,
lvlid7,
lvldesc7,
lvlid8,
lvldesc8,
lvlid9,
lvldesc9,
lvlid10,
lvldesc10,
fromdate,
todate,
servicedate,
rcvdate,
paiddate,
billtype,
poscode,
posdesc,
speccode,
specdesc,
diagcode,
diagdesc,
firstdiagcode,
firstdiagdesc,
seconddiagcode,
seconddiagdesc,
thirddiagcode,
thirddiagdesc,
fourthdiagcode,
fourthdiagdesc,
fifthdiagcode,
fifthdiagdesc,
sixthdiagcode,
sixthdiagdesc,
seventhdiagcode,
seventhdiagdesc,
eighthdiagcode,
eighthdiagdesc,
ninthdiagcode,
ninthdiagdesc,
tenthdiagcode,
tenthdiagdesc,
proctype,
proccode,
procdesc,
revcode,
drgcode,
modifiercode,
modifierdesc,
cpt4_1,
cpt4_2,
cpt4_3,
hcpcs,
cptii,
modifiercode2,
revcode1,
revcode2,
revcode4,
revcode3,
revcode5,
icd9proccode1,
icd9proccode2,
icd9proccode3,
icd9proccode4,
icd9proccode5,
icd9proccode6,
drgtype,
drgidentifier,
ipdays,
dischstatus,
typeofbill,
claimstatus,
adjcode,
provid,
provname,
providerfirstname,
providerlastname,
provnpi,
provzipcode,
servtypecode,
servtypedesc,
provtypecode,
provtypedesc,
servicecode,
specrollupcode,
specrollupdesc,
nwkid,
nwkname,
innwk,
networktype,
serviceunits,
paidamt,
billedamt,
allowedamt,
pposavingamt,
enrpaidamt,
coinsamt,
copayamt,
deductamt,
notallowedamt,
cobamt,
planexclamt,
labtestdata,
siccode,
sicdesc,
ssn,
rcvmth,
srcfilename,
sourceform,
sourcetype,
udfm1,
udfm2,
udf1,
udf2,
udf3,
udf4,
udf5,
udf6,
udf7,
udf8,
udf9,
udfc1,
udfc2,
udfc3,
udfc4,
udfc5,
udfc6,
udfc7,
udfc8,
udfc9,
udfc10,
udfc11,
udfc12,
udfc13,
udfc14,
udfc15,
udfc16,
udfc17,
udfc18,
udfc19,
udfc20,
udfd1,
udfd2,
udfd3,
udfd4,
udfd5,
udfn1,
udfn2,
udfn3,
udfn4,
udfn5,
udfn6,
udfn7,
udfn8,
udfn9,
udfn10,
udfn11,
udfn12,
udfn13,
udfn14,
udfn15,
udfn16,
udfn17,
udfn18,
udfn19,
udfn20,
vh_lvl_id,
paiddays,
emp_nbr,
medeligcatid,
productid,
icdtype,
clmheadernumber,
vhpayorid,
vhlayoutid,
nchclmtypecode,
admittype,
admitsource,
srcrelflag,
mdcr_npmt_rsn_cd,
prov_ccn,
clm_adjsmt_type_cd,
clm_query_cd,
prncpl_diag_cd,
admtg_diag_cd,
hdr_from_dt,
hdr_thru_dt,
op_srvc_typ_cd,
aifileid,
airownumber,
vhpayername,
vhgroupname,
plannumber,
planname,
plantype,
populationtype,
refrngprovid,
refrngprovname,
refrngprovnpi,
billngprovid,
billngprovname,
billngprovnpi,
billngprovtaxid,
srvcngprovid,
srvcngprovname,
srvcngprovnpi,
atndngprovid,
atndngprovname,
atndngprovnpi,
oprtngprovid,
oprtngprovname,
oprtngprovnpi,
otherprov1id,
otherprov1name,
otherprov1npi,
otherprov2id,
otherprov2name,
otherprov2npi,
enrollment_source,
covtypedesc,
iuou
FROM VH_CLAIMS_'||vLvl.SERIALNO||'_BRCL';
------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('Insert britt clinic into CLAIMS EXCEPTION',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;

END IF;


--END HERE ICE 192466




------- #MERITAIN CLAIMS #194051 STARTS --------

IF  vLvl.PAYER='MERITAIN' THEN

IF EMPID='BTLR' THEN

BEGIN
EXECUTE IMMEDIATE 'DROP TABLE ZZZ_MEMID_UPDATE_MERITAIN1 PURGE';
EXCEPTION WHEN OTHERS THEN NULL;
END;


vbQuery:='
    CREATE TABLE ZZZ_MEMID_UPDATE_MERITAIN1 NOLOGGING PARALLEL 4
    as
    SELECT MEMID,ENRID,MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVLID3
    FROM(
    SELECT
	  MEMID,
		ENRID,
    MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		LVLID3,
    Row_Number() OVER (PARTITION BY MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB
    ORDER BY MEMID) rn
	FROM
		VH_ELIGIBILITIES a
	WHERE LVLID3 = ''003321010''
  )
    WHERE rn=1
    ';                    -- ICE263783
	BEGIN EXECUTE IMMEDIATE vbQuery;
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ZZZ_MEMID_UPDATE_MERITAIN1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

END IF ;

VBQUERY := 'DROP TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM AS
							  SELECT
								SOURCE,
								MEMID,
								ENRID,
								LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								LVLID4,
								LVLDESC4,
								PAIDAMT,
								BILLEDAMT,
								ALLOWEDAMT,
								PPOSAVINGAMT,
								ENRPAIDAMT,
								COINSAMT,
								COPAYAMT,
								DEDUCTAMT,
								NOTALLOWEDAMT,
								COBAMT,
								SPECCODE,
								SPECDESC,
								PLANNAME,
								PLANTYPE,
								PRODUCTID,
                BILLTYPE,
                UDFC20,
                UDFN20
						   FROM
								VH_CLAIMS
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS TABLE CREATE MERITAIN CSTM',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_CLMS_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_443_MED_MRTN('HI0826001','HI_CLAIMS_MERITAIN_'||EMPID||'','CLAIMS','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM');
exception when others then
xp_scrubStatusLog ('CLAIMS-COMM MERITAIN ',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_443_MED_MRTN','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		PAIDAMT,
		BILLEDAMT,
		ALLOWEDAMT,
		PPOSAVINGAMT,
		ENRPAIDAMT,
		COINSAMT,
		COPAYAMT,
		DEDUCTAMT,
		NOTALLOWEDAMT,
		COBAMT,
		SPECCODE,
		SPECDESC,
		PRODUCTID,
    UDFC20,
    UDFN20,
    BILLTYPE

	)
	SELECT /*+ PARALLEL(a,4) */
		 a.ROWID AS SRCROWID,
		 ''MERITAIN'' AS source,';

	IF EMPID = 'BTLR' THEN
	vbQuery:= vbQuery||'
	COALESCE(mem.memid,a.INSUREDS_ID||DECODE(UPPER(a.PATIENT_GENDER),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.PATIENT_DATE_OF_BIRTH,''YYYYMMDD'')) AS MEMID,
	COALESCE(mem.enrid,a.INSUREDS_ID) AS ENRID,
	';
	ELSE
	vbQuery:= vbQuery||'
	a.INSUREDS_ID||DECODE(UPPER(a.PATIENT_GENDER),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.PATIENT_DATE_OF_BIRTH,''YYYYMMDD'') AS MEMID,
	a.INSUREDS_ID  AS ENRID,';
	END IF;
    vbQuery:= vbQuery||'
		 ''C'' AS LVL1ID,
		 ''Commercial'' AS LVL1Desc,
		  NULL AS LVL2ID,
		  NULL AS LVL2Desc,
		  NVL(lvl3.ROLLUPID,a.employer_id) LVL3ID,
		  NVL(lvl3.GROUP_NAME,a.employer_id)  AS LVL3Desc,
		  NULL  AS LVLID4,
		  NULL AS LVLDesc4,
-------------------------ICE 329982------------------
		CASE
			WHEN Upper(a.ADJUSTMENT_TYPE) IN (''Y'', ''R'') THEN -1 * Abs(a.NET_PAYMENT_AMOUNT)
			WHEN Upper(a.ADJUSTMENT_TYPE) = ''C'' AND a.NET_PAYMENT_AMOUNT < 0 THEN 0
			ELSE a.NET_PAYMENT_AMOUNT
		END AS PAIDAMT,
		CASE
			WHEN Upper(a.ADJUSTMENT_TYPE) IN (''Y'', ''R'') THEN -1 * Abs(a.SUBMITTED_AMOUNT)
			WHEN Upper(a.ADJUSTMENT_TYPE) = ''C'' AND a.SUBMITTED_AMOUNT < 0 THEN 0
			ELSE a.SUBMITTED_AMOUNT
		END AS BILLEDAMT,
		(CASE
			WHEN Upper(a.ADJUSTMENT_TYPE) IN (''Y'', ''R'') THEN -1 * Abs(a.NET_PAYMENT_AMOUNT)
			WHEN Upper(a.ADJUSTMENT_TYPE) = ''C'' AND a.NET_PAYMENT_AMOUNT < 0 THEN 0
			ELSE a.NET_PAYMENT_AMOUNT
		END )
		+
		(CASE
			WHEN Upper(a.ADJUSTMENT_TYPE) IN (''Y'', ''R'') THEN -1 * Abs(a.COINSURANCE_AMOUNT)
			WHEN Upper(a.ADJUSTMENT_TYPE) = ''C'' AND a.COINSURANCE_AMOUNT < 0 THEN 0
			ELSE a.COINSURANCE_AMOUNT
		END)
		+
		(CASE
			WHEN Upper(a.ADJUSTMENT_TYPE) IN (''Y'', ''R'') THEN -1 * Abs(a.COPAY_AMOUNT)
			WHEN Upper(a.ADJUSTMENT_TYPE) = ''C'' AND a.COPAY_AMOUNT < 0 THEN 0
			ELSE a.COPAY_AMOUNT
		END)
		+
		(CASE
			WHEN Upper(a.ADJUSTMENT_TYPE) IN (''Y'', ''R'') THEN -1 * Abs(a.DEDUCTIBLE_AMOUNT)
			WHEN Upper(a.ADJUSTMENT_TYPE) = ''C'' AND a.DEDUCTIBLE_AMOUNT < 0 THEN 0
			ELSE a.DEDUCTIBLE_AMOUNT
		END) AS ALLOWEDAMT,
		CASE
			WHEN Upper(a.ADJUSTMENT_TYPE) IN (''Y'', ''R'') THEN -1 * Abs(a.DISCOUNT_AMOUNT)
			WHEN Upper(a.ADJUSTMENT_TYPE) = ''C'' AND a.DISCOUNT_AMOUNT < 0 THEN 0
			ELSE a.DISCOUNT_AMOUNT
		END AS PPOSAVINGAMT,
		CASE
			WHEN Upper(a.ADJUSTMENT_TYPE) IN (''Y'', ''R'') THEN -1 * Abs(a.COINSURANCE_AMOUNT)
			WHEN Upper(a.ADJUSTMENT_TYPE) = ''C'' AND a.COINSURANCE_AMOUNT < 0 THEN 0
			ELSE a.COINSURANCE_AMOUNT
		END
		+
		CASE
			WHEN Upper(a.ADJUSTMENT_TYPE) IN (''Y'', ''R'') THEN -1 * Abs(a.COPAY_AMOUNT)
			WHEN Upper(a.ADJUSTMENT_TYPE) = ''C'' AND a.COPAY_AMOUNT < 0 THEN 0
			ELSE a.COPAY_AMOUNT
		END
		+
		CASE
			WHEN Upper(a.ADJUSTMENT_TYPE) IN (''Y'', ''R'') THEN -1 * Abs(a.DEDUCTIBLE_AMOUNT)
			WHEN Upper(a.ADJUSTMENT_TYPE) = ''C'' AND a.DEDUCTIBLE_AMOUNT < 0 THEN 0
			ELSE a.DEDUCTIBLE_AMOUNT
		END AS ENRPAIDAMT,
		CASE
			WHEN Upper(a.ADJUSTMENT_TYPE) IN (''Y'', ''R'') THEN -1 * Abs(a.COINSURANCE_AMOUNT)
			WHEN Upper(a.ADJUSTMENT_TYPE) = ''C'' AND a.COINSURANCE_AMOUNT < 0 THEN 0
			ELSE a.COINSURANCE_AMOUNT
		END AS COINSAMT,
		CASE
			WHEN Upper(a.ADJUSTMENT_TYPE) IN (''Y'', ''R'') THEN -1 * Abs(a.COPAY_AMOUNT)
			WHEN Upper(a.ADJUSTMENT_TYPE) = ''C'' AND a.COPAY_AMOUNT < 0 THEN 0
			ELSE a.COPAY_AMOUNT
		END AS COPAYAMT,
		CASE
			WHEN Upper(a.ADJUSTMENT_TYPE) IN (''Y'', ''R'') THEN -1 * Abs(a.DEDUCTIBLE_AMOUNT)
			WHEN Upper(a.ADJUSTMENT_TYPE) = ''C'' AND a.DEDUCTIBLE_AMOUNT < 0 THEN 0
			ELSE a.DEDUCTIBLE_AMOUNT
		END AS DEDUCTAMT,
		CASE
			WHEN Upper(a.ADJUSTMENT_TYPE) IN (''Y'', ''R'') THEN -1 * Abs(a.INELIGIBLE_AMOUNT)
			WHEN Upper(a.ADJUSTMENT_TYPE) = ''C'' AND a.INELIGIBLE_AMOUNT < 0 THEN 0
			ELSE a.INELIGIBLE_AMOUNT
		END AS NOTALLOWEDAMT,
		CASE
			WHEN Upper(a.ADJUSTMENT_TYPE) IN (''Y'', ''R'') THEN -1 * Abs(a.COB_SAVINGS_AMOUNT)
			WHEN Upper(a.ADJUSTMENT_TYPE) = ''C'' AND a.COB_SAVINGS_AMOUNT < 0 THEN 0
			ELSE a.COB_SAVINGS_AMOUNT
		END AS COBAMT,
-------------------------ICE 329982------------------
		  -- COALESCE(p1.PROCCODE,p2.PROCCODE,p3.PROCCODE,a.PROCEDURE_CODE,nullif(''R''||CASE WHEN LENGTH(a.REVENUE_CODE )=4 AND SUBSTR(a.REVENUE_CODE ,1,1) = ''0'' THEN SUBSTR(a.REVENUE_CODE ,-3) ELSE a.REVENUE_CODE END,''R''),NULLIF(''D''||a.DRG_CODE,''D'')) AS PROCCODE,
		  COALESCE(spec.ROLLUP_CODE,UPPER(a.PROVIDER_SPECIALTY),X.IMPLIEDSPECCODE) as speccode,
		  UPPER(COALESCE(spec.ROLLUP_DESC,UPPER(a.PROVIDER_SPECIALTY),X.IMPLIEDSPECDESC)) as specdesc,
		 ''1'' AS PRODUCTID,
     A.BENEFIT_CODE AS UDFC20,
     A.OVERPAYMENT_AMOUNT AS UDFN20, ';
          IF EMPID = 'BTLR' THEN
	vbQuery:= vbQuery||'
	          CASE WHEN npi.ENTITY_TYPE_CODE = ''1'' THEN ''P'' WHEN npi.ENTITY_TYPE_CODE = ''2'' THEN ''F'' ELSE ''U'' END  AS BILLTYPE '; --323000
	ELSE
	vbQuery:= vbQuery||'
	CASE WHEN a.TYPE_OF_BILL IS NULL THEN ''P'' ELSE ''F'' END AS BILLTYPE ';
	END IF;
          vbQuery:= vbQuery||'
	FROM
		HI0826001.HI_CLAIMS_MERITAIN_'||EMPID||'  A
	LEFT JOIN
		HR_826_GROUP LVL3
	ON
		substr(a.EMPLOYER_ID,1,5) = LVL3.SRC_CODE
	LEFT JOIN
		HR_826_SPEC SPEC
	ON
		UPPER(a.PROVIDER_SPECIALTY)  = SPEC.SRCCODE
	AND
		UPPER(spec.PAYER) = ''MERITAIN_STD''
	LEFT JOIN
		ZZZ_PROCS P1
	ON
		a.PROCEDURE_CODE = p1.PROCCODE
	LEFT JOIN
		ZZZ_PROCS P2
	ON
		''R''|| CASE WHEN LENGTH(a.REVENUE_CODE )=4 AND SUBSTR(a.REVENUE_CODE ,1,1) = ''0'' THEN SUBSTR(a.REVENUE_CODE ,-3) ELSE a.REVENUE_CODE END=P2.PROCCODE
	LEFT JOIN
		ZZZ_PROCS P3
	ON
		''D''||SUBSTR(a.DRG_CODE,-3)=P3.PROCCODE
	LEFT JOIN 	--259744
		ZZZ_SPECS X
	ON
		COALESCE(p1.PROCCODE,p2.PROCCODE,p3.PROCCODE,a.PROCEDURE_CODE,nullif(''R''||CASE WHEN LENGTH(a.REVENUE_CODE )=4 AND SUBSTR(a.REVENUE_CODE ,1,1) = ''0'' THEN SUBSTR(a.REVENUE_CODE ,-3) ELSE a.REVENUE_CODE END,''R''),NULLIF(''D''||a.DRG_CODE,''D''))
		= x.PROCCODE';
  IF EMPID = 'BTLR' THEN
	vbQuery:= vbQuery||'
	LEFT JOIN
		ZZZ_MEMID_UPDATE_MERITAIN1 mem
	on
		UPPER(Nvl(SubStr(a.PATIENT_FIRST_NAME,1,InStr(a.PATIENT_FIRST_NAME,'' '')-1),a.PATIENT_FIRST_NAME))  = mem.MEMFIRSTNAME
	AND
		UPPER(a.PATIENT_LAST_NAME) = mem.MEMLASTNAME
	AND
		DECODE(UPPER(a.PATIENT_GENDER),''M'',''M'',''F'',''F'',''U'') = mem.GENDER
	AND
		a.PATIENT_DATE_OF_BIRTH = mem.DOB         --ICE263783
          LEFT JOIN
                    ZZZ_PYR_NPI npi
	ON
		COALESCE(a.NPI_RENDERING_PROVIDER,a.NPI_ATTENDING_PROVIDER,a.NPI_OPERATING_PROVIDER,a.NPI_FACILITY,a.NPI_BILLING_PROVIDER,a.BILLING_PROVIDER_TAX_ID)=npi.NPI
                    ';
  END IF;
    vbQuery:= vbQuery||'
	WHERE a.PLACE_OF_SERVICE_CODE<>''01''--227414
	'
	 ;
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('CLAIMS-CSTM MERITAIN',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS-CSTM MERITAIN',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'CLAIMS-MERGE MERITAIN','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM','VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_CLAIMS_'||vLvl.SERIALNO||'_MERT');
exception when others then
xp_scrubStatusLog ('CLAIMS-MERGE MERITAIN',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

---------------------------------- Start of Insert of  ANTHEMR CA OR dropped data back ---------------------------------------------------------------

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_CLAIMS_'||vLvl.SERIALNO||'_MERT';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('MERITAIN CLMS FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('MERITAIN CLMS FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;

---------------------------------------------------START OF ICE 329982----------------------------------------------------------------

VBQUERY := 'DROP TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_107_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_107_CSTM AS
		SELECT
			SOURCE,
			MEMID,
			ENRID,
			LVLID1,
			LVLDESC1,
			LVLID2,
			LVLDESC2,
			LVLID3,
			LVLDESC3,
			LVLID4,
			LVLDESC4,
			ALLOWEDAMT,
			SPECCODE,
			SPECDESC,
			PLANNAME,
			PLANTYPE,
			PRODUCTID,
			BILLTYPE
		FROM
			VH_CLAIMS
		WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS TABLE CREATE MERITAIN CSTM',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_107_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_107_CSTM ADD PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_4942_MED_MRTN('HI0826001','HI_CLAIMS_MRTN_107_'||EMPID||'','CLAIMS','VH_CLAIMS_'||vLvl.SERIALNO||'_107_COMM');
exception when others then
xp_scrubStatusLog ('CLAIMS-COMM MERITAIN 107',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4942_MED_MRTN','','E');
end;

COMMIT;


vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_107_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		ALLOWEDAMT,
		SPECCODE,
		SPECDESC,
		PRODUCTID,
		BILLTYPE

	)
	SELECT /*+ PARALLEL(a,4) */
		 a.ROWID AS SRCROWID,
		 ''MERITAIN'' AS source,';

	IF EMPID = 'BTLR' THEN
	vbQuery:= vbQuery||'
	COALESCE(mem.memid,a.INSUREDS_ID||DECODE(UPPER(a.PATIENT_GENDER),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.PATIENT_DATE_OF_BIRTH,''YYYYMMDD'')) AS MEMID,
	COALESCE(mem.enrid,a.INSUREDS_ID) AS ENRID,
	';
	ELSE
	vbQuery:= vbQuery||'
	a.INSUREDS_ID||DECODE(UPPER(a.PATIENT_GENDER),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.PATIENT_DATE_OF_BIRTH,''YYYYMMDD'') AS MEMID,
	a.INSUREDS_ID  AS ENRID,';
	END IF;
    vbQuery:= vbQuery||'
		 ''C'' AS LVL1ID,
		 ''Commercial'' AS LVL1Desc,
		  NULL AS LVL2ID,
		  NULL AS LVL2Desc,
		  NVL(lvl3.ROLLUPID,a.employer_id) LVL3ID,
		  NVL(lvl3.GROUP_NAME,a.employer_id)  AS LVL3Desc,
		  NULL  AS LVLID4,
		  NULL AS LVLDesc4,
		(CASE
			WHEN Upper(a.ADJUSTMENT_TYPE) IN (''Y'', ''R'') THEN -1 * Abs(a.NET_PAYMENT_AMOUNT)
			WHEN Upper(a.ADJUSTMENT_TYPE) = ''C'' AND a.NET_PAYMENT_AMOUNT < 0 THEN 0
			ELSE a.NET_PAYMENT_AMOUNT
		END )
		+
		(CASE
			WHEN Upper(a.ADJUSTMENT_TYPE) IN (''Y'', ''R'') THEN -1 * Abs(a.COINSURANCE_AMOUNT)
			WHEN Upper(a.ADJUSTMENT_TYPE) = ''C'' AND a.COINSURANCE_AMOUNT < 0 THEN 0
			ELSE a.COINSURANCE_AMOUNT
		END)
		+
		(CASE
			WHEN Upper(a.ADJUSTMENT_TYPE) IN (''Y'', ''R'') THEN -1 * Abs(a.COPAY_AMOUNT)
			WHEN Upper(a.ADJUSTMENT_TYPE) = ''C'' AND a.COPAY_AMOUNT < 0 THEN 0
			ELSE a.COPAY_AMOUNT
		END)
		+
		(CASE
			WHEN Upper(a.ADJUSTMENT_TYPE) IN (''Y'', ''R'') THEN -1 * Abs(a.DEDUCTIBLE_AMOUNT)
			WHEN Upper(a.ADJUSTMENT_TYPE) = ''C'' AND a.DEDUCTIBLE_AMOUNT < 0 THEN 0
			ELSE a.DEDUCTIBLE_AMOUNT
		END) AS ALLOWEDAMT, --AS PER ICE 329984
		  COALESCE(spec.ROLLUP_CODE,SUBSTR(UPPER(a.PROVIDER_SPECIALTY),1,20),X.IMPLIEDSPECCODE) as speccode,
		  UPPER(COALESCE(spec.ROLLUP_DESC,UPPER(a.PROVIDER_SPECIALTY),X.IMPLIEDSPECDESC)) as specdesc,
		 ''1'' AS PRODUCTID, ';
          IF EMPID = 'BTLR' THEN
	vbQuery:= vbQuery||'
	          CASE WHEN npi.ENTITY_TYPE_CODE = ''1'' THEN ''P'' WHEN npi.ENTITY_TYPE_CODE = ''2'' THEN ''F'' ELSE ''U'' END  AS BILLTYPE '; --323000
	ELSE
	vbQuery:= vbQuery||'
	CASE WHEN a.TYPE_OF_BILL IS NULL THEN ''P'' ELSE ''F'' END AS BILLTYPE ';
	END IF;
          vbQuery:= vbQuery||'
	FROM
		HI0826001.HI_CLAIMS_MRTN_107_'||EMPID||'  A
	LEFT JOIN
		HR_826_GROUP LVL3
	ON
		substr(a.EMPLOYER_ID,1,5) = LVL3.SRC_CODE
	LEFT JOIN
		HR_826_SPEC SPEC
	ON
		UPPER(a.PROVIDER_SPECIALTY)  = SPEC.SRCCODE
	AND
		UPPER(spec.PAYER) = ''MERITAIN_STD''
	LEFT JOIN
		ZZZ_PROCS P1
	ON
		a.PROCEDURE_CODE = p1.PROCCODE
	LEFT JOIN
		ZZZ_PROCS P2
	ON
		''R''|| CASE WHEN LENGTH(a.REVENUE_CODE )=4 AND SUBSTR(a.REVENUE_CODE ,1,1) = ''0'' THEN SUBSTR(a.REVENUE_CODE ,-3) ELSE a.REVENUE_CODE END=P2.PROCCODE
	LEFT JOIN
		ZZZ_PROCS P3
	ON
		''D''||SUBSTR(a.DRG_CODE,-3)=P3.PROCCODE
	LEFT JOIN 	--259744
		ZZZ_SPECS X
	ON
		COALESCE(p1.PROCCODE,p2.PROCCODE,p3.PROCCODE,a.PROCEDURE_CODE,nullif(''R''||CASE WHEN LENGTH(a.REVENUE_CODE )=4 AND SUBSTR(a.REVENUE_CODE ,1,1) = ''0'' THEN SUBSTR(a.REVENUE_CODE ,-3) ELSE a.REVENUE_CODE END,''R''),NULLIF(''D''||a.DRG_CODE,''D''))
		= x.PROCCODE';
  IF EMPID = 'BTLR' THEN
	vbQuery:= vbQuery||'
	LEFT JOIN
		ZZZ_MEMID_UPDATE_MERITAIN1 mem
	on
		UPPER(Nvl(SubStr(a.PATIENT_FIRST_NAME,1,InStr(a.PATIENT_FIRST_NAME,'' '')-1),a.PATIENT_FIRST_NAME))  = mem.MEMFIRSTNAME
	AND
		UPPER(a.PATIENT_LAST_NAME) = mem.MEMLASTNAME
	AND
		DECODE(UPPER(a.PATIENT_GENDER),''M'',''M'',''F'',''F'',''U'') = mem.GENDER
	AND
		a.PATIENT_DATE_OF_BIRTH = mem.DOB         --ICE263783
          LEFT JOIN
                    ZZZ_PYR_NPI npi
	ON
		COALESCE(a.NPI_RENDERING_PROVIDER,a.NPI_ATTENDING_PROVIDER,a.NPI_OPERATING_PROVIDER,a.NPI_FACILITY,a.NPI_BILLING_PROVIDER,a.BILLING_PROVIDER_TAX_ID)=npi.NPI
                    ';
  END IF;
    vbQuery:= vbQuery||'
	WHERE a.PLACE_OF_SERVICE_CODE<>''01''--227414
	'
	 ;
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('CLAIMS-CSTM MERITAIN 107 ',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_MRTN_107_'||EMPID,'Y','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS-CSTM MERITAIN 107 ',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'HI_CLAIMS_MRTN_107_'||EMPID,'','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'CLAIMS-MERGE MERITAIN 107 ','VH_CLAIMS_'||vLvl.SERIALNO||'_107_COMM','VH_CLAIMS_'||vLvl.SERIALNO||'_107_CSTM','VH_CLAIMS_'||vLvl.SERIALNO||'_MERT_107');
exception when others then
xp_scrubStatusLog ('CLAIMS-MERGE MERITAIN 107 ',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

--------------------------------------------------------------------------------------------------------------------------------
VBQUERY:='INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_CLAIMS_'||vLvl.SERIALNO||'_MERT_107';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('MERITAIN 107 CLMS FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('MERITAIN 107 CLMS FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;

--------------------------------------------END OF ICE 329982-----------------------------------------------------------------------------------


 BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
	FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
	TO_TABLENAME =>	 'VH_CLAIMS_'||vLvl.SERIALNO||'',
	UPDATE_STATUS_FIELDNAME =>	  NULL,
	DELIMITER =>		'-',
	UPDATE_PASSES =>	'1-2',
	LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
	LVL_DESC_YN =>	  'Y',
	PASS_1_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3 AND [a.source]=[b.source]',
	PASS_1_UPDATE_CONDITION =>	'[a.source] in (''MERITAIN'',''MERITAIN_107'')',
	PASS_2_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3 AND [a.source]=[b.source]'  ,
	PASS_2_UPDATE_CONDITION =>	  '[a.LVLID2] IS NULL and [a.source] in (''MERITAIN'',''MERITAIN_107'') AND [b.source]=''MERITAIN''',
	PASS_3_JOIN_CONDITION =>	NULL,
	PASS_3_UPDATE_CONDITION =>	NULL,
	PASS_4_JOIN_CONDITION =>	NULL,
	PASS_4_UPDATE_CONDITION =>	NULL,
	BEGIN_END_DTE_YN =>	 'N',
	STABLE_FROM_TABLE_YN =>	 'N',
	ORDER_BY_LIST =>	NULL
	);
END;


--/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.servicedate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.servicedate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.servicedate ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.servicedate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.servicedate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.servicedate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('MERITAIN CLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('MERITAIN CLAIMS Planname and Plantype UPDATE PASS 2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.ENRID=d.ENRID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
    UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE   c.planname IS NULL';
---------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('MERITAIN CLAIMS Planname and Plantype UPDATE PASS 3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------


END IF;

--------  #194051 END OF MERTITAIN CLAIMS  -----------------------------------------------------------------------------------------
------- #MMO CLAIMS #240305 STARTS --------

IF  vLvl.PAYER='MMO' THEN

VBQUERY := 'DROP TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM_227 PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM_227 AS
							  SELECT
								SOURCE,
								LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								LVLID4,
								LVLDESC4,
                                SPECCODE,
								SPECDESC,
								PRODUCTID,
								MEMID,--ICE-5643
								ENRID--ICE-5643
						   FROM
								VH_CLAIMS
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS TABLE CREATE MMO CSTM New layout',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM_227 ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM_227 ADD CONSTRAINT PK_CSTMTABLE_CLMS_'||vLvl.SERIALNO||'_227 PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_4557_MED_MMOH('HI0826001','HI_CLAIMS_MMOH_'||EMPID||'_227','CLAIMS','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM_227');
EXCEPTION WHEN OTHERS THEN
xp_scrubStatusLog ('CLAIMS-COMM MMO ',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4557_MED_MMOH','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM_227 TBL
	(
		SRCROWID,
		SOURCE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
        SPECCODE,
		SPECDESC,
        PRODUCTID,
		MEMID,--ICE-5643
		ENRID--ICE-5643

	)
	SELECT /*+ PARALLEL(a,4) */
		  a.ROWID AS SRCROWID,
		  ''MMOH'' AS source,
		  ''C'' AS LVL1ID,
		  ''Commercial'' AS LVL1Desc,
		  NULL AS LVL2ID,
		  NULL AS LVL2Desc,
		  NVL(lvl3.ROLLUPID,SubStr(A.SCDRO_PAID_AS_GROUP_NUMBER,1,6)) LVL3ID,
		  NVL(lvl3.GROUP_NAME,SubStr(A.SCDRO_PAID_AS_GROUP_NUMBER,1,6))  AS LVL3Desc,
		  NULL  AS LVLID4,
		  NULL AS LVLDesc4,
           NVL(spec.ROLLUP_CODE,a.SCDRO_BL_PROVIDER_SPECIALTY) AS SPECCODE,   --ICE 337254
		  UPPER(NVL(spec.ROLLUP_DESC,a.SCDRO_BL_PROVIDER_SPECIALTY)) AS SPECDESC,   --ICE 337254
          ''1'' AS PRODUCTID,
		 ';
	IF EMPID IN ('MEVS','PIQU', 'WECS', 'ESCC', 'CSCC') THEN--ICE#13475
		vbQuery := vbQuery||'		 COALESCE(MEMUPD.MEMID,TWINS.MEMID,a.SCDRO_SUB_ID_NUMBER||DECODE(a.SCDRO_PATIENT_SEX,''1'',''M'',''2'',''F'',''U'')||TO_CHAR(a.SCDRO_PATIENT_BIRTHDATE,''YYYYMMDD'')||CASE WHEN LVL3.memid_grp_flag=''Y'' THEN ''-''||lvl3.ROLLUPID END)
		';
		ELSE
			vbQuery:=vbQuery||' a.SCDRO_SUB_ID_NUMBER||DECODE(a.SCDRO_PATIENT_SEX,''1'',''M'',''2'',''F'',''U'')||TO_CHAR(a.SCDRO_PATIENT_BIRTHDATE,''YYYYMMDD'')||CASE WHEN LVL3.memid_grp_flag=''Y'' THEN ''-''||lvl3.ROLLUPID END
			';
		END IF;
		vbQuery := vbQuery||'
		AS MEMID,--ICE-5643
		 ';
	IF EMPID IN ('MEVS','PIQU', 'WECS', 'ESCC', 'CSCC') THEN--ICE#13475
		vbQuery := vbQuery||'
		COALESCE(MEMUPD.ENRID,a.SCDRO_SUB_ID_NUMBER||CASE WHEN LVL3.memid_grp_flag=''Y'' THEN ''-''||lvl3.ROLLUPID END)
	';
	ELSE
		vbQuery:=vbQuery||'
		a.SCDRO_SUB_ID_NUMBER||CASE WHEN LVL3.memid_grp_flag=''Y'' THEN ''-''||lvl3.ROLLUPID END
		';
	END IF;
	vbQuery := vbQuery||'
	AS ENRID--ICE-5643
	FROM
		HI0826001.HI_CLAIMS_MMOH_'||EMPID||'_227  A
	LEFT JOIN
		HR_826_GROUP LVL3
	ON
		--SubStr(A.SCDRO_PAID_AS_GROUP_NUMBER,1,6) = LVL3.SRC_CODE
	 CASE WHEN '''||EMPID||''' IN   (''ESCC'',''CSCC'') THEN A.SCDRO_PAID_AS_GROUP_NUMBER ELSE SubStr(A.SCDRO_PAID_AS_GROUP_NUMBER,1,6) END = LVL3.SRC_CODE
     LEFT JOIN
		HR_826_SPEC SPEC    --ICE 337254
	ON
		a.SCDRO_BL_PROVIDER_SPECIALTY = SPEC.srccode
		and SPEC.PAYER=''MMO''
	';
	IF EMPID IN ('MEVS','PIQU', 'WECS', 'ESCC', 'CSCC') THEN--ICE#13475
	vbQuery := vbQuery||'
	LEFT JOIN
		ZZZ_E2C_E2R_MEMUPD_'||EMPID||'_MMOH MEMUPD--ICE-5643
	ON
		Upper(a.SCDRO_PATIENT_FIRST_NAME) = MEMUPD.MEMFIRSTNAME
	AND
		Upper(a.SCDRO_PATIENT_LAST_NAME)= MEMUPD.MEMLASTNAME
	AND
		DECODE(a.SCDRO_PATIENT_SEX,''1'',''M'',''2'',''F'',''U'')= MEMUPD.GENDER
	AND
		a.SCDRO_PATIENT_BIRTHDATE = MEMUPD.DOB
	AND
		NVL(lvl3.ROLLUPID,SubStr(A.SCDRO_PAID_AS_GROUP_NUMBER,1,6))= MEMUPD.LVLID3
	LEFT JOIN
		ZZZ_MMOH_'||EMPID||'_TWIN TWINS--ICE-5643
	ON
		Upper(a.SCDRO_PATIENT_FIRST_NAME) = TWINS.MEMFIRSTNAME
	AND
		Upper(a.SCDRO_PATIENT_LAST_NAME)= TWINS.MEMLASTNAME
	AND
		DECODE(a.SCDRO_PATIENT_SEX,''1'',''M'',''2'',''F'',''U'')= TWINS.GENDER
	AND
		a.SCDRO_PATIENT_BIRTHDATE = TWINS.DOB
	AND
		NVL(lvl3.ROLLUPID,SubStr(A.SCDRO_PAID_AS_GROUP_NUMBER,1,6))= TWINS.LVLID3
	';
	END IF;
	vbQuery := vbQuery||'
	';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('CLAIMS-CSTM MMO',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_MMOH_'||EMPID||'_227','Y','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS-CSTM MMO',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
BEGIN
 SP_CDF_TBL_MERGE(USER,'CLAIMS-MERGE MMO','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM_227','VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM_227','VH_CLAIMS_'||vLvl.SERIALNO||'_MMO');
EXCEPTION WHEN OTHERS THEN
xp_scrubStatusLog ('CLAIMS-MERGE MMO',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_CLAIMS_'||vLvl.SERIALNO||'_MMO';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('MMO CLMS FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_MMOH_'||EMPID||'_227','Y','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('MMO CLMS FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;

BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
	FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
	TO_TABLENAME =>	 'VH_CLAIMS_'||vLvl.SERIALNO||'',
	UPDATE_STATUS_FIELDNAME =>	  NULL,
	DELIMITER =>		'-',
	UPDATE_PASSES =>	'1-2',
	LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
	LVL_DESC_YN =>	  'Y',
	PASS_1_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3 AND [a.source]=[b.source]',
	PASS_1_UPDATE_CONDITION =>	'[a.source]=''MMOH''',
	PASS_2_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3 AND [a.source]=[b.source]'  ,
	PASS_2_UPDATE_CONDITION =>	  '[a.LVLID2] IS NULL and [a.source]=''MMOH'' AND [b.source]=''MMOH''',
	PASS_3_JOIN_CONDITION =>	NULL,
	PASS_3_UPDATE_CONDITION =>	NULL,
	PASS_4_JOIN_CONDITION =>	NULL,
	PASS_4_UPDATE_CONDITION =>	NULL,
	BEGIN_END_DTE_YN =>	 'N',
	STABLE_FROM_TABLE_YN =>	 'N',
	ORDER_BY_LIST =>	NULL
	);
END;

--/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.servicedate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.servicedate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.servicedate ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.servicedate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.servicedate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.servicedate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('MMOH CLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('MMOH CLAIMS Planname and Plantype UPDATE PASS 2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.ENRID=d.ENRID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
    UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE   c.planname IS NULL';
---------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('MMOH CLAIMS Planname and Plantype UPDATE PASS 3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------



END IF;


------- #MMO CLAIMS 240305 ENDS --------


------- #MMOH CLAIMS #223053 STARTS --------

IF  vLvl.PAYER='MMOH' THEN


VBQUERY := 'DROP TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM AS
							  SELECT
								SOURCE,
								LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								LVLID4,
								LVLDESC4,
                                SPECCODE,
								SPECDESC,
                                PRODUCTID
						   FROM
								VH_CLAIMS
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS TABLE CREATE MMOH CSTM',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_CLMS_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_2247_MED_MMOH('HI0826001','HI_CLAIMS_MMOH_'||EMPID||'','CLAIMS','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM');
exception when others then
xp_scrubStatusLog ('CLAIMS-COMM MMOH ',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_2247_MED_MMOH','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
        SPECCODE,
		SPECDESC,
        PRODUCTID

	)
	SELECT /*+ PARALLEL(a,4) */
		  a.ROWID AS SRCROWID,
		  ''MMOH'' AS source,
		  ''C'' AS LVL1ID,
		  ''Commercial'' AS LVL1Desc,
		  NULL AS LVL2ID,
		  NULL AS LVL2Desc,
		  NVL(lvl3.ROLLUPID,SubStr(A.SCDRO_PAID_AS_GROUP_NUMBER,1,6)) LVL3ID,
		  NVL(lvl3.GROUP_NAME,SubStr(A.SCDRO_PAID_AS_GROUP_NUMBER,1,6))  AS LVL3Desc,
		  NULL  AS LVLID4,
		  NULL AS LVLDesc4,
         Nvl(SPEC.ROLLUP_CODE,A.SCDRO_BL_PROVIDER_SPECIALTY) AS SPECCODE,  --ICE 337254
		  UPPER(Nvl(SPEC.ROLLUP_DESC,A.SCDRO_BL_PROVIDER_SPECIALTY)) AS SPECDESC,  --ICE 337254
         ''1'' AS PRODUCTID
	FROM
		HI0826001.HI_CLAIMS_MMOH_'||EMPID||'  A
	LEFT JOIN
		HR_826_GROUP LVL3
	ON
		SubStr(A.SCDRO_PAID_AS_GROUP_NUMBER,1,6) = LVL3.SRC_CODE
    LEFT JOIN HR_826_SPEC SPEC  --ICE 337254
	ON
		A.SCDRO_BL_PROVIDER_SPECIALTY = SPEC.SRCCODE
		AND SPEC.PAYER=''MMO''
'
	 ;
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('CLAIMS-CSTM MMOH',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS-CSTM MMOH',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'CLAIMS-MERGE MMOH','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM','VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_CLAIMS_'||vLvl.SERIALNO||'_MMOH');
exception when others then
xp_scrubStatusLog ('CLAIMS-MERGE MMOH',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

---------------------------------- Start of Insert of  ANTHEMR CA OR dropped data back ---------------------------------------------------------------

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_CLAIMS_'||vLvl.SERIALNO||'_MMOH';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('MMOH CLMS FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('MMOH CLMS FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;



 BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
	FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
	TO_TABLENAME =>	 'VH_CLAIMS_'||vLvl.SERIALNO||'',
	UPDATE_STATUS_FIELDNAME =>	  NULL,
	DELIMITER =>		'-',
	UPDATE_PASSES =>	'1-2',
	LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
	LVL_DESC_YN =>	  'Y',
	PASS_1_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3 AND [a.source]=[b.source]',
	PASS_1_UPDATE_CONDITION =>	'[a.source]=''MMOH''',
	PASS_2_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3 AND [a.source]=[b.source]'  ,
	PASS_2_UPDATE_CONDITION =>	  '[a.LVLID2] IS NULL and [a.source]=''MMOH'' AND [b.source]=''MMOH''',
	PASS_3_JOIN_CONDITION =>	NULL,
	PASS_3_UPDATE_CONDITION =>	NULL,
	PASS_4_JOIN_CONDITION =>	NULL,
	PASS_4_UPDATE_CONDITION =>	NULL,
	BEGIN_END_DTE_YN =>	 'N',
	STABLE_FROM_TABLE_YN =>	 'N',
	ORDER_BY_LIST =>	NULL
	);
END;

--/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.servicedate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.servicedate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.servicedate ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.servicedate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.servicedate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.servicedate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('MMOH CLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('MMOH CLAIMS Planname and Plantype UPDATE PASS 2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_CLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.ENRID=d.ENRID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
    UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE   c.planname IS NULL';
---------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('MMOH CLAIMS Planname and Plantype UPDATE PASS 3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------


END IF;

--------  #223053 END OF MMOH CLAIMS  -----------------------------------------------------------------------------------------

----------------------------------------------------Start ICE#9468

IF  vLvl.PAYER='OUHL' THEN

BEGIN EXECUTE IMMEDIATE 'DROP TABLE zzz_med_ANTHEM_'||vLvl.SERIALNO||' PURGE';
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
---------------------------------------------------------------------------------------------
	vbQuery:=
	'CREATE TABLE zzz_med_ANTHEM_'||vLvl.SERIALNO||' NOLOGGING AS
	SELECT
	  MEMID,
	  ENRID,
	  MEMFIRSTNAME,
	  MEMLASTNAME,
	  RELFLAG,
	  GENDER,
	  DOB,
	  LVLID2,
	  LVLDESC2,
	  LVLID3,
      LVLID4,
      LVLDESC4,
      UDFC10
	FROM (
			SELECT
			MEMID,
			ENRID,
			MEMFIRSTNAME,
			MEMLASTNAME,
			RELFLAG,
			GENDER,
			DOB,
			LVLID2,
			LVLDESC2,
			LVLID3,
			LVLID4,
			LVLDESC4,
			UDFC10,
			row_number() over (partition BY MEMFIRSTNAME,MEMLASTNAME,LVLID3, UDFC10  order by a.effdate desc Nulls last, a.TERMDATE desc , MEMID) RN
    FROM
		VH_ELIGIBILITIES_'||vLvl.SERIALNO||' a
		where source = ''OUR HEALTH''  and lvlid3 in (''TAVG'',''730337'', ''HAMI'',''WEHI'')  --ICE 10161 ICE#10163
    )
    WHERE RN = 1

	';
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	COMMIT;
---------------------------------------------------------------------------------------------
VBQUERY := 'alter table zzz_med_ANTHEM_'||vLvl.SERIALNO||' add primary key (MEMFIRSTNAME,MEMLASTNAME,LVLID3, UDFC10)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY := 'DROP TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM AS
							SELECT
								SOURCE,
								MEMID,
								ENRID,
								RELFLAG,
								GENDER,
								DOB,
								LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								LVLID4,
								LVLDESC4,
								ProductID,
								ProvID
						   FROM
								VH_CLAIMS
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS TABLE CREATE OUHL',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_CLMS_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_4611_MED_OUHL('HI0826001','HI_CLAIMS_OUHL_'||EMPID||'','CLAIMS','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM');
exception when others then
xp_scrubStatusLog ('CLAIMS-COMM OUHL',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4611_MED_OUHL','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		RELFLAG,
		GENDER,
		DOB,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		ProductID,
		ProvID
	)
	SELECT /*+ PARALLEL(a,4) */
		 a.ROWID AS SRCROWID,
		 ''OUR HEALTH'' AS source,
		 SUBSTR(COALESCE(b.MEMID, SUBSTR(a.WELLNESS_ID, 1, 30)||''-''||lvl3.ROLLUPID),1,50) AS MEMID,
		 SUBSTR(COALESCE(b.ENRID, SUBSTR(a.WELLNESS_ID, 1, 15)||''-''||lvl3.ROLLUPID),1,20) AS ENRID,
		 b.RELFLAG AS RELFLAG,
		 b.GENDER  AS GENDER,
		 b.DOB AS DOB,
		 ''C'' AS LVL1ID,
		 ''Commercial'' AS LVL1Desc,
		 NULL AS LVLID2,
		 NULL AS LVLDESC2,
		  NVL(lvl3.rollupid,a.employer_name) LVL3ID,
		  NVL(lvl3.GROUP_NAME,a.employer_name)  AS LVL3Desc,
		  NULL AS LVLID4,
		  NULL AS LVLDESC4,
		  ''1'',
		  SubStr(CREATED_BY,1,5)||SubStr(CREATED_BY,length(CREATED_BY)/2,5)||SubStr(CREATED_BY,-5) AS PROVID--as suggested in ICE#9468
	FROM
		HI0826001.HI_CLAIMS_OUHL_'||EMPID||' A
	left join
		HR_826_GROUP lvl3
	on
		a.employer_name = lvl3.SRC_CODE
	LEFT JOIN
		zzz_med_ANTHEM_'||vLvl.SERIALNO||' B
	ON
		UPPER(a.FIRST_NAME) = B.MEMFIRSTNAME
	AND
		UPPER(a.LAST_NAME) = B.MEMLASTNAME
	AND
		a.wellness_id = B.UDFC10
	AND
		NVL(lvl3.rollupid,a.employer_name) = B.LVLID3

	'
	 ;
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('CLAIMS-CSTM OUHL',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS-CSTM OUHL',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'CLAIMS-MERGE OUHL','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM','VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_CLAIMS_'||vLvl.SERIALNO||'_OUHL');
exception when others then
xp_scrubStatusLog ('CLAIMS-MERGE OUHL',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

----------------------------------------------------------------------------------------------------------------------------

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_CLAIMS_'||vLvl.SERIALNO||'_OUHL';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('OUHL CLAIMS FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('OUHL CLAIMS FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;

BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
		FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
		TO_TABLENAME =>	 'VH_CLAIMS_'||vLvl.SERIALNO||'',
		UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
		DELIMITER =>		'-',
		UPDATE_PASSES =>	'1-2-3-4',
		LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
		LVL_DESC_YN =>	  'Y',
		PASS_1_JOIN_CONDITION =>	'[a.source]=''OUR HEALTH'' and  a.LVLID3 = b.LVLID3',
		PASS_1_UPDATE_CONDITION =>	'[a.source]=''OUR HEALTH''',
		PASS_2_JOIN_CONDITION =>	'[a.source]=''OUR HEALTH'' and  a.LVLID3 = b.LVLID3',
		PASS_2_UPDATE_CONDITION =>	'[a.source]=''OUR HEALTH'' and [a.UDFC4] IS NULL',
		PASS_3_JOIN_CONDITION =>	'[a.source]=''OUR HEALTH'' and a.LVLID3 = b.LVLID3',
		PASS_3_UPDATE_CONDITION =>	'[a.source]=''OUR HEALTH'' and [a.UDFC4] IS NULL',
		PASS_4_JOIN_CONDITION =>	'[a.source]=''OUR HEALTH'' and a.LVLID3 = b.LVLID3',
		PASS_4_UPDATE_CONDITION =>	'[a.source]=''OUR HEALTH'' and [a.UDFC4] IS NULL',
		begin_END_DTE_YN =>	 'N',
		STABLE_FROM_TABLE_YN =>	 'N',
		ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
	);
END;

END IF;

------------------------------ICE#14350 LAB MAPPING AS MED STARTS----------------------------
IF  vLvl.PAYER='OUHL_4613' THEN

BEGIN EXECUTE IMMEDIATE 'DROP TABLE ZZZ_ELIG_OUHL_'||vLvl.SERIALNO||' PURGE';
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
---------------------------------------------------------------------------------------------
	vbQuery:=
	'CREATE TABLE ZZZ_ELIG_OUHL_'||vLvl.SERIALNO||' NOLOGGING AS
			SELECT
			  MEMID,
			  ENRID,
			  MEMFIRSTNAME,
			  MEMLASTNAME,
			  RELFLAG,
			  GENDER,
			  DOB,
			  LVLID2,
			  LVLDESC2,
			  LVLID3,
			  LVLID4,
			  LVLDESC4
	FROM (
			SELECT
			MEMID,
			ENRID,
			MEMFIRSTNAME,
			MEMLASTNAME,
			RELFLAG,
			GENDER,
			DOB,
			LVLID2,
			LVLDESC2,
			LVLID3,
			LVLID4,
			LVLDESC4,
			ROW_NUMBER() OVER (PARTITION BY MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVLID3  ORDER BY A.EFFDATE DESC NULLS LAST, A.TERMDATE DESC , MEMID) RN
    FROM
		VH_ELIGIBILITIES_'||vLvl.SERIALNO||' a
		WHERE SOURCE = ''OUR HEALTH''  AND LVLID3 in (SELECT DISTINCT CASE WHEN EMPGRPID = ''RUMP'' THEN ''730337'' ELSE EMPGRPID END  FROM HR_826_PKG_EMPPAYER WHERE PAYER = ''OUHL_4613'')
    )
    WHERE RN = 1

	';
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	COMMIT;
---------------------------------------------------------------------------------------------
VBQUERY := 'ALTER TABLE ZZZ_ELIG_OUHL_'||vLvl.SERIALNO||' ADD PRIMARY KEY ( MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVLID3)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY := 'DROP TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM_4613 PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM_4613 AS
							SELECT
								SOURCE,
								MEMID,
								ENRID,
								LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								LVLID4,
								LVLDESC4,
								ProductID
						   FROM
								VH_CLAIMS
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS TABLE CREATE OUHL',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM_4613 ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM_4613 ADD CONSTRAINT PK_CSTMTABLE_CLMS_4613_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_4613_MED_OUHL('HI0826001','HI_LAB_OUHL_4613_'||EMPID||'','CLAIMS','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM_4613');
exception when others then
xp_scrubStatusLog ('CLAIMS-COMM OUHL_4613',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4613_MED_OUHL','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM_4613 TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		ProductID
	)
	SELECT /*+ PARALLEL(a,4) */
		a.ROWID AS SRCROWID,
		''OUR HEALTH'' AS source,
		COALESCE(b.MEMID, SubStr(REPLACE(a.OURHEALTH_WELLNESS_ID, ''-''),1,20)||Decode(Upper(a.GENDER),''M'',''M'',''F'',''F'',''U'')||To_char(a.DOB,''YYYYMMDD'')) AS MEMID,
		COALESCE(b.ENRID, SubStr(REPLACE(a.OURHEALTH_WELLNESS_ID, ''-''),1,20)) AS ENRID,
		''C'' AS LVL1ID,
		''Commercial'' AS LVL1Desc,
		NULL AS LVLID2,
		NULL AS LVLDESC2,
		NVL(lvl3.rollupid,a.COMPANY_NAME) LVL3ID,
		NVL(lvl3.GROUP_NAME,a.COMPANY_NAME)  AS LVL3Desc,
		NULL AS LVLID4,
		NULL AS LVLDESC4,
		''1''
	FROM
		HI0826001.HI_LAB_OUHL_4613_'||EMPID||' A
	left join
		HR_826_GROUP lvl3
	on
		a.COMPANY_NAME = lvl3.SRC_CODE
	LEFT JOIN
		ZZZ_ELIG_OUHL_'||vLvl.SERIALNO||' B
	ON
		UPPER(a.FIRST_NAME) = B.MEMFIRSTNAME
	AND
		UPPER(a.LAST_NAME) = B.MEMLASTNAME
	AND
		Decode(Upper(a.GENDER),''M'',''M'',''F'',''F'',''U'') = B.GENDER
	AND
		TO_CHAR(a.DOB ,''YYYYMMDD'') = TO_CHAR(B.DOB,''YYYYMMDD'')
	AND
		NVL(lvl3.rollupid,a.COMPANY_NAME) = B.LVLID3
	'
	 ;
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('CLAIMS-CSTM OUHL_4613',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_LAB_OUHL_4613_'||EMPID,'Y','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS-CSTM OUHL_4613',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'CLAIMS-MERGE OUHL_4613','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM_4613','VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM_4613','VH_CLAIMS_'||vLvl.SERIALNO||'_OUHL_4613');
exception when others then
xp_scrubStatusLog ('CLAIMS-MERGE OUHL_4613',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

----------------------------------------------------------------------------------------------------------------------------

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_CLAIMS_'||vLvl.SERIALNO||'_OUHL_4613';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('OUHL_4613 CLAIMS FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_LAB_OUHL_4613_'||EMPID,'Y','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('OUHL_4613 CLAIMS FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;

BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
		FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
		TO_TABLENAME =>	 'VH_CLAIMS_'||vLvl.SERIALNO||'',
		UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
		DELIMITER =>		'-',
		UPDATE_PASSES =>	'1-2-3-4',
		LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
		LVL_DESC_YN =>	  'Y',
		PASS_1_JOIN_CONDITION =>	'[a.source]=''OUR HEALTH'' and  a.LVLID3 = b.LVLID3',
		PASS_1_UPDATE_CONDITION =>	'[a.source]=''OUR HEALTH''',
		PASS_2_JOIN_CONDITION =>	'[a.source]=''OUR HEALTH'' and  a.LVLID3 = b.LVLID3',
		PASS_2_UPDATE_CONDITION =>	'[a.source]=''OUR HEALTH'' and [a.UDFC4] IS NULL',
		PASS_3_JOIN_CONDITION =>	'[a.source]=''OUR HEALTH'' and a.LVLID3 = b.LVLID3',
		PASS_3_UPDATE_CONDITION =>	'[a.source]=''OUR HEALTH'' and [a.UDFC4] IS NULL',
		PASS_4_JOIN_CONDITION =>	'[a.source]=''OUR HEALTH'' and a.LVLID3 = b.LVLID3',
		PASS_4_UPDATE_CONDITION =>	'[a.source]=''OUR HEALTH'' and [a.UDFC4] IS NULL',
		begin_END_DTE_YN =>	 'N',
		STABLE_FROM_TABLE_YN =>	 'N',
		ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
	);
END;

END IF;


------------------------------ICE#18474 NRAA MED Start------------------------------
IF  vLvl.PAYER='NRAA' THEN

BEGIN EXECUTE IMMEDIATE 'DROP TABLE ZZZ_ELIG_NRAA_'||vLvl.SERIALNO||' PURGE';
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
---------------------------------------------------------------------------------------------
	vbQuery:=
	'CREATE TABLE ZZZ_ELIG_NRAA_'||vLvl.SERIALNO||' NOLOGGING AS
			SELECT
			  MEMID,
			  ENRID,
			  MEMFIRSTNAME,
			  MEMLASTNAME,
			  RELFLAG,
			  GENDER,
			  DOB,
			  LVLID3
	FROM (
			SELECT
			MEMID,
			ENRID,
			MEMFIRSTNAME,
			MEMLASTNAME,
			RELFLAG,
			GENDER,
			DOB,
			LVLID3,
			ROW_NUMBER() OVER (PARTITION BY MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVLID3  ORDER BY A.EFFDATE DESC NULLS LAST, A.TERMDATE DESC , MEMID) RN
    FROM
		VH_ELIGIBILITIES_'||vLvl.SERIALNO||' a
		WHERE SOURCE = ''NORTH_AMERICAN_ADMIN''
    )
    WHERE RN = 1

	';
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	COMMIT;
---------------------------------------------------------------------------------------------
VBQUERY := 'ALTER TABLE ZZZ_ELIG_NRAA_'||vLvl.SERIALNO||' ADD PRIMARY KEY ( MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVLID3)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY := 'DROP TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM_NRAA PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM_NRAA AS
							SELECT
								SOURCE,
								MEMID,
								ENRID,
								LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								LVLID4,
								LVLDESC4,
								NWKID,
								NWKNAME,
								ProductID
						   FROM
								VH_CLAIMS
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS TABLE CREATE NRAA',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM_NRAA ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM_NRAA ADD CONSTRAINT PK_CSTMTABLE_CLMS_NRAA_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_5231_MED_NRAA('HI0826001','HI_CLAIMS_NRAA_5231_'||EMPID||'','CLAIMS','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM_NRAA');
exception when others then
xp_scrubStatusLog ('CLAIMS-COMM NRAA',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_5231_MED_NRAA','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM_NRAA TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		NWKID,
		NWKNAME,
		ProductID
	)
	SELECT /*+ PARALLEL(a,4) */
		a.ROWID AS SRCROWID,
		''NORTH_AMERICAN_ADMIN'' AS source,
		COALESCE(b.MEMID, a.MEMID||DECODE(UPPER(a.GENDER),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.DOB,''YYYYMMDD'')||''-''||lvl3.rollupid) AS MEMID,
		COALESCE(b.ENRID, a.MEMID||''-''||lvl3.rollupid) AS ENRID,
		''C'' AS LVL1ID,
		''Commercial'' AS LVL1Desc,
		NULL AS LVLID2,
		NULL AS LVLDESC2,
		NVL(lvl3.rollupid,a.EMP_NBR) LVL3ID,
		NVL(lvl3.GROUP_NAME,a.EMP_NBR)  AS LVL3Desc,
		NULL AS LVLID4,
		NULL AS LVLDESC4,
		CASE WHEN A.NWKID IS NULL THEN ''NNP''
		WHEN UPPER(A.NWKNAME) = ''WRAP NETWORK'' THEN ''WN''
		WHEN UPPER(A.NWKNAME) = ''HST'' THEN ''HST''
		ELSE Nvl(a.NWKID, ''NNP'') END AS NWKID,
		CASE WHEN UPPER(A.NWKID) IN (''HSN'') THEN ''HSN-HEALTHSPAN/HEALTHSPAN PREFERRED NORTH NEGOTIATED DISCOUNT - PATIEN''
		WHEN A.NWKID IS NULL THEN ''NETWORK NOT PROVIDED''
		ELSE a.NWKNAME END AS NWKNAME,
		''1''
	FROM
		HI0826001.HI_CLAIMS_NRAA_5231_'||EMPID||' A
	left join
		HR_826_GROUP lvl3
	on
		a.EMP_NBR = lvl3.SRC_CODE
	LEFT JOIN
		ZZZ_ELIG_NRAA_'||vLvl.SERIALNO||' B
	ON
		UPPER(a.MEMFIRSTNAME) = B.MEMFIRSTNAME
	AND
		UPPER(a.MEMLASTNAME) = B.MEMLASTNAME
	AND
		DECODE(UPPER(a.GENDER),''M'',''M'',''F'',''F'',''U'') = B.GENDER
	AND
		TO_CHAR(a.DOB ,''YYYYMMDD'') = TO_CHAR(B.DOB,''YYYYMMDD'')
	AND
		NVL(lvl3.rollupid,a.EMP_NBR) = B.LVLID3
	'
	 ;
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('CLAIMS-CSTM NRAA',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_NRAA_5231_'||EMPID,'Y','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('CLAIMS-CSTM NRAA',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'CLAIMS-MERGE NRAA','VH_CLAIMS_'||vLvl.SERIALNO||'_COMM_NRAA','VH_CLAIMS_'||vLvl.SERIALNO||'_CSTM_NRAA','VH_CLAIMS_'||vLvl.SERIALNO||'_NRAA');
exception when others then
xp_scrubStatusLog ('CLAIMS-MERGE NRAA',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

------------------------------------------------------------------------------------------------------------------
-- LOA UPDATE FROM ELIG

--1st pass

	vbQuery:=
	'MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||'_NRAA c
	USING
	(
    SELECT /*+ PARALLEL(f,4) */
      f.MEMID,f.lvlid3, f.SERVICEDATE, f.lvlid2,f.lvldesc2,f.lvlid4,f.lvldesc4
    FROM
		(
			SELECT /*+ PARALLEL(a,4) */
				b.MEMID,b.lvlid3, a.SERVICEDATE,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4,b.EFFDATE, b.TERMDATE,
				ROW_NUMBER() OVER (PARTITION BY b.MEMID,b.lvlid3,a.SERVICEDATE ORDER BY b.TERMDATE desc, b.EFFDATE desc, b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4) rn
			FROM
        VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  b
			INNER JOIN
        VH_CLAIMS_'||vLvl.SERIALNO||'_NRAA a
			ON
        b.MEMID=a.MEMID
			AND
			  b.lvlid3=a.lvlid3
			AND
        NVL( a.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
     ) f WHERE rn=1
	) d
	ON
	(
    c.MEMID=d.MEMID
		  AND
    NVL(c.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
		  AND
		c.lvlid3=d.lvlid3
    )
	WHEN MATCHED THEN UPDATE SET
    c.LVLID2= d.LVLID2, c.LVLDESC2= d.LVLDESC2,
    c.LVLID4= d.LVLID4, c.LVLDESC4= d.LVLDESC4
	';
	BEGIN
		EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIMS NRAA NEW UPDATE PASS 1',EMPID,'NRAA',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;
	COMMIT;

----------------------------------------------------------------------------------------------------------------------------------------------------------
--2nd pass
	vbQuery:=
	'MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||'_NRAA c
	USING
	(
     SELECT /*+ PARALLEL(f,4) */
		    f.MEMID,f.lvlid3, f.lvlid2,f.lvldesc2,f.lvlid4,f.lvldesc4
     FROM
		(
			SELECT /*+ PARALLEL(a,4) */
				b.MEMID,b.lvlid3,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4,
				ROW_NUMBER() OVER (PARTITION BY b.MEMID,b.lvlid3 ORDER BY b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4) rn
			FROM
        VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  b
			INNER JOIN
        VH_CLAIMS_'||vLvl.SERIALNO||'_NRAA a
			ON
        b.MEMID=a.MEMID
			AND
			  b.lvlid3=a.lvlid3
		) f
      WHERE rn=1
	) d
	ON
	(
    c.MEMID=d.MEMID
		AND
		c.lvlid3=d.lvlid3
   )
	WHEN MATCHED THEN UPDATE SET
    c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
    c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4
	WHERE c.LVLID2 IS NULL
	';

	 BEGIN
		EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('CLAIMS NRAA NEW UPDATE PASS 2',EMPID,'NRAA',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
	 
--3rd pass

	vbQuery:=
	'MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||'_NRAA c
	USING
	(
    SELECT /*+ PARALLEL(f,4) */
      f.ENRID,f.lvlid3, f.SERVICEDATE, f.lvlid2,f.lvldesc2,f.lvlid4,f.lvldesc4
    FROM
		(
			SELECT /*+ PARALLEL(a,4) */
				b.ENRID,b.lvlid3, a.SERVICEDATE,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4,b.EFFDATE, b.TERMDATE,
				ROW_NUMBER() OVER (PARTITION BY b.ENRID,b.lvlid3,a.SERVICEDATE ORDER BY b.TERMDATE desc, b.EFFDATE desc, b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4) rn
			FROM
        VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  b
			INNER JOIN
        VH_CLAIMS_'||vLvl.SERIALNO||'_NRAA a
			ON
        b.ENRID=a.ENRID
			AND
			  b.lvlid3=a.lvlid3
			AND
        NVL( a.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
     ) f WHERE rn=1
	) d
	ON
	(
    c.ENRID=d.ENRID
		  AND
    NVL(c.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.SERVICEDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
		  AND
		c.lvlid3=d.lvlid3
    )
	WHEN MATCHED THEN UPDATE SET
    c.LVLID2= d.LVLID2, c.LVLDESC2= d.LVLDESC2,
    c.LVLID4= d.LVLID4, c.LVLDESC4= d.LVLDESC4
	';
	BEGIN
		EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('CLAIMS NRAA NEW UPDATE PASS 3',EMPID,'NRAA',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;
	COMMIT;

----------------------------------------------------------------------------------------------------------------------------------------------------------
--4th pass
	vbQuery:=
	'MERGE INTO VH_CLAIMS_'||vLvl.SERIALNO||'_NRAA c
	USING
	(
     SELECT /*+ PARALLEL(f,4) */
		    f.ENRID,f.lvlid3, f.lvlid2,f.lvldesc2,f.lvlid4,f.lvldesc4
     FROM
		(
			SELECT /*+ PARALLEL(a,4) */
				b.ENRID,b.lvlid3,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4,
				ROW_NUMBER() OVER (PARTITION BY b.ENRID,b.lvlid3 ORDER BY b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4) rn
			FROM
        VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  b
			INNER JOIN
        VH_CLAIMS_'||vLvl.SERIALNO||'_NRAA a
			ON
        b.ENRID=a.ENRID
			AND
			  b.lvlid3=a.lvlid3
		) f
      WHERE rn=1
	) d
	ON
	(
    c.ENRID=d.ENRID
		AND
		c.lvlid3=d.lvlid3
   )
	WHEN MATCHED THEN UPDATE SET
    c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
    c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4
	WHERE c.LVLID2 IS NULL
	';

	 BEGIN
		EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('CLAIMS NRAA NEW UPDATE PASS 4',EMPID,'NRAA',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT; 
--------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------

VBQUERY:='ALTER TABLE VH_CLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_CLAIMS_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_CLAIMS_'||vLvl.SERIALNO||'_NRAA';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('NRAA CLAIMS FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_NRAA_5231_'||EMPID,'Y','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('NRAA CLAIMS FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;


END IF;

----------------------------------------------------Start ICE#9468

END LOOP;

  D2SCRUB.signalCompletion(SchemaName || '.SP_SC('''||EMPID||''')');

END SP_SC;
/


-----------------------------------------------------rxclaims starts here------------------------------------------
CREATE OR REPLACE PROCEDURE SP_SR
(
            EMPID IN VARCHAR2
) IS

	vbQuery LONG;
	tablename VARCHAR2(50);
	vblStaticDate DATE;
	vbDate LONG;
	SchemaName VARCHAR2(20);
  vRows NUMBER;
  vblQueryName LONG;

    BEGIN
    SELECT sys_context('USERENV', 'CURRENT_USER') INTO SchemaName FROM dual;
    SELECT TO_DATE('12-31-9999','MM-DD-YYYY') INTO vblStaticDate FROM DUAL;



FOR vLvl IN (SELECT DISTINCT SERIALNO,PAYER,EMPGRPID,replace(EMPGRPNAME,'''','''''')EMPGRPNAME  FROM HR_826_PKG_EMPPAYER WHERE EMPGRPID=''||EmpID||'' AND  SET1='RX')

	LOOP
------------------------------- RX_START-------------------------------------------------------

------------------------------- ANTHEM-------------------------------------------------------

   IF  vLvl.PAYER='ANTHEM'  THEN

	vbquery:='
	INSERT  INTO  VH_RXCLAIMS_'||vLvl.SERIALNO||'
		(
			SN,
			Source,
			SrcFileName,
			transNum,
			SEQNO,
			MemID,
			EnrID,
			RelFlag,
			MemFirstName,
			MemLastName,
			Gender,
			DOB,
			Addr1,
			Addr2,
			City,
			State,
			Zip,
			HomePhone,
			WorkPhone,
			LVLID1,
			LVLDesc1,
			LVLID2,
			LVLDesc2,
			LVLID3,
			LVLDesc3,
			LVLID4,
			LVLDesc4,
			LVLID5,
			LVLDesc5,
			LVLID6,
			LVLDesc6,
			claimStatus,
			fillDate,
			PaidDate,
			metricquantity,
			DaysSupply,
			DrugCode,
			DrugDesc,
			DrugStrength,
			Formulary_YN,
			MOI,
			PHARMID,
			PHARMNAME,
			prescriberid,
			prescribername,
			PaidAmt,
			BilledAmt,
			IngredCost,
			DispensingCost,
			SalesTax,
			ALLOWEDAMT,
			enrPaidAmt,
			CoInsAmt,
			CopayAmt,
			DeductAmt,
			NotAllowedAmt,
			AdmFees,
			AWP,
			COBAmt,
			ADJCODE,
			prescount,
			UDF1,
			UDF2,
			UDF3,
			UDF4,
			UDF5,
			RcvMth,
			SrcRelFlag,
			PlanType,
			PlanName,
			ENROLLMENT_SOURCE,
			PRODUCTID,
			VHPAYORID
		 )
	SELECT
			 ROWNUM AS SN,
			''ANTHEM'' AS Source,
			a.SOURCEFILENAME AS SrcFileName,
			a.CLM_NBR AS ClmNum,
			''01'' as SEQNO,
			COALESCE(REPLACE(a.SBSCRBR_ID||SubStr(MBR_SQNC_NBR,1,2),''~''),''MEMBERID'') AS MemID,
			COALESCE(REPLACE(a.SBSCRBR_ID,''~''),''EMPLOYEEID'')AS EmpID,
			CASE WHEN a.MBR_REL_CD IN(''18'',''20'') THEN ''E'' WHEN a.MBR_REL_CD IN (''01'',''25'',''53'') THEN ''S'' ELSE ''D'' END AS RelFlag,
			UPPER(a.MBR_FIRST_NM) AS MemFirstName,
			UPPER(a.MBR_LAST_NM) AS MemLastName,
			CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN  a.MBR_GNDR_CD ELSE ''U'' END AS  Gender,
			a.MBR_BRTH_DT DOB,
			NULL AS Addr1,
			NULL AS Addr2,
			NULL AS City,
			NULL AS State,
			SUBSTR(a.EMP_ZIP_CD,1,5) AS Zip,
			NULL AS HomePhone,
			NULL AS WorkPhone,
			''C'' AS LVL1ID,
			''Commercial'' AS LVL1Desc,
			COALESCE(t.ROLLUP_ID ,pl.ROLLUPID) AS LVL2ID,		--188358
			COALESCE(t.ROLLUP_DESC,pl.PLAN_NAME) AS LVL2Desc,	--188358,
			nvl(grp.ROLLUPID,a.ACCT_NBR) AS LVL3ID,
			nvl(grp.Group_Name,a.ACCT_NBR) AS LVL3Desc,
			Sgrp.ROLLUPID AS LVL4ID,
			Sgrp.sub_grp_nm AS LVL4Desc,
			NULL AS LVL5ID,
			NULL AS LVL5Desc,
            NULL AS LVL6ID,
			NULL AS LVL6Desc,
			NULL AS CMStatus,
			a.RX_FILL_DT AS ServiceDate,
			a.PAID_DT AS PaidDate,
			a.QTY_DISP AS ServiceUnits,
			a.DAYS_SPLY_NBR AS DaysSupply,
			a.NDC_CD AS DrugCode,
			NULL as DrugDesc,
			NULL AS DrugStrength,
			CASE a.FRMLRY_CD WHEN ''FRMLY'' THEN ''Y'' ELSE ''N'' END AS Formulary_YN,
			CASE a.MAIL_ORDR_CD WHEN ''RETAL'' THEN ''R'' WHEN ''MO'' THEN ''M'' ELSE ( CASE WHEN DAYS_SPLY_NBR>35 THEN ''M'' ELSE ''R'' END) END  AS MOI,
			a.PHARM_NBR AS PharmID,
			NULL AS PharmName,
			a.PRSC_PROV_DEA_NO AS DEANo,
			(SELECT d.ProviderName FROM zzz_NPI d WHERE a.PRSC_PROV_DEA_NO=d.NPI) AS DEAName,
			a.PAID_AMT AS PaidAmt,
			NVL(a.INGRED_COST_AMT,0)+ NVL(a.DSPNSG_FEE_AMT,0)+ NVL(a.SALES_TAX_AMT,0)+NVL(a.CPAY_AMT,0) AS BilledAmt,
			a.INGRED_COST_AMT AS IngredCost,
			a.DSPNSG_FEE_AMT AS DispensingCost,
			a.SALES_TAX_AMT AS SalesTax,
			NVL(a.INGRED_COST_AMT,0)+ NVL(a.DSPNSG_FEE_AMT,0)+ NVL(a.SALES_TAX_AMT,0) AS AllowedAmt,	--for dxcg
			NVL(a.CPAY_AMT,0)+ NVL(a.DDCTBL_AMT,0)+ NVL(a.COINSRN_AMT,0) AS EmpPaidAmt,
			a.COINSRN_AMT AS CoInsAmt,
			a.CPAY_AMT AS CopayAmt,
			a.DDCTBL_AMT AS DeductAmt,
			NULL AS NotAllowedAmt,
			NULL AS AdmFees,
			NULL AS AWP,
			NULL AS COBAmt,
			CASE WHEN a.ADJ_TYP_CD = ''RVRSL'' THEN ''R'' ELSE ''P'' END AS ADJCODE,
			CASE
			--	WHEN NVL(a.INGRED_COST_AMT,0)+ NVL(a.DSPNSG_FEE_AMT,0)+ NVL(a.SALES_TAX_AMT,0) >= 0 THEN 1
				WHEN NVL(a.INGRED_COST_AMT,0)+ NVL(a.DSPNSG_FEE_AMT,0)+ NVL(a.SALES_TAX_AMT,0) > 0 THEN 1                       -- AS PER ICE#150444
				WHEN NVL(a.INGRED_COST_AMT,0)+ NVL(a.DSPNSG_FEE_AMT,0)+ NVL(a.SALES_TAX_AMT,0) = 0 THEN 0
				ELSE -1
			END AS prescount,
			a.UDF1 AS UDF1,
			NULL AS UDF2,
			NULL AS UDF3,
			NULL AS UDF4,
			NULL AS UDF5,
			a.RECEIVEDMONTH AS RcvMth,
			(SELECT R.rollup_desc FROM HR_826_REL R WHERE  R.source = ''ANTHEMOH'' AND R.src_code=a.MBR_REL_CD ) SrcRelFlag,
			COALESCE(t.PLANTYPE, pl.PLAN_TYPE) AS PLANTYPE ,		--188358
			COALESCE(t.ROLLUP_DESC,pl.PLAN_NAME) AS PLANNAME,		--188358
			--''ANTHEM'' ENROLLMENT_SOURCE,
			NULL AS ENROLLMENT_SOURCE,    ---ICE 243113
			''1'' as PRODUCTID,
--			NULL BENCOVTYPEDESC,
			(SELECT p.PAYORID FROM HR_GLOBAL_PAYORLIST p WHERE TABLENAME=''HI_RX_ANTHEM'') AS VHPAYORID

		FROM
			HI0826001.HI_RX_ANTHEM_'||EMPID||'  a
		LEFT JOIN
			HR_826_GROUP grp
		ON
			a.ACCT_NBR = grp.src_code
		LEFT JOIN
			HR_826_ANTHEM_SUBGRP Sgrp
		ON
			a.ACCT_NBR = Sgrp.ACCT_NBR
		AND
			SUBSTR(A.SUBGRP_NBR,-4) = Sgrp.src_code
		LEFT JOIN
			HR_826_ANTHEM_PLAN pl
		ON
			a.ACCT_NBR = pl.ACCT_NBR
		AND
            CASE WHEN grp.ROLLUPID= ''TRAN''  THEN substr(a.SUBGRP_NBR , 4)
            ELSE UPPER(a.PKG_NBR) END  = pl.src_code  --ICE_10717
		LEFT JOIN													--188358
			HR_826_LOA_LVL_ROLLUP t
		ON
			a.ACCT_NBR  = t.groupid
		AND
			UPPER(a.PKG_NBR) = Upper(t.PLANCODE)
		AND
			To_Char(a.RX_FILL_DT,''YYYY'') = To_Char(t.effectivedate, ''YYYY'')
		WHERE NVL(pl.DROP_PLAN,''N'')=''N''';
	---------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('RX',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RX',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
	-----------------------------------------------------------------------------------------------

	--/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.filldate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.filldate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.filldate ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.ENRID=d.ENRID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
    UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE   c.planname IS NULL';


---------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	--- LOA Update(Level 2 and Level 4 Update)  --JIRA_15810

		vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
		USING
		(
				SELECT
						/*+ PARALLEL(f,4) */ f.MEMID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4, f.EFFDATE, f.TERMDATE, f.filldate
				FROM
						(SELECT
								/*+ PARALLEL(a,4) */ b.MEMID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.filldate,
								ROW_NUMBER() OVER (PARTITION BY b.MEMID, b.LVLID3, a.filldate ORDER BY b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.memid) rn
				FROM
						VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
				INNER JOIN
						VH_RXCLAIMS_'||vLvl.SERIALNO||' a
				ON
						b.MEMID=a.MEMID
				AND
						a.source=''ANTHEM'' and  a.LVLID3 = b.LVLID3
				AND
						NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
				) f
				WHERE rn=1
		) d
		ON
		(
				c.MEMID=d.MEMID
		AND
				NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

		)
		WHEN MATCHED THEN
				UPDATE SET
				c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
				c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
				c.UDFC4=''PASS-1 : Updated from VH_ELIGIBILITIES''
		WHERE c.source=''ANTHEM''';
		---------------------------------------------------------------------
		BEGIN EXECUTE IMMEDIATE vbquery;
				 xp_scrubStatusLog ('RXCLAIMS-LOA UPDATE PASS1',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_ANTHEM_'||EMPID||'','Y','I');
			 EXCEPTION WHEN OTHERS THEN
				 xp_scrubStatusLog ('ANTHEM RXCLAIMS LOA update from elig Pass1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
			 END;
		----------------------------------------------------------------------------------------------
		vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
		USING
		(
				SELECT
						/*+ PARALLEL(f,4) */ f.MEMID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4
				FROM
						(SELECT
								/*+ PARALLEL(a,4) */ b.MEMID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4,
								ROW_NUMBER() OVER (PARTITION BY b.MEMID, b.LVLID3 ORDER BY  b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.memid) rn
				FROM
						 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
				INNER JOIN
						VH_RXCLAIMS_'||vLvl.SERIALNO||' a
				ON
						b.MEMID=a.MEMID
				AND
						a.source=''ANTHEM'' and  a.LVLID3 = b.LVLID3
				) f
				WHERE rn=1
		) d
		ON
		(
				c.MEMID=d.MEMID
		)
		WHEN MATCHED THEN
				UPDATE SET
				c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
				c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
				c.UDFC4=''PASS-2 : Updated from VH_ELIGIBILITIES''
		WHERE c.source=''ANTHEM'' and c.UDFC4 IS NULL  ';
		---------------------------------------------------------------------
		BEGIN EXECUTE IMMEDIATE vbquery;
				 xp_scrubStatusLog ('RXCLAIMS-LOA UPDATE PASS2',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_ANTHEM_'||EMPID||'','Y','I');
			 EXCEPTION WHEN OTHERS THEN
				 xp_scrubStatusLog ('ANTHEM RXCLAIMS LOA update from elig Pass2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
			 END;
		----------------------------------------------------------------------------------------------


		vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
		USING
		(
				SELECT
						/*+ PARALLEL(f,4) */ f.ENRID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4,  f.EFFDATE, f.TERMDATE, f.filldate
				FROM
						(SELECT
								/*+ PARALLEL(a,4) */ b.ENRID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.filldate,
								ROW_NUMBER() OVER (PARTITION BY b.ENRID, b.LVLID3, a.filldate ORDER BY  b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.enrid) rn
				FROM
						 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
				INNER JOIN
						VH_RXCLAIMS_'||vLvl.SERIALNO||' a
				ON
						b.ENRID=a.ENRID
				AND
						a.source=''ANTHEM'' and a.LVLID3 = b.LVLID3
				AND
						NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
				) f
				WHERE rn=1
		) d
		ON
		(
				c.ENRID=d.ENRID
		AND
				NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
		)
		WHEN MATCHED THEN
				UPDATE SET
				c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
				c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
				c.UDFC4=''PASS-3 : Updated from VH_ELIGIBILITIES''
		WHERE c.source=''ANTHEM'' and c.UDFC4 IS NULL ';
		---------------------------------------------------------------------
		BEGIN EXECUTE IMMEDIATE vbquery;
				 xp_scrubStatusLog ('ANTHEM RXCLAIMS-LOA UPDATE PASS3',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_ANTHEM_'||EMPID||'','Y','I');
			 EXCEPTION WHEN OTHERS THEN
				 xp_scrubStatusLog ('ANTHEM RXCLAIMS LOA update from elig Pass3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
			 END;
		----------------------------------------------------------------------------------------------

		vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
		USING
		(
				SELECT
						/*+ PARALLEL(f,4) */ f.ENRID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4
				FROM
						(SELECT
								/*+ PARALLEL(a,4) */ b.ENRID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4,
								ROW_NUMBER() OVER (PARTITION BY b.ENRID, b.LVLID3 ORDER BY  b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.enrid) rn
				FROM
						 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
				INNER JOIN
						VH_RXCLAIMS_'||vLvl.SERIALNO||' a
				ON
						b.ENRID=a.ENRID
				AND
						a.source=''ANTHEM'' and a.LVLID3 = b.LVLID3
				) f
				WHERE rn=1
		) d
		ON
		(
				c.ENRID=d.ENRID
		)
		WHEN MATCHED THEN
				UPDATE SET
				c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
				c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
				c.UDFC4=''PASS-4 : Updated from VH_ELIGIBILITIES''
		WHERE c.source=''ANTHEM'' and c.UDFC4 IS NULL   ';
		---------------------------------------------------------------------
		BEGIN EXECUTE IMMEDIATE vbquery;
				 xp_scrubStatusLog ('RXCLAIMS-LOA UPDATE PASS4',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_ANTHEM_'||EMPID||'','Y','I');
			 EXCEPTION WHEN OTHERS THEN
				 xp_scrubStatusLog ('ANTHEM RXCLAIMS LOA update from elig Pass4',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
		END;
		----------------------------------------------------------------------------------------------
END IF;

--------------------------------------------------CIGNA_HCE RXCLAIMS IMPLEMENTATION STARTS (ICE 1799)--------------------------------------------------
IF  vLvl.PAYER='CIGNA HEALTHCARE' THEN

	VBQUERY := 'DROP TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM AS
	SELECT
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID3,
		LVLDESC3,
		PRODUCTID
	FROM
		VH_RXCLAIMS
	WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS TABLE CREATE CGNA CSTM',EMPID,'CGNA',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMCGNA_RX_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	BEGIN
		SP_PYR_20_RX_CGNA('HI0826001','HI_RX_CGNA_'||EMPID||'','RXCLAIMS','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','4');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RX-COMM CGNA ',EMPID,'CGNA',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_20_RX_CGNA','','E');
	END;
	COMMIT;
----------------------------------------------------------------------------------------------------------

	vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID3,
		LVLDESC3,
		PRODUCTID
	)
	SELECT /*+ PARALLEL(a,4) */
		a.ROWID AS SRCROWID,
		''CIGNA_HCE'' AS SOURCE,
		a.EMP_ID || Decode(Upper(a.SEX_CD), ''M'', ''M'', ''F'', ''F'', ''U'') || To_Char(a.PATDOB, ''YYYYMMDD'')||''-''||GRP.rollupid AS MEMID,
		a.EMP_ID||''-''||GRP.rollupid AS ENRID,
		''C'' AS LVL1ID,
		''Commercial'' AS LVL1Desc,
		nvl(grp.ROLLUPID, a.rx_acct_num)  LVL3ID,
		nvl(grp.Group_Name, a.rx_acct_num) AS LVL3Desc,
		''1'' AS PRODUCTID
	FROM
		HI0826001.HI_RX_CGNA_'||EMPID||' a

	LEFT JOIN
		HR_826_GROUP GRP
	ON
		a.rx_acct_num= grp.src_code

	';

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('RXCLAIMS CGNA CSTM ERROR',EMPID,'CGNA','','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS CGNA CSTM ERROR',EMPID,'CGNA',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;
	COMMIT;
------------------------------------------------------------------------------------------------------------------
	BEGIN
		SP_CDF_TBL_MERGE(USER,'RXCLAIMS-MERGE CGNA','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_CGNA');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS-MERGE CGNA',EMPID,'CGNA',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	END;
	COMMIT;

--------------------------------------------------TWIN CASES UPDATE --------------------------------

	vbQuery:='MERGE /*+PARALLEL(A,4)*/ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CGNA A
			USING
				(
				SELECT /*+PARALLEL(A,4)*/
					SOURCE,MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ,LVLID3,NEWMEMID
				FROM
					ZZZ_ELIG_CGNA_TWINS_'||vLvl.SERIALNO||' A )S
				ON
				(
						A.SOURCE=''CIGNA_HCE''
					AND A.LVLID3=S.LVLID3
					AND A.ENRID=S.ENRID
					AND NVL(A.DOB,TO_DATE(''2000/02/02'',''YYYY/MM/DD'')) = Nvl(s.DOB,To_DATE(''2000/02/02'',''YYYY/MM/DD''))
					AND NVL(A.Gender,''X'') = NVL(s.Gender,''X'')
					AND A.MemFirstName = s.MemFirstName
					AND A.RelFlag = ''D''
				)
				WHEN MATCHED THEN UPDATE SET
					A.MEMID = S.NEWMEMID
				';

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('CIGNA MEMID Update ',EMPID,'CGNA',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;
	COMMIT;
------------------------------------------------------------------------------------------------------------------------

--/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CGNA c
	USING
	(
        SELECT /*+ PARALLEL(f,4) */
			f.MEMID,f.lvlid3, f.filldate,f.planname, f.plantype, f.lvlid2,f.lvldesc2,f.lvlid4,f.lvldesc4
        FROM
		(
			SELECT /*+ PARALLEL(a,4) */
				b.MEMID,b.lvlid3, a.filldate,b.planname, b.plantype,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4,b.EFFDATE, b.TERMDATE,
				ROW_NUMBER() OVER (PARTITION BY b.MEMID,b.lvlid3,a.filldate ORDER BY b.planname,b.plantype,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4) rn
			FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  b
			INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||'_CGNA a
			ON
                b.MEMID=a.MEMID
				AND
			    b.lvlid3=a.lvlid3
				AND
                NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
		AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
		AND
		c.lvlid3=d.lvlid3
    )
	WHEN MATCHED THEN
        UPDATE SET
		c.planname=d.planname,
        c.plantype=d.plantype,
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4

	';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	BEGIN
		EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS Planname,Plantype.. UPDATE PASS 1',EMPID,'CGNA',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;
	COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CGNA c
	USING
	(
        SELECT /*+ PARALLEL(f,4) */
			f.MEMID,f.lvlid3,f.planname, f.plantype, f.lvlid2,f.lvldesc2,f.lvlid4,f.lvldesc4
        FROM
		(
			SELECT /*+ PARALLEL(a,4) */
				b.MEMID,b.lvlid3,b.planname, b.plantype,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4,
				ROW_NUMBER() OVER (PARTITION BY b.MEMID,b.lvlid3 ORDER BY b.planname,b.plantype,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4) rn
			FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  b
			INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||'_CGNA a
			ON
                b.MEMID=a.MEMID
				AND
			    b.lvlid3=a.lvlid3
		) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
		AND
		c.lvlid3=d.lvlid3
    )
	WHEN MATCHED THEN
        UPDATE SET
		c.planname=d.planname,
        c.plantype=d.plantype,
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4
	WHERE c.LVLID2 IS NULL
	';

---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN
		EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS Planname , Plantype.. UPDATE PASS 2',EMPID,'CGNA',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
--------------------------------------------------------------------------------------------

---------------------------------- Start of Insert of RX CIGNA OR dropped data back ---------------------------------------------------------------

	VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
          SELECT * FROM VH_RXCLAIMS_'||vLvl.SERIALNO||'_CGNA';

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('Insert CGNA group into rxclaims',EMPID,'CGNA','','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('Insert CGNA group into rxclaims',EMPID,'CGNA',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;

END IF;
---------------------------------------------------CIGNA_HCE RXCLAIMS IMPLEMENTATION ENDS (ICE 1799)----------------------------------------------------------

--HERE ICE 192467


IF  vLvl.PAYER='BRITT' THEN

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ZZZ_BRITT_MEMID_UPDATE CASCADE CONSTRAINTS';
  EXCEPTION
    WHEN Others THEN NULL;
 END;


  vbquery:=
  'CREATE TABLE ZZZ_BRITT_MEMID_UPDATE as
  SELECT * from
	  (SELECT
		MEMFIRSTNAME, MEMLASTNAME,DOB,MEMID, ENRID, GENDER,
		ROW_NUMBER() OVER(PARTITION BY MEMFIRSTNAME, MEMLASTNAME, DOB ORDER BY RCVMTH DESC) RN
  FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||') a
	WHERE rn = 1';

 EXECUTE IMMEDIATE vbquery;


VBQUERY := 'DROP TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM AS
							  SELECT
								SOURCE,
								MEMID,
								ENRID,
								LVLID1,
								LVLDESC1,
								PRODUCTID

						   FROM
								VH_RXCLAIMS
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('RXCLAIMS TABLE CREATE BRCL GTRI',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_CLMS_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_4135_RX_BRCL('HI0826001','HI_RX_BRCL_'||EMPID||'','RXCLAIMS','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','4');
exception when others then
xp_scrubStatusLog ('RX-COMM BRCL GTRI',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4135_RX_BRCL','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		PRODUCTID

	)
	SELECT /*+ PARALLEL(a,4) */
		 a.ROWID AS SRCROWID,
		 ''BRITT_CLINIC'' AS source,
		 NVL(X.MEMID, SubStr(a.PRIMARY_SSN,1,9)||Decode(Upper(a.GENDER),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.DATE_OF_BIRTH,''YYYYMMDD'')) AS MEMID,
		 NVL(X.ENRID,SubStr(a.PRIMARY_SSN,1,9)) AS ENRID,
		 ''C'' AS LVL1ID,
		 ''Commercial'' AS LVL1Desc,
		 ''1'' AS PRODUCTID

  FROM
	HI0826001.HI_RX_BRCL_'||EMPID||'  A
  LEFT JOIN
	ZZZ_BRITT_MEMID_UPDATE X
 ON
	CASE WHEN  InStr(first_name,'' '')<>0 THEN  REPLACE(Upper(SubStr(first_name,1,InStr(first_name,'' '')-1)),''.'','''')
   WHEN  InStr(first_name,''.'')<>0 THEN  REPLACE(Upper(SubStr(first_name,1,InStr(first_name,''.'')-1)),'' '','''')
   ELSE  Upper(first_name) END=X.MEMFIRSTNAME
 AND
	UPPER(A.last_name)=X.MEMLASTNAME
 AND
	A.date_of_birth=X.DOB
 AND
	DECODE(UPPER(A.gender),''M'',''M'',''F'',''F'',''U'')=X.GENDER'
	 ;
BEGIN EXECUTE IMMEDIATE vbquery;
 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS BRITT_CLINIC ERROR',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'RXCLAIMS-MERGE BRCL GTRI','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_BRCL');
exception when others then
xp_scrubStatusLog ('RXCLAIMS-MERGE BRCL GTRI',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_BRCL c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname, f.plantype, f.SRCRELFLAG, f.ZIP, f.RELFLAG, f.lvlid2,f.lvldesc2,f.lvlid3,f.lvldesc3,f.lvlid4,f.lvldesc4
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype,b.SRCRELFLAG,b.ZIP,b.RELFLAG ,b.lvlid2,b.lvldesc2,b.lvlid3,b.lvldesc3,b.lvlid4,b.lvldesc4 ,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname,b.SRCRELFLAG,b.ZIP,b.RELFLAG,b.lvlid2,b.lvldesc2,b.lvlid3,b.lvldesc3,b.lvlid4,b.lvldesc4) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||'_BRCL a
        ON
                b.MEMID=a.MEMID
        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
    )
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.SRCRELFLAG=d.SRCRELFLAG,
		c.ZIP =d.ZIP,
		c.RELFLAG  =d.RELFLAG,
		c.lvlid2= d.lvlid2,
		c.lvldesc2= d.lvldesc2,
		c.lvlid3= d.lvlid3,
		c.lvldesc3= d.lvldesc3,
		c.lvlid4= d.lvlid4,
		c.lvldesc4= d.lvldesc4
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname , Plantype.. UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;

----------------


	 vbQuery:=
'INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
(source, sn, transnum, seqno, datetimestamp, memid, enrid, relflag, memfirstname, memlastname, gender, dob, addr1, addr2, city, state, zip, homephone, workphone, lvlid1, lvldesc1, lvlid2, lvldesc2, lvlid3, lvldesc3, lvlid4, lvldesc4, lvlid5, lvldesc5, lvlid6, lvldesc6, lvlid7, lvldesc7, lvlid8, lvldesc8, lvlid9, lvldesc9, lvlid10,
lvldesc10, filldate, paiddate, metricquantity, dayssupply, drugcode, drugdesc, drugstrength, formulary_yn, moi, prescriberid, prescribertype, prescribername, pharmid, pharmname, pharmzipcode, paidamt, billedamt, ingredcost, dispensingcost, salestax, allowedamt, enrpaidamt, coinsamt, copayamt, deductamt, notallowedamt, admfees, awp, cobamt, adjcode, siccode, sicdesc, claimstatus, supplyflag,
discountamt, prescount, ssn, rcvmth, srcfilename, udf1, udfm1, udf2, udfm2, udf3, udf4, udf5, udf6, udf7, udf8, udf9, udfc1, udfc2, udfc3, udfc4, udfc5, udfc6, udfc7, udfc8, udfc9, udfc10, udfc11, udfc12, udfc13, udfc14, udfc15, udfc16, udfc17, udfc18, udfc19, udfc20, udfd1, udfd2, udfd3, udfd4, udfd5, udfn1, udfn2, udfn3, udfn4, udfn5, udfn6, udfn7, udfn8, udfn9, udfn10, udfn11, udfn12,
udfn13, udfn14, udfn15, udfn16, udfn17, udfn18, udfn19, udfn20, vh_lvl_id, emp_nbr, medeligcatid, productid, vhpayorid, vhlayoutid, qty_disp, srcrelflag, aifileid,
airownumber, vhpayername, vhgroupname, compoundind, specialtyind, pharmnabpnum, plannumber, planname, plantype, populationtype, enrollment_source) SELECT source, sn, transnum, seqno, datetimestamp, memid, enrid, relflag, memfirstname, memlastname, gender, dob, addr1, addr2, city, state, zip, homephone, workphone, lvlid1, lvldesc1, lvlid2, lvldesc2, lvlid3, lvldesc3, lvlid4, lvldesc4, lvlid5, lvldesc5, lvlid6, lvldesc6, lvlid7, lvldesc7, lvlid8, lvldesc8, lvlid9, lvldesc9, lvlid10,
lvldesc10, filldate, paiddate, metricquantity, dayssupply, drugcode, drugdesc, drugstrength, formulary_yn, moi, prescriberid, prescribertype, prescribername, pharmid, pharmname, pharmzipcode, paidamt, billedamt, ingredcost, dispensingcost, salestax, allowedamt, enrpaidamt, coinsamt, copayamt, deductamt, notallowedamt, admfees, awp, cobamt, adjcode, siccode, sicdesc, claimstatus, supplyflag, discountamt,
prescount, ssn, rcvmth, srcfilename, udf1, udfm1, udf2, udfm2,
udf3, udf4, udf5, udf6, udf7, udf8, udf9, udfc1, udfc2, udfc3, udfc4, udfc5, udfc6, udfc7, udfc8, udfc9, udfc10, udfc11, udfc12, udfc13, udfc14, udfc15, udfc16, udfc17, udfc18, udfc19, udfc20, udfd1, udfd2, udfd3, udfd4, udfd5, udfn1, udfn2, udfn3, udfn4, udfn5, udfn6, udfn7, udfn8, udfn9, udfn10, udfn11, udfn12, udfn13, udfn14, udfn15, udfn16, udfn17, udfn18, udfn19, udfn20, vh_lvl_id, emp_nbr, medeligcatid,
productid, vhpayorid, vhlayoutid, qty_disp, srcrelflag, aifileid,
airownumber, vhpayername, vhgroupname, compoundind, specialtyind, pharmnabpnum, plannumber, planname, plantype, populationtype, enrollment_source FROM VH_RXCLAIMS_'||vLvl.SERIALNO||'_BRCL';
------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('Insert britt clinic into rxclaims',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;

END IF;


--END HERE ICE 192467
---------------------------- ANTHEM OH/RDX------------------------------------------------

------------------------------------------------------RX ANTHEMRDX 2611 STARTS--MI Implementation-----------------------------------------------------------------
IF  vLvl.PAYER='ANTHEMRDX' OR vLvl.PAYER='ANTHEM_OH' THEN

	VBQUERY := 'DROP TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM AS
	SELECT
		SOURCE,
		SEQNO,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		PAIDAMT,
		BILLEDAMT,
		ALLOWEDAMT,
		PRESCOUNT,
		PRODUCTID,
		PLANTYPE,
		PLANNAME
	FROM
		VH_RXCLAIMS
	WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS TABLE CREATE ANTHEMRDX',EMPID,'ANTHEM',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_RX_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	BEGIN
		SP_PYR_2611_RX_ARDX('HI0826001','HI_RX_ANTHEM_'||EMPID||'','RXCLAIMS','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS-COMM ANTHEMRDX',EMPID,'ANTHEM',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_2611_RX_ARDX','','E');
	END;
	COMMIT;
----------------------------------------------------------------------------------------------------------

	vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		SEQNO,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		PAIDAMT,
		BILLEDAMT,
		ALLOWEDAMT,
		PRESCOUNT,
		PRODUCTID,
		PLANTYPE,
		PLANNAME
	)
	SELECT
		a.ROWID AS SRCROWID,
		''ANTHEM_OH'' AS SOURCE,
		CASE
			WHEN grp.ROLLUPID IN (''GTCO'', ''ARTW'',''PRIM'',''SWOO'') THEN ''01''  --ice 266811,
			ELSE a.CLM_NBR
		  END AS SEQNO,
		';
		IF EMPID IN ('WSPI','PRIM','OHIO','COMS','GROT','RLCS') THEN			--ice337498,8136,12926 --ICE-18938
		vbQuery := vbQuery||'NVL(MEM1.MEMID,a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'')||CASE WHEN grp.MEMID_GRP_FLAG = ''Y'' THEN ''-''||nvl(grp.ROLLUPID,a.ACCT_NBR) END) AS MemID,
		';
		ELSIF EMPID IN ('OLSD') THEN			----350132,371234
		vbQuery := vbQuery||'NVL(SW.MEMID,ssn.MBR_SSN|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'')) AS MemID,
		';
	ELSIF EMPID IN ('XAVI','UCFO') THEN-- 15172
	vbQuery := vbQuery||
	'COALESCE(MEM1.MEMID,REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~'')||''-''||nvl(grp.ROLLUPID,a.ACCT_NBR),''MEMBERID'') AS MemID,	--5216
	';
		ELSE
		vbQuery := vbQuery ||
		'
		CASE
			WHEN grp.MEMID_GRP_FLAG = ''Y'' THEN COALESCE(REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~''),''MEMBERID'')||''-''||nvl(grp.ROLLUPID,a.ACCT_NBR)   --ICE283272
			WHEN grp.ROLLUPID = ''OHMH'' THEN a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2)||''-''||''OHMH''  ----ICE 278043
			WHEN a.ACCT_NBR in (''834~004007010'',''00249078'') THEN COALESCE (MEM.MEMID,a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD''))	--271895
			WHEN a.ACCT_NBR IN (''00123728'', ''00172918'', ''00172421'', ''00169440'', ''00070454'',''00171314'',''00249106'',''00246533'',''00173134'')	--275996
				THEN COALESCE(REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~''),''MEMBERID'')
			ELSE a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'')
		  END AS MemID,   --ice 254417
		';
		END IF;
		IF EMPID IN ('WSPI','COMS') THEN   --ICE 8136
		vbQuery := vbQuery||'NVL(MEM1.ENRID,a.SBSCRBR_ID)  AS ENRID,
		';
		ELSIF EMPID IN ('PRIM') THEN
		vbQuery := vbQuery||'NVL(MEM1.ENRID,''EMPLOYEEID-''||nvl(grp.ROLLUPID,a.ACCT_NBR))  AS ENRID,  --330246 ----ice337498
		';
		ELSIF EMPID IN ('OHIO','XAVI','GROT','UCFO') THEN-- 15172
		vbQuery := vbQuery||'NVL(MEM1.ENRID, a.SBSCRBR_ID||''-''||nvl(grp.ROLLUPID,a.ACCT_NBR))  AS ENRID,  --330246 ----ice337498,5216,12926
		';
		ELSIF EMPID IN ('OLSD') THEN			----350132,371234
		vbQuery := vbQuery||'NVL(SW.ENRID,ssn.MBR_SSN) AS ENRID,
		';
		ELSE
		vbQuery := vbQuery ||
		'
		CASE
			WHEN grp.MEMID_GRP_FLAG = ''Y'' THEN a.SBSCRBR_ID||''-''||nvl(grp.ROLLUPID,a.ACCT_NBR)  --ICE283272
			WHEN grp.ROLLUPID = ''OHMH'' THEN a.SBSCRBR_ID||''-''||''OHMH'' ----ICE 278043
			WHEN a.ACCT_NBR in (''834~004007010'',''00249078'') THEN COALESCE (MEM.ENRID,a.SBSCRBR_ID)	--271895
			WHEN grp.ROLLUPID IN (''GTCO'', ''ARTW'') THEN ''EMPLOYEEID''    --ICE259700,266811
			WHEN a.ACCT_NBR IN (''00123728'', ''00172918'', ''00172421'', ''00169440'', ''00070454'',''00171314'',''00249106'',''00246533'') THEN COALESCE(REPLACE(a.SBSCRBR_ID,''~''),''EMPLOYEEID'')	--275996
		  ELSE a.SBSCRBR_ID END AS ENRID,   --ice 254417
		';
		END IF;
		vbQuery := vbQuery ||
		'
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		CASE
			WHEN a.acct_nbr=''00217976'' AND UPPER(a.PKG_NBR)= ''HEALTH 3'' AND To_Number(To_Char(a.RX_FILL_DT,''YYYY''))<=2013 THEN  ''00217976Health32013''
			WHEN a.acct_nbr=''00172431'' AND UPPER(a.PKG_NBR)= ''HEALTH 7'' AND To_Char(a.RX_FILL_DT,''YYYY'')=''2014'' THEN  ''00172431HEALTH72014''   ---ice 266811
			ELSE COALESCE(Sgrp.PLAN_ID,t.ROLLUP_ID ,pl.ROLLUPID)
		  END AS LVLID2,
		CASE
			WHEN a.acct_nbr=''00217976'' AND UPPER(a.PKG_NBR)= ''HEALTH 3'' AND To_Number(To_Char(a.RX_FILL_DT,''YYYY''))<=2013 THEN  ''PPO $750 Deb Opt''
			WHEN a.acct_nbr=''00172431'' AND UPPER(a.PKG_NBR)= ''HEALTH 7'' AND To_Char(a.RX_FILL_DT,''YYYY'')=''2014'' THEN  ''$2500 Embedded LHSA''   ---ice 266811
			ELSE COALESCE(Sgrp.PLAN_DESC,t.ROLLUP_DESC,pl.PLAN_NAME)
		  END AS LVLDESC2,
		nvl(grp.ROLLUPID,a.ACCT_NBR) AS LVLID3,
		nvl(grp.Group_Name,a.ACCT_NBR) AS LVLDESC3,
		Sgrp.ROLLUPID AS LVLID4,
		Sgrp.sub_grp_nm AS LVLDESC4,
		CASE
			WHEN grp.ROLLUPID = ''ARTW'' THEN a.PAID_AMT + a.HRA_AMT
			WHEN a.PAID_AMT IN (99999.99,-99999.99) THEN 0
			ELSE a.PAID_AMT
		  END AS PAIDAMT, -----ICE 271211

		CASE
			WHEN grp.ROLLUPID in (''GTCO'',''ARTW'',''RTCO'',''XAVI'',''COMS'',''COCI'') THEN (Nvl(a.PAID_AMT,0) + Nvl(a.CPAY_AMT,0) + Nvl(a.COINSRN_AMT,0) + Nvl(a.DDCTBL_AMT,0))  ---ICE 4296,8136
			ELSE
			CASE WHEN a.DSPNSG_FEE_AMT IN (99999.99,-99999.99) THEN 0 ELSE a.DSPNSG_FEE_AMT END +
			CASE WHEN a.INGRED_COST_AMT IN (99999.99,-99999.99) THEN 0 ELSE a.INGRED_COST_AMT END +
			CASE WHEN a.SALES_TAX_AMT IN (99999.99,-99999.99) THEN 0 ELSE a.SALES_TAX_AMT END
		  END AS BILLEDAMT,     --ICE#292124,5216

			CASE WHEN a.COINSRN_AMT IN (99999.99,-99999.99)  THEN 0 ELSE a.COINSRN_AMT END +
			CASE WHEN a.CPAY_AMT IN (99999.99,-99999.99)  THEN 0 ELSE  a.CPAY_AMT END +
			CASE WHEN a.DDCTBL_AMT IN (99999.99,-99999.99)  THEN 0 ELSE a.DDCTBL_AMT END +
			CASE WHEN a.PAID_AMT IN (99999.99,-99999.99)  THEN 0 ELSE a.PAID_AMT END
		AS ALLOWEDAMT,

		CASE
			WHEN
        (CASE WHEN a.COINSRN_AMT IN (99999.99,-99999.99)  THEN 0 ELSE a.COINSRN_AMT END +
				CASE WHEN a.CPAY_AMT IN (99999.99,-99999.99)  THEN 0 ELSE  a.CPAY_AMT END +
				CASE WHEN a.DDCTBL_AMT IN (99999.99,-99999.99)  THEN 0 ELSE a.DDCTBL_AMT END +
				CASE WHEN a.PAID_AMT IN (99999.99,-99999.99)  THEN 0 ELSE a.PAID_AMT END
				) > 0 THEN 1
			WHEN
        (CASE WHEN a.COINSRN_AMT IN (99999.99,-99999.99)  THEN 0 ELSE a.COINSRN_AMT END +
				CASE WHEN a.CPAY_AMT IN (99999.99,-99999.99)  THEN 0 ELSE  a.CPAY_AMT END +
				CASE WHEN a.DDCTBL_AMT IN (99999.99,-99999.99)  THEN 0 ELSE a.DDCTBL_AMT END +
				CASE WHEN a.PAID_AMT IN (99999.99,-99999.99)  THEN 0 ELSE a.PAID_AMT END
				) < 0 THEN -1
			ELSE 0
		  END AS PRESCOUNT,
		''1'' AS PRODUCTID,
		COALESCE(t.PLANTYPE, pl.PLAN_TYPE) AS PLANTYPE ,
		CASE
			WHEN a.acct_nbr=''00217976'' AND UPPER(a.PKG_NBR)= ''HEALTH 3'' AND To_Number(To_Char(a.RX_FILL_DT,''YYYY''))<=2013 THEN  ''PPO $750 Deb Opt''
			ELSE COALESCE(t.ROLLUP_DESC,pl.PLAN_NAME)
		  END AS PLANNAME
	FROM
		HI0826001.HI_RX_ANTHEM_'||EMPID||' a

	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.ACCT_NBR = grp.src_code

	LEFT JOIN
		HR_826_ANTHEM_SUBGRP Sgrp
	ON
		a.ACCT_NBR = Sgrp.ACCT_NBR
		AND
		SUBSTR(A.SUBGRP_NBR,-4) = Sgrp.src_code

	LEFT JOIN
		HR_826_ANTHEM_PLAN pl
	ON
		a.ACCT_NBR = pl.ACCT_NBR
		AND
		Case When pl.FLAG= ''Y'' AND A.RX_FILL_DT > TO_DATE(''2018.12.31'',''YYYY.MM.DD'') THEN UPPER(SUBSTR(a.subgrp_nbr,-4))
    when nvl(grp.ROLLUPID,a.ACCT_NBR) = ''RLCS'' THEN UPPER(SUBSTR(a.subgrp_nbr,-4))
    ELSE UPPER(a.PKG_NBR) END = UPPER(pl.src_code) --6088 --ICE7917

	LEFT JOIN
		HR_826_LOA_LVL_ROLLUP t
	ON
		a.ACCT_NBR  = t.groupid
		AND
		UPPER(a.PKG_NBR) = Upper(t.PLANCODE)
		AND
		To_Char(a.RX_FILL_DT,''YYYY'') = To_Char(t.effectivedate, ''YYYY'')

	LEFT JOIN
		zzz_memid_update_anthem1 MEM
	ON
		UPPER(a.MBR_FIRST_NM) = MEM.MEMFIRSTNAME
		AND
		UPPER(a.MBR_LAST_NM) = MEM.MEMLASTNAME
		AND
		Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'') = MEM.GENDER
		AND
		a.MBR_BRTH_DT = MEM.DOB
		AND
		mem.lvlid3 = nvl(grp.ROLLUPID,a.ACCT_NBR)		--271895
	';
	IF EMPID IN ('WSPI','PRIM','OHIO','XAVI','COMS','GROT','UCFO','RLCS') THEN ----ice337498,350132,(,'OLSD')371234,5216,8136,12926 --ICE-18938
		vbQuery := vbQuery||'
	LEFT JOIN
		ZZZ_VH_ELIG_MEMUPD_'||EMPID||' MEM1
	ON
		UPPER(a.MBR_FIRST_NM) = MEM1.MEMFIRSTNAME
		AND
		UPPER(a.MBR_LAST_NM) = MEM1.MEMLASTNAME
		AND
		Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'') = MEM1.GENDER
		AND
		a.MBR_BRTH_DT = MEM1.DOB
		AND 	--271895
		nvl(grp.ROLLUPID,a.ACCT_NBR) = MEM1.LVLID3
	';
	END IF;
	IF EMPID IN ('OLSD') THEN ----350132,371234
	vbQuery := vbQuery||'
	LEFT JOIN
		HR_826_MEMUPD_SWOO SW
	ON
		UPPER(a.MBR_FIRST_NM) = sw.MEMFIRSTNAME
		AND
		UPPER(a.MBR_LAST_NM) = sw.MEMLASTNAME
		AND
		CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END = sw.GENDER
		AND
		a.MBR_BRTH_DT = sw.DOB
		AND
		nvl(grp.ROLLUPID,a.ACCT_NBR) = sw.LVL3ID

	LEFT JOIN
		ZZZ_ELIG_OLSD_SSN ssn
	ON
		a.SBSCRBR_ID =ssn.SBSCRBR_ID
	';
	END IF;
	vbQuery := vbQuery ||
	'
	WHERE NVL(pl.DROP_PLAN,''N'')=''N''			--need confirmation if this filter condition is to be used(If yes then include this logic)
	';


	BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('RXCLAIMS-CSTM ANTHEMRDX',EMPID,'ANTHEM','','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS-CSTM ANTHEMRDX',EMPID,'ANTHEM',SQLCODE,substr(SQLERRM, 1,400),'',0,'RX','','E');
	END;
	COMMIT;
------------------------------------------------------------------------------------------------------------------
	BEGIN
		SP_CDF_TBL_MERGE(USER,'RXCLAIMS-MERGE ANTHEMRDX','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_ARDX');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS-MERGE ANTHEMRDX',EMPID,'ANTHEM',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	END;
	COMMIT;

---------------------------------- Start of Insert of ANTHEMRDX OR dropped data back ---------------------------------------------------------------

	VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
	    SELECT * FROM VH_RXCLAIMS_'||vLvl.SERIALNO||'_ARDX';

	BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('ANTHEMRDX FINAL INSERT',EMPID,'ANTHEM','','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('ANTHEMRDX FINAL INSERT',EMPID,'ANTHEM',SQLCODE,substr(SQLERRM, 1,400),'',0,'RX','','E');
	END;
	COMMIT;
------------------------------------------RX ANTHEMRDX 2611 ends-----MI Implementation-----------------------------

 --------------------------------------------------------------------------------------------------------------------
 --ICE-1794((8 groups added as per ICE-3113, 3114, 3151,4063,4870,7281,9722,10629,10919,10920,10921,10922, 10717, 11626,15285, 15712,15768,ICE-16085, 18616)
IF EmpID IN ('KBCN', 'MDOM', 'WSTR','CIMO', 'SHAW', 'TBCM','MAYF','OMYA','FUYA','FHLB','EAGF','PEVM','CECO','TCRG','ADTL', 'MEDP','ATRM','GRTI','GTEG','00172422','RITT','TRAN','COCI', 'ARTW', 'GTCO', 'MAKN','PRIM','MAKI','KMCC','RTCO','COMS','UCFO','RELA','DNHB') THEN
vbQuery:='MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' d
	USING
	(
       SELECT
                /*+ PARALLEL(f,4) */ b.memid,b.enrid,b.MEMFIRSTNAME, b.MEMLASTNAME, b.GENDER, b.DOB
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ a.memid,a.enrid,a.MEMFIRSTNAME, a.MEMLASTNAME, a.GENDER, a.DOB,TERMDATE,EFFDATE,
                        ROW_NUMBER() OVER (PARTITION BY a.MEMFIRSTNAME, a.MEMLASTNAME, a.GENDER, a.DOB ORDER BY EFFDATE DESC nulls last) rn
        FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  a
        ) b
        WHERE rn=1

	) c
	ON
	(
		d.MEMFIRSTNAME=c.MEMFIRSTNAME AND
		d.MEMLASTNAME=c.MEMLASTNAME AND
		d.GENDER=c.GENDER AND
		d.DOB=c.DOB
	)
	WHEN MATCHED THEN
        UPDATE SET
		d.memid=c.memid,
		d.enrid=c.enrid
        ';
---------------------------------------Memid update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('AnthemRDX RXCLAIMS Memid update from elig',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
END IF;
----------------------------------------------------------------------------------------------------------------
--ICE-14624
-- IF EMPID='RELA' THEN

-- vbQuery:=
-- 'MERGE /*+ PARALLEL(c,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
-- USING
	-- (
        -- SELECT
                -- /*+ PARALLEL(f,4) */ f.MEMID,f.LVLID2, f.LVLDESC2, f.LVLID3, f.LVLID4, f.LVLDESC4, f.FILLDATE
        -- FROM
                -- (SELECT
                        -- /*+ PARALLEL(a,4) */ b.MEMID,b.LVLID2, b.LVLDESC2, b.LVLID3, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.FILLDATE,
                        -- ROW_NUMBER() OVER (PARTITION BY b.MEMID,b.LVLID3,a.FILLDATE ORDER BY b.TERMDATE DESC,b.EFFDATE DESC) rn
        -- FROM
                -- VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        -- INNER JOIN
                -- VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        -- ON
                -- b.MEMID=a.MEMID
        -- AND
				-- a.LVLID3 = b.LVLID3
		-- AND
                -- NVL(a.FILLDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        -- ) f
        -- WHERE rn=1
-- ) d
-- ON
-- (
        -- c.MEMID=d.MEMID
-- AND
        -- NVL(c.FILLDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.FILLDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
-- AND
	-- c.LVLID3 = d.LVLID3
-- )
-- WHEN MATCHED THEN
        -- UPDATE SET
        -- c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
  -- c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
	-- udfc4=''PASS-1 : Updated from VH_ELIGIBILITIES''
-- ';
-- -------------------------------------------------------------------------------------------------------
-- BEGIN EXECUTE IMMEDIATE vbquery;
	-- EXCEPTION WHEN OTHERS THEN
	 -- VHSCRUB.XP_SCRUBSTATUSLOG('PASS1-RXCLAIMS LVL2, LVL4 UPDATE RELA',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
-- END;
-- -------------------------------------------------------------------------------------------------------
-- COMMIT;
-- -------------------------------------------------------------------------------------------------------
-- --PASS-2 : Updated from VH_ELIGIBILITIES
-- vbQuery:=
-- '
-- MERGE /*+ PARALLEL(c,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
-- USING
-- (
        -- SELECT
                -- /*+ PARALLEL(f,4) */ f.MEMID,f.LVLID2, f.LVLDESC2, f.LVLID3, f.LVLID4, f.LVLDESC4
        -- FROM
                -- (SELECT
                        -- /*+ PARALLEL(a,4) */ b.MEMID,b.LVLID2, b.LVLDESC2, b.LVLID3, b.LVLID4, b.LVLDESC4,
                        -- ROW_NUMBER() OVER (PARTITION BY b.LVLID3, b.MEMID ORDER BY b.TERMDATE DESC,b.EFFDATE DESC) rn
        -- FROM
                -- VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        -- INNER JOIN
                -- VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        -- ON
                -- b.MEMID=a.MEMID
        -- AND
				-- a.LVLID3 = b.LVLID3
        -- ) f
        -- WHERE rn=1
-- ) d
-- ON
-- (
        -- c.MEMID=d.MEMID
	-- AND
		-- c.LVLID3 = d.LVLID3
-- )
-- WHEN MATCHED THEN
        -- UPDATE SET
		-- c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
		-- c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
		-- c.udfc10=''PASS-2 : Updated from VH_ELIGIBILITIES''
  -- WHERE c.udfc4 IS NULL
-- ';
-- -------------------------------------------------------------------------------------------------------
-- BEGIN EXECUTE IMMEDIATE vbquery;
-- EXCEPTION WHEN OTHERS THEN
	 -- VHSCRUB.XP_SCRUBSTATUSLOG('PASS1-RXCLAIMS LVL2, LVL4 UPDATE RELA',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
-- END;
-- -------------------------------------------------------------------------------------------------------
-- COMMIT;

-- ELSE

-- BEGIN
	-- UTILITY.PKG_UPDATE.SP_LOA
	-- (
		-- FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
		-- TO_TABLENAME =>	 'VH_RXCLAIMS_'||vLvl.SERIALNO||'',
		-- UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
		-- DELIMITER =>		'-',
		-- UPDATE_PASSES =>	'1-2',
		-- LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
		-- LVL_DESC_YN =>	  'Y',
		-- PASS_1_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3',
		-- PASS_1_UPDATE_CONDITION =>	'[a.source]=''ANTHEM_OH'' and [a.LVLID2] IS NULL',
		-- PASS_2_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3',
		-- PASS_2_UPDATE_CONDITION =>	'[a.source]=''ANTHEM_OH'' and [a.LVLID2] IS NULL',
		-- PASS_3_JOIN_CONDITION =>	NULL,
		-- PASS_3_UPDATE_CONDITION =>	NULL,
		-- PASS_4_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3',
		-- PASS_4_UPDATE_CONDITION =>	'[a.source]=''ANTHEM_OH'' and [a.LVLID2] IS NULL',
		-- BEGIN_END_DTE_YN =>	 'N',
		-- STABLE_FROM_TABLE_YN =>	 'N',
		-- ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
	-- );
	-- END;
-- END IF;
-- --------------------------------------------------------------------------------
-- --- LOA Update(Level 2 and Level 4 Update)

-- IF EmpID='WSTR' THEN
-- vbQuery:='UPDATE VH_RXCLAIMS_'||vLvl.SERIALNO||' a
-- SET
-- a.UDFC4=NULL
    -- ';
-- vbQuery:='MERGE INTO
		-- VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	-- USING
		-- (
		-- SELECT
			-- MemID,
			-- LVLID1,LVLID2,LVLID3,LVLID4,
			-- LVLDESC1,LVLDESC2,LVLDESC3,LVLDESC4,
			-- EffDate,TermDate,FILLDATE
		-- FROM
			-- (
			-- SELECT
				-- b.MemID,
				-- b.LVLID1,b.LVLID2,b.LVLID3,b.LVLID4,b.LVLDESC1,b.LVLDESC2,b.LVLDESC3,b.LVLDESC4,
				-- b.EffDate,b.TermDate,a.FILLDATE,
				-- Row_Number() OVER (PARTITION BY b.MemID,a.FILLDATE ORDER BY b.LVLID1,b.LVLID2,b.LVLID3,b.LVLID4) rn
			-- FROM
				-- VH_RXCLAIMS_'||vLvl.SERIALNO||' a
			-- LEFT JOIN
				-- (
				-- SELECT
					-- MEMID, LVLID1,LVLID2,LVLID3,LVLID4,LVLDESC1,LVLDESC2,LVLDESC3,LVLDESC4,EffDate,TermDate
				-- FROM
					-- VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
				-- GROUP BY
					-- MEMID, LVLID1,LVLID2,LVLID3,LVLID4,LVLDESC1,LVLDESC2,LVLDESC3,LVLDESC4,EffDate,TermDate
				-- ) b
			-- ON
				-- a.MemID = b.MemID
				-- AND
				-- COALESCE(a.FILLDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN COALESCE(b.EffDate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND COALESCE(b.TermDate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        -- AND
        -- a.lvlid3=b.lvlid3
			-- )
			-- WHERE rn=1
		-- ) d
	-- ON
		-- (
		-- c.MemID=d.MemID
		-- AND
		-- c.FILLDATE =   d.FILLDATE
    -- AND
        -- c.lvlid3=d.lvlid3
		-- )
	-- WHEN MATCHED THEN UPDATE SET

		-- c.LVLID2   = d.LVLID2,
		-- c.LVLID4   = d.LVLID4,
		-- c.LVLDESC2 = d.LVLDESC2,
		-- c.LVLDESC4 = d.LVLDESC4,
		-- c.UDFC4 = ''LOA Update : 1st pass : WSTR''
		-- ';

-- --------------------------------------------------------------------------------
-- BEGIN EXECUTE IMMEDIATE vbquery;
		 -- xp_scrubStatusLog ('WSTR RXCLAIMS-LOA UPDATE PASS1',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_ANTHEM_'||EMPID,'Y','I');
	 -- EXCEPTION WHEN OTHERS THEN
		 -- xp_scrubStatusLog ('AnthemRDX RXCLAIMS LOA update from elig Pass1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 -- END;
-- COMMIT;
-- --------------------------------------------------------------------------------
-- --ICE#290815 : LOA PASS 2 FOR WSTR NOT BEING USED
	-- -- vbQuery:='MERGE INTO
		-- -- VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	-- -- USING
		-- -- (
		-- -- SELECT
			-- -- MemID,
			-- -- LVLID1,LVLID2,LVLID3,LVLID4,
			-- -- LVLDESC1,LVLDESC2,LVLDESC3,LVLDESC4
		-- -- FROM
			-- -- (
			-- -- SELECT
				-- -- b.MemID,
				-- -- b.LVLID1,b.LVLID2,b.LVLID3,b.LVLID4,b.LVLDESC1,b.LVLDESC2,b.LVLDESC3,b.LVLDESC4,
				-- -- ROW_NUMBER() OVER (PARTITION BY b.MemID ORDER BY b.MemID,b.LVLID1,b.LVLID2,b.LVLID3,b.LVLID4,b.EFFDATE DESC NULLS LAST) rn
			-- -- FROM
				-- -- VH_RXCLAIMS_'||vLvl.SERIALNO||' a
			-- -- LEFT JOIN
				-- -- (
				-- -- SELECT
					-- -- MEMID, LVLID1,LVLID2,LVLID3,LVLID4,LVLDESC1,LVLDESC2,LVLDESC3,LVLDESC4,EFFDATE
				-- -- FROM
					-- -- VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
					-- -- GROUP BY
					-- -- MEMID, LVLID1,LVLID2,LVLID3,LVLID4,LVLDESC1,LVLDESC2,LVLDESC3,LVLDESC4,EFFDATE
				-- -- ) b
			-- -- ON
				-- -- a.MemID=b.MemID
          -- -- AND
        -- -- a.lvlid3=b.lvlid3

			-- -- )
		-- -- WHERE rn=1
		-- -- ) d
	-- -- ON
		-- -- (
  -- -- c.MemID=d.MemID
  -- -- AND
  -- -- c.lvlid3=d.lvlid3
		-- -- )
	-- -- WHEN MATCHED THEN UPDATE SET

		-- -- c.LVLID2   = d.LVLID2,
		-- -- c.LVLID4   = d.LVLID4,
		-- -- c.LVLDESC2 = d.LVLDESC2,
		-- -- c.LVLDESC4 = d.LVLDESC4,
		-- -- c.UDFC4 = ''LOA Update : 2nd pass : WSTR''
	-- -- WHERE
		-- -- c.UDFC4 IS NULL
	-- -- ';
-- -- -----------------------------------------
-- -- BEGIN EXECUTE IMMEDIATE vbquery;
	 -- -- EXCEPTION WHEN OTHERS THEN
		 -- -- xp_scrubStatusLog ('AnthemRDX RXCLAIMS LOA update from elig',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 -- -- END;
	 -- -- COMMIT;
-- END IF;
--------------------------------------------------------------------------------


	--/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.filldate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.filldate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.filldate ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.ENRID=d.ENRID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
    UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE   c.planname IS NULL';


---------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

		--- LOA Update(Level 2 and Level 4 Update)  --JIRA_15810
		
		vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
		USING
		(
				SELECT
						/*+ PARALLEL(f,4) */ f.MEMID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4, f.EFFDATE, f.TERMDATE, f.filldate
				FROM
						(SELECT
								/*+ PARALLEL(a,4) */ b.MEMID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.filldate,
								ROW_NUMBER() OVER (PARTITION BY b.MEMID, b.LVLID3, a.filldate ORDER BY b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.memid) rn
				FROM
						VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
				INNER JOIN
						VH_RXCLAIMS_'||vLvl.SERIALNO||' a
				ON
						b.MEMID=a.MEMID
				AND
						a.source=''ANTHEM_OH'' and  a.LVLID3 = b.LVLID3
				AND
						NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
				) f
				WHERE rn=1
		) d
		ON
		(
				c.MEMID=d.MEMID
		AND
				NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

		)
		WHEN MATCHED THEN
				UPDATE SET
				c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
				c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
				c.UDFC4=''PASS-1 : Updated from VH_ELIGIBILITIES''
		WHERE c.source=''ANTHEM_OH''';
		---------------------------------------------------------------------
		BEGIN EXECUTE IMMEDIATE vbquery;
				 xp_scrubStatusLog ('RXCLAIMS-LOA UPDATE PASS1',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_ANTHEM_'||EMPID||'','Y','I');
			 EXCEPTION WHEN OTHERS THEN
				 xp_scrubStatusLog ('ANTHEM_OH RXCLAIMS LOA update from elig Pass1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
			 END;
		----------------------------------------------------------------------------------------------
		vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
		USING
		(
				SELECT
						/*+ PARALLEL(f,4) */ f.MEMID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4
				FROM
						(SELECT
								/*+ PARALLEL(a,4) */ b.MEMID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4,
								ROW_NUMBER() OVER (PARTITION BY b.MEMID, b.LVLID3 ORDER BY  b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.memid) rn
				FROM
						 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
				INNER JOIN
						VH_RXCLAIMS_'||vLvl.SERIALNO||' a
				ON
						b.MEMID=a.MEMID
				AND
						a.source=''ANTHEM_OH'' and  a.LVLID3 = b.LVLID3
				) f
				WHERE rn=1
		) d
		ON
		(
				c.MEMID=d.MEMID
		)
		WHEN MATCHED THEN
				UPDATE SET
				c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
				c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
				c.UDFC4=''PASS-2 : Updated from VH_ELIGIBILITIES''
		WHERE c.source=''ANTHEM_OH'' and c.UDFC4 IS NULL  ';
		---------------------------------------------------------------------
		BEGIN EXECUTE IMMEDIATE vbquery;
				 xp_scrubStatusLog ('RXCLAIMS-LOA UPDATE PASS2',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_ANTHEM_'||EMPID||'','Y','I');
			 EXCEPTION WHEN OTHERS THEN
				 xp_scrubStatusLog ('ANTHEM_OH RXCLAIMS LOA update from elig Pass2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
			 END;
		----------------------------------------------------------------------------------------------


		vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
		USING
		(
				SELECT
						/*+ PARALLEL(f,4) */ f.ENRID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4,  f.EFFDATE, f.TERMDATE, f.filldate
				FROM
						(SELECT
								/*+ PARALLEL(a,4) */ b.ENRID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.filldate,
								ROW_NUMBER() OVER (PARTITION BY b.ENRID, b.LVLID3, a.filldate ORDER BY  b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.enrid) rn
				FROM
						 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
				INNER JOIN
						VH_RXCLAIMS_'||vLvl.SERIALNO||' a
				ON
						b.ENRID=a.ENRID
				AND
						a.source=''ANTHEM_OH'' and a.LVLID3 = b.LVLID3
				AND
						NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
				) f
				WHERE rn=1
		) d
		ON
		(
				c.ENRID=d.ENRID
		AND
				NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
		)
		WHEN MATCHED THEN
				UPDATE SET
				c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
				c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
				c.UDFC4=''PASS-3 : Updated from VH_ELIGIBILITIES''
		WHERE c.source=''ANTHEM_OH'' and c.UDFC4 IS NULL ';
		---------------------------------------------------------------------
		BEGIN EXECUTE IMMEDIATE vbquery;
				 xp_scrubStatusLog ('ANTHEM_OH RXCLAIMS-LOA UPDATE PASS3',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_ANTHEM_'||EMPID||'','Y','I');
			 EXCEPTION WHEN OTHERS THEN
				 xp_scrubStatusLog ('ANTHEM_OH RXCLAIMS LOA update from elig Pass3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
			 END;
		----------------------------------------------------------------------------------------------

		vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
		USING
		(
				SELECT
						/*+ PARALLEL(f,4) */ f.ENRID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4
				FROM
						(SELECT
								/*+ PARALLEL(a,4) */ b.ENRID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4,
								ROW_NUMBER() OVER (PARTITION BY b.ENRID, b.LVLID3 ORDER BY  b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.enrid) rn
				FROM
						 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
				INNER JOIN
						VH_RXCLAIMS_'||vLvl.SERIALNO||' a
				ON
						b.ENRID=a.ENRID
				AND
						a.source=''ANTHEM_OH'' and a.LVLID3 = b.LVLID3
				) f
				WHERE rn=1
		) d
		ON
		(
				c.ENRID=d.ENRID
		)
		WHEN MATCHED THEN
				UPDATE SET
				c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
				c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
				c.UDFC4=''PASS-4 : Updated from VH_ELIGIBILITIES''
		WHERE c.source=''ANTHEM_OH'' and c.UDFC4 IS NULL   ';
		---------------------------------------------------------------------
		BEGIN EXECUTE IMMEDIATE vbquery;
				 xp_scrubStatusLog ('RXCLAIMS-LOA UPDATE PASS4',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_ANTHEM_'||EMPID||'','Y','I');
			 EXCEPTION WHEN OTHERS THEN
				 xp_scrubStatusLog ('ANTHEM_OH RXCLAIMS LOA update from elig Pass4',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
		END;
		----------------------------------------------------------
END IF;
----------------ICE#152050 Implementation of RX UHC NCPDP for Joseph Auto Group-------------------------------------
IF  vLvl.PAYER='UHC_NCPDP'  THEN

-----------------------------NEW LAYOUT UHC NCPDP 405 ICE 263115 ---------------------------------------------------

VBQUERY := 'DROP TABLE VH_RX_UHC_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
    EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_RX_UHC_'||vLvl.SERIALNO||'_CSTM AS
							  SELECT
								SOURCE,
                MEMID, --271567
                ENRID, --271567
                LVLID1,
                LVLDesc1,
                LVLID2,
                LVLDesc2,
                LVLID3,
                LVLDesc3,
                MOI,
                udfc19,
								PRODUCTID

						   FROM
								VH_RXCLAIMS
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('RX TABLE CREATE UHC_NCPDP_405',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_RX_UHC_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_RX_UHC_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_CLMS_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_4548_RX_UHC('HI0826001','HI_RX_UHC_NCPDP_405_'||EMPID||'','RXCLAIMS','VH_RX_UHC_'||vLvl.SERIALNO||'_COMM','4');
exception when others then
xp_scrubStatusLog ('RX-COMM UHC_NCPDP_405',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4548_RX_UHC','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_RX_UHC_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
    MEMID, --271567
    ENRID, --271567
    LVLID1,
    LVLDesc1,
    LVLID2,
    LVLDesc2,
    LVLID3,
    LVLDesc3,
    MOI,
    udfc19,
		PRODUCTID

	)
	SELECT /*+ PARALLEL(a,4) */
		 a.ROWID AS SRCROWID,
		 ''UHC_NCPDP'' AS source,
		CASE WHEN grp.ROLLUPID = ''FERN'' THEN
			COALESCE(MEM.MEMID,SubStr(a.CARDHOLDERID,1,9)||Decode(a.PATIENTGENDERCODE,''1'',''M'',''2'',''F'',''U'')||To_Char(a.PATIENTDATEOFBIRTH,''YYYYMMDD''))
		 WHEN grp.memid_grp_flag=''Y'' THEN   ----ice 284513
			COALESCE(CASE WHEN grp.ROLLUPID = ''WOOL'' THEN MEM1.MEMID END,
			';
			IF EMPID IN ('WOOL', 'FIAE', 'PHEC','CHWI','HMLT','HDCO', 'CTIS','DRCO','LSIN') THEN     --ICE 5264,11345 --ICE-14138 --ICE-16119
				vbQuery:=vbQuery||'TWIN.NEW_MEMID,';
			END IF;
			IF EMPID IN ('FIGA') THEN    --ICE 6087
			vbQuery:=vbQuery||'COALESCE(TWIN.NEW_MEMID,MEM3.MEMID,SubStr(a.CARDHOLDERID,1,9)||Decode(a.PATIENTGENDERCODE,''1'',''M'',''2'',''F'',''U'')||To_Char(a.PATIENTDATEOFBIRTH,''YYYYMMDD'')||''-''||nvl(grp.rollupid,SubStr(a.policynumber,-6))),
			';
			END IF;
			vbQuery:=vbQuery||'SubStr(a.CARDHOLDERID,1,9)||Decode(a.PATIENTGENDERCODE,''1'',''M'',''2'',''F'',''U'')||To_Char(a.PATIENTDATEOFBIRTH,''YYYYMMDD'')||''-''||nvl(grp.rollupid,SubStr(a.policynumber,-6)))
	ELSE ';
			IF EMPID IN ('ERNS','MEVS') THEN
	--ICE_134 5643
				vbQuery:=vbQuery||'COALESCE(MEM2.MEMID,SubStr(a.CARDHOLDERID,1,9)||Decode(a.PATIENTGENDERCODE,''1'',''M'',''2'',''F'',''U'')||To_Char(a.PATIENTDATEOFBIRTH,''YYYYMMDD''))';
			ELSE
		vbQuery:=vbQuery||'SubStr(a.CARDHOLDERID,1,9)||Decode(a.PATIENTGENDERCODE,''1'',''M'',''2'',''F'',''U'')||To_Char(a.PATIENTDATEOFBIRTH,''YYYYMMDD'')';
    END IF;
    vbQuery:=vbQuery||'
	END
	AS MemID,
	';
	--ICE_134
	IF EMPID='ERNS' THEN
		vbQuery:=vbQuery||'COALESCE(MEM2.ENRID,SubStr(a.CARDHOLDERID,1,9))AS ENRID,';
	ELSIF EMPID='FIGA' THEN
		vbQuery:=vbQuery||'COALESCE(MEM3.ENRID,SubStr(a.CARDHOLDERID,1,9)||''-''||nvl(grp.rollupid,SubStr(a.policynumber,-6)))AS ENRID,';
	ELSE
    vbQuery:=vbQuery||'
	CASE WHEN grp.ROLLUPID = ''FERN'' THEN
			COALESCE(MEM.ENRID,SubStr(a.CARDHOLDERID,1,9))
		 WHEN grp.memid_grp_flag=''Y'' THEN   ----ice 284513
			COALESCE(CASE WHEN grp.ROLLUPID = ''WOOL'' THEN MEM1.MEMID END, SubStr(a.CARDHOLDERID,1,9)||''-''||nvl(grp.rollupid,SubStr(a.policynumber,-6)))
	ELSE
		SubStr(a.CARDHOLDERID,1,9)
	END
	AS ENRID,   --ICE 271567
	';
    END IF;
    vbQuery:= vbQuery||'
     ''C'' AS LVLID1,
			''Commercial'' AS LVLDesc1,
			NULL AS LVLID2,
			NULL AS LVLDesc2,
			nvl(grp.rollupid,SubStr(a.policynumber,-6)) AS LVLID3,
			nvl(grp.group_name,SubStr(a.policynumber,-6)) AS LVLDesc3,
      CASE WHEN a.PHARMACYDISPENSERTYPE = ''5'' THEN ''M'' ELSE CASE	WHEN Abs(a.DAYSSUPPLY) > 90 THEN ''M'' ELSE ''R'' END END AS MOI,
      ''HI_RX_UHC_NCPDP_405_'||EMPID||''' AS udfc19,
		 ''1'' AS PRODUCTID

		FROM
				HI0826001.HI_RX_UHC_NCPDP_405_'||EMPID||'  a
	LEFT JOIN
    HR_826_GROup grp
	ON
	  grp.SRC_CoDe=substr(a.POLICYNUMBER,-6)
    LEFT JOIN
  ZZZ_MEMID_UPDATE_ANTHEM_UHC MEM
  ON
  UPPER(a.PATIENTFIRSTNAME) = MEM.MEMFIRSTNAME
  AND
  UPPER(a.PATIENTLASTNAME) = MEM.MEMLASTNAME
  AND
  DECODE(a.PATIENTGENDERCODE,''1'',''M'',''2'',''F'',''U'') = MEM.GENDER
  AND
  a.PATIENTDATEOFBIRTH = MEM.DOB
  AND
  nvl(grp.rollupid,SubStr(a.policynumber,-6)) = MEM.LVL3ID  --ICE271567
  LEFT JOIN
  ZZZ_MEMID_UPDATE_ANTHEM_WOOL MEM1  --283275
  ON
  UPPER(a.PATIENTFIRSTNAME) = MEM1.MEMFIRSTNAME
  AND
  UPPER(a.PATIENTLASTNAME) = MEM1.MEMLASTNAME
  AND
  DECODE(a.PATIENTGENDERCODE,''1'',''M'',''2'',''F'',''U'') = MEM1.GENDER
  AND
  a.PATIENTDATEOFBIRTH = MEM1.DOB
  AND
  nvl(grp.rollupid,SubStr(a.policynumber,-6)) = MEM1.LVL3ID
  ';
  IF EMPID IN ('WOOL','FIGA', 'FIAE', 'PHEC','CHWI','HMLT','HDCO', 'CTIS','DRCO','LSIN') THEN     --ICE 5264,ICE-14138 --ICE-16119
  vbQuery := vbQuery || '
  LEFT JOIN
  ZZZ_UHC_'||EMPID||'_TWIN TWIN
  ON
  UPPER(a.PATIENTFIRSTNAME) = TWIN.MEMFIRSTNAME
  AND
  UPPER(a.PATIENTLASTNAME) = TWIN.MEMLASTNAME
  AND
  DECODE(a.PATIENTGENDERCODE,''1'',''M'',''2'',''F'',''U'') = TWIN.GENDER
  AND
  a.PATIENTDATEOFBIRTH = TWIN.DOB
  AND
  nvl(grp.rollupid,SubStr(a.policynumber,-6)) = TWIN.LVL3ID ';
  END IF;
  IF EMPID IN ('ERNS','MEVS') THEN
   --ICE_134
		vbQuery := vbQuery||'
  LEFT JOIN
  ZZZ_VH_ELIG_MEMUPD_'||EMPID||'_UHC MEM2
  ON
  UPPER(a.PATIENTFIRSTNAME) = MEM2.MEMFIRSTNAME
  AND
  UPPER(a.PATIENTLASTNAME) = MEM2.MEMLASTNAME
  AND
  DECODE(a.PATIENTGENDERCODE,''1'',''M'',''2'',''F'',''U'') = MEM2.GENDER
  AND
  a.PATIENTDATEOFBIRTH = MEM2.DOB
  AND
  nvl(grp.rollupid,SubStr(a.policynumber,-6)) = MEM2.LVLID3
  ';
  END IF;
  IF EMPID IN ('FIGA') THEN
		vbQuery := vbQuery||'
LEFT JOIN
		ZZZ_AETNA_ELIG_MEMUPD_FIGA MEM3
	ON
		UPPER(a.PATIENTFIRSTNAME) = MEM3.MEMFIRSTNAME
		AND
		UPPER(a.PATIENTFIRSTNAME)= MEM3.MEMLASTNAME
		AND
		 DECODE(UPPER(a.PATIENTGENDERCODE),''1'',''M'',''2'',''F'',''U'') = UPPER(MEM3.GENDER)
		AND
		a.PATIENTDATEOFBIRTH = MEM3.DOB
		AND
		nvl(grp.rollupid,SubStr(a.policynumber,-6))  = MEM3.LVLID3
		AND
		CASE
			WHEN a.PATIENTRELATIONSHIPCODE = ''1'' THEN ''E''
			WHEN a.PATIENTRELATIONSHIPCODE = ''2'' THEN ''S''
			WHEN a.PATIENTRELATIONSHIPCODE IN (''3'',''4'') THEN ''D''
			ELSE ''U''
		END = MEM3.RELFLAG';
     END IF;

BEGIN EXECUTE IMMEDIATE vbquery;
    xp_scrubStatusLog ('RX',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_UHC_NCPDP_405_'||EMPID,'Y','I');
 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS UHC_NCPDP_405 ERROR',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'RXCLAIMS-MERGE UHC_NCPDP_40','VH_RX_UHC_'||vLvl.SERIALNO||'_COMM','VH_RX_UHC_'||vLvl.SERIALNO||'_CSTM','VH_RX_UHC_'||vLvl.SERIALNO);
exception when others then
xp_scrubStatusLog ('RXCLAIMS-MERGE UHC_NCPDP_40',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

BEGIN EXECUTE IMMEDIATE
'INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' SELECT * FROM  VH_RX_UHC_'||vLvl.SERIALNO;
EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS UHC_NCPDP_40 INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;


COMMIT;

--------------------------------------------------------------------------------------------------------------------

IF EMPID IN ('ARMO', 'BEOR',	'CLGN',	'HOBS',	'INTE',	'JOSE',	'KENT',	'MEVS',	'PLT',	'RUMP',	'WEHI',	'WRGT',	'XENI')
THEN
    vbQuery :=
    'INSERT  INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'
		(
			SN,
			Source,
			transNum,
			SEQNO,
			MemID,
			EnrID,
			RelFlag,
			MemFirstName,
			MemLastName,
			Gender,
			DOB,
			Addr1,
			Addr2,
			City,
			State,
			Zip,
			HomePhone,
			WorkPhone,
			LVLID1,
			LVLDesc1,
			LVLID2,
			LVLDesc2,
			LVLID3,
			LVLDesc3,
			LVLID4,
			LVLDesc4,
			LVLID5,
			LVLDesc5,
			LVLID6,
			LVLDesc6,
			claimStatus,
			fillDate,
			PaidDate,
			metricquantity,
			DaysSupply,
			DrugCode,
			DrugDesc,
			DrugStrength,
			Formulary_YN,
			MOI,
			prescriberid,
			prescribername,
			PHARMID,
			PHARMNAME,
			PaidAmt,
			BilledAmt,
			IngredCost,
			DispensingCost,
			SalesTax,
			ALLOWEDAMT,
			enrPaidAmt,
			CoInsAmt,
			CopayAmt,
			DeductAmt,
			NotAllowedAmt,
			AdmFees,
			AWP,
			COBAmt,
			ADJCODE,
			prescount,
			UDF1,
			UDF2,
			UDF3,
			UDF4,
			UDF5,
			RcvMth,
			SrcFileName,
			VHPAYORID,
			srcrelflag,
			productid
		 )
		 SELECT
			 ROWNUM AS SN,
			 ''UHC_NCPDP'' AS Source,
			a.TRANSACTIONID||CLAIMSEQUENCENUMBER AS ClmNum,
			a.CLAIMSEQUENCENUMBER AS SEQNO,
			SUBSTR(a.CARDHOLDERID,1,9)||DECODE(a.PATIENTGENDERCODE,''1'',''M'',''2'',''F'',''U'')||TO_CHAR(a.PATIENTDATEOFBIRTH,''YYYYMMDD'') AS MemID,
			SUBSTR(a.CARDHOLDERID,1,9) AS EmpID,
			CASE WHEN a.PATIENTRELATIONSHIPCODE = ''1'' THEN ''E'' WHEN a.PATIENTRELATIONSHIPCODE =''2'' THEN ''S'' ELSE ''D'' END AS RelFlag,
			UPPER(a.PATIENTFIRSTNAME) AS MemFirstName,
			UPPER(a.PATIENTLASTNAME) AS MemLastName,
			DECODE(a.PATIENTGENDERCODE,''1'',''M'',''2'',''F'',''U'') AS Gender,
			a.PATIENTDATEOFBIRTH AS DOB,
			a.ADDRESSLINE1 AS Addr1,
			a.ADDRESSLINE2 AS Addr2,
			a.CITY AS City,
			a.STATE AS State,
			SUBSTR(a.ZIPPOSTALCODE,1,5) AS Zip,
			NULL AS HomePhone,
			NULL AS WorkPhone,
			''C'' AS LVLID1,
			''Commercial'' AS LVLDesc1,
			NULL AS LVLID2,
			NULL AS LVLDesc2,
			nvl(grp.rollupid,SubStr(a.policynumber,-6)) AS LVLID3,
			nvl(grp.group_name,SubStr(a.policynumber,-6)) AS LVLDesc3,
			NULL AS LVLID4,
			NULL AS LVLDesc4,
			NULL AS LVLID5,
			NULL AS LVLDesc5,
			NULL AS LVLID6,
			NULL AS LVLDesc6,
			NULL AS CMStatus,
			a.DATEOFSERVICE AS fillDate,
			a.ADJUDICATIONDATE AS PaidDate,
			a.QUANTITYDISPENSED/1000  AS ServiceUnits,
			a.DAYSSUPPLY AS DaysSupply,
			a.PRODUCTSERVICEID AS DrugCode,
			a.PRODUCTSERVICENAME AS DrugDesc,
			a.PRODUCTSTRENGTH  AS DrugStrength,
			CASE WHEN a.FORMULARYSTATUS IN (''I'',''P'',''T'',''Y'') THEN ''Y'' WHEN a.FORMULARYSTATUS IN (''J'',''K'',''Q'',''N'') THEN ''N'' END AS Formulary_YN,
			CASE WHEN a.PHARMACYDISPENSERTYPE = ''5'' THEN ''M'' ELSE CASE	WHEN Abs(a.DAYSSUPPLY) > 90 THEN ''M'' ELSE ''R'' END END AS MOI,
			a.PRESCRIBERID AS PRESCRIBERID,
			a.PRESCRIBERFIRSTNAME || '' '' || a.PRESCRIBERLASTNAME AS PRESCRIBERNAME,
			a.SERVICEPROVIDERID AS PharmID,
			a.PHARMACYNAME AS PharmName,
			a.NETAMOUNTDUE/100 AS PaidAmt,
			a.GROSSAMOUNTDUE/100 AS BilledAmt,
			a.INGREDIENTCOSTPAID/100 AS IngredCost,
			a.DISPENSINGFEEPAID/100 AS DispensingCost,
			a.AMOUNTATTRIBUTEDTOSALESTAX/100 AS SalesTax,
			(a.NETAMOUNTDUE + a.AMOUNTOFCOINSURANCE + a.AMOUNTOFCOPAY + a.AMOUNTPERIODICDEDUCTIBLE)/100 AS AllowedAmt,
			(a.AMOUNTOFCOINSURANCE + a.AMOUNTOFCOPAY + a.AMOUNTPERIODICDEDUCTIBLE )/100 AS EnrPaidAmt,
			a.AMOUNTOFCOINSURANCE/100 AS CoInsAmt,
			a.AMOUNTOFCOPAY/100 AS CopayAmt,
			a.AMOUNTPERIODICDEDUCTIBLE/100 AS DeductAmt,
			a.AMTEXCEEDPERIODICBENEFITMXM/100 AS NotAllowedAmt,
			a.ADMINISTRATIVEFEEAMOUNT/100 AS AdmFees,
			a.AVERAGEWHOLESALEUNITPRICE/100 AS AWP,
			a.COBCARRIERSUBMITAMOUNT/100 AS COBAmt,
			CASE a.ADJUSTMENTTYPE WHEN ''2'' THEN ''R'' ELSE ''P'' END AS ADJCODE,
			CASE
				WHEN a.NETAMOUNTDUE + a.AMOUNTOFCOINSURANCE + a.AMOUNTOFCOPAY + a.AMOUNTPERIODICDEDUCTIBLE > 0 THEN 1
				WHEN a.NETAMOUNTDUE + a.AMOUNTOFCOINSURANCE + a.AMOUNTOFCOPAY + a.AMOUNTPERIODICDEDUCTIBLE = 0 THEN 0
				ELSE -1
			END AS prescount,
			NULL AS UDF1,
			NULL AS UDF2,
			NULL AS UDF3,
			NULL AS UDF4,
			NULL AS UDF5,
			a.RECEIVEDMONTH AS RcvMth,
			a.SOURCEFILENAME AS SrcFileName,
			(SELECT p.PAYORID FROM HR_GLOBAL_PAYORLIST p WHERE TABLENAME=''HI_RX_UHC_411'') AS VHPAYORID,
			CASE WHEN a.PATIENTRELATIONSHIPCODE = ''1'' THEN ''SELF'' WHEN a.PATIENTRELATIONSHIPCODE =''2'' THEN ''SPOUSE'' ELSE ''CHILD'' END AS SRCRELFLAG, -------- Added on Dec 2015 Processing
			''1'' AS PRODUCTID
			FROM
				HI0826001.HI_RX_UHC_NCPDP_'||EMPID||'  a
	LEFT JOIN
    HR_826_GROup grp
	ON
	  grp.SRC_CoDe=substr(a.POLICYNUMBER,-6)';

BEGIN EXECUTE IMMEDIATE vbquery;
	xp_scrubStatusLog ('RX',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_UHC_NCPDP_'||EMPID||'','Y','I');
EXCEPTION WHEN OTHERS THEN
	xp_scrubStatusLog ('RX',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;
COMMIT;

END IF;

--------------------------------------------------------------------------------
--- LOA Update(Level 2 and Level 4 Update)
--------------------------------------------------------------------------------
	BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
		FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
		TO_TABLENAME =>	 'VH_RXCLAIMS_'||vLvl.SERIALNO||'',
		UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
		DELIMITER =>		'-',
		UPDATE_PASSES =>	'1-2-3-4',
		LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
		LVL_DESC_YN =>	  'Y',
		PASS_1_JOIN_CONDITION =>	'[a.source]=''UHC_NCPDP'' and  a.LVLID3 = b.LVLID3',
		PASS_1_UPDATE_CONDITION =>	'[a.source]=''UHC_NCPDP''',
		PASS_2_JOIN_CONDITION =>	'[a.source]=''UHC_NCPDP'' and  a.LVLID3 = b.LVLID3',
		PASS_2_UPDATE_CONDITION =>	'[a.source]=''UHC_NCPDP'' and [a.UDFC4] IS NULL',
		PASS_3_JOIN_CONDITION =>	'[a.source]=''UHC_NCPDP'' and a.LVLID3 = b.LVLID3',
		PASS_3_UPDATE_CONDITION =>	'[a.source]=''UHC_NCPDP'' and [a.UDFC4] IS NULL',
		PASS_4_JOIN_CONDITION =>	'[a.source]=''UHC_NCPDP'' and a.LVLID3 = b.LVLID3',
		PASS_4_UPDATE_CONDITION =>	'[a.source]=''UHC_NCPDP'' and [a.UDFC4] IS NULL',
		BEGIN_END_DTE_YN =>	 'N',
		STABLE_FROM_TABLE_YN =>	 'N',
		ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
	);
	END;
	--/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.filldate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.filldate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.filldate ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.ENRID=d.ENRID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
    UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE   c.planname IS NULL';


---------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

END IF;
------------------------------- ESI-------------------------------------------------------

   IF  vLvl.PAYER='ESI'  THEN
   BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ZZZ_AETNA_MEMID_UPDATE_ESI CASCADE CONSTRAINTS';
  EXCEPTION
    WHEN Others THEN NULL;
  END;


  vbquery:=
  'CREATE TABLE ZZZ_AETNA_MEMID_UPDATE_ESI as
  SELECT * from
	  (SELECT
		MEMFIRSTNAME, MEMLASTNAME,DOB,MEMID, ENRID, GENDER,
		ROW_NUMBER() OVER(PARTITION BY MEMFIRSTNAME, MEMLASTNAME, DOB ORDER BY RCVMTH DESC) RN
  FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||' WHERE SOURCE IN (''UMR'',''AETNA'')) a
	WHERE rn = 1';

 EXECUTE IMMEDIATE vbquery;

	vbquery:='
	INSERT  INTO  VH_RXCLAIMS_'||vLvl.SERIALNO||'
		(
			SN,
			Source,
			SrcFileName,
			transNum,
			SEQNO,
			MemID,
			EnrID,
			RelFlag,
			MemFirstName,
			MemLastName,
			Gender,
			DOB,
			Addr1,
			Addr2,
			City,
			State,
			Zip,
			HomePhone,
			WorkPhone,
			LVLID1,
			LVLDesc1,
			LVLID2,
			LVLDesc2,
			LVLID3,
			LVLDesc3,
			LVLID4,
			LVLDesc4,
			LVLID5,
			LVLDesc5,
			LVLID6,
			LVLDesc6,
			claimStatus,
			fillDate,
			PaidDate,
			metricquantity,
			DaysSupply,
			DrugCode,
			DrugDesc,
			DrugStrength,
			Formulary_YN,
			MOI,
			PHARMID,
			PHARMNAME,
			prescriberid,
			prescribername,
			PaidAmt,
			BilledAmt,
			IngredCost,
			DispensingCost,
			SalesTax,
			ALLOWEDAMT,
			enrPaidAmt,
			CoInsAmt,
			CopayAmt,
			DeductAmt,
			NotAllowedAmt,
			AdmFees,
			DISCOUNTAMT,
			AWP,
			COBAmt,
			ADJCODE,
			prescount,
			UDF1,
			UDF2,
			UDF3,
			UDF4,
			UDF5,
			UDFC1,
			RcvMth,
			SrcRelFlag,
			PlanType,
			PlanName,
			ENROLLMENT_SOURCE,
			PRODUCTID,
			VHPAYORID
		 )
	SELECT
			ROWNUM AS SN,
			''ESI'' AS Source,
			a.SOURCEFILENAME AS SrcFileName,
			a.TRANSACTIONID AS ClmNum,
			a.CLAIMSEQUENCENUMBER as SEQNO,
			x.MEMID AS MemID,
			NVL(X.ENRID, a.clientAccountID) AS EmpID,
			DECODE(a.PATIENTRELATIONSHIPCODE,''1'',''E'',''2'',''S'',''D'') AS RelFlag,
			UPPER(a.PATIENTFIRSTNAME) AS MemFirstName,
			UPPER(a.PATIENTLASTNAME) AS MemLastName,
			DECODE(a.PATIENTGENDER, ''1'', ''M'',''2'',''F'',''U'') AS Gender,
			a.PATIENTDATEOFBIRTH AS DOB,
			a.CARDHOLDERADDRESS1 AS Addr1,
			a.CARDHOLDERADDRESS2 AS Addr2,
			a.CARDHOLDERCITY AS City,
			a.CARDHOLDERSTATE AS State,
			SUBSTR(a.CARDHOLDERZIPCODE,1,5) AS Zip,
			NULL AS HomePhone,
			NULL AS WorkPhone,
			''C'' AS LVL1ID,
			''Commercial'' AS LVL1Desc,
			NULL AS LVL2ID,
			NULL AS LVL2Desc,
			NVL(grp.ROLLUPID,a.CARRIERNUMBER) AS LVL3ID,
			NVL(grp.GROUP_NAME,a.CARRIERNUMBER) AS LVL3Desc,
			NULL AS LVL4ID,
			NULL AS LVL4Desc,
			NULL AS LVL5ID,
			NULL AS LVL5Desc,
            NULL AS LVL6ID,
			NULL AS LVL6Desc,
			NULL AS CMStatus,
			a.DATEOFSERVICE AS ServiceDate,
			a.invoiceDate AS PaidDate,
			a.QUANTITYDISPENSED/1000 AS ServiceUnits,
			a.DAYSSUPPLY AS DaysSupply,
			a.BILLABLEPRODUCTSERVICEID AS DrugCode,
			NULL as DrugDesc,
			a.DRUGSTRENGTH AS DrugStrength,
			a.FORMULARYFLAG AS Formulary_YN,
			CASE WHEN a.DAYSSUPPLY>=35 THEN ''M'' ELSE ''R'' END AS MOI,
			a.SERVICEPROVIDERID AS PharmID,
			a.PHARMACYNAME AS PharmName,
			a.PRESCRIBERID AS DEANo,
			a.PRESCRIBERLASTNAME AS DEAName,
			a.CLIENTAMOUNTDUE/100 AS PaidAmt,
			a.GROSSCOST/100 AS BilledAmt,
			a.INGREDIENTCOST/100 AS IngredCost,
			a.DISPENSINGFEE/100 AS DispensingCost,
			a.TOTALSALESTAX/100 AS SalesTax,
			a.CLIENTAMOUNTDUE/100 + a.PATIENTPAIDAMOUNT/100 AS AllowedAmt,
			a.PATIENTPAIDAMOUNT/100 AS EmpPaidAmt,
			a.COPAYCOINSURANCE/100 - a.COPAYWAIVERAMT/100 AS CoInsAmt,
			a.COPAYWAIVERAMT/100 AS CopayAmt,
			a.DEDUCTIBLE/100 AS DeductAmt,
			a.AMOUNTEXCEEDINGBENEFITMAXIMUM/100 AS NotAllowedAmt,
			a.ADMINISTRATIVEFEEAMOUNT/100 AS AdmFees,
			a.ADDPATIENTDISCOUNT AS DISCOUNTAMT,
			a.AWPUNITPRICE/100000 AS AWP,
			NULL AS COBAmt,
			NULL AS ADJCODE,
			CASE
				WHEN (a.CLIENTAMOUNTDUE/100 + a.PATIENTPAIDAMOUNT/100) >0 THEN 1
				WHEN (a.CLIENTAMOUNTDUE/100 + a.PATIENTPAIDAMOUNT/100) <0 THEN -1
				ELSE 0
			END AS PRESCOUNT,
			a.UDF1 AS UDF1,
			NULL AS UDF2,
			NULL AS UDF3,
			NULL AS UDF4,
			NULL AS UDF5,
			SUBSTR(a.PERSONCODE,-2) as UDFC1,
			a.RECEIVEDMONTH AS RcvMth,
			DECODE(a.PATIENTRELATIONSHIPCODE,''1'',''SELF'',''2'',''SPOUSE'',''3'',''CHILD'',''4'',''OTHER RELATIONSHIP'') AS SrcRelFlag,
			NULL AS PLANTYPE ,
			NULL AS PLANNAME,
			--CASE WHEN grp.ROLLUPID = ''CBEL'' THEN ''ANTHEM''  END  AS ENROLLMENT_SOURCE,
			null AS ENROLLMENT_SOURCE,    ---ICE 243113
			''1'' AS PRODUCTID,
			(SELECT p.PAYORID FROM HR_GLOBAL_PAYORLIST p WHERE TABLENAME=''HI_RX_MEDCOPAL'') AS VHPAYORID
		FROM
			HI0826001.HI_RX_ESI_'||EMPID||'  a
		LEFT JOIN
			HR_826_GROUP grp
		on
			a.CARRIERNUMBER = grp.SRC_CODE
    LEFT JOIN
			ZZZ_AETNA_MEMID_UPDATE_ESI X
		ON
			UPPER(A.PATIENTFIRSTNAME)=X.MEMFIRSTNAME
		AND
			UPPER(A.PATIENTLASTNAME)=X.MEMLASTNAME
		AND
			A.PATIENTDATEOFBIRTH=X.DOB
		AND
			DECODE(a.PATIENTGENDER, ''1'', ''M'',''2'',''F'',''U'')=X.GENDER
		';
	---------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('RX',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RX',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;

--------------------------------------------------------------------------------
--- Checking UnKnown codes in Level 3/Group
--------------------------------------------------------------------------------

  vbquery :=
  'SELECT /*+ parallel(a,4) */ Count(*) FROM VH_RXCLAIMS_'||vLvl.SERIALNO||' a
  WHERE SOURCE=''ESI'' AND LVLID3 IS NULL';

	BEGIN
    EXECUTE IMMEDIATE vbquery INTO vRows;
    IF vRows>0 THEN
      Raise_Application_Error(-20531,'New codes found in Level 3 of ESI.Please check.');
    END  IF;
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('Medco New code check',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;


	-------------------------------------------------------------------------------------------------
	--FOR MEDCO MEMID UPDATE
	-------------------------------------------------------------------------------------------------
	vbQuery:='
		MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' a
		USING
		(
			SELECT memID,enrID,memFirstName,memLastName,gender,dob
			FROM
			(
				SELECT memID,enrID,memFirstName,memLastName,gender,dob,
				Row_Number()over(PARTITION BY memFirstName,memLastName,gender,dob ORDER BY memID)rn
				FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
			)x WHERE rn=1
		)b
		ON
		(
			a.memFirstName = b.memFirstName AND
			a.memLastName = b.memLastName AND
			a.gender = b.gender AND
			a.dob = b.dob
		)
		WHEN MATCHED THEN UPDATE SET
		a.memID=b.memID,a.enrID=b.enrID,
		a.UDFC2=''1st Pass''
		WHERE a.memID IS NULL';
	-------------------------------------------------------------------------------------------------
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('Medco memID Pass1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;

	COMMIT;
	-------------------------------------------------------------------------------------------------
	--FOR MEDCO MEMID UPDATE
	-------------------------------------------------------------------------------------------------
	vbQuery:='
		MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' a
		USING
		(
			SELECT memID,enrID,memFirstName,memLastName,gender,dob
			FROM
			(
				SELECT memID,enrID,memFirstName,memLastName,gender,dob,
				Row_Number()over(PARTITION BY enrID,memFirstName,gender,dob ORDER BY memID)rn
				FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
			)x WHERE rn=1
		)b
		ON
		(
			a.memFirstName = b.memFirstName AND
			a.enrID = b.enrID AND
			a.gender = b.gender AND
			a.dob = b.dob
		)
		WHEN MATCHED THEN UPDATE SET
		a.memID=b.memID,
		a.UDFC2=''2nd Pass''
		WHERE a.memID IS NULL';
	-------------------------------------------------------------------------------------------------
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('Medco memID Pass2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;

	COMMIT;
	-------------------------------------------------------------------------------------------------
	--FOR MEDCO MEMID UPDATE
	-------------------------------------------------------------------------------------------------
	vbQuery:='
		MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' a
		USING
		(
			SELECT memID,enrID,memFirstName,memLastName,gender,dob
			FROM
			(
				SELECT memID,enrID,memFirstName,memLastName,gender,dob,
				Row_Number()over(PARTITION BY enrID,gender,dob ORDER BY memID)rn
				FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'
			)x WHERE rn=1
		)b
		ON
		(
			a.enrID = b.enrID AND
			a.gender = b.gender AND
			a.dob = b.dob
		)
		WHEN MATCHED THEN UPDATE SET
		a.memID=b.memID,
		a.UDFC2=''3rd Pass''
		WHERE a.memID IS NULL';
	-------------------------------------------------------------------------------------------------
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('Medco memID Pass3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;

	COMMIT;
	-------------------------------------------------------------------------------------------------
	--FOR MEDCO MEMID UPDATE
	-------------------------------------------------------------------------------------------------
	vbQuery:='
		UPDATE VH_RXCLAIMS_'||vLvl.SERIALNO||' SET
		memID=enrID||UDFC1,
		UDFC2=''4th Pass''
		WHERE memID IS NULL';
	-------------------------------------------------------------------------------------------------
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('Medco memID Pass4',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;

	COMMIT;

	----------------------------------------------------------------------------

	BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
		FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
		TO_TABLENAME =>	 'VH_RXCLAIMS_'||vLvl.SERIALNO||'',
		UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
		DELIMITER =>		'-',
		UPDATE_PASSES =>	'1-2-4',
		LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
		LVL_DESC_YN =>	  'Y',
		PASS_1_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3 AND [a.source]=''ESI''',
		PASS_1_UPDATE_CONDITION =>	'[a.source]=''ESI''',
		PASS_2_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3 AND [a.source]=''ESI''',
		PASS_2_UPDATE_CONDITION =>	'[a.source]=''ESI'' and [a.LVLID2] IS NULL',
		PASS_3_JOIN_CONDITION =>	NULL,
		PASS_3_UPDATE_CONDITION =>	NULL,
		PASS_4_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3 AND [a.source]=''ESI''',
		PASS_4_UPDATE_CONDITION =>	'[a.source]=''ESI'' and [a.LVLID2] IS NULL',
		BEGIN_END_DTE_YN =>	 'N',
		STABLE_FROM_TABLE_YN =>	 'N',
		ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
	);
	END;

 COMMIT;
 --ice 201530---
vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.lvlid2,f.lvldesc2,f.lvlid4,f.lvldesc4, f.filldate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4, b.EFFDATE, b.TERMDATE, a.filldate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.filldate ORDER BY b.lvlid2,b.lvlid4) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2,
        c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4,
        c.LVLDESC4=d.LVLDESC4
	WHERE  c.LVLID2 IS NULL';
---------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS LVL2 AND LVL4 UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
	 --END --ice 201530---
 --/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.filldate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.filldate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.filldate ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.ENRID=d.ENRID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
    UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE   c.planname IS NULL';


---------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
END IF;
 ------------------------------- UHC-------------------------------------------------------

   IF  vLvl.PAYER='UHC'  THEN

	vbquery:='
	INSERT  INTO  VH_RXCLAIMS_'||vLvl.SERIALNO||'
		(
			SN,
			Source,
			SrcFileName,
			transNum,
			SEQNO,
			MemID,
			EnrID,
			RelFlag,
			MemFirstName,
			MemLastName,
			Gender,
			DOB,
			Addr1,
			Addr2,
			City,
			State,
			Zip,
			HomePhone,
			WorkPhone,
			LVLID1,
			LVLDesc1,
			LVLID2,
			LVLDesc2,
			LVLID3,
			LVLDesc3,
			LVLID4,
			LVLDesc4,
			LVLID5,
			LVLDesc5,
			LVLID6,
			LVLDesc6,
			claimStatus,
			fillDate,
			PaidDate,
			metricquantity,
			DaysSupply,
			DrugCode,
			DrugDesc,
			DrugStrength,
			Formulary_YN,
			MOI,
			PHARMID,
			PHARMNAME,
			prescriberid,
			prescribername,
			PaidAmt,
			BilledAmt,
			IngredCost,
			DispensingCost,
			SalesTax,
			ALLOWEDAMT,
			enrPaidAmt,
			CoInsAmt,
			CopayAmt,
			DeductAmt,
			NotAllowedAmt,
			AdmFees,
			AWP,
			COBAmt,
			ADJCODE,
			prescount,
			UDF1,
			UDF2,
			UDF3,
			UDF4,
			UDF5,
			RcvMth,
			SrcRelFlag,
			PlanType,
			PlanName,
			ENROLLMENT_SOURCE,
			PRODUCTID,
			VHPAYORID
		 )
	SELECT
			 ROWNUM AS SN,
			''UHC'' AS Source,
			a.SOURCEFILENAME AS SrcFileName,
			a.TRANSACTIONID||a.CLAIMSEQUENCENUMBER AS ClmNum,
			a.CLAIMSEQUENCENUMBER as SEQNO,
			COALESCE(SUBSTR(a.CARDHOLDERID,1,9)||DECODE(a.PATIENTGENDERCODE,''1'',''M'',''2'',''F'',''U'')||TO_CHAR(a.PATIENTDATEOFBIRTH,''YYYYMMDD''),''MEMBERID'') AS MemID,
			COALESCE(SUBSTR(a.CARDHOLDERID,1,9),''EMPLOYEEID'')AS EmpID,
			CASE WHEN a.PATIENTRELATIONSHIPCODE = ''1'' THEN ''E'' WHEN a.PATIENTRELATIONSHIPCODE =''2'' THEN ''S'' ELSE ''D'' END AS RelFlag,
			UPPER(a.PATIENTFIRSTNAME) AS MemFirstName,
			UPPER(a.PATIENTLASTNAME) AS MemLastName,
			DECODE(a.PATIENTGENDERCODE,''1'',''M'',''2'',''F'',''U'') AS Gender,
			a.PATIENTDATEOFBIRTH AS DOB,
			a.ADDRESSLINE1 AS Addr1,
			a.ADDRESSLINE2 AS Addr2,
			a.CITY AS City,
			a.STATE AS State,
			SUBSTR(a.ZIPPOSTALCODE,1,5) AS Zip,
			NULL AS HomePhone,
			NULL AS WorkPhone,
			''C'' AS LVL1ID,
			''Commercial'' AS LVL1Desc,
			lv.ROLLUP_PLANID AS LVL2ID,
			lv.ROLLUP_PLANNM  AS LVL2Desc,
			grp.ROLLUPID AS LVL3ID,
			grp.Group_Name AS LVL3Desc,
			lv.ROLLUP_SUB_GRPID AS LVL4ID,
			lv.ROLLUP_SUB_GRPNM AS LVL4Desc,
			NULL AS LVL5ID,
			NULL AS LVL5Desc,
            NULL AS LVL6ID,
			NULL AS LVL6Desc,
			NULL AS CMStatus,
			a.DATEOFSERVICE AS fillDate,
			a.ADJUDICATIONDATE AS PaidDate,
			a.QUANTITYDISPENSED/1000  AS ServiceUnits,
			a.DAYSSUPPLY AS DaysSupply,
			a.PRODUCTSERVICEID AS DrugCode,
			a.PRODUCTSERVICENAME AS DrugDesc,
			a.PRODUCTSTRENGTH  AS DrugStrength,
			CASE WHEN a.FORMULARYSTATUS IN (''I'',''P'',''T'',''Y'') THEN ''Y'' WHEN a.FORMULARYSTATUS IN (''J'',''K'',''Q'',''N'') THEN ''N'' END AS Formulary_YN,
			CASE WHEN a.PHARMACYDISPENSERTYPE = ''5'' THEN ''M'' ELSE CASE WHEN a.DAYSSUPPLY > 35 THEN ''M'' ELSE ''R'' END END AS MOI,
			a.SERVICEPROVIDERID AS PharmID,
			a.PHARMACYNAME AS PharmName,
			a.PRESCRIBERID AS PRESCRIBERID,
			a.PRESCRIBERFIRSTNAME || '' '' || a.PRESCRIBERLASTNAME AS PRESCRIBERNAME,
			a.NETAMOUNTDUE/100 AS PaidAmt,
			a.GROSSAMOUNTDUE/100 AS BilledAmt,
			a.INGREDIENTCOSTPAID/100 AS IngredCost,
			a.DISPENSINGFEEPAID/100 AS DispensingCost,
			a.AMOUNTATTRIBUTEDTOSALESTAX/100 AS SalesTax,
			(a.NETAMOUNTDUE + a.AMOUNTOFCOINSURANCE + a.AMOUNTOFCOPAY + a.AMOUNTPERIODICDEDUCTIBLE)/100 AS AllowedAmt,
			(a.AMOUNTOFCOINSURANCE + a.AMOUNTOFCOPAY + a.AMOUNTPERIODICDEDUCTIBLE )/100 AS EnrPaidAmt,
			a.AMOUNTOFCOINSURANCE/100 AS CoInsAmt,
			a.AMOUNTOFCOPAY/100 AS CopayAmt,
			a.AMOUNTPERIODICDEDUCTIBLE/100 AS DeductAmt,
			a.AMTEXCEEDPERIODICBENEFITMXM/100 AS NotAllowedAmt,
			a.ADMINISTRATIVEFEEAMOUNT/100 AS AdmFees,
			a.AVERAGEWHOLESALEUNITPRICE/100 AS AWP,
			a.COBCARRIERSUBMITAMOUNT/100 AS COBAmt,
			CASE a.ADJUSTMENTTYPE WHEN ''2'' THEN ''R'' ELSE ''P'' END AS ADJCODE,
			CASE
				WHEN a.NETAMOUNTDUE + a.AMOUNTOFCOINSURANCE + a.AMOUNTOFCOPAY + a.AMOUNTPERIODICDEDUCTIBLE > 0 THEN 1
				WHEN a.NETAMOUNTDUE + a.AMOUNTOFCOINSURANCE + a.AMOUNTOFCOPAY + a.AMOUNTPERIODICDEDUCTIBLE = 0 THEN 0
				ELSE -1
			END AS prescount,
			NULL AS UDF1,
			NULL AS UDF2,
			NULL AS UDF3,
			NULL AS UDF4,
			NULL AS UDF5,
			a.RECEIVEDMONTH AS RcvMth,
			(SELECT R.rollup_desc FROM HR_826_REL R WHERE  R.source = ''UHC_RX'' AND R.src_code=a.PATIENTRELATIONSHIPCODE ) SrcRelFlag,
			lv.PLANTYPE AS PLANTYPE ,
			lv.ROLLUP_PLANNM AS PLANNAME,
			--''UHC'' ENROLLMENT_SOURCE,
			NULL AS ENROLLMENT_SOURCE,   ---ICE 243113
			''1'' as PRODUCTID,
			(SELECT p.PAYORID FROM HR_GLOBAL_PAYORLIST p WHERE TABLENAME=''HI_RX_UHC'') AS VHPAYORID
		FROM
			HI0826001.HI_RX_UHC_'||EMPID||'  a
		LEFT JOIN
			HR_826_GROUP grp
		ON
			a.customerstructure1 = grp.src_code
		LEFT JOIN
			HR_826_UHC_LOA lv
		ON
			a.customerstructure1 = lv.SRC_CD1
		AND
			a.customerstructure3 = lv.SRC_CD2
		WHERE NVL(lv.DROP_PLAN,''N'')=''N''		--ICE #169508
		';
	---------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('RX',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RX',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
	---------------------------------------------------------------------------------------------
--/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.filldate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.filldate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.filldate ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.ENRID=d.ENRID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
    UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE   c.planname IS NULL';
---------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------ICE 10670----------------------
--BEGIN
--	UTILITY.PKG_UPDATE.SP_LOA
--	(
--		FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
--		TO_TABLENAME =>	 'VH_RXCLAIMS_'||vLvl.SERIALNO||'',
--		UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
--		DELIMITER =>		'-',
--		UPDATE_PASSES =>	'1-2-3-4',
--		LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
--		LVL_DESC_YN =>	  'Y',
--		PASS_1_JOIN_CONDITION =>	'[a.source]=''UHC'' and  a.LVLID3 = b.LVLID3',
--		PASS_1_UPDATE_CONDITION =>	'[a.source]=''UHC''',
--		PASS_2_JOIN_CONDITION =>	'[a.source]=''UHC'' and  a.LVLID3 = b.LVLID3',
--		PASS_2_UPDATE_CONDITION =>	'[a.source]=''UHC'' and [a.UDFC4] IS NULL',
--		PASS_3_JOIN_CONDITION =>	'[a.source]=''UHC'' and a.LVLID3 = b.LVLID3',
--		PASS_3_UPDATE_CONDITION =>	'[a.source]=''UHC'' and [a.UDFC4] IS NULL',
--		PASS_4_JOIN_CONDITION =>	'[a.source]=''UHC'' and a.LVLID3 = b.LVLID3',
--		PASS_4_UPDATE_CONDITION =>	'[a.source]=''UHC'' and [a.UDFC4] IS NULL',
--		begin_END_DTE_YN =>	 'N',
--		STABLE_FROM_TABLE_YN =>	 'N',
--		ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
--	);
--END;

--------------- LOA Update(Level 2 and Level 4 Update)  ICE-14836

vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.LVLID2, f.LVLDESC2, f.LVLID3, f.LVLID4, f.LVLDESC4,  f.EFFDATE, f.TERMDATE, f.FILLDATE
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID, b.LVLID2, b.LVLDESC2, b.LVLID3, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.FILLDATE,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, b.lvlid3, a.FILLDATE ORDER BY b.EFFDATE DESC NULLS LAST, b.TERMDATE DESC,b.LVLID2,b.LVLID4, b.MEMID) rn
        FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.source=''UHC_NCPDP'' and  a.LVLID3 = b.LVLID3
        AND
                NVL( a.FILLDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        ) f
        WHERE rn=1
) d
ON
(
        c.MEMID=d.MEMID
AND
        NVL(c.FILLDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.FILLDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
and
		c.LVLID3 = d.LVLID3
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-1 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UHC_NCPDP''';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('RXCLAIMS-LOA UPDATE PASS1',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_UHC_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UHC RXCLAIMS LOA update from elig Pass1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------
vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.LVLID2, f.LVLDESC2, f.LVLID3, f.LVLID4, f.LVLDESC4
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID, b.LVLID2, b.LVLDESC2, b.LVLID3, b.LVLID4, b.LVLDESC4,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, b.lvlid3 ORDER BY b.EFFDATE DESC NULLS LAST, b.TERMDATE DESC,b.LVLID2,b.LVLID4, b.MEMID) rn
        FROM
                 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.source=''UHC_NCPDP'' and  a.LVLID3 = b.LVLID3
        ) f
        WHERE rn=1
) d
ON
(
        c.MEMID=d.MEMID
and
		c.LVLID3 = d.LVLID3
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-2 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UHC_NCPDP'' and c.UDFC4 IS NULL  ';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('RXCLAIMS-LOA UPDATE PASS2',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_UHC_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UHC RXCLAIMS LOA update from elig Pass2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------


vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, f.LVLID2, f.LVLDESC2, f.LVLID3, f.LVLID4, f.LVLDESC4, f.EFFDATE, f.TERMDATE, f.FILLDATE
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, b.LVLID2, b.LVLDESC2, b.LVLID3, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.FILLDATE,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID, b.lvlid3, a.FILLDATE ORDER BY b.EFFDATE DESC NULLS LAST, b.TERMDATE DESC,b.LVLID2,b.LVLID4, b.ENRID) rn
        FROM
                 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.source=''UHC_NCPDP'' and a.LVLID3 = b.LVLID3
        AND
                NVL( a.FILLDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        ) f
        WHERE rn=1
) d
ON
(
        c.ENRID=d.ENRID
AND
        NVL(c.FILLDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.FILLDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
and
		c.LVLID3 = d.LVLID3
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-3 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UHC_NCPDP'' and c.UDFC4 IS NULL ';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('RXCLAIMS-LOA UPDATE PASS3',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_UHC_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UHC RXCLAIMS LOA update from elig Pass3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------

vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, f.LVLID2, f.LVLDESC2, f.LVLID3, f.LVLID4, f.LVLDESC4
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, b.LVLID2, b.LVLDESC2, b.LVLID3, b.LVLID4, b.LVLDESC4,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID, b.lvlid3 ORDER BY b.EFFDATE DESC NULLS LAST, b.TERMDATE DESC,b.LVLID2,b.LVLID4, b.ENRID) rn
        FROM
                 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.source=''UHC_NCPDP'' and a.LVLID3 = b.LVLID3
        ) f
        WHERE rn=1
) d
ON
(
        c.ENRID=d.ENRID
and
		a.LVLID3 = b.LVLID3
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-4 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UHC_NCPDP'' and c.UDFC4 IS NULL    ';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('RXCLAIMS-LOA UPDATE PASS4',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_UHC_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UHC RXCLAIMS LOA update from elig Pass4',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------
COMMIT;
END IF;
 ------------------------------- UMR MDS0043 LAYOUT: RXCLAIMS -------------------------------------------------------

   IF  vLvl.PAYER='UMR_BEF'  THEN


 IF EMPID IN ('FRII','HENG', 'DUCH','WSPI','LHY','COFL','CORM','ARST','TPME', 'EMPI') THEN   --- ICE 312761,312760 , 347977,646,3966,5266,6085,8079, 10249
 BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE zzz_elig1_'||vLvl.SERIALNO;
  EXCEPTION
    WHEN Others THEN NULL;
  END;
vbQuery:='CREATE /*+PARALLEL(A,4)*/ TABLE zzz_elig1_'||vLvl.SERIALNO||'
			AS
			SELECT MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3, EFFDATE
			FROM
			(
			 SELECT /*+PARALLEL(A,4)*/  MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3, EFFDATE ,
			 ROW_NUMBER() OVER (PARTITION BY MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3 ORDER BY EFFDATE NULLS LAST, TERMDATE NULLS LAST) RN
			 FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||' A
			 where source=''UMR''
			)
			 WHERE RN=1
			 '
			 ;

BEGIN
	EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('Temp table for MEMID Update to rx UMR_BEF',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_UMR_BEF_'||EMPID,'Y','I');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('Temp table for MEMID Update to rx UMR_BEF',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

END IF;
-------------------------------------------------------------------------------------------------------------------------

-----------------------------------------------------RX UMR_BEF 321 starts--MI Implementation----------------------------------------------
	VBQUERY := 'DROP TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM AS
	SELECT
		SOURCE,
    SEQNO,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		DRUGDESC,
		PLANTYPE,
		PLANNAME,
		PRODUCTID,
		SRCRELFLAG
	FROM
		VH_RXCLAIMS
	WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS TABLE CREATE UMR_BEF',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_RX_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	BEGIN
		SP_PYR_321_RX_UMR('HI0826001','HI_RX_UMR_BEF_'||EMPID||'','RXCLAIMS','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS-COMM UMR_BEF',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_321_RX_UMR','','E');
	END;
	COMMIT;
----------------------------------------------------------------------------------------------------------

	vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
    SEQNO,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		DRUGDESC,
		PLANTYPE,
		PLANNAME,
		PRODUCTID,
		SRCRELFLAG
		)
		SELECT
		a.ROWID AS SRCROWID,
		''UMR'' AS SOURCE,
		''01'' AS SEQNO,
		';
		IF EMPID IN ('FRII','HENG', 'DUCH','COFL','CORM','ARST','TPME', 'EMPI') THEN  --ICE 312761,312760, 347977,5266,6085,8079, 10249
		vbQuery:=vbQuery||'
			CASE WHEN grp.MEMID_GRP_FLAG = ''Y'' THEN
			NVL(ELIG.MEMID,a.EMPE_SSN_NBR||CASE UPPER(a.FMLY_MEMB_SEX_CODE) WHEN ''M'' THEN ''M'' WHEN ''F'' THEN ''F'' ELSE ''U'' END||TO_CHAR(a.CLMT_BIRTH_DATE,''YYYYMMDD'')||''-''||grp.ROLLUPID)
			ELSE
			NVL(ELIG.MEMID,a.EMPE_SSN_NBR||CASE UPPER(a.FMLY_MEMB_SEX_CODE) WHEN ''M'' THEN ''M'' WHEN ''F'' THEN ''F'' ELSE ''U'' END||TO_CHAR(a.CLMT_BIRTH_DATE,''YYYYMMDD'')) END
			AS MEMID,
			CASE WHEN grp.MEMID_GRP_FLAG = ''Y'' THEN
			NVL(ELIG.ENRID,a.EMPE_SSN_NBR||''-''||grp.ROLLUPID) ELSE
			NVL(ELIG.ENRID,a.EMPE_SSN_NBR)   --DEFECT-12477
			END
			AS ENRID,
		';
		ELSIF EMPID in ('WSPI','LHY') THEN	--ICE-646, 3966
		vbQuery:= vbQuery||'
			NVL(ELIG.MEMID,a.EMPE_SSN_NBR||CASE UPPER(a.FMLY_MEMB_SEX_CODE) WHEN ''M'' THEN ''M'' WHEN ''F'' THEN ''F'' ELSE ''U'' END||TO_CHAR(a.CLMT_BIRTH_DATE,''YYYYMMDD'')) AS MEMID,
			NVL(ELIG.ENRID,a.EMPE_SSN_NBR)  AS	ENRID,
		';
		ELSIF EMPID ='ALTM' THEN	--ICE 5770
		vbQuery:= vbQuery||'
			NVL(ELIG1.MEMID,a.EMPE_SSN_NBR||CASE UPPER(a.FMLY_MEMB_SEX_CODE) WHEN ''M'' THEN ''M'' WHEN ''F'' THEN ''F'' ELSE ''U'' END||TO_CHAR(a.CLMT_BIRTH_DATE,''YYYYMMDD'')||''-''||grp.ROLLUPID) AS MEMID,
			NVL(ELIG1.ENRID,a.EMPE_SSN_NBR||''-''||grp.ROLLUPID)  AS	ENRID,
		';
		ELSE
		vbQuery:=vbQuery||'
			CASE WHEN grp.MEMID_GRP_FLAG = ''Y'' THEN
			a.EMPE_SSN_NBR||CASE UPPER(a.FMLY_MEMB_SEX_CODE) WHEN ''M'' THEN ''M'' WHEN ''F'' THEN ''F'' ELSE ''U'' END||TO_CHAR(a.CLMT_BIRTH_DATE,''YYYYMMDD'')||''-''||grp.ROLLUPID
			ELSE
			a.EMPE_SSN_NBR||CASE UPPER(a.FMLY_MEMB_SEX_CODE) WHEN ''M'' THEN ''M'' WHEN ''F'' THEN ''F'' ELSE ''U'' END||TO_CHAR(a.CLMT_BIRTH_DATE,''YYYYMMDD'') END
			AS MEMID,
			CASE WHEN grp.MEMID_GRP_FLAG = ''Y'' THEN
			a.EMPE_SSN_NBR||''-''||grp.ROLLUPID ELSE
			a.EMPE_SSN_NBR
			END
			AS ENRID,
		';
		END IF;
		vbQuery:=vbQuery||'
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		CASE WHEN grp.ROLLUPID = ''ALTM'' THEN Nvl(lvl24.ROLLUP_ID2, a.GROUP_ID_NUMBER||a.STAT_CLASS_CODE)
        ELSE COALESCE(t.ROLLUP_ID, lvl.ROLLUP_CLASS,a.GROUP_ID_NUMBER||a.STAT_CLASS_CODE) END  AS LVLID2,  --ICE 5770	--ICE-16180
        CASE WHEN grp.ROLLUPID = ''ALTM'' THEN Nvl(lvl24.ROLLUP_DESC2, a.GROUP_ID_NUMBER||a.STAT_CLASS_CODE)
        ELSE COALESCE(t.ROLLUP_DESC, lvl.CLASS_DESCRIPTION,a.GROUP_ID_NUMBER||a.STAT_CLASS_CODE) END  AS LVLDESC2,  --ICE 5770	--ICE-16180
		Nvl(grp.ROLLUPID,a.GROUP_ID_NUMBER) AS LVLID3,
		Nvl(grp.GROUP_NAME,a.GROUP_ID_NUMBER) AS LVLDESC3,
		CASE WHEN grp.ROLLUPID = ''ALTM'' THEN Nvl(lvl24.ROLLUP_ID4, a.GROUP_ID_NUMBER||a.STAT_CLASS_CODE)
        ELSE loc.ROLLUP_LOCATION END AS LVLID4,  --ICE 5770
 		CASE WHEN grp.ROLLUPID = ''ALTM'' THEN Nvl(lvl24.ROLLUP_DESC4, a.GROUP_ID_NUMBER||a.STAT_CLASS_CODE)
        ELSE loc.LOCATION_DESCRIPTION END AS LVLDESC4,  --ICE 5770
		a.DRUG_NM AS DRUGDESC,
		COALESCE(t.PLANTYPE ,lvl.PLANTYPE,''PPO'') AS PLANTYPE,
		CASE WHEN grp.ROLLUPID = ''ALTM'' THEN LVL24.ROLLUP_DESC2 ELSE COALESCE(t.ROLLUP_DESC, lvl.CLASS_DESCRIPTION) END AS PLANNAME,  --ICE 5770
		''1'' PRODUCTID,
		NVL(re.ROLLUP_DESC, UPPER(a.DPNT_REL_CODE)) AS SRCRELFLAG
 	FROM
		HI0826001.HI_RX_UMR_BEF_'||EMPID||' a

	LEFT JOIN
		HR_826_REL re
	ON
		UPPER(a.DPNT_REL_CODE) = re.SRC_CODE
		AND
		''UMR'' = re.SOURCE

	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.GROUP_ID_NUMBER = grp.SRC_CODE

	LEFT JOIN
		HR_826_UMR_NEW_LOA lvl
	ON
		a.GROUP_ID_NUMBER = lvl.GROUPID
		AND
		a.policy_id_number = lvl.PLAN_CONTRACT
		AND
		a.STAT_CLASS_CODE = lvl.CLASS

	LEFT JOIN
		HR_826_UMR_NEW_LOC loc
	ON
		a.GROUP_ID_NUMBER = loc.GROUPID
		AND
		a.GRP_LOCATION_CODE = loc.LOCATION

	left JOIN  --ICE 5770
	HR_826_UMR_LVL lvl24
    ON
	a.GROUP_ID_NUMBER = lvl24.SRC_GROUPID
	AND
	a.policy_id_number = lvl24.PLAN_CONTRACT
	AND
	a.STAT_CLASS_CODE = lvl24.CLASS
	LEFT JOIN
		HR_826_LOA_LVL_ROLLUP t
	ON
		a.GROUP_ID_NUMBER  = t.groupid
		AND
		Upper(a.STAT_CLASS_CODE) = Upper(t.PLANCODE)
		AND
		To_Char(a.SERV_RCVD_DT,''YYYY'') = To_Char(t.effectivedate,''YYYY'')
	';
	IF EMPID IN('FRII','HENG', 'DUCH','WSPI','LHY','COFL','CORM','ARST', 'TPME', 'EMPI') THEN  --ICE312761,312760, 347977,646, 3966,5266,6085,8079,10249
	vbQuery:=vbQuery||'
	LEFT JOIN zzz_elig1_'||vLvl.SERIALNO||' ELIG
	ON
		UPPER(a.INDIV_1ST_NAME_TEXT) = ELIG.MEMFIRSTNAME
		AND
		UPPER(a.INDIV_LAST_NAME_TEXT) = ELIG.MEMLASTNAME
		AND
		UPPER(a.FMLY_MEMB_SEX_CODE) = ELIG.GENDER
		AND
		a.CLMT_BIRTH_DATE = ELIG.DOB
		AND
		Nvl(grp.ROLLUPID,a.GROUP_ID_NUMBER)= ELIG.LVLID3
	';
	END IF;
	IF EMPID ='ALTM' THEN  --ICE 5770
	vbQuery:=vbQuery||'
	LEFT JOIN zzz_eligupd_'||vLvl.SERIALNO||' ELIG1
	ON
		ELIG1.UDFC5=a.EMPE_SSN_NBR||CASE UPPER(a.FMLY_MEMB_SEX_CODE) WHEN ''M'' THEN ''M'' WHEN ''F'' THEN ''F'' ELSE ''U'' END||TO_CHAR(a.CLMT_BIRTH_DATE,''YYYYMMDD'')||''-''||grp.ROLLUPID
	';
	END IF;

	BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('RXCLAIMS-CSTM UMR_BEF',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS-CSTM UMR_BEF',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'RX','','E');
	END;
	COMMIT;
------------------------------------------------------------------------------------------------------------------
	BEGIN
		SP_CDF_TBL_MERGE(USER,'RXCLAIMS-MERGE UMR_BEF','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_UMRBEF');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS-MERGE UMR_BEF',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	END;
	COMMIT;
-----------------------------------------------------------------------------------------------------------------------------
----ICE-14077
--BEGIN
--	UTILITY.PKG_UPDATE.SP_LOA
--	(
--		FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
--		TO_TABLENAME =>	 'VH_RXCLAIMS_'||vLvl.SERIALNO||'',
--		UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
--		DELIMITER =>		'-',
--		UPDATE_PASSES =>	'1-2-3-4',
--		LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
--		LVL_DESC_YN =>	  'Y',
--		PASS_1_JOIN_CONDITION =>  '[a.source]=''UMR'' and  a.LVLID3 = b.LVLID3',
--		PASS_1_UPDATE_CONDITION =>	'[a.source]=''UMR''',
--		PASS_2_JOIN_CONDITION =>	'[a.source]=''UMR'' and  a.LVLID3 = b.LVLID3',
--		PASS_2_UPDATE_CONDITION =>	'[a.source]=''UMR'' and [a.UDFC4] IS NULL',
--		PASS_3_JOIN_CONDITION =>	'[a.source]=''UMR'' and a.LVLID3 = b.LVLID3',
--		PASS_3_UPDATE_CONDITION =>	'[a.source]=''UMR'' and [a.UDFC4] IS NULL',
--		PASS_4_JOIN_CONDITION =>	'[a.source]=''UMR'' and a.LVLID3 = b.LVLID3',
--		PASS_4_UPDATE_CONDITION =>	'[a.source]=''UMR'' and [a.UDFC4] IS NULL',
--		BEGIN_END_DTE_YN =>	 'N',
--		STABLE_FROM_TABLE_YN =>	 'N',
--		ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
--	);
--	END;
--	COMMIT;

--------------- LOA Update(Level 2 and Level 4 Update)  JIRA_14529

vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_UMRBEF c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4,  f.EFFDATE, f.TERMDATE, f.FILLDATE
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.FILLDATE,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, b.lvlid3, a.FILLDATE ORDER BY b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.memid) rn
        FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||'_UMRBEF a
        ON
                b.MEMID=a.MEMID
        AND
                a.source=''UMR'' and  a.LVLID3 = b.LVLID3
        AND
                NVL( a.FILLDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        ) f
        WHERE rn=1
) d
ON
(
        c.MEMID=d.MEMID
AND
        NVL(c.FILLDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.FILLDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-1 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UMR''';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('RXCLAIMS-LOA UPDATE PASS1',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_UMR_BEF_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UMR RXCLAIMS LOA update from elig Pass1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------
vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_UMRBEF c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, b.lvlid3 ORDER BY b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.memid) rn
        FROM
                 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||'_UMRBEF a
        ON
                b.MEMID=a.MEMID
        AND
                a.source=''UMR'' and  a.LVLID3 = b.LVLID3
        ) f
        WHERE rn=1
) d
ON
(
        c.MEMID=d.MEMID
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-2 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UMR'' and c.UDFC4 IS NULL  ';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('RXCLAIMS-LOA UPDATE PASS2',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_UMR_BEF_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UMR RXCLAIMS LOA update from elig Pass2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------


vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_UMRBEF c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4, f.EFFDATE, f.TERMDATE, f.FILLDATE
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4, b.EFFDATE, b.TERMDATE, a.FILLDATE,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID, b.lvlid3, a.FILLDATE ORDER BY b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.enrid) rn
        FROM
                 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||'_UMRBEF a
        ON
                b.ENRID=a.ENRID
        AND
                a.source=''UMR'' and a.LVLID3 = b.LVLID3
        AND
                NVL( a.FILLDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        ) f
        WHERE rn=1
) d
ON
(
        c.ENRID=d.ENRID
AND
        NVL(c.FILLDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.FILLDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-3 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UMR'' and c.UDFC4 IS NULL ';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('RXCLAIMS-LOA UPDATE PASS3',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_UMR_BEF_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UMR RXCLAIMS LOA update from elig Pass3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------

vbQuery:= 'MERGE /*+ PARALLEL(c,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_UMRBEF c
USING
(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, f.LVLID2, f.LVLDESC2, f.LVLID4, f.LVLDESC4
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, b.LVLID2, b.LVLDESC2, b.LVLID4, b.LVLDESC4,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID, b.lvlid3 ORDER BY b.effdate desc nulls last, b.termdate desc, b.LVLID2,b.LVLID4,b.enrid) rn
        FROM
                 VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||'_UMRBEF a
        ON
                b.ENRID=a.ENRID
        AND
                a.source=''UMR'' and a.LVLID3 = b.LVLID3
        ) f
        WHERE rn=1
) d
ON
(
        c.ENRID=d.ENRID
)
WHEN MATCHED THEN
        UPDATE SET
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4,
        c.UDFC4=''PASS-4 : Updated from VH_ELIGIBILITIES''
WHERE c.source=''UMR'' and c.UDFC4 IS NULL    ';
---------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('RXCLAIMS-LOA UPDATE PASS4',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_UMR_BEF_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('UMR RXCLAIMS LOA update from elig Pass4',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
----------------------------------------------------------------------------------------------
COMMIT;

---------------------------------- Start of Insert of UMR_BEF OR dropped data back ---------------------------------------------------------------

	VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
	    SELECT * FROM VH_RXCLAIMS_'||vLvl.SERIALNO||'_UMRBEF';

	BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('UMR_BEF FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('UMR_BEF FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'RX','','E');
	END;
	COMMIT;
-------------------------------------------------------------------RX UMR_BEF 321 ends--MI Implementation---------------------------------

--/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.filldate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.filldate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.filldate ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.ENRID=d.ENRID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
    UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE   c.planname IS NULL';


---------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

END IF;
----------------------------------------------------------ICE 6050 (Payer:TrueRX starts)-------------------------------------------------------
   IF  vLvl.PAYER='TRUERX'  THEN
   IF EMPID IN ('CORM') THEN
 BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE zzz_elig2_'||vLvl.SERIALNO;
  EXCEPTION
    WHEN Others THEN NULL;
  END;
vbQuery:='CREATE /*+PARALLEL(A,4)*/ TABLE zzz_elig2_'||vLvl.SERIALNO||'
			AS
			SELECT MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3, EFFDATE
			FROM
			(
			 SELECT /*+PARALLEL(A,4)*/  MEMID, ENRID, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3, EFFDATE ,
			 ROW_NUMBER() OVER (PARTITION BY MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3 ORDER BY EFFDATE NULLS LAST, TERMDATE NULLS LAST) RN
			 FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||' A
			 where source=''UMR''
			)
			 WHERE RN=1
			 '
			 ;

BEGIN
	EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('Temp table for MEMID Update to rx TRUERX',EMPID,'TRUERX','','','HI0826001',SQL%ROWCOUNT,'HI_RX_TRRX_5425','Y','I');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('Temp table for MEMID Update to rx TRUERX',EMPID,'TRUERX',SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;

END IF;
-------------------------------------------------------------------------------------------------------------------------

-----------------------------------------------------RX TRUERX  Implementation----------------------------------------------
	VBQUERY := 'DROP TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTMTRRX PURGE';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTMTRRX AS
	SELECT
		SOURCE,
        MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID3,
		LVLDESC3,
		PRODUCTID
	FROM
		VH_RXCLAIMS
	WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS TABLE CREATE TRUERX',EMPID,'TRUERX',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTMTRRX ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTMTRRX ADD CONSTRAINT PK_CSTMTBL_RX_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	BEGIN
	    SP_PYR_5425_RX_TRRX('HI0826001','HI_RX_TRRX_5425','RXCLAIMS','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMMTRRX','4');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS-COMM TRUERX',EMPID,'TRUERX',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_5425_RX_TRRX','','E');
	END;
	COMMIT;
----------------------------------------------------------------------------------------------------------
vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTMTRRX TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID3,
		LVLDESC3,
		PRODUCTID
		)
	SELECT /*+ PARALLEL(a,4) */
		a.ROWID AS SRCROWID,
		''TRUERX'' AS SOURCE,
		';
		IF EMPID ='CORM' THEN
		vbQuery := vbQuery||'
		NVL(ELIG.MEMID,SUBSTR(a.cardholder_id,1,9) || DECODE(UPPER(a.member_gender),''M'',''M'',''F'',''F'',''U'') || TO_CHAR(a.member_date_of_birth,''YYYYMMDD'')||''-''||grp.ROLLUPID) AS MEMID,
		NVL(ELIG.ENRID,SUBSTR(a.cardholder_id,1,9)||''-''||grp.ROLLUPID) AS ENRID,';
		ELSE
		vbQuery:= vbQuery||'
		SUBSTR(a.cardholder_id,1,9) || DECODE(UPPER(a.member_gender),''M'',''M'',''F'',''F'',''U'') || TO_CHAR(a.member_date_of_birth,''YYYYMMDD'') AS MEMID,
		SUBSTR(a.cardholder_id,1,9) AS ENRID,';
		END IF;
		vbQuery:= vbQuery||'
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		nvl(grp.ROLLUPID, a.Flex_2) AS LVLID3,
		nvl(grp.Group_Name, a.Flex_2) AS LVLDESC3,
		''1'' AS PRODUCTID
		FROM
		HI0826001.HI_RX_TRRX_5425 a
        LEFT JOIN
		HR_826_GROUP GRP
	ON
		a.Flex_2 = grp.src_code
     ';
	IF EMPID IN('CORM') THEN
	vbQuery:=vbQuery||'
	LEFT JOIN zzz_elig2_'||vLvl.SERIALNO||' ELIG
	ON
		Upper(a.MEMBER_FIRST_NAME) = ELIG.MEMFIRSTNAME
		AND
		Upper(a.MEMBER_LAST_NAME)  = ELIG.MEMLASTNAME
		AND
		DECODE(UPPER(a.member_gender),''M'',''M'',''F'',''F'',''U'')  = ELIG.GENDER
		AND
		a.member_date_of_birth = ELIG.DOB
		AND
		nvl(grp.ROLLUPID, a.Flex_2) = ELIG.LVLID3
	';
	END IF;


	BEGIN
		EXECUTE IMMEDIATE vbquery;

		xp_scrubStatusLog ('RXCLAIMS TRUERX CSTM',EMPID,'TRUERX','','','HI0826001',SQL%ROWCOUNT,'HI_RX_TRRX_5425','Y','I');
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS TRUERX CSTM',EMPID,'TRUERX',SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;




------------------------------------------------------------------------------------------------------------------
	BEGIN
		SP_CDF_TBL_MERGE(USER,'RXCLAIMS-MERGE TRUERX','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMMTRRX','VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTMTRRX','VH_RXCLAIMS_'||vLvl.SERIALNO||'_TRUERX');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS-MERGE TRUERX',EMPID,'TRUERX',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	END;
	COMMIT;

--------/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_TRUERX c
	USING
	(
        SELECT /*+ PARALLEL(f,4) */
			f.MEMID,f.lvlid3, f.filldate,f.planname, f.plantype, f.lvlid2,f.lvldesc2,f.lvlid4,f.lvldesc4
        FROM
		(
			SELECT /*+ PARALLEL(a,4) */
				b.MEMID,b.lvlid3, a.filldate,b.planname, b.plantype,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4,b.EFFDATE, b.TERMDATE,
				ROW_NUMBER() OVER (PARTITION BY b.MEMID,b.lvlid3,a.filldate ORDER BY b.planname,b.plantype,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4) rn
			FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  b
			INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||'_TRUERX a
			ON
                b.MEMID=a.MEMID
				AND
			    b.lvlid3=a.lvlid3
				AND
                NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
		AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
		AND
		c.lvlid3=d.lvlid3
    )
	WHEN MATCHED THEN
        UPDATE SET
		c.planname=d.planname,
        c.plantype=d.plantype,
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4

	';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	BEGIN
		EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS Planname,Plantype.. UPDATE PASS 1',EMPID,'TRUERX',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;
	COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_TRUERX c
	USING
	(
        SELECT /*+ PARALLEL(f,4) */
			f.MEMID,f.lvlid3,f.planname, f.plantype, f.lvlid2,f.lvldesc2,f.lvlid4,f.lvldesc4
        FROM
		(
			SELECT /*+ PARALLEL(a,4) */
				b.MEMID,b.lvlid3,b.planname, b.plantype,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4,
				ROW_NUMBER() OVER (PARTITION BY b.MEMID,b.lvlid3 ORDER BY b.planname,b.plantype,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4) rn
			FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  b
			INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||'_TRUERX a
			ON
                b.MEMID=a.MEMID
				AND
			    b.lvlid3=a.lvlid3
		) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
		AND
		c.lvlid3=d.lvlid3
    )
	WHEN MATCHED THEN
        UPDATE SET
		c.planname=d.planname,
        c.plantype=d.plantype,
        c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4
	WHERE c.LVLID2 IS NULL
	';

---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN
		EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS Planname , Plantype.. UPDATE PASS 2',EMPID,'TRUERX',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
--------------------------------------------------------------------------------------------

---------------------------------- Start of Insert of RX TRUERX --------------------------------------------------------------

	VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
          SELECT * FROM VH_RXCLAIMS_'||vLvl.SERIALNO||'_TRUERX';

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('Insert TRUERX group into rxclaims',EMPID,'TRUERX','','','HI0826001',SQL%ROWCOUNT,'HI_RX_TRRX_5425','Y','I');
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('Insert TRUERX group into rxclaims',EMPID,'TRUERX',SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
		END;
	 COMMIT;

END IF;
----------------------------------------------------------ICE 6050 (Payer:TrueRX ends)-------------------------------------------------------


----------------------------ICE 346565: CASTIARX PAYER FRII GROUP START-----------------------------
IF  vLvl.PAYER='CASTIARX' THEN

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ZZZ_ELIG_FRII CASCADE CONSTRAINTS';
  EXCEPTION
    WHEN Others THEN NULL;
 END;


  vbquery:=
  'CREATE TABLE ZZZ_ELIG_FRII as
  SELECT * from
	  (SELECT
		MEMFIRSTNAME, MEMLASTNAME,DOB,MEMID, ENRID, GENDER,LVLID3,
		ROW_NUMBER() OVER(PARTITION BY MEMFIRSTNAME, MEMLASTNAME, DOB,GENDER, LVLID3 ORDER BY TERMDATE DESC NULLS LAST, EFFDATE DESC NULLS LAST) RN
  FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||' WHERE LVLID3=''FRII'') a
	WHERE rn = 1';

 EXECUTE IMMEDIATE vbquery;


VBQUERY := 'DROP TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM AS
							  SELECT
								SOURCE,
								MEMID,
								ENRID,
								LVLID1,
								LVLDESC1,
								LVLID3,
								LVLDESC3,
								PRODUCTID

						   FROM
								VH_RXCLAIMS
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('RXCLAIMS TABLE CREATE CASTIARX FRII',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_CLMS_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_5140_RX_CARX('HI0826001','HI_RXCLAIMS_CARX_061_'||EMPID||'','RXCLAIMS','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','4');
exception when others then
xp_scrubStatusLog ('RX-COMM CASTIARX FRII',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_5140_RX_CARX','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID3,
		LVLDESC3,
		PRODUCTID

	)
	SELECT /*+ PARALLEL(a,4) */
		a.ROWID AS SRCROWID,
		''CASTIARX'' AS source,
		NVL(X.MEMID,a.MEMBERID||Decode(Upper(a.GENDER),''M'',''M'',''F'',''F'',''U'')||To_Char(a.MEMBERDOB,''YYYYMMDD'')||CASE WHEN lvl3.memid_grp_flag=''Y'' THEN ''-''||lvl3.ROLLUPID END) AS MEMID,
		NVL(X.ENRID,a.MEMBERID||CASE WHEN lvl3.memid_grp_flag=''Y'' THEN ''-''||lvl3.ROLLUPID END) AS ENRID,
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		NVL(lvl3.ROLLUPID,a.CUSTOMER_GROUPNO) LVLID3,
		NVL(lvl3.GROUP_NAME,a.CUSTOMER_GROUPNO) AS LVLDESC3,
		''1'' AS PRODUCTID
FROM
	HI0826001.HI_RXCLAIMS_CARX_061_'||EMPID||'  A
LEFT JOIN
	HR_826_GROUP lvl3
ON
	a.CUSTOMER_GROUPNO = LVL3.SRC_CODE
LEFT JOIN
	ZZZ_ELIG_FRII X
ON
	Upper(a.MEMBER_FIRSTNAME)=X.MEMFIRSTNAME
AND
	Upper(a.MEMBER_LASTNAME)=X.MEMLASTNAME
AND
	a.MEMBERDOB=X.DOB
AND
	Decode(Upper(a.GENDER),''M'',''M'',''F'',''F'',''U'')=X.GENDER
AND
	NVL(lvl3.ROLLUPID,a.CUSTOMER_GROUPNO) = x.LVLID3
	'
	 ;
BEGIN EXECUTE IMMEDIATE vbquery;
 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS CASTIARX ERROR',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'RXCLAIMS-MERGE CASTIARX FRII','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_CARX');
exception when others then
xp_scrubStatusLog ('RXCLAIMS-MERGE CASTIARX FRII',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
BEGIN
UTILITY.PKG_UPDATE.SP_LOA
(
	FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
	TO_TABLENAME =>	 'VH_RXCLAIMS_'||vLvl.SERIALNO||'_CARX',
	UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
	DELIMITER =>		'-',
	UPDATE_PASSES =>	'1-2-3-4',
	LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
	LVL_DESC_YN =>	  'Y',
	PASS_1_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3',
	PASS_1_UPDATE_CONDITION =>	'[a.source]=''CASTIARX''',
	PASS_2_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3',
	PASS_2_UPDATE_CONDITION =>	'[a.source]=''CASTIARX''  and [a.LVLID2] IS NULL',
	PASS_3_JOIN_CONDITION =>	NULL,
	PASS_3_UPDATE_CONDITION =>	NULL,
	PASS_4_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3',
	PASS_4_UPDATE_CONDITION =>	'[a.source]=''CASTIARX''  and [a.LVLID2] IS NULL',
	BEGIN_END_DTE_YN =>	 'N',
	STABLE_FROM_TABLE_YN =>	 'N',
	ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
);
END;
COMMIT;

-- --/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CARX c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.filldate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.filldate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.filldate ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||'_CARX a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
		    ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RX Planname and Plantype CASTIARX UPD PASS1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CARX c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||'_CARX a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RX Planname and Plantype CASTIARX UPD PASS1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CARX c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||'_CARX a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3
        ) f
        WHERE rn=1
	) d
	ON
	(
        c.ENRID=d.ENRID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
    UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE   c.planname IS NULL';


---------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RX Planname and Plantype CASTIARX UPD PASS3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	 vbQuery:=
'INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
(source, sn, transnum, seqno, datetimestamp, memid, enrid, relflag, memfirstname, memlastname, gender, dob, addr1, addr2, city, state, zip, homephone, workphone, lvlid1, lvldesc1, lvlid2, lvldesc2, lvlid3, lvldesc3, lvlid4, lvldesc4, lvlid5, lvldesc5, lvlid6, lvldesc6, lvlid7, lvldesc7, lvlid8, lvldesc8, lvlid9, lvldesc9, lvlid10,
lvldesc10, filldate, paiddate, metricquantity, dayssupply, drugcode, drugdesc, drugstrength, formulary_yn, moi, prescriberid, prescribertype, prescribername, pharmid, pharmname, pharmzipcode, paidamt, billedamt, ingredcost, dispensingcost, salestax, allowedamt, enrpaidamt, coinsamt, copayamt, deductamt, notallowedamt, admfees, awp, cobamt, adjcode, siccode, sicdesc, claimstatus, supplyflag,
discountamt, prescount, ssn, rcvmth, srcfilename, udf1, udfm1, udf2, udfm2, udf3, udf4, udf5, udf6, udf7, udf8, udf9, udfc1, udfc2, udfc3, udfc4, udfc5, udfc6, udfc7, udfc8, udfc9, udfc10, udfc11, udfc12, udfc13, udfc14, udfc15, udfc16, udfc17, udfc18, udfc19, udfc20, udfd1, udfd2, udfd3, udfd4, udfd5, udfn1, udfn2, udfn3, udfn4, udfn5, udfn6, udfn7, udfn8, udfn9, udfn10, udfn11, udfn12,
udfn13, udfn14, udfn15, udfn16, udfn17, udfn18, udfn19, udfn20, vh_lvl_id, emp_nbr, medeligcatid, productid, vhpayorid, vhlayoutid, qty_disp, srcrelflag, aifileid,
airownumber, vhpayername, vhgroupname, compoundind, specialtyind, pharmnabpnum, plannumber, planname, plantype, populationtype, enrollment_source) SELECT source, sn, transnum, seqno, datetimestamp, memid, enrid, relflag, memfirstname, memlastname, gender, dob, addr1, addr2, city, state, zip, homephone, workphone, lvlid1, lvldesc1, lvlid2, lvldesc2, lvlid3, lvldesc3, lvlid4, lvldesc4, lvlid5, lvldesc5, lvlid6, lvldesc6, lvlid7, lvldesc7, lvlid8, lvldesc8, lvlid9, lvldesc9, lvlid10,
lvldesc10, filldate, paiddate, metricquantity, dayssupply, drugcode, drugdesc, drugstrength, formulary_yn, moi, prescriberid, prescribertype, prescribername, pharmid, pharmname, pharmzipcode, paidamt, billedamt, ingredcost, dispensingcost, salestax, allowedamt, enrpaidamt, coinsamt, copayamt, deductamt, notallowedamt, admfees, awp, cobamt, adjcode, siccode, sicdesc, claimstatus, supplyflag, discountamt,
prescount, ssn, rcvmth, srcfilename, udf1, udfm1, udf2, udfm2,
udf3, udf4, udf5, udf6, udf7, udf8, udf9, udfc1, udfc2, udfc3, udfc4, udfc5, udfc6, udfc7, udfc8, udfc9, udfc10, udfc11, udfc12, udfc13, udfc14, udfc15, udfc16, udfc17, udfc18, udfc19, udfc20, udfd1, udfd2, udfd3, udfd4, udfd5, udfn1, udfn2, udfn3, udfn4, udfn5, udfn6, udfn7, udfn8, udfn9, udfn10, udfn11, udfn12, udfn13, udfn14, udfn15, udfn16, udfn17, udfn18, udfn19, udfn20, vh_lvl_id, emp_nbr, medeligcatid,
productid, vhpayorid, vhlayoutid, qty_disp, srcrelflag, aifileid,
airownumber, vhpayername, vhgroupname, compoundind, specialtyind, pharmnabpnum, plannumber, planname, plantype, populationtype, enrollment_source FROM VH_RXCLAIMS_'||vLvl.SERIALNO||'_CARX';
------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('Insert CASTIARX into rxclaims',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;

END IF;
----------------------------ICE 346565: CASTIARX PAYER FRII GROUP END-------------------------------

----------------------------------START-276913------------------------------------------
IF  vLvl.PAYER='BAS' THEN

  BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM CASCADE CONSTRAINTS';
  EXCEPTION
    WHEN Others THEN NULL;
  END;


  vbquery:=
  'CREATE TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM as
  SELECT
								SOURCE,
								MEMID,
								ENRID,
								LVLID1,
								LVLDESC1,
								LVLID3,
								LVLDESC3,
		PRODUCTID
		-- ,
		-- PLANTYPE,
		-- PLANNAME
  FROM VH_RXCLAIMS WHERE 1=2';
  EXECUTE IMMEDIATE vbquery;

  EXECUTE IMMEDIATE 'ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
  EXECUTE IMMEDIATE 'ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM PRIMARY KEY (SRCROWID)';

--------------------------------------------------------------------------------
--  Standard Client custom mapping
---------------------------------------------------------------------------------
  SP_PYR_4797_RX_BAS('HI0826001','HI_RX_BAS_'||EMPID||'','RXCLAIMS','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','4');

  vblQueryName:='060_826_'||vLvl.SERIALNO||'_RX_1';
  INSERT INTO VH_QUERYLOG(QueryName,CURTIME) VALUES(vblQueryName,SYSDATE);
  COMMIT;

--------------------------------------------------------------------------------
--  Client custom mapping
---------------------------------------------------------------------------------

  vbquery:=
	'INSERT /*+ APPEND PARALLEL(a,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM a
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID3,
		LVLDESC3,
		PRODUCTID
		-- ,
		-- PLANTYPE,
		-- PLANNAME
	)
	SELECT /*+ PARALLEL(a,4) */
		a.ROWID AS SRCROWID,
		''BAS'' AS SOURCE,
		NVL(B.MEMID,A.SBSCRBR_ID|| DECODE(UPPER(A.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||TO_CHAR(A.MBR_BRTH_DT,''YYYYMMDD'')||''-''||A.MBR_SQNC_NBR||''-''||grp.ROLLUPID) AS MEMID,
		NVL(B.ENRID,SUBSTR(a.SBSCRBR_ID,1,20)||''-''||A.MBR_SQNC_NBR||''-''||grp.ROLLUPID) AS ENRID,
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		Nvl(grp.ROLLUPID,a.ACCT_NBR) AS LVLID3,
		Nvl(grp.GROUP_NAME,a.ACCT_NBR) AS LVLDESC3,
		''1'' AS PRODUCTID
		-- ,
		-- ''HDHP'' AS PLANTYPE,
		-- ''BAS HDHP'' as PLANNAME	--275048 F/U#7.3
 	FROM
	  HI0826001.HI_RX_'||vLvl.PAYER||'_'||EMPID||' a
	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.ACCT_NBR = grp.SRC_CODE
	LEFT JOIN
		zzz_elig_umr_'||vLvl.SERIALNO||' B
	ON
		substr(UPPER(A.MBR_FIRST_NM),1,30) = B.MEMFIRSTNAME
	AND
		UPPER(A.MBR_LAST_NM) = B.MEMLASTNAME
	AND
		DECODE(UPPER(A.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'') = B.GENDER
	AND
		A.MBR_BRTH_DT = B.DOB
	AND 	--323306
		Nvl(grp.ROLLUPID,a.ACCT_NBR) = B.LVLID3

';
BEGIN
EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('RX-CSTM BAS',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('RX-CSTM BAS',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'RX','','E');
 END ;
 COMMIT;

  vblQueryName:='060_826_'||vLvl.SERIALNO||'_RX_2';
  INSERT INTO VH_QUERYLOG(QueryName,CURTIME) VALUES(vblQueryName,SYSDATE);
  COMMIT;

--------------------------------------------------------------------------------
-- Merging Standard and Client custom mapping tables
---------------------------------------------------------------------------------
  vbquery:='Merge Procedure call SP_CDF_TBL_MERGE';
   SP_CDF_TBL_MERGE(USER,'RX','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_BAS');

  vblQueryName:='060_826_'||vLvl.SERIALNO||'_RX_3';
  INSERT INTO VH_QUERYLOG(QueryName,CURTIME) VALUES(vblQueryName,SYSDATE);
  COMMIT;

 ----/*************************************************************************************************/
vbQuery:=
'INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
(source, sn, transnum, seqno, datetimestamp, memid, enrid, relflag, memfirstname, memlastname, gender, dob, addr1, addr2, city, state, zip, homephone, workphone, lvlid1, lvldesc1, lvlid2, lvldesc2, lvlid3, lvldesc3, lvlid4, lvldesc4, lvlid5, lvldesc5, lvlid6, lvldesc6, lvlid7, lvldesc7, lvlid8, lvldesc8, lvlid9, lvldesc9, lvlid10,
lvldesc10, filldate, paiddate, metricquantity, dayssupply, drugcode, drugdesc, drugstrength, formulary_yn, moi, prescriberid, prescribertype, prescribername, pharmid, pharmname, pharmzipcode, paidamt, billedamt, ingredcost, dispensingcost, salestax, allowedamt, enrpaidamt, coinsamt, copayamt, deductamt, notallowedamt, admfees, awp, cobamt, adjcode, siccode, sicdesc, claimstatus, supplyflag,
discountamt, prescount, ssn, rcvmth, srcfilename, udf1, udfm1, udf2, udfm2, udf3, udf4, udf5, udf6, udf7, udf8, udf9, udfc1, udfc2, udfc3, udfc4, udfc5, udfc6, udfc7, udfc8, udfc9, udfc10, udfc11, udfc12, udfc13, udfc14, udfc15, udfc16, udfc17, udfc18, udfc19, udfc20, udfd1, udfd2, udfd3, udfd4, udfd5, udfn1, udfn2, udfn3, udfn4, udfn5, udfn6, udfn7, udfn8, udfn9, udfn10, udfn11, udfn12,
udfn13, udfn14, udfn15, udfn16, udfn17, udfn18, udfn19, udfn20, vh_lvl_id, emp_nbr, medeligcatid, productid, vhpayorid, vhlayoutid, qty_disp, srcrelflag, aifileid,
airownumber, vhpayername, vhgroupname, compoundind, specialtyind, pharmnabpnum, plannumber, planname, plantype, populationtype, enrollment_source)
SELECT source, sn, transnum, seqno, datetimestamp, memid, enrid, relflag, memfirstname, memlastname, gender, dob, addr1, addr2, city, state, zip, homephone, workphone, lvlid1, lvldesc1, lvlid2, lvldesc2, lvlid3, lvldesc3, lvlid4, lvldesc4, lvlid5, lvldesc5, lvlid6, lvldesc6, lvlid7, lvldesc7, lvlid8, lvldesc8, lvlid9, lvldesc9, lvlid10,
lvldesc10, filldate, paiddate, metricquantity, dayssupply, drugcode, drugdesc, drugstrength, formulary_yn, moi, prescriberid, prescribertype, prescribername, pharmid, pharmname, pharmzipcode, paidamt, billedamt, ingredcost, dispensingcost, salestax, allowedamt, enrpaidamt, coinsamt, copayamt, deductamt, notallowedamt, admfees, awp, cobamt, adjcode, siccode, sicdesc, claimstatus, supplyflag, discountamt,
prescount, ssn, rcvmth, srcfilename, udf1, udfm1, udf2, udfm2,
udf3, udf4, udf5, udf6, udf7, udf8, udf9, udfc1, udfc2, udfc3, udfc4, udfc5, udfc6, udfc7, udfc8, udfc9, udfc10, udfc11, udfc12, udfc13, udfc14, udfc15, udfc16, udfc17, udfc18, udfc19, udfc20, udfd1, udfd2, udfd3, udfd4, udfd5, udfn1, udfn2, udfn3, udfn4, udfn5, udfn6, udfn7, udfn8, udfn9, udfn10, udfn11, udfn12, udfn13, udfn14, udfn15, udfn16, udfn17, udfn18, udfn19, udfn20, vh_lvl_id, emp_nbr, medeligcatid,
productid, vhpayorid, vhlayoutid, qty_disp, srcrelflag, aifileid,
airownumber, vhpayername, vhgroupname, compoundind, specialtyind, pharmnabpnum, plannumber, planname, plantype, populationtype, enrollment_source
FROM VH_RXCLAIMS_'||vLvl.SERIALNO||'_BAS';
------------------------------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('BAS RX FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('BAS RX FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'RX','','E');
END;
	 COMMIT;
-----------------------------------------------------------------------------
--ICE-11202
BEGIN
UTILITY.PKG_UPDATE.SP_LOA
(
	FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
	TO_TABLENAME =>	 'VH_RXCLAIMS_'||vLvl.SERIALNO||'',
	UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
	DELIMITER =>		'-',
	UPDATE_PASSES =>	'1-2-3-4',
	LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
	LVL_DESC_YN =>	  'Y',
	PASS_1_JOIN_CONDITION =>	'[a.source]=''BAS'' and  a.LVLID3 = b.LVLID3',
		PASS_1_UPDATE_CONDITION =>	'[a.source]=''BAS''',
		PASS_2_JOIN_CONDITION =>	'[a.source]=''BAS'' and  a.LVLID3 = b.LVLID3',
		PASS_2_UPDATE_CONDITION =>	'[a.source]=''BAS'' and [a.UDFC4] IS NULL',
		PASS_3_JOIN_CONDITION =>	'[a.source]=''BAS'' and a.LVLID3 = b.LVLID3',
		PASS_3_UPDATE_CONDITION =>	'[a.source]=''BAS'' and [a.UDFC4] IS NULL',
		PASS_4_JOIN_CONDITION =>	'[a.source]=''BAS'' and a.LVLID3 = b.LVLID3',
		PASS_4_UPDATE_CONDITION =>	'[a.source]=''BAS'' and [a.UDFC4] IS NULL',
	BEGIN_END_DTE_YN =>	 'N',
	STABLE_FROM_TABLE_YN =>	 'N',
	ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
);
END;
COMMIT;

-- --275046 removed because for one payer only on plan details. Hence can be hardcoded and no need merging to save scrub time
-- --/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.filldate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.filldate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.filldate ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
		WHERE B.source='''||vLvl.PAYER||'''
        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from '||vLvl.PAYER||' VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RX Planname and Plantype BAS UPD PASS1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
		WHERE B.source='''||vLvl.PAYER||'''
        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from '||vLvl.PAYER||' VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RX Planname and Plantype BAS UPD PASS1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3
		WHERE B.source='''||vLvl.PAYER||'''
        ) f
        WHERE rn=1
	) d
	ON
	(
        c.ENRID=d.ENRID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
    UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from '||vLvl.PAYER||' VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE   c.planname IS NULL';


---------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RX Planname and Plantype BAS UPD PASS3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------
END IF;
-------------------------------------------END-276913-------------------------------------------------------------------------------------------------------------
------------------------------- HUMANA-------------------------------------------------------

   IF  vLvl.PAYER='HUMANA'  THEN

   BEGIN
    --EXECUTE IMMEDIATE 'DROP TABLE ZZZ_AETNA_MEMID_UPDATE_HU CASCADE CONSTRAINTS';  ----365360
	EXECUTE IMMEDIATE 'DROP TABLE ZZZ_AETNA_MEMUPD_'||vLvl.SERIALNO||'  CASCADE CONSTRAINTS';
  EXCEPTION
    WHEN Others THEN NULL;
  END;


  vbquery:=
  'CREATE TABLE ZZZ_AETNA_MEMUPD_'||vLvl.SERIALNO||' as
  SELECT * from
	  (SELECT
		MEMFIRSTNAME, MEMLASTNAME,DOB,MEMID, ENRID, GENDER,
		ROW_NUMBER() OVER(PARTITION BY MEMFIRSTNAME, MEMLASTNAME, DOB ORDER BY RCVMTH DESC) RN
  FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||' WHERE SOURCE=''AETNA'') a
	WHERE rn = 1';

 EXECUTE IMMEDIATE vbquery;


	vbquery:='
	INSERT  INTO  VH_RXCLAIMS_'||vLvl.SERIALNO||'
		(
			SN,
			Source,
			SrcFileName,
			transNum,
			SEQNO,
			MemID,
			EnrID,
			RelFlag,
			MemFirstName,
			MemLastName,
			Gender,
			DOB,
			Addr1,
			Addr2,
			City,
			State,
			Zip,
			HomePhone,
			WorkPhone,
			LVLID1,
			LVLDesc1,
			LVLID2,
			LVLDesc2,
			LVLID3,
			LVLDesc3,
			LVLID4,
			LVLDesc4,
			LVLID5,
			LVLDesc5,
			LVLID6,
			LVLDesc6,
			claimStatus,
			fillDate,
			PaidDate,
			metricquantity,
			DaysSupply,
			DrugCode,
			DrugDesc,
			DrugStrength,
			Formulary_YN,
			MOI,
			PHARMID,
			PHARMNAME,
			prescriberid,
			prescribername,
			PaidAmt,
			BilledAmt,
			IngredCost,
			DispensingCost,
			SalesTax,
			ALLOWEDAMT,
			enrPaidAmt,
			CoInsAmt,
			CopayAmt,
			DeductAmt,
			NotAllowedAmt,
			AdmFees,
			AWP,
			COBAmt,
			ADJCODE,
			prescount,
			UDF1,
			UDF2,
			UDF3,
			UDF4,
			UDF5,
			RcvMth,
			SrcRelFlag,
			PlanType,
			PlanName,
			ENROLLMENT_SOURCE,
			PRODUCTID,
			VHPAYORID
		 )
	SELECT
			 ROWNUM AS SN,
			''HUMANA'' AS Source,
			a.SOURCEFILENAME AS SrcFileName,
			a.CLAIM_NBR AS ClmNum,
			''01'' as SEQNO,
			 ';
		    IF EMPID IN ('LPKI','CMHA') THEN
	        vbQuery := vbQuery||'NVL(TWINS.NEW_MEMID,a.SUBS_SSN||a.PATIENT_SEX||TO_CHAR(a.PATIENT_DOB,''YYYYMMDD'')||''-''||nvl(grp.ROLLUPID,a.EMP_GRP_NBR)) AS MemID,
	';
		ELSE
	vbQuery := vbQuery ||
	' CASE WHEN grp.MEMID_GRP_FLAG=''Y''
			THEN
			a.SUBS_SSN||a.PATIENT_SEX||TO_CHAR(a.PATIENT_DOB,''YYYYMMDD'')||''-''||nvl(grp.ROLLUPID,a.EMP_GRP_NBR)
			ELSE NVL(X.MEMID, a.SUBS_SSN||a.PATIENT_SEX||TO_CHAR(a.PATIENT_DOB,''YYYYMMDD'')) END AS MemID,';
         END IF;
		 vbQuery := vbQuery ||
	'CASE WHEN grp.MEMID_GRP_FLAG=''Y''
			THEN a.SUBS_SSN||''-''||nvl(grp.ROLLUPID,a.EMP_GRP_NBR)
			ELSE NVL(X.ENRID,a.SUBS_SSN) END AS EmpID,		--ICE#3054
			CASE WHEN a.PATIENT_REL=''18'' THEN ''E''
         		WHEN a.PATIENT_REL IN (''01'',''25'',''53'') THEN ''S''
         		WHEN a.PATIENT_REL IN (''03'',''05'',''07'',''08'',''14'',''17'',''19'',''22'',''26'',''34'') THEN ''D'' END AS RelFlag,
			UPPER(a.PATIENT_FIRST) AS MemFirstName,
			UPPER(a.PATIENT_LAST) AS MemLastName,
			CASE WHEN a.PATIENT_SEX IN (''F'',''M'') THEN  a.PATIENT_SEX ELSE ''U'' END AS  Gender,
			a.PATIENT_DOB DOB,
			NULL AS Addr1,
			NULL AS Addr2,
			NULL AS City,
			NULL AS State,
			SUBSTR(a.PATIENT_ZIP,1,5) AS Zip,
			NULL AS HomePhone,
			NULL AS WorkPhone,
			''C'' AS LVL1ID,
			''Commercial'' AS LVL1Desc,
			NULL AS LVL2ID,
			NULL AS LVL2Desc,
			nvl(grp.ROLLUPID,a.EMP_GRP_NBR) AS LVL3ID,
			nvl(grp.Group_Name,a.EMP_GRP_NBR) AS LVL3Desc,
			NULL AS LVL4ID,
			NULL AS LVL4Desc,
			NULL AS LVL5ID,
			NULL AS LVL5Desc,
            NULL AS LVL6ID,
			NULL AS LVL6Desc,
			NULL AS CMStatus,
			a.SERVIDATE AS ServiceDate,
			a.PAID_DATE AS PaidDate,
			a.METRIC_QTR AS ServiceUnits,
			a.DAYS_SUPPLY AS DaysSupply,
			a.NDC AS DrugCode,
			a.DRUG_NAME as DrugDesc,
			NULL AS DrugStrngth,
			Decode(a.FORMULARY_IND,''F'',''Y'',''N'',''N'') AS Formulary_YN,
			Decode(a.MAIL_ORD_IND,''Y'',''M'',''R'') AS MOI,
			NULL AS PharmID,
			NULL AS PharmName,
			Nvl(a.ORDERING_PHYS_NPI_ID,a.ORDERING_DEA_ID)  AS DEANo,
			SUBSTR((SELECT d.ProviderName FROM zzz_NPI d WHERE Nvl(a.ORDERING_PHYS_NPI_ID,a.ORDERING_DEA_ID)=d.NPI),1,50) AS DEAName,
			a.PAID_AMT AS PAIDAMT,
			a.CHARGE_AMT AS BILLEDAMT,
			a.INGREDIANT_COST AS INGREDCOST,
			a.DISPENSING_FEE AS DISPENSINGCOST,
			a.SALES_TAX AS SALESTAX,
			a.PAID_AMT + a.MBR_RESP_AMT AS ALLOWEDAMT,
			a.MBR_RESP_AMT AS ENRPAIDAMT,
			a.COINSURANCE AS COINSAMT,
			a.COPAY_AMT AS COPAYAMT,
			a.DEDUCTIBLE_AMT AS DEDUCTAMT,
			NULL AS NOTALLOWEDAMT,
			NULL AS ADMFEES,
			NULL AS AWP,
			a.COB_AMT AS COBAMT,
			NULL AS ADJCODE,
			CASE
				WHEN a.PAID_AMT + a.MBR_RESP_AMT <0 THEN -1
				WHEN a.PAID_AMT + a.MBR_RESP_AMT >0 THEN 1
				ELSE 0
			END AS PRESCOUNT,
			a.UDF1 AS UDF1,
			NULL AS UDF2,
			NULL AS UDF3,
			NULL AS UDF4,
			NULL AS UDF5,
			a.RECEIVEDMONTH AS RcvMth,
			(SELECT R.rollup_desc FROM HR_826_REL R WHERE  R.source = ''HUMANA'' AND R.src_code=a.PATIENT_REL ) SrcRelFlag,
			NULL AS PLANTYPE ,
			NULL AS PLANNAME,
			--''HUMANA'' ENROLLMENT_SOURCE,
			NULL AS ENROLLMENT_SOURCE, ---ICE 243113
			''1'' as PRODUCTID,
--			NULL BENCOVTYPEDESC,
			(SELECT p.PAYORID FROM HR_GLOBAL_PAYORLIST p WHERE TABLENAME=''HI_RX_HUMANA'') AS VHPAYORID

		FROM
			HI0826001.HI_RX_HUMANA_'||EMPID||'  a
		LEFT JOIN
			HR_826_GROUP grp
		ON
			a.EMP_GRP_NBR = grp.src_code
    LEFT JOIN
			ZZZ_AETNA_MEMUPD_'||vLvl.SERIALNO||' X
		ON
			UPPER(A.PATIENT_FIRST)=X.MEMFIRSTNAME
		AND
			UPPER(A.PATIENT_LAST)=X.MEMLASTNAME
		AND
			A.PATIENT_DOB=X.DOB
		AND
			CASE WHEN a.PATIENT_SEX IN (''F'',''M'') THEN  a.PATIENT_SEX ELSE ''U'' END=X.GENDER';
	IF EMPID IN ('LPKI','CMHA') THEN
		vbQuery := vbQuery||'
		LEFT JOIN ZZZ_ELIG_HM_TWINS_'||vLvl.SERIALNO||' TWINS
	ON
		a.SUBS_SSN||''-''||nvl(grp.ROLLUPID,a.EMP_GRP_NBR) =TWINS.ENRID
	AND
		CASE WHEN a.PATIENT_SEX IN (''F'',''M'') THEN  a.PATIENT_SEX ELSE ''U'' END  =TWINS.GENDER
	AND
		a.PATIENT_DOB =TWINS.DOB
	AND
		nvl(grp.ROLLUPID,a.EMP_GRP_NBR)= TWINS.LVLID3
AND
	UPPER(a.PATIENT_FIRST)= TWINS.MEMFIRSTNAME
	AND
	UPPER(a.PATIENT_LAST)= TWINS.MEMLASTNAME
		';
		END IF;
	---------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('RX',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RX',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
     --ICE-12104
	 vbQuery:='MERGE /*+ PARALLEL(a,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
	USING
	(
		SELECT MemFirstName,MemLastName,Gender,DOB,MemID,EnrID,lvlid3
		FROM
		(
			SELECT
				MemFirstName,MemLastName,Gender,DOB,MemID,EnrID,lvlid3,
				ROW_NUMBER() OVER(PARTITION BY MemFirstName,MemLastName,Gender,DOB,lvlid3 ORDER BY EFFDATE DESC NULLS LAST, TERMDATE DESC) rn
			FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||' where source<>''OUR HEALTH''  --ICE-13206
		)x WHERE rn=1
	)b
	ON
	(
		a.MemFirstName = b.MemFirstName AND
		a.MemLastName = b.MemLastName AND
		a.Gender = b.Gender AND
		a.DOB = b.DOB AND
    a.lvlid3=b.lvlid3
	)
	WHEN MATCHED THEN UPDATE
	SET a.MemID=b.MemID, a.EnrID = b.EnrID, UDFC3=''MemID Update''
	WHERE a.MemID<>b.MemID AND a.source=''HUMANA''';

BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('Memid update Humana from elig to rxclaims',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;

--ICE-12652
	BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
		FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
		TO_TABLENAME =>	 'VH_RXCLAIMS_'||vLvl.SERIALNO||'',
		UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
		DELIMITER =>		'-',
		UPDATE_PASSES =>	'1-2-3-4',
		LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
		LVL_DESC_YN =>	  'Y',
		PASS_1_JOIN_CONDITION =>  '[a.source]=''HUMANA'' and  a.LVLID3 = b.LVLID3',
		PASS_1_UPDATE_CONDITION =>	'[a.source]=''HUMANA''',
		PASS_2_JOIN_CONDITION =>	'[a.source]=''HUMANA'' and  a.LVLID3 = b.LVLID3',
		PASS_2_UPDATE_CONDITION =>	'[a.source]=''HUMANA'' and [a.UDFC4] IS NULL',
		PASS_3_JOIN_CONDITION =>	'[a.source]=''HUMANA'' and a.LVLID3 = b.LVLID3',
		PASS_3_UPDATE_CONDITION =>	'[a.source]=''HUMANA'' and [a.UDFC4] IS NULL',
		PASS_4_JOIN_CONDITION =>	'[a.source]=''HUMANA'' and a.LVLID3 = b.LVLID3',
		PASS_4_UPDATE_CONDITION =>	'[a.source]=''HUMANA'' and [a.UDFC4] IS NULL',
		BEGIN_END_DTE_YN =>	 'N',
		STABLE_FROM_TABLE_YN =>	 'N',
		ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
	);
	END;
	COMMIT;

	--/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.filldate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.filldate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.filldate ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.ENRID=d.ENRID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
    UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE   c.planname IS NULL';


---------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

END IF;
-----------------------------------------------------------
----------------------------------------------------------------------------ice 5214 start rxclaims bcbsil----------------------------------------------
IF  vLvl.PAYER='BCBSIL' THEN

VBQUERY := 'DROP TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM AS
	    SELECT
		    SOURCE,
		    MEMID,
		    ENRID,
		    LVLID1,
		    LVLDESC1,
		    LVLID3,
		    LVLDESC3,
			SRCRELFLAG,
			PRODUCTID
		FROM
		    VH_CLAIMS
		 WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
    xp_scrubStatusLog ('RXCLAIMS TABLE CREATE BCBSIL',EMPID,'BCBSIL',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	BEGIN
		SP_PYR_209_RX_BCIL('HI0826001','HI_CLAIMS_BCBSIL_'||EMPID||'','RXCLAIMS','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS-COMM BCBSIL',EMPID,'BCBSIL',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_209_RX_BCIL','','E');
	END;
	COMMIT;
vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID3,
		LVLDESC3,
		SRCRELFLAG,
		PRODUCTID
	)
	SELECT
		a.ROWID AS SRCROWID,
		''BCBSIL'' AS SOURCE,
		CASE WHEN grp.ROLLUPID = ''CECO'' THEN NVL(UPD.MEMID,COALESCE(SubStr(A.subscriber_id,-9) || Decode(Upper(a.patient_gender),''M'',''M'',''F'',''F'',''U'') || TO_CHAR(A.patient_dob,''YYYYMMDD''),''MEMBERID'')  )
		ELSE
		COALESCE(SubStr(A.subscriber_id,-9) || Decode(Upper(a.patient_gender),''M'',''M'',''F'',''F'',''U'') || TO_CHAR(A.patient_dob,''YYYYMMDD''),''MEMBERID'')||''-''||grp.ROLLUPID END AS MEMID,
		CASE WHEN grp.ROLLUPID = ''CECO'' THEN NVL(UPD.ENRID,COALESCE(SubStr(A.subscriber_id,-9),''EMPLOYEEID'')) ELSE  COALESCE(SubStr(A.subscriber_id,-9),''EMPLOYEEID'')||''-''||grp.ROLLUPID END AS ENRID,
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		NVL(GRP.rollupid,a.account_number) AS LVLID3,
		NVL(GRP.group_name,a.account_number) AS LVL3DESC,
		NVL(rel.ROLLUPRELDESC , a.PATIENT_RELATIONSHIP) AS SRCRELFLAG,
		''1'' AS PRODUCTID
	FROM
		HI0826001.HI_CLAIMS_BCBSIL_'||EMPID||' a

	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.account_number = grp.src_code
		LEFT JOIN
		HR_826_SRCREL_BCIL rel
	ON
		UPPER(a.PATIENT_RELATIONSHIP) = rel.SRCRELCODE
	';
	IF EMPID IN ('CECO') THEN
	vbQuery := vbQuery||'
	LEFT JOIN
		ZZZ_E2C_E2R_MEMUPD_'||EMPID||' UPD
	ON
		UPPER(a.PATIENT_FIRST_NAME) = UPD.MEMFIRSTNAME
		AND
		UPPER(a.PATIENT_LAST_NAME) = UPD.MEMLASTNAME
		AND
		DECODE(UPPER(a.PATIENT_GENDER),''M'',''M'',''F'',''F'',''U'')  = UPD.GENDER
		AND
		a.PATIENT_DOB = UPD.DOB
		AND
		NVL(GRP.rollupid,a.account_number) = UPD.LVLID3
		';
	END IF;
	BEGIN
		EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('RXCLAIMS-CSTM BCBSIL',EMPID,'BCBSIL','','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_BCBSIL_'||EMPID,'Y','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS-CSTM BCBSIL',EMPID,'BCBSIL',SQLCODE,substr(SQLERRM, 1,400),'',0,'RXCLAIMS','','E');
	END;
	COMMIT;
------------------------------------------------------------------------------------------------------------------
	BEGIN
		SP_CDF_TBL_MERGE(USER,'RXCLAIMS-MERGE BCBSIL','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_BC');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS-MERGE BCBSIL',EMPID,'BCBSIL',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	END;
	COMMIT;

---------------------------------- Start of Insert of  BCBSIL ---------------------------------------------------------------

	VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_RXCLAIMS_'||vLvl.SERIALNO||'_BC';

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('BCBSIL RX FINAL INSERT',EMPID,'BCBSIL','','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_BCBSIL_'||EMPID,'Y','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('BCBSIL RX FINAL INSERT',EMPID,'BCBSIL',SQLCODE,substr(SQLERRM, 1,400),'',0,'RXCLAIMS','','E');
	END;
	COMMIT;

--ICE-11202
BEGIN
	 UTILITY.PKG_UPDATE.SP_LOA
	 (
	 	FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
	 	TO_TABLENAME =>	 'VH_RXCLAIMS_'||vLvl.SERIALNO||'',
	 	UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
	 	DELIMITER =>		'-',
	 	UPDATE_PASSES =>	'1-2-3-4',
	 	LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
	 	LVL_DESC_YN =>	  'Y',
	 	PASS_1_JOIN_CONDITION =>	'[a.source]=''BCBSIL'' and  a.LVLID3 = b.LVLID3',
	 	PASS_1_UPDATE_CONDITION =>	'[a.source]=''BCBSIL''',
	 	PASS_2_JOIN_CONDITION =>	'[a.source]=''BCBSIL'' and  a.LVLID3 = b.LVLID3',
	 	PASS_2_UPDATE_CONDITION =>	'[a.source]=''BCBSIL'' and [a.UDFC4] IS NULL',
	 	PASS_3_JOIN_CONDITION =>	'[a.source]=''BCBSIL'' and a.LVLID3 = b.LVLID3',
	 	PASS_3_UPDATE_CONDITION =>	'[a.source]=''BCBSIL'' and [a.UDFC4] IS NULL',
	 	PASS_4_JOIN_CONDITION =>	'[a.source]=''BCBSIL'' and a.LVLID3 = b.LVLID3',
	 	PASS_4_UPDATE_CONDITION =>	'[a.source]=''BCBSIL'' and [a.UDFC4] IS NULL',
	 	BEGIN_END_DTE_YN =>	 'N',
	 	STABLE_FROM_TABLE_YN =>	 'N',
	 	ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
	 );
	 END;
	 END IF;
-------------------------------------------END RXCLAIMS OF BCBSIL ICE 5214---------------------------------------------------
------------------------------- OPTUM ICE#144739-------------------------------------------------------

------------------------------------------------------RX OPTUM 1156 STARTS--MI Implementation-----------------------------------------------------------------
IF vLvl.PAYER='OPTM' AND EMPID NOT IN ('STOB') THEN			--STOB group is out of cycle period --ICE_1498

	VBQUERY := 'DROP TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM AS
	SELECT
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		PAIDDATE,
		DRUGSTRENGTH,
		UDF1,
		PRODUCTID
	FROM
		VH_RXCLAIMS
	WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS TABLE CREATE OPTUM',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_RX_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	BEGIN
		SP_PYR_1156_RX_OPTM('HI0826001','HI_RX_OPTM_'||EMPID||'','RXCLAIMS','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS-COMM OPTUM',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_1156_RX_OPTM','','E');
	END;
	COMMIT;
----------------------------------------------------------------------------------------------------------

	vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		PAIDDATE,
		DRUGSTRENGTH,
		UDF1,
		PRODUCTID
	)
	SELECT
		a.ROWID AS SRCROWID,
		''OPTUM'' AS SOURCE,
		a.SOCIALSECURITYNUMBER||DECODE(a.GENDER,''1'',''M'',''2'',''F'',''U'')||TO_CHAR(a.PATIENTDATEOFBIRTH,''YYYYMMDD'') AS MEMID,
		a.SOCIALSECURITYNUMBER AS EMPID,
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		NULL AS LVLID2,
		NULL AS LVLDESC2,
		nvl(grp.ROLLUPID,a.CARRIER) AS LVLID3,
		nvl(grp.Group_Name,a.CARRIER) AS LVLDESC3,
		NULL AS LVLID4,
		NULL AS LVLDESC4,
		CASE
			WHEN grp.ROLLUPID = ''WARR'' THEN a.PROCESSCYCLEDATE
			WHEN GRP.ROLLUPID = ''COCI'' THEN a.SUBMITDATEOFCLAIM	--213983
			ELSE Nvl(a.CHECKDATE,a.DATEOFSERVICE)
		  END AS PAIDDATE,								---as per ice 161790
		a.DRUGSTRENGTH/1000 AS DRUGSTRENGTH,
		a.UDF1 AS UDF1,
		''1'' as PRODUCTID
	FROM
		HI0826001.HI_RX_OPTM_'||EMPID||'  a

	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.CARRIER = grp.SRC_CODE
	';

	BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('RXCLAIMS-CSTM OPTUM',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS-CSTM OPTUM',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'RX','','E');
	END;
	COMMIT;
------------------------------------------------------------------------------------------------------------------
	BEGIN
		SP_CDF_TBL_MERGE(USER,'RXCLAIMS-MERGE OPTUM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_OPTM');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS-MERGE OPTUM',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	END;
	COMMIT;

---------------------------------- Start of Insert of OPTUM OR dropped data back ---------------------------------------------------------------

	VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
	    SELECT * FROM VH_RXCLAIMS_'||vLvl.SERIALNO||'_OPTM';

	BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('OPTUM FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('OPTUM FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'RX','','E');
	END;
	COMMIT;
------------------------------------------RX OPTUM 1156 ends-----MI Implementation-----------------------------

----------------------------------------------------------------------------------------------------------------------
	 vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
   	    USING
   	    (
   	    SELECT  memfirstname,memlastname,gender,dob,MEMID,ENRID
        FROM
   	            (
   	              SELECT /*+parallel(a,4)*/ memfirstname,memlastname,gender,dob,MEMID,ENRID,


   	                     Row_Number() over (PARTITION BY
   	                    memfirstname,memlastname,gender,dob
   	                       ORDER BY memfirstname,memlastname,gender,dob

   	                      ) rn
   	             FROM   VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b

   	              )WHERE RN=1
   	    )D
   	    ON
   	    (
   	     C.memfirstname=D.memfirstname
		AND C.memlastname=D.memlastname
		AND C.gender=D.gender
		AND C.dob=D.DOB
		)
		WHEN MATCHED THEN
        UPDATE SET
		C.MEMID=D.MEMID,
		C.ENRID=D.ENRID
		WHERE C.SOURCE=''OPTUM''';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS MEMID UPDATE',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;

	BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
		FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
		TO_TABLENAME =>	 'VH_RXCLAIMS_'||vLvl.SERIALNO||'',
		UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
		DELIMITER =>		'-',
		UPDATE_PASSES =>	'1-2-4',
		LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
		LVL_DESC_YN =>	  'Y',
		PASS_1_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3',
		PASS_1_UPDATE_CONDITION =>	'[a.source]=''OPTUM''',
		PASS_2_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3',
		PASS_2_UPDATE_CONDITION =>	'[a.source]=''OPTUM''  and [a.LVLID2] IS NULL',
		PASS_3_JOIN_CONDITION =>	NULL,
		PASS_3_UPDATE_CONDITION =>	NULL,
		PASS_4_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3',
		PASS_4_UPDATE_CONDITION =>	'[a.source]=''OPTUM''  and [a.LVLID2] IS NULL',
		BEGIN_END_DTE_YN =>	 'N',
		STABLE_FROM_TABLE_YN =>	 'N',
		ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
	);
	END;
	COMMIT;
	--/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.filldate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.filldate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.filldate ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.ENRID=d.ENRID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
    UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE   c.planname IS NULL';
---------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

END IF;
-----------------------------------------------------------------------------
---  Aurora Casket AND RELIANCE MEDICAL - Healthsmart RxClaims Mapping
-----------------------------------------------------------------------------
IF  vLvl.PAYER='HLTS' THEN

  BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ZZZ_MEM_UPDATE_ELIG CASCADE CONSTRAINTS';
  EXCEPTION
    WHEN Others THEN NULL;
  END;


  vbquery:=
  'CREATE TABLE ZZZ_MEM_UPDATE_ELIG as
  SELECT * from
	  (SELECT
		INDIV_1ST_NAME_TEXT, INDIV_LAST_NAME_TEXT,INDIV_BIRTH_DATE,EMPE_SSN_NBR, INDIV_SEX_CODE,
		ROW_NUMBER() OVER(PARTITION BY INDIV_1ST_NAME_TEXT, INDIV_LAST_NAME_TEXT, INDIV_BIRTH_DATE ORDER BY RECEIVEDMONTH DESC) RN
  FROM HI0826001.HI_ELIG_UMR_BEF_ACKT
	  UNION ALL
	  SELECT
		INDIV_1ST_NAME_TEXT, INDIV_LAST_NAME_TEXT, INDIV_BIRTH_DATE,EMPE_SSN_NBR,  INDIV_SEX_CODE,
		ROW_NUMBER() OVER(PARTITION BY INDIV_1ST_NAME_TEXT, INDIV_LAST_NAME_TEXT, INDIV_BIRTH_DATE ORDER BY RECEIVEDMONTH DESC) RN
	  FROM HI0826001.HI_ELIG_UMR_BEF_RMPI ) a
	WHERE rn = 1';
  EXECUTE IMMEDIATE vbquery;

  BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM CASCADE CONSTRAINTS';
  EXCEPTION
    WHEN Others THEN NULL;
  END;


   BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ZZZ_ZIP_UPDATE_ELIG CASCADE CONSTRAINTS';
  EXCEPTION
    WHEN Others THEN NULL;
  END;


  vbquery:=
  'CREATE TABLE ZZZ_ZIP_UPDATE_ELIG as
  SELECT MEMID,ZIP from
	  (SELECT
		MEMID,ZIP,
		ROW_NUMBER() OVER(PARTITION BY MEMID ORDER BY RCVMTH DESC) RN
	  FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||' )
	WHERE rn = 1';
  EXECUTE IMMEDIATE vbquery;

  BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM CASCADE CONSTRAINTS';
  EXCEPTION
    WHEN Others THEN NULL;
  END;


  vbquery:=
  'CREATE TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM as
  SELECT
    SN,
    MEMID,
	ZIP,
    LVLID1,
    LVLDESC1,
	LVLID3,
	LVLDESC3,
	PRODUCTID
  FROM VH_RXCLAIMS WHERE 1=2';
  EXECUTE IMMEDIATE vbquery;

  EXECUTE IMMEDIATE 'ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
  EXECUTE IMMEDIATE 'ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM PRIMARY KEY (SRCROWID)';

--------------------------------------------------------------------------------
--  Standard Client custom mapping
---------------------------------------------------------------------------------
  SP_PYR_3133_RX_HLTS('HI0826001','HI_RX_HLTS_'||EMPID||'','RXCLAIMS','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','4');

  vblQueryName:='060_826_'||vLvl.SERIALNO||'_RX_1';
  INSERT INTO VH_QUERYLOG(QueryName,CURTIME) VALUES(vblQueryName,SYSDATE);
  COMMIT;

--------------------------------------------------------------------------------
--  Client custom mapping
---------------------------------------------------------------------------------

  vbquery:=
	'INSERT /*+ APPEND PARALLEL(a,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM a
	(
	   SRCROWID,
	   SN,
	   MEMID,
	   ZIP,
	   LVLID1,
	   LVLDESC1,
	   LVLID3,
	   LVLDESC3,
	   PRODUCTID
	)
	SELECT /*+ PARALLEL(a,4) */
		a.ROWID AS SRCROWID,
		rowindexRx.nextval AS SN,
		Nvl(NULLIF(b.EMPE_SSN_NBR||DECODE(UPPER(b.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')|| TO_CHAR(b.INDIV_BIRTH_DATE,''YYYYMMDD''),''U''), a.MEMBER_ID||CASE UPPER(a.MEMBER_GENDER_CODE) WHEN ''M'' THEN ''M'' WHEN ''F'' THEN ''F'' ELSE ''U'' END||TO_CHAR(a.MEMBER_BIRTH_DATE,''YYYYMMDD'')) AS MEMID,
		ELIG.ZIP,
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		Nvl(grp.ROLLUPID,a.GROUP_NUMBER) AS LVLID3,
		Nvl(grp.GROUP_NAME,a.GROUP_NUMBER) AS LVLDESC3,
		''1'' AS PRODUCTID
 	FROM
	  HI0826001.HI_RX_'||vLvl.PAYER||'_'||EMPID||' a
	LEFT JOIN
	  ZZZ_MEM_UPDATE_ELIG b
	 ON
	  UPPER(a.PATIENT_FIRST_NAME) = UPPER(b.INDIV_1ST_NAME_TEXT)
	AND
	  UPPER(a.PATIENT_LAST_NAME) = UPPER(b.INDIV_LAST_NAME_TEXT)
	AND
	  a.MEMBER_BIRTH_DATE = b.INDIV_BIRTH_DATE
	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.GROUP_NUMBER = grp.SRC_CODE
	LEFT JOIN
	ZZZ_ZIP_UPDATE_ELIG ELIG
	ON
	Nvl(NULLIF(b.EMPE_SSN_NBR||DECODE(UPPER(b.INDIV_SEX_CODE),''M'',''M'',''MALE'',''M'',''F'',''F'',''FEMALE'',''F'',''U'')|| TO_CHAR(b.INDIV_BIRTH_DATE,''YYYYMMDD''),''U''), a.MEMBER_ID||CASE UPPER(a.MEMBER_GENDER_CODE) WHEN ''M'' THEN ''M'' WHEN ''F'' THEN ''F'' ELSE ''U'' END||TO_CHAR(a.MEMBER_BIRTH_DATE,''YYYYMMDD''))=ELIG.MEMID
';

 EXECUTE IMMEDIATE vbquery;
 COMMIT;

  vblQueryName:='060_826_'||vLvl.SERIALNO||'_RX_2';
  INSERT INTO VH_QUERYLOG(QueryName,CURTIME) VALUES(vblQueryName,SYSDATE);
  COMMIT;

--------------------------------------------------------------------------------
-- Merging Standard and Client custom mapping tables
---------------------------------------------------------------------------------
  vbquery:='Merge Procedure call SP_CDF_TBL_MERGE';
   SP_CDF_TBL_MERGE(USER,'RX','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_HLT');

  vblQueryName:='060_826_'||vLvl.SERIALNO||'_RX_3';
  INSERT INTO VH_QUERYLOG(QueryName,CURTIME) VALUES(vblQueryName,SYSDATE);
  COMMIT;

  --select * from VH_RXCLAIMS_HEALTHSMART

  vbQuery:=
	'MERGE INTO  VH_RXCLAIMS_'||vLvl.SERIALNO||'_HLT c
   	    USING
   	    (
   	    SELECT  memfirstname,memlastname,gender,dob,MEMID,ENRID
        FROM
   	            (
   	              SELECT /*+parallel(a,4)*/ memfirstname,memlastname,gender,dob,MEMID,ENRID,


   	                     Row_Number() over (PARTITION BY
   	                    memfirstname,memlastname,gender,dob
   	                       ORDER BY memfirstname,memlastname,gender,dob

   	                      ) rn
   	             FROM   VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b

   	              )WHERE RN=1
   	    )D
   	    ON
   	    (
   	     C.memfirstname=D.memfirstname
		AND C.memlastname=D.memlastname
		AND C.gender=D.gender
		AND C.dob=D.DOB
		)
		WHEN MATCHED THEN
        UPDATE SET
		C.MEMID=D.MEMID,
		C.ENRID=D.ENRID
		WHERE C.SOURCE=''HEALTHSMART''';
---------------------------------------Executing memid update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS MEMID UPDATE',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;



    ----/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
vbQuery:=
'INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
(source, sn, transnum, seqno, datetimestamp, memid, enrid, relflag, memfirstname, memlastname, gender, dob, addr1, addr2, city, state, zip, homephone, workphone, lvlid1, lvldesc1, lvlid2, lvldesc2, lvlid3, lvldesc3, lvlid4, lvldesc4, lvlid5, lvldesc5, lvlid6, lvldesc6, lvlid7, lvldesc7, lvlid8, lvldesc8, lvlid9, lvldesc9, lvlid10,
lvldesc10, filldate, paiddate, metricquantity, dayssupply, drugcode, drugdesc, drugstrength, formulary_yn, moi, prescriberid, prescribertype, prescribername, pharmid, pharmname, pharmzipcode, paidamt, billedamt, ingredcost, dispensingcost, salestax, allowedamt, enrpaidamt, coinsamt, copayamt, deductamt, notallowedamt, admfees, awp, cobamt, adjcode, siccode, sicdesc, claimstatus, supplyflag,
discountamt, prescount, ssn, rcvmth, srcfilename, udf1, udfm1, udf2, udfm2, udf3, udf4, udf5, udf6, udf7, udf8, udf9, udfc1, udfc2, udfc3, udfc4, udfc5, udfc6, udfc7, udfc8, udfc9, udfc10, udfc11, udfc12, udfc13, udfc14, udfc15, udfc16, udfc17, udfc18, udfc19, udfc20, udfd1, udfd2, udfd3, udfd4, udfd5, udfn1, udfn2, udfn3, udfn4, udfn5, udfn6, udfn7, udfn8, udfn9, udfn10, udfn11, udfn12,
udfn13, udfn14, udfn15, udfn16, udfn17, udfn18, udfn19, udfn20, vh_lvl_id, emp_nbr, medeligcatid, productid, vhpayorid, vhlayoutid, qty_disp, srcrelflag, aifileid,
airownumber, vhpayername, vhgroupname, compoundind, specialtyind, pharmnabpnum, plannumber, planname, plantype, populationtype, enrollment_source)
SELECT source, sn, transnum, seqno, datetimestamp, memid, enrid, relflag, memfirstname, memlastname, gender, dob, addr1, addr2, city, state, zip, homephone, workphone, lvlid1, lvldesc1, lvlid2, lvldesc2, lvlid3, lvldesc3, lvlid4, lvldesc4, lvlid5, lvldesc5, lvlid6, lvldesc6, lvlid7, lvldesc7, lvlid8, lvldesc8, lvlid9, lvldesc9, lvlid10,
lvldesc10, filldate, paiddate, metricquantity, dayssupply, drugcode, drugdesc, drugstrength, formulary_yn, moi, prescriberid, prescribertype, prescribername, pharmid, pharmname, pharmzipcode, paidamt, billedamt, ingredcost, dispensingcost, salestax, allowedamt, enrpaidamt, coinsamt, copayamt, deductamt, notallowedamt, admfees, awp, cobamt, adjcode, siccode, sicdesc, claimstatus, supplyflag, discountamt,
prescount, ssn, rcvmth, srcfilename, udf1, udfm1, udf2, udfm2,
udf3, udf4, udf5, udf6, udf7, udf8, udf9, udfc1, udfc2, udfc3, udfc4, udfc5, udfc6, udfc7, udfc8, udfc9, udfc10, udfc11, udfc12, udfc13, udfc14, udfc15, udfc16, udfc17, udfc18, udfc19, udfc20, udfd1, udfd2, udfd3, udfd4, udfd5, udfn1, udfn2, udfn3, udfn4, udfn5, udfn6, udfn7, udfn8, udfn9, udfn10, udfn11, udfn12, udfn13, udfn14, udfn15, udfn16, udfn17, udfn18, udfn19, udfn20, vh_lvl_id, emp_nbr, medeligcatid,
productid, vhpayorid, vhlayoutid, qty_disp, srcrelflag, aifileid,
airownumber, vhpayername, vhgroupname, compoundind, specialtyind, pharmnabpnum, plannumber, planname, plantype, populationtype, enrollment_source FROM VH_RXCLAIMS_'||vLvl.SERIALNO||'_HLT';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('Insert Healthsamrt into rxclaims',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
-----------------------------------------------------------------------------
BEGIN
UTILITY.PKG_UPDATE.SP_LOA
(
	FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
	TO_TABLENAME =>	 'VH_RXCLAIMS_'||vLvl.SERIALNO||'',
	UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
	DELIMITER =>		'-',
	UPDATE_PASSES =>	'1-2-4',
	LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
	LVL_DESC_YN =>	  'Y',
	PASS_1_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3',
	PASS_1_UPDATE_CONDITION =>	'[a.source]=''HEALTHSMART''',
	PASS_2_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3',
	PASS_2_UPDATE_CONDITION =>	'[a.source]=''HEALTHSMART''  and [a.LVLID2] IS NULL',
	PASS_3_JOIN_CONDITION =>	NULL,
	PASS_3_UPDATE_CONDITION =>	NULL,
	PASS_4_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3',
	PASS_4_UPDATE_CONDITION =>	'[a.source]=''HEALTHSMART''  and [a.LVLID2] IS NULL',
	BEGIN_END_DTE_YN =>	 'N',
	STABLE_FROM_TABLE_YN =>	 'N',
	ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
);
END;
COMMIT;

----/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.filldate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.filldate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.filldate ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.ENRID=d.ENRID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
    UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE   c.planname IS NULL';


---------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
END IF;



------- #MERITAIN RX #194051 STARTS, 227414 --------

IF  vLvl.PAYER='MERITAIN' THEN


----------------Changes Made as per ICE#326243
  BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE zzz_oop_rx_meritain_'||EMPID||' PURGE';
	  EXCEPTION WHEN OTHERS THEN NULL;
	END;

  vbQuery:='CREATE TABLE ZZZ_OOP_RX_MERITAIN_'||EMPID||' AS
SELECT
B.CLAIM_ID,
B.ADJUSTMENT_TYPE,
    B.PAID_DATE,
    B.NET_PAYMENT_AMOUNT,
    B.SOURCEFILENAME,
    B.RECEIVEDMONTH,
    B.IMPORTEDDATE,
    B.FILEID,
    B.CLAIM_LINE_NUMBER,
    B.PROCEDURE_CODE,
    B.SUBMITTED_AMOUNT,
    B.COPAY_AMOUNT,
    B.OVERPAYMENT_AMOUNT,
    B.UNITS,
    B.DAYS_OF_SERVICE,
    B.ALLOWED_AMOUNT,
    B.COINSURANCE_AMOUNT,
    B.DEDUCTIBLE_AMOUNT,
    B.DISCOUNT_AMOUNT,
    B.COB_SAVINGS_AMOUNT,
    B.PRECERT_PENALTY_AMOUNT,
    B.RX_QUANTITY,
    B.RX_DAYS_SUPPLY,
    B.RX_INGREDIENT_COST,
    B.RX_DISPENSING_FEE,
    B.RX_SALES_TAX,
    B.INELIGIBLE_AMOUNT,
    B.HOURS,
    B.EXEMPT_CODE,
    B.RX_PROGRAM_TYPE,
    B.BENEFIT_CODE,
    B.BENEFIT_CODE_DESCRIPTION,
    B.PATIENT_RESPONSIBILITY_AMOUNT,
    B.ROWNUMBER,
    B.HASHKEY
 FROM
(
    SELECT
    B.CLAIM_ID,
    B.ADJUSTMENT_TYPE,
    B.PAID_DATE,
    B.NET_PAYMENT_AMOUNT,
    B.SOURCEFILENAME,
    B.RECEIVEDMONTH,
    B.IMPORTEDDATE,
    B.FILEID,
    B.CLAIM_LINE_NUMBER,
    B.PROCEDURE_CODE,
    B.SUBMITTED_AMOUNT,
    B.COPAY_AMOUNT,
    B.OVERPAYMENT_AMOUNT,
    B.UNITS,
    B.DAYS_OF_SERVICE,
    B.ALLOWED_AMOUNT,
    B.COINSURANCE_AMOUNT,
    B.DEDUCTIBLE_AMOUNT,
    B.DISCOUNT_AMOUNT,
    B.COB_SAVINGS_AMOUNT,
    B.PRECERT_PENALTY_AMOUNT,
    B.RX_QUANTITY,
    B.RX_DAYS_SUPPLY,
    B.RX_INGREDIENT_COST,
    B.RX_DISPENSING_FEE,
    B.RX_SALES_TAX,
    B.INELIGIBLE_AMOUNT,
    B.HOURS,
    B.EXEMPT_CODE,
    B.RX_PROGRAM_TYPE,
    B.BENEFIT_CODE,
    B.BENEFIT_CODE_DESCRIPTION,
    B.PATIENT_RESPONSIBILITY_AMOUNT,
    B.ROWNUMBER,
    B.HASHKEY,
    ROW_NUMBER() OVER (PARTITION BY B.CLAIM_ID,B.PAID_DATE,B.ADJUSTMENT_TYPE ORDER BY IMPORTEDDATE DESC, ROWNUMBER DESC) RN
    FROM
    HI0826001.HI_CLAIMS_MERITAIN_'||EMPID||' B
    WHERE
      CLAIM_TYPE_CODE=''R''
    AND
      BENEFIT_CODE=''94V''
) B
WHERE
RN=1
';

  BEGIN
    EXECUTE IMMEDIATE vbQuery;
	  EXCEPTION WHEN OTHERS THEN xp_scrubStatusLog ('ZZZ_OOP_RX_MERITAIN_'||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
  END;
	COMMIT;

----Main Table
 BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ZZZ_RX_MERITAIN_'||EMPID||' PURGE';
	  EXCEPTION WHEN OTHERS THEN NULL;
	END;


vbQuery:=
'CREATE TABLE ZZZ_RX_MERITAIN_'||EMPID||' AS
SELECT
  A.INSUREDS_ID,
  A.INSUREDS_FIRST_NAME,
  A.INSUREDS_LAST_NAME,
  A.PATIENT_FIRST_NAME,
  A.PATIENT_LAST_NAME,
  A.PATIENT_GENDER,
  A.PATIENT_DATE_OF_BIRTH,
  A.DEPENDENT_NUMBER,
  A.PATIENT_RELATIONSHIP,
  A.INSUREDS_ZIP_CODE,
  A.BILLING_PROVIDER_TAX_ID,
  A.BILLING_PROVIDER_NAME,
  A.BILLING_PROVIDER_ADDRESS_1,
  A.BILLING_PROVIDER_ADDRESS_2,
  A.BILLING_PROVIDER_CITY,
  A.BILLING_PROVIDER_STATE,
  A.BILLING_PROVIDER_ZIP,
  A.CLAIM_ID,
  A.CLAIM_TYPE_CODE,
  A.ADJUSTMENT_TYPE,
  A.CLAIM_LINE_NUMBER,
  A.NETWORK_PAID_FLAG,
  A.NETWORK_PROVIDER_FLAG,
  A.PLACE_OF_SERVICE_CODE,
  A.ICD_CODE_TYPE,
  A.PRIMARY_DIAGNOSIS_CODE,
  A.SECONDARY_DIAGNOSIS_CODE,
  A.PROCEDURE_CODE,
  A.UNITS,
  A.MODIFIERS,
  A.TYPE_OF_SERVICE_CODE,
  A.REMARK,
  A.PLAN_COVERAGE_SUFFIX,
  A.DRG_CODE,
  A.RECEIVED_DATE,
  A.SERVICE_FROM_DATE,
  A.SERVICE_TO_DATE,
  A.DAYS_OF_SERVICE,
  A.PAID_DATE,
  A.SUBMITTED_AMOUNT,
  A.ALLOWED_AMOUNT,
  A.COINSURANCE_AMOUNT,
  A.DEDUCTIBLE_AMOUNT,
  A.COPAY_AMOUNT,
  A.DISCOUNT_AMOUNT,
  A.NET_PAYMENT_AMOUNT,
  A.OVERPAYMENT_AMOUNT,
  A.COB_SAVINGS_AMOUNT,
  A.EXEMPT_CODE,
  A.EMPLOYER_ID,
  A.REVENUE_CODE,
  A.PRECERT_PENALTY_AMOUNT,
  A.NPI_RENDERING_PROVIDER,
  A.NPI_BILLING_PROVIDER,
  A.NPI_ATTENDING_PROVIDER,
  A.NPI_REFERRING_PROVIDER,
  A.NPI_FACILITY,
  A.NPI_OPERATING_PROVIDER,
  A.NPI_OTHER_PROVIDER,
  A.RX_DATE_WRITTEN,
  A.RX_PRESCRIPTION_NUMBER,
  A.RX_NEW_OR_REFILL,
  A.RX_CARDHOLDER_NUMBER,
  A.RX_PROGRAM_TYPE,
  A.RX_DRUG_CODE,
  A.RX_DRUG_NAME,
  A.RX_QUANTITY,
  A.RX_DAYS_SUPPLY,
  A.RX_INGREDIENT_COST,
  A.RX_DISPENSING_FEE,
  A.RX_SALES_TAX,
  A.RX_PHARMACY_NUMBER,
  A.RX_PHYSICIANS_DEA_NUMBER,
  A.RX_FORMULARY,
  A.BILLING_PROVIDER_PHONE_NUMBER,
  A.UNUSED1,
  A.UNUSED2,
  A.QUANTITY,
  A.EMPLOYER_GROUP_NAME,
  A.OTHER_DIAGNO_CODES,
  A.PROVIDER_SPECIALTY,
  A.REPRICER_CODE,
  A.REPRICER_NAME,
  A.BENEFIT_CODE,
  A.BENEFIT_CODE_DESCRIPTION,
  A.HOSPITAL_DISCHARGE_STATUS_CODE,
  A.INELIGIBLE_AMOUNT,
  A.PATIENT_RESPONSIBILITY_AMOUNT,
  A.INSURED_ALTERNATE_ID,
  A.INSURED_CARD_ID,
  A.PHYSICIAN_NAME,
  A.HOURS,
  A.RENDERING_PROVIDER_NAME,
  A.RENDERING_PROVIDER_ADDRESS_1,
  A.RENDERING_PROVIDER_ADDRESS_2,
  A.RENDERING_PROVIDER_CITY,
  A.RENDERING_PROVIDER_STATE,
  A.RENDERING_PROVIDER_ZIP,
  A.TYPE_OF_BILL,
  A.COVERAGE_RECORD_DESCRIPTION,
  A.TOOTH_NUMBER,
  A.UDF1,
  A.UDF2,
  A.UDF3,
  A.UDF4,
  A.UDF5,
  A.SOURCEFILENAME,
  A.RECEIVEDMONTH,
  A.IMPORTEDDATE,
  A.CLIENTID,
  A.EMPGRP,
  A.FILEID,
  A.ROWNUMBER,
  A.HASHKEY,
  A.PAYORNAME,
  OOP.ADJUSTMENT_TYPE AS OOP_ADJUSTMENT_TYPE,
  OOP.PAID_DATE AS OOP_PAID_DATE,
  OOP.NET_PAYMENT_AMOUNT AS OOP_NET_PAYMENT_AMOUNT,
  OOP.SOURCEFILENAME AS OOP_SOURCEFILENAME,
  OOP.RECEIVEDMONTH AS OOP_RECEIVEDMONTH,
  OOP.IMPORTEDDATE AS OOP_IMPORTEDDATE,
  OOP.FILEID AS OOP_FILEID,
  OOP.CLAIM_LINE_NUMBER AS OOP_CLAIM_LINE_NUMBER,
  OOP.PROCEDURE_CODE AS OOP_PROCEDURE_CODE,
  OOP.SUBMITTED_AMOUNT AS OOP_SUBMITTED_AMOUNT,
  OOP.COPAY_AMOUNT AS OOP_COPAY_AMOUNT,
  OOP.OVERPAYMENT_AMOUNT AS OOP_OVERPAYMENT_AMOUNT,
  OOP.UNITS AS OOP_UNITS,
  OOP.DAYS_OF_SERVICE AS OOP_DAYS_OF_SERVICE,
  OOP.ALLOWED_AMOUNT AS OOP_ALLOWED_AMOUNT,
  OOP.COINSURANCE_AMOUNT AS OOP_COINSURANCE_AMOUNT,
  OOP.DEDUCTIBLE_AMOUNT AS OOP_DEDUCTIBLE_AMOUNT,
  OOP.DISCOUNT_AMOUNT AS OOP_DISCOUNT_AMOUNT,
  OOP.COB_SAVINGS_AMOUNT AS OOP_COB_SAVINGS_AMOUNT,
  OOP.PRECERT_PENALTY_AMOUNT AS OOP_PRECERT_PENALTY_AMOUNT,
  OOP.RX_QUANTITY AS OOP_RX_QUANTITY,
  OOP.RX_DAYS_SUPPLY AS OOP_RX_DAYS_SUPPLY,
  OOP.RX_INGREDIENT_COST AS OOP_RX_INGREDIENT_COST,
  OOP.RX_DISPENSING_FEE AS OOP_RX_DISPENSING_FEE,
  OOP.RX_SALES_TAX AS OOP_RX_SALES_TAX,
  OOP.INELIGIBLE_AMOUNT AS OOP_INELIGIBLE_AMOUNT,
  OOP.HOURS AS OOP_HOURS,
  OOP.EXEMPT_CODE AS OOP_EXEMPT_CODE,
  OOP.RX_PROGRAM_TYPE AS OOP_RX_PROGRAM_TYPE,
  OOP.BENEFIT_CODE AS OOP_BENEFIT_CODE,
  OOP.BENEFIT_CODE_DESCRIPTION AS OOP_BENEFIT_CODE_DESCRIPTION,
  OOP.PATIENT_RESPONSIBILITY_AMOUNT AS OOP_PATIENT_RESPONSIBILITY_AMT,
  OOP.ROWNUMBER AS OOP_ROWNUMBER,
  OOP.HASHKEY AS OOP_HASHKEY
FROM
HI0826001.HI_CLAIMS_MERITAIN_'||EMPID||' A
LEFT JOIN
ZZZ_OOP_RX_MERITAIN_'||EMPID||' OOP
ON
  A.CLAIM_ID=OOP.CLAIM_ID
AND
  A.PAID_DATE=OOP.PAID_DATE
AND
NVL(A.ADJUSTMENT_TYPE,''BLANK'')=NVL(OOP.ADJUSTMENT_TYPE,''BLANK'')
WHERE
  A.CLAIM_TYPE_CODE=''R''
AND
  A.BENEFIT_CODE<>''94V''
';

 BEGIN
    EXECUTE IMMEDIATE vbQuery;
	  EXCEPTION WHEN OTHERS THEN xp_scrubStatusLog ('ZZZ_RX_MERITAIN_'||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
  END;
	COMMIT;


IF EMPID='BTLR' THEN
BEGIN EXECUTE IMMEDIATE 'DROP TABLE zzz_memid_update_meritain2 PURGE';
	EXCEPTION WHEN OTHERS THEN NULL;
	END;


vbQuery:='
    CREATE TABLE zzz_memid_update_meritain2 NOLOGGING PARALLEL 4
    as
    SELECT MEMID,ENRID,MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVLID3
    FROM(
    SELECT
	  MEMID,
		ENRID,
    MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		LVLID3,
    Row_Number() OVER (PARTITION BY MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB
    ORDER BY MEMID) rn
	FROM
		vh_eligibilities a
	WHERE LVLID3 = ''003321010''
  )
    WHERE rn=1
    ';                    -- ICE263783
	BEGIN EXECUTE IMMEDIATE vbQuery;
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('zzz_memid_update_meritain2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
	END;
	COMMIT;
end if;



VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='
		INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'
	(
		SRCROWID,
		SN,
		SOURCE,
		TRANSNUM,
		SEQNO,
		DATETIMESTAMP,
		MEMID,
		ENRID,
		RELFLAG,
		MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		ADDR1,
		ADDR2,
		CITY,
		STATE,
		ZIP,
		HOMEPHONE,
		WORKPHONE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		LVLID5,
		LVLDESC5,
		LVLID6,
		LVLDESC6,
		LVLID7,
		LVLDESC7,
		LVLID8,
		LVLDESC8,
		LVLID9,
		LVLDESC9,
		LVLID10,
		LVLDESC10,
		FILLDATE,
		PAIDDATE,
		METRICQUANTITY,
		DAYSSUPPLY,
		DRUGCODE,
		DRUGDESC,
		DRUGSTRENGTH,
		FORMULARY_YN,
		MOI,
		PRESCRIBERID,
		PRESCRIBERTYPE,
		PRESCRIBERNAME,
		PHARMID,
		PHARMNAME,
		PHARMZIPCODE,
		PAIDAMT,
		BILLEDAMT,
		INGREDCOST,
		DISPENSINGCOST,
		SALESTAX,
		ALLOWEDAMT,
		ENRPAIDAMT,
		COINSAMT,
		COPAYAMT,
		DEDUCTAMT,
		NOTALLOWEDAMT,
		ADMFEES,
		AWP,
		COBAMT,
		ADJCODE,
		SICCODE,
		SICDESC,
		CLAIMSTATUS,
		SUPPLYFLAG,
		DISCOUNTAMT,
		PRESCOUNT,
		SSN,
		RCVMTH,
		SRCFILENAME,
		UDF1,
		UDFM1,
		UDF2,
		UDFM2,
		UDF3,
		UDF4,
		UDF5,
		UDF6,
		UDF7,
		UDF8,
		UDF9,
		UDFC1,
		UDFC2,
		UDFC3,
		UDFC4,
		UDFC5,
		UDFC6,
		UDFC7,
		UDFC8,
		UDFC9,
		UDFC10,
		UDFC11,
		UDFC12,
		UDFC13,
		UDFC14,
		UDFC15,
		UDFC16,
		UDFC17,
		UDFC18,
		UDFC19,
		UDFC20,
		UDFD1,
		UDFD2,
		UDFD3,
		UDFD4,
		UDFD5,
		UDFN1,
		UDFN2,
		UDFN3,
		UDFN4,
		UDFN5,
		UDFN6,
		UDFN7,
		UDFN8,
		UDFN9,
		UDFN10,
		UDFN11,
		UDFN12,
		UDFN13,
		UDFN14,
		UDFN15,
		UDFN16,
		UDFN17,
		UDFN18,
		UDFN19,
		UDFN20,
		VH_LVL_ID,
		EMP_NBR,
		MEDELIGCATID,
		PRODUCTID,
		VHPAYORID,
		VHLAYOUTID,
		QTY_DISP,
		SRCRELFLAG,
		AIFILEID,
		AIROWNUMBER,
		VHPAYERNAME,
		VHGROUPNAME
	)
	SELECT /*+parallel(a,4)*/
		a.ROWID AS SRCROWID,
		ROWNUM AS SN,
		''MERITAIN'' AS SOURCE,
		a.CLAIM_ID || a.CLAIM_LINE_NUMBER AS TRANSNUM,
		NVL(a.CLAIM_LINE_NUMBER,''01'') AS SEQNO,
		NULL AS DATETIMESTAMP,';
	-- CASE WHEN NVL(lvl3.ROLLUPID,a.employer_id) = ''003321010'' THEN
    -- COALESCE(MEM.MEMID,a.INSUREDS_ID||DECODE(UPPER(a.PATIENT_GENDER),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.PATIENT_DATE_OF_BIRTH,''YYYYMMDD''))
    -- ELSE
		-- a.INSUREDS_ID||DECODE(UPPER(a.PATIENT_GENDER),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.PATIENT_DATE_OF_BIRTH,''YYYYMMDD'') END AS MEMID,  --ICE263783
		-- CASE WHEN NVL(lvl3.ROLLUPID,a.employer_id) = ''003321010'' THEN
    -- COALESCE(MEM.ENRID,a.INSUREDS_ID)
    -- ELSE
    -- a.INSUREDS_ID END AS ENRID,  --ICE263783

	IF EMPID = 'BTLR' THEN
	vbQuery:= vbQuery||'
	COALESCE(mem.memid,a.INSUREDS_ID||DECODE(UPPER(a.PATIENT_GENDER),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.PATIENT_DATE_OF_BIRTH,''YYYYMMDD'')) AS MEMID,
	COALESCE(mem.enrid,a.INSUREDS_ID) AS ENRID,
	';
    ELSE
	vbQuery:= vbQuery||'
	a.INSUREDS_ID||DECODE(UPPER(a.PATIENT_GENDER),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.PATIENT_DATE_OF_BIRTH,''YYYYMMDD'') AS MEMID,
	a.INSUREDS_ID  AS ENRID,';
	END IF;
    vbQuery:= vbQuery||'

		DECODE(UPPER(a.PATIENT_RELATIONSHIP),''E'',''E'',''S'',''S'',''C'',''D'',''U'') AS RELFLAG,
		Upper(a.PATIENT_FIRST_NAME) AS MEMFIRSTNAME,
		Upper(a.PATIENT_LAST_NAME ) AS MEMLASTNAME,
		DECODE(UPPER(a.PATIENT_GENDER),''M'',''M'',''F'',''F'',''U'') AS GENDER,
		a.PATIENT_DATE_OF_BIRTH AS DOB,
		NULL AS ADDR1,
		NULL AS ADDR2,
		NULL AS CITY,
		NULL AS STATE,
		Substr(a.INSUREDS_ZIP_CODE,1,5) AS ZIP,
		NULL AS HOMEPHONE,
		NULL AS WORKPHONE,
		--LOA WILL BE CLIENT-SPECIFIC
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		NULL AS LVLID2,
		NULL AS LVLDESC2,
		NVL(lvl3.ROLLUPID,a.employer_id) AS LVLID3,
		NVL(lvl3.GROUP_NAME,a.employer_id) AS LVLDESC3,
		NULL AS LVLID4,
		NULL AS LVLDESC4,
		NULL AS LVLID5,
		NULL AS LVLDESC5,
		NULL AS LVLID6,
		NULL AS LVLDESC6,
		NULL AS LVLID7,
		NULL AS LVLDESC7,
		NULL AS LVLID8,
		NULL AS LVLDESC8,
		NULL AS LVLID9,
		NULL AS LVLDESC9,
		NULL AS LVLID10,
		NULL AS LVLDESC10,
		a.SERVICE_FROM_DATE AS FILLDATE,
		a.PAID_DATE AS PAIDDATE,
		a.RX_QUANTITY/1000 AS METRICQUANTITY,
		a.RX_DAYS_SUPPLY AS DAYSSUPPLY,
		a.RX_DRUG_CODE AS DRUGCODE,
		a.RX_DRUG_NAME AS DRUGDESC,
		NULL AS DRUGSTRENGTH,
		Decode(UPPER(a.RX_FORMULARY),''Y'',''Y'',''N'',''N'') AS FORMULARY_YN,
		CASE
			WHEN UPPER(a.RX_PROGRAM_TYPE) = ''94J'' THEN ''M''
			WHEN UPPER(a.RX_PROGRAM_TYPE) IN(''94'',''94Q'',''94S'', ''94T'') THEN ''R''
		END  AS MOI,
		NVL(a.RX_PHYSICIANS_DEA_NUMBER, Substr(a.PHYSICIAN_NAME,1,3) || Substr(a.PHYSICIAN_NAME,-3)) AS PRESCRIBERID,
		NULL AS PRESCRIBERTYPE,
		NVL(DEA.DEANAME, a.PHYSICIAN_NAME) AS PRESCRIBERNAME,
		a.RX_PHARMACY_NUMBER AS PHARMID,
		NULL AS PHARMNAME,
		NULL AS PHARMZIPCODE,
		a.NET_PAYMENT_AMOUNT AS PAIDAMT,
		Nvl(a.RX_INGREDIENT_COST,0)+Nvl(a.RX_DISPENSING_FEE,0) + Nvl(a.RX_SALES_TAX,0) AS BILLEDAMT,
		a.RX_INGREDIENT_COST AS INGREDCOST,
		a.RX_DISPENSING_FEE AS DISPENSINGCOST,
		a.RX_SALES_TAX  AS SALESTAX,
		Nvl(a.NET_PAYMENT_AMOUNT,0) + Nvl(a.OOP_COPAY_AMOUNT,0) +Nvl(a.OOP_COINSURANCE_AMOUNT ,0) + Nvl(a.OOP_DEDUCTIBLE_AMOUNT,0)   AS ALLOWEDAMT,
		a.OOP_PATIENT_RESPONSIBILITY_AMT AS ENRPAIDAMT,
		a.OOP_COINSURANCE_AMOUNT AS COINSAMT,
		a.OOP_COPAY_AMOUNT AS COPAYAMT,
		a.OOP_DEDUCTIBLE_AMOUNT AS DEDUCTAMT,
		a.INELIGIBLE_AMOUNT AS NOTALLOWEDAMT,
		NULL AS ADMFEES,
		NULL AS AWP,
		a.COB_SAVINGS_AMOUNT AS COBAMT,
		CASE WHEN Upper(a.ADJUSTMENT_TYPE) IN (''R'',''D'') THEN ''R'' ELSE ''P'' END AS ADJCODE,
		NULL AS SICCODE,
		NULL AS SICDESC,
		NULL AS CLAIMSTATUS,
		NULL AS SUPPLYFLAG,
		a.DISCOUNT_AMOUNT AS DISCOUNTAMT,
		CASE WHEN (Nvl(a.NET_PAYMENT_AMOUNT,0) + Nvl(a.OOP_COPAY_AMOUNT ,0) + Nvl(a.OOP_COINSURANCE_AMOUNT,0) + Nvl(a.OOP_DEDUCTIBLE_AMOUNT,0)) > 0 THEN 1
		  WHEN (Nvl(a.NET_PAYMENT_AMOUNT,0) + Nvl(a.OOP_COPAY_AMOUNT ,0) + Nvl(a.OOP_COINSURANCE_AMOUNT,0) + Nvl(a.OOP_DEDUCTIBLE_AMOUNT,0)) = 0 THEN 0
		  ELSE -1 END AS PRESCOUNT,
		NULL AS SSN,
		a.RECEIVEDMONTH AS RCVMTH,
		a.SOURCEFILENAME AS SRCFILENAME,
		NULL AS UDF1,
		NULL AS UDFM1,
		NULL AS UDF2,
		NULL AS UDFM2,
		NULL AS UDF3,
		NULL AS UDF4,
		NULL AS UDF5,
		NULL AS UDF6,
		NULL AS UDF7,
		NULL AS UDF8,
		NULL AS UDF9,
		NULL AS UDFC1,
		NULL AS UDFC2,
		NULL AS UDFC3,
		NULL AS UDFC4,
		NULL AS UDFC5,
		NULL AS UDFC6,
		NULL AS UDFC7,
		NULL AS UDFC8,
		NULL AS UDFC9,
		NULL AS UDFC10,
		NULL AS UDFC11,
		NULL AS UDFC12,
		NULL AS UDFC13,
		NULL AS UDFC14,
		NULL AS UDFC15,
		NULL AS UDFC16,
		NULL AS UDFC17,
		NULL AS UDFC18,
		NULL AS UDFC19,
		A.BENEFIT_CODE AS UDFC20,
		NULL AS UDFD1,
		NULL AS UDFD2,
		NULL AS UDFD3,
		NULL AS UDFD4,
		NULL AS UDFD5,
		NULL AS UDFN1,
		NULL AS UDFN2,
		NULL AS UDFN3,
		NULL AS UDFN4,
		NULL AS UDFN5,
		NULL AS UDFN6,
		NULL AS UDFN7,
		NULL AS UDFN8,
		NULL AS UDFN9,
		NULL AS UDFN10,
		NULL AS UDFN11,
		NULL AS UDFN12,
		NULL AS UDFN13,
		NULL AS UDFN14,
		NULL AS UDFN15,
		NULL AS UDFN16,
		NULL AS UDFN17,
		NULL AS UDFN18,
		A.OOP_OVERPAYMENT_AMOUNT AS UDFN19,
		A.OVERPAYMENT_AMOUNT AS UDFN20,
		NULL AS VH_LVL_ID,
		NULL AS EMP_NBR,
		NULL AS MEDELIGCATID,
		''1'' AS PRODUCTID,	--EI-specific. The value should match with the client-specific value populated in HR_Global_ProductLine. E.g., if ID for ''Commercial'' is 1 in the rules table, then populate 1. Default is ''Commercial''.
		''P0845'' AS VHPayorID,
		''443'' AS VHLayOutID, -- Populate AIP Layout ID
		NULL AS QTY_DISP,
		DECODE(UPPER(a.PATIENT_RELATIONSHIP), ''E'', ''EMPLOYEE'', ''S'', ''SPOUSE'', ''C'',''CHILD'',UPPER(a.PATIENT_RELATIONSHIP)) AS SRCRELFLAG,
		a.FILEID AS AIFILEID,
		a.ROWNUMBER AIROWNUMBER,
		a.PAYORNAME VHPAYERNAME,
		NULL AS VHGROUPNAME
	FROM
		ZZZ_RX_MERITAIN_'||EMPID||'  A
	LEFT JOIN
		ZZZ_PYR_DEA DEA
	ON
		a.RX_PHYSICIANS_DEA_NUMBER = DEA.DEAID
	LEFT JOIN
		HR_826_GROUP LVL3
	ON
		substr(a.EMPLOYER_ID,1,5) = LVL3.SRC_CODE';
IF EMPID = 'BTLR' THEN
	vbQuery:= vbQuery||'
    LEFT JOIN
    zzz_memid_update_meritain2 mem
  on
  UPPER(Nvl(SubStr(a.PATIENT_FIRST_NAME,1,InStr(a.PATIENT_FIRST_NAME,'' '')-1),a.PATIENT_FIRST_NAME))  = mem.MEMFIRSTNAME
  AND
  UPPER(a.PATIENT_LAST_NAME) = mem.MEMLASTNAME
  AND
  DECODE(UPPER(a.PATIENT_GENDER),''M'',''M'',''F'',''F'',''U'') = mem.GENDER
  AND
  a.PATIENT_DATE_OF_BIRTH = mem.DOB         --ICE263783
  ';
END IF;
 vbQuery:= vbQuery||'
	WHERE
		NVL(UPPER(a.CLAIM_TYPE_CODE),''NULL'') = ''R''
	OR
		a.PLACE_OF_SERVICE_CODE=''01''
';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('MERITAIN RX FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('MERITAIN RX FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'RX','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------START OF ICE 329984----------------------------------------------------------------

----------------Changes Made as per ICE#326243
  BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ZZZ_OOP_RX_MERITAIN_107_'||EMPID||' PURGE';
	  EXCEPTION WHEN OTHERS THEN NULL;
	END;

  vbQuery:='CREATE TABLE ZZZ_OOP_RX_MERITAIN_107_'||EMPID||' AS
SELECT
B.CLAIM_ID,
B.ADJUSTMENT_TYPE,
    B.PAID_DATE,
    B.NET_PAYMENT_AMOUNT,
    B.SOURCEFILENAME,
    B.RECEIVEDMONTH,
    B.IMPORTEDDATE,
    B.FILEID,
    B.CLAIM_LINE_NUMBER,
    B.PROCEDURE_CODE,
    B.SUBMITTED_AMOUNT,
    B.COPAY_AMOUNT,
    B.OVERPAYMENT_AMOUNT,
    B.UNITS,
    B.DAYS_OF_SERVICE,
    B.ALLOWED_AMOUNT,
    B.COINSURANCE_AMOUNT,
    B.DEDUCTIBLE_AMOUNT,
    B.DISCOUNT_AMOUNT,
    B.COB_SAVINGS_AMOUNT,
    B.PRECERT_PENALTY_AMOUNT,
    B.RX_QUANTITY,
    B.RX_DAYS_SUPPLY,
    B.RX_INGREDIENT_COST,
    B.RX_DISPENSING_FEE,
    B.RX_SALES_TAX,
    B.INELIGIBLE_AMOUNT,
    B.HOURS,
    B.EXEMPT_CODE,
    B.RX_PROGRAM_TYPE,
    B.BENEFIT_CODE,
    B.BENEFIT_CODE_DESCRIPTION,
    B.PATIENT_RESPONSIBILITY_AMOUNT,
    B.ROWNUMBER,
    B.HASHKEY
 FROM
(
    SELECT
    B.CLAIM_ID,
    B.ADJUSTMENT_TYPE,
    B.PAID_DATE,
    B.NET_PAYMENT_AMOUNT,
    B.SOURCEFILENAME,
    B.RECEIVEDMONTH,
    B.IMPORTEDDATE,
    B.FILEID,
    B.CLAIM_LINE_NUMBER,
    B.PROCEDURE_CODE,
    B.SUBMITTED_AMOUNT,
    B.COPAY_AMOUNT,
    B.OVERPAYMENT_AMOUNT,
    B.UNITS,
    B.DAYS_OF_SERVICE,
    B.ALLOWED_AMOUNT,
    B.COINSURANCE_AMOUNT,
    B.DEDUCTIBLE_AMOUNT,
    B.DISCOUNT_AMOUNT,
    B.COB_SAVINGS_AMOUNT,
    B.PRECERT_PENALTY_AMOUNT,
    B.RX_QUANTITY,
    B.RX_DAYS_SUPPLY,
    B.RX_INGREDIENT_COST,
    B.RX_DISPENSING_FEE,
    B.RX_SALES_TAX,
    B.INELIGIBLE_AMOUNT,
    B.HOURS,
    B.EXEMPT_CODE,
    B.RX_PROGRAM_TYPE,
    B.BENEFIT_CODE,
    B.BENEFIT_CODE_DESCRIPTION,
    B.PATIENT_RESPONSIBILITY_AMOUNT,
    B.ROWNUMBER,
    B.HASHKEY,
    ROW_NUMBER() OVER (PARTITION BY B.CLAIM_ID,B.PAID_DATE,B.ADJUSTMENT_TYPE ORDER BY IMPORTEDDATE DESC, ROWNUMBER DESC) RN
    FROM
    HI0826001.HI_CLAIMS_MRTN_107_'||EMPID||' B
    WHERE
      CLAIM_TYPE_CODE=''R''
    AND
      BENEFIT_CODE=''94V''
) B
WHERE
RN=1
';

  BEGIN
    EXECUTE IMMEDIATE vbQuery;
	  EXCEPTION WHEN OTHERS THEN xp_scrubStatusLog ('ZZZ_OOP_RX_MERITAIN_'||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
  END;
	COMMIT;

----Main Table
 BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ZZZ_RX_MERITAIN_107_'||EMPID||' PURGE';
	  EXCEPTION WHEN OTHERS THEN NULL;
	END;


vbQuery:=
'CREATE TABLE ZZZ_RX_MERITAIN_107_'||EMPID||' AS
SELECT
  A.ROWID AS SRCROWID,
  A.INSUREDS_ID,
  A.INSUREDS_FIRST_NAME,
  A.INSUREDS_LAST_NAME,
  A.PATIENT_FIRST_NAME,
  A.PATIENT_LAST_NAME,
  A.PATIENT_GENDER,
  A.PATIENT_DATE_OF_BIRTH,
  A.DEPENDENT_NUMBER,
  A.PATIENT_RELATIONSHIP,
  A.INSUREDS_ZIP_CODE,
  A.BILLING_PROVIDER_TAX_ID,
  A.BILLING_PROVIDER_NAME,
  A.BILLING_PROVIDER_ADDRESS_1,
  A.BILLING_PROVIDER_ADDRESS_2,
  A.BILLING_PROVIDER_CITY,
  A.BILLING_PROVIDER_STATE,
  A.BILLING_PROVIDER_ZIP,
  A.CLAIM_ID,
  A.CLAIM_TYPE_CODE,
  A.ADJUSTMENT_TYPE,
  A.CLAIM_LINE_NUMBER,
  A.NETWORK_PAID_FLAG,
  A.NETWORK_PROVIDER_FLAG,
  A.PLACE_OF_SERVICE_CODE,
  A.ICD_CODE_TYPE,
  A.PRIMARY_DIAGNOSIS_CODE,
  A.SECONDARY_DIAGNOSIS_CODE,
  A.PROCEDURE_CODE,
  A.UNITS,
  A.MODIFIERS,
  A.TYPE_OF_SERVICE_CODE,
  A.REMARK,
  A.PLAN_COVERAGE_SUFFIX,
  A.DRG_CODE,
  A.RECEIVED_DATE,
  A.SERVICE_FROM_DATE,
  A.SERVICE_TO_DATE,
  A.DAYS_OF_SERVICE,
  A.PAID_DATE,
  A.SUBMITTED_AMOUNT,
  A.ALLOWED_AMOUNT,
  A.COINSURANCE_AMOUNT,
  A.DEDUCTIBLE_AMOUNT,
  A.COPAY_AMOUNT,
  A.DISCOUNT_AMOUNT,
  A.NET_PAYMENT_AMOUNT,
  A.OVERPAYMENT_AMOUNT,
  A.COB_SAVINGS_AMOUNT,
  A.EXEMPT_CODE,
  A.EMPLOYER_ID,
  A.REVENUE_CODE,
  A.PRECERT_PENALTY_AMOUNT,
  A.NPI_RENDERING_PROVIDER,
  A.NPI_BILLING_PROVIDER,
  A.NPI_ATTENDING_PROVIDER,
  A.NPI_REFERRING_PROVIDER,
  A.NPI_FACILITY,
  A.NPI_OPERATING_PROVIDER,
  A.NPI_OTHER_PROVIDER,
  A.RX_DATE_WRITTEN,
  A.RX_PRESCRIPTION_NUMBER,
  A.RX_NEW_OR_REFILL,
  A.RX_CARDHOLDER_NUMBER,
  A.RX_PROGRAM_TYPE,
  A.RX_DRUG_CODE,
  A.RX_DRUG_NAME,
  A.RX_QUANTITY,
  A.RX_DAYS_SUPPLY,
  A.RX_INGREDIENT_COST,
  A.RX_DISPENSING_FEE,
  A.RX_SALES_TAX,
  A.RX_PHARMACY_NUMBER,
  A.RX_PHYSICIANS_DEA_NUMBER,
  A.RX_FORMULARY,
  A.BILLING_PROVIDER_PHONE_NUMBER,
  A.UNUSED1,
  A.UNUSED2,
  A.QUANTITY,
  A.EMPLOYER_GROUP_NAME,
  A.OTHER_DIAGNO_CODES,
  A.PROVIDER_SPECIALTY,
  A.REPRICER_CODE,
  A.REPRICER_NAME,
  A.BENEFIT_CODE,
  A.BENEFIT_CODE_DESCRIPTION,
  A.HOSPITAL_DISCHARGE_STATUS_CODE,
  A.INELIGIBLE_AMOUNT,
  A.PATIENT_RESPONSIBILITY_AMOUNT,
  A.INSURED_ALTERNATE_ID,
  A.INSURED_CARD_ID,
  A.PHYSICIAN_NAME,
  A.HOURS,
  A.RENDERING_PROVIDER_NAME,
  A.RENDERING_PROVIDER_ADDRESS_1,
  A.RENDERING_PROVIDER_ADDRESS_2,
  A.RENDERING_PROVIDER_CITY,
  A.RENDERING_PROVIDER_STATE,
  A.RENDERING_PROVIDER_ZIP,
  A.TYPE_OF_BILL,
  A.COVERAGE_RECORD_DESCRIPTION,
  A.TOOTH_NUMBER,
  A.DEPT,
  A.CHECK_NUMBER,
  A.RX_GENERIC_IND,
  A.RX_MAIL_ORDER_IND,
  A.RX_DAW_IND,
  A.ICD_PROC_CODES,
  A.UDF1,
  A.UDF2,
  A.UDF3,
  A.UDF4,
  A.UDF5,
  A.SOURCEFILENAME,
  A.RECEIVEDMONTH,
  A.IMPORTEDDATE,
  A.CLIENTID,
  A.EMPGRP,
  A.FILEID,
  A.ROWNUMBER,
  A.HASHKEY,
  A.PAYORNAME,
  OOP.ADJUSTMENT_TYPE AS OOP_ADJUSTMENT_TYPE,
  OOP.PAID_DATE AS OOP_PAID_DATE,
  OOP.NET_PAYMENT_AMOUNT AS OOP_NET_PAYMENT_AMOUNT,
  OOP.SOURCEFILENAME AS OOP_SOURCEFILENAME,
  OOP.RECEIVEDMONTH AS OOP_RECEIVEDMONTH,
  OOP.IMPORTEDDATE AS OOP_IMPORTEDDATE,
  OOP.FILEID AS OOP_FILEID,
  OOP.CLAIM_LINE_NUMBER AS OOP_CLAIM_LINE_NUMBER,
  OOP.PROCEDURE_CODE AS OOP_PROCEDURE_CODE,
  OOP.SUBMITTED_AMOUNT AS OOP_SUBMITTED_AMOUNT,
  OOP.COPAY_AMOUNT AS OOP_COPAY_AMOUNT,
  OOP.OVERPAYMENT_AMOUNT AS OOP_OVERPAYMENT_AMOUNT,
  OOP.UNITS AS OOP_UNITS,
  OOP.DAYS_OF_SERVICE AS OOP_DAYS_OF_SERVICE,
  OOP.ALLOWED_AMOUNT AS OOP_ALLOWED_AMOUNT,
  OOP.COINSURANCE_AMOUNT AS OOP_COINSURANCE_AMOUNT,
  OOP.DEDUCTIBLE_AMOUNT AS OOP_DEDUCTIBLE_AMOUNT,
  OOP.DISCOUNT_AMOUNT AS OOP_DISCOUNT_AMOUNT,
  OOP.COB_SAVINGS_AMOUNT AS OOP_COB_SAVINGS_AMOUNT,
  OOP.PRECERT_PENALTY_AMOUNT AS OOP_PRECERT_PENALTY_AMOUNT,
  OOP.RX_QUANTITY AS OOP_RX_QUANTITY,
  OOP.RX_DAYS_SUPPLY AS OOP_RX_DAYS_SUPPLY,
  OOP.RX_INGREDIENT_COST AS OOP_RX_INGREDIENT_COST,
  OOP.RX_DISPENSING_FEE AS OOP_RX_DISPENSING_FEE,
  OOP.RX_SALES_TAX AS OOP_RX_SALES_TAX,
  OOP.INELIGIBLE_AMOUNT AS OOP_INELIGIBLE_AMOUNT,
  OOP.HOURS AS OOP_HOURS,
  OOP.EXEMPT_CODE AS OOP_EXEMPT_CODE,
  OOP.RX_PROGRAM_TYPE AS OOP_RX_PROGRAM_TYPE,
  OOP.BENEFIT_CODE AS OOP_BENEFIT_CODE,
  OOP.BENEFIT_CODE_DESCRIPTION AS OOP_BENEFIT_CODE_DESCRIPTION,
  OOP.PATIENT_RESPONSIBILITY_AMOUNT AS OOP_PATIENT_RESPONSIBILITY_AMT,
  OOP.ROWNUMBER AS OOP_ROWNUMBER,
  OOP.HASHKEY AS OOP_HASHKEY
FROM
HI0826001.HI_CLAIMS_MRTN_107_'||EMPID||' A
LEFT JOIN
ZZZ_OOP_RX_MERITAIN_107_'||EMPID||' OOP
ON
  A.CLAIM_ID=OOP.CLAIM_ID
AND
  A.PAID_DATE=OOP.PAID_DATE
AND
NVL(A.ADJUSTMENT_TYPE,''BLANK'')=NVL(OOP.ADJUSTMENT_TYPE,''BLANK'')
WHERE
  A.CLAIM_TYPE_CODE=''R''
AND
  A.BENEFIT_CODE<>''94V''
';

 BEGIN
    EXECUTE IMMEDIATE vbQuery;
	  EXCEPTION WHEN OTHERS THEN xp_scrubStatusLog ('ZZZ_RX_MERITAIN_107_'||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'ELIG','','E');
  END;
	COMMIT;

VBQUERY := 'DROP TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_107_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_107_CSTM AS
		SELECT
			SOURCE,
			MEMID,
			ENRID,
			LVLID1,
			LVLDESC1,
			LVLID3,
			LVLDESC3,
      ALLOWEDAMT,
		  ENRPAIDAMT,
		  COINSAMT,
		  COPAYAMT,
		  DEDUCTAMT,
      PRESCOUNT,
      UDFC20,
      UDFN19,
		  UDFN20,
			PRODUCTID
		FROM
			VH_RXCLAIMS
		WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('RX TABLE CREATE MERITAIN CSTM',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_107_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_107_CSTM ADD PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_4942_RX_MRTN('HI0826001','HI_CLAIMS_MRTN_107_'||EMPID||'','RXCLAIMS','VH_RXCLAIMS_'||vLvl.SERIALNO||'_107_COMM');
exception when others then
xp_scrubStatusLog ('RX-COMM MERITAIN 107',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4942_RX_MRTN','','E');
end;

COMMIT;


vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_107_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID3,
		LVLDESC3,
    ALLOWEDAMT,
		ENRPAIDAMT,
		COINSAMT,
		COPAYAMT,
		DEDUCTAMT,
    PRESCOUNT,
    UDFC20,
    UDFN19,
		UDFN20,
		PRODUCTID

	)
	SELECT /*+ PARALLEL(a,4) */
		 a.SRCROWID AS SRCROWID,
		 ''MERITAIN'' AS source,';

	IF EMPID = 'BTLR' THEN
	vbQuery:= vbQuery||'
	COALESCE(mem.memid,a.INSUREDS_ID||DECODE(UPPER(a.PATIENT_GENDER),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.PATIENT_DATE_OF_BIRTH,''YYYYMMDD'')) AS MEMID,
	COALESCE(mem.enrid,a.INSUREDS_ID) AS ENRID,
	';
    ELSE
	vbQuery:= vbQuery||'
	a.INSUREDS_ID||DECODE(UPPER(a.PATIENT_GENDER),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.PATIENT_DATE_OF_BIRTH,''YYYYMMDD'') AS MEMID,
	a.INSUREDS_ID  AS ENRID,';
	END IF;
    vbQuery:= vbQuery||'

		 ''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		NVL(lvl3.ROLLUPID,a.employer_id) AS LVLID3,
		NVL(lvl3.GROUP_NAME,a.employer_id) AS LVLDESC3,
    Nvl(a.NET_PAYMENT_AMOUNT,0) + Nvl(a.OOP_COPAY_AMOUNT,0) +Nvl(a.OOP_COINSURANCE_AMOUNT ,0) + Nvl(a.OOP_DEDUCTIBLE_AMOUNT,0)   AS ALLOWEDAMT,
		a.OOP_PATIENT_RESPONSIBILITY_AMT AS ENRPAIDAMT,
		a.OOP_COINSURANCE_AMOUNT AS COINSAMT,
		a.OOP_COPAY_AMOUNT AS COPAYAMT,
		a.OOP_DEDUCTIBLE_AMOUNT AS DEDUCTAMT,
    CASE WHEN (Nvl(a.NET_PAYMENT_AMOUNT,0) + Nvl(a.OOP_COPAY_AMOUNT ,0) + Nvl(a.OOP_COINSURANCE_AMOUNT,0) + Nvl(a.OOP_DEDUCTIBLE_AMOUNT,0)) > 0 THEN 1
		  WHEN (Nvl(a.NET_PAYMENT_AMOUNT,0) + Nvl(a.OOP_COPAY_AMOUNT ,0) + Nvl(a.OOP_COINSURANCE_AMOUNT,0) + Nvl(a.OOP_DEDUCTIBLE_AMOUNT,0)) = 0 THEN 0
		  ELSE -1 END AS PRESCOUNT,
      A.BENEFIT_CODE AS UDFC20,
      A.OOP_OVERPAYMENT_AMOUNT AS UDFN19,
		  A.OVERPAYMENT_AMOUNT AS UDFN20,
		''1'' AS PRODUCTID
	FROM
		ZZZ_RX_MERITAIN_107_'||EMPID||'  A
	LEFT JOIN
		ZZZ_PYR_DEA DEA
	ON
		a.RX_PHYSICIANS_DEA_NUMBER = DEA.DEAID
	LEFT JOIN
		HR_826_GROUP LVL3
	ON
		substr(a.EMPLOYER_ID,1,5) = LVL3.SRC_CODE';
	IF EMPID = 'BTLR' THEN
		vbQuery:= vbQuery||'
		LEFT JOIN
		zzz_memid_update_meritain2 mem
	  on
	  UPPER(Nvl(SubStr(a.PATIENT_FIRST_NAME,1,InStr(a.PATIENT_FIRST_NAME,'' '')-1),a.PATIENT_FIRST_NAME))  = mem.MEMFIRSTNAME
	  AND
	  UPPER(a.PATIENT_LAST_NAME) = mem.MEMLASTNAME
	  AND
	  DECODE(UPPER(a.PATIENT_GENDER),''M'',''M'',''F'',''F'',''U'') = mem.GENDER
	  AND
	  a.PATIENT_DATE_OF_BIRTH = mem.DOB         --ICE263783
	  ';
	END IF;
	 vbQuery:= vbQuery||'
		WHERE
			NVL(UPPER(a.CLAIM_TYPE_CODE),''NULL'') = ''R''
		OR
			a.PLACE_OF_SERVICE_CODE=''01''
	';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('RX-CSTM MERITAIN 107 ',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_CLAIMS_MRTN_107_'||EMPID,'Y','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('RX-CSTM MERITAIN 107 ',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'HI_CLAIMS_MRTN_107_'||EMPID,'','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'RX-MERGE MERITAIN 107 ','VH_RXCLAIMS_'||vLvl.SERIALNO||'_107_COMM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_107_CSTM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_MERT_107');
exception when others then
xp_scrubStatusLog ('RX-MERGE MERITAIN 107 ',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

--------------------------------------------------------------------------------------------------------------------------------
VBQUERY:='INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_RXCLAIMS_'||vLvl.SERIALNO||'_MERT_107';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('MERITAIN 107 RX FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'CLAIMS','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('MERITAIN 107 RX FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;

--------------------------------------------END OF ICE 329984-----------------------------------------------------------------------------------


 BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
	FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
	TO_TABLENAME =>	 'VH_RXCLAIMS_'||vLvl.SERIALNO||'',
	UPDATE_STATUS_FIELDNAME =>	  NULL,
	DELIMITER =>		'-',
	UPDATE_PASSES =>	'1-2',
	LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
	LVL_DESC_YN =>	  'Y',
	PASS_1_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3 AND [a.source]=[b.source]',
	PASS_1_UPDATE_CONDITION =>	'[a.source] in (''MERITAIN'',''MERITAIN_107'')',
	PASS_2_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3 AND [a.source]=[b.source]'  ,
	PASS_2_UPDATE_CONDITION =>	  '[a.LVLID2] IS NULL and [a.source] in (''MERITAIN'',''MERITAIN_107'') AND [b.source]=''MERITAIN''',
	PASS_3_JOIN_CONDITION =>	NULL,
	PASS_3_UPDATE_CONDITION =>	NULL,
	PASS_4_JOIN_CONDITION =>	NULL,
	PASS_4_UPDATE_CONDITION =>	NULL,
	BEGIN_END_DTE_YN =>	 'N',
	STABLE_FROM_TABLE_YN =>	 'N',
	ORDER_BY_LIST =>	NULL
	);
END;

--/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.filldate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.filldate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.filldate ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('MERITAIN RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('MERITAIN RXCLAIMS Planname and Plantype UPDATE PASS 2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.ENRID=d.ENRID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
    UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE   c.planname IS NULL';
---------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('MERITAIN RXCLAIMS Planname and Plantype UPDATE PASS 3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------


END IF;

--------  #194051 END OF MERTITAIN RX  -----------------------------------------------------------------------------------------
-------------------------------------- #KROGER RX #204292 STARTS ---------------------------------------

IF  vLvl.PAYER='KROG' OR vLvl.PAYER = 'KROG_286' THEN


IF  vLvl.PAYER='KROG' THEN

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ZZZ_KROG_MEMID_UPDATE CASCADE CONSTRAINTS';
  EXCEPTION
    WHEN Others THEN NULL;
 END;


  vbquery:=
  'CREATE TABLE ZZZ_KROG_MEMID_UPDATE as
  SELECT * from
	  (SELECT
		MEMFIRSTNAME, MEMLASTNAME,DOB,MEMID, ENRID, GENDER,
		ROW_NUMBER() OVER(PARTITION BY MEMFIRSTNAME, MEMLASTNAME, DOB ORDER BY RCVMTH DESC) RN
  FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||') a
	WHERE rn = 1';

 EXECUTE IMMEDIATE vbquery;

VBQUERY := 'DROP TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM AS
							  SELECT
								SOURCE,
								MEMID,
								ENRID,
								LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								LVLID4,
								LVLDESC4,
								PLANNAME,
								PLANTYPE,
								PAIDDATE,
								PAIDAMT,
								PRODUCTID,
								UDFC19
						   FROM
								VH_RXCLAIMS
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('RX TABLE CREATE KROGER CSTM',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_RX_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_4189_RX_KROG('HI0826001','HI_RX_KROG_'||EMPID||'','RXCLAIMS','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM');
exception when others then
xp_scrubStatusLog ('RX-COMM KROGER ',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4189_RX_KROG','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		PAIDDATE, --ICE258174
		PAIDAMT,  --ICE258174
		PRODUCTID,
		UDFC19
	)
	SELECT /*+ PARALLEL(a,4) */
		 a.ROWID AS SRCROWID,
		 ''KROGER'' AS source,
		 NVL(X.MEMID,a.CARDHOLDER||DECODE(a.SEXCODE,''1'',''M'',''2'',''F'',''U'')||TO_CHAR(a.BIRTHDTE,''YYYYMMDD'')) AS MEMID,
		 NVL(X.enrid,a.CARDHOLDER) AS ENRID,
		 ''C'' AS LVL1ID,
		 ''Commercial'' AS LVL1Desc,
		  NULL AS LVL2ID,
		  NULL AS LVL2Desc,
		  NVL(lvl3.ROLLUPID,a.GROUPID) LVL3ID,
		  NVL(lvl3.GROUP_NAME,a.GROUPID)  AS LVL3Desc,
		  NULL  AS LVLID4,
		  NULL AS LVLDesc4,
      NVL(a.ORGPDSBMDT, a.DATESBM) AS PAIDDATE,--ICE258174
      a.CLTDUEAMT AS PAIDAMT, --ICE258174
		  ''1'' AS PRODUCTID,
		  ''HI_RX_KROG_'||EMPID||''' AS UDFC19
	FROM
		HI0826001.HI_RX_KROG_'||EMPID||'  A
	LEFT JOIN
		HR_826_GROUP LVL3
	ON
		a.GROUPID = LVL3.SRC_CODE
	LEFT JOIN
		ZZZ_KROG_MEMID_UPDATE X
	ON
		UPPER(a.MBRFSTNME) = X.MEMFIRSTNAME
	AND
		UPPER(a.MBRLSTNME) =X.MEMLASTNAME
	AND
		a.BIRTHDTE=X.DOB
	AND
		DECODE(a.SEXCODE,''1'',''M'',''2'',''F'',''U'') =X.GENDER
  WHERE
    (CASE WHEN NVL(lvl3.ROLLUPID,a.GROUPID) = ''COMA'' THEN a.CLAIMSTS ELSE ''1'' END) <> ''R''      --ICE258174
  AND
    (CASE WHEN NVL(lvl3.ROLLUPID,a.GROUPID) = ''COMA'' THEN a.mbrplan ELSE ''KG0502'' END) = ''KG0502''    --ICE258174
	';
	if EMPID='SCGR' then vbQuery:=vbQuery||'AND
	a.ORGPDSBMDT IS NOT NULL'; end if;
--ice295759
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('RX-CSTM KROGER',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('RX-CSTM KROGER',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'RX','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'RX-MERGE KROGER','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_KROG');
exception when others then
xp_scrubStatusLog ('RX-MERGE KROGER',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

---------------------------------- Start of Insert of  ANTHEMR CA OR dropped data back ---------------------------------------------------------------

VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
(source, sn, transnum, seqno, datetimestamp, memid, enrid, relflag, memfirstname, memlastname, gender, dob, addr1, addr2, city, state, zip, homephone, workphone, lvlid1, lvldesc1, lvlid2, lvldesc2, lvlid3, lvldesc3, lvlid4, lvldesc4, lvlid5, lvldesc5, lvlid6, lvldesc6, lvlid7, lvldesc7, lvlid8, lvldesc8, lvlid9, lvldesc9, lvlid10,
lvldesc10, filldate, paiddate, metricquantity, dayssupply, drugcode, drugdesc, drugstrength, formulary_yn, moi, prescriberid, prescribertype, prescribername, pharmid, pharmname, pharmzipcode, paidamt, billedamt, ingredcost, dispensingcost, salestax, allowedamt, enrpaidamt, coinsamt, copayamt, deductamt, notallowedamt, admfees, awp, cobamt, adjcode, siccode, sicdesc, claimstatus, supplyflag,
discountamt, prescount, ssn, rcvmth, srcfilename, udf1, udfm1, udf2, udfm2, udf3, udf4, udf5, udf6, udf7, udf8, udf9, udfc1, udfc2, udfc3, udfc4, udfc5, udfc6, udfc7, udfc8, udfc9, udfc10, udfc11, udfc12, udfc13, udfc14, udfc15, udfc16, udfc17, udfc18, udfc19, udfc20, udfd1, udfd2, udfd3, udfd4, udfd5, udfn1, udfn2, udfn3, udfn4, udfn5, udfn6, udfn7, udfn8, udfn9, udfn10, udfn11, udfn12,
udfn13, udfn14, udfn15, udfn16, udfn17, udfn18, udfn19, udfn20, vh_lvl_id, emp_nbr, medeligcatid, productid, vhpayorid, vhlayoutid, qty_disp, srcrelflag, aifileid,
airownumber, vhpayername, vhgroupname, compoundind, specialtyind, pharmnabpnum, plannumber, planname, plantype, populationtype, enrollment_source)
SELECT source, sn, transnum, seqno, datetimestamp, memid, enrid, relflag, memfirstname, memlastname, gender, dob, addr1, addr2, city, state, zip, homephone, workphone, lvlid1, lvldesc1, lvlid2, lvldesc2, lvlid3, lvldesc3, lvlid4, lvldesc4, lvlid5, lvldesc5, lvlid6, lvldesc6, lvlid7, lvldesc7, lvlid8, lvldesc8, lvlid9, lvldesc9, lvlid10,
lvldesc10, filldate, paiddate, metricquantity, dayssupply, drugcode, drugdesc, drugstrength, formulary_yn, moi, prescriberid, prescribertype, prescribername, pharmid, pharmname, pharmzipcode, paidamt, billedamt, ingredcost, dispensingcost, salestax, allowedamt, enrpaidamt, coinsamt, copayamt, deductamt, notallowedamt, admfees, awp, cobamt, adjcode, siccode, sicdesc, claimstatus, supplyflag, discountamt,
prescount, ssn, rcvmth, srcfilename, udf1, udfm1, udf2, udfm2,
udf3, udf4, udf5, udf6, udf7, udf8, udf9, udfc1, udfc2, udfc3, udfc4, udfc5, udfc6, udfc7, udfc8, udfc9, udfc10, udfc11, udfc12, udfc13, udfc14, udfc15, udfc16, udfc17, udfc18, udfc19, udfc20, udfd1, udfd2, udfd3, udfd4, udfd5, udfn1, udfn2, udfn3, udfn4, udfn5, udfn6, udfn7, udfn8, udfn9, udfn10, udfn11, udfn12, udfn13, udfn14, udfn15, udfn16, udfn17, udfn18, udfn19, udfn20, vh_lvl_id, emp_nbr, medeligcatid,
productid, vhpayorid, vhlayoutid, qty_disp, srcrelflag, aifileid,
airownumber, vhpayername, vhgroupname, compoundind, specialtyind, pharmnabpnum, plannumber, planname, plantype, populationtype, enrollment_source
FROM VH_RXCLAIMS_'||vLvl.SERIALNO||'_KROG';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('KROGER RX FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('KROGER RX FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'RX','','E');
END;
COMMIT;

-------------------------------------- #KROG_286 RX #244605 STARTS ---------------------------------------
ELSIF  vLvl.PAYER='KROG_286' THEN
---ICE#287515
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ZZZ_KROG_MEMID_UPDATE_'||EMPID||' CASCADE CONSTRAINTS';
  EXCEPTION
    WHEN Others THEN NULL;
 END;


  vbquery:=
  'CREATE TABLE ZZZ_KROG_MEMID_UPDATE_'||EMPID||' as
  SELECT * from
	  (SELECT
		MEMFIRSTNAME, MEMLASTNAME,DOB,MEMID, ENRID, GENDER,
		ROW_NUMBER() OVER(PARTITION BY MEMFIRSTNAME, MEMLASTNAME, DOB ORDER BY RCVMTH DESC) RN
  FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||') a
	WHERE rn = 1';

 EXECUTE IMMEDIATE vbquery;

VBQUERY := 'DROP TABLE VH_RXCLAIMS_286_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_RXCLAIMS_286_'||vLvl.SERIALNO||'_CSTM AS
							  SELECT
								SOURCE,
								MEMID,
								ENRID,
								LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								LVLID4,
								LVLDESC4,
								PRODUCTID,
								UDFC19
						   FROM
								VH_RXCLAIMS
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('RX TABLE CREATE KROG_286 CSTM',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_RXCLAIMS_286_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_RXCLAIMS_286_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTM_RX_286_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_4668_RX_KROG('HI0826001','HI_RX_KROG_286_'||EMPID||'','RXCLAIMS','VH_RXCLAIMS_286_'||vLvl.SERIALNO||'_COMM');
exception when others then
xp_scrubStatusLog ('RX-COMM KROG_286',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4668_RX_KROG','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_RXCLAIMS_286_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		PRODUCTID,
		UDFC19
	)
	SELECT /*+ PARALLEL(a,4) */
		a.ROWID AS SRCROWID,
		''KROGER'' AS source,
		NVL(X.MEMID,SUBSTR(a.SOCIAL_SECURITY_NUMBER,1,9)||DECODE(UPPER(a.GENDER),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.DATE_OF_BIRTH,''YYYYMMDD'')) AS MEMID,
		NVL(X.enrid,SUBSTR(a.SOCIAL_SECURITY_NUMBER,1,9)) AS ENRID,
		''C'' AS LVL1ID,
		''Commercial'' AS LVL1Desc,
		NULL AS LVL2ID,
		NULL AS LVL2Desc,';
		IF EMPID='CIST' THEN
		vbQuery:=vbQuery||'
		COALESCE(lvln3.ROLLUPID,a.group_number) LVL3ID,
		COALESCE(lvln3.GROUP_NAME,a.group_number)  AS LVL3Desc,
		';
		ELSE
		vbQuery:=vbQuery||'
		COALESCE(LVL3.ROLLUPID,a.group_number) LVL3ID,
		COALESCE(LVL3.GROUP_NAME,a.group_number)  AS LVL3Desc,
		';
		END IF;
		vbQuery:=vbQuery||'
		NULL  AS LVLID4,
		NULL AS LVLDesc4,
		''1'' AS PRODUCTID,
		''HI_RX_KROG_286_'||EMPID||''' AS UDFC19
	FROM
		HI0826001.HI_RX_KROG_286_'||EMPID||'  A
	LEFT JOIN
		HR_826_GROUP LVLN3
	ON
		a.CLIENT_HQ_CODE  = LVLN3.SRC_CODE
	LEFT JOIN
		HR_826_GROUP LVL3
	ON
		a.group_number = LVL3.SRC_CODE
	LEFT JOIN
		ZZZ_KROG_MEMID_UPDATE_'||EMPID||' X
	ON
		UPPER(a.FIRST_NAME) = X.MEMFIRSTNAME
	AND
		UPPER(a.LAST_NAME) =X.MEMLASTNAME
	AND
		a.DATE_OF_BIRTH=X.DOB
	AND
		DECODE(UPPER(a.GENDER),''M'',''M'',''F'',''F'',''U'') =X.GENDER
  WHERE
		NVL(a.CLAIM_STATUS_CODE,''NULL'') = ''1''
	AND
		NVL(a.PERSON_CODE,''NULL'')<>''-1''
'
	 ;
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('RX-CSTM KROG_286',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('RX-CSTM KROG_286',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'RX','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'RX-MERGE KROG_286','VH_RXCLAIMS_286_'||vLvl.SERIALNO||'_COMM','VH_RXCLAIMS_286_'||vLvl.SERIALNO||'_CSTM','VH_RXCLAIMS_286_'||vLvl.SERIALNO||'_KROG');
exception when others then
xp_scrubStatusLog ('RX-MERGE KROG_286',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

---------------------------------- Start of Insert of  ANTHEMR CA OR dropped data back ---------------------------------------------------------------

VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
(source, sn, transnum, seqno, datetimestamp, memid, enrid, relflag, memfirstname, memlastname, gender, dob, addr1, addr2, city, state, zip, homephone, workphone, lvlid1, lvldesc1, lvlid2, lvldesc2, lvlid3, lvldesc3, lvlid4, lvldesc4, lvlid5, lvldesc5, lvlid6, lvldesc6, lvlid7, lvldesc7, lvlid8, lvldesc8, lvlid9, lvldesc9, lvlid10,
lvldesc10, filldate, paiddate, metricquantity, dayssupply, drugcode, drugdesc, drugstrength, formulary_yn, moi, prescriberid, prescribertype, prescribername, pharmid, pharmname, pharmzipcode, paidamt, billedamt, ingredcost, dispensingcost, salestax, allowedamt, enrpaidamt, coinsamt, copayamt, deductamt, notallowedamt, admfees, awp, cobamt, adjcode, siccode, sicdesc, claimstatus, supplyflag,
discountamt, prescount, ssn, rcvmth, srcfilename, udf1, udfm1, udf2, udfm2, udf3, udf4, udf5, udf6, udf7, udf8, udf9, udfc1, udfc2, udfc3, udfc4, udfc5, udfc6, udfc7, udfc8, udfc9, udfc10, udfc11, udfc12, udfc13, udfc14, udfc15, udfc16, udfc17, udfc18, udfc19, udfc20, udfd1, udfd2, udfd3, udfd4, udfd5, udfn1, udfn2, udfn3, udfn4, udfn5, udfn6, udfn7, udfn8, udfn9, udfn10, udfn11, udfn12,
udfn13, udfn14, udfn15, udfn16, udfn17, udfn18, udfn19, udfn20, vh_lvl_id, emp_nbr, medeligcatid, productid, vhpayorid, vhlayoutid, qty_disp, srcrelflag, aifileid,
airownumber, vhpayername, vhgroupname, compoundind, specialtyind, pharmnabpnum, plannumber, planname, plantype, populationtype, enrollment_source)
SELECT source, sn, transnum, seqno, datetimestamp, memid, enrid, relflag, memfirstname, memlastname, gender, dob, addr1, addr2, city, state, zip, homephone, workphone, lvlid1, lvldesc1, lvlid2, lvldesc2, lvlid3, lvldesc3, lvlid4, lvldesc4, lvlid5, lvldesc5, lvlid6, lvldesc6, lvlid7, lvldesc7, lvlid8, lvldesc8, lvlid9, lvldesc9, lvlid10,
lvldesc10, filldate, paiddate, metricquantity, dayssupply, drugcode, drugdesc, drugstrength, formulary_yn, moi, prescriberid, prescribertype, prescribername, pharmid, pharmname, pharmzipcode, paidamt, billedamt, ingredcost, dispensingcost, salestax, allowedamt, enrpaidamt, coinsamt, copayamt, deductamt, notallowedamt, admfees, awp, cobamt, adjcode, siccode, sicdesc, claimstatus, supplyflag, discountamt,
prescount, ssn, rcvmth, srcfilename, udf1, udfm1, udf2, udfm2,
udf3, udf4, udf5, udf6, udf7, udf8, udf9, udfc1, udfc2, udfc3, udfc4, udfc5, udfc6, udfc7, udfc8, udfc9, udfc10, udfc11, udfc12, udfc13, udfc14, udfc15, udfc16, udfc17, udfc18, udfc19, udfc20, udfd1, udfd2, udfd3, udfd4, udfd5, udfn1, udfn2, udfn3, udfn4, udfn5, udfn6, udfn7, udfn8, udfn9, udfn10, udfn11, udfn12, udfn13, udfn14, udfn15, udfn16, udfn17, udfn18, udfn19, udfn20, vh_lvl_id, emp_nbr, medeligcatid,
productid, vhpayorid, vhlayoutid, qty_disp, srcrelflag, aifileid,
airownumber, vhpayername, vhgroupname, compoundind, specialtyind, pharmnabpnum, plannumber, planname, plantype, populationtype, enrollment_source
FROM VH_RXCLAIMS_286_'||vLvl.SERIALNO||'_KROG';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('KROG_286 RX FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('KROG_286 RX FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'RX','','E');
END;
COMMIT;

END IF;
----------------------------------------  #244605 END OF KROG_286 RX  -------------------------------------------------------------------------

 BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
	FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
	TO_TABLENAME =>	 'VH_RXCLAIMS_'||vLvl.SERIALNO||'',
	UPDATE_STATUS_FIELDNAME =>	  NULL,
	DELIMITER =>		'-',
	UPDATE_PASSES =>	'1-2-4',
	LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
	LVL_DESC_YN =>	  'Y',
	PASS_1_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3',
	PASS_1_UPDATE_CONDITION =>	'[a.source]=''KROGER''',
	PASS_2_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3'  ,
	PASS_2_UPDATE_CONDITION =>	  '[a.LVLID2] IS NULL and [a.source]=''KROGER''',
	PASS_3_JOIN_CONDITION =>	NULL,
	PASS_3_UPDATE_CONDITION =>	NULL,
	PASS_4_JOIN_CONDITION =>	NULL,
	PASS_4_UPDATE_CONDITION =>	NULL,
	BEGIN_END_DTE_YN =>	 'N',
	STABLE_FROM_TABLE_YN =>	 'N',
	ORDER_BY_LIST =>	NULL
	);
END;

--/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.filldate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.filldate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.filldate ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('KROGER RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('KROGER RXCLAIMS Planname and Plantype UPDATE PASS 2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.ENRID=d.ENRID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
    UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE   c.planname IS NULL';
---------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('KROGER RXCLAIMS Planname and Plantype UPDATE PASS 3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------


END IF;

--------  #204292 END OF kroger RX  -----------------------------------------------------------------------------------------
-------------------------------------- #MMOH RX #223054 STARTS ---------------------------------------

IF  vLvl.PAYER='MMOH' THEN

VBQUERY := 'DROP TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM AS
							  SELECT
								SOURCE,
								LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								LVLID4,
								LVLDESC4,
								PRODUCTID,
								MEMID,--ICE-5643
								ENRID--ICE-5643
						   FROM
								VH_RXCLAIMS
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('RX TABLE CREATE MMOH CSTM',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_RX_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_4587_RX_MMOH('HI0826001','HI_RX_MMOH_'||EMPID||'','RXCLAIMS','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM');     --ICE240306
exception when others then
xp_scrubStatusLog ('RX-COMM MMOH ',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4021_RX_MMOH','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		PRODUCTID,
		MEMID,--ICE-5643
		ENRID--ICE-5643
	)
	SELECT /*+ PARALLEL(a,4) */
		  a.ROWID AS SRCROWID,
		  ''MMOH'' AS source,
		  ''C'' AS LVL1ID,
		  ''Commercial'' AS LVL1Desc,
		  NULL AS LVL2ID,
		  NULL AS LVL2Desc,
		  NVL(lvl3.ROLLUPID,SubStr(a.GROUP_BASE,1,6)) LVL3ID,
		  NVL(lvl3.GROUP_NAME,SubStr(a.GROUP_BASE,1,6))  AS LVL3Desc,
		  NULL  AS LVLID4,
		  NULL AS LVLDesc4,
		  ''1'' AS PRODUCTID,
		 ';
IF EMPID IN ('MEVS', 'ESCC', 'CSCC') THEN
	vbQuery := vbQuery||'		 COALESCE(MEMUPD.MEMID,TWINS.MEMID,SUBSTR(a.SUB_ID,1,9)||DECODE(a.PAT_SEX,''1'',''M'',''2'',''F'',''U'') || To_Char(a.PAT_BIRTHDT,''YYYYMMDD'') ||CASE WHEN LVL3.memid_grp_flag=''Y'' THEN ''-''||lvl3.ROLLUPID END)
	';
		ELSE
		vbQuery:=vbQuery||'
		SUBSTR(a.SUB_ID,1,9)||DECODE(a.PAT_SEX,''1'',''M'',''2'',''F'',''U'') || To_Char(a.PAT_BIRTHDT,''YYYYMMDD'') ||CASE WHEN LVL3.memid_grp_flag=''Y'' THEN ''-''||lvl3.ROLLUPID END
		';
	END IF;
	vbQuery := vbQuery||'
	AS MEMID,
	';
IF EMPID IN ('MEVS', 'ESCC', 'CSCC') THEN
	vbQuery := vbQuery||'
		  COALESCE(MEMUPD.ENRID,SUBSTR(a.SUB_ID,1,9)||CASE WHEN LVL3.memid_grp_flag=''Y'' THEN ''-''||lvl3.ROLLUPID END)
	';
		ELSE
		vbQuery:=vbQuery||'
		SUBSTR(a.SUB_ID,1,9)||CASE WHEN LVL3.memid_grp_flag=''Y'' THEN ''-''||lvl3.ROLLUPID END
		';
	END IF;
	vbQuery := vbQuery||'
	AS ENRID
	FROM
		HI0826001.HI_RX_MMOH_'||EMPID||'  A
	LEFT JOIN
		HR_826_GROUP LVL3
	ON
		--SubStr(a.GROUP_BASE,1,6)  = LVL3.SRC_CODE
		 CASE WHEN '''||EMPID||''' IN   (''ESCC'',''CSCC'') THEN A.GROUP_NBR ELSE SubStr(A.GROUP_BASE,1,6) END = LVL3.SRC_CODE

	';
	IF EMPID IN ('MEVS', 'ESCC', 'CSCC') THEN
	vbQuery := vbQuery||'
	LEFT JOIN
		ZZZ_E2C_E2R_MEMUPD_'||EMPID||'_MMOH MEMUPD--ICE-5643
	ON
		Upper(a.PAT_FNAME) = MEMUPD.MEMFIRSTNAME
	AND
		Upper(a.PAT_LNAME)= MEMUPD.MEMLASTNAME
	AND
		DECODE(a.PAT_SEX,''1'',''M'',''2'',''F'',''U'')= MEMUPD.GENDER
	AND
		a.PAT_BIRTHDT = MEMUPD.DOB
	AND
		NVL(lvl3.ROLLUPID,SubStr(a.GROUP_BASE,1,6))= MEMUPD.LVLID3
	LEFT JOIN
		ZZZ_MMOH_'||EMPID||'_TWIN TWINS--ICE-5643
	ON
		Upper(a.PAT_FNAME) = TWINS.MEMFIRSTNAME
	AND
		Upper(a.PAT_LNAME)= TWINS.MEMLASTNAME
	AND
		DECODE(a.PAT_SEX,''1'',''M'',''2'',''F'',''U'')= TWINS.GENDER
	AND
		a.PAT_BIRTHDT = TWINS.DOB
	AND
		NVL(lvl3.ROLLUPID,SubStr(a.GROUP_BASE,1,6))= TWINS.LVLID3

	';
	END IF;
	vbQuery := vbQuery||'
	';
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('RX-CSTM MMOH',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('RX-CSTM MMOH',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'RX','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'RX-MERGE MMOH','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_MMOH');
exception when others then
xp_scrubStatusLog ('RX-MERGE MMOH',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

---------------------------------- Start of Insert of  ANTHEMR CA OR dropped data back ---------------------------------------------------------------

VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
(source, sn, transnum, seqno, datetimestamp, memid, enrid, relflag, memfirstname, memlastname, gender, dob, addr1, addr2, city, state, zip, homephone, workphone, lvlid1, lvldesc1, lvlid2, lvldesc2, lvlid3, lvldesc3, lvlid4, lvldesc4, lvlid5, lvldesc5, lvlid6, lvldesc6, lvlid7, lvldesc7, lvlid8, lvldesc8, lvlid9, lvldesc9, lvlid10,
lvldesc10, filldate, paiddate, metricquantity, dayssupply, drugcode, drugdesc, drugstrength, formulary_yn, moi, prescriberid, prescribertype, prescribername, pharmid, pharmname, pharmzipcode, paidamt, billedamt, ingredcost, dispensingcost, salestax, allowedamt, enrpaidamt, coinsamt, copayamt, deductamt, notallowedamt, admfees, awp, cobamt, adjcode, siccode, sicdesc, claimstatus, supplyflag,
discountamt, prescount, ssn, rcvmth, srcfilename, udf1, udfm1, udf2, udfm2, udf3, udf4, udf5, udf6, udf7, udf8, udf9, udfc1, udfc2, udfc3, udfc4, udfc5, udfc6, udfc7, udfc8, udfc9, udfc10, udfc11, udfc12, udfc13, udfc14, udfc15, udfc16, udfc17, udfc18, udfc19, udfc20, udfd1, udfd2, udfd3, udfd4, udfd5, udfn1, udfn2, udfn3, udfn4, udfn5, udfn6, udfn7, udfn8, udfn9, udfn10, udfn11, udfn12,
udfn13, udfn14, udfn15, udfn16, udfn17, udfn18, udfn19, udfn20, vh_lvl_id, emp_nbr, medeligcatid, productid, vhpayorid, vhlayoutid, qty_disp, srcrelflag, aifileid,
airownumber, vhpayername, vhgroupname, compoundind, specialtyind, pharmnabpnum, plannumber, planname, plantype, populationtype, enrollment_source)
SELECT source, sn, transnum, seqno, datetimestamp, memid, enrid, relflag, memfirstname, memlastname, gender, dob, addr1, addr2, city, state, zip, homephone, workphone, lvlid1, lvldesc1, lvlid2, lvldesc2, lvlid3, lvldesc3, lvlid4, lvldesc4, lvlid5, lvldesc5, lvlid6, lvldesc6, lvlid7, lvldesc7, lvlid8, lvldesc8, lvlid9, lvldesc9, lvlid10,
lvldesc10, filldate, paiddate, metricquantity, dayssupply, drugcode, drugdesc, drugstrength, formulary_yn, moi, prescriberid, prescribertype, prescribername, pharmid, pharmname, pharmzipcode, paidamt, billedamt, ingredcost, dispensingcost, salestax, allowedamt, enrpaidamt, coinsamt, copayamt, deductamt, notallowedamt, admfees, awp, cobamt, adjcode, siccode, sicdesc, claimstatus, supplyflag, discountamt,
prescount, ssn, rcvmth, srcfilename, udf1, udfm1, udf2, udfm2,
udf3, udf4, udf5, udf6, udf7, udf8, udf9, udfc1, udfc2, udfc3, udfc4, udfc5, udfc6, udfc7, udfc8, udfc9, udfc10, udfc11, udfc12, udfc13, udfc14, udfc15, udfc16, udfc17, udfc18, udfc19, udfc20, udfd1, udfd2, udfd3, udfd4, udfd5, udfn1, udfn2, udfn3, udfn4, udfn5, udfn6, udfn7, udfn8, udfn9, udfn10, udfn11, udfn12, udfn13, udfn14, udfn15, udfn16, udfn17, udfn18, udfn19, udfn20, vh_lvl_id, emp_nbr, medeligcatid,
productid, vhpayorid, vhlayoutid, qty_disp, srcrelflag, aifileid,
airownumber, vhpayername, vhgroupname, compoundind, specialtyind, pharmnabpnum, plannumber, planname, plantype, populationtype, enrollment_source
FROM VH_RXCLAIMS_'||vLvl.SERIALNO||'_MMOH';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('MMOH RX FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('MMOH RX FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'RX','','E');
END;
COMMIT;



 BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
	FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
	TO_TABLENAME =>	 'VH_RXCLAIMS_'||vLvl.SERIALNO||'',
	UPDATE_STATUS_FIELDNAME =>	  NULL,
	DELIMITER =>		'-',
	UPDATE_PASSES =>	'1-2-4',
	LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
	LVL_DESC_YN =>	  'Y',
	PASS_1_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3',
	PASS_1_UPDATE_CONDITION =>	'[a.source]=''MMOH''',
	PASS_2_JOIN_CONDITION =>	'a.LVLID3 = b.LVLID3'  ,
	PASS_2_UPDATE_CONDITION =>	  '[a.LVLID2] IS NULL and [a.source]=''MMOH''',
	PASS_3_JOIN_CONDITION =>	NULL,
	PASS_3_UPDATE_CONDITION =>	NULL,
	PASS_4_JOIN_CONDITION =>	NULL,
	PASS_4_UPDATE_CONDITION =>	NULL,
	BEGIN_END_DTE_YN =>	 'N',
	STABLE_FROM_TABLE_YN =>	 'N',
	ORDER_BY_LIST =>	NULL
	);
END;

--/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.filldate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.filldate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.filldate ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('MMOH RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('MMOH RXCLAIMS Planname and Plantype UPDATE PASS 2',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.ENRID=d.ENRID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
    UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE   c.planname IS NULL';
---------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('MMOH RXCLAIMS Planname and Plantype UPDATE PASS 3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------


END IF;

--------  #223054 END OF MMOH RX  -----------------------------------------------------------------------------------------

----------------------------------------------AETNA RX 279877---------------------------------------
IF  vLvl.PAYER='AETNA' THEN

BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ZZZ_ATNA_MEMID_UPD_RX_'||EMPID||' CASCADE CONSTRAINTS';
  EXCEPTION
    WHEN Others THEN NULL;
  END;


  vbquery:=
  'CREATE TABLE ZZZ_ATNA_MEMID_UPD_RX_'||EMPID||' as
  SELECT * from
	  (SELECT
		MEMFIRSTNAME, MEMLASTNAME,DOB,MEMID, ENRID, GENDER,
		ROW_NUMBER() OVER(PARTITION BY MEMFIRSTNAME, MEMLASTNAME, DOB ORDER BY RCVMTH DESC) RN
  FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||' WHERE SOURCE = ''AETNA'') a
	WHERE rn = 1';


 BEGIN EXECUTE IMMEDIATE vbquery;
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('TEMP TABLE AETNA RX UPDATE',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'HI_RX_ATNA_OHMH','Y','E');
END;
COMMIT;


VBQUERY := 'DROP TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM AS
							  SELECT
								SOURCE,
								MEMID,
								ENRID,
								LVLID1,
								LVLDESC1,
								LVLID2,
								LVLDESC2,
								LVLID3,
								LVLDESC3,
								PRODUCTID,
								COPAYAMT

						   FROM
								VH_CLAIMS
						   WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('RXCLAIMS TABLE CREATE AETNA '||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_rxCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;


VBQUERY :='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD  PRIMARY KEY(SRCROWID)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

begin
SP_PYR_4422_RX_ATNA('HI0826001','HI_RX_ATNA_'||EMPID||'','RXCLAIMS','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM');
exception when others then
xp_scrubStatusLog ('RXCLAIMS-COMM AETNA '||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4422_RX_ATNA','','E');
end;

	COMMIT;
----------------------------------------------------------------------------------------------------------

vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		PRODUCTID,
		COPAYAMT

	)
	SELECT /*+ PARALLEL(a,4) */
		a.ROWID AS SRCROWID,
		''AETNA'' AS source,
		 NVL(X.MEMID,
				CASE WHEN LVL3.MEMID_GRP_FLAG =''Y'' THEN
					SUBSTR(A.EE_ID,-9)||DECODE(UPPER(A.SRC_MBR_GENDER_CD),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(A.SRC_MBR_BIRTH_DT,''YYYYMMDD'')||''-''||LVL3.ROLLUPID
				ELSE SUBSTR(A.EE_ID,-9)||DECODE(UPPER(A.SRC_MBR_GENDER_CD),''M'',''M'',''F'',''F'',''U'')||TO_CHAR(A.SRC_MBR_BIRTH_DT,''YYYYMMDD'') END ) AS MEMID,
		NVL(X.ENRID,CASE WHEN LVL3.MEMID_GRP_FLAG =''Y'' THEN SUBSTR(a.EE_ID,-9)||''-''||LVL3.ROLLUPID ELSE SUBSTR(a.EE_ID,-9) END ) as ENRID,
		''C'' AS LVL1ID,
		''Commercial'' AS LVL1Desc,
		NULL AS LVL2ID,
		NULL AS LVL2Desc,
		NVL(lvl3.rollupid,SUBSTR(a.group_nbr,-7)) LVL3ID,
		NVL(lvl3.GROUP_NAME,SUBSTR(a.group_nbr,-7))  AS LVL3Desc ,
		''1'' AS PRODUCTID, ';
		IF EMPID='TIRE' THEN  --ICE-17471  --ICE-18007
		vbQuery:=vbQuery||' a.SRV_COPAY_AMT/100'; 
		ELSE 
		vbQuery:=vbQuery||' (a.SRV_COPAY_AMT - a.APP_TO_PER_DED_AMT)/100  AS COPAYAMT';
		END IF;
vbQuery:=vbQuery||' 
  FROM
	HI0826001.HI_RX_ATNA_'||EMPID||'  A
  LEFT JOIN
	HR_826_GROUP lvl3
  ON
	SUBSTR(a.GROUP_NBR,-7)   =  lvl3.SRC_CODE
  LEFT JOIN
	ZZZ_ATNA_MEMID_UPD_RX_'||EMPID||' X
 ON
	UPPER(A.FIRST_NAME)=X.MEMFIRSTNAME
 AND
	UPPER(A.LAST_NAME)=X.MEMLASTNAME
 AND
	A.SRC_MBR_BIRTH_DT =X.DOB
 AND
	DECODE(UPPER(a.SRC_MBR_GENDER_CD),''M'',''M'',''F'',''F'',''U'')=X.GENDER'
	 ;
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('RXCLAIMS-CSTM AETNA '||EMPID,EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_ATNA_'||EMPID,'Y','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('RXCLAIMS-CSTM AETNA '||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'RXCLAIMS','','E');
END;
COMMIT;
------------------------------------------------------------------------------------------------------------------
begin
 SP_CDF_TBL_MERGE(USER,'RXCLAIMS-MERGE AETNA '||EMPID,'VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_AETNA');
exception when others then
xp_scrubStatusLog ('RXCLAIMS-MERGE AETNA '||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
end;

COMMIT;

VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;

VBQUERY:='INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
	        SELECT * FROM VH_RXCLAIMS_'||vLvl.SERIALNO||'_AETNA';

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('AETNA RX '||EMPID||' FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_ATNA_'||EMPID,'Y','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('AETNA RX '||EMPID||' FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'CLAIMS','','E');
END;
COMMIT;

--Updated from ICE-13332
 BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
	FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
	TO_TABLENAME =>	 'VH_RXCLAIMS_'||vLvl.SERIALNO||'',
	UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
	DELIMITER =>		'-',
	UPDATE_PASSES =>	'1-2-3-4',
	LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
	LVL_DESC_YN =>	  'Y',
	PASS_1_JOIN_CONDITION =>	'[a.source]=''AETNA'' and  a.LVLID3 = b.LVLID3',
	PASS_1_UPDATE_CONDITION =>	'[a.source]=''AETNA''',
	PASS_2_JOIN_CONDITION =>	'[a.source]=''AETNA'' and  a.LVLID3 = b.LVLID3',
	PASS_2_UPDATE_CONDITION =>	'[a.source]=''AETNA'' and [a.UDFC4] IS NULL',
	PASS_3_JOIN_CONDITION =>	'[a.source]=''AETNA'' and a.LVLID3 = b.LVLID3',
	PASS_3_UPDATE_CONDITION =>	'[a.source]=''AETNA'' and [a.UDFC4] IS NULL',
	PASS_4_JOIN_CONDITION =>	'[a.source]=''AETNA'' and a.LVLID3 = b.LVLID3',
	PASS_4_UPDATE_CONDITION =>	'[a.source]=''AETNA'' and [a.UDFC4] IS NULL',
	BEGIN_END_DTE_YN =>	 'N',
	STABLE_FROM_TABLE_YN =>	 'N',
	ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
	);
END;

COMMIT;

END IF;
----------------------------------------------AETNA RX 279877 END ---------------------------------------


----------------ICE#340126 MAGELLAN -------------------------------------
IF  vLvl.PAYER='MAGELLAN'  THEN

IF EMPID IN ('SCGR','XENI') THEN		--ICE-13947
BEGIN
  EXECUTE IMMEDIATE 'CREATE TABLE ZZZ_MEMID_MAGELLAN_'||EMPID||' NOLOGGING PARALLEL 4
    AS
    SELECT MEMID,ENRID,MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVLID3
    FROM(
    SELECT
    /*+PARALLEL (a,4)*/
		MEMID,
		ENRID,
		MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		LVLID3,
    Row_Number() OVER
    (PARTITION BY MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3
    ORDER BY TERMDATE DESC NULLS LAST , EFFDATE DESC NULLS LAST) rn
	FROM
		VH_ELIGIBILITIES_'||vLvl.SERIALNO||' a)
  WHERE rn=1';
  EXCEPTION
    WHEN OTHERS THEN NULL;
END;
END IF;


VBQUERY := 'DROP TABLE VH_RX_MAGELLAN_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
  EXECUTE IMMEDIATE VBQUERY;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_RX_MAGELLAN_'||vLvl.SERIALNO||'_CSTM AS
							SELECT
								SOURCE,
                MEMID,
                ENRID,
                LVLID1,
                LVLDESC1,
                LVLID3,
                LVLDESC3,
								PRODUCTID
              FROM
								VH_RXCLAIMS
						  WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('MAGELLAN CSTM TABLE CREATE ',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_RX_MAGELLAN_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';

BEGIN
  EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN NULL;
END;


VBQUERY :='ALTER TABLE VH_RX_MAGELLAN_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTM_MAGELLAN_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';

BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

BEGIN
SP_PYR_4011_RX_MAGE('HI0826001','HI_RX_MAGE_056_'||EMPID||'','HI_RX_MAGE_01_'||EMPID||'','RXCLAIMS','VH_RX_MAGELLAN_'||vLvl.SERIALNO||'_COMM','4');
EXCEPTION WHEN OTHERS THEN
xp_scrubStatusLog ('MAGELLAN COMM TABLE CREATE ',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4011_RX_MAGE','','E');
END;

----------------------------------------------------------------------------------------------------------

vbQuery:='
INSERT /*+ PARALLEL(TBL,4) */ INTO VH_RX_MAGELLAN_'||vLvl.SERIALNO||'_CSTM TBL
(
		SRCROWID,
		SOURCE,
    MEMID,
    ENRID,
    LVLID1,
    LVLDESC1,
    LVLID3,
    LVLDESC3,
		PRODUCTID
	)
SELECT /*+ PARALLEL(a,4) */
	a.ROWID AS SRCROWID,
	''MAGELLAN'' AS source,
  nvl(MEM.MEMID, a.CARDHOLDERMEMBERID ||DECODE(UPPER(a.SEXCODE),''1'',''M'',''M'',''M'',''2'',''F'',''F'',''F'',''U'')||TO_CHAR(a.DATEOFBIRTH,''YYYYMMDD'')||''-''||GRP.ROLLUPID) AS MEMID,
	nvl(MEM.ENRID, a.CARDHOLDERMEMBERID ||''-''||GRP.ROLLUPID) AS ENRID,
  ''C'' AS LVLID1,
  ''Commercial'' AS LVLDesc1,
  NVL(GRP.ROLLUPID,A.GROUPNUMBER) AS LVL3ID,
  NVL(GRP.GROUP_NAME,A.GROUPNUMBER) AS LVLDESC3,
	''1'' AS PRODUCTID
FROM
	HI0826001.HI_RX_MAGE_056_'||EMPID||'  a
LEFT JOIN
  HR_826_GROUP GRP
ON
	A.GROUPNUMBER = GRP.SRC_CODE';

IF EMPID IN ('SCGR','XENI')		--ICE-13947
THEN
  vbQuery := vbQuery||'
    LEFT JOIN
      ZZZ_MEMID_MAGELLAN_'||EMPID||' MEM
    ON
      UPPER(a.PATIENTFIRSTNAME) = MEM.MEMFIRSTNAME AND
      UPPER(a.PATIENTLASTNAME) = MEM.MEMLASTNAME AND
	    DECODE(UPPER(a.SEXCODE),''1'',''M'',''M'',''M'',''2'',''F'',''F'',''F'',''U'') = MEM.GENDER AND
	    a.DATEOFBIRTH = MEM.DOB AND
	    NVL(GRP.ROLLUPID,A.GROUPNUMBER) = MEM.LVLID3
 WHERE A.GROUPNUMBER NOT IN (''0ERF00M00100001'',''0ERF00M00100002'',''0ERF00M00200001'',''0ERF00M00200002'',''0HTZ00M00E00001'',''0JRJ00M00E00001'')	--ICE-13947
';
END IF;

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('RX',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_MAGE_056_'||EMPID,'Y','I');
EXCEPTION WHEN OTHERS THEN
	xp_scrubStatusLog ('RXCLAIMS MAGELLAN ERROR',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

COMMIT;
------------------------------------------------------------------------------------------------------------------
BEGIN
 SP_CDF_TBL_MERGE(USER,'RXCLAIMS-MERGE MAGELLAN','VH_RX_MAGELLAN_'||vLvl.SERIALNO||'_COMM','VH_RX_MAGELLAN_'||vLvl.SERIALNO||'_CSTM','VH_RX_MAGELLAN_'||vLvl.SERIALNO);
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('RXCLAIMS-MERGE MAGELLAN',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
END;

-- ICE-18735
--BEGIN EXECUTE IMMEDIATE
--'ALTER TABLE  VH_RX_MAGELLAN_'||vLvl.SERIALNO ||' DROP COLUMN SRCROWID';
--EXCEPTION WHEN OTHERS THEN
--	xp_scrubStatusLog ('RX MAGELLAN DROP SRCROW',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
--END;
--
--BEGIN EXECUTE IMMEDIATE
--'ALTER TABLE  VH_RXCLAIMS_'||vLvl.SERIALNO ||' DROP COLUMN SRCROWID';
--EXCEPTION WHEN OTHERS THEN
--	xp_scrubStatusLog ('RX MAGELLAN DROP SRCROW',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
--END;


-- ICE-18735
BEGIN EXECUTE IMMEDIATE
'INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'
(SOURCE, SN, TRANSNUM, SEQNO, DATETIMESTAMP, MEMID, ENRID, RELFLAG, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, ADDR1, ADDR2, CITY, STATE, ZIP, HOMEPHONE, WORKPHONE, LVLID1, LVLDESC1, LVLID2, LVLDESC2, LVLID3, LVLDESC3, LVLID4, LVLDESC4, LVLID5, LVLDESC5, LVLID6, LVLDESC6, LVLID7, LVLDESC7, LVLID8, LVLDESC8, LVLID9, LVLDESC9, LVLID10, LVLDESC10, FILLDATE, PAIDDATE, METRICQUANTITY, DAYSSUPPLY, DRUGCODE, DRUGDESC, DRUGSTRENGTH, FORMULARY_YN, MOI, PRESCRIBERID, PRESCRIBERTYPE, PRESCRIBERNAME, PRESCRIBERNPI, PHARMID, PHARMNAME, PHARMNPI, PHARMZIPCODE, PAIDAMT, BILLEDAMT, INGREDCOST, DISPENSINGCOST, SALESTAX, ALLOWEDAMT, ENRPAIDAMT, COINSAMT, COPAYAMT, DEDUCTAMT, NOTALLOWEDAMT, ADMFEES, AWP, COBAMT, ADJCODE, SICCODE, SICDESC, CLAIMSTATUS, SUPPLYFLAG, DISCOUNTAMT, PRESCOUNT, SSN, RCVMTH, SRCFILENAME, UDF1, UDFM1, UDF2, UDFM2, UDF3, UDF4, UDF5, UDF6, UDF7, UDF8, UDF9, UDFC1, UDFC2, UDFC3, UDFC4, UDFC5, UDFC6, UDFC7, UDFC8, UDFC9, UDFC10, UDFC11, UDFC12, UDFC13, UDFC14, UDFC15, UDFC16, UDFC17, UDFC18, UDFC19, UDFC20, UDFC21, UDFC22, UDFC23, UDFC24, UDFC25, UDFC26, UDFC27, UDFC28, UDFC29, UDFC30, UDFD1, UDFD2, UDFD3, UDFD4, UDFD5, UDFN1, UDFN2, UDFN3, UDFN4, UDFN5, UDFN6, UDFN7, UDFN8, UDFN9, UDFN10, UDFN11, UDFN12, UDFN13, UDFN14, UDFN15, UDFN16, UDFN17, UDFN18, UDFN19, UDFN20, VH_LVL_ID, EMP_NBR, MEDELIGCATID, PRODUCTID, VHPAYORID, VHLAYOUTID, QTY_DISP, SRCRELFLAG, AIFILEID, AIROWNUMBER, VHPAYERNAME, VHGROUPNAME, COMPOUNDIND, SPECIALTYIND, PHARMNABPNUM, PLANNUMBER, PLANNAME, PLANTYPE, POPULATIONTYPE, I_SRC_ORCL_ROW_ID, I_SRC_TBL_NM, DAWPS_CD, RX_ORGN_CD, UNC_PRICE, SUBSCRIBERFLAG, LVL4FIRSTNAME, LVL4LASTNAME, CMSTATUS, DRUGTYPECODE, DRUGTYPEDESC, GCN, GI, GPI, RXCODE, RXDESC, REINSAMT, REPRICEDAMT, PERSISTENCEFACTOR, NETWORKTYPE, ENROLLMENT_SOURCE)
 SELECT SOURCE, SN, TRANSNUM, SEQNO, DATETIMESTAMP, MEMID, ENRID, RELFLAG, MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, ADDR1, ADDR2, CITY, STATE, ZIP, HOMEPHONE, WORKPHONE, LVLID1, LVLDESC1, LVLID2, LVLDESC2, LVLID3, LVLDESC3, LVLID4, LVLDESC4, LVLID5, LVLDESC5, LVLID6, LVLDESC6, LVLID7, LVLDESC7, LVLID8, LVLDESC8, LVLID9, LVLDESC9, LVLID10, LVLDESC10, FILLDATE, PAIDDATE, METRICQUANTITY, DAYSSUPPLY, DRUGCODE, DRUGDESC, DRUGSTRENGTH, FORMULARY_YN, MOI, PRESCRIBERID, PRESCRIBERTYPE, PRESCRIBERNAME, PRESCRIBERNPI, PHARMID, PHARMNAME, PHARMNPI, PHARMZIPCODE, PAIDAMT, BILLEDAMT, INGREDCOST, DISPENSINGCOST, SALESTAX, ALLOWEDAMT, ENRPAIDAMT, COINSAMT, COPAYAMT, DEDUCTAMT, NOTALLOWEDAMT, ADMFEES, AWP, COBAMT, ADJCODE, SICCODE, SICDESC, CLAIMSTATUS, SUPPLYFLAG, DISCOUNTAMT, PRESCOUNT, SSN, RCVMTH, SRCFILENAME, UDF1, UDFM1, UDF2, UDFM2, UDF3, UDF4, UDF5, UDF6, UDF7, UDF8, UDF9, UDFC1, UDFC2, UDFC3, UDFC4, UDFC5, UDFC6, UDFC7, UDFC8, UDFC9, UDFC10, UDFC11, UDFC12, UDFC13, UDFC14, UDFC15, UDFC16, UDFC17, UDFC18, UDFC19, UDFC20, UDFC21, UDFC22, UDFC23, UDFC24, UDFC25, UDFC26, UDFC27, UDFC28, UDFC29, UDFC30, UDFD1, UDFD2, UDFD3, UDFD4, UDFD5, UDFN1, UDFN2, UDFN3, UDFN4, UDFN5, UDFN6, UDFN7, UDFN8, UDFN9, UDFN10, UDFN11, UDFN12, UDFN13, UDFN14, UDFN15, UDFN16, UDFN17, UDFN18, UDFN19, UDFN20, VH_LVL_ID, EMP_NBR, MEDELIGCATID, PRODUCTID, VHPAYORID, VHLAYOUTID, QTY_DISP, SRCRELFLAG, AIFILEID, AIROWNUMBER, VHPAYERNAME, VHGROUPNAME, COMPOUNDIND, SPECIALTYIND, PHARMNABPNUM, PLANNUMBER, PLANNAME, PLANTYPE, POPULATIONTYPE, I_SRC_ORCL_ROW_ID, I_SRC_TBL_NM, DAWPS_CD, RX_ORGN_CD, UNC_PRICE, SUBSCRIBERFLAG, LVL4FIRSTNAME, LVL4LASTNAME, CMSTATUS, DRUGTYPECODE, DRUGTYPEDESC, GCN, GI, GPI, RXCODE, RXDESC, REINSAMT, REPRICEDAMT, PERSISTENCEFACTOR, NETWORKTYPE, ENROLLMENT_SOURCE
 FROM  VH_RX_MAGELLAN_'||vLvl.SERIALNO;
EXCEPTION WHEN OTHERS THEN
	xp_scrubStatusLog ('RXCLAIMS MAGELLAN INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

COMMIT;

--------------------------------------------------------------------------------
--- LOA Update(Level 2 and Level 4 Update)
--------------------------------------------------------------------------------
BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
		FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
		TO_TABLENAME =>	 'VH_RXCLAIMS_'||vLvl.SERIALNO||'',
		UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
		DELIMITER =>		'-',
		UPDATE_PASSES =>	'1-2-3-4',
		LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
		LVL_DESC_YN =>	  'Y',
		PASS_1_JOIN_CONDITION =>	'[a.source]=''MAGELLAN'' and  a.LVLID3 = b.LVLID3',
		PASS_1_UPDATE_CONDITION =>	'[a.source]=''MAGELLAN''',
		PASS_2_JOIN_CONDITION =>	'[a.source]=''MAGELLAN'' and  a.LVLID3 = b.LVLID3',
		PASS_2_UPDATE_CONDITION =>	'[a.source]=''MAGELLAN'' and [a.UDFC4] IS NULL',
		PASS_3_JOIN_CONDITION =>	'[a.source]=''MAGELLAN'' and a.LVLID3 = b.LVLID3',
		PASS_3_UPDATE_CONDITION =>	'[a.source]=''MAGELLAN'' and [a.UDFC4] IS NULL',
		PASS_4_JOIN_CONDITION =>	'[a.source]=''MAGELLAN'' and a.LVLID3 = b.LVLID3',
		PASS_4_UPDATE_CONDITION =>	'[a.source]=''MAGELLAN'' and [a.UDFC4] IS NULL',
		BEGIN_END_DTE_YN =>	 'N',
		STABLE_FROM_TABLE_YN =>	 'N',
		ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
	);
END;

/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.filldate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.filldate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.filldate ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.ENRID=d.ENRID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
    UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE   c.planname IS NULL';


---------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

END IF;
-------------- END MAGELLAN ----------------------------------------------------



----------------ICE#337018 OPTM_148 -------------------------------------
IF  vLvl.PAYER='OPTM_148'  THEN

IF EMPID IN ('CLAR') THEN
BEGIN
  EXECUTE IMMEDIATE 'CREATE TABLE ZZZ_MEMID_OPTM_148_'||EMPID||' NOLOGGING PARALLEL 4
    AS
    SELECT MEMID,ENRID,MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVLID3
    FROM(
    SELECT
    /*+PARALLEL (a,4)*/
		MEMID,
		ENRID,
		MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		LVLID3,
    Row_Number() OVER
    (PARTITION BY MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB, LVLID3
    ORDER BY TERMDATE DESC NULLS LAST , EFFDATE DESC NULLS LAST) rn
	FROM
		VH_ELIGIBILITIES_'||vLvl.SERIALNO||' a
   )
  WHERE rn=1';
  EXCEPTION
    WHEN OTHERS THEN NULL;
END;
END IF;


VBQUERY := 'DROP TABLE VH_RX_OPTM_148_'||vLvl.SERIALNO||'_CSTM PURGE';
BEGIN
  EXECUTE IMMEDIATE VBQUERY;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

VBQUERY:='CREATE TABLE VH_RX_OPTM_148_'||vLvl.SERIALNO||'_CSTM AS
							SELECT
								SOURCE,
                MEMID,
                ENRID,
                LVLID1,
                LVLDESC1,
                LVLID3,
                LVLDESC3,
                TRANSNUM,
                PAIDDATE,
                DRUGSTRENGTH,
                SRCRELFLAG,
                UDF1,
								PRODUCTID
              FROM
								VH_RXCLAIMS
						  WHERE 1=2';

BEGIN
	EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('OPTM_148 CSTM TABLE CREATE ',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

VBQUERY:='ALTER TABLE VH_RX_OPTM_148_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';

BEGIN
  EXECUTE IMMEDIATE VBQUERY;
	EXCEPTION WHEN OTHERS THEN NULL;
END;


VBQUERY :='ALTER TABLE VH_RX_OPTM_148_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTM_OPTM_148_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';

BEGIN
	EXECUTE IMMEDIATE VBQUERY ;
  EXCEPTION WHEN OTHERS THEN NULL;
END;

BEGIN
SP_PYR_4769_RX_OPTM('HI0826001','HI_RX_OPTM_148_'||EMPID||'','RXCLAIMS','VH_RX_OPTM_148_'||vLvl.SERIALNO||'_COMM','4');
EXCEPTION WHEN OTHERS THEN
xp_scrubStatusLog ('OPTM_148 COMM TABLE CREATE ',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4769_RX_OPTM','','E');
END;

----------------------------------------------------------------------------------------------------------

vbQuery:='
INSERT /*+ PARALLEL(TBL,4) */ INTO VH_RX_OPTM_148_'||vLvl.SERIALNO||'_CSTM TBL
(
		SRCROWID,
		SOURCE,
    MEMID,
    ENRID,
    LVLID1,
    LVLDESC1,
    LVLID3,
    LVLDESC3,
    TRANSNUM,
    PAIDDATE,
    DRUGSTRENGTH,
    SRCRELFLAG,
    UDF1,
		PRODUCTID
	)
SELECT /*+ PARALLEL(a,4) */
	a.ROWID AS SRCROWID,
	''OPTM_148'' AS source,
  nvl(MEM.MEMID, a.SOCIALSECURITYNUMBER || Decode(a.GENDER,''1'',''M'',''2'',''F'',''U'') || To_Char(a.PATIENTDATEOFBIRTH,''YYYYMMDD'')) AS MEMID,
	nvl(MEM.ENRID, a.SOCIALSECURITYNUMBER) AS ENRID,
  ''C'' AS LVLID1,
  ''Commercial'' AS LVLDesc1,
  NVL(GRP.ROLLUPID,A.CARRIER) AS LVL3ID,
  NVL(GRP.GROUP_NAME,A.CARRIER) AS LVLDESC3,
  a.RXCLAIMSNUMBER AS TRANSNUM,
  Nvl(a.CHECKDATE,a.DATEOFSERVICE) AS PAIDDATE,
  a.DRUGSTRENGTH/1000 AS DRUGSTRENGTH,
   (SELECT R.rollup_desc FROM HR_826_REL R WHERE  R.source = ''OPTUM'' AND R.src_code=a.PATIENTRELATIONSHIPCARDHOLDER ) SrcRelFlag,
  a.UDF1 AS UDF1,
	''1'' AS PRODUCTID
FROM
	HI0826001.HI_RX_OPTM_148_'||EMPID||'  a
LEFT JOIN
  HR_826_GROUP GRP
ON
	GRP.SRC_CODE=A.CARRIER';

IF EMPID IN ('CLAR')
THEN
  vbQuery := vbQuery||'
    LEFT JOIN
      ZZZ_MEMID_OPTM_148_'||EMPID||' MEM
    ON
      UPPER(a.PATIENTFIRSTNAME) = MEM.MEMFIRSTNAME AND
      UPPER(a.PATIENTLASTNAME) = MEM.MEMLASTNAME AND
	    Decode(a.GENDER,''1'',''M'',''2'',''F'',''U'') = MEM.GENDER AND
	    a.PATIENTDATEOFBIRTH = MEM.DOB AND
	    NVL(GRP.ROLLUPID,A.CARRIER) = MEM.LVLID3
';
END IF;

BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('RX',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_OPTM_148_'||EMPID,'Y','I');
EXCEPTION WHEN OTHERS THEN
	xp_scrubStatusLog ('RXCLAIMS OPTM_148 ERROR',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

COMMIT;
------------------------------------------------------------------------------------------------------------------
BEGIN
 SP_CDF_TBL_MERGE(USER,'RXCLAIMS-MERGE OPTM_148','VH_RX_OPTM_148_'||vLvl.SERIALNO||'_COMM','VH_RX_OPTM_148_'||vLvl.SERIALNO||'_CSTM','VH_RX_OPTM_148_'||vLvl.SERIALNO||'_OPTM148');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('RXCLAIMS-MERGE OPTM_148',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
END;

	VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';   --ICE_3153
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
	    SELECT * FROM VH_RX_OPTM_148_'||vLvl.SERIALNO||'_OPTM148';

	BEGIN EXECUTE IMMEDIATE vbquery;
		XP_SCRUBSTATUSLOG ('OPTM_148 FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('OPTM_148 FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'RX','','E');
	END;
	COMMIT;
----------------------------------------------------------

--------------------------------------------------------------------------------
--- LOA Update(Level 2 and Level 4 Update)
--------------------------------------------------------------------------------
BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
		FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
		TO_TABLENAME =>	 'VH_RXCLAIMS_'||vLvl.SERIALNO||'',
		UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
		DELIMITER =>		'-',
		UPDATE_PASSES =>	'1-2-4',
		LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
		LVL_DESC_YN =>	  'Y',
		PASS_1_JOIN_CONDITION =>	'[a.source]=''OPTM_148'' and  a.LVLID3 = b.LVLID3',
		PASS_1_UPDATE_CONDITION =>	'[a.source]=''OPTM_148''',
		PASS_2_JOIN_CONDITION =>	'[a.source]=''OPTM_148'' and  a.LVLID3 = b.LVLID3',
		PASS_2_UPDATE_CONDITION =>	'[a.source]=''OPTM_148'' and [a.UDFC4] IS NULL',
		PASS_3_JOIN_CONDITION =>	NULL,
		PASS_3_UPDATE_CONDITION =>	NULL,
		PASS_4_JOIN_CONDITION =>	'[a.source]=''OPTM_148'' and a.LVLID3 = b.LVLID3',
		PASS_4_UPDATE_CONDITION =>	'[a.source]=''OPTM_148'' and [a.UDFC4] IS NULL',
		BEGIN_END_DTE_YN =>	 'N',
		STABLE_FROM_TABLE_YN =>	 'N',
		ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
	);
END;

/*********************************************Beginning to Plan type and Plan name update from Elig****************************************************/
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID, f.planname,f.plantype, f.filldate,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.EFFDATE, b.TERMDATE, a.filldate, a.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID, a.filldate ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3
        AND
                NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
	AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
	AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-1 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';
---------------------------------------Executing first pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.MEMID,f.planname,f.plantype ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.MEMID,b.planname,b.plantype, b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.MEMID ORDER BY b.plantype,b.planname) rn
        FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.MEMID=a.MEMID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
        UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-2 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE  c.planname IS NULL';


---------------------------------------Executing sceond pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 1',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||' c
	USING
	(
        SELECT
                /*+ PARALLEL(f,4) */ f.ENRID, F.PLANNAME,F.PLANTYPE ,f.lvlid3
        FROM
                (SELECT
                        /*+ PARALLEL(a,4) */ b.ENRID, B.PLANNAME,B.PLANTYPE,b.lvlid3,
                        ROW_NUMBER() OVER (PARTITION BY b.ENRID ORDER BY b.PLANNAME,B.PLANTYPE) rn
        FROM
                VH_ELIGIBILITIES_'||vLvl.SERIALNO||' b
        INNER JOIN
                VH_RXCLAIMS_'||vLvl.SERIALNO||' a
        ON
                b.ENRID=a.ENRID
        AND
                a.LVLID3 = b.LVLID3

        ) f
        WHERE rn=1
	) d
	ON
	(
        c.ENRID=d.ENRID
        AND
        c.lvlid3=d.lvlid3
	)
	WHEN MATCHED THEN
    UPDATE SET
        c.planname=d.planname,
        c.plantype=d.plantype,
        c.UDFC13=''PASS-3 : Updated from VH_ELIGIBILITIES_'||vLvl.SERIALNO||'''
	WHERE   c.planname IS NULL';


---------------------------------------Executing third pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('RXCLAIMS Planname and Plantype UPDATE PASS 3',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------------------------------------------------------------------------------------

END IF;
--------------------------------------------------------------OPTUM ends---------------------------------------------

-----------------------------------------RX CAREMAK layout 4819 starts---ice 1338 starts-------------------------------------------------------------
IF  vLvl.PAYER='CAREMARK' THEN

	VBQUERY := 'DROP TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM PURGE';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM
		AS
		SELECT
			SOURCE,
			MEMID,
			ENRID,
			LVLID1,
			LVLDESC1,
			LVLID3,
			LVLDESC3,
			PRODUCTID
		FROM
			VH_RXCLAIMS
		WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS TABLE CREATE',EMPID,'CMRK',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_CSTMTABLE_CLMS1_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	begin
		SP_PYR_4819_RX_CMRK('HI0826001','HI_RXCLAIMS_CMRK_'||EMPID||'','RXCLAIMS','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','4');
		exception when others then
		xp_scrubStatusLog ('RX-COMM CAREMARK',EMPID,'CMRK',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_4819_RX_CMRK','','E');
	end;

	COMMIT;
	------------------------------------------------------------------------------------------------------------------------

	vbquery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM TBL
	(
		SRCROWID,
		SOURCE,
		MemID,
		EnrID,
		LVLID1,
		LVLDesc1,
		LVLID3,
		LVLDESC3,
		PRODUCTID
	)
	SELECT
		a.ROWID AS SRCROWID,
		''CAREMARK'' AS SOURCE,
		SUBSTR(a.CARDHOLDER_ID,1,9)||DECODE(a.PATIENT_GENDER_CODE,''1'',''M'',''2'',''F'',''U'')||TO_CHAR(a.PATIENT_DATE_OF_BIRTH,''YYYYMMDD'')||''-''||grp.ROLLUPID AS MEMID,
		SUBSTR(a.CARDHOLDER_ID,1,9)||''-''||grp.ROLLUPID AS ENRID,
		''C'' AS LVL1ID,
		''Commercial'' AS LVL1Desc,
		nvl(grp.ROLLUPID, a.carrier_number||a.group_id) AS LVL3ID,
		nvl(grp.Group_Name, a.carrier_number||a.group_id) AS LVL3Desc,
		''1'' as PRODUCTID
	FROM
		HI0826001.HI_RXCLAIMS_CMRK_'||EMPID||'  a

	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.carrier_number||a.group_id = grp.src_code

	';

	BEGIN EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS CMRK CSTM ERROR',EMPID,'CMRK',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;
	COMMIT;
------------------------------------------------------------------------------------------------------------------
	begin
		SP_CDF_TBL_MERGE(USER,'RXCLAIMS-MERGE CMRK','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_CMRK');
		exception when others then
		xp_scrubStatusLog ('RXCLAIMS-MERGE CMRK',EMPID,'CMRK',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	end;
	COMMIT;
--------------------------------------------------------------------------------------------------------------------

----------------------------------FIRST pass for planname and plantype update from elig starts---------------------------------------
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CMRK c
	USING
	(
        SELECT
            /*+ PARALLEL(f,4) */ f.MEMID,f.lvlid3, f.filldate,f.planname, f.plantype, f.ZIP,f.lvlid2,f.lvldesc2,f.lvlid4,f.lvldesc4
        FROM
			(SELECT
				/*+ PARALLEL(a,4) */ b.MEMID,b.lvlid3, a.filldate,b.planname, b.plantype, b.ZIP,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4,b.EFFDATE, b.TERMDATE,
				ROW_NUMBER() OVER (PARTITION BY b.MEMID,b.lvlid3,a.filldate ORDER BY b.planname,b.plantype,b.ZIP,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4) rn
        FROM
			VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  b

        INNER JOIN
			VH_RXCLAIMS_'||vLvl.SERIALNO||'_CMRK a
        ON
			b.MEMID=a.MEMID
			AND
			b.lvlid3=a.lvlid3
			AND
			NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
        ) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
		AND
        NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
		AND
		c.lvlid3=d.lvlid3
    )
	WHEN MATCHED THEN UPDATE SET
		c.planname=d.planname,
        c.plantype=d.plantype,
        c.ZIP =d.ZIP,
		c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4
	';

---------------------------------------Executing FIRST pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN
		EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS Planname,Plantype.. UPDATE PASS 1',EMPID,'CMRK',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;
	COMMIT;
-----------------------------------------------------FIRST pass for planname and plantype update from elig ends------------------------------------------------

-----------------------------------------------------Second pass for planname and plantype update from elig starts------------------------------------------------
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CMRK c
	USING
	(
        SELECT
			/*+ PARALLEL(f,4) */ f.MEMID,f.lvlid3,f.planname, f.plantype, f.ZIP,f.lvlid2,f.lvldesc2,f.lvlid4,f.lvldesc4
        FROM
			(SELECT
				/*+ PARALLEL(a,4) */ b.MEMID,b.lvlid3,b.planname, b.plantype, b.ZIP,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4,
				ROW_NUMBER() OVER (PARTITION BY b.MEMID,b.lvlid3 ORDER BY b.planname,b.plantype,b.ZIP,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4) rn
        FROM
			VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  b

        INNER JOIN
			VH_RXCLAIMS_'||vLvl.SERIALNO||'_CMRK a
        ON
			b.MEMID=a.MEMID
			AND
			b.lvlid3=a.lvlid3
		) f
        WHERE rn=1
	) d
	ON
	(
        c.MEMID=d.MEMID
		AND
		c.lvlid3=d.lvlid3
    )
	WHEN MATCHED THEN UPDATE SET
		c.planname=d.planname,
        c.plantype=d.plantype,
        c.ZIP =d.ZIP,
		c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
        c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4
	WHERE
		c.LVLID2 IS NULL
	';


---------------------------------------Executing second pass for planname and plantype update from elig---------------------------------------------------
	 BEGIN
		EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS Planname , Plantype.. UPDATE PASS 2',EMPID,'CMRK',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;
	COMMIT;
-----------------------------------------------------Second pass for planname and plantype update from elig ends------------------------------------------------

	vbQuery:=
	'INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
	(
	source, sn, transnum, seqno, datetimestamp, memid, enrid, relflag, memfirstname, memlastname, gender, dob, addr1, addr2, city, state, zip, homephone, workphone, lvlid1, lvldesc1, lvlid2, lvldesc2, lvlid3, lvldesc3, lvlid4, lvldesc4, lvlid5, lvldesc5, lvlid6, lvldesc6, lvlid7, lvldesc7, lvlid8, lvldesc8, lvlid9, lvldesc9, lvlid10,
	lvldesc10, filldate, paiddate, metricquantity, dayssupply, drugcode, drugdesc, drugstrength, formulary_yn, moi, prescriberid, prescribertype, prescribername, pharmid, pharmname, pharmzipcode, paidamt, billedamt, ingredcost, dispensingcost, salestax, allowedamt, enrpaidamt, coinsamt, copayamt, deductamt, notallowedamt, admfees, awp, cobamt, adjcode, siccode, sicdesc, claimstatus, supplyflag,
	discountamt, prescount, ssn, rcvmth, srcfilename, udf1, udfm1, udf2, udfm2, udf3, udf4, udf5, udf6, udf7, udf8, udf9, udfc1, udfc2, udfc3, udfc4, udfc5, udfc6, udfc7, udfc8, udfc9, udfc10, udfc11, udfc12, udfc13, udfc14, udfc15, udfc16, udfc17, udfc18, udfc19, udfc20, udfd1, udfd2, udfd3, udfd4, udfd5, udfn1, udfn2, udfn3, udfn4, udfn5, udfn6, udfn7, udfn8, udfn9, udfn10, udfn11, udfn12,
	udfn13, udfn14, udfn15, udfn16, udfn17, udfn18, udfn19, udfn20, vh_lvl_id, emp_nbr, medeligcatid, productid, vhpayorid, vhlayoutid, qty_disp, srcrelflag, aifileid,
	airownumber, vhpayername, vhgroupname, compoundind, specialtyind, pharmnabpnum, plannumber, planname, plantype, populationtype, enrollment_source
	)
	SELECT
	source, sn, transnum, seqno, datetimestamp, memid, enrid, relflag, memfirstname, memlastname, gender, dob, addr1, addr2, city, state, zip, homephone, workphone, lvlid1, lvldesc1, lvlid2, lvldesc2, lvlid3, lvldesc3, lvlid4, lvldesc4, lvlid5, lvldesc5, lvlid6, lvldesc6, lvlid7, lvldesc7, lvlid8, lvldesc8, lvlid9, lvldesc9, lvlid10,
	lvldesc10, filldate, paiddate, metricquantity, dayssupply, drugcode, drugdesc, drugstrength, formulary_yn, moi, prescriberid, prescribertype, prescribername, pharmid, pharmname, pharmzipcode, paidamt, billedamt, ingredcost, dispensingcost, salestax, allowedamt, enrpaidamt, coinsamt, copayamt, deductamt, notallowedamt, admfees, awp, cobamt, adjcode, siccode, sicdesc, claimstatus, supplyflag, discountamt,
	prescount, ssn, rcvmth, srcfilename, udf1, udfm1, udf2, udfm2,
	udf3, udf4, udf5, udf6, udf7, udf8, udf9, udfc1, udfc2, udfc3, udfc4, udfc5, udfc6, udfc7, udfc8, udfc9, udfc10, udfc11, udfc12, udfc13, udfc14, udfc15, udfc16, udfc17, udfc18, udfc19, udfc20, udfd1, udfd2, udfd3, udfd4, udfd5, udfn1, udfn2, udfn3, udfn4, udfn5, udfn6, udfn7, udfn8, udfn9, udfn10, udfn11, udfn12, udfn13, udfn14, udfn15, udfn16, udfn17, udfn18, udfn19, udfn20, vh_lvl_id, emp_nbr, medeligcatid,
	productid, vhpayorid, vhlayoutid, qty_disp, srcrelflag, aifileid,
	airownumber, vhpayername, vhgroupname, compoundind, specialtyind, pharmnabpnum, plannumber, planname, plantype, populationtype, enrollment_source
	FROM
	VH_RXCLAIMS_'||vLvl.SERIALNO||'_CMRK';
------------------------------------------------------------------------------------------
	BEGIN
		EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('Insert CMRK group into rxclaims',EMPID,'CMRK',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;
	COMMIT;
END IF;
--------------------------------------------------------------RX CAREMAK layout 4819 ends-----ice 1338 ends ---------------------------------------

--------------------------------------------------TRUERX PAYER IMPLEMENTATION 7062--------------------------------------------------
IF  vLvl.PAYER='TRUERX_NEW' THEN

	VBQUERY := 'DROP TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM_TRX PURGE';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM_TRX AS
	SELECT
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID3,
		LVLDESC3,
    BILLEDAMT,
		PRODUCTID
	FROM
		VH_RXCLAIMS
	WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS CSTM - TRUERX NEW',EMPID,'TRUERX_NEW',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM_TRX ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM_TRX ADD CONSTRAINT PK_CSTM_TRUERX_NEW_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	BEGIN
		SP_PYR_5496_RX_TRRX('HI0826001','HI_RX_TRRX_1_'||EMPID||'','HI_RX_TRRX_3_'||EMPID||'','RXCLAIMS','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM_TRX','4');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS COMM - TRUERX NEW',EMPID,'TRUERX_NEW',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_5496_RX_TRRX','','E');
	END;
	COMMIT;
----------------------------------------------------------------------------------------------------------

	vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM_TRX TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID3,
		LVLDESC3,
    BILLEDAMT,
		PRODUCTID
	)
	SELECT /*+ PARALLEL(a,4) */
		a.ROWID AS SRCROWID,
		''TRUERX_NEW'' AS SOURCE,
		SubStr(a.ALTERNATE_MEMBER_ID_MEMBER,-9) || Decode(Upper(a.MEMBER_SEX),''M'',''M'',''F'',''F'',''U'') || To_Char(a.MEMBER_BIRTHDATE,''YYYYMMDD'') || ''-'' || GRP.rollupid AS MEMID,
		SubStr(a.ALTERNATE_MEMBER_ID_MEMBER,-9) || ''-'' || GRP.rollupid AS ENRID,
		''C'' AS LVL1ID,
		''Commercial'' AS LVL1Desc,
		NVL(GRP.rollupid , substr(a.group_no,1,12)) AS LVL3ID,
		NVL(GRP.group_name , substr(a.group_no,1,12)) AS LVL3Desc,
    (a.INGREDIEN_COST_PAID + a.AMT_ATTRIBUTED_TO_SALE_TAX + a.DISPENSE_FEE)/100 AS BILLEDAMT,
		''1'' AS PRODUCTID
	FROM
		HI0826001.HI_RX_TRRX_1_'||EMPID||' a
	LEFT JOIN
		HR_826_GROUP GRP
	ON
		substr(a.group_no,1,12) = grp.src_code
	';

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('RXCLAIMS CSTM - TRUERX NEW - INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_TRRX_1_'||EMPID,'Y','I');
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS CSTM - TRUERX NEW - INSERT',EMPID,'TRUERX_NEW',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;
	COMMIT;
------------------------------------------------------------------------------------------------------------------
	BEGIN
		SP_CDF_TBL_MERGE(USER,'RXCLAIMS-MERGE TRUERX NEW','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM_TRX','VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM_TRX','VH_RXCLAIMS_'||vLvl.SERIALNO||'_TRX');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS-MERGE TRUERX NEW',EMPID,'TRUERX_NEW',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	END;
	COMMIT;


------------------------------------------------------------------------------------------------------------------
-- LOA / PLANTYPE UPDATE FROM ELIG

--1st pass

	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_TRX c
	USING
	(
    SELECT /*+ PARALLEL(f,4) */
      f.MEMID,f.lvlid3, f.filldate,f.planname, f.plantype, f.lvlid2,f.lvldesc2,f.lvlid4,f.lvldesc4
    FROM
		(
			SELECT /*+ PARALLEL(a,4) */
				b.MEMID,b.lvlid3, a.filldate,b.planname, b.plantype,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4,b.EFFDATE, b.TERMDATE,
				ROW_NUMBER() OVER (PARTITION BY b.MEMID,b.lvlid3,a.filldate ORDER BY b.TERMDATE desc, b.EFFDATE desc, b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4) rn
			FROM
        VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  b
			INNER JOIN
        VH_RXCLAIMS_'||vLvl.SERIALNO||'_TRX a
			ON
        b.MEMID=a.MEMID
			AND
			  b.lvlid3=a.lvlid3
			AND
        NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
     ) f WHERE rn=1
	) d
	ON
	(
    c.MEMID=d.MEMID
		  AND
    NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
		  AND
		c.lvlid3=d.lvlid3
    )
	WHEN MATCHED THEN UPDATE SET
		c.planname= d.planname,
    c.plantype= d.plantype,
    c.LVLID2= d.LVLID2, c.LVLDESC2= d.LVLDESC2,
    c.LVLID4= d.LVLID4, c.LVLDESC4= d.LVLDESC4
	';
	BEGIN
		EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS TRUERX NEW UPDATE PASS 1',EMPID,'TRUERX_NEW',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;
	COMMIT;

----------------------------------------------------------------------------------------------------------------------------------------------------------
--2nd pass
	vbQuery:=
	'MERGE INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_TRX c
	USING
	(
     SELECT /*+ PARALLEL(f,4) */
		    f.MEMID,f.lvlid3,f.planname, f.plantype, f.lvlid2,f.lvldesc2,f.lvlid4,f.lvldesc4
     FROM
		(
			SELECT /*+ PARALLEL(a,4) */
				b.MEMID,b.lvlid3,b.planname, b.plantype,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4,
				ROW_NUMBER() OVER (PARTITION BY b.MEMID,b.lvlid3 ORDER BY b.planname,b.plantype,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4) rn
			FROM
        VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  b
			INNER JOIN
        VH_RXCLAIMS_'||vLvl.SERIALNO||'_TRX a
			ON
        b.MEMID=a.MEMID
			AND
			  b.lvlid3=a.lvlid3
		) f
      WHERE rn=1
	) d
	ON
	(
    c.MEMID=d.MEMID
		AND
		c.lvlid3=d.lvlid3
   )
	WHEN MATCHED THEN UPDATE SET
		c.planname=d.planname,
    c.plantype=d.plantype,
    c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
    c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4
	WHERE c.LVLID2 IS NULL
	';

	 BEGIN
		EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS TRUERX NEW UPDATE PASS 1',EMPID,'TRUERX_NEW',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
--------------------------------------------------------------------------------------------

---------------------------------- TRUERX NEW FINAL INSERT ---------------------------------------------------------------

	VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
          SELECT * FROM VH_RXCLAIMS_'||vLvl.SERIALNO||'_TRX';

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('TRUERX NEW FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_TRRX_1_'||EMPID,'Y','I');
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('TRUERX NEW FINAL INSERT',EMPID,'TRUERX_NEW',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;

END IF;

----------------------------Start ICE#9500

IF  vLvl.PAYER='OUHL' THEN

BEGIN EXECUTE IMMEDIATE 'DROP TABLE zzz_rx_ANTHEM_'||vLvl.SERIALNO||' PURGE';
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
---------------------------------------------------------------------------------------------
	vbQuery:=
	'CREATE TABLE zzz_rx_ANTHEM_'||vLvl.SERIALNO||' NOLOGGING AS
	SELECT
		MEMID,
		ENRID,
		MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLID4,
		LVLDESC4
	FROM (
SELECT
			MEMID,
			ENRID,
			MEMFIRSTNAME,
			MEMLASTNAME,
			GENDER,
			DOB,
			LVLID2,
			LVLDESC2,
			LVLID3,
			LVLID4,
			LVLDESC4,
			row_number() over (partition by MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVLID3  order by a.effdate desc Nulls last, a.TERMDATE desc , MEMID) rn

    FROM
		VH_ELIGIBILITIES_'||vLvl.SERIALNO||' a
		where source = ''OUR HEALTH'' and lvlid3 in (''TAVG'',''730337'',''HAMI'',''WEHI'') --ICE#10163
	)
	WHERE RN=1
	';
	BEGIN EXECUTE IMMEDIATE vbquery;
	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	COMMIT;
---------------------------------------------------------------------------------------------
VBQUERY := 'alter table zzz_rx_ANTHEM_'||vLvl.SERIALNO||' add primary key (MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVLID3)';
BEGIN
	EXECUTE IMMEDIATE VBQUERY;
    EXCEPTION WHEN OTHERS THEN NULL;
END;

  BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM CASCADE CONSTRAINTS';
  EXCEPTION
    WHEN Others THEN NULL;
  END;


  vbquery:=
  'CREATE TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM as
  SELECT
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		PRODUCTID
  FROM VH_RXCLAIMS WHERE 1=2';
  EXECUTE IMMEDIATE vbquery;

  EXECUTE IMMEDIATE 'ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
  EXECUTE IMMEDIATE 'ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM PRIMARY KEY (SRCROWID)';

--------------------------------------------------------------------------------
--  Standard Client custom mapping
---------------------------------------------------------------------------------
  SP_PYR_5585_RX_OUHL('HI0826001','HI_RX_OUHL_'||EMPID||'','RXCLAIMS','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','4');

  vblQueryName:='060_826_'||vLvl.SERIALNO||'_RX_1';
  INSERT INTO VH_QUERYLOG(QueryName,CURTIME) VALUES(vblQueryName,SYSDATE);
  COMMIT;

--------------------------------------------------------------------------------
--  Client custom mapping
---------------------------------------------------------------------------------

  vbquery:=
	'INSERT /*+ APPEND PARALLEL(a,4) */ INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM a
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		PRODUCTID
	)
	SELECT /*+ PARALLEL(a,4) */
		a.ROWID AS SRCROWID,
		''OUR HEALTH'' AS SOURCE,
		SUBSTR(COALESCE(B.MEMID,Substr(a.OURHEALTH_WELLNESS_ID,1,30)||''-''||grp.ROLLUPID),1,50) AS MEMID,
		SUBSTR(COALESCE(B.ENRID,Substr(a.OURHEALTH_WELLNESS_ID,1,15)||''-''||grp.ROLLUPID),1,20) AS ENRID,
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		NULL as LVLID2,
		NULL as LVLDESC2,
		Nvl(grp.ROLLUPID,a.company_name) AS LVLID3,
		Nvl(grp.GROUP_NAME,a.company_name) AS LVLDESC3,
		NULL as LVLID4,
		NULL as LVLDESC4,
		''1'' AS PRODUCTID
 	FROM
	  HI0826001.HI_RX_OUHL_'||EMPID||' a
	LEFT JOIN
		HR_826_GROUP grp
	ON
		a.company_name = grp.SRC_CODE
	LEFT JOIN
		zzz_rx_ANTHEM_'||vLvl.SERIALNO||' B
	ON
		Upper(a.FIRST_NAME) = B.MEMFIRSTNAME
	AND
		Upper(a.LAST_NAME) = B.MEMLASTNAME
	AND
		Decode(Upper(a.GENDER),''M'',''M'',''F'',''F'',''U'') = B.GENDER
	AND
		TO_CHAR(a.DOB,''YYYYMMDD'')= TO_CHAR(B.DOB,''YYYYMMDD'')
	AND
		Nvl(grp.ROLLUPID,a.company_name) = B.LVLID3

';
BEGIN
EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('RX-CSTM OUHL',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('RX-CSTM OUHL',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'RX','','E');
 END ;
 COMMIT;

  vblQueryName:='060_826_'||vLvl.SERIALNO||'_RX_2';
  INSERT INTO VH_QUERYLOG(QueryName,CURTIME) VALUES(vblQueryName,SYSDATE);
  COMMIT;

--------------------------------------------------------------------------------
-- Merging Standard and Client custom mapping tables
---------------------------------------------------------------------------------
  vbquery:='Merge Procedure call SP_CDF_TBL_MERGE';
   SP_CDF_TBL_MERGE(USER,'RX','VH_RXCLAIMS_'||vLvl.SERIALNO||'_COMM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_CSTM','VH_RXCLAIMS_'||vLvl.SERIALNO||'_OUHL');

  vblQueryName:='060_826_'||vLvl.SERIALNO||'_RX_3';
  INSERT INTO VH_QUERYLOG(QueryName,CURTIME) VALUES(vblQueryName,SYSDATE);
  COMMIT;
---------------------------------------------------------------------------------
VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||VLVL.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
			EXECUTE IMMEDIATE VBQUERY;
			EXCEPTION WHEN OTHERS THEN NULL;
		END;
 ----/*************************************************************************************************/
vbQuery:=
'INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
SELECT *
FROM VH_RXCLAIMS_'||vLvl.SERIALNO||'_OUHL';
------------------------------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
  xp_scrubStatusLog ('OUHL RX FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'RX','N','I');
EXCEPTION WHEN OTHERS THEN
  xp_scrubStatusLog ('OUHL RX FINAL INSERT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'RX','','E');
END;
	 COMMIT;
-----------------------------------------------------------------------------
BEGIN
	UTILITY.PKG_UPDATE.SP_LOA
	(
		FROM_TABLENAME =>	   'VH_ELIGIBILITIES_'||vLvl.SERIALNO||'',
		TO_TABLENAME =>	 'VH_RXCLAIMS_'||vLvl.SERIALNO||'',
		UPDATE_STATUS_FIELDNAME =>	  'UDFC4',
		DELIMITER =>		'-',
		UPDATE_PASSES =>	'1-2-3-4',
		LVL_UPDATE_LIST =>	  'LVLID2-LVLID4',
		LVL_DESC_YN =>	  'Y',
		PASS_1_JOIN_CONDITION =>	'[a.source]=''OUR HEALTH'' and  a.LVLID3 = b.LVLID3',
		PASS_1_UPDATE_CONDITION =>	'[a.source]=''OUR HEALTH''',
		PASS_2_JOIN_CONDITION =>	'[a.source]=''OUR HEALTH'' and  a.LVLID3 = b.LVLID3',
		PASS_2_UPDATE_CONDITION =>	'[a.source]=''OUR HEALTH'' and [a.UDFC4] IS NULL',
		PASS_3_JOIN_CONDITION =>	'[a.source]=''OUR HEALTH'' and a.LVLID3 = b.LVLID3',
		PASS_3_UPDATE_CONDITION =>	'[a.source]=''OUR HEALTH'' and [a.UDFC4] IS NULL',
		PASS_4_JOIN_CONDITION =>	'[a.source]=''OUR HEALTH'' and a.LVLID3 = b.LVLID3',
		PASS_4_UPDATE_CONDITION =>	'[a.source]=''OUR HEALTH'' and [a.UDFC4] IS NULL',
		begin_END_DTE_YN =>	 'N',
		STABLE_FROM_TABLE_YN =>	 'N',
		ORDER_BY_LIST =>	'b.LVLID2,b.LVLID4'
	);
END;
----------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------
END IF;

--------------------------------------------------NRAA PAYER IMPLEMENTATION ICE#18476--------------------------------------------------
IF  vLvl.PAYER='NRAA' THEN


	VBQUERY := 'DROP TABLE VH_RX_'||vLvl.SERIALNO||'_CSTM_NRAA PURGE';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='CREATE TABLE VH_RX_'||vLvl.SERIALNO||'_CSTM_NRAA AS
	SELECT
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID3,
		LVLDESC3,
		PRODUCTID
	FROM
		VH_RXCLAIMS
	WHERE 1=2';

	BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS CSTM - NRAA NEW',EMPID,'NRAA',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;

	VBQUERY:='ALTER TABLE VH_RX_'||vLvl.SERIALNO||'_CSTM_NRAA ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY :='ALTER TABLE VH_RX_'||vLvl.SERIALNO||'_CSTM_NRAA ADD CONSTRAINT PK_CSTM_NRAA_'||vLvl.SERIALNO||' PRIMARY KEY(SRCROWID)';
	BEGIN
		EXECUTE IMMEDIATE VBQUERY ;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	BEGIN
		SP_PYR_5682_RX_NRAA('HI0826001','HI_RX_NRAA_5682_'||EMPID||'','RXCLAIMS','VH_RX_'||vLvl.SERIALNO||'_COMM_NRAA','4');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS COMM - NRAA',EMPID,'NRAA',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_PYR_5682_RX_NRAA','','E');
	END;
	COMMIT;
----------------------------------------------------------------------------------------------------------

	vbQuery:='
	INSERT /*+ PARALLEL(TBL,4) */ INTO VH_RX_'||vLvl.SERIALNO||'_CSTM_NRAA TBL
	(
		SRCROWID,
		SOURCE,
		MEMID,
		ENRID,
		LVLID1,
		LVLDESC1,
		LVLID3,
		LVLDESC3,
		PRODUCTID
	)
	SELECT /*+ PARALLEL(a,4) */
		a.ROWID AS SRCROWID,
		''NORTH_AMERICAN_ADMIN'' AS SOURCE,
		NVL(X.MEMID,a.ENRID||Decode(Upper(a.GENDER),''M'',''M'',''F'',''F'',''U'')||To_Char(a.DOB,''YYYYMMDD'') || ''-'' || GRP.rollupid) AS MEMID,
		NVL(X.ENRID,a.ENRID || ''-'' || GRP.rollupid) AS ENRID,
		''C'' AS LVLID1,
		''Commercial'' AS LVLDESC1,
		NVL(GRP.rollupid , EMP_NBR) AS LVLID3,
		NVL(GRP.group_name , EMP_NBR ) AS LVLDESC3,
		''1'' AS PRODUCTID
	FROM
		HI0826001.HI_RX_NRAA_5682_'||EMPID||' a
	LEFT JOIN
		HR_826_GROUP GRP
	ON
		case when upper(a.sourceFileName) like ''%PHARMACY_S93%'' THEN ''NAA_DUNCAN'' END = grp.src_code
	LEFT JOIN
	ZZZ_ELIG_NRAA_'||vLvl.SERIALNO||' X
 ON
	UPPER(a.MEMFIRSTNAME)=X.MEMFIRSTNAME
 AND
	UPPER(A.MEMLASTNAME)=X.MEMLASTNAME
 AND
	A.DOB =X.DOB
 AND
	Decode(Upper(a.GENDER),''M'',''M'',''F'',''F'',''U'')=X.GENDER
AND
	NVL(GRP.rollupid , EMP_NBR) = X.LVLID3
	';

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('RXCLAIMS CSTM - NRAA - INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_NRAA_5682_'||EMPID,'Y','I');
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS CSTM - NRAA - INSERT',EMPID,'NRAA',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;
	COMMIT;
------------------------------------------------------------------------------------------------------------------
	BEGIN
		SP_CDF_TBL_MERGE(USER,'RXCLAIMS-MERGE NRAA','VH_RX_'||vLvl.SERIALNO||'_COMM_NRAA','VH_RX_'||vLvl.SERIALNO||'_CSTM_NRAA','VH_RX_'||vLvl.SERIALNO||'_NRAA');
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS-MERGE NRAA',EMPID,'NRAA',SQLCODE,substr(SQLERRM, 1,400),'',0,'SP_CDF_TBL_MERGE','','E');
	END;
	COMMIT;


------------------------------------------------------------------------------------------------------------------
-- LOA UPDATE FROM ELIG

--1st pass

	vbQuery:=
	'MERGE INTO VH_RX_'||vLvl.SERIALNO||'_NRAA c
	USING
	(
    SELECT /*+ PARALLEL(f,4) */
      f.MEMID,f.lvlid3, f.filldate, f.lvlid2,f.lvldesc2,f.lvlid4,f.lvldesc4
    FROM
		(
			SELECT /*+ PARALLEL(a,4) */
				b.MEMID,b.lvlid3, a.filldate,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4,b.EFFDATE, b.TERMDATE,
				ROW_NUMBER() OVER (PARTITION BY b.MEMID,b.lvlid3,a.filldate ORDER BY b.TERMDATE desc, b.EFFDATE desc, b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4) rn
			FROM
        VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  b
			INNER JOIN
        VH_RX_'||vLvl.SERIALNO||'_NRAA a
			ON
        b.MEMID=a.MEMID
			AND
			  b.lvlid3=a.lvlid3
			AND
        NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
     ) f WHERE rn=1
	) d
	ON
	(
    c.MEMID=d.MEMID
		  AND
    NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
		  AND
		c.lvlid3=d.lvlid3
    )
	WHEN MATCHED THEN UPDATE SET
    c.LVLID2= d.LVLID2, c.LVLDESC2= d.LVLDESC2,
    c.LVLID4= d.LVLID4, c.LVLDESC4= d.LVLDESC4
	';
	BEGIN
		EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS NRAA NEW UPDATE PASS 1',EMPID,'NRAA',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;
	COMMIT;

----------------------------------------------------------------------------------------------------------------------------------------------------------
--2nd pass
	vbQuery:=
	'MERGE INTO VH_RX_'||vLvl.SERIALNO||'_NRAA c
	USING
	(
     SELECT /*+ PARALLEL(f,4) */
		    f.MEMID,f.lvlid3, f.lvlid2,f.lvldesc2,f.lvlid4,f.lvldesc4
     FROM
		(
			SELECT /*+ PARALLEL(a,4) */
				b.MEMID,b.lvlid3,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4,
				ROW_NUMBER() OVER (PARTITION BY b.MEMID,b.lvlid3 ORDER BY b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4) rn
			FROM
        VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  b
			INNER JOIN
        VH_RX_'||vLvl.SERIALNO||'_NRAA a
			ON
        b.MEMID=a.MEMID
			AND
			  b.lvlid3=a.lvlid3
		) f
      WHERE rn=1
	) d
	ON
	(
    c.MEMID=d.MEMID
		AND
		c.lvlid3=d.lvlid3
   )
	WHEN MATCHED THEN UPDATE SET
    c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
    c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4
	WHERE c.LVLID2 IS NULL
	';

	 BEGIN
		EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS NRAA NEW UPDATE PASS 2',EMPID,'NRAA',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
	 
--3rd pass

	vbQuery:=
	'MERGE INTO VH_RX_'||vLvl.SERIALNO||'_NRAA c
	USING
	(
    SELECT /*+ PARALLEL(f,4) */
      f.ENRID,f.lvlid3, f.filldate, f.lvlid2,f.lvldesc2,f.lvlid4,f.lvldesc4
    FROM
		(
			SELECT /*+ PARALLEL(a,4) */
				b.ENRID,b.lvlid3, a.filldate,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4,b.EFFDATE, b.TERMDATE,
				ROW_NUMBER() OVER (PARTITION BY b.ENRID,b.lvlid3,a.filldate ORDER BY b.TERMDATE desc, b.EFFDATE desc, b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4) rn
			FROM
        VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  b
			INNER JOIN
        VH_RX_'||vLvl.SERIALNO||'_NRAA a
			ON
        b.ENRID=a.ENRID
			AND
			  b.lvlid3=a.lvlid3
			AND
        NVL( a.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) BETWEEN NVL(b.EFFDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) AND  NVL(b.TERMDATE, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
     ) f WHERE rn=1
	) d
	ON
	(
    c.ENRID=d.ENRID
		  AND
    NVL(c.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) =   NVL(d.filldate, TO_DATE(''12-31-9999'',''MM-DD-YYYY''))
		  AND
		c.lvlid3=d.lvlid3
    )
	WHEN MATCHED THEN UPDATE SET
    c.LVLID2= d.LVLID2, c.LVLDESC2= d.LVLDESC2,
    c.LVLID4= d.LVLID4, c.LVLDESC4= d.LVLDESC4
	';
	BEGIN
		EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('RXCLAIMS NRAA NEW UPDATE PASS 3',EMPID,'NRAA',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	END;
	COMMIT;

----------------------------------------------------------------------------------------------------------------------------------------------------------
--4th pass
	vbQuery:=
	'MERGE INTO VH_RX_'||vLvl.SERIALNO||'_NRAA c
	USING
	(
     SELECT /*+ PARALLEL(f,4) */
		    f.ENRID,f.lvlid3, f.lvlid2,f.lvldesc2,f.lvlid4,f.lvldesc4
     FROM
		(
			SELECT /*+ PARALLEL(a,4) */
				b.ENRID,b.lvlid3,b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4,
				ROW_NUMBER() OVER (PARTITION BY b.ENRID,b.lvlid3 ORDER BY b.lvlid2,b.lvldesc2,b.lvlid4,b.lvldesc4) rn
			FROM
        VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  b
			INNER JOIN
        VH_RX_'||vLvl.SERIALNO||'_NRAA a
			ON
        b.ENRID=a.ENRID
			AND
			  b.lvlid3=a.lvlid3
		) f
      WHERE rn=1
	) d
	ON
	(
    c.ENRID=d.ENRID
		AND
		c.lvlid3=d.lvlid3
   )
	WHEN MATCHED THEN UPDATE SET
    c.LVLID2=d.LVLID2, c.LVLDESC2=d.LVLDESC2,
    c.LVLID4=d.LVLID4, c.LVLDESC4=d.LVLDESC4
	WHERE c.LVLID2 IS NULL
	';

	 BEGIN
		EXECUTE IMMEDIATE vbquery;
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('RXCLAIMS NRAA NEW UPDATE PASS 4',EMPID,'NRAA',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT; 
--------------------------------------------------------------------------------------------

---------------------------------- NRAA NEW FINAL INSERT ---------------------------------------------------------------

	VBQUERY:='ALTER TABLE VH_RXCLAIMS_'||vLvl.SERIALNO||' ADD SRCROWID VARCHAR2(200)';
    BEGIN
		EXECUTE IMMEDIATE VBQUERY;
		EXCEPTION WHEN OTHERS THEN NULL;
	END;

	VBQUERY:='INSERT INTO VH_RXCLAIMS_'||vLvl.SERIALNO||'  a
          SELECT * FROM VH_RX_'||vLvl.SERIALNO||'_NRAA';

	BEGIN
		EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('NRAARX NEW FINAL INSERT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_RX_NRAA_5682_'||EMPID,'Y','I');
		EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('NRAARX NEW FINAL INSERT',EMPID,'NRAA',SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;

END IF;

---------------------------------------------------------------------------------------------------------------------------

----------------**************************END OF RXCLAIMS  *********************-----------------
tablename:='VH_RXCLAIMS_'||vLvl.SERIALNO;
vbQuery:='INSERT INTO ZZZ_PACKAGE_MERGE VALUES('''||tablename||''','''||EmpID||''',''RX'','''||vLvl.SERIALNO||''')';

---------------------------------------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
EXCEPTION WHEN OTHERS THEN
xp_scrubStatusLog ('RX',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'INSERT INTO ZZZ_PACKAGE_MERGE VALUES RX','','E');
END;
-------------------------------------------------------------------------------------------------


END LOOP;

D2SCRUB.signalCompletion(SchemaName || '.SP_SR('''||EMPID||''')');

END SP_SR;
/

--------------------------------------------------------------------------------
CREATE OR REPLACE PROCEDURE SP_LB(EMPID IN VARCHAR2) IS
	vbQuery LONG;
	tablename VARCHAR2(50);
	vblStaticDate DATE;
	vbDate LONG;
	SchemaName VARCHAR2(20);


BEGIN
	SELECT sys_context('USERENV', 'CURRENT_USER') INTO SchemaName FROM dual;
	SELECT TO_DATE('12-31-9999','MM-DD-YYYY') INTO vblStaticDate FROM DUAL;



FOR vLvl IN (SELECT DISTINCT SERIALNO,PAYER,EMPGRPID,replace(EMPGRPNAME,'''','''''')EMPGRPNAME  FROM HR_826_PKG_EMPPAYER  WHERE EMPGRPID=''||EmpID||'' AND  SET1='LAB')

	LOOP
	       DBMS_OUTPUT.PUT_LINE(EmpID);

------------------------------- LAB_START-------------------------------------------------------

	IF  vLvl.PAYER='WLVB' THEN
	---------------------------------------------------------------------------------------------------------
  BEGIN EXECUTE IMMEDIATE 'DROP TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM '; EXCEPTION WHEN Others THEN NULL; END;

	vbQuery:='CREATE TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM nologging as
				SELECT
					MEMID
				FROM
					VH_LABDATA
				WHERE 1=2';

	EXECUTE IMMEDIATE vbquery;

	EXECUTE IMMEDIATE 'ALTER TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
	EXECUTE IMMEDIATE 'ALTER TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM ADD PRIMARY KEY (SRCROWID)';

    SP_PYR_3970_LAB_WLVB('HI0826001','HI_LAB_'||vLvl.PAYER||'_016','LAB','VH_LAB_'||vLvl.SERIALNO||'_COMM',4);

	--temp table
	BEGIN EXECUTE IMMEDIATE 'DROP TABLE ZZZ_MEMID_WLVB'; EXCEPTION WHEN Others THEN NULL; END;

	vbQuery:='CREATE TABLE ZZZ_MEMID_WLVB nologging as
				SELECT memID,memFirstName,memLastName,dob
			FROM
			(
				SELECT memID,memFirstName,memLastName,dob,
				Row_Number()over(PARTITION BY memFirstName,memLastName,dob ORDER BY memID)rn
				FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  WHERE MEMID IS NOT NULL
			)x WHERE rn=1';

	EXECUTE IMMEDIATE vbQuery;
	---------------------------------------------------------------------------------------------
	 vbquery:='INSERT /*+ APPEND PARALLEL(a,4) */ INTO VH_LAB_'||vLvl.SERIALNO||'_CSTM a
		(
			SRCROWID,
			MEMID
		)
	SELECT /*+ PARALLEL(a,4) */
		a.ROWID AS SRCROWID,
		coalesce(mid.MEMID,NVL(a.MEMBERS_ID,''MEMID''))  AS MEMID
	FROM
		HI0826001.HI_LAB_'||vLvl.PAYER||'_016 a
	LEFT JOIN
		ZZZ_MEMID_WLVB mid
	ON
			upper(a.first_name) = upper(mid.memFirstName) AND
			upper(a.last_name) = upper(mid.memLastName) AND
			a.date_of_birth = mid.dob
			';
--Defect#330915
	EXECUTE IMMEDIATE vbquery;
	commit;
		xp_scrubStatusLog ('LAB-WLVB',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_LAB_WLVB_016','Y','I');
	COMMIT;

	SP_CDF_TBL_MERGE(USER,'LAB','VH_LAB_'||vLvl.SERIALNO||'_COMM','VH_LAB_'||vLvl.SERIALNO||'_CSTM','VH_LAB_'||vLvl.SERIALNO);


	---------------------------------------------------------------------------------------------
	vbquery:='
	INSERT  INTO  VH_LABDATA
	(
		memid,
		cpt4,
		labcode,
		labvalue,
		servicedate,
		pnindicator,
		labid,
		uselabvalue,
		vhpayorid,
		vhlayoutid,
		labresulttext,
		labrecordnumber,
		refrencerangelow,
		refrencerangehigh,
		abnormalvalue,
		codetype,
		RCVMTH, 			--ICE#4326
		SRCFILENAME,
		AIFILEID,
		AIROWNUMBER,
		labvalueunit
	)
	SELECT DISTINCT
		a.memid,
		a.cpt4,
		a.labcode,
		a.labvalue,
		a.servicedate,
		a.pnindicator,
		a.labid,
		a.uselabvalue,
		a.vhpayorid AS vhpayorid,
		a.vhlayoutid AS vhlayoutid,
		a.labresulttext,
		a.labrecordnumber,
		a.REFRENCERANGELOW as refrencerangelow,
		a.REFRENCERANGEHIGH as refrencerangehigh,
		a.abnormalvalue,
		a.codetype,
		A.RCVMTH,
		a.SRCFILENAME,
		a.AIFILEID,
		a.AIROWNUMBER,
		a.labvalueunit
	FROM
		VH_LAB_'||vLvl.SERIALNO||' a';

---------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('MERGE LAB-WLVB',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_LAB_WLVB_016','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('MERGE LAB-WLVB',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------
END IF;


------------------------------------ICE 212017-------231742------------------------------
IF  vLvl.PAYER='HLTW' THEN
	---------------------------------------------------------------------------------------------------------
  BEGIN EXECUTE IMMEDIATE 'DROP TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM '; EXCEPTION WHEN Others THEN NULL; END;

	vbQuery:='CREATE TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM nologging as
				SELECT
					MEMID
				FROM
					VH_LABDATA
				WHERE 1=2';

	EXECUTE IMMEDIATE vbquery;

	EXECUTE IMMEDIATE 'ALTER TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
	EXECUTE IMMEDIATE 'ALTER TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM ADD PRIMARY KEY (SRCROWID)';

    --SP_PYR_4291_LAB_HLTW('HI0826001','HI_LAB_'||vLvl.PAYER||'_SHLE','LAB','VH_LAB_'||vLvl.SERIALNO||'_COMM',4);
    SP_PYR_4291_LAB_HLTW('HI0826001','HI_LAB_HLTW_'||EMPID||'','LAB','VH_LAB_'||vLvl.SERIALNO||'_COMM',4);

	--temp table
	BEGIN EXECUTE IMMEDIATE 'DROP TABLE ZZZ_MEMID_HLTW_'||vLvl.SERIALNO ; EXCEPTION WHEN Others THEN NULL; END;

--	vbQuery:='CREATE TABLE ZZZ_MEMID_HLTW nologging as  ----ICE 340139
	vbQuery:='CREATE TABLE ZZZ_MEMID_HLTW_'||vLvl.SERIALNO||' nologging as ';
  IF EMPID IN ('WSTR','TAHO','ATRM') THEN   --ICE 366865,10888
	VBQUERY := VBQUERY || ' SELECT memID,memFirstName,memLastName,dob
			FROM
			(
				SELECT memID,memFirstName,memLastName,dob,
				Row_Number()over(PARTITION BY memFirstName,memLastName,dob ORDER BY memID) rn ';
	ELSIF EMPID IN ('CLGN') THEN --ICE#9832
    	VBQUERY := VBQUERY || ' SELECT memID,memFirstName,memLastName,dob
			FROM
			(
				SELECT memID,CASE WHEN instr(memFirstName, '' '') = 0
						THEN memFirstName
						ELSE substr(memFirstName, 1,instr(memFirstName, '' '') -1) end memFirstName,
						CASE WHEN instr(memLastName, '' '') = 0
						THEN memLastName
						ELSE substr(memLastName, 1,instr(memLastName, '' '') -1) end memLastName,dob,
						Row_Number()over(PARTITION BY CASE WHEN instr(memFirstName, '' '') = 0
						THEN memFirstName
						ELSE substr(memFirstName, 1,instr(memFirstName, '' '') -1) end,
						CASE WHEN instr(memLastName, '' '') = 0
						THEN memLastName
						ELSE substr(memLastName, 1,instr(memLastName, '' '') -1) end,dob ORDER BY effdate desc, termdate desc,memID)rn';
    ELSE
    	VBQUERY := VBQUERY || ' SELECT memID,memFirstName,memLastName,dob, enrid
			FROM
			(
				SELECT memID,memFirstName,memLastName,dob,enrid,
				Row_Number()over(PARTITION BY memFirstName,memLastName,dob, enrid ORDER BY memID)rn ';
    END IF;
      	VBQUERY := VBQUERY || '
				FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  WHERE MEMID IS NOT NULL
			)x WHERE rn=1';

	EXECUTE IMMEDIATE vbQuery;
	---------------------------------------------------------------------------------------------
	 vbquery:='INSERT /*+ APPEND PARALLEL(a,4) */ INTO VH_LAB_'||vLvl.SERIALNO||'_CSTM a
		(
			SRCROWID,
			MEMID
		)
	SELECT /*+ PARALLEL(a,4) */
		a.ROWID AS SRCROWID,
     ';
  IF EMPID IN ('WSTR', 'CLGN','ATRM') THEN --ICE#9832,10888
  VBQUERY := VBQUERY || ' 	NVL(mid.MEMID ,''MEMID'')  AS MEMID ';
  ELSE
	 VBQUERY := VBQUERY || ' 	coalesce(mid.MEMID,NVL(a.SSN || TO_CHAR(a.DOB,''YYYYMMDD'') ,''MEMID''))  AS MEMID ';
  END IF;
   VBQUERY := VBQUERY || '
	FROM
--		HI0826001.HI_LAB_'||vLvl.PAYER||'_SHLE a
      HI0826001.HI_LAB_HLTW_'||EMPID||' a
      	LEFT JOIN
		ZZZ_MEMID_HLTW_'||vLvl.SERIALNO||' mid
   -- ZZZ_MEMID_HLTW mid
	ON
			Upper(A.FIRST_NAME) = mid.memFirstName AND
			Upper(A.LAST_NAME) = mid.memLastName AND
			To_Char(A.DOB, ''YYYYMMDD'') = To_Char(MID.DOB, ''YYYYMMDD'') ';
    IF EMPID NOT IN ('WSTR','TAHO','CLGN','ATRM') THEN    --ICE 366865,9832,10888
		VBQUERY := VBQUERY || ' AND	NVL(a.ssn, ''NULL'')=NVL(mid.enrid, ''NULL'') ';
    ELSE
    	VBQUERY := VBQUERY ;
    END IF;


	EXECUTE IMMEDIATE vbquery;
	commit;
		--xp_scrubStatusLog ('LAB-HLTW',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_LAB_HLTW_SHLE','Y','I');
    xp_scrubStatusLog ('LAB-HLTW',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_LAB_HLTW_'||EMPID||'','Y','I');

	COMMIT;

	SP_CDF_TBL_MERGE(USER,'LAB','VH_LAB_'||vLvl.SERIALNO||'_COMM','VH_LAB_'||vLvl.SERIALNO||'_CSTM','VH_LAB_'||vLvl.SERIALNO);


	---------------------------------------------------------------------------------------------
	vbquery:='
	INSERT  INTO  VH_LABDATA
	(
		memid,
		cpt4,
		labcode,
		labvalue,
		servicedate,
		pnindicator,
		labid,
		uselabvalue,
		vhpayorid,
		vhlayoutid,
		labresulttext,
		labrecordnumber,
		refrencerangelow,
		refrencerangehigh,
		abnormalvalue,
		codetype,
		RCVMTH,
		SRCFILENAME,
		AIFILEID,
		AIROWNUMBER,
		labvalueunit
	)
	SELECT DISTINCT
		a.memid,
		a.cpt4,
		a.labcode,
		a.labvalue,
		a.servicedate,
		a.pnindicator,
		a.labid,
		a.uselabvalue,
		a.vhpayorid AS vhpayorid,
		a.vhlayoutid AS vhlayoutid,
		a.labresulttext,
		a.labrecordnumber,
		a.REFRENCERANGELOW as refrencerangelow,
		a.REFRENCERANGEHIGH as refrencerangehigh,
		a.abnormalvalue,
		a.codetype,
		a.RCVMTH, 				--ICE#4326
		a.SRCFILENAME,
		a.AIFILEID,
		a.AIROWNUMBER,
		a.labvalueunit
	FROM
		VH_LAB_'||vLvl.SERIALNO||' a';

---------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('MERGE LAB-HLTW',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_LAB_HLTW_'||EMPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('MERGE LAB-HLTW',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------
END IF;
--------------------------------------ICE 212017 END - ---231742----



---------------------------------------------------------------------------------------------------
--BEGIN EXECUTE IMMEDIATE vbquery;
--EXCEPTION WHEN OTHERS THEN
--xp_scrubStatusLog ('RX',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'INSERT INTO ZZZ_PACKAGE_MERGE VALUES RX','','E');
--END;
-------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------
--Ice # 173695 START OF THE lAB iMPLEMENTATION FOR THE GREENVILLE TECHNOLOGIES - GTI
--------------------------------------------------------------------------------------------
IF  vLvl.PAYER='CRHT' THEN
--------------------------------------------------------------------------------------------
----------------------TEMP TABLE OF MASTER LAB TABLE(M_LABCATEGORY)-------------
BEGIN
		EXECUTE IMMEDIATE'DROP TABLE ZZZ_LABCODE_CRHT PURGE';
		EXCEPTION WHEN OTHERS THEN NULL;
END;

BEGIN
	EXECUTE IMMEDIATE '
		CREATE TABLE ZZZ_LABCODE_CRHT
		(
			LABCODE VARCHAR2(10),
			CODETYPE VARCHAR2(200),
			REFRENCERANGELOW VARCHAR2(50),
			REFRENCERANGEHIGH VARCHAR2(50),
			LABVALUEUNIT  VARCHAR2(50),
			PRIMARY KEY(LABCODE)
		)NOLOGGING';
	EXCEPTION WHEN OTHERS THEN NULL;
END;

BEGIN
	EXECUTE IMMEDIATE '
		INSERT INTO ZZZ_LABCODE_CRHT
		(
			LABCODE,CODETYPE,REFRENCERANGELOW,REFRENCERANGEHIGH,LABVALUEUNIT
		)
		SELECT
			LABCODE,
			MIN(CODETYPE) AS CODETYPE,
			REFRENCERANGELOW,
			REFRENCERANGEHIGH,
			LABVALUEUNIT
		FROM
			HAWKEYEMASTER.M_LABCATEGORY
		GROUP BY
			LABCODE,REFRENCERANGELOW,REFRENCERANGEHIGH,LABVALUEUNIT';

	--EXCEPTION WHEN OTHERS THEN NULL;
END;

COMMIT;
-----------------------END OF TEMP MASTER LAB TABLE(M_LABCATEGORY)--------------

BEGIN EXECUTE IMMEDIATE 'DROP TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM '; EXCEPTION WHEN Others THEN NULL; END;

	vbQuery:='CREATE TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM nologging as
				SELECT
					MEMID,
					LABCODE,
					REFRENCERANGELOW,
					REFRENCERANGEHIGH
				FROM
					VH_LABDATA
				WHERE 1=2';

	EXECUTE IMMEDIATE vbquery;

	EXECUTE IMMEDIATE 'ALTER TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
	EXECUTE IMMEDIATE 'ALTER TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM ADD CONSTRAINT PK_LAB_'||vLvl.SERIALNO||'_CSTM PRIMARY KEY (SRCROWID)';

    SP_PYR_4052_LAB_CRHT('HI0826001','HI_LAB_'||vLvl.PAYER||'_022','LAB','VH_LAB_'||vLvl.SERIALNO||'_COMM',4);

--temp table
BEGIN EXECUTE IMMEDIATE 'DROP TABLE ZZZ_ELIG_ANTH_ANTHRDX'; EXCEPTION WHEN Others THEN NULL; END;
vbQuery:='CREATE TABLE ZZZ_ELIG_ANTH_ANTHRDX nologging AS
SELECT
	COALESCE(REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~''),''MEMBERID'') AS MemID,
	UPPER(a.MBR_FIRST_NM) AS MemFirstName,
	UPPER(a.MBR_LAST_NM) AS MemLastName,
	CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END AS  Gender,
	a.MBR_BRTH_DT  AS DOB,
	a.MBR_EFCTV_DT AS EffDate
FROM
		HI0826001.HI_ELIG_ANTHEM_GTEG a
LEFT JOIN
		HR_826_ANTHEM_PLAN pl
	ON
		a.ACCT_NBR = pl.ACCT_NBR
	AND
		UPPER(a.PKG_NBR) = pl.src_code
WHERE NVL(pl.DROP_PLAN,''N'')=''N''
UNION
SELECT
	CASE WHEN a.ACCT_NBR IN (''00123728'', ''00172918'', ''00172421'', ''00169440'', ''00070454'') THEN COALESCE(REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~''),''MEMBERID'') ELSE a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'') END AS MemID,
	UPPER(a.MBR_FIRST_NM) AS MemFirstName,
	UPPER(a.MBR_LAST_NM) AS MemLastName,
	CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END AS  Gender,
	a.MBR_BRTH_DT  AS DOB,
	a.MBR_EFCTV_DT AS EffDate
FROM
		HI0826001.HI_ELIG_ANTHEM_GRTI a
LEFT JOIN
		HR_826_ANTHEM_PLAN pl
	ON
		a.ACCT_NBR = pl.ACCT_NBR
	AND
		UPPER(a.PKG_NBR) = pl.src_code
WHERE NVL(pl.DROP_PLAN,''N'')=''N''
';

EXECUTE IMMEDIATE vbQuery;


BEGIN EXECUTE IMMEDIATE 'DROP TABLE ZZZ_MEMID_CRHT'; EXCEPTION WHEN Others THEN NULL; END;

	vbQuery:='CREATE TABLE ZZZ_MEMID_CRHT nologging as
				SELECT
				memID,memFirstName,memLastName,dob,gender
			FROM
			(
				SELECT memID,memFirstName,memLastName,dob,gender,
				Row_Number()over(PARTITION BY memFirstName,memLastName,dob,gender ORDER BY EFFDATE DESC, memID)rn
				FROM VH_ELIGIBILITIES  where memid is not null and Lvlid3 IN (''GTEG'',''GRTI'')    --12154
			)x WHERE rn=1';

EXECUTE IMMEDIATE vbQuery;

 vbquery:='INSERT /*+ APPEND PARALLEL(a,4) */ INTO VH_LAB_'||vLvl.SERIALNO||'_CSTM a
	(
		SRCROWID,
		MEMID,
		LABCODE,
		REFRENCERANGELOW,
		REFRENCERANGEHIGH
	)
SELECT /*+ PARALLEL(a,4) */
	a.ROWID AS SRCROWID,
	coalesce(mid.MEMID,REPLACE(a.SOCIAL_SECURITY_NUMBER,''.'')||DECODE(UPPER(REPLACE(a.GENDER,''.'')), ''M'',''M'',''F'',''F'',''U'')||TO_CHAR(a.DATE_OF_BIRTH,''MMDDYYYY''),''MEMID'')  AS MEMID,
	COALESCE(lab.LABCODE, b.LAB_CODE) AS LABCODE,
	COALESCE(lab.REFRENCERANGELOW, b.REFRENCERANGELOW) AS REFRENCERANGELOW,
	COALESCE(lab.REFRENCERANGEHIGH, b.REFRENCERANGEHIGH) AS REFRENCERANGEHIGH
FROM
	HI0826001.HI_LAB_'||vLvl.PAYER||'_022 a
LEFT JOIN
	ZZZ_MEMID_CRHT mid
ON
		upper(a.first_name) = mid.memFirstName AND
		upper(a.last_name) = mid.memLastName AND
		a.date_of_birth = mid.dob AND
		upper(a.gender) = mid.gender
LEFT JOIN
	ZZZ_LABCODE_CRHT lab
ON
	a.CODE = lab.LABCODE
LEFT JOIN
	HR_826_LAB_CRHT b
ON
	UPPER(a.TEST) = b.SRC_LAB_DESC
';

EXECUTE IMMEDIATE vbquery;
commit;
	xp_scrubStatusLog ('LAB-CRHT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_LAB_CRHT_022','Y','I');
COMMIT;

SP_CDF_TBL_MERGE(USER,'LAB-CRHT','VH_LAB_'||vLvl.SERIALNO||'_COMM','VH_LAB_'||vLvl.SERIALNO||'_CSTM','VH_LAB_'||vLvl.SERIALNO);


---------------------------------------------------------------------------------------------
vbquery:='
INSERT  INTO  VH_LABDATA
(
	memid,
	cpt4,
	labcode,
	labvalue,
	servicedate,
	pnindicator,
	labid,
	uselabvalue,
	vhpayorid,
	vhlayoutid,
	labresulttext,
	labrecordnumber,
	refrencerangelow,
	refrencerangehigh,
	abnormalvalue,
	codetype,
	RCVMTH,
	SRCFILENAME,
	AIFILEID,
	AIROWNUMBER,
	labvalueunit
)
SELECT DISTINCT
	a.memid,
	a.cpt4,
	a.labcode,
	a.labvalue,
	a.servicedate,
	a.pnindicator,
	a.labid,
	a.uselabvalue,
	a.vhpayorid AS vhpayorid,
	a.vhlayoutid AS vhlayoutid,
	a.labresulttext,
	a.labrecordnumber,
	a.REFRENCERANGELOW as refrencerangelow,
	a.REFRENCERANGEHIGH as refrencerangehigh,
	a.abnormalvalue,
	a.codetype,
	a.RCVMTH, 			--ICE#4326
	a.SRCFILENAME,
	a.AIFILEID,
	a.AIROWNUMBER,
	a.labvalueunit
FROM
	VH_LAB_'||vLvl.SERIALNO||' a';

---------------------------------------------------------------------------------------------
 BEGIN EXECUTE IMMEDIATE vbquery;
	 xp_scrubStatusLog ('MERGE LAB',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_LAB_CRHT_022','Y','I');
 EXCEPTION WHEN OTHERS THEN
	 xp_scrubStatusLog ('MERGE LAB',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
 END;
 COMMIT;
----------------------------------------------------------------------------
END IF;
----------------------------------------------------------------------------
--END OF THE lAB iMPLEMENTATION FOR THE GREENVILLE TECHNOLOGIES - GTI
----------------------------------------------------------------------------
--------------------------------------START OF ICE 5548------------------------------
IF  vLvl.PAYER='AYWS' THEN
--------------------------------------------------------------------------------------------
----------------------TEMP TABLE OF MASTER LAB TABLE(M_LABCATEGORY)-------------
--DBMS_OUTPUT.PUT_LINE( EMPID);

BEGIN EXECUTE IMMEDIATE 'DROP TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM '; EXCEPTION WHEN Others THEN NULL; END;

	vbQuery:='CREATE TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM nologging as
				SELECT
					MEMID
				FROM
					VH_LABDATA
				WHERE 1=2';

	EXECUTE IMMEDIATE vbquery;

	EXECUTE IMMEDIATE 'ALTER TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
	EXECUTE IMMEDIATE 'ALTER TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM ADD PRIMARY KEY (SRCROWID)';

    SP_PYR_5422_LAB_AYWS('HI0826001','HI_LAB_AYWS_5422_GRTI','LABDATA','VH_LABDATA_AYWS_COMM','4');
--temp table
BEGIN EXECUTE IMMEDIATE 'DROP TABLE ZZZ_ELIG_ANTHRDX_AYWS'; EXCEPTION WHEN Others THEN NULL; END;
vbQuery:='CREATE TABLE ZZZ_ELIG_ANTHRDX_AYWS nologging AS
SELECT
	CASE WHEN a.ACCT_NBR IN (''00123728'', ''00172918'', ''00172421'', ''00169440'', ''00070454'') THEN COALESCE(REPLACE(a.SBSCRBR_ID||SubStr(a.MBR_SQNC_NBR,1,2),''~''),''MEMBERID'') ELSE a.SBSCRBR_ID|| Decode(Upper(a.MBR_GNDR_CD),''F'',''F'',''M'',''M'',''U'')||To_Char(a.MBR_BRTH_DT,''YYYYMMDD'') END AS MemID,
	UPPER(a.MBR_FIRST_NM) AS MemFirstName,
	UPPER(a.MBR_LAST_NM) AS MemLastName,
	CASE WHEN a.MBR_GNDR_CD IN (''F'',''M'') THEN a.MBR_GNDR_CD ELSE ''U'' END AS  Gender,
	a.MBR_BRTH_DT  AS DOB,
	a.MBR_EFCTV_DT AS EffDate
FROM
		HI0826001.HI_ELIG_ANTHEM_GRTI a
LEFT JOIN
		HR_826_ANTHEM_PLAN pl
	ON
		a.ACCT_NBR = pl.ACCT_NBR
	AND
		UPPER(a.PKG_NBR) = pl.src_code
WHERE NVL(pl.DROP_PLAN,''N'')=''N''
';

BEGIN EXECUTE IMMEDIATE vbQuery;
 xp_scrubStatusLog ('CREATE MEMID TABLE-AYWS',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_ELIG_ANTHEM_GRTI','Y','I');
EXCEPTION WHEN OTHERS THEN
 xp_scrubStatusLog ('CREATE MEMID TABLE-AYWS',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;
COMMIT;



BEGIN EXECUTE IMMEDIATE 'DROP TABLE ZZZ_MEMID_AYWS'; EXCEPTION WHEN Others THEN NULL; END;

	vbQuery:='CREATE TABLE ZZZ_MEMID_AYWS nologging as
				SELECT
				memID,memFirstName,memLastName,dob,gender
			FROM
			(
				SELECT memID,memFirstName,memLastName,dob,gender,
				Row_Number()over(PARTITION BY memFirstName,memLastName,dob ORDER BY EFFDATE DESC, memID)rn
				FROM VH_ELIGIBILITIES  where memid is not null and Lvlid3 IN (''GTEG'',''GRTI'') --12154
			)x WHERE rn=1';

BEGIN EXECUTE IMMEDIATE vbQuery;
 xp_scrubStatusLog ('CREATE MEMID TABLE1-AYWS',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_LAB_AYWS_5422_GRTI','Y','I');
EXCEPTION WHEN OTHERS THEN
 xp_scrubStatusLog ('CREATE MEMID TABLE1-AYWS',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;
COMMIT;

 vbquery:='INSERT /*+ APPEND PARALLEL(a,4) */ INTO VH_LAB_'||vLvl.SERIALNO||'_CSTM a
	(
		SRCROWID,
		MEMID
	)
SELECT /*+ PARALLEL(a,4) */
	a.ROWID AS SRCROWID,
	coalesce(mid.MEMID,replace(a.UNIQUE_ID,''#N/A'')||TO_CHAR(a.DATE_OF_BIRTH,''YYYYMMDD''),''MEMID'')  AS MEMID
FROM
	HI0826001.HI_LAB_AYWS_5422_GRTI a
LEFT JOIN
	ZZZ_MEMID_AYWS mid
ON
		upper(a.first_name) = mid.memFirstName AND
		upper(a.last_name) = mid.memLastName AND
		a.date_of_birth = mid.dob
';

BEGIN EXECUTE IMMEDIATE vbquery;
	 xp_scrubStatusLog ('INSERT INTO CUSTOM LAB',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_LAB_AYWS_5422_GRTI','Y','I');
 EXCEPTION WHEN OTHERS THEN
	 xp_scrubStatusLog ('INSERT INTO CUSTOM LAB',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
 END;
 COMMIT;

SP_CDF_TBL_MERGE(USER,'LAB-AYWS','VH_LABDATA_AYWS_COMM','VH_LAB_'||vLvl.SERIALNO||'_CSTM','VH_LAB_'||vLvl.SERIALNO);


---------------------------------------------------------------------------------------------
vbquery:='
INSERT  INTO  VH_LABDATA
(
	memid,
	cpt4,
	labcode,
	labvalue,
	servicedate,
	pnindicator,
	labid,
	uselabvalue,
	vhpayorid,
	vhlayoutid,
	labresulttext,
	labrecordnumber,
	refrencerangelow,
	refrencerangehigh,
	abnormalvalue,
	codetype,
	RCVMTH,
	SRCFILENAME,
	AIFILEID,
	AIROWNUMBER,
	labvalueunit
)
SELECT DISTINCT
	a.memid,
	a.cpt4,
	a.labcode,
	a.labvalue,
	a.servicedate,
	a.pnindicator,
	a.labid,
	a.uselabvalue,
	a.vhpayorid AS vhpayorid,
	a.vhlayoutid AS vhlayoutid,
	a.labresulttext,
	a.labrecordnumber,
	a.REFRENCERANGELOW as refrencerangelow,
	a.REFRENCERANGEHIGH as refrencerangehigh,
	a.abnormalvalue,
	a.codetype,
	a.RCVMTH,
	a.SRCFILENAME,
	a.AIFILEID,
	a.AIROWNUMBER,
	a.labvalueunit
FROM
	VH_LAB_'||vLvl.SERIALNO||' a';

---------------------------------------------------------------------------------------------
 BEGIN EXECUTE IMMEDIATE vbquery;
	 xp_scrubStatusLog ('MERGE LAB',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_LAB_AYWS_5422_'||EMPID||'','Y','I');
 EXCEPTION WHEN OTHERS THEN
	 xp_scrubStatusLog ('MERGE LAB',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
 END;
 COMMIT;
----------------------------------------------------------------------------
END IF;
--------------------------------------END OF ICE 5548------------------------------
--------------------------------------ICE 216778------------------------------
IF  vLvl.PAYER='QUST' THEN

    SP_PYR_4346_LAB_QUST('HI0826001','HI_LAB_'||vLvl.PAYER||'_GTRI','LABDATA','VH_LABDATA_'||vLvl.PAYER||'_COMM','4');

--NO CHANGES IN CUSTOM SCRIPT SO INSERTING INTO VH_LABDATA FROM COMMMON TABLE
	---------------------------------------------------------------------------------------------
	vbquery:='
	INSERT  INTO  VH_LABDATA
	(
		memid,
		cpt4,
		labcode,
		labvalue,
		servicedate,
		pnindicator,
		labid,
		uselabvalue,
		vhpayorid,
		vhlayoutid,
		labresulttext,
		labrecordnumber,
		refrencerangelow,
		refrencerangehigh,
		abnormalvalue,
		codetype,
		RCVMTH,
		SRCFILENAME,
		AIFILEID,
		AIROWNUMBER,
		labvalueunit
	)
	SELECT DISTINCT
		a.memid,
		a.cpt4,
		a.labcode,
		a.labvalue,
		a.servicedate,
		a.pnindicator,
		a.labid,
		a.uselabvalue,
		a.vhpayorid AS vhpayorid,
		a.vhlayoutid AS vhlayoutid,
		a.labresulttext,
		a.labrecordnumber,
		a.REFRENCERANGELOW as refrencerangelow,
		a.REFRENCERANGEHIGH as refrencerangehigh,
		a.abnormalvalue,
		a.codetype,
		a.RCVMTH, 					--ICE#4326
		a.SRCFILENAME,
		a.AIFILEID,
		a.AIROWNUMBER,
		a.labvalueunit
	FROM
		VH_LABDATA_'||vLvl.PAYER||'_COMM a';

---------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('INSERT INTO LAB-GTRI',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_LAB_QUST_GTRI','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('INSERT INTO LAB-GTRI-EXP',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;
----------------------------------------------------------------------------
END IF;
--------------------------------------ICE 216778 END ------------------------------

  -------------------------------------------------ICE#275376-8283-------------------------------------------------------
  IF  vLvl.PAYER='TRIHEALTH' THEN

  BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM ';
  EXCEPTION WHEN OTHERS THEN NULL;
  END;

	vbQuery:='CREATE TABLE VH_LAB_'||VLVL.SERIALNO||'_CSTM NOLOGGING AS
SELECT
					MEMID,
					I_SRC_ORCL_ROW_ID,
					I_SRC_TBL_NM

				FROM
					VH_LABDATA
				WHERE 1=2';

	EXECUTE IMMEDIATE vbquery;

	EXECUTE IMMEDIATE 'ALTER TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
	EXECUTE IMMEDIATE 'ALTER TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM ADD PRIMARY KEY (SRCROWID)';

    SP_PYR_4800_LAB_TRLT('HI0826001','HI_LAB_TRLT_'||vLvl.EMPGRPID,'LABDATA','VH_LAB_'||vLvl.SERIALNO||'_COMM',4);


	--temp table to update memid from eligibilities
 BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE ZZZ_MEMID_TRLT_'||vLvl.SERIALNO||'_CSTM ';
  EXCEPTION WHEN OTHERS THEN NULL;
  END;


	vbQuery:='CREATE TABLE ZZZ_MEMID_TRLT_'||VLVL.SERIALNO||' NOLOGGING AS
SELECT MEMID,MEMFIRSTNAME,MEMLASTNAME,DOB
			FROM
			(
				SELECT MEMID,MEMFIRSTNAME,MEMLASTNAME,DOB,
				ROW_NUMBER()OVER(PARTITION BY MEMFIRSTNAME,MEMLASTNAME,DOB ORDER BY MEMID)RN
				FROM VH_ELIGIBILITIES_'||VLVL.SERIALNO||'  WHERE MEMID IS NOT NULL
			)X WHERE RN=1';

	EXECUTE IMMEDIATE vbQuery;
	---------------------------------------------------------------------------------------------
	  vbquery:='INSERT /*+ APPEND */ INTO VH_LAB_'||vLvl.SERIALNO||'_CSTM a
		(
			SRCROWID,
			MEMID,
			I_SRC_ORCL_ROW_ID,
			I_SRC_TBL_NM
		)
	SELECT /*+ PARALLEL(a,4) */
		A.ROWID AS SRCROWID,
		COALESCE(MEM.MEMID,a.MEMBER_ID)  AS MEMID,
     a.ROWNUMBER as i_src_orcl_row_id,
     ''HI_LAB_TRLT_'||vLvl.EMPGRPID||''' as i_src_tbl_nm

	FROM
		HI0826001.HI_LAB_TRLT_'||vLvl.EMPGRPID||' A
	LEFT JOIN
    HR_826_LAB_TRLT B
  ON
		Upper(a.MEASUREMENT) = Upper(B.MEASUREMENT)
  LEFT JOIN
		ZZZ_MEMID_TRLT_'||VLVL.SERIALNO||' MEM
	ON
			upper(A.FIRST_NAME) = MEM.MEMFIRSTNAME AND
			upper(A.LAST_NAME) = MEM.MEMLASTNAME AND
			A.DATE_OF_BIRTH = MEM.DOB
  WHERE NOT  (upper(a.MEASUREMENT)=''KROGER COACHING PROGRAM'')
			';

	EXECUTE IMMEDIATE vbquery;
	commit;
		xp_scrubStatusLog ('LAB-TRLT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_LAB_TRLT_'||vLvl.EMPGRPID||'','Y','I');
	COMMIT;

	SP_CDF_TBL_MERGE(USER,'LAB','VH_LAB_'||vLvl.SERIALNO||'_COMM','VH_LAB_'||vLvl.SERIALNO||'_CSTM','VH_LAB_'||vLvl.SERIALNO);



	---------------------------------------------------------------------------------------------
	vbquery:='
	INSERT  INTO  VH_LABDATA
	(
		memid,
		cpt4,
		labcode,
		labvalue,
		servicedate,
		pnindicator,
		labid,
		uselabvalue,
		vhpayorid,
		vhlayoutid,
		labresulttext,
		labrecordnumber,
		refrencerangelow,
		refrencerangehigh,
		abnormalvalue,
		codetype,
		RCVMTH,
		SRCFILENAME,
		AIFILEID,
		AIROWNUMBER,
		labvalueunit,
		I_SRC_ORCL_ROW_ID,  I_SRC_TBL_NM

	)
	SELECT DISTINCT
		a.memid,
		a.cpt4,
		a.labcode,
		a.labvalue,
		a.servicedate,
		a.pnindicator,
		a.labid,
		a.uselabvalue,
		a.vhpayorid AS vhpayorid,
		a.vhlayoutid AS vhlayoutid,
		a.labresulttext,
		a.labrecordnumber,
		a.REFRENCERANGELOW as refrencerangelow,
		a.REFRENCERANGEHIGH as refrencerangehigh,
		a.abnormalvalue,
		a.codetype,
		a.RCVMTH, 				--ICE#4326
		a.SRCFILENAME,
		a.AIFILEID,
		a.AIROWNUMBER,
		a.labvalueunit,
		a.I_SRC_ORCL_ROW_ID,  a.I_SRC_TBL_NM

	FROM
		VH_LAB_'||vLvl.SERIALNO||' a';

---------------------------------------------------------------------------------------------
	 BEGIN EXECUTE IMMEDIATE vbquery;
		 xp_scrubStatusLog ('MERGE LAB-TRLT',EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_LAB_TRLT_'||vLvl.EMPGRPID||'','Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('MERGE LAB-TRLT',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
	 END;
	 COMMIT;

----------------------------------------------------------------------------
END IF;

----------------------------------------------------------------------------
--------------------------------------START OF ICE 9469------------------------------
IF  vLvl.PAYER='OUHL' THEN
--------------------------------------------------------------------------------------------
----------------------TEMP TABLE OF MASTER LAB TABLE(M_LABCATEGORY)-------------
--DBMS_OUTPUT.PUT_LINE( EMPID);

BEGIN
EXECUTE IMMEDIATE 'DROP TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM ';
EXCEPTION WHEN Others THEN NULL;
END;

	vbQuery:='CREATE TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM nologging as
				SELECT
					MEMID,
					I_SRC_TBL_NM,
          REFRENCERANGELOW,
		      REFRENCERANGEHIGH,
		      CODETYPE,
		      LABVALUEUNIT,
          LABCODE
				FROM
					VH_LABDATA
				WHERE 1=2';

	EXECUTE IMMEDIATE vbquery;

	EXECUTE IMMEDIATE 'ALTER TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
	EXECUTE IMMEDIATE 'ALTER TABLE VH_LAB_'||vLvl.SERIALNO||'_CSTM ADD PRIMARY KEY (SRCROWID)';

    SP_PYR_4612_LAB_OUHL('HI0826001','HI_BIOM_OUHL_'||vLvl.EMPGRPID,'LABDATA','VH_LABDATA_'||vLvl.SERIALNO||'_COMM','4');

--temp table to update memid from eligibilities

BEGIN
EXECUTE IMMEDIATE 'DROP TABLE ZZZ_MEMID_OUHL_'||VLVL.SERIALNO||'';
EXCEPTION WHEN Others THEN NULL;
END;

	vbQuery:='CREATE TABLE ZZZ_MEMID_OUHL_'||VLVL.SERIALNO||' nologging as
				SELECT
				memID,memFirstName,memLastName,dob,gender
			FROM
			(
				SELECT memID,memFirstName,memLastName,dob,gender,
				Row_Number()over(PARTITION BY memFirstName,memLastName,dob, gender ORDER BY effdate desc, termdate desc,memID)rn
				FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||' where memid is not null
			)x WHERE rn=1';

EXECUTE IMMEDIATE vbQuery;
	---------------------------------------------------------------------------------------------

 vbquery:='INSERT /*+ APPEND PARALLEL(a,4) */ INTO VH_LAB_'||vLvl.SERIALNO||'_CSTM a
	(
		SRCROWID,
		MEMID,
		I_SRC_TBL_NM,
    REFRENCERANGELOW,
		REFRENCERANGEHIGH,
		CODETYPE,
		LABVALUEUNIT,
    LABCODE
	)
SELECT /*+ PARALLEL(a,4) */
	a.ROWID AS SRCROWID,
	coalesce(mid.MEMID,SubStr(a.OURHEALTH_WELLNESS_ID,1,30) || Decode(Upper(a.GENDER),''M'',''M'',''F'',''F'',''U'') || To_Char(a.BORN_ON,''YYYYMMDD'')||NULLIF(''-''||grp.rollupid,''-''),''MEMID'')  AS MEMID, --ICE#10196
	''HI_BIOM_OUHL_'||vLvl.EMPGRPID||''' as i_src_tbl_nm,
  lab.REFRENCERANGELOW AS REFRENCERANGELOW,
	lab.REFRENCERANGEHIGH AS REFRENCERANGEHIGH,
	NVL(lab.CODE_TYPE, ''UNK'') AS CODETYPE,
	lab.LABVALUEUNIT AS LABVALUEUNIT,
  NVL(lab.LAB_CODE,''UNK'') AS LABCODE
FROM
	HI0826001.HI_BIOM_OUHL_'||vLvl.EMPGRPID||' a
LEFT JOIN
	ZZZ_MEMID_OUHL_'||VLVL.SERIALNO||' mid
ON
		upper(a.first_name) = mid.memFirstName AND
		upper(a.last_name) = mid.memLastName AND
		TO_CHAR(a.BORN_ON,''YYYYMMDD'') = TO_CHAR(mid.dob,''YYYYMMDD'') AND
		upper(a.gender) = mid.gender
LEFT JOIN
   HR_826_GROUP GRP
ON
        a.Company_name =grp.src_code
LEFT JOIN
		HR_826_LAB_OUHL lab
	ON
		UPPER(a.BIOMETRIC) = lab.SOURCE_LAB_DESC
';

EXECUTE IMMEDIATE vbquery;
	commit;
		xp_scrubStatusLog ('LAB-OUHL',vLvl.EMPGRPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_BIOM_OUHL_'||vLvl.EMPGRPID||'','Y','I');
	COMMIT;

SP_CDF_TBL_MERGE(USER,'LAB-OUHL','VH_LABDATA_'||vLvl.SERIALNO||'_COMM','VH_LAB_'||vLvl.SERIALNO||'_CSTM','VH_LAB_'||vLvl.SERIALNO);


---------------------------------------------------------------------------------------------
vbquery:='
INSERT  INTO  VH_LABDATA
(
	memid,
	cpt4,
	labcode,
	labvalue,
	servicedate,
	pnindicator,
	labid,
	uselabvalue,
	vhpayorid,
	vhlayoutid,
	labresulttext,
	labrecordnumber,
	refrencerangelow,
	refrencerangehigh,
	abnormalvalue,
	codetype,
	RCVMTH,
	SRCFILENAME,
	AIFILEID,
	AIROWNUMBER,
	labvalueunit,
	I_SRC_TBL_NM
)
SELECT DISTINCT
	a.memid,
	a.cpt4,
	a.labcode,
	a.labvalue,
	a.servicedate,
	a.pnindicator,
	a.labid,
	a.uselabvalue,
	a.vhpayorid AS vhpayorid,
	a.vhlayoutid AS vhlayoutid,
	a.labresulttext,
	a.labrecordnumber,
	a.REFRENCERANGELOW as refrencerangelow,
	a.REFRENCERANGEHIGH as refrencerangehigh,
	a.abnormalvalue,
	a.codetype,
	a.RCVMTH,
	a.SRCFILENAME,
	a.AIFILEID,
	a.AIROWNUMBER,
	a.labvalueunit,
	a.I_SRC_TBL_NM
FROM
	VH_LAB_'||vLvl.SERIALNO||' a';

---------------------------------------------------------------------------------------------
 BEGIN EXECUTE IMMEDIATE vbquery;
	 xp_scrubStatusLog ('MERGE LAB-OUHL',vLvl.EMPGRPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_BIOM_OUHL_'||vLvl.EMPGRPID||'','Y','I');
 EXCEPTION WHEN OTHERS THEN
	 xp_scrubStatusLog ('MERGE LAB-OUHL',vLvl.EMPGRPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
 END;
 COMMIT;
----------------------------------------------------------------------------
END IF;


END LOOP;

D2SCRUB.signalCompletion(SchemaName || '.SP_LB('''||EMPID||''')');

END SP_LB;
/

------------END LAB DATA-------------------------------------
----------------------START HRA------------------------------------
CREATE OR REPLACE PROCEDURE SP_HR(EMPID IN VARCHAR2) IS
	vbQuery LONG;
	tablename VARCHAR2(50);
	vblStaticDate DATE;
	vbDate LONG;
	SchemaName VARCHAR2(20);


BEGIN
	SELECT sys_context('USERENV', 'CURRENT_USER') INTO SchemaName FROM dual;
	SELECT TO_DATE('12-31-9999','MM-DD-YYYY') INTO vblStaticDate FROM DUAL;



FOR vLvl IN (SELECT DISTINCT SERIALNO,PAYER,EMPGRPID,replace(EMPGRPNAME,'''','''''')EMPGRPNAME  FROM HR_826_PKG_EMPPAYER  WHERE EMPGRPID=''||EmpID||'' AND  SET1='HRA')

	LOOP
	       DBMS_OUTPUT.PUT_LINE(EmpID);

------------------------------- HRA_START-------------------------------------------------------

	IF  vLvl.PAYER='INTERACTIVE HEALTH' THEN

  BEGIN EXECUTE IMMEDIATE 'DROP TABLE VH_HRA_'||vLvl.SERIALNO||'_CSTM '; EXCEPTION WHEN Others THEN NULL; END;

	vbQuery:='CREATE TABLE VH_HRA_'||vLvl.SERIALNO||'_CSTM nologging as
				SELECT
					MEMID ,
          vhgroupname,
          aifileid,
          airownumber
				FROM
					VH_HRA
				WHERE 1=2';

	EXECUTE IMMEDIATE vbquery;

	EXECUTE IMMEDIATE 'ALTER TABLE VH_HRA_'||vLvl.SERIALNO||'_CSTM ADD SRCROWID VARCHAR2(200)';
	EXECUTE IMMEDIATE 'ALTER TABLE VH_HRA_'||vLvl.SERIALNO||'_CSTM ADD PRIMARY KEY (SRCROWID)';

   -- SP_PYR_3970_LAB_WLVB('HI0826001','HI_LAB_'||vLvl.PAYER||'_016','LAB','VH_LAB_'||vLvl.SERIALNO||'_COMM',4);
  SP_PYR_4953_HRA_INHE('HI0826001','HI_HRA_INHE_'||EMPID,'HRA','VH_HRA_'||vLvl.SERIALNO||'_COMM','4');

	--temp table
	BEGIN EXECUTE IMMEDIATE 'DROP TABLE ZZZ_MEMID_'||EMPID; EXCEPTION WHEN Others THEN NULL; END;

	vbQuery:='CREATE TABLE ZZZ_MEMID_'||EMPID|| ' nologging as
				SELECT memID,memFirstName,memLastName,dob, GENDER
			FROM
			(
				SELECT memID,memFirstName,memLastName,dob, GENDER,
				Row_Number()over(PARTITION BY memFirstName,memLastName,dob, GENDER  ORDER BY memID)rn
				FROM VH_ELIGIBILITIES_'||vLvl.SERIALNO||'  WHERE MEMID IS NOT NULL
			)x WHERE rn=1';

	EXECUTE IMMEDIATE vbQuery;
-------------------------------------------------------------------------------

	 vbquery:='INSERT /*+ APPEND PARALLEL(a,4) */ INTO VH_HRA_'||vLvl.SERIALNO||'_CSTM a
		(
			SRCROWID,
			MEMID,
      vhgroupname,
      aifileid,
      airownumber
		)
	SELECT /*+ PARALLEL(a,4) */
		a.ROWID AS SRCROWID,
		nvl(mid.MEMID,Nvl(A.SSN, A.IH_UID)||A.GENDER||To_Char(A.BIRTH_DATE, ''YYYYMMDD''))  AS MEMID,
    CASE
		WHEN '''||EMPID||'''=''TAVG'' THEN ''The ADVICS Group''
		WHEN '''||EMPID||'''=''EMPI'' THEN ''Empire''
		WHEN '''||EMPID||'''=''TIRE'' THEN ''Tire Discounters, Inc.''  --ICE 8908
	END AS vhgroupname , --ICE-6705
    a.fileid as aifileid,
    a.rownumber as airownumber
	FROM
		HI0826001.HI_HRA_INHE_'||EMPID|| ' A
	LEFT JOIN
		ZZZ_MEMID_'||EMPID|| ' mid
	ON
			Upper(A.FIRST_NAME) = mid.memFirstName AND
			Upper(REGEXP_SUBSTR(last_name,''(\S*)'')) = mid.memLastName AND   --ICE 8908
			A.BIRTH_DATE = mid.dob AND
			Upper(A.GENDER) = MID.GENDER
			';


BEGIN
EXECUTE IMMEDIATE vbquery;
		xp_scrubStatusLog ('HRA CSTM'||EMPID,EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_HRA_INHE_'||EMPID,'Y','I');
     EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('HRA CSTM '||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;


BEGIN
SP_CDF_TBL_MERGE(USER,'HRA','VH_HRA_'||vLvl.SERIALNO||'_COMM','VH_HRA_'||vLvl.SERIALNO||'_CSTM','VH_HRA_DATA_'||vLvl.SERIALNO);
	 xp_scrubStatusLog ('MERGE HRA '||EMPID,EMPID,vLvl.PAYER,'','','HI0826001',SQL%ROWCOUNT,'HI_HRA_INHE_'||EMPID,'Y','I');
	 EXCEPTION WHEN OTHERS THEN
		 xp_scrubStatusLog ('MERGE HRA '||EMPID,EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'','','E');
END;

END IF;

--------------------------------------END 0F HRA ---------------------
-------------------------------------------------------------------------------------------------------------------

	tablename:='VH_HRA_DATA_'||vLvl.SERIALNO;
	vbQuery:='INSERT INTO ZZZ_PACKAGE_MERGE VALUES('''||tablename||''','''||EmpID||''',''HRA'','''||vLvl.SERIALNO||''')';


-------------------------------------------------------------------------------------------------
BEGIN EXECUTE IMMEDIATE vbquery;
EXCEPTION WHEN OTHERS THEN
XP_SCRUBSTATUSLOG ('HRA',EMPID,vLvl.PAYER,SQLCODE,substr(SQLERRM, 1,400),'',0,'INSERT INTO ZZZ_PACKAGE_MERGE VALUES HRA','','E');
END;
-------------------------------------------------------------------------------------------------

end loop;

D2SCRUB.signalCompletion(SchemaName || '.SP_HR('''||EMPID||''')');

END SP_HR;
/

-----------------------END HRA-------------------------------------

CREATE OR REPLACE PROCEDURE SP_MH
	(
		EMPID IN VARCHAR2
	) IS
		vQuery LONG;
		vLvl VARCHAR2(200);
		SchemaName VARCHAR2(20);


	BEGIN
	SELECT sys_context('USERENV', 'CURRENT_USER')
		INTO SchemaName
	FROM dual;


	FOR vLvl IN (SELECT DISTINCT TABLE_NAME,SERIALNO FROM ZZZ_PACKAGE_MERGE WHERE EMPLID=''||EmpID||'' AND SET1='HRA')

	LOOP

		vQuery:='
		INSERT INTO VH_HRA_DATA
		(
			MEMID,SMOKINGHISTORY,ALCOHOLDRINKS,BLOODGLUCOSECODE,BLOODGLUCOSEVALUE,BPDIASTOLICCODE,BPDIASTOLICVALUE,BPSYSTOLICCODE,BPSYSTOLICVALUE,CHOLESTEROLHDLCODE,CHOLESTEROLHDLVALUE,CHOLESTEROLLDLCODE,CHOLESTEROLLDLVALUE,CHOLESTEROLTOTALCODE,COLONOSCOPY,COLONSCREENING,DEPRESSIONSCORE,DEPRESSIONSCORECODE,DRINKDRIVE,EXERCISE,FECALTESTING,GENERALHEALTH,HEIGHTFEET,HISTORYASTHMA,HISTORYBRONCHITIS,HISTORYCOPD,HISTORYDIABETES,HISTORYHYPERLIPIDEMIA,HISTORYHYPERTENSION,HISTORYLUNGDISEASE,MAMMOGRAM,NUMDEPRESSIONQUESTIONS,PREGNANT,PAPSMEAR,SAFETYBELT,SIGMOIDOSCOPY,SMOKINGFREQUENCY,STRESSSCORECODE,WANTCHANGEEXERCISE,WANTCHANGESMOKING,WANTCHANGEWEIGHT,WEIGHT,UDF1,UDF2,UDF3,UDF4,UDF5,SURVEYDATE,CYCLEENDDATE,IMPORTEDDATE
			,AIFILEID ,
			AIROWNUMBER ,
			I_SRC_TBL_NM ,
			I_SRC_ORCL_ROW_ID,
      vhgroupname
		)

SELECT 	MEMID,SMOKINGHISTORY,ALCOHOLDRINKS,BLOODGLUCOSECODE,BLOODGLUCOSEVALUE,BPDIASTOLICCODE,BPDIASTOLICVALUE,BPSYSTOLICCODE,BPSYSTOLICVALUE,CHOLESTEROLHDLCODE,CHOLESTEROLHDLVALUE,CHOLESTEROLLDLCODE,CHOLESTEROLLDLVALUE,CHOLESTEROLTOTALCODE,COLONOSCOPY,COLONSCREENING,DEPRESSIONSCORE,DEPRESSIONSCORECODE,DRINKDRIVE,EXERCISE,FECALTESTING,GENERALHEALTH,HEIGHTFEET,HISTORYASTHMA,HISTORYBRONCHITIS,HISTORYCOPD,HISTORYDIABETES,HISTORYHYPERLIPIDEMIA,HISTORYHYPERTENSION,HISTORYLUNGDISEASE,MAMMOGRAM,NUMDEPRESSIONQUESTIONS,PREGNANT,PAPSMEAR,SAFETYBELT,SIGMOIDOSCOPY,SMOKINGFREQUENCY,STRESSSCORECODE,WANTCHANGEEXERCISE,WANTCHANGESMOKING,WANTCHANGEWEIGHT,WEIGHT,UDF1,UDF2,UDF3,UDF4,UDF5,SURVEYDATE,CYCLEENDDATE,IMPORTEDDATE,
AIFILEID ,
AIROWNUMBER ,
I_SRC_TBL_NM ,
I_SRC_ORCL_ROW_ID,
vhgroupname
	FROM
  (
  SELECT	MEMID,SMOKINGHISTORY,ALCOHOLDRINKS,BLOODGLUCOSECODE,BLOODGLUCOSEVALUE,BPDIASTOLICCODE,BPDIASTOLICVALUE,BPSYSTOLICCODE,BPSYSTOLICVALUE,CHOLESTEROLHDLCODE,CHOLESTEROLHDLVALUE,CHOLESTEROLLDLCODE,CHOLESTEROLLDLVALUE,CHOLESTEROLTOTALCODE,COLONOSCOPY,COLONSCREENING,DEPRESSIONSCORE,DEPRESSIONSCORECODE,DRINKDRIVE,EXERCISE,FECALTESTING,GENERALHEALTH,HEIGHTFEET,HISTORYASTHMA,HISTORYBRONCHITIS,HISTORYCOPD,HISTORYDIABETES,HISTORYHYPERLIPIDEMIA,HISTORYHYPERTENSION,HISTORYLUNGDISEASE,MAMMOGRAM,NUMDEPRESSIONQUESTIONS,PREGNANT,PAPSMEAR,SAFETYBELT,SIGMOIDOSCOPY,SMOKINGFREQUENCY,STRESSSCORECODE,WANTCHANGEEXERCISE,WANTCHANGESMOKING,WANTCHANGEWEIGHT,WEIGHT,UDF1,UDF2,UDF3,UDF4,UDF5,SURVEYDATE,CYCLEENDDATE,IMPORTEDDATE,
	AIFILEID ,
	AIROWNUMBER ,
	I_SRC_TBL_NM ,
	I_SRC_ORCL_ROW_ID,
	vhgroupname,
   ROW_NUMBER() OVER(PARTITION BY MemID, SurveyDate ORDER BY SURVEYDATE DESC NULLS LAST) rn
		  FROM	VH_HRA_DATA_'||vLvl.SERIALNO||' a
  )
	WHERE rn = 1';

		-------------------------------------------------------------------------------------------------
		BEGIN EXECUTE IMMEDIATE vQuery;
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('HRA',EMPID,'  ',SQLCODE,substr(SQLERRM, 1,400),'',0,'INSERT INTO VH_HRA_DATA','','E');
		END;

	--------------------------------------------------------------------------------
		BEGIN
			SP_HRA_TRANSPOSE;
			XP_SCRUBSTATUSLOG ('HRA',EMPID,'HRA','','',USER,SQL%ROWCOUNT,'VH_HRA','Y','I');
		END ;

-------------------------------------------------------------------------------------------------

	END LOOP;
--------------------------------------------------------------------------------------------------

--VHSCRUB.signalCompletion('SP_MH('''||EMPID||''')');
D2SCRUB.signalCompletion(SchemaName || '.SP_MH('''||EMPID||''')');


END SP_MH;
/
--------------------------------------------------------------------------------

CREATE OR REPLACE PROCEDURE SP_ME
(
   EMPID IN VARCHAR2
) IS
vQuery LONG;
vLvl VARCHAR2(200);
SchemaName VARCHAR2(20);
--      OrgSchemaName VARCHAR2(20);

BEGIN
SELECT sys_context('USERENV', 'CURRENT_USER')
      INTO SchemaName
  FROM dual;

FOR vLvl IN (SELECT DISTINCT TABLE_NAME,SERIALNO FROM ZZZ_PACKAGE_MERGE WHERE EMPLID=''||EmpID||'' AND SET1='ELIG')

    LOOP
	vQuery:='
	INSERT INTO VH_ELIGIBILITIES
	(
		row_id,
		Source,
		MemID,
		EnrID,
		RelFlag,
		MemFirstName,
		MemLastName,
		Gender,
		DOB,
		Addr1,
		Addr2,
		City,
		State,
		Zip,
		HomePhone,
		WorkPhone,
		EffDate,
		TermDate,
		LVLID1,
		LVLDesc1,
		LVLID2,
		LVLDesc2,
		LVLID3,
		LVLDesc3,
		LVLID4,
		LVLDesc4,
		LVLID5,
		LVLDESC5,
		LVLID6,
		LVLDESC6,
		CMStatus,
		UDF1,
		UDF1_Mem,
		UDF2,
		UDF2_Mem,
		UDFC1,
		UDFC2,
		UDFC3,
		UDFC4,
		UDFD1,
		UDFD2,
		UDFD3,
		UDFD4,
		UDFN1,
		UDFN2,
		RcvMth,
		SrcFileName,
		SICCODE,
		SICDESC,
		PAYERTYPE,
		BENCOVTYPE,
		BENCOVTYPEDESC,
		COVERAGESTATUS ,
		covtypeid,
		covtypedesc,
		PLANTYPE ,
		PLANNAME,
		SrcRelFlag,
		PRODUCTID,
		VHPAYORID
		)
	SELECT
		rowindexElg.nextval as row_id,
		Source,
		MemID,
		EnrID,
		RelFlag,
		MemFirstName,
		MemLastName,
		Gender,
		DOB,
		Addr1,
		Addr2,
		City,
		State,
		Zip,
		HomePhone,
		WorkPhone,
		EffDate,
		TermDate,
		LVLID1,
		LVLDesc1,
		LVLID2,
		LVLDesc2,
		LVLID3,
		LVLDesc3,
		LVLID4,
		LVLDesc4,
		LVLID5,
		LVLDESC5,
		LVLID6,
		LVLDESC6,
		CMStatus,
		UDF1,
		SSNMASK(substr(udfc21,1,50)) as UDF1_MEM, --ICE-17438	
		UDF2,
		UDF2_Mem,
		UDFC1,
		UDFC2,
		UDFC3,
		UDFC4,
		UDFD1,
		UDFD2,
		UDFD3,
		UDFD4,
		UDFN1,
		UDFN2,
		RcvMth,
		SrcFileName,
		--FOR LONG NORM
		SICCODE,
		SICDESC,
		-- FOR HEDIS
		PAYERTYPE,
		BENCOVTYPE,
		BENCOVTYPEDESC,
		COVERAGESTATUS ,
		covtypeid,
		covtypedesc,
		PLANTYPE ,
		PLANNAME,
		Decode(a.relflag, ''E'', ''Employee'', ''S'', ''Spouse'', ''D'', ''Dependent'', ''Unknown'') AS SrcRelFlag,   ---ICE 231730 Use RelFlag for Horan as Relationship Code
		PRODUCTID,
		VHPAYORID
	FROM
		VH_ELIGIBILITIES_'||vLvl.SERIALNO||' a
		
  WHERE
  COVTYPEID <> ''RX'' --296174
  AND source||lvlid3 NOT IN (''OUR HEALTH730337'',''OUR HEALTHHAMI'',''OUR HEALTHTAVG'',''OUR HEALTHWEHI'')     --ICE-11948
		';

	--printquery(vQuery) ;

-------------------------------------------------------------------------------------------------
	BEGIN EXECUTE IMMEDIATE vQuery;
	EXCEPTION WHEN OTHERS THEN
	xp_scrubStatusLog ('ELIG',EMPID,'  ',SQLCODE,substr(SQLERRM, 1,400),'',0,'INSERT INTO VH_ELIGIBILITIES','','E');
	END;
-------------------------------------------------------------------------------------------------

END LOOP;

DBMS_STATS.GATHER_TABLE_STATS(OWNNAME => USER, TABNAME => 'VH_ELIGIBILITIES', ESTIMATE_PERCENT=> DBMS_STATS.AUTO_SAMPLE_SIZE,DEGREE=>4);

vQuery:='	MERGE /*+PARALLEL(A,4)*/ INTO VH_ELIGIBILITIES A
			USING (
			SELECT MEMID, ENRID,  MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ,LVLID3
 			FROM (SELECT /*+PARALLEL(VH_ELIGIBILITIES,4)*/ MEMID, ENRID,  MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ,LVLID3,
      ROW_NUMBER() OVER (PARTITION BY MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB order by MEMID) rn FROM VH_ELIGIBILITIES where lvlid3 = ''CSTA'' and SOURCE =''CDBT'')
      WHERE RN = 1) B
			 ON
			 (
			  A.MEMFIRSTNAME = B.MEMFIRSTNAME AND
			  A.MEMLASTNAME = B.MEMLASTNAME AND
			  A.GENDER = B.GENDER AND
			  A.DOB = B.DOB AND
        A.LVLID3 = B.LVLID3
			 )
			 WHEN MATCHED THEN UPDATE SET
			 A.MEMID = B.MEMID ,
			 A.ENRID = B.ENRID
			WHERE A.lVLID3 = ''CSTA'' AND A.SOURCE = ''UMR''';

BEGIN EXECUTE IMMEDIATE vQuery;
DBMS_STATS.GATHER_TABLE_STATS(OWNNAME => USER, TABNAME => 'VH_ELIGIBILITIES', ESTIMATE_PERCENT => DBMS_STATS.AUTO_SAMPLE_SIZE); --ICE 2933

	EXCEPTION WHEN OTHERS THEN NULL;
	END;
	COMMIT;


IF EmpID = 'HAMI' THEN
   BEGIN
   EXECUTE IMMEDIATE '
    INSERT INTO zzz_memid_update_anthem1
    SELECT MEMID,ENRID,MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVLID3
    FROM(
    SELECT /*+parallel(a,4)*/
	  MEMID,
		ENRID,
    MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		LVLID3,
    Row_Number() OVER (PARTITION BY MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB
    ORDER BY MEMID) rn
	FROM
		vh_eligibilities a
	WHERE LVLID3 = ''HAMI''
  )
    WHERE rn=1
    ';
	 EXCEPTION WHEN OTHERS THEN NULL;
	 END;
ELSIF EmpID = 'ATRM' THEN	--271895
	BEGIN
	   EXECUTE IMMEDIATE '
		INSERT INTO zzz_memid_update_anthem1
		SELECT MEMID,ENRID,MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVLID3
		FROM(
		SELECT /*+parallel(a,4)*/
			MEMID,
			ENRID,
			MEMFIRSTNAME,
			MEMLASTNAME,
			GENDER,
			DOB,
			LVLID3,
		Row_Number() OVER (PARTITION BY MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB
		ORDER BY MEMID) rn
		FROM
			vh_eligibilities a
		WHERE LVLID3 = ''ATRM''
		AND SOURCE = ''MMOH''
	  )
		WHERE rn=1
		';
		 EXCEPTION WHEN OTHERS THEN NULL;
	 END;
ELSIF EmpID = 'CSTA' THEN	--295787
	BEGIN
	   EXECUTE IMMEDIATE '
		INSERT INTO ZZZ_MEMID_UPDATE_CSTA
		SELECT MEMID,ENRID,MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB,LVLID3
		FROM(
		SELECT /*+parallel(a,4)*/
			MEMID,
			ENRID,
			MEMFIRSTNAME,
			MEMLASTNAME,
			GENDER,
			DOB,
			LVLID3,
		Row_Number() OVER (PARTITION BY MEMFIRSTNAME,MEMLASTNAME,GENDER,DOB
		ORDER BY MEMID) rn
		FROM
			vh_eligibilities a
		WHERE LVLID3 = ''CSTA''
	  )
		WHERE rn=1
		';
		 EXCEPTION WHEN OTHERS THEN NULL;
	 END;
END IF;




D2SCRUB.signalCompletion(SchemaName || '.SP_ME('''||EMPID||''')');


END SP_ME;
/



CREATE OR REPLACE  PROCEDURE SP_MC
(
   EMPID IN VARCHAR2
) IS
	vQuery LONG;
	vLvl VARCHAR2(200);
	SchemaName VARCHAR2(20);
	vblICD10Date VARCHAR2(50);
	vblParamVal VARCHAR2(50);

	BEGIN

	BEGIN
		SELECT PARAMVAL INTO vblParamVal  FROM HAWKEYEMASTER.M_CLIENTPARAMS WHERE clientid IN (SELECT clientID FROM VH_CLIENTS) AND PARAMID ='072' ;
		EXCEPTION WHEN NO_DATA_FOUND THEN
		SELECT 'NO_DATA_FOUND' INTO vblParamVal FROM DUAL;
	END;


	BEGIN
		SELECT TO_CHAR(ICD10ROLLOUT_DT,'MM-DD-YYYY') INTO vblICD10Date  FROM HR_GLOBAL_ICD10ROLLOUTDATE WHERE APPID IN (SELECT APPID FROM VH_CLIENTS);
		EXCEPTION WHEN NO_DATA_FOUND THEN
		SELECT '12-31-9999' INTO vblICD10Date FROM DUAL;
	END;

SELECT sys_context('USERENV', 'CURRENT_USER')
      INTO SchemaName
FROM dual;


FOR vLvl IN (SELECT DISTINCT TABLE_NAME,SERIALNO FROM ZZZ_PACKAGE_MERGE WHERE EMPLID=''||EmpID||'' AND SET1='CLAIMS')

LOOP
	vQuery:='

	INSERT INTO VH_CLAIMS
	(
		SN,
		Source,
		ClmNum,
		ClmType,
		ClmTypeDesc,
		ClmCategory,
		MemID,
		EnrID,
		RelFlag,
		MemFirstName,
		MemLastName,
		Gender,
		DOB,
		Addr1,
		Addr2,
		City,
		State,
		Zip,
		HomePhone,
		WorkPhone,
		LVLID1,
		LVLDesc1,
		LVLID2,
		LVLDesc2,
		LVLID3,
		LVLDesc3,
		LVLID4,
		LVLDesc4,
		LVLID5,
		LVLDESC5,
		LVLID6,
		LVLDESC6,
		claimstatus,
		FromDate,
		TODATE,
		ServiceDate,
		RcvDate,
		PAIDDATE,
		BILLTYPE,
		POSCODE,
		POSDESC,
		SPECCODE,
		SPECDESC,
		DIAGCODE,
		DIAGDESC,
		FirstDiagCode,
		SecondDiagCode,
		ThirdDiagCode,
		FourthDiagCode,
		FifthDiagCode,
		PROCTYPE,
		PROCCODE,
		PROCDESC,
		REVCODE,
		DRGCODE,
		ModifierCode,
		ModifierDesc,
		ProvID,
		ProvName,
		InNwk,
		NwkID,
		NwkName,
		SERVICEUNITS,
		PaidAmt,
		BilledAmt,
		AllowedAmt,
		PPOSavingAmt,
		EnrPaidAmt,
		CoInsAmt,
		CopayAmt,
		DeductAmt,
		NotAllowedAmt,
		COBAmt,
		PlanExclAmt,
		ADJCODE,
		IPDays,
		ServiceCode,
		SpecRollupCode,
		SpecRollupDesc,
		SSN,
		UDFM1,
		UDFM2,
		UDF1,
		UDF2,
		UDF3,
		UDF4,
		UDF5,
		UDF6,
		UDF7,
		UDF8,
		UDF9,
		UDFC1,
		UDFC2,
		UDFC3,
		UDFC4,
		UDFC5,
		UDFC6,
		UDFC7,
		UDFC8,
		UDFC9,
		UDFC10,
		UDFC11,
		UDFC12,
		UDFC13,
		UDFC14,
		UDFC15,
		UDFC16,
		UDFC17,
		UDFC18,
		UDFC19,
		UDFC20,
		UDFD1,
		UDFD2,
		UDFD3,
		UDFD4,
		UDFD5,
		UDFN1,
		UDFN2,
		UDFN3,
		UDFN4,
		UDFN5,
		UDFN6,
		UDFN7,
		UDFN8,
		UDFN9,
		UDFN10,
		UDFN11,
		UDFN12,
		UDFN13,
		UDFN14,
		UDFN15,
		UDFN16,
		UDFN17,
		UDFN18,
		UDFN19,
		UDFN20,
		RcvMth,
		SrcFileName,
		-- LabTestData,
		SERVTYPECODE,
		SERVTYPEDESC,
		PROVTYPECODE,
		PROVTYPEDESC,
		ICD9PROCCODE1,
		ICD9PROCCODE2,
		ICD9PROCCODE3,
		ICD9PROCCODE4,
		ICD9PROCCODE5,
		REVCODE1,
		REVCODE2,
		REVCODE3,
		REVCODE4,
		REVCODE5,
		CPT4_1,
		CPT4_2,
		CPT4_3,
		HCPCS,
		PROVIDERFIRSTNAME,
		PROVIDERLASTNAME,
		SICCODE,
		SICDESC,
		--For HEDIS
		MODIFIERCODE2,
		CPTII     ,
		SIXTHDIAGCODE ,
		SEVENTHDIAGCODE   ,
		EIGHTHDIAGCODE    ,
		NINTHDIAGCODE ,
		TENTHDIAGCODE ,
		ICD9PROCCODE6 ,
		DRGIDENTIFIER ,
		DISCHSTATUS   ,
		TYPEOFBILL,
		ICDTYPE,
		CLMHEADERNUMBER,
		claimlinenumber,
		SRCRELFLAG,
		PlanType,
		PlanName,
		ENROLLMENT_SOURCE,
		COVTYPEDESC,
		PRODUCTID,
		VHPAYORID,
    I_SRC_TBL_NM --ICE371458
		)
	SELECT
		rowindexClm.nextval as SN,
		a.Source,
		a.ClmNum,
		a.ClmType,
		a.ClmTypeDesc,
		a.ClmCategory,
		a.MemID,
		a.EnrID,
		a.RelFlag,
		a.MemFirstName,
		a.MemLastName,
		a.Gender,
		a.DOB,
		a.Addr1,
		a.Addr2,
		a.City,
		a.State,
		a.Zip,
		a.HomePhone,
		a.WorkPhone,
		a.LVLID1,
		a.LVLDesc1,
		a.LVLID2,
		a.LVLDesc2,
		a.LVLID3,
		a.LVLDesc3,
		a.LVLID4,
		a.LVLDesc4,
		a.LVLID5,
		a.LVLDESC5,
		a.LVLID6,
		a.LVLDESC6,
		a.claimstatus,
		a.FromDate,
		a.TODATE,
		a.ServiceDate,
		a.RcvDate,
		a.PAIDDATE,
		a.BILLTYPE,
		a.POSCODE,
		a.POSDESC,
		a.SPECCODE,
		a.SPECDESC,
		a.DIAGCODE,
		a.DIAGDESC,
		a.FirstDiagCode,
		a.SecondDiagCode,
		a.ThirdDiagCode,
		a.FourthDiagCode,
		a.FifthDiagCode,
		CASE
			WHEN NVL(proc.cnt,1) = 1 THEN NVL(proc.PROCTYPEDESC,''ICD9Proc'')
			WHEN '''||vblParamVal||''' <>''NO_DATA_FOUND'' THEN '''||vblParamVal||'Proc''
			WHEN nvl(a.SERVICEDATE,TO_DATE(''12-31-9999'',''MM-DD-YYYY'')) >= TO_DATE('''||vblICD10Date||''',''MM/DD/YYYY'') THEN ''ICD10Proc''
			ELSE ''ICD9Proc''
		END as PROCTYPE,
		a.PROCCODE,
		a.PROCDESC,
		a.REVCODE,
		a.DRGCODE,
		a.ModifierCode,
		a.ModifierDesc,
		a.ProvID,
		a.ProvName,
		a.InNwk,
		a.NwkID,
		a.NwkName,
		a.SERVICEUNITS,
		a.PaidAmt,
		a.BilledAmt,
		a.AllowedAmt,
		a.PPOSavingAmt,
		a.EnrPaidAmt,
		a.CoInsAmt,
		a.CopayAmt,
		a.DeductAmt,
		a.NotAllowedAmt,
		a.COBAmt,
		a.PlanExclAmt,
		a.ADJCODE,
		a.IPDays,
		a.ServiceCode,
		a.SpecRollupCode,
		a.SpecRollupDesc,
		a.SSN,
		a.UDFM1,
		a.UDFM2,
		a.UDF1,
		a.UDF2,
		a.UDF3,
		a.UDF4,
		a.UDF5,
		a.UDF6,
		a.UDF7,
		a.UDF8,
		a.UDF9,
		a.UDFC1,
		a.UDFC2,
		a.UDFC3,
		a.UDFC4,
		a.UDFC5,
		a.UDFC6,
		a.UDFC7,
		a.UDFC8,
		a.UDFC9,
		a.UDFC10,
		a.UDFC11,
		a.UDFC12,
		a.UDFC13,
		a.UDFC14,
		a.UDFC15,
		a.UDFC16,
		a.UDFC17,
		a.UDFC18,
		a.UDFC19,
		a.UDFC20,
		a.UDFD1,
		a.UDFD2,
		a.UDFD3,
		a.UDFD4,
		a.UDFD5,
		a.UDFN1,
		a.UDFN2,
		a.UDFN3,
		a.UDFN4,
		a.UDFN5,
		a.UDFN6,
		a.UDFN7,
		a.UDFN8,
		a.UDFN9,
		a.UDFN10,
		a.UDFN11,
		a.UDFN12,
		a.UDFN13,
		a.UDFN14,
		a.UDFN15,
		a.UDFN16,
		a.UDFN17,
		a.UDFN18,
		a.UDFN19,
		a.UDFN20,
		a.RcvMth,
		a.SrcFileName,
		-- LabTestData,
		a.SERVTYPECODE,
		a.SERVTYPEDESC,
		a.PROVTYPECODE,
		a.PROVTYPEDESC,
		a.ICD9PROCCODE1,
		a.ICD9PROCCODE2,
		a.ICD9PROCCODE3,
		a.ICD9PROCCODE4,
		a.ICD9PROCCODE5,
		a.REVCODE1,
		a.REVCODE2,
		a.REVCODE3,
		a.REVCODE4,
		a.REVCODE5,
		a.CPT4_1,
		a.CPT4_2,
		a.CPT4_3,
		a.HCPCS,
		a.PROVIDERFIRSTNAME,
		a.PROVIDERLASTNAME,
		a.SICCODE,
		a.SICDESC,
		--For HEDIS
		a.MODIFIERCODE2,
		a.CPTII     ,
		a.SIXTHDIAGCODE ,
		a.SEVENTHDIAGCODE   ,
		a.EIGHTHDIAGCODE    ,
		a.NINTHDIAGCODE ,
		a.TENTHDIAGCODE ,
		a.ICD9PROCCODE6 ,
		a.DRGIDENTIFIER ,
		a.DISCHSTATUS   ,
		a.TYPEOFBILL,
		CASE WHEN HR.ICD10_FLAG=''Y'' THEN a.ICDTYPE ELSE NVL(ICDTY.DIAGTYPEDESC,CASE WHEN SERVICEDATE<TO_DATE(''20151001'',''YYYYMMDD'') THEN ''ICD9'' ELSE ''ICD10'' END) END ,
		a.CLMHEADERNUMBER,
		a.claimlinenumber,
		Decode(a.relflag, ''E'', ''Employee'', ''S'', ''Spouse'', ''D'', ''Dependent'', ''Unknown'') AS SrcRelFlag,   ---ICE 231730 Use RelFlag for Horan as Relationship Code
		a.PlanType,
		a.PlanName,
		a.ENROLLMENT_SOURCE,
		NVL(a.COVTYPEDESC,a.clmTypeDesc),
		a.PRODUCTID,
		a.VHPAYORID,
    a.I_SRC_TBL_NM --ICE371458
	FROM
		(select * from VH_CLAIMS_'||vLvl.SERIALNO||' A where UPPER(ClmType)  in (''MED'')) a
	LEFT JOIN
		ZZZ_PROCS proc
	ON
		a.PROCCODE = proc.PROCCODE
	LEFT JOIN
		HR_GLOBAL_ICDTYPE HR
	ON A.SOURCE=HR.SOURCE
	and HR.AppID = ''826-001''
	LEFT JOIN
		ZZZ_UNIQUE_DIAG_LIST ICDTY
	ON replace(A.DIAGCODE,''.'')=ICDTY.DIAGCODE
	';

	-- ----printquery(vQuery) ;


-------------------------------------------------------------------------------------------------
	BEGIN EXECUTE IMMEDIATE vQuery;
	EXCEPTION WHEN OTHERS THEN
	xp_scrubStatusLog ('CLAIMS',EMPID,'  ',SQLCODE,substr(SQLERRM, 1,400),'',0,'INSERT INTO VH_CLAIMS'||vLvl.SERIALNO,'','E');
	END;
-------------------------------------------------------------------------------------------------

END LOOP;
DBMS_STATS.GATHER_TABLE_STATS(OWNNAME => USER, TABNAME => 'VH_CLAIMS', ESTIMATE_PERCENT=> DBMS_STATS.AUTO_SAMPLE_SIZE,DEGREE=>4);


vQuery:='	MERGE /*+PARALLEL(A,4)*/ INTO VH_CLAIMS A
			USING (
			SELECT MEMID, ENRID,  MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ,LVLID3
			FROM ZZZ_MEMID_UPDATE_CSTA) B
			 ON
			 (
			  A.MEMFIRSTNAME = B.MEMFIRSTNAME AND
			  A.MEMLASTNAME = B.MEMLASTNAME AND
			  A.GENDER = B.GENDER AND
			  A.DOB = B.DOB AND
        A.LVLID3 = B.lVLID3
			 )
			 WHEN MATCHED THEN UPDATE SET
			 A.MEMID = B.MEMID ,
			 A.ENRID = B.ENRID
			WHERE A.lVLID3 = ''CSTA''';

BEGIN EXECUTE IMMEDIATE vQuery;
DBMS_STATS.GATHER_TABLE_STATS(OWNNAME => USER, TABNAME => 'VH_CLAIMS', ESTIMATE_PERCENT => DBMS_STATS.AUTO_SAMPLE_SIZE); --ICE 2933

	EXCEPTION WHEN OTHERS THEN
	NULL;
	END;
	COMMIT;

--    --DEFECT 321879
--  vQuery:='	merge /*+NO_MERGE(b)*/ INTO vh_claims a
--            USING
--            (
--            Select provid,provname FROM
--            (
--            SELECT provid,provname,Sum(paidamt) paidamt,Row_Number() OVER (PARTITION BY provname ORDER BY Sum(paidamt) desc) rn  FROM vh_claims GROUP BY provid,provname
--            ) WHERE rn = 1
--            )b
--            ON
--            (
--            a.provname = b.provname
--            )
--            WHEN matched THEN UPDATE SET
--            a.provid = b.provid';

--BEGIN EXECUTE IMMEDIATE vQuery;

--	EXCEPTION WHEN OTHERS THEN
--	NULL;
--	END;
--	COMMIT;


	D2SCRUB.signalCompletion(SchemaName || '.SP_MC('''||EMPID||''')');

END SP_MC;
/
----------------------------------------------------------------------------------------------------

CREATE OR REPLACE PROCEDURE SP_MR
(
   EMPID IN VARCHAR2
) IS
vQuery LONG;
vLvl VARCHAR2(200);
SchemaName VARCHAR2(20);

BEGIN

SELECT sys_context('USERENV', 'CURRENT_USER')
	INTO SchemaName
FROM dual;



FOR vLvl IN (SELECT DISTINCT TABLE_NAME,SERIALNO FROM ZZZ_PACKAGE_MERGE WHERE EMPLID=''||EmpID||'' AND SET1='RX')

LOOP
	vQuery:='

	INSERT INTO VH_RXCLAIMS
	(
		sn,
		SOURCE,
		TRANSNUM,
		SEQNO,
		MEMID,
		ENRID,
		RELFLAG,
		MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		ADDR1,
		ADDR2,
		CITY,
		STATE,
		ZIP,
		HOMEPHONE,
		WORKPHONE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		LVLID5,
		LVLDESC5,
		LVLID6,
		LVLDESC6,
		FILLDATE,
		PAIDDATE,
		METRICQUANTITY,
		DAYSSUPPLY,
		DRUGCODE,
		DRUGDESC,
		DRUGSTRENGTH,
		FORMULARY_YN,
		MOI,
		PRESCRIBERID,
		PRESCRIBERNAME,
		PHARMID,
		PHARMNAME,
		PHARMZIPCODE,
		PAIDAMT,
		BILLEDAMT,
		INGREDCOST,
		DISPENSINGCOST,
		SALESTAX,
		ALLOWEDAMT,
		ENRPAIDAMT,
		COINSAMT,
		COPAYAMT,
		DEDUCTAMT,
		NOTALLOWEDAMT,
		ADMFEES,
		AWP,
		COBAMT,
		ADJCODE,
		SICCODE,
		SICDESC,
		CLAIMSTATUS,
		SUPPLYFLAG,
		DISCOUNTAMT,
		PRESCOUNT,
		SSN,
		RCVMTH,
		SRCFILENAME,
		UDF1,
		UDFM1,
		UDF2,
		UDFM2,
		UDF3,
		UDF4,
		UDF5,
		UDF6,
		UDF7,
		UDF8,
		UDF9,
		UDFC1,
		UDFC2,
		UDFC3,
		UDFC4,
		UDFC5,
		UDFC6,
		UDFC7,
		UDFC8,
		UDFC9,
		UDFC10,
		UDFC11,
		UDFC12,
		UDFC13,
		UDFC14,
		UDFC15,
		UDFC16,
		UDFC17,
		UDFC18,
		UDFC19,
		UDFC20,
		UDFD1,
		UDFD2,
		UDFD3,
		UDFD4,
		UDFD5,
		UDFN1,
		UDFN2,
		UDFN3,
		UDFN4,
		UDFN5,
		UDFN6,
		UDFN7,
		UDFN8,
		UDFN9,
		UDFN10,
		UDFN11,
		UDFN12,
		UDFN13,
		UDFN14,
		UDFN15,
		UDFN16,
		UDFN17,
		UDFN18,
		UDFN19,
		UDFN20,
		VH_LVL_ID,
		EMP_NBR,
		MEDELIGCATID,
		PRODUCTID,
		SRCRELFLAG,
		PlanType,
		PlanName,
		ENROLLMENT_SOURCE,
		VHPAYORID,
		SPECIALTYIND--ICE-3815
		)
	SELECT
		rowindexRx.nextval as SN,
		SOURCE,
		TRANSNUM,
		SEQNO,
		MEMID,
		ENRID,
		RELFLAG,
		MEMFIRSTNAME,
		MEMLASTNAME,
		GENDER,
		DOB,
		ADDR1,
		ADDR2,
		CITY,
		STATE,
		ZIP,
		HOMEPHONE,
		WORKPHONE,
		LVLID1,
		LVLDESC1,
		LVLID2,
		LVLDESC2,
		LVLID3,
		LVLDESC3,
		LVLID4,
		LVLDESC4,
		LVLID5,
		LVLDESC5,
		LVLID6,
		LVLDESC6,
		FILLDATE,
		PAIDDATE,
		METRICQUANTITY,
		DAYSSUPPLY,
		DRUGCODE,
		DRUGDESC,
		DRUGSTRENGTH,
		FORMULARY_YN,
		MOI,
		PRESCRIBERID,
		PRESCRIBERNAME,
		PHARMID,
		PHARMNAME,
		PHARMZIPCODE,
		PAIDAMT,
		BILLEDAMT,
		INGREDCOST,
		DISPENSINGCOST,
		SALESTAX,
		ALLOWEDAMT,
		ENRPAIDAMT,
		COINSAMT,
		COPAYAMT,
		DEDUCTAMT,
		NOTALLOWEDAMT,
		ADMFEES,
		AWP,
		COBAMT,
		ADJCODE,
		SICCODE,
		SICDESC,
		CLAIMSTATUS,
		SUPPLYFLAG,
		DISCOUNTAMT,
		PRESCOUNT,
		SSN,
		RCVMTH,
		SRCFILENAME,
		UDF1,
		UDFM1,
		UDF2,
		UDFM2,
		UDF3,
		UDF4,
		UDF5,
		UDF6,
		UDF7,
		UDF8,
		UDF9,
		UDFC1,
		UDFC2,
		UDFC3,
		UDFC4,
		UDFC5,
		UDFC6,
		UDFC7,
		UDFC8,
		UDFC9,
		UDFC10,
		UDFC11,
		UDFC12,
		UDFC13,
		UDFC14,
		UDFC15,
		UDFC16,
		UDFC17,
		UDFC18,
		UDFC19,
		UDFC20,
		UDFD1,
		UDFD2,
		UDFD3,
		UDFD4,
		UDFD5,
		UDFN1,
		UDFN2,
		UDFN3,
		UDFN4,
		UDFN5,
		UDFN6,
		UDFN7,
		UDFN8,
		UDFN9,
		UDFN10,
		UDFN11,
		UDFN12,
		UDFN13,
		UDFN14,
		UDFN15,
		UDFN16,
		UDFN17,
		UDFN18,
		UDFN19,
		UDFN20,
		VH_LVL_ID,
		EMP_NBR,
		MEDELIGCATID,
		PRODUCTID,
		Decode(a.relflag, ''E'', ''Employee'', ''S'', ''Spouse'', ''D'', ''Dependent'', ''Unknown'') AS SrcRelFlag,   ---ICE 231730 Use RelFlag for Horan as Relationship Code
		PlanType,
		PlanName,
		ENROLLMENT_SOURCE,
		VHPAYORID,
		SPECIALTYIND--ICE-3815
	FROM
		VH_RXCLAIMS_'||vLvl.SERIALNO||' A';

	------printquery(vQuery) ;


-------------------------------------------------------------------------------------------------
	BEGIN EXECUTE IMMEDIATE vQuery;
  COMMIT;
	EXCEPTION WHEN OTHERS THEN
	xp_scrubStatusLog ('RX',EMPID,'',SQLCODE,substr(SQLERRM, 1,400),'',0,'INSERT INTO VH_RXCLAIMS','','E');
	END;
-------------------------------------------------------------------------------------------------
END LOOP;
DBMS_STATS.GATHER_TABLE_STATS(OWNNAME => USER, TABNAME => 'VH_RXCLAIMS', ESTIMATE_PERCENT=> DBMS_STATS.AUTO_SAMPLE_SIZE,DEGREE=>4);

vQuery:='	MERGE /*+PARALLEL(A,4)*/ INTO VH_RXCLAIMS A
			USING (
			SELECT MEMID, ENRID,  MEMFIRSTNAME, MEMLASTNAME, GENDER, DOB ,LVLID3
			FROM ZZZ_MEMID_UPDATE_CSTA )B
			 ON
			 (
			  A.MEMFIRSTNAME = B.MEMFIRSTNAME AND
			  A.MEMLASTNAME = B.MEMLASTNAME AND
			  A.GENDER = B.GENDER AND
			  A.DOB = B.DOB AND
        A.LVLID3 = B.lVLID3
			 )
			 WHEN MATCHED THEN UPDATE SET
			 A.MEMID = B.MEMID ,
			 A.ENRID = B.ENRID
			WHERE A.lVLID3 = ''CSTA''';

BEGIN EXECUTE IMMEDIATE vQuery;
DBMS_STATS.GATHER_TABLE_STATS(OWNNAME => USER, TABNAME => 'VH_RXCLAIMS', ESTIMATE_PERCENT => DBMS_STATS.AUTO_SAMPLE_SIZE); --ICE 2933

	EXCEPTION WHEN OTHERS THEN
	NULL;
	END;
	COMMIT;


	D2SCRUB.signalCompletion(SchemaName || '.SP_MR('''||EMPID||''')');

END SP_MR;
/

CREATE OR REPLACE  PROCEDURE SP_FM
 IS vbQuery LONG;
SchemaName VARCHAR2(20);
--OrgSchemaName VARCHAR2(20);

	vblICD10Date VARCHAR2(50);
	vblParamVal VARCHAR2(50);
	VBLCYCLESTARTDATE VARCHAR2(20);
	VBLCYCLEENDDATE VARCHAR2(20);
BEGIN

SELECT sys_context('USERENV', 'CURRENT_USER')
	INTO SchemaName
FROM dual;

		SELECT  TO_CHAR(CYCLESTARTDATE,'DD-MON-YYYY') INTO VBLCYCLESTARTDATE FROM VH_RUNDATE;
        SELECT TO_CHAR(CYCLEENDDATE,'DD-MON-YYYY') INTO VBLCYCLEENDDATE FROM VH_RUNDATE;

---------------remove termed groups from all set-------ICE 314145------------------------
begin
	pkg_vhscrubcommon.spRemoveTermedGroups;
end;
-----------------------------------------------------------------------------------------
---------ICE-18063-----------------
BEGIN
EXECUTE IMMEDIATE 'DROP TABLE VH_ELIG_MULTI_UDF1_MEM PURGE';
EXCEPTION
WHEN OTHERS THEN NULL;
END;
------------------------------------------------------------------------

BEGIN
EXECUTE IMMEDIATE '
CREATE TABLE VH_ELIG_MULTI_UDF1_MEM AS 
SELECT DISTINCT 
MEMID, LVLID3, UDF1_MEM,  TERMDATE  , EFFDATE FROM 
VH_ELIGIBILITIES WHERE MEMID||LVLID3 IN
(
SELECT  MEMID||LVLID3 FROM VH_ELIGIBILITIES
GROUP BY MEMID||LVLID3 
HAVING COUNT(DISTINCT UDF1_MEM)>1 
)
';
EXCEPTION
WHEN OTHERS THEN NULL;
END;

BEGIN
EXECUTE IMMEDIATE 'DROP TABLE zzz_vh_elig_udf1mem PURGE';
EXCEPTION
WHEN OTHERS THEN NULL;
END;

-------------------------------------------------------------------------------------------

BEGIN
EXECUTE IMMEDIATE '
CREATE TABLE zzz_vh_elig_udf1mem NOLOGGING PARALLEL 4 AS 
SELECT memid, lvlid3, udf1_mem FROM 
( SELECT /*+ parallel (a,4) */  memid, lvlid3, udf1_mem,  Row_Number() OVER ( PARTITION BY memid, lvlid3 ORDER BY termdate DESC , effdate DESC ) rn 
  FROM VH_ELIG_MULTI_UDF1_MEM a )
WHERE rn = 1';
EXCEPTION
WHEN OTHERS THEN NULL;
END;


vbQuery:='	Merge /*+ parallel (a,4) */  INTO vh_eligibilities a
			USING
			zzz_vh_elig_udf1mem  b
			ON
			(a.memid = b.memid
			AND 
			a.lvlid3 = b.lvlid3 
			)
			WHEN matched THEN UPDATE SET 
			a.udf1_mem = b.udf1_mem '; 
			
BEGIN EXECUTE IMMEDIATE vbQuery;
		xp_scrubStatusLog ('ELIG UDFC1 UPDATE','HORAN','  ',SQLCODE,substr(SQLERRM, 1,400),'',0,'vh_eligibilities','','E');
	EXCEPTION WHEN OTHERS THEN
		xp_scrubStatusLog ('ELIG UDFC1 UPDATE ERROR','HORAN','  ',SQLCODE,substr(SQLERRM, 1,400),'',0,'vh_eligibilities','','E');
	END;
	
	COMMIT;
---------END ICE-18063-----------------
-------------------------------------------------------------------------------------------------
		BEGIN
			PKG_PMPR.CREATE_MEMBERS_PER_MONTH ('VH_ELIGIBILITIES','VH_ELIGIBILITIES_PMPR',VBLCYCLESTARTDATE,VBLCYCLEENDDATE, 'Y');
		END;
--------------------------------------START-ICE#317412-------------------------------------------  DEFECT329799
DBMS_STATS.GATHER_TABLE_STATS(OWNNAME => USER, TABNAME => 'VH_ELIGIBILITIES_PMPR', ESTIMATE_PERCENT=> DBMS_STATS.AUTO_SAMPLE_SIZE,DEGREE=>4);

vbQuery:='
MERGE INTO VH_ELIGIBILITIES_PMPR A
USING (SELECT LVLID4, LVLDESC4,UDFC1,BEGIN_DTE, LVLID3
		FROM (
					SELECT LVLID4, LVLDESC4,UDFC1,BEGIN_DTE, LVLID3,
					ROW_NUMBER()OVER(PARTITION BY LVLID3,UDFC1,BEGIN_DTE ORDER BY BEGIN_DTE DESC,LVLID4,LVLDESC4) RN
					FROM VH_ELIGIBILITIES_PMPR WHERE SOURCE = ''CDBT'' AND Nvl(LVLDESC4,''XXX'') NOT IN (''THS00-'', ''GWC00-'', ''STR00-'' , ''RMP00-'', ''DEL00-'', ''SGR00-'', ''MAS00-'' ,''JWL00-'')
			 )
		WHERE RN=1
		) B
ON
(
	A.UDFC1=B.UDFC1 AND A.BEGIN_DTE=B.BEGIN_DTE AND A.LVLID3 =B.LVLID3
)
WHEN MATCHED THEN
UPDATE SET
	A.LVLID4 = B.LVLID4,
	A.LVLDESC4 = B.LVLDESC4
WHERE A.source = ''CDBT''
';

BEGIN EXECUTE IMMEDIATE vbQuery;
EXCEPTION WHEN OTHERS THEN
xp_scrubStatusLog ('VH_ELIGIBILITIES_PMPR LVL4 UPD: '||SQL%ROWCOUNT,'HORAN','  ',SQLCODE,substr(SQLERRM, 1,400),'',0,'VH_ELIGIBILITIES_PMPR','','E');
END;
COMMIT;
--------------------------------------END-ICE#317412--------------------------------------------

    --DEFECT 321879
  vbQuery:='	merge /*+NO_MERGE(b)*/ INTO vh_claims a
            USING
            (
            Select provid,provname FROM
            (
            SELECT provid,provname,Sum(paidamt) paidamt,Row_Number() OVER (PARTITION BY provname ORDER BY Sum(paidamt) desc) rn  FROM vh_claims GROUP BY provid,provname
            ) WHERE rn = 1
            )b
            ON
            (
            a.provname = b.provname
            )
            WHEN matched THEN UPDATE SET
            a.provid = b.provid';

BEGIN EXECUTE IMMEDIATE vbQuery;

	EXCEPTION WHEN OTHERS THEN
	xp_scrubStatusLog ('PROVID MULTIPLE CASE: ','HORAN','  ',SQLCODE,substr(SQLERRM, 1,400),'',0,'VH_CLAIMS','','E');
	END;
	COMMIT;


----------------------------------------------------------------------------------
-- Generic procedure to convert lab to hra for EI application
----------------------------------------------------------------------------------
  BEGIN
    sp_cdf_lab_to_hra_map('826', USER, 'VH_LABDATA', 'VH_HRA');
  END;
----------------------------------------------------------------------------------
  BEGIN
    DELETE FROM  vh_hra WHERE answervalue IS NULL;
  END;
----------------------------------------------------------------------------------

-------------------------------------------------------VH_HRA_ANSWER starts--IM Implementation--ICE-1498----------------------------------------------------
	vbQuery :='INSERT /*+ parallel(VH_HRA_ANSWERS,4) */ INTO VH_HRA_ANSWERS
	(
		MEMID,
		SURVEYDATE,
		ANS00,
		ANS01,
		ANS02,
		ANS07,
		ANS08,
		ANS09,
		ANS10,
		ANS11,
		ANS12,
		ANS13,
		ANS14,
		ANS15,
		ANS16,
		ANS17,
		ANS18,
		ANS19,
		ANS20,
		ANS21,
		ANS22,
		ANS23,
		ANS24,
		ANS25,
		ANS26,
		ANS27,
		ANS28,
		ANS29,
		ANS30,
		ANS31,
		ANS32,
		ANS33,
		ANS34,
		ANS35,
		ANS36,
		ANS37,
		ANS38,
		ANS39,
		ANS40,
		ANS41,
		ANS42,
		ANS43,
		ANS44,
		ANS45,
		AIFILEID,
		AIROWNUMBER,
		VHGROUPNAME,
		I_SRC_ORCL_ROW_ID,
		I_SRC_TBL_NM
	)
	SELECT /*+ parallel(M,4) */
		MEMID AS MEMID,
		SURVEYDATE as SURVEYDATE,
		HEIGHTFEET*12 AS ANS00,
		WEIGHT AS ANS01,
		CASE WHEN SMOKINGHISTORY IN (1,2,3) THEN ''Y'' ELSE ''N'' END AS ANS02,
		CASE
			WHEN BLOODGLUCOSECODE=1 THEN ''NOT SURE''
			WHEN BLOODGLUCOSECODE=2 THEN ''NORMAL''
			WHEN BLOODGLUCOSECODE=3 THEN ''BORDERLINE''
			WHEN BLOODGLUCOSECODE=4 THEN ''HIGH''
		  END AS ANS07,
		BLOODGLUCOSEVALUE AS ANS08,
		CASE
			WHEN BPDIASTOLICCODE=1 THEN ''NOT SURE''
			WHEN BPDIASTOLICCODE=2 THEN ''NORMAL''
			WHEN BPDIASTOLICCODE=3 THEN ''BORDERLINE''
			WHEN BPDIASTOLICCODE=4 THEN ''HIGH''
			WHEN BPDIASTOLICCODE=5 THEN ''VERY HIGH''
		  END AS ANS09,
		BPDIASTOLICVALUE AS ANS10,
		CASE
			WHEN BPSYSTOLICCODE=1 THEN ''NOT SURE''
			WHEN BPSYSTOLICCODE=2 THEN ''NORMAL''
			WHEN BPSYSTOLICCODE=3 THEN ''BORDERLINE''
			WHEN BPSYSTOLICCODE=4 THEN ''HIGH''
			WHEN BPSYSTOLICCODE=5 THEN ''VERY HIGH''
		  END AS ANS11,
		BPSYSTOLICVALUE AS ANS12,
		CASE
			WHEN CHOLESTEROLHDLCODE=1 THEN ''NOT SURE''
			WHEN CHOLESTEROLHDLCODE=2 THEN ''LOW''
			WHEN CHOLESTEROLHDLCODE=3 THEN ''NORMAL''
			WHEN CHOLESTEROLHDLCODE=4 THEN ''HIGH''
		  END AS ANS13,
		CHOLESTEROLHDLVALUE AS ANS14,
		CASE
			WHEN CHOLESTEROLLDLCODE=1 THEN ''NOT SURE''
			WHEN CHOLESTEROLLDLCODE=2 THEN ''NORMAL(LOWER RANGE)''
			WHEN CHOLESTEROLLDLCODE=3 THEN ''NORMAL(UPPER RANGE)''
			WHEN CHOLESTEROLLDLCODE=4 THEN ''BORDERLINE''
			WHEN CHOLESTEROLLDLCODE=5 THEN ''HIGH''
		  END AS ANS15,
		CHOLESTEROLLDLVALUE AS ANS16,
		CASE
			WHEN CHOLESTEROLTOTALCODE=1 THEN ''NOT SURE''
			WHEN CHOLESTEROLTOTALCODE=2 THEN ''NORMAL''
			WHEN CHOLESTEROLTOTALCODE=3 THEN ''BORDERLINE''
			WHEN CHOLESTEROLTOTALCODE=4 THEN ''HIGH''
		  END AS ANS17,
		CASE
			WHEN COLONOSCOPY=1 THEN ''COMPLAINT''
			WHEN COLONOSCOPY=2 THEN ''NONCOMPLIANT''
			WHEN COLONOSCOPY=3 THEN ''UNKNOWN''
		  END AS ANS18,
		CASE
			WHEN COLONSCREENING=1 THEN ''COMPLAINT''
			WHEN COLONSCREENING=2 THEN ''NONCOMPLIANT''
			WHEN COLONSCREENING=3 THEN ''UNKNOWN''
		  END  AS ANS19,
		DEPRESSIONSCORE AS ANS20,
		CASE
			WHEN DEPRESSIONSCORECODE=1 THEN ''LOW''
			WHEN DEPRESSIONSCORECODE=2 THEN ''MODERATE''
			WHEN DEPRESSIONSCORECODE=3 THEN ''HIGH''
		  END  AS ANS21,
		CASE
			WHEN DRINKDRIVE=1 THEN ''NEVER''
			WHEN DRINKDRIVE=2 THEN ''RARELY''
			WHEN DRINKDRIVE=3 THEN ''SOMETIMES''
			WHEN DRINKDRIVE=4 THEN ''FREQUENTLY''
		  END AS ANS22,
		CASE
			WHEN EXERCISE=1 THEN ''NEVER''
			WHEN EXERCISE=2 THEN ''SOMETIMES''
			WHEN EXERCISE=3 THEN ''OFTEN''
			WHEN EXERCISE=4 THEN ''VERY OFTEN''
		  END AS  ANS23,
		CASE
			WHEN FECALTESTING=1 THEN ''COMPLAINT''
			WHEN FECALTESTING=2 THEN ''NONCOMPLIANT''
			WHEN FECALTESTING=3 THEN ''UNKNOWN''
		  END AS ANS24,
		CASE
			WHEN GENERALHEALTH=1 THEN ''EXCELLENT''
			WHEN GENERALHEALTH=2 THEN ''VERY GOOD''
			WHEN GENERALHEALTH=3 THEN ''GOOD''
			WHEN GENERALHEALTH=4 THEN ''FAIR''
			WHEN GENERALHEALTH=5 THEN ''POOR''
		  END AS ANS25,
		CASE
			WHEN SMOKINGHISTORY =1 THEN ''CURRENT/STILL/YES''
			WHEN SMOKINGHISTORY=2 THEN ''CURRENT & DAILY''
			WHEN SMOKINGHISTORY=3 THEN ''CURRENT & SOMETIMES''
			WHEN SMOKINGHISTORY=4 THEN ''FORMER SMOKER/USED TO''
			WHEN SMOKINGHISTORY=5 THEN ''NON-SMOKER/NEVER/NO''
		  END AS ANS26,
		CASE
			WHEN HISTORYASTHMA=1 THEN ''N''
			WHEN HISTORYASTHMA=2 THEN ''Y''
		  END AS ANS27,
		CASE
			WHEN HISTORYBRONCHITIS=1 THEN ''N''
			WHEN HISTORYBRONCHITIS=2 THEN ''Y''
		  END AS ANS28,
		CASE
			WHEN HISTORYCOPD=1 THEN ''N''
			WHEN HISTORYCOPD=2 THEN ''Y''
		  END AS ANS29,
		CASE
			WHEN HISTORYDIABETES=1 THEN ''N''
			WHEN HISTORYDIABETES=2 THEN ''Y''
		  END AS ANS30,
		CASE
			WHEN HISTORYHYPERLIPIDEMIA=1 THEN ''N''
			WHEN HISTORYHYPERLIPIDEMIA=2 THEN ''Y''
		  END AS ANS31,
		CASE
			WHEN HISTORYHYPERTENSION=1 THEN ''N''
			WHEN HISTORYHYPERTENSION=2 THEN ''Y''
		  END AS ANS32,
		CASE
			WHEN HISTORYLUNGDISEASE=1 THEN ''N''
			WHEN HISTORYLUNGDISEASE=2 THEN ''Y''
		  END AS ANS33,
		CASE
			WHEN MAMMOGRAM=1 THEN ''WITHIN LAST 2 YEARS''
			WHEN MAMMOGRAM=2 THEN ''GREATER THAN 2 YEARS AGO''
		  END AS ANS34,
		NUMDEPRESSIONQUESTIONS AS ANS35,
		CASE
			WHEN PREGNANT=1 THEN ''NOT PREGNANT''
			WHEN PREGNANT=2 THEN ''CURRENTLY PREGNANT''
			WHEN PREGNANT=3 THEN ''PLANNING TO GET PREGNANT''
		  END AS ANS36,
		CASE
			WHEN PAPSMEAR=1 THEN ''LESS THAN 1 YEAR AGO''
			WHEN PAPSMEAR=2 THEN ''1-3 YEARS AGO''
			WHEN PAPSMEAR=3 THEN ''3+ YEARS AGO''
		  END AS ANS37,
		CASE
			WHEN SAFETYBELT=1 THEN ''NEVER/RARELY''
			WHEN SAFETYBELT=2 THEN ''SOMETIMES''
			WHEN SAFETYBELT=3 THEN ''ALWAYS''
		  END  AS ANS38,
		CASE
			WHEN SIGMOIDOSCOPY=1 THEN ''COMPLAINT''
			WHEN SIGMOIDOSCOPY=2 THEN ''NONCOMPLIANT''
			WHEN SIGMOIDOSCOPY=3 THEN ''UNKNOWN''
		  END  AS ANS39,
		CASE
			WHEN SMOKINGFREQUENCY=1 THEN ''1-9CIGS/DAY OR <1PK/WK''
			WHEN SMOKINGFREQUENCY=2 THEN ''10-19CIGS/DAY OR <1PK/DAY''
			WHEN SMOKINGFREQUENCY=3 THEN ''1-2PACKS/DAY''
			WHEN SMOKINGFREQUENCY=4 THEN ''>2PACKS/DAY''
		  END AS ANS40,
		CASE
			WHEN STRESSSCORECODE=1 THEN ''NONE/A LITTLE''
			WHEN STRESSSCORECODE=2 THEN ''SOME''
			WHEN STRESSSCORECODE=3 THEN ''A LOT''
		  END  AS ANS41,
		CASE
			WHEN WANTCHANGEEXERCISE=1 THEN ''ALREADY DID''
			WHEN WANTCHANGEEXERCISE=2 THEN ''YES(WITHIN NEXT 6 MONTHS)''
			WHEN WANTCHANGEEXERCISE=3 THEN ''NO/NOT SURE''
			WHEN WANTCHANGEEXERCISE=4 THEN ''NOT APPLICABLE''
		  END AS ANS42,
		CASE
			WHEN WANTCHANGESMOKING=1 THEN ''ALREADY DID''
			WHEN WANTCHANGESMOKING=2 THEN ''YES(WITHIN NEXT 6 MONTHS)''
			WHEN WANTCHANGESMOKING=3 THEN ''NO/NOT SURE''
			WHEN WANTCHANGESMOKING=4 THEN ''NOT APPLICABLE''
		  END AS ANS43,
		CASE
			WHEN WANTCHANGEWEIGHT=1 THEN ''ALREADY DID''
			WHEN WANTCHANGEWEIGHT=2 THEN ''YES(WITHIN NEXT 6 MONTHS)''
			WHEN WANTCHANGEWEIGHT=3 THEN ''NO/NOT SURE''
			WHEN WANTCHANGEWEIGHT=4 THEN ''NOT APPLICABLE''
		  END AS ANS44,
		CASE
			WHEN ALCOHOLDRINKS=1 THEN ''NEVER''
			WHEN ALCOHOLDRINKS=2 THEN ''LIGHT''
			WHEN ALCOHOLDRINKS=3 THEN ''MODERATE''
			WHEN ALCOHOLDRINKS=4 THEN ''HEAVY''
		  END AS ANS45,
		AIFILEID AS AIFILEID,
		AIROWNUMBER AS AIROWNUMBER,
		VHGROUPNAME AS VHGROUPNAME,
		I_SRC_ORCL_ROW_ID AS I_SRC_ORCL_ROW_ID,
		I_SRC_TBL_NM AS I_SRC_TBL_NM

	FROM
		(SELECT Z.*
            FROM
				(
					SELECT A.*, Row_Number()OVER(PARTITION BY MEMID,SURVEYDATE ORDER BY MEMID,SURVEYDATE DESC)RN
					FROM VH_HRA_DATA A
                )Z
            WHERE RN=1
         ) M';

	BEGIN
		EXECUTE IMMEDIATE vbQuery;
		EXCEPTION WHEN OTHERS THEN
		XP_SCRUBSTATUSLOG ('HRA ANSWER','HRA','  ',SQLCODE,substr(SQLERRM, 1,400),'',0,'INSERT INTO VH_HRA_ANSWERS','','E');
	END;
	COMMIT;
-------------------------------------------------------VH_HRA_ANSWER ends---MI Implementation--ICE-1498---------------------------------------------------


D2SCRUB.signalCompletion(SchemaName || '.SP_FM');

END SP_FM;
/

COMMIT;

-------------------------------------------------------------------------------------------------
EXEC sp_process_scrub(4);
-------------------------------------------------------------------------------------------------

--SELECT * FROM scrubStatusLog where message is not null;
--SELECT * FROM tbl_error_log ;

--SELECT * FROM user_jobs;

--SELECT * FROM vh_scrub_exec_log;

--EXEC DBMS_JOB.remove(job);
--select * from querylog_loa where success_failure <> 'SUCCESS' ORDER BY 1;
--   SELECT * FROM hr_826_pkg_emppayer WHERE flag = 'T';

--   UPDATE hr_826_pkg_emppayer
--   SET flag = 'T'
--   WHERE payer IN('UMR','ANTHEM');

--SELECT * FROM vh_hra_answers;
